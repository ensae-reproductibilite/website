{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "---\n",
        "title: \"Application\"\n",
        "description: |\n",
        "  Une application fil rouge pour illustrer l'int√©r√™t d'appliquer graduellement les bonnes pratiques dans une optique de mise en production d'une application de data science.\n",
        "order: 10\n",
        "href: chapters/application.html\n",
        "image: /rocket.png\n",
        "---\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "D√©rouler les _slides_ ci-dessous ou [cliquer ici](https://ensae-reproductibilite.github.io/slides/#/title-slide)\n",
        "pour afficher les slides en plein √©cran.\n",
        "</summary>\n",
        "\n",
        "\n",
        "<div class=\"sourceCode\" id=\"cb1\"><pre class=\"sourceCode yaml code-with-copy\"><code class=\"sourceCode yaml\"></code><button title=\"Copy to Clipboard\" class=\"code-copy-button\"><i class=\"bi\"></i></button></pre><iframe class=\"sourceCode yaml code-with-copy\" src=\"https://ensae-reproductibilite.github.io/slides/#/title-slide\"></iframe></div>\n",
        "\n",
        "</details>\n",
        "\n",
        "L'objectif de cette mise en application est d'**illustrer les diff√©rentes √©tapes qui s√©parent la phase de d√©veloppement d'un projet de celle de la mise en production**. Elle permettra de mettre en pratique les diff√©rents concepts pr√©sent√©s tout au long du cours.\n",
        "\n",
        "Celle-ci est un tutoriel pas √† pas pour avoir un projet reproductible et disponible sous plusieurs livrables.\n",
        "Toutes les √©tapes ne sont pas indispensables √† tous les projets de _data science_.\n",
        "\n",
        "Nous nous pla√ßons dans une situation initiale correspondant √† la fin de la phase de d√©veloppement d'un projet de data science.\n",
        "On a un _notebook_ un peu monolithique, qui r√©alise les √©tapes classiques d'un *pipeline* de *machine learning* :\n",
        "\n",
        "- Import de donn√©es ;\n",
        "- Statistiques descriptives et visualisations ;\n",
        "- *Feature engineering* ;\n",
        "- Entra√Ænement d'un mod√®le ;\n",
        "- Evaluation du mod√®le.\n",
        "\n",
        "**L'objectif est d'am√©liorer le projet de mani√®re incr√©mentale jusqu'√† pouvoir le mettre en production, en le valorisant sous une forme adapt√©e.**\n",
        "\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "Illustration de notre point de d√©part\n",
        "</summary>\n",
        "![](/drawio/starting_point.png)\n",
        "</details>\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "Illustration de l'horizon vers lequel on se dirige\n",
        "</summary>\n",
        "![](/drawio/end_point.png)\n",
        "</details>\n",
        "\n",
        "::: {.callout-important}\n",
        "Il est important de bien lire les consignes et d'y aller progressivement.\n",
        "Certaines √©tapes peuvent √™tre rapides, d'autres plus fastidieuses ;\n",
        "certaines √™tre assez guid√©es, d'autres vous laisser plus de libert√©.\n",
        "Si vous n'effectuez pas une √©tape, vous risquez de ne pas pouvoir passer √†\n",
        "l'√©tape suivante qui en d√©pend.\n",
        "\n",
        "Bien que l'exercice soit applicable sur toute configuration bien faite, nous\n",
        "recommandons de privil√©gier l'utilisation du [SSP Cloud](https://datalab.sspcloud.fr/home), o√π tous les\n",
        "outils n√©cessaires sont pr√©-install√©s et pr√©-configur√©s. Le service `VSCode`\n",
        "ne sera en effet que le point d'entr√©e pour l'utilisation d'outils plus exigeants\n",
        "sur le plan de l'infrastructure: _Argo_, _MLFLow_, etc.\n",
        ":::\n",
        "\n",
        "\n",
        "# Partie 0 : initialisation du projet\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application pr√©liminaire: forker le d√©p√¥t d'exemple\n",
        "\n",
        "Les premi√®res √©tapes consistent √† mettre en place son environnement de travail sur `Github`:\n",
        "\n",
        "- G√©n√©rer un jeton d'acc√®s (*token*) sur `GitHub` afin de permettre l'authentification en ligne de commande √† votre compte.\n",
        "La proc√©dure est d√©crite [ici](https://docs.sspcloud.fr/onyxia-guide/controle-de-version#creer-un-jeton-dacces-token).\n",
        "__Vous ne voyez ce jeton qu'une fois, ne fermez pas la page de suite__.\n",
        "\n",
        "- Mettez de c√¥t√© ce jeton en l'enregistrant dans un gestionnaire de mot de passe ou dans\n",
        "l'espace _[\"Mon compte\"](https://datalab.sspcloud.fr/account/third-party-integration)_\n",
        "du `SSP Cloud`.\n",
        "\n",
        "- Forker le d√©p√¥t `Github` : [https://github.com/ensae-reproductibilite/application](https://github.com/ensae-reproductibilite/application) en faisant attention √† une option :\n",
        "    + **D√©cocher la case _\"Copy the `main` branch only\"_** afin de copier √©galement les _tags_ `Git` qui nous permettront de faire les _checkpoint_.\n",
        "\n",
        "\n",
        "<details>\n",
        "\n",
        "<summary>\n",
        "Ce que vous devriez voir sur la page de cr√©ation du _fork_\n",
        "</summary>\n",
        "\n",
        "![](/fork-example.png)\n",
        "\n",
        "</details>\n",
        "\n",
        "Il est maintenant possible de ce lancer dans la cr√©ation de l'environnement de travail:\n",
        "\n",
        "- Ouvrir un service `VSCode` sur le [SSP Cloud](https://datalab.sspcloud.fr/home). Vous pouvez aller\n",
        "dans la page `My Services` et cliquer sur `New service`. Sinon, vous\n",
        "pouvez initialiser la cr√©ation du service en cliquant directement [ici](https://datalab.sspcloud.fr/launcher/ide/vscode-python?autoLaunch=false). __Modifier les options suivantes__:\n",
        "    + Dans l'onglet `Role`, s√©lectionner le r√¥le `Admin` ;\n",
        "    + Dans l'onglet `Networking`, cliquer sur _\"Enable a custom service port\"_ et laisser la valeur par d√©faut 5000 pour le num√©ro du port\n",
        "\n",
        "- Cl√¥ner __votre__ d√©p√¥t `Github` en utilisant le\n",
        "terminal depuis `Visual Studio` (`Terminal > New Terminal`) et\n",
        "en passant directement le token dans l'URL selon cette structure:\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git clone https://$TOKEN@github.com/$USERNAME/application.git\n",
        "```\n",
        "\n",
        "o√π `$TOKEN` et `$USERNAME` sont √† remplacer, respectivement,\n",
        "par le jeton que vous avez g√©n√©r√© pr√©c√©demment et votre nom d'utilisateur.\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "# Partie 1 : qualit√© du script\n",
        "\n",
        "Cette premi√®re partie vise √† **rendre le projet conforme aux bonnes pratiques** pr√©sent√©es dans le cours.\n",
        "\n",
        "Elle fait intervenir les notions suivantes :\n",
        "\n",
        "- Utilisation du **terminal** (voir [Linux 101](/chapters/linux-101.qmd)) ;\n",
        "- **Qualit√© du code** (voir [Qualit√© du code](/chapters/code-quality.qmd)) ;\n",
        "- **Architecture de projets** (voir [Architecture des projets](/chapters/projects-architecture.html)) ;\n",
        "- **Contr√¥le de version** avec `Git` (voir [Rappels `Git`](/chapters/git.qmd)) ;\n",
        "- **Travail collaboratif** avec `Git` et `GitHub` (voir [Rappels `Git`](/chapters/git.qmd)).\n",
        "\n",
        "\n",
        "Le plan de la partie est le suivant :\n",
        "\n",
        "1. S'assurer que le script fonctionne ;\n",
        "2. Nettoyer le code des scories formelles avec un _linter_ et un _formatter_ ;\n",
        "3. Param√©trisation du script ;\n",
        "4. Utilisation de fonctions.\n",
        "\n",
        "\n",
        "## √âtape 1 : s'assurer que le script s'ex√©cute correctement\n",
        "\n",
        "On va partir du fichier `notebook.py` qui reprend le contenu\n",
        "du _notebook_[^jupytext] mais dans un script classique.\n",
        "Le travail de nettoyage en sera facilit√©.\n",
        "\n",
        "[^jupytext]: L'export dans un script `.py` a √©t√© fait\n",
        "        directement depuis `VSCode`. Comme\n",
        "        cela n'est pas vraiment l'objet du cours, nous passons cette √©tape et fournissons\n",
        "        directement le script expurg√© du texte interm√©diaire. Mais n'oubliez\n",
        "        pas que cette d√©marche, fr√©quente quand on a d√©marr√© sur un _notebook_ et\n",
        "        qu'on d√©sire consolider en faisant la transition vers des\n",
        "        scripts, n√©cessite d'√™tre attentif pour ne pas risquer de faire une erreur.\n",
        "\n",
        "La premi√®re √©tape est simple, mais souvent oubli√©e : **v√©rifier que le code fonctionne correctement**.\n",
        "Pour cela, nous recommandons de faire un aller-retour entre le script ouvert dans `VSCode`\n",
        "et un terminal pour le lancer.\n",
        "\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 1: corriger les erreurs\n",
        "\n",
        "- Ouvrir dans `VSCode` le script `titanic.py` ;\n",
        "- Ex√©cuter le script en ligne de commande (`python titanic.py`)[^interactivite] pour d√©tecter les erreurs ;\n",
        "- Corriger les deux erreurs qui emp√™chent la bonne ex√©cution ;\n",
        "- V√©rifier le fonctionnement du script en utilisant la ligne de commande:\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "python titanic.py\n",
        "```\n",
        "\n",
        "Le code devrait afficher des sorties.\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "Aide sur les erreurs rencontr√©es\n",
        "</summary>\n",
        "\n",
        "La premi√®re erreur rencontr√©e est une alerte `FileNotFoundError`,\n",
        "la seconde est li√©e √† un _package_. \n",
        "\n",
        "</details>\n",
        "\n",
        "\n",
        "Il est maintenant temps de *commit* les changements effectu√©s avec `Git`[^2] :\n",
        "\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git add titanic.py\n",
        "git commit -m \"Corrige l'erreur qui emp√™chait l'ex√©cution\"\n",
        "git push\n",
        "```\n",
        "\n",
        "<!---- \n",
        "Temps estim√©: 3mn\n",
        "------>\n",
        "\n",
        ":::\n",
        "\n",
        "[^interactivite]: Il est √©galement possible avec `VSCode` d'ex√©cuter le script ligne √† ligne\n",
        "de mani√®re interactive ligne √† ligne (<kbd>MAJ</kbd>+<kbd>ENTER</kbd>). N√©anmoins, cela n√©cessite\n",
        "de s'assurer que le _working directory_ de votre console interactive est le bon. Celle-ci se\n",
        "lance selon les param√®tres pr√©configur√©s de `VSCode` et les votres ne sont peut-√™tre pas les\n",
        "m√™mes que les notres. Vous pouvez changer le _working directory_ dans le script\n",
        "en utilisant le _package_ `os` mais peut-√™tre allez vous d√©couvrir ult√©rieurement qu'il\n",
        "y a de meilleures pratiques...\n",
        "[^2]: Essayez de *commit* vos changements √† chaque √©tape de l'exercice, c'est une bonne habitude √† prendre.\n",
        "\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli1\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "## √âtape 2: utiliser un _linter_ puis un _formatter_\n",
        "\n",
        "On va maintenant am√©liorer la qualit√© de notre code en appliquant les standards communautaires.\n",
        "Pour cela, on va utiliser le *linter* classique [`PyLint`](https://pylint.readthedocs.io/en/latest/)\n",
        "et le _formatter_ [`Black`](https://github.com/psf/black).\n",
        "Si vous d√©sirez un outil deux en un, il est possible d'utiliser [`Ruff`](https://github.com/astral-sh/ruff-vscode)\n",
        "en compl√©ment ou substitut.\n",
        "\n",
        "Ce nettoyage automatique du code permettra, au passage, de restructurer notre\n",
        "script de mani√®re plus naturelle.\n",
        "\n",
        "::: {.callout-important}\n",
        "[`PyLint`](https://pylint.readthedocs.io/en/latest/) et [`Black`](https://black.readthedocs.io/en/stable/)\n",
        "sont des _packages_ `Python` qui\n",
        "s'utilisent principalement en ligne de commande.\n",
        "\n",
        "Si vous avez une erreur qui sugg√®re\n",
        "que votre terminal ne connait pas [`PyLint`](https://pylint.readthedocs.io/en/latest/)\n",
        "ou [`Black`](https://black.readthedocs.io/en/stable/),\n",
        "n'oubliez pas d'ex√©cuter la commande `pip install pylint` ou `pip install black`.\n",
        ":::\n",
        "\n",
        "\n",
        "Le _linter_ renvoie alors une s√©rie d'irr√©gularit√©s,\n",
        "en pr√©cisant √† chaque fois la ligne de l'erreur et le message d'erreur associ√© (ex : mauvaise identation).\n",
        "Il renvoie finalement une note sur 10,\n",
        "qui estime la qualit√© du code √† l'aune des standards communautaires √©voqu√©s\n",
        "dans la partie [Qualit√© du code](/chapters/code-quality.html).\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 2: rendre lisible le script\n",
        "\n",
        "- Diagnostiquer et √©valuer la qualit√© de `titanic.py` avec [`PyLint`](https://pylint.readthedocs.io/en/latest/). Regarder la note obtenue.\n",
        "- Utiliser `black titanic.py --diff --color` pour observer les changements de forme que va induire l'utilisation du _formatter_ [`Black`](https://black.readthedocs.io/en/stable/). Cette √©tape n'applique pas les modifications, elle ne fait que vous les montrer.\n",
        "- Appliquer le _formatter_ [`Black`](https://black.readthedocs.io/en/stable/)\n",
        "- R√©utiliser [`PyLint`](https://pylint.readthedocs.io/en/latest/) pour diagnostiquer l'am√©lioration de la qualit√© du script et le travail qui reste √† faire. \n",
        "- Comme la majorit√© du travail restant est √† consacrer aux imports:\n",
        "    - Mettre tous les _imports_ ensemble en d√©but de script\n",
        "    - Retirer les _imports_ redondants en s'aidant des diagnostics de votre √©diteur\n",
        "    - R√©ordonner les _imports_ si [`PyLint`](https://pylint.readthedocs.io/en/latest/) vous indique de le faire\n",
        "    - Corriger les derni√®res fautes formelles sugg√©r√©es par [`PyLint`](https://pylint.readthedocs.io/en/latest/)\n",
        "- D√©limiter des parties dans votre code pour rendre sa structure plus lisible. Si des parties vous semblent √™tre dans le d√©sordre, vous pouvez r√©ordonner le script (mais n'oubliez pas de le tester)\n",
        "\n",
        "<!-----\n",
        "Temps test Julien: 22mn\n",
        "------>\n",
        ":::\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli2\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "Le code est maintenant lisible, il obtient √† ce stade une note formelle proche de 10.\n",
        "Mais il n'est pas encore totalement intelligible ou fiable.\n",
        "Il y a notamment\n",
        "quelques redondances de code auxquelles nous allons nous attaquer par la suite.\n",
        "N√©anmoins, avant cela, occupons-nous de mieux g√©rer certains param√®tres du script:\n",
        "jetons d'API et chemin des fichiers.\n",
        "\n",
        "\n",
        "## √âtape 3: gestion des param√®tres\n",
        "\n",
        "L'ex√©cution du code et les r√©sultats obtenus\n",
        "d√©pendent de certains param√®tres d√©finis dans le code. L'√©tude de r√©sultats\n",
        "alternatifs, en jouant sur\n",
        "des variantes des (hyper)param√®tres, est √† ce stade compliqu√©e\n",
        "car il est n√©cessaire de parcourir le code pour trouver\n",
        "ces param√®tres. De plus, certains param√®tres personnels\n",
        "comme des jetons\n",
        "d'API ou des mots de passe n'ont pas vocation √†\n",
        "√™tre pr√©sents dans le code.\n",
        "\n",
        "Il est plus judicieux de consid√©rer ces param√®tres comme des\n",
        "variables d'entr√©e du script. Cela peut √™tre fait de deux\n",
        "mani√®res:\n",
        "\n",
        "1. Avec des __arguments optionnels__ appel√©s depuis la ligne de commande _(Application 3a)_.\n",
        "Cela peut √™tre pratique pour mettre en oeuvre des tests automatis√©s mais\n",
        "n'est pas forc√©ment pertinent pour toutes les variables. Nous allons montrer\n",
        "cet usage avec le nombre d'arbres de notre _random forest_ ;\n",
        "2. En utilisant un __fichier de configuration__ dont les valeurs sont import√©es dans\n",
        "le script principal _(Application 3b)_.\n",
        "\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "Un exemple de d√©finition d'un argument pour l'utilisation en ligne de commande\n",
        "</summary>\n",
        "\n",
        "```{.python filename=\"prenom.py\"}\n",
        "import argparse\n",
        "parser = argparse.ArgumentParser(description=\"Qui √™tes-vous?\")\n",
        "parser.add_argument(\n",
        "    \"--prenom\", type=str, default=\"Toto\", help=\"Un pr√©nom √† afficher\"\n",
        ")\n",
        "args = parser.parse_args()\n",
        "print(args.prenom)\n",
        "```\n",
        "\n",
        "Exemples d'utilisations en ligne de commande\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "python prenom.py\n",
        "python prenom.py --prenom \"Zinedine\"\n",
        "```\n",
        "\n",
        "</details>\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 3a: Param√©trisation du script\n",
        "\n",
        "1. En s'inspirant de l'exemple ci-dessus üëÜÔ∏è,\n",
        "cr√©er une variable `n_trees` qui peut √©ventuellement √™tre param√©tr√©e en ligne de commande\n",
        "et dont la valeur par d√©faut est 20 ;\n",
        "2. Tester cette param√©trisation en ligne de commande avec la valeur par d√©faut\n",
        "puis 2, 10 et 50 arbres.\n",
        ":::\n",
        "\n",
        "L'exercice suivant permet de mettre en application le fait de param√©triser\n",
        "un script en utilisant des variables d√©finies dans un fichier YAML.\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 3b: La configuration dans un fichier d√©di√©\n",
        "\n",
        "1. Installer le package `python-dotenv` que nous allons utiliser pour charger notre jeton d'API √† partir d'une variable d'environnement.\n",
        "2. A partir de l'exemple de la [documentation](https://pypi.org/project/python-dotenv/), utiliser la fonction `load_dotenv` pour charger dans `Python` nos variables d'environnement √† partir d'un fichier (vous pouvez le cr√©er mais ne pas le remplir encore avec les valeurs voulues, ce sera fait ensuite)\n",
        "3. Cr√©er la variable et v√©rifier la sortie de `Python` en faisant tourner `titanic.py` en ligne de commande\n",
        "\n",
        "\n",
        "```{.python filename=\"titanic.py\"}\n",
        "jeton_api = os.environ.get(\"JETON_API\", \"\")\n",
        "\n",
        "if jeton_api.startswith(\"$\"):\n",
        "    print(\"API token has been configured properly\")\n",
        "else:\n",
        "    print(\"API token has not been configured\")\n",
        "```\n",
        "\n",
        "4. Maintenant introduire la valeur voulue pour le jeton d'API dans le fichier d'environnement lu par `dotenv`\n",
        "5. S'il n'existe pas d√©j√†, cr√©er un fichier `.gitignore` (cf. [Chapitre `Git`](/chapters/git.qmd)). Ajouter dans ce fichier `.env` car il ne faut pas committer ce fichier. Au passage ajouter `__pycache__/` au `.gitignore`[^pycache], cela\n",
        "√©vitera d'avoir √† le faire ult√©rieurement ;\n",
        "1. Cr√©er un fichier `README.md` o√π vous indiquez qu'il faut cr√©er un fichier `.env` pour\n",
        "pouvoir utiliser l'API.\n",
        "\n",
        "[^fileexist]: Ici, le jeton d'API n'est pas indispensable pour que le code\n",
        "    fonctionne. Afin d'√©viter une erreur non n√©cessaire\n",
        "    lorsqu'on automatisera le processus, on peut\n",
        "    cr√©er une condition qui v√©rifie la pr√©sence ou non de ce fichier.\n",
        "    Le script reste donc reproductible m√™me pour un utilisateur n'ayant pas le fichier\n",
        "    `secrets.yaml`.\n",
        "\n",
        "[^pycache]: Il est normal d'avoir des dossiers `__pycache__` qui tra√Ænent en local : ils se cr√©ent automatiquement √† l'ex√©cution d'un script en `Python`. N√©anmoins, il ne faut pas associer ces fichiers √† `Git`, voil√† pourquoi on les ajoute au `.gitignore`.\n",
        "\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli3\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "## √âtape 4 : Privil√©gier la programmation fonctionnelle\n",
        "\n",
        "Nous allons **mettre en fonctions les parties importantes de l'analyse**.\n",
        "Ceci facilitera l'√©tape ult√©rieure de modularisation de notre projet.\n",
        "\n",
        "Cet exercice √©tant chronophage, il n'est __pas obligatoire de le r√©aliser en entier__. L'important est de\n",
        "comprendre la d√©marche et d'adopter fr√©quemment une approche fonctionnelle[^POO]. Pour obtenir\n",
        "une chaine enti√®rement fonctionnalis√©e, vous pouvez reprendre le _checkpoint_.\n",
        "\n",
        "[^POO]: Nous proposons ici d'adopter le principe de la __programmation fonctionnelle__. Pour encore fiabiliser\n",
        "un processus, il serait possible d'adopter le paradigme de la __programmation orient√©e objet (POO)__. Celle-ci est\n",
        "plus rebutante et demande plus de temps au d√©veloppeur. L'arbitrage co√ªt-avantage est n√©gatif pour notre\n",
        "exemple, nous proposons donc de nous en passer. N√©anmoins, pour une mise en production r√©elle d'un mod√®le,\n",
        "il est recommand√© de l'adopter. C'est d'ailleurs obligatoire avec des [_pipelines_ `scikit`](https://pythonds.linogaliana.fr/pipeline-scikit/).\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 4: adoption des standards de programmation fonctionnelle\n",
        "\n",
        "Cette application peut √™tre chronophage, vous pouvez aller plus ou moins\n",
        "loin dans la fonctionalisation de votre script en fonction du temps dont vous\n",
        "disposez.\n",
        "\n",
        "* Cr√©er une fonction g√©n√©rique pour r√©duire la redondance de code\n",
        " dans l'√©tape d'exploration des donn√©es o√π on utilise `split` ;\n",
        "* Cr√©er une fonction qui r√©alise le *split train/test* en fonction d'un param√®tre repr√©sentant la proportion de l'√©chantillon de test\n",
        "et d'arguments optionnels sur les chemins d'√©criture des deux √©chantillons en csv.\n",
        "* Cr√©er une fonction qui int√®gre les diff√©rentes √©tapes du _pipeline_ (preprocessing et d√©finition du mod√®le). Cette fonction prend\n",
        "en param√®tre le nombre d'arbres (argument obligatoire) et des arguments optionnels suppl√©mentaires (les colonnes sur lesquelles s'appliquent les diff√©rentes √©tapes du _pipeline_, `max_depth` et `max_features`).\n",
        "* Cr√©er une fonction d'√©valuation renvoyant le score obtenu et la matrice de confusion, √† l'issue d'une estimation (mais cette estimation est faite en amont de la fonction, pas au sein de celle-ci)\n",
        "- D√©placer toutes les fonctions ensemble, en d√©but de script. Si besoin, ajouter des param√®tres √† votre fichier d'environnement pour cr√©er de nouvelles variables comme les chemins des donn√©es.\n",
        ":::\n",
        "\n",
        "[^notepandas]: Au passage vous pouvez noter que mauvaises pratiques discutables,\n",
        "    peuvent\n",
        "    √™tre corrig√©es, notamment l'utilisation excessive de `apply` l√† o√π\n",
        "    il serait possible d'utiliser des m√©thodes embarqu√©es par `Pandas`.\n",
        "    Cela est plut√¥t de l'ordre du bon style de programmation que de la\n",
        "    qualit√© formelle du script. Ce n'est donc pas obligatoire mais c'est mieux.\n",
        "\n",
        "\n",
        "::: {.callout-important}\n",
        "Le fait d'appliquer des fonctions a d√©j√† am√©lior√© la fiabilit√© du processus\n",
        "en r√©duisant le nombre d'erreurs de copier-coller. N√©anmoins, pour vraiment\n",
        "fiabiliser le processus, il faudrait utiliser un _pipeline_ de transformations\n",
        "de donn√©es.\n",
        "\n",
        "Ceci n'est pas encore au programme du cours mais le sera dans une prochaine\n",
        "version.\n",
        ":::\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli4\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "Cela ne se remarque pas encore vraiment car nous avons de nombreuses d√©finitions de fonctions\n",
        "mais notre chaine de production est beaucoup plus\n",
        "concise (le script fait environ 300 lignes dont 250 de d√©finitions de fonctions g√©n√©riques).\n",
        "Cette auto-discipline facilitera grandement\n",
        "les √©tapes ult√©rieures. Cela aurait √©t√© n√©anmoins beaucoup moins co√ªteux en temps d'adopter\n",
        "ces bons gestes de mani√®re plus pr√©coce.\n",
        "\n",
        "\n",
        "# Partie 2 : adoption d'une structure modulaire {#partie2}\n",
        "\n",
        "Dans la partie pr√©c√©dente,\n",
        "on a appliqu√© de mani√®re incr√©mentale de nombreuses bonnes pratiques vues tout au long du cours.\n",
        "Ce faisant, on s'est d√©j√† consid√©rablement rapproch√©s d'un\n",
        "possible partage du code : celui-ci est lisible et intelligible.\n",
        "Le code est proprement versionn√© sur un\n",
        "d√©p√¥t `GitHub`.\n",
        "Cependant, le projet est encore perfectible: il est encore difficile de rentrer\n",
        "dedans si on ne sait pas exactement ce qu'on recherche. L'objectif de cette partie\n",
        "est d'isoler les diff√©rentes √©tapes de notre _pipeline_.\n",
        "Outre le gain de clart√© pour notre projet, nous √©conomiserons beaucoup de peines\n",
        "pour la mise en production ult√©rieure de notre mod√®le.\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "Illustration de l'√©tat actuel du projet\n",
        "</summary>\n",
        "![](/schema_post_appli4.png)\n",
        "</details>\n",
        "\n",
        "Dans cette partie nous allons continuer les am√©liorations\n",
        "incr√©mentales de notre projet avec les √©tapes suivantes:\n",
        "\n",
        "1. Modularisation du code `Python` pour s√©parer les diff√©rentes\n",
        "√©tapes de notre _pipeline_ ;\n",
        "2. Adopter une structure standardis√©e pour notre projet afin\n",
        "d'autodocumenter l'organisation de celui-ci ;\n",
        "3. Documenter les _packages_ indispensables √† l'ex√©cution du code ;\n",
        "4. Stocker les donn√©es dans un environnement ad√©quat\n",
        "afin de continuer la d√©marche de s√©parer conceptuellement les donn√©es du code en de la configuration.\n",
        "\n",
        "\n",
        "## √âtape 1 : modularisation\n",
        "\n",
        "Nous allons profiter de la modularisation pour adopter une structure\n",
        "applicative pour notre code. Celui-ci n'√©tant en effet plus lanc√©\n",
        "que depuis la ligne de commande, on peut consid√©rer qu'on construit\n",
        "une application g√©n√©rique o√π un script principal (`main.py`)\n",
        "encapsule des √©l√©ments issus d'autres scripts `Python`.\n",
        "\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 5: modularisation\n",
        "\n",
        "- D√©placer les fonctions dans une s√©rie de fichiers d√©di√©s:\n",
        "    +  `import_data.py`: fonctions d'import et d'exploration de donn√©es \n",
        "    +  `build_features.py`: fonctions regroupant la d√©finition des √©chantillons d'apprentissage et de test ainsi que le _pipeline_ \n",
        "    +  `train_evaluate.py`: fonctions d'√©valuation du mod√®le\n",
        "- Sp√©cifier les d√©pendances (i.e. les packages √† importer)\n",
        "dans les modules pour que ceux-ci puissent s'ex√©cuter ind√©pendamment ;\n",
        "- Renommer `titanic.py` en `main.py` pour suivre la convention de nommage des projets `Python` ;\n",
        "- Importer les fonctions n√©cessaires √† partir des modules.\n",
        "- V√©rifier que tout fonctionne bien en ex√©cutant le _script_ `main` √† partir de la ligne de commande :\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "python main.py\n",
        "```\n",
        ":::\n",
        "\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli5\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "## √âtape 2 : adopter une architecture standardis√©e de projet\n",
        "\n",
        "On dispose maintenant d'une application `Python` fonctionnelle.\n",
        "N√©anmoins, le projet est certes plus fiable mais sa structuration\n",
        "laisse √† d√©sirer et il serait difficile de rentrer √† nouveau\n",
        "dans le projet dans quelques temps.\n",
        "\n",
        "<details>\n",
        "<summary>Etat actuel du projet üôà</summary>\n",
        "\n",
        "```\n",
        "‚îú‚îÄ‚îÄ .gitignore\n",
        "‚îú‚îÄ‚îÄ data.csv\n",
        "‚îú‚îÄ‚îÄ train.csv\n",
        "‚îú‚îÄ‚îÄ test.csv\n",
        "‚îú‚îÄ‚îÄ README.md\n",
        "‚îú‚îÄ‚îÄ config.yaml\n",
        "‚îú‚îÄ‚îÄ import_data.py\n",
        "‚îú‚îÄ‚îÄ build_features.py\n",
        "‚îú‚îÄ‚îÄ train_evaluate.py\n",
        "‚îú‚îÄ‚îÄ titanic.ipynb\n",
        "‚îî‚îÄ‚îÄ main.py\n",
        "```\n",
        "\n",
        "\n",
        "</details>\n",
        "\n",
        "Comme cela est expliqu√© dans la\n",
        "partie [Structure des projets](/chapters/projects-architecture.html),\n",
        "on va adopter une structure certes arbitraire mais qui va\n",
        "faciliter l'autodocumentation de notre projet. De plus, une telle structure va faciliter des √©volutions optionnelles\n",
        "comme la _packagisation_ du projet. Passer d'une structure modulaire\n",
        "bien faite √† un _package_ est quasi-imm√©diat en `Python`.\n",
        "\n",
        "On va donc modifier l'architecture de notre projet pour la rendre plus standardis√©e.\n",
        "Pour cela, on va s'inspirer des structures\n",
        "[`cookiecutter`](https://cookiecutter.readthedocs.io/en/stable/)\n",
        "qui g√©n√®rent des _templates_ de projet. En l'occurrence\n",
        "notre source d'inspiration sera le [_template datascience_](https://drivendata.github.io/cookiecutter-data-science/)\n",
        "issu d'un effort communautaire.\n",
        "\n",
        "::: {.callout-note}\n",
        "L'id√©e de [`cookiecutter`](https://cookiecutter.readthedocs.io/en/stable/) est de proposer des _templates_ que l'on utilise pour __initialiser__ un projet, afin de b√¢tir √† l'avance une structure √©volutive. La syntaxe √† utiliser dans ce cas est la suivante :\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "pip install cookiecutter\n",
        "cookiecutter https://github.com/drivendata/cookiecutter-data-science\n",
        "```\n",
        "\n",
        "Ici, on a d√©j√† un projet, on va donc faire les choses dans l'autre sens : on va s'inspirer de la structure propos√©e afin de r√©organiser celle de notre projet selon les standards communautaires.\n",
        ":::\n",
        "\n",
        "En s'inspirant du _cookiecutter data science_\n",
        "on va adopter la structure suivante:\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "Structure recommand√©e\n",
        "</summary>\n",
        "\n",
        "```\n",
        "application\n",
        "‚îú‚îÄ‚îÄ main.py\n",
        "‚îú‚îÄ‚îÄ README.md\n",
        "‚îú‚îÄ‚îÄ data\n",
        "‚îÇ   ‚îú‚îÄ‚îÄ raw\n",
        "‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ data.csv\n",
        "‚îÇ   ‚îî‚îÄ‚îÄ derived\n",
        "‚îÇ       ‚îú‚îÄ‚îÄ test.csv\n",
        "‚îÇ       ‚îî‚îÄ‚îÄ train.csv\n",
        "‚îú‚îÄ‚îÄ configuration\n",
        "‚îÇ   ‚îî‚îÄ‚îÄ config.yaml\n",
        "‚îú‚îÄ‚îÄ notebooks\n",
        "‚îÇ   ‚îî‚îÄ‚îÄ titanic.ipynb\n",
        "‚îî‚îÄ‚îÄ src\n",
        "    ‚îú‚îÄ‚îÄ data\n",
        "    ‚îÇ   ‚îî‚îÄ‚îÄ import_data.py\n",
        "    ‚îú‚îÄ‚îÄ pipeline\n",
        "    ‚îÇ   ‚îî‚îÄ‚îÄ build_pipeline.py\n",
        "    ‚îî‚îÄ‚îÄ models\n",
        "        ‚îî‚îÄ‚îÄ train_evaluate.py\n",
        "```\n",
        "\n",
        "</details>\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "\n",
        "## Application 6: adopter une structure lisible\n",
        "\n",
        "- _(optionnel)_ Analyser et comprendre la [structure de projet](https://drivendata.github.io/cookiecutter-data-science/#directory-structure) propos√©e par le template ;\n",
        "- Modifier l'arborescence du projet selon le mod√®le ;\n",
        "- Mettre √† jour l'import des d√©pendances, le fichier de configuration et `main.py` avec les nouveaux chemins ;\n",
        ":::\n",
        "\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli6\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "## √âtape 3: mieux tracer notre chaine de production\n",
        "\n",
        "### Indiquer l'environnement minimal de reproductibilit√©\n",
        "\n",
        "Le script `main.py` n√©cessite un certain nombre de packages pour\n",
        "√™tre fonctionnel. Chez vous les packages n√©cessaires sont\n",
        "bien s√ªr install√©s mais √™tes-vous assur√© que c'est le cas\n",
        "chez la personne qui testera votre code ?\n",
        "\n",
        "Afin de favoriser la portabilit√© du projet,\n",
        "il est d'usage de _\"fixer l'environnement\"_,\n",
        "c'est-√†-dire d'indiquer dans un fichier toutes les d√©pendances utilis√©es ainsi que leurs version.\n",
        "Nous proposons de cr√©er un fichier `requirements.txt` minimal, sur lequel nous reviendrons\n",
        "dans la partie consacr√©e aux environnements reproductibles.\n",
        "\n",
        "Le fichier `requirements.txt` est conventionnellement localis√© √† la racine du projet.\n",
        "Ici on ne va pas fixer les versions, on raffinera ce fichier ult√©rieurement.\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "\n",
        "## Application 7a: cr√©ation du `requirements.txt`\n",
        "\n",
        "- Cr√©er un fichier `requirements.txt` avec la liste des packages n√©cessaires\n",
        "- Ajouter une indication dans `README.md` sur l'installation des _packages_ gr√¢ce au fichier `requirements.txt`\n",
        ":::\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli7\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "### Tracer notre cha√Æne\n",
        "\n",
        "Quand votre projet passera en production, vous aurez un acc√®s limit√© √† celui-ci. Il est donc important de faire remonter, par le biais du _logging_ des informations critiques sur votre projet qui vous permettront de savoir o√π il en est (si vous avez acc√®s √† la console o√π il tourne) ou l√† o√π il s'est arr√™t√©.\n",
        "\n",
        "L'utilisation de `print` montre rapidement ses limites pour cela. Les informations enregistr√©es ne persistent pas apr√®s la session et sont quelques peu rudimentaires.\n",
        "\n",
        "Pour faire du _logging_, la librairie consacr√©e depuis longtemps en `Python` est... [`logging`](https://docs.python.org/3/library/logging.html). On va n√©anmoins ici proposer d'utiliser [`loguru`](https://github.com/Delgan/loguru) qui est un peu plus simple √† configurer (l'instanciation du _logger_ est plus ais√©e) et plus agr√©able gr√¢ce √† ses messages en couleurs qui permettent de visuellement trier les informations.\n",
        "\n",
        "![](https://raw.githubusercontent.com/Delgan/loguru/master/docs/_static/img/demo.gif)\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "\n",
        "## Application 7b: remont√©e de messages par _logging_\n",
        "\n",
        "1. Installer `loguru` et l'ajouter au `requirements.txt`\n",
        "2. En s'aidant du `README` du projet sur [`Github`](https://github.com/Delgan/loguru), remplacer nos `print` par diff√©rents types de messages (info, success, etc.).\n",
        "3. Tester l'ex√©cution du script en ligne de commande et observer vos sorties\n",
        "4. Mettre √† jour le logger pour enregistrer dans un fichier de _log_. Ajouter celui-ci au `.gitignore` puis tester en ligne de commande votre script. Ouvrir le fichier en question, refaites tourner le script et regardez son √©volutoin.\n",
        "5. Il est possible avec `loguru` de capturer les erreurs des fonctions gr√¢ce au syst√®me de cache d√©crit [ici](https://github.com/Delgan/loguru?tab=readme-ov-file#exceptions-catching-within-threads-or-main).\n",
        "Introduire une erreur dans une des fonctions (par exemple dans `split_train_test`) avec un code du type `raise ValueError(\"Probl√®me ici\")`\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "## √âtape 4 : stocker les donn√©es de mani√®re externe {#stockageS3}\n",
        "\n",
        "L'√©tape pr√©c√©dente nous a permis d'isoler la configuration. Nous avons conceptuellement isol√© les donn√©es du code lors des applications pr√©c√©dentes. Cependant, nous n'avons pas √©t√© au bout du chemin car le stockage des donn√©es reste conjoint √† celui du code. Nous allons maintenant dissocier ces deux √©l√©ments.\n",
        "\n",
        "::: {.callout-warning collapse=\"true\"}\n",
        "## Pour en savoir plus sur le syst√®me de stockage `S3`\n",
        "\n",
        "Pour mettre en oeuvre cette √©tape, il peut √™tre utile de\n",
        "comprendre un peu comme fonctionne le SSP Cloud.\n",
        "Vous devrez suivre la [documentation du SSP Cloud](https://inseefrlab.github.io/docs.sspcloud.fr/docs/fr/storage.html) pour la r√©aliser. Une aide-m√©moire est √©galement disponible dans le cours\n",
        "de 2e ann√©e de l'ENSAE [Python pour la _data science_](https://linogaliana-teaching.netlify.app/reads3/#).\n",
        ":::\n",
        "\n",
        "\n",
        "Le chapitre sur la [structure des projets](/chapters/projects-architecture.qmd)\n",
        "d√©veloppe l'id√©e qu'il est recommand√© de converger vers un mod√®le\n",
        "o√π environnements d'ex√©cution, de stockage du code et des donn√©es sont conceptuellement\n",
        "s√©par√©s. Ce haut niveau d'exigence est un gain de temps important\n",
        "lors de la mise en production car au cours de cette derni√®re, le projet\n",
        "est amen√© √† √™tre ex√©cut√© sur une infrastructure informatique d√©di√©e\n",
        "qu'il est bon d'anticiper. Sch√©matiquement, nous visons la structure de projet suivante:\n",
        "\n",
        "![](https://inseefrlab.github.io/formation-bonnes-pratiques-git-R/slides/img/environment_clean.png)\n",
        "\n",
        "A l'heure actuelle, les donn√©es sont stock√©es dans le d√©p√¥t. C'est une\n",
        "mauvaise pratique. En premier lieu, `Git` n'est techniquement\n",
        "pas bien adapt√© au stockage de donn√©es. Ici ce n'est pas tr√®s grave\n",
        "car il ne s'agit pas de donn√©es volumineuses et ces derni√®res ne sont\n",
        "pas modifi√©es au cours de notre chaine de traitement.\n",
        "\n",
        "La raison principale\n",
        "est que les donn√©es trait√©es par les _data scientists_\n",
        "sont g√©n√©ralement soumises √† des clauses de\n",
        "confidentialit√©s ([RGPD](https://www.cnil.fr/fr/rgpd-de-quoi-parle-t-on), [secret statistique](https://www.insee.fr/fr/information/1300624)...). Mettre ces donn√©es sous contr√¥le de version\n",
        "c'est prendre le risque de les divulguer √† un public non habilit√©.\n",
        "Il est donc recommand√© de privil√©gier des outils techniques adapt√©s au\n",
        "stockage de donn√©es.\n",
        "\n",
        "L'id√©al, dans notre cas, est d'utiliser une solution de stockage externe.\n",
        "On va utiliser pour cela `MinIO`, la solution de stockage de type `S3` offerte par le SSP Cloud.\n",
        "Cela nous permettra de supprimer les donn√©es de `Github` tout en maintenant la reproductibilit√©\n",
        "de notre projet [^history].\n",
        "\n",
        "[^history]: Attention, les donn√©es ont √©t√© _committ√©es_ au moins une fois. Les supprimer\n",
        "du d√©p√¥t ne les efface pas de l'historique. Si cette erreur arrive, le mieux est de supprimer\n",
        "le d√©p√¥t en ligne, cr√©er un nouvel historique `Git` et partir de celui-ci pour des publications\n",
        "ult√©rieures sur `Github`. N√©anmoins l'id√©al serait de ne pas s'exposer √† cela. C'est justement\n",
        "l'objet des bonnes pratiques de ce cours: un `.gitignore` bien construit et une s√©paration des\n",
        "environnements de stockage du code et\n",
        "des donn√©es seront bien plus efficaces pour vous √©viter ces probl√®mes que tout les conseils de\n",
        "vigilance que vous pourrez trouver ailleurs.\n",
        "\n",
        "Plus concr√®tement, nous allons adopter le pipeline suivant pour notre projet:\n",
        "\n",
        "![](/chapters/applications/figures/pipeline_appli8.png)\n",
        "\n",
        "Le sc√©nario type est que nous avons une source brute, re√ßue sous forme de CSV, dont on ne peut changer le format. Il aurait √©t√© id√©al d'avoir un format plus adapt√© au traitement de donn√©es pour ce fichier mais ce n'√©tait pas de notre ressort. Notre chaine va aller chercher ce fichier, travailler dessus jusqu'√† valoriser celui-ci sous la forme de notre matrice de confusion. Si on imagine que notre chaine prend un certain temps, il n'est pas inutile d'√©crire des donn√©es interm√©diaires. Pour faire cela, puisque nous avons la main, autant choisir un format adapt√©, √† savoir le format `Parquet`.\n",
        "\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "\n",
        "## Application 8: utilisation d'un syst√®me de stockage distant\n",
        "\n",
        "A partir de la ligne de commande,\n",
        "utiliser l'utilitaire [MinIO](https://min.io/docs/minio/linux/reference/minio-mc.html)\n",
        "pour copier les donn√©es `data/raw/data.csv`\n",
        "vers votre\n",
        "bucket personnel. Les donn√©es interm√©diaires\n",
        "peuvent √™tre laiss√©es en local mais doivent √™tre ajout√©es\n",
        "au `.gitignore`.\n",
        "\n",
        "\n",
        "<details>\n",
        "<summary>Indice</summary>\n",
        "\n",
        "Structure √† adopter:\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "mc cp data/raw/data.csv s3/$BUCKET_PERSONNEL/ensae-reproductibilite/data/raw/data.csv\n",
        "```\n",
        "\n",
        "en modifiant `$BUCKET_PERSONNEL`, l'emplacement de votre bucket personnel\n",
        "</details>\n",
        "\n",
        "Pour se simplifier la vie, on va utiliser des URL de t√©l√©chargement des fichiers\n",
        "(comme si ceux-ci √©taient sur n'importe quel espace de stockage) plut√¥t que d'utiliser\n",
        "une librairie `S3` compatible comme `boto3` ou `s3fs`.\n",
        "\n",
        "Par d√©faut, le contenu de votre _bucket_ est priv√©, seul vous y avez acc√®s. N√©anmoins,\n",
        "vous pouvez rendre accessible √† tous en lecture le contenu de votre _bucket_ en\n",
        "faisant lui donnant des droits anonymes.\n",
        "Pour cela, en ligne de\n",
        "commande, faire:\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "mc anonymous set download s3/$BUCKET_PERSONNEL/ensae-reproductibilite/data/raw/\n",
        "```\n",
        "\n",
        "en modifiant `$BUCKET_PERSONNEL`. Les URL de t√©l√©chargement seront de la forme\n",
        "`https://minio.lab.sspcloud.fr/$BUCKET_PERSONNEL/ensae-reproductibilite/data/raw/data.csv`\n",
        "\n",
        "En premier lieu, on va am√©liorer la brique d'ingestion et de pr√©paration des donn√©es\n",
        "\n",
        "- Modifier le fichier `.env` et la variable `data_path` pour utiliser, par d√©faut, directement l'URL dans l'import;\n",
        "- Modifier les valeurs par d√©faut dans votre code ;\n",
        "- Ajouter le dossier `data/` au `.gitignore` ainsi que les fichiers `*.parquet`\n",
        "- Supprimer le dossier `data` de votre projet et faites `git rm --cached -r data`\n",
        "\n",
        "\n",
        "Nous allons en profiter pour am√©liorer nos donn√©es interm√©diaires. Dans `main.py`, remplacer les chemins par ceux-ci:\n",
        "\n",
        "```{.python file=\"main.py\"}\n",
        "# main.py\n",
        "data_path = os.environ.get(\"data_path\", URL_RAW)\n",
        "data_train_path = os.environ.get(\"train_path\", \"data/derived/train.parquet\")\n",
        "data_test_path = os.environ.get(\"test_path\", \"data/derived/test.parquet\")\n",
        "```\n",
        "\n",
        "o√π `URL_RAW` est le lien de la forme `\"https://minio.lab.sspcloud.fr/$BUCKET_PERSONNEL/ensae-reproductibilite/data/raw/data.csv\"`\n",
        "\n",
        "Dans `data/pipeline/build_pipeline.py`, remplacer l'√©criture des donn√©es par ce morceau:\n",
        "\n",
        "```{.python file=\"data/pipeline/build_pipeline.py\"}\n",
        "# data/pipeline/build_pipeline.py\n",
        "if train_path:\n",
        "    pd.concat([X_train, y_train]).to_parquet(train_path)\n",
        "if test_path:\n",
        "    pd.concat([X_test, y_test]).to_parquet(test_path)\n",
        "```\n",
        "\n",
        "- V√©rifier le bon fonctionnement de votre application.\n",
        "\n",
        "\n",
        "Maintenant qu'on a arrang√© la structure de notre projet, c'est l'occasion\n",
        "de supprimer le code qui n'est plus n√©cessaire au bon fonctionnement de notre\n",
        "projet (cela r√©duit la charge de maintenance[^pourapres]).\n",
        "\n",
        "Pour vous aider, vous pouvez\n",
        "utiliser [`vulture`](https://pypi.org/project/vulture/) de mani√®re it√©rative\n",
        "pour vous assister dans le nettoyage de votre code.\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "vulture main.py src/\n",
        "```\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "Exemple de sortie\n",
        "</summary>\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "vulture .\n",
        "```\n",
        "\n",
        "```{.python}\n",
        "src/data/import_data.py:3: unused function 'split_and_count' (60% confidence)\n",
        "```\n",
        "\n",
        "</details>\n",
        "\n",
        ":::\n",
        "\n",
        "[^pourapres]: Lorsqu'on d√©veloppe du code qui finalement ne s'av√®re plus n√©cessaire, on a souvent un cas de conscience √† le supprimer et on pr√©f√®re le mettre de c√¥t√©. Au final, ce syndr√¥me de Diog√®ne est mauvais pour la p√©rennit√© du projet : on se retrouve √† devoir maintenir une base de code qui n'est, en pratique, pas utilis√©e. Ce n'est pas un probl√®me de supprimer un code ; si finalement celui-ci s'av√®re utile, on peut le retrouver gr√¢ce √† l'historique `Git` et les outils de recherche sur `Github`. Le _package_ `vulture` est tr√®s pratique pour diagnostiquer les morceaux de code inutiles dans un projet.\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli8\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "# Partie 2bis: packagisation de son projet (optionnel)\n",
        "\n",
        "Cette s√©rie d'actions n'est pas forc√©ment pertinente pour tous\n",
        "les projets. Elle fait un peu la transition entre la modularit√©\n",
        "et la portabilit√©.\n",
        "\n",
        "## √âtape 1 : proposer des tests unitaires (optionnel)\n",
        "\n",
        "Notre code comporte un certain nombre de fonctions g√©n√©riques.\n",
        "On peut vouloir tester leur usage sur des donn√©es standardis√©es,\n",
        "diff√©rentes de celles du Titanic.\n",
        "\n",
        "M√™me si la notion de tests unitaires\n",
        "prend plus de sens dans un _package_, nous pouvons proposer\n",
        "dans le projet des exemples d'utilisation de la fonction, ceci peut √™tre p√©dagogique.\n",
        "\n",
        "Nous allons utiliser [`unittest`](https://docs.python.org/3/library/unittest.html)\n",
        "pour effectuer des tests unitaires. Cette approche n√©cessite quelques notions\n",
        "de programmation orient√©e objet ou une bonne discussion avec `ChatGPT`.\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "\n",
        "## Application 9: test unitaire _(optionnel)_\n",
        "\n",
        "Dans le dossier `tests/`, cr√©er avec l'aide de `ChatGPT` ou \n",
        "de `Copilot` un test pour la fonction\n",
        "`split_and_count`. \n",
        "\n",
        "- Effectuer le test unitaire en ligne de commande avec `unittest` (`python -m unittest tests/test_split.py`). Corriger le test unitaire en cas d'erreur. \n",
        "- Si le temps le permet, proposer des variantes ou d'autres tests.\n",
        ":::\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli9\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "::: {.callout-note}\n",
        "\n",
        "Lorsqu'on effectue des tests unitaires, on cherche g√©n√©ralement\n",
        "√† tester le plus de lignes possibles de son code. On parle de\n",
        "__taux de couverture__ (_coverage rate_) pour d√©signer\n",
        "la statistique mesurant cela.\n",
        "\n",
        "Cela peut s'effectuer de la mani√®re suivante avec le package\n",
        "[`coverage`](https://coverage.readthedocs.io/en/7.2.2/):\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "coverage run -m unittest tests/test_create_variable_title.py\n",
        "coverage report -m\n",
        "```\n",
        "\n",
        "```{.python}\n",
        "Name                                  Stmts   Miss  Cover   Missing\n",
        "-------------------------------------------------------------------\n",
        "src/features/build_features.py           34     21    38%   35-36, 48-58, 71-74, 85-89, 99-101, 111-113\n",
        "tests/test_create_variable_title.py      21      1    95%   54\n",
        "-------------------------------------------------------------------\n",
        "TOTAL                                    55     22    60%\n",
        "```\n",
        "\n",
        "Le taux de couverture est souvent mis en avant par les gros\n",
        "projets comme indicateur de leur qualit√©. Il existe d'ailleurs\n",
        "des badges `Github` d√©di√©s.\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "## √âtape 2 : transformer son projet en package (optionnel)\n",
        "\n",
        "Notre projet est modulaire, ce qui le rend assez simple √† transformer\n",
        "en _package_, en s'inspirant de la structure du `cookiecutter` adapt√©, issu\n",
        "de [cet ouvrage](https://py-pkgs.org/03-how-to-package-a-python#package-structure).\n",
        "\n",
        "On va cr√©er un _package_ nomm√© `titanicml` qui encapsule\n",
        "tout notre code et qui sera appel√©\n",
        "par notre script `main.py`. La structure attendue\n",
        "est la suivante:\n",
        "\n",
        "<details>\n",
        "<summary>Structure vis√©e</summary>\n",
        "\n",
        "```\n",
        "ensae-reproductibilite-application\n",
        "‚îú‚îÄ‚îÄ docs                                    ‚îê\n",
        "‚îÇ   ‚îú‚îÄ‚îÄ main.py                             ‚îÇ\n",
        "‚îÇ   ‚îî‚îÄ‚îÄ notebooks                           ‚îÇ Package documentation and examples\n",
        "‚îÇ       ‚îî‚îÄ‚îÄ titanic.ipynb                   ‚îÇ\n",
        "‚îú‚îÄ‚îÄ configuration                           ‚îê Configuration (pas √† partager avec Git)\n",
        "‚îÇ   ‚îî‚îÄ‚îÄ config.yaml                         ‚îò\n",
        "‚îú‚îÄ‚îÄ README.md\n",
        "‚îú‚îÄ‚îÄ pyproject.toml                          ‚îê\n",
        "‚îú‚îÄ‚îÄ requirements.txt                        ‚îÇ\n",
        "‚îú‚îÄ‚îÄ titanicml                               ‚îÇ\n",
        "‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                         ‚îÇ Package source code, metadata\n",
        "‚îÇ   ‚îú‚îÄ‚îÄ data                                ‚îÇ and build instructions\n",
        "‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ import_data.py                  ‚îÇ\n",
        "‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_create_variable_title.py   ‚îÇ\n",
        "‚îÇ   ‚îú‚îÄ‚îÄ features                            ‚îÇ\n",
        "‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ build_features.py               ‚îÇ\n",
        "‚îÇ   ‚îî‚îÄ‚îÄ models                              ‚îÇ\n",
        "‚îÇ       ‚îî‚îÄ‚îÄ train_evaluate.py               ‚îò\n",
        "‚îî‚îÄ‚îÄ tests                                   ‚îê\n",
        "    ‚îî‚îÄ‚îÄ test_create_variable_title.py       ‚îò Package tests\n",
        "```\n",
        "</details>\n",
        "\n",
        "<details>\n",
        "<summary>Rappel: structure actuelle</summary>\n",
        "\n",
        "```\n",
        "ensae-reproductibilite-application\n",
        "‚îú‚îÄ‚îÄ notebooks\n",
        "‚îÇ   ‚îî‚îÄ‚îÄ titanic.ipynb\n",
        "‚îú‚îÄ‚îÄ configuration\n",
        "‚îÇ   ‚îî‚îÄ‚îÄ config.yaml\n",
        "‚îú‚îÄ‚îÄ main.py\n",
        "‚îú‚îÄ‚îÄ README.md\n",
        "‚îú‚îÄ‚îÄ requirements.txt\n",
        "‚îî‚îÄ‚îÄ src\n",
        "    ‚îú‚îÄ‚îÄ data\n",
        "    ‚îÇ   ‚îú‚îÄ‚îÄ import_data.py\n",
        "    ‚îÇ   ‚îî‚îÄ‚îÄ test_create_variable_title.py\n",
        "    ‚îú‚îÄ‚îÄ features\n",
        "    ‚îÇ   ‚îî‚îÄ‚îÄ build_features.py\n",
        "    ‚îî‚îÄ‚îÄ models\n",
        "        ‚îî‚îÄ‚îÄ train_evaluate.py\n",
        "```\n",
        "</details>\n",
        "\n",
        "Il existe plusieurs\n",
        "_frameworks_ pour\n",
        "construire un _package_. Nous\n",
        "allons privil√©gier [`Poetry`](https://python-poetry.org/)\n",
        "√† [`Setuptools`](https://pypi.org/project/setuptools/).\n",
        "\n",
        "\n",
        "::: {.callout-note}\n",
        "\n",
        "Pour cr√©er la structure minimale d'un _package_, le plus simple est\n",
        "d'utiliser le `cookiecutter` adapt√©,\n",
        "issu de [cet ouvrage](https://py-pkgs.org/03-how-to-package-a-python#package-structure).\n",
        "\n",
        "Comme on a d√©j√† une structure tr√®s modulaire, on va plut√¥t recr√©er cette\n",
        "structure dans notre projet d√©j√† existant. En fait, il ne manque qu'un fichier essentiel,\n",
        "le principal distinguant un projet classique d'un package : `pyproject.toml`.\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "cookiecutter https://github.com/py-pkgs/py-pkgs-cookiecutter.git\n",
        "```\n",
        "\n",
        "<details>\n",
        "<summary>D√©rouler pour voir les choix possibles</summary>\n",
        "```{.python}\n",
        "author_name [Monty Python]: Daffy Duck\n",
        "package_name [mypkg]: titanicml\n",
        "package_short_description []: Impressive Titanic survival analysis\n",
        "package_version [0.1.0]:\n",
        "python_version [3.9]:\n",
        "Select open_source_license:\n",
        "1 - MIT\n",
        "2 - Apache License 2.0\n",
        "3 - GNU General Public License v3.0\n",
        "4 - Creative Commons Attribution 4.0\n",
        "5 - BSD 3-Clause\n",
        "6 - Proprietary\n",
        "7 - None\n",
        "Choose from 1, 2, 3, 4, 5, 6 [1]:\n",
        "Select include_github_actions:\n",
        "1 - no\n",
        "2 - ci\n",
        "3 - ci+cd\n",
        "Choose from 1, 2, 3 [1]:\n",
        "```\n",
        "</details>\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "\n",
        "## Application 10: packagisation _(optionnel)_\n",
        "\n",
        "- Renommer le dossier `titanicml` pour respecter la nouvelle\n",
        "arborescence ;\n",
        "- Cr√©er un fichier `pyproject.toml` sur cette base ;\n"
      ],
      "id": "3c793e60"
    },
    {
      "cell_type": "code",
      "metadata": {
        "filename": "pyproject.toml"
      },
      "source": [
        "#| eval: false\n",
        "#| code-summary: pyproject.toml\n",
        "[tool.poetry]\n",
        "name = \"titanicml\"\n",
        "version = \"0.0.1\"\n",
        "description = \"Awesome Machine Learning project\"\n",
        "authors = [\"Daffy Duck <daffy.duck@fauxmail.fr>\", \"Mickey Mouse\"]\n",
        "license = \"MIT\"\n",
        "readme = \"README.md\"\n",
        "\n",
        "[build-system]\n",
        "requires = [\"poetry-core\"]\n",
        "build-backend = \"poetry.core.masonry.api\"\n",
        "\n",
        "[tool.pytest.ini_options]\n",
        "log_cli = true\n",
        "log_cli_level = \"WARNING\"\n",
        "log_cli_format = \"%(asctime)s [%(levelname)8s] %(message)s (%(filename)s:%(lineno)s)\"\n",
        "log_cli_date_format = \"%Y-%m-%d %H:%M:%S\""
      ],
      "id": "9e423a34",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "- Cr√©er le dossier `docs` et mettre les fichiers indiqu√©s dedans\n",
        "- Dans `titanicml/`, cr√©er un fichier `__init__.py`[^init]\n"
      ],
      "id": "705f10ab"
    },
    {
      "cell_type": "code",
      "metadata": {
        "filename": "__init__.py"
      },
      "source": [
        "#| eval: false\n",
        "#| code-summary: __init__.py\n",
        "from .data.import_data import (\n",
        "    split_and_count\n",
        ")\n",
        "from .pipeline.build_pipeline import (\n",
        "    split_train_test,\n",
        "    create_pipeline\n",
        ")\n",
        "from .models.train_evaluate import (\n",
        "    evaluate_model\n",
        ")\n",
        "__all__ = [\n",
        "    \"split_and_count\",\n",
        "    \"split_train_test\",\n",
        "    \"create_pipeline\",\n",
        "    \"evaluate_model\"\n",
        "]"
      ],
      "id": "7dd890cd",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "- Installer le package en local avec `pip install -e .`\n",
        "- Modifier le contenu de `docs/main.py` pour importer les fonctions de notre _package_ `titanicml` et tester en\n",
        "ligne de commande notre fichier `main.py`\n",
        ":::\n",
        "\n",
        "[^init]: Le fichier `__init__.py` indique √† `Python` que le dossier\n",
        "est un _package_. Il permet de proposer certaines configurations\n",
        "lors de l'import du _package_. Il permet √©galement de contr√¥ler\n",
        "les objets export√©s (c'est-√†-dire mis √† disposition de l'utilisateur)\n",
        "par le _package_ par rapport aux objets internes au _package_.\n",
        "En le laissant vide, nous allons utiliser ce fichier\n",
        "pour importer l'ensemble des fonctions de nos sous-modules.\n",
        "Ce n'est pas la meilleure pratique mais un contr√¥le plus fin des\n",
        "objets export√©s demanderait un investissement qui ne vaut, ici, pas\n",
        "le co√ªt.\n",
        "\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli10\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "# Partie 3 : construction d'un projet portable et reproductible {#partie3}\n",
        "\n",
        "Dans la partie pr√©c√©dente,\n",
        "on a appliqu√© de mani√®re incr√©mentale de nombreuses bonnes pratiques vues\n",
        "dans les chapitres [Qualit√© du code](/chapters/code-quality.html)\n",
        "et [Structure des projets](/chapters/projects-architecture.html)\n",
        "tout au long du cours.\n",
        "\n",
        "Ce faisant, on s'est d√©j√† consid√©rablement rapproch√©s d'une\n",
        "possible mise en production : le code est lisible,\n",
        "la structure du projet est normalis√©e et √©volutive,\n",
        "et le code est proprement versionn√© sur un\n",
        "d√©p√¥t `GitHub` {{< fa brands github >}}.\n",
        "\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "Illustration de l'√©tat actuel du projet\n",
        "</summary>\n",
        "![](/chapters/applications/figures/_pipeline_avant_partie3.png)\n",
        "\n",
        "</details>\n",
        "\n",
        "\n",
        "\n",
        "A pr√©sent, nous avons une version du projet qui est largement partageable.\n",
        "Du moins en th√©orie, car la pratique est souvent plus compliqu√©e :\n",
        "il y a fort √† parier que si vous essayez d'ex√©cuter votre projet sur un autre environnement (typiquement, votre ordinateur personnel),\n",
        "les choses ne se passent pas du tout comme attendu. Cela signifie qu'**en l'√©tat, le projet n'est pas portable : il n'est pas possible, sans modifications co√ªteuses, de l'ex√©cuter dans un environnement diff√©rent de celui dans lequel il a √©t√© d√©velopp√©**.\n",
        "\n",
        "Dans cette trois√®me partie de notre travail vers la mise en production,\n",
        "nous allons voir\n",
        "comment **normaliser l'environnement d'ex√©cution afin de produire un projet portable**.\n",
        "Autrement dit, nous n'allons plus nous contenter de modularit√© mais allons rechercher\n",
        "la portabilit√©.\n",
        "On sera alors tout proche de pouvoir mettre le projet en production.\n",
        "\n",
        "On progressera dans l'√©chelle de la reproductibilit√©\n",
        "de la mani√®re suivante:\n",
        "\n",
        "1. [**Environnements virtuels**](#anaconda) ;\n",
        "2. Cr√©er un [script shell](#shell) qui permet, depuis un environnement minimal, de construire l'application de A √† Z ;\n",
        "3. [**Images et conteneurs `Docker`**](#docker).\n",
        "\n",
        "\n",
        "Nous allons repartir de l'application 8, c'est-√†-dire d'un projet\n",
        "modulaire mais qui n'est pas, √† strictement parler, un _package_\n",
        "(objet des applications optionnelles suivantes 9 et 10).\n",
        "\n",
        "Pour se replacer dans l'√©tat du projet √† ce niveau,\n",
        "il est possible d'utiliser le _tag_ _ad hoc_.\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash\n",
        "git checkout appli8\n",
        "```\n",
        "\n",
        "\n",
        "## √âtape 1 : un environnement pour rendre le projet portable {#anaconda}\n",
        "\n",
        "Pour qu'un projet soit portable, il doit remplir deux conditions:\n",
        "\n",
        "- Ne pas n√©cessiter de d√©pendance\n",
        "qui ne soient pas renseign√©es quelque part ;\n",
        "- Ne pas proposer des d√©pendances inutiles, qui ne\n",
        "sont pas utilis√©es dans le cadre du projet.\n",
        "\n",
        "Le prochain exercice vise √† mettre ceci en oeuvre.\n",
        "Comme expliqu√© dans le [chapitre portabilit√©](/chapters/portability.qmd),\n",
        "le choix du gestionnaire d'environnement est laiss√©\n",
        "libre. Il est recommand√© de privil√©gier `venv` si vous d√©couvrez\n",
        "la probl√©matique de la portabilit√©.\n",
        "\n",
        "::: {.panel-tabset group=\"language\"}\n",
        "\n",
        "## Environnement virtuel `venv`\n",
        "\n",
        "L'approche la plus l√©g√®re est l'environnement virtuel.\n",
        "Nous avons en fait implicitement d√©j√† commenc√© √† aller vers\n",
        "cette direction\n",
        "en cr√©ant un fichier `requirements.txt`.\n",
        "\n",
        "\n",
        ":::: {.callout-tip}\n",
        "\n",
        "## Application 11a: environnement virtuel `venv`\n",
        "\n",
        "1. Ex√©cuter `pip freeze` en ligne de commande et observer la (tr√®s) longue\n",
        "liste de package\n",
        "2. Cr√©er l'environnement virtuel `titanic` en s'inspirant de [la documentation officielle](https://packaging.python.org/en/latest/guides/installing-using-pip-and-virtual-environments/)[^pythonversion] ou du [chapitre d√©di√©](/chapters/portability.qmd)\n",
        "3. Utiliser `ls` pour observer et comprendre le contenu du dossier `titanic/bin` install√©\n",
        "4. Activer l'environnement et v√©rifier l'installation de `Python` maintenant utilis√©e par votre machine\n",
        "<!---source titanic/bin/activate && which python---->\n",
        "5. V√©rifier directement depuis la ligne de commande que `Python` ex√©cute bien une commande[^option] avec:\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "python -c \"print('Hello')\"\n",
        "```\n",
        "\n",
        "6. Faire la m√™me chose mais avec `import pandas as pd`\n",
        "7. Installer les _packages_ √† partir du `requirements.txt`. Tester √† nouveau `import pandas as pd` pour comprendre la diff√©rence.\n",
        "8. Ex√©cuter `pip freeze` et comprendre la diff√©rence avec la situation pr√©c√©dente.\n",
        "9. V√©rifier que le script `main.py` fonctionne bien. Sinon ajouter les _packages_ manquants dans le `requirements.txt` et reprendre de mani√®re it√©rative √† partir de la question 7.\n",
        "10. Ajouter le dossier `titanic/` au `.gitignore` pour ne pas ajouter ce dossier √† `Git`.\n",
        "\n",
        "\n",
        "<details>\n",
        "<summary>Aide pour la question 4</summary>\n",
        "\n",
        "Apr√®s l'activation, vous pouvez v√©rifier quel `python`\n",
        "est utilis√© de cette mani√®re\n",
        "\n",
        "```{.bash filename=\"terminal\" env=\"titanic\"}\n",
        "which python\n",
        "```\n",
        "\n",
        "</details>\n",
        "\n",
        "::::\n",
        "\n",
        "[^pythonversion]: Si vous d√©sirez aussi contr√¥ler la version de `Python`, ce qui peut √™tre important\n",
        "dans une perspective de portabilit√©, vous pouvez ajouter une option, par exemple `-p python3.10`. N√©anmoins\n",
        "nous n'allons pas nous embarasser de cette nuance pour la suite car nous pourrons contr√¥ler\n",
        "la version de `Python` plus finement par le biais de `Docker`.\n",
        "[^option]: L'option `-c` pass√©e apr√®s la commande `python` permet d'indiquer √† `Python` que la commande\n",
        "ne se trouve pas dans un fichier mais sera dans le texte qu'on va directement lui fournir.\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli11a\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "## Environnement `conda`\n",
        "\n",
        "Les environnements `conda` sont plus lourds √† mettre en oeuvre que les\n",
        "environnements virtuels mais peuvent permettre un contr√¥le\n",
        "plus formel des d√©pendances.\n",
        "\n",
        "\n",
        ":::: {.callout-tip}\n",
        "\n",
        "## Application 11b: environnement `conda` \n",
        "\n",
        "1. Ex√©cuter `conda env export` en ligne de commande et observer la (tr√®s) longue\n",
        "liste de package\n",
        "2. Cr√©er un environnement `titanic`\n",
        "avec [`conda create`](https://conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html#creating-an-environment-with-commands)\n",
        "4. Activer l'environnement et v√©rifier l'installation de `Python` maintenant utilis√©e par votre machine \n",
        "<!---conda activate titanic && which python---->\n",
        "5. V√©rifier directement depuis la ligne de commande que `Python` ex√©cute bien une commande[^option] avec:\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "python -c \"print('Hello')\"\n",
        "```\n",
        "\n",
        "6. Faire la m√™me chose mais avec `import pandas as pd`\n",
        "7. Installer les _packages_ qu'on avait list√© dans le `requirements.txt` pr√©c√©demment. Ne pas faire un `pip install -r requirements.txt` afin de privil√©gier `conda install`\n",
        "8. Ex√©cuter √† nouveau `conda env export` et comprendre la diff√©rence avec la situation pr√©c√©dente[^splitscreen].\n",
        "9. V√©rifier que le script `main.py` fonctionne bien. Sinon installer les _packages_ manquants\n",
        "et reprndre de mani√®re it√©rative\n",
        "√† partir de la question 7.\n",
        "10. Quand `main.py` fonctionne, faire `conda env export > environment.yml` pour figer l'environnement de travail.\n",
        "\n",
        "::::\n",
        "\n",
        "[^splitscreen]: Pour comparer les deux listes, vous pouvez utiliser la fonctionnalit√© de _split_ \n",
        "du terminal sur `VSCode` pour comparer les outputs de `conda env export` en les mettant \n",
        "en face √† face. \n",
        "\n",
        ":::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli11b\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        "::::\n",
        "\n",
        "\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "## √âtape 2: construire l'environnement de notre application via un script `shell` {#shell}\n",
        "\n",
        "Les environnements virtuels permettent de mieux sp√©cifier les d√©pendances de notre projet, mais ne permettent pas de garantir une portabilit√© optimale. Pour cela, il faut recourir √† la technologie des conteneurs. L'id√©e est de construire une machine, en partant d'une base quasi-vierge, qui permette de construire √©tape par √©tape l'environnement n√©cessaire au bon fonctionnement de notre projet. C'est le principe des conteneurs `Docker` {{< fa brands docker >}}.\n",
        "\n",
        "Leur m√©thode de construction √©tant un peu difficile √† prendre en main au d√©but, nous allons passer par une √©tape interm√©diaire afin de bien comprendre le processus de production.\n",
        "\n",
        "- Nous allons d'abord cr√©er un script `shell`, c'est √† dire une suite de commandes `Linux` permettant de construire l'environnement √† partir d'une machine vierge ;\n",
        "- Nous transformerons celui-ci en `Dockerfile` dans un deuxi√®me temps. C'est l'objet de l'√©tape suivante.\n",
        "\n",
        "::: {.panel-tabset group=\"language\"}\n",
        "\n",
        "## Environnement virtuel `venv`\n",
        "\n",
        "\n",
        ":::: {.callout-tip}\n",
        "\n",
        "## Application 12a : cr√©er un fichier d'installation de A √† Z\n",
        "\n",
        "1. Cr√©er un service `ubuntu` sur le SSP Cloud\n",
        "2. Ouvrir un terminal\n",
        "3. Cloner le d√©p√¥t \n",
        "4. Se placer dans le dossier du projet avec `cd`\n",
        "5. Se placer au niveau du checkpoint 11a avec `git checkout appli11a`\n",
        "6. Via l'explorateur de fichiers, cr√©er le fichier `install.sh` √† la racine du projet avec le contenu suivant:\n",
        "\n",
        "<details>\n",
        "<summary>Script √† cr√©er sous le nom `install.sh` </summary>\n",
        "```{.bash filename=\"install.sh\" no-prefix=true}\n",
        "#!/bin/bash\n",
        "\n",
        "# Install Python\n",
        "apt-get -y update\n",
        "apt-get install -y python3-pip python3-venv\n",
        "\n",
        "# Create empty virtual environment\n",
        "python3 -m venv titanic\n",
        "source titanic/bin/activate\n",
        "\n",
        "# Install project dependencies\n",
        "pip install -r requirements.txt\n",
        "```\n",
        "</details>\n",
        "\n",
        "6. Changer les permissions sur le script pour le rendre ex√©cutable\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "chmod +x install.sh\n",
        "```\n",
        "\n",
        "7. Ex√©cuter le script depuis la ligne de commande avec des droits de super-utilisateur (n√©cessaires pour installer des *packages* via `apt`)\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "sudo ./install.sh\n",
        "```\n",
        "\n",
        "8. V√©rifier que le script `main.py` fonctionne correctement dans l'environnement virtuel cr√©√© \n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "source titanic/bin/activate\n",
        "python3 main.py\n",
        "```\n",
        "\n",
        "::::\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli12a\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "## Environnement `conda`\n",
        "\n",
        "\n",
        ":::: {.callout-tip}\n",
        "\n",
        "## Application 12b : cr√©er un fichier d'installation de A √† Z\n",
        "\n",
        "1. Cr√©er un service `ubuntu` sur le SSP Cloud\n",
        "2. Ouvrir un terminal\n",
        "3. Cloner le d√©p√¥t \n",
        "4. Se placer dans le dossier du projet avec `cd`\n",
        "5. Se placer au niveau du checkpoint 11b avec `git checkout appli11b`\n",
        "6. Via l'explorateur de fichiers, cr√©er le fichier `install.sh` √† la racine du projet avec le contenu suivant:\n",
        "\n",
        "<details>\n",
        "<summary>Script √† cr√©er sous le nom `install.sh` </summary>\n",
        "```{.bash filename=\"install.sh\" no-prefix=true}\n",
        "apt-get -y update && apt-get -y install wget\n",
        "\n",
        "wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh && \\\n",
        "    bash Miniconda3-latest-Linux-x86_64.sh -b -p /miniconda && \\\n",
        "    rm -f Miniconda3-latest-Linux-x86_64.sh\n",
        "\n",
        "PATH=\"/miniconda/bin:${PATH}\"\n",
        "\n",
        "# Create environment\n",
        "conda create -n titanic pandas PyYAML scikit-learn -c conda-forge\n",
        "conda activate titanic\n",
        "\n",
        "PATH=\"/miniconda/envs/titanic/bin:${PATH}\"\n",
        "\n",
        "python main.py\n",
        "```\n",
        "</details>\n",
        "\n",
        "6. Changer les permissions sur le script pour le rendre ex√©cutable\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "chmod +x install.sh\n",
        "```\n",
        "\n",
        "7. Ex√©cuter le script depuis la ligne de commande avec des droits de super-utilisateur (n√©cessaires pour installer des *packages* via `apt`)\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "sudo ./install.sh\n",
        "```\n",
        "\n",
        "8. V√©rifier que le script `main.py` fonctionne correctement dans l'environnement virtuel cr√©√© \n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "conda activate titanic\n",
        "python3 main.py\n",
        "```\n",
        "\n",
        "::::\n",
        "\n",
        ":::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli12b\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        "::::\n",
        "\n",
        "\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "## √âtape 3: conteneuriser l'application avec `Docker` {#docker}\n",
        "\n",
        "\n",
        "::: {.callout-note}\n",
        "Cette application n√©cessite l'acc√®s √† une version interactive de `Docker`.\n",
        "Il n'y a pas beaucoup d'instances en ligne disponibles.\n",
        "\n",
        "Nous proposons deux solutions:\n",
        "\n",
        "- [Installer `Docker`](https://docs.docker.com/get-docker/) sur sa machine ;\n",
        "- Se rendre sur l'environnement bac √† sable _[Play with Docker](https://labs.play-with-docker.com)_\n",
        "\n",
        "Sinon, elle peut √™tre r√©alis√©e en essai-erreur par le biais des services d'int√©gration continue de `Github` {{< fa brands github >}} ou `Gitlab` {{< fa brands gitlab >}}. N√©anmoins, nous pr√©senterons l'utilisation de ces services plus tard, dans la prochaine partie.\n",
        ":::\n",
        "\n",
        "Maintenant qu'on sait que ce script pr√©paratoire fonctionne, on va le transformer en `Dockerfile` pour anticiper la mise en production.  Comme la syntaxe `Docker` est l√©g√®rement diff√©rente de la syntaxe `Linux` classique (voir le [chapitre portabilit√©](/chapters/portability.qmd)), il va √™tre n√©cessaire de changer quelques instructions mais ceci sera tr√®s l√©ger.\n",
        "\n",
        "On va tester le `Dockerfile` dans un environnement bac √† sable pour ensuite\n",
        "pouvoir plus facilement automatiser la construction de l'image\n",
        "`Docker`.\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "\n",
        "## Application 13: cr√©ation de l'image `Docker` \n",
        "\n",
        "Se placer dans un environnement avec `Docker`, par\n",
        "exemple _[Play with Docker](https://labs.play-with-docker.com)_\n",
        "\n",
        "#### Cr√©ation du `Dockerfile`\n",
        "\n",
        "- Dans le terminal `Linux`, cloner votre d√©p√¥t `Github` \n",
        "- Repartir de la derni√®re version √† disposition. Par exemple, si vous avez privil√©gi√© \n",
        "l'environnement virtuel `venv`, ce sera:\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli12a\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "- Cr√©er via la ligne de commande un fichier texte vierge nomm√© `Dockerfile` (la majuscule au d√©but du mot est importante)\n",
        "\n",
        "<details><summary>Commande pour cr√©er un `Dockerfile` vierge depuis la ligne de commande</summary>\n",
        "```{.bash filename=\"terminal\"}\n",
        "touch Dockerfile\n",
        "```\n",
        "</details>\n",
        "\n",
        "- Ouvrir ce fichier via un √©diteur de texte et copier le contenu suivant dedans:\n",
        "\n",
        "<details><summary>Premier `Dockerfile`</summary>\n",
        "\n",
        "```{.bash filename=\"terminal\" no-prefix=true}\n",
        "FROM ubuntu:22.04\n",
        "\n",
        "WORKDIR ${HOME}/titanic\n",
        "\n",
        "# Install Python\n",
        "RUN apt-get -y update && \\\n",
        "    apt-get install -y python3-pip\n",
        "\n",
        "# Install project dependencies\n",
        "COPY requirements.txt .\n",
        "RUN pip install -r requirements.txt\n",
        "\n",
        "CMD [\"python3\", \"main.py\"]\n",
        "```\n",
        "</details>\n",
        "\n",
        "#### Construire (_build_) l'image\n",
        "\n",
        "- Utiliser `docker build` pour cr√©er une image avec le tag `my-python-app`\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "docker build . -t my-python-app\n",
        "```\n",
        "\n",
        "- V√©rifier les images dont vous disposez. Vous devriez avoir un r√©sultat proche de celui-ci :\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "docker images\n",
        "```\n",
        "\n",
        "```{.python}\n",
        "REPOSITORY      TAG       IMAGE ID       CREATED              SIZE\n",
        "my-python-app   latest    188957e16594   About a minute ago   879MB\n",
        "```\n",
        "\n",
        "#### Tester l'image: d√©couverte du cache\n",
        "\n",
        "L'√©tape de `build` a fonctionn√©: une image a √©t√© construite.\n",
        "\n",
        "Mais fait-elle effectivement ce que l'on attend d'elle ?\n",
        "\n",
        "Pour le savoir, il faut passer √† l'√©tape suivante, l'√©tape de `run`.\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "docker run -it my-python-app\n",
        "```\n",
        "\n",
        "```{.python}\n",
        "python3: can't open file '/~/titanic/main.py': [Errno 2] No such file or directory\n",
        "```\n",
        "\n",
        "Le message d'erreur est clair : `Docker` ne sait pas o√π trouver le fichier `main.py`. D'ailleurs, il ne connait pas non plus les autres fichiers de notre application qui sont n√©cessaires pour faire tourner le code, par exemple le dossier `src`.\n",
        "\n",
        "- Avant l'√©tape `CMD`, copier les fichiers n√©cessaires sur l'image afin que l'application dispose de tous les √©l√©ments n√©cessaires pour √™tre en mesure de fonctionner.\n",
        "\n",
        "<details>\n",
        "<summary>Nouveau `Dockerfile` </summary>\n",
        "```{.bash filename=\"terminal\" no-prefix=true}\n",
        "FROM ubuntu:22.04\n",
        "\n",
        "WORKDIR ${HOME}/titanic\n",
        "\n",
        "# Install Python\n",
        "RUN apt-get -y update && \\\n",
        "    apt-get install -y python3-pip\n",
        "\n",
        "# Install project dependencies\n",
        "COPY requirements.txt .\n",
        "RUN pip install -r requirements.txt\n",
        "\n",
        "COPY main.py .\n",
        "COPY src ./src\n",
        "CMD [\"python3\", \"main.py\"]\n",
        "```\n",
        "</details>\n",
        "\n",
        "- Refaire tourner l'√©tape de `build`\n",
        "\n",
        "- Refaire tourner l'√©tape de `run`. A ce stade, la matrice de confusion doit fonctionner üéâ.\n",
        "Vous avez cr√©√© votre premi√®re application reproductible !\n",
        "\n",
        ":::\n",
        "\n",
        "::: {.callout-note}\n",
        "\n",
        "Ici, le _cache_ permet d'√©conomiser beaucoup de temps. Par besoin de \n",
        "refaire tourner toutes les √©tapes, `Docker` agit de mani√®re intelligente\n",
        "en faisant tourner uniquement les √©tapes qui ont chang√©.\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli13\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "# Partie 4 : automatisation avec l'int√©gration continue\n",
        "\n",
        "\n",
        "Imaginez que vous √™tes au restaurant\n",
        "et qu'on ne vous serve pas le plat mais seulement la recette\n",
        "et que, de plus, on vous demande de pr√©parer le plat\n",
        "chez vous avec les ingr√©dients dans votre frigo.\n",
        "Vous seriez quelque peu d√©√ßu. En revanche, si vous avez go√ªt√©\n",
        "au plat, que vous √™tes un r√©el cordon bleu\n",
        "et qu'on vous donne la recette pour refaire ce plat ult√©rieurement,\n",
        "peut-√™tre\n",
        "que vous appr√©ciriez plus.\n",
        "\n",
        "Cette analogie illustre l'enjeu de d√©finir\n",
        "le public cible et ses attentes afin de fournir un livrable adapt√©.\n",
        "Une image `Docker` est un livrable qui n'est pas forc√©ment int√©ressant\n",
        "pour tous les publics. Certains pr√©f√©reront avoir un plat bien pr√©par√©\n",
        "qu'une recette ; certains appr√©cieront avoir une image `Docker` mais\n",
        "d'autres ne seront pas en mesure de construire celle-ci ou ne sauront\n",
        "pas la faire fonctionner. Une image `Docker` est plus souvent un\n",
        "moyen pour faciliter la mise en service d'une production qu'une fin en soi.\n",
        "\n",
        "Nous allons donc proposer\n",
        "plusieurs types de livrables plus classiques par la suite. Ceux-ci\n",
        "correspondront mieux aux attendus des publics utilisateurs de services\n",
        "construits √† partir de techniques de _data science_. `Docker` est n√©anmoins\n",
        "un passage oblig√© car l'ensemble des types de livrables que nous allons\n",
        "explorer reposent sur la standardisation permise par les conteneurs.\n",
        "\n",
        "Cette approche nous permettra de quitter le domaine de l'artisanat pour\n",
        "s'approcher d'une industrialisation de la mise √† disposition\n",
        "de notre projet. Ceci va notamment nous amener √† mettre en oeuvre\n",
        "l'approche pragmatique du `DevOps` qui consiste √† int√©grer d√®s la phase de\n",
        "d√©veloppement d'un projet les contraintes li√©es √† sa mise √† disposition\n",
        "au public cible (cette approche est d√©taill√©e plus\n",
        "amplement dans le chapitre sur la [mise en production](/chapters/deployment.qmd)).\n",
        "\n",
        "L'automatisation et la mise √† disposition automatis√©e de nos productions\n",
        "sera faite progressivement, au cours des prochaines parties. Tous les\n",
        "projets n'ont pas vocation √† aller aussi loin dans ce domaine.\n",
        "L'opportunit√© doit √™tre compar√©e aux co√ªts humains et financiers\n",
        "de leur mise en oeuvre et de leur cycle de vie.\n",
        "Avant de faire une production en s√©rie de nos mod√®les,\n",
        "nous allons d√©j√† commencer\n",
        "par automatiser quelques tests de conformit√© de notre code.\n",
        "On va ici utiliser l'int√©gration continue pour deux objectifs distincts:\n",
        "\n",
        "- la mise √† disposition de l'image `Docker` ;\n",
        "- la mise en place de tests automatis√©s de la qualit√© du code\n",
        "sur le mod√®le de notre `linter` pr√©c√©dent.\n",
        "\n",
        "Nous allons utiliser `Github Actions` pour cela. Il s'agit de serveurs\n",
        "standardis√©s mis √† disposition gratuitement par `Github` {{<fa brands github >}}.\n",
        "`Gitlab` {{<fa brands gitlab >}}, l'autre principal acteur du domaine,\n",
        "propose des services similaires. L'impl√©mentation est l√©g√®rement diff√©rente\n",
        "mais les principes sont identiques.\n",
        "\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Si vous prenez ce projet fil rouge en cours de route\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git checkout appli13\n",
        "```\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "## √âtape 1: mise en place de tests automatis√©s\n",
        "\n",
        "Avant d'essayer de mettre en oeuvre la cr√©ation de notre image\n",
        "`Docker` de mani√®re automatis√©e, nous allons pr√©senter la logique\n",
        "de l'int√©gration continue en testant de mani√®re automatis√©e\n",
        "notre script `main.py`.\n",
        "\n",
        "Pour cela, nous allons partir de la structure propos√©e dans l'[action officielle](https://github.com/actions/setup-python).\n",
        "La documentation associ√©e est [ici](https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python).\n",
        "Des √©l√©ments succincts de pr√©sentation de la logique d√©clarative des actions `Github`\n",
        "sont disponibles dans le chapitre sur la [mise en production](/chapters/deployment.qmd). N√©anmoins, la meilleure\n",
        "√©cole pour comprendre le fonctionnement de celles-ci est de parcourir la documentation du service et d'observer\n",
        "les actions `Github` mises en oeuvre par vos projets favoris, celles-ci seront fort instructives !\n",
        "\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "\n",
        "## Application 14: premier script d'int√©gration continue\n",
        "\n",
        "A partir de l'exemple pr√©sent\n",
        "dans la [documentation officielle](https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python#using-a-specific-python-version)\n",
        "de `Github` {{< fa brands github >}}, on a d√©j√† une base de d√©part qui peut √™tre modifi√©e.\n",
        "Les questions suivantes permettront d'automatiser les tests et le diagnostic qualit√© de\n",
        "notre code[^failure]\n",
        "\n",
        "[^failure]: Il est tout √† fait normal de ne pas parvenir √† cr√©er une action fonctionnelle\n",
        "du premier coup. N'h√©sitez pas √† _pusher_ votre code apr√®s chaque question pour v√©rifier\n",
        "que vous parvenez bien √† r√©aliser chaque √©tape. Sinon vous risquez de devoir corriger\n",
        "bout par bout un fichier plus cons√©quent.\n",
        "\n",
        "1. Cr√©er un fichier `.github/workflows/test.yaml` avec le contenu de l'exemple de la documentation\n",
        "3. Avec l'aide de la documentation, introduire une √©tape d'installation des d√©pendances.\n",
        "Utiliser le fichier `requirements.txt` pour installer les d√©pendances.\n",
        "4. Utiliser `pylint` pour v√©rifier la qualit√© du code. Ajouter l'argument `--fail-under=6` pour\n",
        "renvoyer une erreur en cas de note trop basse[^hook]\n",
        "5. Utiliser une √©tape appelant notre application en ligne de commande (`python main.py`)\n",
        "pour tester que la matrice de confusion s'affiche bien.\n",
        "6. Cr√©er un secret stockant une valeur du `JETON_API`. Ne le faites pas commencer par un _\"$\"_ comme √ßa vous pourrez regarder la log ult√©rieurement\n",
        "7. Aller voir votre test automatis√© dans l'onglet `Actions` de votre d√©p√¥t sur `Github`\n",
        "8. _(optionnel)_: Cr√©er un _artefact_ √† partir du fichier de _log_ que vous cr√©ez dans `main.py`\n",
        "\n",
        "[^hook]: Il existe une approche alternative pour faire des tests\n",
        "    r√©guliers: les _hooks_ `Git`.\n",
        "    Il s'agit de r√®gles qui doivent √™tre satisfaites pour que le\n",
        "    fichier puisse √™tre committ√©. Cela assure que chaque `commit` remplisse\n",
        "    des crit√®res de qualit√© afin d'√©viter le probl√®me de la procrastination.\n",
        "\n",
        "    La [documentation de pylint](https://pylint.pycqa.org/en/latest/user_guide/pre-commit-integration.html) offre des explications suppl√©mentaires.\n",
        "    Ici, nous allons adopter une approche moins ambitieuse en demandant √† notre\n",
        "    action de faire ce travail d'√©valuation de la qualit√© de notre code\n",
        "\n",
        "\n",
        "\n",
        "\n",
        ":::\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli14\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "Maintenant, nous pouvons observer que l'onglet `Actions`\n",
        "s'est enrichi. Chaque `commit` va entra√Æner une s√©rie d'actions automatis√©es.\n",
        "\n",
        "Si l'une des √©tapes √©choue, ou si la note de notre projet est mauvaise, nous aurons\n",
        "une croix rouge (et nous recevrons un mail). On pourra ainsi d√©tecter,\n",
        "en d√©veloppant son projet, les moments o√π on d√©grade la qualit√© du script\n",
        "afin de la r√©tablir imm√©diatemment.\n",
        "\n",
        "\n",
        "\n",
        "## √âtape 2: Automatisation de la livraison de l'image `Docker`\n",
        "\n",
        "Maintenant, nous allons automatiser la mise √† disposition de notre image\n",
        "sur `DockerHub` (le lieu de partage des images `Docker`). Cela facilitera sa r√©utilisation mais aussi des\n",
        "valorisations ult√©rieures.\n",
        "\n",
        "L√† encore, nous allons utiliser une s√©rie d'actions pr√©-configur√©es.\n",
        "\n",
        "Pour que `Github` puisse s'authentifier aupr√®s de `DockerHub`, il va\n",
        "falloir d'abord interfacer les deux plateformes. Pour cela, nous allons utiliser\n",
        "un jeton (_token_) `DockerHub` que nous allons mettre dans un espace\n",
        "s√©curis√© associ√© √† votre d√©p√¥t `Github`.\n",
        "\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 15a: configuration\n",
        "\n",
        "- Se rendre sur\n",
        "[https://hub.docker.com/](https://hub.docker.com/) et cr√©er un compte. Il est recommand√©\n",
        "d'associer ce compte √† votre compte `Github`.\n",
        "- Cr√©er un d√©p√¥t public `application`\n",
        "- Aller dans les [param√®tres de votre compte](https://hub.docker.com/settings/general)\n",
        "et cliquer, √† gauche, sur `Security`\n",
        "- Cr√©er un jeton personnel d'acc√®s, ne fermez pas l'onglet en question,\n",
        "vous ne pouvez voir sa valeur qu'une fois.\n",
        "- Dans le d√©p√¥t `Github` de votre projet, cliquer sur l'onglet `Settings` et cliquer,\n",
        "√† gauche, sur `Secrets and variables` puis\n",
        "dans le menu d√©roulant en dessous sur `Actions`. Sur la page qui s'affiche, aller\n",
        "dans la section `Repository secrets`\n",
        "- Cr√©er un jeton `DOCKERHUB_TOKEN` √† partir du jeton que vous aviez cr√©√© sur `Dockerhub`. Valider\n",
        "- Cr√©er un deuxi√®me secret nomm√© `DOCKERHUB_USERNAME` ayant comme valeur le nom d'utilisateur\n",
        "que vous avez cr√©√© sur `Dockerhub`\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "Etape optionnelle suppl√©mentaire si on met en production un site web\n",
        "</summary>\n",
        "\n",
        "- Dans le d√©p√¥t `Github` de votre projet, cliquer sur l'onglet `Settings` et cliquer,\n",
        "√† gauche, sur `Actions`. Donner les droits d'√©criture √† vos actions sur le d√©p√¥t\n",
        "du projet (ce sera n√©cessaire pour `Github Pages`)\n",
        "\n",
        "![](/permissions.png)\n",
        "\n",
        "</details>\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "A ce stade, nous avons donn√© les moyens √† `Github` de s'authentifier avec\n",
        "notre identit√© sur `Dockerhub`. Il nous reste √† mettre en oeuvre l'action\n",
        "en s'inspirant de la [documentation officielle](https://github.com/docker/build-push-action/#usage).\n",
        "On ne va modifier que trois √©l√©ments dans ce fichier. Effectuer les\n",
        "actions suivantes:\n",
        "\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "\n",
        "## Application 15b: automatisation de l'image `Docker`\n",
        "\n",
        "- En s'inspirant de ce [_template_](https://github.com/marketplace/actions/build-and-push-docker-images), cr√©er le fichier `.github/workflows/prod.yml` qui va *build* et *push* l'image sur le `DockerHub`. Il va √™tre n√©cessaire de changer l√©g√®rement ce mod√®le :\n",
        "    + Retirer la condition restrictive sur les _commits_ pour lesquels sont lanc√©s cette automatisation. Pour cela, remplacer le contenu de `on` de sorte √† avoir `on:\n",
        "  push:\n",
        "    branches:\n",
        "      - main\n",
        "      - dev`\n",
        "    + Changer le tag √† la fin pour mettre `username/application:latest`\n",
        "o√π `username` est le nom d'utilisateur sur `DockerHub`;\n",
        "    + Optionnel: changer le nom de l'action\n",
        "\n",
        "- Faire un `commit` et un `push` de ces fichiers\n",
        "\n",
        "Comme on est fier de notre travail, on va afficher √ßa avec un badge sur le\n",
        "`README` _(partie optionnelle)_.\n",
        "\n",
        "- Se rendre dans l'onglet `Actions` et cliquer sur une des actions list√©es.\n",
        "- En haut √† droite, cliquer sur `...`\n",
        "- S√©lectionner `Create status badge`\n",
        "- R√©cup√©rer le code `Markdown` propos√©\n",
        "- Copier dans votre `README.md` le code _markdown_ propos√©\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "Cr√©er le badge\n",
        "</summary>\n",
        "![](/create-badge.png)\n",
        "</details>\n",
        "\n",
        ":::\n",
        "\n",
        "Maintenant, il nous reste √† tester notre application dans l'espace bac √† sable\n",
        "ou en local, si `Docker` est install√©.\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "\n",
        "## Application 15b (partie optionnelle): Tester l'application\n",
        "\n",
        "- Se rendre sur l'environnement bac √† sable _[Play with Docker](https://labs.play-with-docker.com)_\n",
        "ou dans votre environnement `Docker` de pr√©dilection.\n",
        "- R√©cup√©rer et lancer l'image :\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "docker run -it username/application:latest\n",
        "```\n",
        "\n",
        "üéâ La matrice de confusion doit s'afficher ! Vous avez grandement\n",
        "facilit√© la r√©utilisation de votre image.\n",
        "\n",
        ":::\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli15\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "# Partie 5: exp√©rimenter en local des valorisations puis automatiser leur production\n",
        "\n",
        "\n",
        "Nous avons automatis√© les √©tapes interm√©diaires de notre projet.\n",
        "N√©anmoins nous n'avons pas encore r√©fl√©chi √† la valorisation\n",
        "√† mettre en oeuvre pour notre projet. On va supposer que notre\n",
        "projet s'adresse √† des _data scientists_ mais aussi √† une audience\n",
        "moins technique. Pour ces premiers, nous pourrions nous contenter\n",
        "de valorisations techniques, comme des API,\n",
        "mais pour ces derniers il est\n",
        "conseill√© de privil√©gier des formats plus _user friendly_.\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Si vous prenez ce projet fil rouge en cours de route\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git checkout appli15\n",
        "```\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "Afin de faire le parall√®le avec les parcours possibles pour l'√©valuation,\n",
        "nous allons proposer trois valorisations[^valorisation]:\n",
        "\n",
        "- Une [API](https://titanic.kub.sspcloud.fr/docs) facilitant la r√©utilisation du mod√®le en \"production\" ;\n",
        "- Un [site web statique](https://ensae-reproductibilite.github.io/application/) exploitant cette API pour exposer les pr√©dictions\n",
        "√† une audience moins technique.\n",
        "\n",
        "\n",
        "[^valorisation]: Vous n'√™tes pas oblig√©s pour l'√©valuation de mettre en oeuvre\n",
        "les jalons de plusieurs parcours. N√©anmoins, vous d√©couvrirez que\n",
        "chaque nouveau pas en avant est moins co√ªteux que le\n",
        "pr√©c√©dent si vous avez mis en oeuvre les r√©flexes des bonnes\n",
        "pratiques.\n",
        "\n",
        "\n",
        "\n",
        "::: {.callout-warning collapse=\"true\"}\n",
        "## Site statique vs application r√©active\n",
        "\n",
        "La solution que nous allons proposer\n",
        "pour les sites statiques, `Quarto` associ√©\n",
        "√† `Github Pages`, peut √™tre utilis√©e dans le cadre des parcours\n",
        "_\"rapport reproductible\"_ ou _\"dashboard / application interactive\"_.\n",
        "\n",
        "Pour ce dernier\n",
        "parcours, d'autres approches techniques sont n√©anmoins possibles,\n",
        "comme `Streamlit`. Celles-ci sont plus exigeantes sur le plan technique\n",
        "puisqu'elles n√©cessitent de mettre en production sur des serveurs\n",
        "conteuneuris√©s (comme la mise en production de l'API)\n",
        "l√† o√π le site statique ne n√©cessite qu'un serveur web, mis √† disposition\n",
        "gratuitement par `Github`.\n",
        "\n",
        "\n",
        "La distinction principale entre ces deux approches est qu'elles\n",
        "s'appuient sur des serveurs diff√©rents. Un site statique repose\n",
        "sur un serveur web l√† o√π `Streamlit` s'appuie sur\n",
        "serveur classique en _backend_. La diff√©rence principale\n",
        "entre ces deux types de serveurs\n",
        "r√©side principalement dans leur fonction et leur utilisation:\n",
        "\n",
        "- Un __serveur web__ est sp√©cifiquement con√ßu pour stocker, traiter et livrer des pages web aux clients. Cela inclut des fichiers HTML, CSS, JavaScript, images, etc. Les serveurs web √©coutent les requ√™tes HTTP/HTTPS provenant des navigateurs des utilisateurs et y r√©pondent en envoyant les donn√©es demand√©es.\n",
        "- Un **serveur _backend_** classique est con√ßu pour effectuer des op√©rations en r√©ponse √† un _front_, en l'occurrence une page web.\n",
        "Dans le contexte d'une application `Streamlit`, il s'agit d'un serveur avec l'environnement `Python` _ad hoc_ pour\n",
        "ex√©cuter le code n√©cessaire √† r√©pondre √† toute action d'un utilisateur de l'appliacation.\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "## √âtape 1: d√©velopper une API en local\n",
        "\n",
        "Le premier livrable devenu classique dans un projet\n",
        "impliquant du _machine learning_ est la mise √†\n",
        "disposition d'un mod√®le par le biais d'une\n",
        "API (voir chapitre sur la [mise en production](/chapters/deployment.qmd)).\n",
        "Le _framework_ [`FastAPI`](https://fastapi.tiangolo.com/) va permettre\n",
        "de rapidement transformer notre application `Python` en une API fonctionnelle.\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Si vous prenez ce projet fil rouge en cours de route\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git checkout appli15\n",
        "```\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "\n",
        "## Application 16: Mise √† disposition sous forme d'API locale\n",
        "\n",
        "- Installer `fastAPI` et `uvicorn` puis les ajouter au `requirements.txt`\n",
        "- Renommer le fichier `main.py` en `train.py`. Dans ce script, ajouter une\n",
        "sauvegarde du mod√®le apr√®s l'avoir entra√Æn√©, sous le\n",
        "format [`joblib`](https://scikit-learn.org/stable/model_persistence.html#python-specific-serialization). \n",
        "- Faire tourner\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "python train.py\n",
        "```\n",
        "\n",
        "pour enregistrer en local votre mod√®le de production. \n",
        "\n",
        "- Modifier les appels √† `main.py` dans votre `Dockerfile` et vos actions `Github`\n",
        "sous peine d'essuyer des √©checs lors de vos actions `Github` apr√®s le prochain _push_. \n",
        "\n",
        "- Ajouter `model.joblib` au `.gitignore` car `Git` n'est pas fait pour \n",
        "ce type de fichiers. \n",
        "\n",
        "Nous allons maintenant passer au d√©veloppement de l'API.\n",
        "Comme d√©couvrir `FastAPI` n'est pas l'objet de cet enseignement, nous\n",
        "donnons directement le mod√®le pour cr√©er l'API. Si vous\n",
        "d√©sirez tester de vous-m√™mes, vous pouvez cr√©er votre \n",
        "fichier sans vous r√©f√©rer √† l'exemple\n",
        "\n",
        "- Cr√©er le fichier `api.py` permettant d'initialiser l'API:\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "Fichier `api.py`\n",
        "</summary>\n",
        "\n",
        "```{.python include=\"./applications/code/appli17_api_main.py\" filename=\"src/models/train_evaluation.py\"}\n",
        "```\n",
        "</details>\n",
        "\n",
        "- D√©ployer en local l'API avec la commande\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "uvicorn api:app --reload --host \"0.0.0.0\" --port 5000\n",
        "```\n",
        "\n",
        "- A partir du `README` du service, se rendre sur l'URL de d√©ploiement, \n",
        "ajouter `/docs/` √† celui-ci et observer la documentation de l'API \n",
        "- Se servir de la documentation pour tester les requ√™tes `/predict`\n",
        "- R√©cup√©rer l'URL d'une des requ√™tes propos√©es. La tester dans le navigateur\n",
        "et depuis `Python` avec `requests` :\n",
        "\n",
        "```{.python}\n",
        "import request\n",
        "requests.get(url).json()\n",
        "```\n",
        "\n",
        "- Une fois que vous avez test√©, vous pouvez tuer l'application en faisant <kbd>CTRL</kbd>+<kbd>C</kbd>. Retester\n",
        "votre bout de code `Python` et comprendre l'origine du probl√®me.\n",
        "\n",
        ":::\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli17\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "## √âtape 2: d√©ployer l'API de mani√®re manuelle\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Si vous prenez ce projet fil rouge en cours de route\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git checkout appli16\n",
        "```\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "A ce stade, nous avons d√©ploy√© l'API seulement localement, dans le cadre d'un terminal qui tourne en arri√®re-plan.\n",
        "C'est une mise en production manuelle, pas franchement p√©renne.\n",
        "Ce mode de d√©ploiement est tr√®s pratique pour la phase de d√©veloppement, afin de s'assurer que l'API fonctionne comme attendu.\n",
        "Pour p√©renniser la mise en production, on va √©liminer l'aspect artisanal de celle-ci.\n",
        "\n",
        "Il est temps de passer √† l'√©tape de d√©ploiement, qui permettra √† notre API d'√™tre accessible via une URL sur le web\n",
        "et d'avoir un serveur, en arri√®re plan, qui effectuera les op√©rations pour r√©pondre √† une\n",
        "requ√™te. Pour se faire, on va utiliser les possibilit√©s offertes par `Kubernetes`, sur lequel est bas√© le [SSP Cloud](https://datalab.sspcloud.fr).\n",
        "\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 17: Dockeriser l'API (int√©gration continue)\n",
        "\n",
        "- Pour rendre la structure du projet plus lisible, d√©placer `api.py` -> `api/main.py`\n",
        "\n",
        "- Cr√©er un script `api/run.sh` √† la racine du projet qui lance le script `train.py` puis d√©ploie localement l'API\n",
        "\n",
        "<details>\n",
        "<summary>Fichier `run.sh`</summary>\n",
        "\n",
        "```{.bash filename=\"api/run.sh\" no-prefix=true}\n",
        "#/bin/bash\n",
        "\n",
        "python3 train.py\n",
        "uvicorn api.main:app --reload --host \"0.0.0.0\" --port 5000\n",
        "```\n",
        "</details>\n",
        "\n",
        "- Donner au script `api/run.sh` des permissions d'ex√©cution : `chmod +x api/run.sh`\n",
        "\n",
        "- Ajouter `COPY api ./api` pour avoir les fichiers n√©cessaires au lancement dans l'API dans l'image\n",
        "\n",
        "- Modifier `COPY train.py .` pour tenir compte du nouveau nom du fichier\n",
        "\n",
        "- Changer l'instruction `CMD` du `Dockerfile` pour ex√©cuter le script `api/run.sh` au lancement du conteneur (`CMD [\"bash\", \"-c\", \"./api/run.sh\"]`)\n",
        "\n",
        "- Mettre √† jour votre `requirements.txt` pour tenir compte des nouveaux _packages_ utilis√©s\n",
        "\n",
        "- *Commit* et *push* les changements\n",
        "\n",
        "- Une fois le CI termin√©, r√©cup√©rer la nouvelle image dans votre environnement de test de `Docker` et v√©rifier que l'API se d√©ploie correctement\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "Nous avons pr√©par√© la mise √† disposition de notre API mais √† l'heure\n",
        "actuelle elle n'est pas disponible de mani√®re ais√©e car il est n√©cessaire\n",
        "de lancer manuellement une image `Docker` pour pouvoir y acc√©der.\n",
        "Ce type de travail est la sp√©cialit√© de `Kubernetes` que nous allons\n",
        "utiliser pour g√©rer la mise √† disposition de notre API.\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 18b: Mettre √† disposition l'API (d√©ploiement manuel)\n",
        "\n",
        "Cette partie n√©cessite d'avoir √† disposition une infrastructure _cloud_.\n",
        "\n",
        "- Cr√©er un dossier `deployment` √† la racine du projet qui va contenir les fichiers de configuration n√©cessaires pour d√©ployer sur un cluster `Kubernetes`\n",
        "\n",
        "- En vous inspirant de la [documentation](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment), y ajouter un premier fichier `deployment.yaml` qui va sp√©cifier la configuration du *Pod* √† lancer sur le cluster\n",
        "\n",
        "<details>\n",
        "<summary>Fichier `deployment/deployment.yaml`</summary>\n"
      ],
      "id": "91ad9a82"
    },
    {
      "cell_type": "code",
      "metadata": {
        "filename": "deployment/deployment.yaml",
        "source-line-numbers": "19"
      },
      "source": [
        "#| eval: false\n",
        "apiVersion: apps/v1\n",
        "kind: Deployment\n",
        "metadata:\n",
        "  name: titanic-deployment\n",
        "  labels:\n",
        "    app: titanic\n",
        "spec:\n",
        "  replicas: 1\n",
        "  selector:\n",
        "    matchLabels:\n",
        "      app: titanic\n",
        "  template:\n",
        "    metadata:\n",
        "      labels:\n",
        "        app: titanic\n",
        "    spec:\n",
        "      containers:\n",
        "      - name: titanic\n",
        "        image: #<1>\n",
        "        ports:\n",
        "        - containerPort: 5000"
      ],
      "id": "ee2e723b",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "1. Mettre ici l'image `Docker` utilis√©e, sous la forme `username/image:latest`\n",
        "\n",
        "</details>\n",
        "\n",
        "- En vous inspirant de la [documentation](https://kubernetes.io/fr/docs/concepts/services-networking/service/#d%C3%A9finition-d-un-service), y ajouter un second fichier `service.yaml` qui va cr√©er une ressource `Service` permettant de donner une identit√© fixe au `Pod` pr√©c√©demment cr√©√© au sein du cluster\n",
        "\n",
        "<details>\n",
        "<summary>Fichier `deployment/service.yaml`</summary>\n",
        "\n",
        "```{.yaml filename=\"deployment/service.yaml\"}\n",
        "apiVersion: v1\n",
        "kind: Service\n",
        "metadata:\n",
        "  name: titanic-service\n",
        "spec:\n",
        "  selector:\n",
        "    app: titanic\n",
        "  ports:\n",
        "    - protocol: TCP\n",
        "      port: 80\n",
        "      targetPort: 5000\n",
        "```\n",
        "</details>\n",
        "\n",
        "- En vous inspirant de la [documentation](https://kubernetes.io/docs/concepts/services-networking/ingress/#the-ingress-resource), y ajouter un troisi√®me fichier `ingress.yaml` qui va cr√©er une ressource `Ingress` permettant d'exposer le service via une URL en dehors du cluster\n",
        "\n",
        "<details>\n",
        "<summary>Fichier `deployment/ingress.yaml`</summary>\n"
      ],
      "id": "e4c46464"
    },
    {
      "cell_type": "code",
      "metadata": {
        "filename": "deployment/ingress.yaml",
        "source-line-numbers": "16-19"
      },
      "source": [
        "#| eval: false\n",
        "apiVersion: networking.k8s.io/v1\n",
        "kind: Ingress\n",
        "metadata:\n",
        "  name: titanic-ingress\n",
        "  annotations:\n",
        "    nginx.ingress.kubernetes.io/rewrite-target: /\n",
        "    # Enable CORS by adding these annotations\n",
        "    nginx.ingress.kubernetes.io/enable-cors: \"true\"\n",
        "    nginx.ingress.kubernetes.io/cors-allow-methods: \"PUT, GET, POST, DELETE, PATCH, OPTIONS\"\n",
        "    nginx.ingress.kubernetes.io/cors-allow-credentials: \"true\"\n",
        "    nginx.ingress.kubernetes.io/cors-allow-headers: \"DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization\"\n",
        "    nginx.ingress.kubernetes.io/cors-allow-origin: \"*\"\n",
        "spec:\n",
        "  ingressClassName: nginx\n",
        "  tls:\n",
        "  - hosts:\n",
        "    - #<1>\n",
        "  rules:\n",
        "  - host: #<2>\n",
        "    http:\n",
        "      paths:\n",
        "      - path: /\n",
        "        pathType: Prefix\n",
        "        backend:\n",
        "          service:\n",
        "            name: titanic-service\n",
        "            port:\n",
        "              number: 80"
      ],
      "id": "c25c1e73",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "1. Mettez l'URL auquel vous voulez exposer votre service. Sur le mod√®le de `titanic.kub.sspcloud.fr` (mais ne tentez pas celui-l√†, il est d√©j√† pris üòÉ)\n",
        "2. Mettre ce m√™me URL ici aussi\n",
        "</details>\n",
        "\n",
        "- Appliquer ces fichiers de configuration sur le cluster : `kubectl apply -f deployment/`\n",
        "\n",
        "- Si tout a correctement fonctionn√©, vous devriez pouvoir acc√©der depuis votre navigateur √† l'API √† l'URL sp√©cifi√©e dans le fichier `deployment/ingress.yaml`. Par exemple `https://toto.kub.sspcloud.fr/` si vous avez mis celui-ci plus t√¥t (et `https://toto.kub.sspcloud.fr/docs` pour la documentation).\n",
        "\n",
        ":::\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli18\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "::: {.callout-note title=\"G√©rer le CORS\" collapse=\"true\"}\n",
        "Notre API est accessible sans probl√®me depuis `Python` ou notre navigateur.\n",
        "\n",
        "En revanche, si on d√©sire utiliser `JavaScript` pour cr√©er une application\n",
        "interactive il est indispensable de mettre\n",
        "les lignes un peu obscure sur le CORS dans le fichier `ingress.yaml`.\n",
        "\n",
        "Comme c'est un point technique qui ne concerne pas les comp√©tences\n",
        "li√©es √† ce cours, nous donnons directement les mises √† jour n√©cessaires\n",
        "du projet.\n",
        "\n",
        "Ceci consiste principalement √† ajouter la ligne suivante au fichier `ingress.yaml` :\n",
        "\n",
        "```\n",
        "nginx.ingress.kubernetes.io/enable-cors: \"true\"\n",
        "```\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "On peut remarquer quelques voies d'am√©lioration de notre approche qui\n",
        "seront ult√©rieurement trait√©es:\n",
        "\n",
        "- L'entra√Ænement du mod√®le\n",
        "est r√©-effectu√© √† chaque lancement d'un nouveau conteneur.\n",
        "On relance donc autant de fois un entra√Ænement qu'on d√©ploie\n",
        "de conteneurs pour r√©pondre √† nos utilisateurs. Ce sera\n",
        "l'objet de la partie MLOps de fiabiliser et optimiser\n",
        "cette partie du _pipeline_.\n",
        "- il est n√©cessaire de (re)lancer manuellement  `kubectl apply -f deployment/`\n",
        "√† chaque changement de notre code. Autrement dit, lors de cette application,\n",
        "on a am√©lior√©\n",
        "la fiabilit√© du lancement de notre API mais un lancement manuel est encore indispensable.\n",
        "Comme dans le reste de ce cours, on va essayer d'√©viter un geste manuel pouvant\n",
        "√™tre source d'erreur en privil√©giant l'automatisation et l'archivage dans des\n",
        "scripts. C'est l'objet de la prochaine √©tape.\n",
        "\n",
        "\n",
        "## Etape 3: automatiser le d√©ploiement (d√©ploiement en continu)\n",
        "\n",
        "::: {.callout-important}\n",
        "## Clarification sur la branche de travail et les _tags_\n",
        "\n",
        "A partir de maintenant, il est n√©cessaire de clarifier la\n",
        "branche principale sur laquelle nous travaillons. De mani√®re\n",
        "traditionnelle, on utilise la branche `main`. Si vous avez chang√© de branche,\n",
        "vous pouvez continuer 1/ continuer mais en tenir compte dans les exemples ult√©rieurs ou 2/ fusionner celle-ci √† `main`.\n",
        "\n",
        "Si vous avez utilis√© un `tag` pour sauter une ou plusieurs √©tapes, il va\n",
        "√™tre n√©cessaire de se placer sur une branche car vous √™tes en _head detached_.\n",
        "Pour cela, apr√®s avoir _committ√©_ les fichiers que vous d√©sirez garder\n"
      ],
      "id": "824b26be"
    },
    {
      "cell_type": "code",
      "metadata": {
        "file": "terminal",
        "filename": "terminal"
      },
      "source": [
        "#| eval: false\n",
        "$ git branch -D dev #<1>\n",
        "$ git push origin -d dev #<2>\n",
        "$ git checkout -b dev #<3>\n",
        "$ git push --set-upstream origin dev #<4>"
      ],
      "id": "7f83d02c",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "1. Supprime la branche `dev` *locale* (si elle existe).\n",
        "2. Supprime la branche `dev` *remote* (si elle existe).\n",
        "3. Cr√©e une nouvelle branche `dev` *locale* et on se place sur cette branche.\n",
        "4. Pousse la branche `dev` et active la synchronisation entre la branche *locale* et la branche *remote*.\n",
        ":::\n",
        "\n",
        "Qu'est-ce qui peut d√©clencher une √©volution n√©cessitant de mettre √† jour l'ensemble de notre processus de production ?\n",
        "\n",
        "Regardons √† nouveau notre _pipeline_:\n",
        "\n",
        "![](/drawio/end_point.png)\n",
        "\n",
        "Les _inputs_ de notre _pipeline_ sont donc:\n",
        "\n",
        "- La __configuration__. Ici, on peut consid√©rer que notre `.env` de configuration ou les secrets renseign√©s √† `Github` rel√®vent de cette cat√©gorie  ;\n",
        "- Les __donn√©es__. Nos donn√©es sont statiques et n'ont pas vocation √† √©voluer. Si c'√©tait le cas, il faudrait en tenir compte dans notre automatisation[^versionning-data]. ;\n",
        "- Le __code__. C'est l'√©l√©ment principal qui √©volue chez nous. Id√©alement, on veut automatiser le processus au maximum en faisant en sorte qu'√† chaque mise √† jour de notre code (un _push_ sur `Github`), les √©tapes ult√©rieures (production de l'image `Docker`, etc.) se lancent. N√©anmoins, on veut aussi √©viter qu'une erreur puisse donner lieu √† une mise en production non-fonctionnelle, on va donc maintenir une action manuelle minimale comme garde-fou.\n",
        "\n",
        "::: {.callout-note}\n",
        "## Et le _versionning_ des donn√©es ?\n",
        "\n",
        "Ici, nous nous pla√ßons dans le cas simple o√π les donn√©es brutes re√ßues sont fig√©es. Ce qui peut changer est la mani√®re dont on constitue nos √©chantillons train/test. Il sera donc utile de logguer les donn√©es en question par le biais de `MLFlow`. Mais il n'est pas n√©cessaire de versionner les donn√©es brutes.\n",
        "\n",
        "Si celles-ci √©voluaient, il pourrait √™tre utile de versionner les donn√©es, √† la mani√®re dont on le fait pour le code. `Git` n'est pas l'outil appropri√© pour cela. Parmi les outils populaires de versionning de donn√©es, bien int√©gr√©s avec S3, il y a sur le SSPCloud [`lakefs`](https://lakefs.io/).\n",
        ":::\n",
        "\n",
        "Pour automatiser au maximum la mise en production, on va utiliser un nouvel outil : `ArgoCD`. Ainsi, au lieu de devoir appliquer manuellement la commande `kubectl apply` √† chaque modification des fichiers de d√©ploiement (pr√©sents dans le dossier `kubernetes/`), c'est l'**op√©rateur** `ArgoCD`, d√©ploy√© sur le cluster, qui va d√©tecter les changements de configuration du d√©ploiement et les appliquer automatiquement.\n",
        "\n",
        "C'est l'approche dite **GitOps** : le d√©p√¥t `Git` du d√©ploiement fait office de **source de v√©rit√© unique** de l'√©tat voulu de l'application, tout changement sur ce dernier doit donc se r√©percuter imm√©diatement sur le d√©ploiement effectif.\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 19a: Automatiser la mise √† disposition de l'API (d√©ploiement continu)\n",
        "\n",
        "- Lancer un service `ArgoCD` sur le `SSPCloud` depuis la page `Mes services` (catalogue `Automation`). Laisser\n",
        "les configurations par d√©faut.\n",
        "- Sur `GitHub`, cr√©er un d√©p√¥t `application-deployment` qui va servir de **d√©p√¥t GitOps**, c'est √† dire un d√©p√¥t qui sp√©cifie le param√©trage du d√©ploiement de votre application.\n",
        "- Ajouter un dossier `deployment` √† votre d√©p√¥t `GitOps`, dans lequel on mettra les trois fichiers de d√©ploiement qui permettent de d√©ployer notre application sur `Kubernetes` (`deployment.yaml`, `service.yaml`, `ingress.yaml`).\n",
        "- A la racine de votre d√©p√¥t `GitOps`, cr√©ez un fichier `application.yml` avec le contenu suivant, en prenant bien soin de modifier les lignes surlign√©es avec les informations pertinentes :\n"
      ],
      "id": "1df5331e"
    },
    {
      "cell_type": "code",
      "metadata": {
        "file": "application.yaml",
        "filename": "application.yaml",
        "source-line-numbers": "8-9,13"
      },
      "source": [
        "#| eval: false\n",
        "apiVersion: argoproj.io/v1alpha1\n",
        "kind: Application\n",
        "metadata:\n",
        "  name: ensae-mlops\n",
        "spec:\n",
        "  project: default\n",
        "  source:\n",
        "    repoURL: https://github.com/<your_github_username>/application-deployment.git #<1>\n",
        "    targetRevision: main #<2>\n",
        "    path: deployment #<3>\n",
        "  destination:\n",
        "    server: https://kubernetes.default.svc\n",
        "    namespace: user-<your_sspcloud_username> #<4>\n",
        "  syncPolicy:\n",
        "    automated:\n",
        "      selfHeal: true"
      ],
      "id": "a7389ff6",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "1. L'URL de votre d√©p√¥t `Github` {{< fa brands github >}} faisant office de d√©p√¥t `GitOps`.\n",
        "2. La branche √† partir de laquelle vous d√©ployez.\n",
        "3. Le nom du dossier contenant vos fichiers de d√©ploiement `Kubernetes`.\n",
        "4. Votre _namespace_ `Kubernetes`. Sur le SSPCloud, cela prend la forme `user-${username}`.\n",
        "\n",
        "- Pousser sur `Github` le d√©p√¥t `GitOps`.\n",
        "- Dans `ArgoCD`, cliquez sur `New App` puis `Edit as a YAML`. Copiez-collez le contenu de `application.yml` et cliquez sur `Create`.\n",
        "- Observez dans l'interface d'`ArgoCD` le d√©ploiement progressif des ressources n√©cessaires √† votre application sur le cluster. Joli non ?\n",
        "- V√©rifiez que votre API est bien d√©ploy√©e en utilisant l‚ÄôURL d√©finie dans le fichier `ingress.yml`.\n",
        "- Supprimer du code applicatif le dossier `deployment` puisque c'est maintenant votre d√©p√¥t de d√©ploiement qui le contr√¥le.\n",
        "- Indiquer dans le `README.md` que le d√©ploiement de votre application (dont vous pouvez mettre l'URL dans le README) est contr√¥l√© par un autre d√©p√¥t.\n",
        "\n",
        ":::\n",
        "\n",
        "Si cela a fonctionn√©, vous devriez maintenant voir votre application dans votre tableau de bord `ArgoCD`:\n",
        "\n",
        "![](/chapters/applications/figures/argo_appli19a.png)\n",
        "\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli19a\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "A pr√©sent, nous avons tous les outils √† notre disposition pour construire un vrai **pipeline de CI/CD, automatis√© de bout en bout**. Il va nous suffire pour cela de mettre √† bout les composants :\n",
        "\n",
        "- dans la partie 4 de l'application, nous avons construit un **pipeline de CI** : on a donc seulement √† faire un commit sur le d√©p√¥t de l'application pour lancer l'√©tape de **build** et de mise √† disposition de la nouvelle image sur le `DockerHub` ;\n",
        "\n",
        "- dans l'application pr√©c√©dente, nous avons construit un **pipeline de CD** : `ArgoCD` suit en permanence l'√©tat du d√©p√¥t `GitOps`, tout commit sur ce dernier lancera donc automatiquement un red√©ploiement de l'application.\n",
        "\n",
        "Il y a donc un √©l√©ment qui fait la liaison entre ces deux pipelines et qui nous sert de garde-fou en cas d'erreur : la **version de l'application**.\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 19b : Mettre √† jour la version en production\n",
        "\n",
        "Jusqu'√† maintenant, on a utilis√© le tag *latest* pour d√©finir la version de notre application. En pratique, lorsqu'on passe de la phase de d√©veloppement √† celle de production, on a plut√¥t envie de versionner proprement les versions de l'application afin de savoir ce qui est d√©ploy√©. On va pour cela utiliser les ***tags*** avec `Git`, qui vont se propager au nommage de l'image `Docker`.\n",
        "\n",
        "- Modifier le fichier de CI `prod.yml` pour assurer la propagation des tags.\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "\n",
        "Fichier `.github/workflows/prod.yml`\n",
        "\n",
        "</summary>\n",
        "\n",
        "```{.yaml filename=\".github/workflows/prod.yml\"}\n",
        "name: Construction image Docker\n",
        "\n",
        "on:\n",
        "  push:\n",
        "    branches:\n",
        "      - main\n",
        "      - dev\n",
        "    tags:\n",
        "      - 'v*.*.*'\n",
        "\n",
        "jobs:\n",
        "  docker:\n",
        "    runs-on: ubuntu-latest\n",
        "    steps:\n",
        "      -\n",
        "        name: Set up QEMU\n",
        "        uses: docker/setup-qemu-action@v3\n",
        "      -\n",
        "        name: Set up Docker Buildx\n",
        "        uses: docker/setup-buildx-action@v3\n",
        "\n",
        "      -\n",
        "        name: Docker meta\n",
        "        id: meta\n",
        "        uses: docker/metadata-action@v5\n",
        "        with:\n",
        "          images: linogaliana/application #<1>\n",
        "\n",
        "      -\n",
        "        name: Login to Docker Hub\n",
        "        uses: docker/login-action@v3\n",
        "        with:\n",
        "          username: ${{ secrets.DOCKERHUB_USERNAME }}\n",
        "          password: ${{ secrets.DOCKERHUB_TOKEN }}\n",
        "      -\n",
        "        name: Build and push\n",
        "        uses: docker/build-push-action@v5\n",
        "        with:\n",
        "          push: true\n",
        "          tags: ${{ steps.meta.outputs.tags }}\n",
        "          labels: ${{ steps.meta.outputs.labels }}\n",
        "```\n",
        "1. Modifier ici !\n",
        "\n",
        "</details>\n",
        "\n",
        "- Dans le d√©p√¥t de l'application, mettre √† jour le code dans `api/main.py` pour changer un √©l√©ment de l'interface de votre documentation.\n",
        "Par exemple, mettre en gras un titre.\n",
        "\n",
        "```{.python}\n",
        "app = FastAPI(\n",
        "    title=\"D√©monstration du mod√®le de pr√©diction de survie sur le Titanic\",\n",
        "    description=\n",
        "    \"<b>Application de pr√©diction de survie sur le Titanic</b> üö¢ <br>Une version par API pour faciliter la r√©utilisation du mod√®le üöÄ\" +\\\n",
        "        \"<br><br><img src=\\\"https://media.vogue.fr/photos/5faac06d39c5194ff9752ec9/1:1/w_2404,h_2404,c_limit/076_CHL_126884.jpg\\\" width=\\\"200\\\">\"\n",
        "    )\n",
        "```\n",
        "\n",
        "- *Commit* et *push* les changements.\n",
        "\n",
        "- Tagger le commit effectu√© pr√©c√©demment et *push* le nouveau tag :\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git tag v0.0.1\n",
        "git push --tags\n",
        "```\n",
        "\n",
        "- V√©rifier sur le d√©p√¥t `GitHub` de l'application que ce *commit* lance bien un pipeline de CI **associ√© au tag v1.0.0**. Une fois termin√©, v√©rifier sur le `DockerHub` que le tag `v0.0.1` existe bien parmi les tags disponibles de l'image.\n",
        "\n",
        "La partie CI a correctement fonctionn√©. Int√©ressons-nous √† pr√©sent √† la partie CD.\n",
        "\n",
        "- Sur le d√©p√¥t `GitOps`, mettre √† jour la version de l'image √† d√©ployer en production dans le fichier `deployment/deployment.yaml`\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "\n",
        "Fichier `deployment/deployment.yaml`\n",
        "\n",
        "</summary>\n"
      ],
      "id": "91a66f5e"
    },
    {
      "cell_type": "code",
      "metadata": {
        "file": "deployment/deployment.yaml",
        "filename": "deployment/deployment.yaml",
        "source-line-numbers": "19"
      },
      "source": [
        "#| eval: false\n",
        "apiVersion: apps/v1\n",
        "kind: Deployment\n",
        "metadata:\n",
        "  name: titanic-deployment\n",
        "  labels:\n",
        "    app: titanic\n",
        "spec:\n",
        "  replicas: 1\n",
        "  selector:\n",
        "    matchLabels:\n",
        "      app: titanic\n",
        "  template:\n",
        "    metadata:\n",
        "      labels:\n",
        "        app: titanic\n",
        "    spec:\n",
        "      containers:\n",
        "      - name: titanic\n",
        "        image: linogaliana/application:v0.0.1 #<1>\n",
        "        ports:\n",
        "        - containerPort: 5000"
      ],
      "id": "2b02f75c",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "1. Remplacer ici par le d√©p√¥t applicatif ad√©quat\n",
        "\n",
        "\n",
        "</details>\n",
        "\n",
        "- Apr√®s avoir _committ√©_ et _push√©_, observer dans `ArgoCD` le statut de votre application. Normalement, l'op√©rateur devrait avoir automatiquement identifi√© le changement, et mettre √† jour le d√©ploiement pour en tenir compte.\n",
        "\n",
        "![](/argocd-waiting.png)\n",
        "\n",
        "- V√©rifier que l'API a bien √©t√© mise √† jour.\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli19b\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "## Etape 4: construire un site web\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Si vous prenez ce projet fil rouge en cours de route\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git checkout appli19\n",
        "git checkout -b dev\n",
        "git push origin dev\n",
        "```\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "On va proposer un nouveau livrable pour parler √† un public plus large.\n",
        "Pour faire ce site web,\n",
        "on va utiliser `Quarto` et d√©ployer sur `Github Pages`.\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "\n",
        "## Application 20: Cr√©ation d'un site web pour valoriser le projet\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "quarto create project website mysite\n",
        "```\n",
        "\n",
        "- Faire remonter d'un niveau `_quarto.yml`\n",
        "- Supprimer `about.qmd`, d√©placer `index.qmd` vers la racine de notre projet.\n",
        "- Remplacer le contenu de `index.qmd` par [celui-ci](https://raw.githubusercontent.com/ensae-reproductibilite/application/tree/appli19/index.qmd) et retirer `about.qmd` des fichiers √† compiler.\n",
        "- D√©placer `styles.css` √† la racine du projet\n",
        "- Mettre √† jour le `.gitignore` avec les instructions suivantes\n",
        "\n",
        "```{.bash file=\".gitignore\" no-prefix=true}\n",
        "/.quarto/\n",
        "*.html\n",
        "*_files\n",
        "_site/\n",
        "```\n",
        "\n",
        "- En ligne de commande, faire `quarto preview` (ajouter les arguments `--port 5000 --host 0.0.0.0` si vous passez par le `SSPCloud`)\n",
        "- Observer le site web g√©n√©r√© en local\n",
        "\n",
        "Enfin, on va construire et d√©ployer automatiquement ce site web gr√¢ce au\n",
        "combo `Github Actions` et `Github Pages`:\n",
        "\n",
        "- Cr√©er une branche `gh-pages` √† partir des lignes suivantes\n",
        "\n",
        "```python\n",
        "git checkout --orphan gh-pages\n",
        "git reset --hard # make sure all changes are committed before running this!\n",
        "git commit --allow-empty -m \"Initialising gh-pages branch\"\n",
        "git push origin gh-pages\n",
        "```\n",
        "\n",
        "- Revenir √† votre branche\n",
        "- Cr√©er un fichier `.github/workflows/website.yaml` avec le contenu de [ce fichier](https://raw.githubusercontent.com/ensae-reproductibilite/application/tree/appli20/.github/workflows/publish.yaml)\n",
        "- Modifier le `README` pour indiquer l'URL de votre site web et de votre API\n",
        "\n",
        ":::\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli20\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "# Partie 6: adopter une approche MLOps pour am√©liorer notre mod√®le\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Si vous prenez ce projet fil rouge en cours de route\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git checkout appli20\n",
        "git checkout -b dev\n",
        "git push origin dev\n",
        "```\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "Maintenant que nous avons tout pr√©par√© pour mettre √† disposition rapidement un mod√®le,\n",
        "nous pouvons revenir en arri√®re pour am√©liorer ce mod√®le. Pour cela, nous allons mettre en oeuvre une validation crois√©e.\n",
        "\n",
        "Le probl√®me que nous allons rencontrer va √™tre que nous voudrions facilement tracer les √©volutions de notre mod√®le, la qualit√© pr√©dictive de celui-ci dans diff√©rentes situations. Il s'agira d'√† nouveau mettre en place du _logging_ mais, cette fois, de suivre la qualit√© du mod√®le et pas seulement s'il fonctionne. L'outil `MLFlow` va r√©pondre √† ce probl√®me et va, au passage, fluidifier la mise √† disposition du mod√®le de production, c'est-√†-dire de celui qu'on d√©sire mettre √† disposition du public.\n",
        "\n",
        "## Revenir sur le code d'entra√Ænement du mod√®le pour faire de la validation crois√©e\n",
        "\n",
        "Pour pouvoir faire ceci, il va falloir changer un tout petit peu notre code applicatif dans sa phase d'entra√Ænement.\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 21 _(optionnelle)_: restructuration de la cha√Æne\n",
        "\n",
        "1. Faire les modifications suivantes pour restructurer notre _pipeline_\n",
        "afin de mieux distinguer les √©tapes d'estimation et d'√©valuation\n",
        "\n",
        "\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "Modification de `train.py` pour faire une _grid search_\n",
        "</summary>\n",
        "\n",
        "```{.python filename=\"train.py\"}\n",
        "\"\"\"\n",
        "Prediction de la survie d'un individu sur le Titanic\n",
        "\"\"\"\n",
        "\n",
        "import os\n",
        "from dotenv import load_dotenv\n",
        "import argparse\n",
        "from loguru import logger\n",
        "\n",
        "import pathlib\n",
        "from joblib import dump\n",
        "import pandas as pd\n",
        "from sklearn.model_selection import GridSearchCV\n",
        "\n",
        "from src.pipeline.build_pipeline import split_train_test, create_pipeline\n",
        "from src.models.train_evaluate import evaluate_model\n",
        "\n",
        "\n",
        "# ENVIRONMENT CONFIGURATION ---------------------------\n",
        "\n",
        "logger.add(\"recording.log\", rotation=\"500 MB\")\n",
        "load_dotenv()\n",
        "\n",
        "parser = argparse.ArgumentParser(description=\"Param√®tres du random forest\")\n",
        "parser.add_argument(\n",
        "    \"--n_trees\", type=int, default=20, help=\"Nombre d'arbres\"\n",
        ")\n",
        "args = parser.parse_args()\n",
        "\n",
        "URL_RAW = \"https://minio.lab.sspcloud.fr/lgaliana/ensae-reproductibilite/data/raw/data.csv\"\n",
        "\n",
        "n_trees = args.n_trees\n",
        "jeton_api = os.environ.get(\"JETON_API\", \"\")\n",
        "data_path = os.environ.get(\"data_path\", URL_RAW)\n",
        "data_train_path = os.environ.get(\"train_path\", \"data/derived/train.parquet\")\n",
        "data_test_path = os.environ.get(\"test_path\", \"data/derived/test.parquet\")\n",
        "MAX_DEPTH = None\n",
        "MAX_FEATURES = \"sqrt\"\n",
        "\n",
        "if jeton_api.startswith(\"$\"):\n",
        "    logger.info(\"API token has been configured properly\")\n",
        "else:\n",
        "    logger.warning(\"API token has not been configured\")\n",
        "\n",
        "\n",
        "# IMPORT ET STRUCTURATION DONNEES --------------------------------\n",
        "\n",
        "p = pathlib.Path(\"data/derived/\")\n",
        "p.mkdir(parents=True, exist_ok=True)\n",
        "\n",
        "TrainingData = pd.read_csv(data_path)\n",
        "\n",
        "X_train, X_test, y_train, y_test = split_train_test(\n",
        "    TrainingData, test_size=0.1,\n",
        "    train_path=data_train_path,\n",
        "    test_path=data_test_path\n",
        ")\n",
        "\n",
        "\n",
        "# PIPELINE ----------------------------\n",
        "\n",
        "\n",
        "# Create the pipeline\n",
        "pipe = create_pipeline(\n",
        "    n_trees, max_depth=MAX_DEPTH, max_features=MAX_FEATURES\n",
        ")\n",
        "\n",
        "\n",
        "param_grid = {\n",
        "    \"classifier__n_estimators\": [10, 20, 50],\n",
        "    \"classifier__max_leaf_nodes\": [5, 10, 50],\n",
        "}\n",
        "\n",
        "\n",
        "pipe_cross_validation = GridSearchCV(\n",
        "    pipe,\n",
        "    param_grid=param_grid,\n",
        "    scoring=[\"accuracy\", \"precision\", \"recall\", \"f1\"],\n",
        "    refit=\"f1\",\n",
        "    cv=5,\n",
        "    n_jobs=5,\n",
        "    verbose=1,\n",
        ")\n",
        "pipe = pipe_cross_validation.best_estimator_\n",
        "\n",
        "# ESTIMATION ET EVALUATION ----------------------\n",
        "\n",
        "pipe.fit(X_train, y_train)\n",
        "\n",
        "dump(pipe, 'model.joblib')\n",
        "\n",
        "\n",
        "# Evaluate the model\n",
        "score, matrix = evaluate_model(pipe, X_test, y_test)\n",
        "\n",
        "logger.success(f\"{score:.1%} de bonnes r√©ponses sur les donn√©es de test pour validation\")\n",
        "logger.debug(20 * \"-\")\n",
        "logger.info(\"Matrice de confusion\")\n",
        "logger.debug(matrix)\n",
        "```\n",
        "\n",
        "</details>\n",
        "\n",
        "2. Dans le code de l'API (`api/main.py`), changer la version du mod√®le mis en oeuvre en _\"0.2\"_\n",
        "2. Apr√®s avoir committ√© cette nouvelle version du code applicatif, tagguer ce d√©p√¥t avec le tag `v0.0.2`\n",
        "3. Modifier `deployment/deployment.yaml` dans le code `GitOps` pour utiliser ce _tag_.\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli21\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "## Garder une trace des entra√Ænements de notre mod√®le gr√¢ce au _register_ de `MLFlow`\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Si vous prenez ce projet fil rouge en cours de route\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash\n",
        "git checkout appli21\n",
        "```\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "## Enregistrer nos premiers entra√Ænements\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 22 : archiver nos entra√Ænements avec `MLFlow`\n",
        "\n",
        "1. Lancer `MLFlow` depuis l'onflet [Mes services](https://datalab.sspcloud.fr/catalog/automation) du SSPCloud.\n",
        "Attendre que le service soit bien lanc√©.\n",
        "Cela cr√©era un service dont l'URL est de la forme `https://user-{username}.user.lab.sspcloud.fr`. Ce service `MLFlow` communiquera avec les `VSCode` que vous\n",
        "ouvrirez ult√©rieurement √† partir de cet URL ainsi qu'avec le syst√®me de stockage `S3`[^tokenMLFlow].\n",
        "\n",
        "1. Regarder la page `Experiments`. Elle ne contient que `Default` √† ce stade, c'est normal.\n",
        "\n",
        "[^tokenMLFlow]: Par cons√©quent, `MLFLow` b√©n√©ficie de l'injection automatique des _tokens_\n",
        "pour pouvoir lire/√©crire sur S3. Ces jetons ont la m√™me dur√©e avant expiration que ceux\n",
        "de vos services interactifs `VSCode`. Il faut donc, par d√©faut, supprimer et rouvrir un service `MLFLow`\n",
        "r√©guli√®rement. La mani√®re d'√©viter cela\n",
        "est de cr√©er des _service account_ sur [https://minio-console.lab.sspcloud.fr/](https://minio-console.lab.sspcloud.fr/login)\n",
        "et de les renseigner sur [la page](https://datalab.sspcloud.fr/project-settings/s3-configs).\n",
        "\n",
        "\n",
        "2. Une fois le service `MLFlow` fonctionnel,\n",
        "lancer un nouveau `VSCode` pour b√©n√©ficier de la connexion\n",
        "automatique entre les services interactifs du SSPCloud et les services d'automatisation comme `MLFlow`.\n",
        "\n",
        "1. Cl√¥ner votre projet, vous situer sur la branche de travail.\n",
        "\n",
        "2. Dans la section de passage des param√®tres de notre ligne de commande, introduire ce morceau de code:\n",
        "\n",
        "```{.python}\n",
        "parser = argparse.ArgumentParser(description=\"Param√®tres du random forest\")\n",
        "parser.add_argument(\n",
        "    \"--n_trees\", type=int, default=20, help=\"Nombre d'arbres\"\n",
        ")\n",
        "parser.add_argument(\n",
        "    \"--experiment_name\", type=str, default=\"titanicml\", help=\"MLFlow experiment name\"\n",
        ")\n",
        "args = parser.parse_args()\n",
        "```\n",
        "\n",
        "3. Faire tourner `train.py` en ligne de commande puis retourner sur l'UI de `MLFlow`\n",
        "et observer la diff√©rence, √† gauche.\n",
        "\n",
        "4. A la fin du script `train.py`, ajouter le code suivant\n",
        "\n",
        "<details>\n",
        "<summary>\n",
        "Code √† ajouter\n",
        "</summary>\n",
        "\n",
        "```{.python filename=\"fin de train.py\"}\n",
        "# LOGGING IN MLFLOW -----------------\n",
        "\n",
        "input_data_mlflow = mlflow.data.from_pandas(\n",
        "    TrainingData, source=data_path, name=\"Raw dataset\"\n",
        ")\n",
        "training_data_mlflow = mlflow.data.from_pandas(\n",
        "    pd.concat([X_train, y_train]), source=data_path, name=\"Training data\"\n",
        ")\n",
        "\n",
        "\n",
        "with mlflow.start_run():\n",
        "\n",
        "    # Log datasets\n",
        "    mlflow.log_input(input_data_mlflow, context=\"raw\")\n",
        "    mlflow.log_input(training_data_mlflow, context=\"raw\")\n",
        "\n",
        "    # Log parameters\n",
        "    mlflow.log_param(\"n_trees\", n_trees)\n",
        "    mlflow.log_param(\"max_depth\", MAX_DEPTH)\n",
        "    mlflow.log_param(\"max_features\", MAX_FEATURES)\n",
        "\n",
        "    # Log best hyperparameters from GridSearchCV\n",
        "    best_params = pipe_cross_validation.best_params_\n",
        "    for param, value in best_params.items():\n",
        "        mlflow.log_param(param, value)\n",
        "\n",
        "    # Log metrics\n",
        "    mlflow.log_metric(\"accuracy\", score)\n",
        "\n",
        "    # Log confusion matrix as an artifact\n",
        "    matrix_path = \"confusion_matrix.txt\"\n",
        "    with open(matrix_path, \"w\") as f:\n",
        "        f.write(str(matrix))\n",
        "    mlflow.log_artifact(matrix_path)\n",
        "\n",
        "    # Log model\n",
        "    mlflow.sklearn.log_model(pipe, \"model\")\n",
        "```\n",
        "\n",
        "</details>\n",
        "\n",
        "5. Ajouter `mlruns/*` dans `.gitignore`\n",
        "\n",
        "6. Tester `train.py` en ligne de commande\n",
        "\n",
        "7. Observer l'√©volution de la page `Experiments`. Cliquer sur un des _run_.\n",
        "Observer toutes les m√©tadonn√©es archiv√©es (hyperparam√®tres, m√©triques d'√©valuation, `requirements.txt` dont `MLFlow` a fait l'inf√©rence, etc.)\n",
        "\n",
        "1. Observer le code propos√© par `MLFlow` pour r√©cup√©rer le _run_ en question. Tester celui-ci dans un _notebook_ sur le fichier interm√©diaire de test au format `Parquet`\n",
        "\n",
        "2.  En ligne de commande, faites tourner pour une autre valeur de `n_trees`.  Retourner √† la liste des _runs_ en cliquant √† nouveau sur _\"titanicml\"_ dans les exp√©rimentations\n",
        "\n",
        "3.  Dans l'onglet `Table`, s√©lectionner plusieurs exp√©rimentations, cliquer sur `Columns` et ajouter la statistique d'accuracy. Ajuster la taille des colonnes pour la voir et classer les mod√®les par score d√©croissants\n",
        "\n",
        "4.  Cliquer sur `Compare` apr√®s en avoir s√©lectionn√© plusieurs. Afficher un _scatterplot_ des performances\n",
        "en fonction du nombre d'estimateurs. Conclure.\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli22\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "Cette appplication illustre l'un des premiers apports de `MLFlow`: on garde\n",
        "une trace de nos exp√©rimentations: le mod√®le est archiv√© avec les param√®tres et des m√©triques de performance. On peut donc retrouver de plusieurs mani√®res un mod√®le qui nous avait tap√© dans l'oeil.\n",
        "\n",
        "N√©anmoins, persistent un certain nombre de voies d'am√©lioration dans notre _pipeline_.\n",
        "\n",
        "- On entra√Æne le mod√®le en local, de mani√®re s√©quentielle, et en lan√ßant nous-m√™mes le script `train.py`.\n",
        "- Pis encore, √† l'heure actuelle, cette √©tape d'estimation n'est pas s√©par√©e de la mise √† disposition du mod√®le par le biais de notre API. On archive des mod√®les mais on les utilise pas ult√©rieurement.\n",
        "\n",
        "\n",
        "Les prochaines applications permettront d'am√©liorer ceci.\n",
        "\n",
        "## Consommation d'un mod√®le archiv√© sur `MLFlow`\n",
        "\n",
        "A l'heure actuelle, notre _pipeline_ est lin√©aire:\n",
        "\n",
        "![](/chapters/applications/figures/pipeline_avant_appli23.png)\n",
        "\n",
        "Ceci nous g√™ne pour faire √©voluer notre mod√®le: on ne dissocie pas ce qui rel√®ve de l'entra√Ænement du mod√®le de son utilisation. Un _pipeline_ plus cyclique permettra de mieux dissocier l'exp√©rimentation de la production:\n",
        "\n",
        "![](/chapters/applications/figures/pipeline_apres_appli23.png)\n",
        "\n",
        "\n",
        "__TO BE CONTINUED__\n",
        "\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 23 : passer en production un mod√®le avec MLFlow\n",
        "\n",
        "1. A partir du tableau de performance pr√©c√©dent,\n",
        "choisir le mod√®le avec le F1 score maximal.\n",
        "Acc√©der √† celui-ci.\n",
        "\n",
        "Cr√©er un script dans `mlflow/predict.py` pour\n",
        "illustrer l'utilisation d'un mod√®le\n",
        "depuis MLFlow. Nous allons progressivement l'am√©liorer.\n",
        "\n",
        "1. Copier-coller le\n",
        "contenu ci-dessous\n",
        "afin de se simplifier la cr√©ation de donn√©es en entr√©e\n",
        "de notre code\n",
        "\n",
        "```{.python filename=\"data/import_data.py\"}\n",
        "import data\n",
        "\n",
        "@logger.catch\n",
        "def create_data(\n",
        "    sex: str = \"female\",\n",
        "    age: float = 29.0,\n",
        "    fare: float = 16.5,\n",
        "    embarked: str = \"S\",\n",
        ") -> str:\n",
        "    \"\"\"\n",
        "    \"\"\"\n",
        "\n",
        "    df = pd.DataFrame(\n",
        "        {\n",
        "            \"Sex\": [sex],\n",
        "            \"Age\": [age],\n",
        "            \"Fare\": [fare],\n",
        "            \"Embarked\": [embarked],\n",
        "        }\n",
        "    )\n",
        "\n",
        "    return df\n",
        "```\n",
        "\n",
        "2. All√©ger, au passage, le code de l'API, en modifiant la fonction `predict` par celle-ci:\n"
      ],
      "id": "d3cab952"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "from src.data.import_data import create_data\n",
        "\n",
        "async def predict(\n",
        "    sex: str = \"female\",\n",
        "    age: float = 29.0,\n",
        "    fare: float = 16.5,\n",
        "    embarked: str = \"S\"\n",
        ") -> str:\n",
        "    \"\"\"\n",
        "    \"\"\"\n",
        "\n",
        "    df = create_data(\n",
        "        sex=sex,\n",
        "        age=age,\n",
        "        fare=fare,\n",
        "        embarked=embarked\n",
        "    )\n",
        "\n",
        "    prediction = \"Survived üéâ\" if int(model.predict(df)) == 1 else \"Dead ‚ö∞Ô∏è\"\n",
        "\n",
        "    return prediction"
      ],
      "id": "5cd5edcb",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "3. Par le biais \n",
        "\n",
        "6. Cliquer sur votre meilleur mod√®le et introduire dans `mlflow/predict.py`\n",
        "le morceau de code sugg√©r√©\n",
        "par `MLFlow`, du type de celui-ci:\n"
      ],
      "id": "9213283b"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| eval: false\n",
        "import mlflow\n",
        "logged_model = #A CHANGER #<1>\n",
        "\n",
        "# Load model as a PyFuncModel.\n",
        "loaded_model = mlflow.pyfunc.load_model(logged_model)\n",
        "\n",
        "# Predict on a Pandas DataFrame.\n",
        "import pandas as pd\n",
        "loaded_model.predict(pd.DataFrame(data))"
      ],
      "id": "a91d1f34",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "1. _Hash_ du mod√®le\n",
        "\n",
        "Lancer depuis la ligne de commande ce script et observer l'application obtenue.\n",
        "\n",
        ":::\n",
        "\n",
        "A ce stade, nous avons am√©lior√© la fiabilit√© de notre mod√®le car\n",
        "nous utilisons le meilleur. N√©anmoins, celui-ci\n",
        "n'est pas forc√©ment pratique √† r√©cup√©rer car nous utilisons\n",
        "un _hash_ qui certes identifie de mani√®re unique notre mod√®le\n",
        "mais pr√©sente l'inconv√©nient d'√™tre peu intelligible.\n",
        "Nous allons passer de l'exp√©rimentation √† la mise\n",
        "en production en s√©lectionnant explicitement notre meilleur mod√®le.\n",
        "\n",
        "::: {.callout-tip}\n",
        "## Application 23b : passer en production un mod√®le\n",
        "\n",
        "1. Dans la page du mod√®le en question sur `MLFlow`, cliquer sur `Register model`\n",
        "et le nommer `titanic`.\n",
        "2. Aller dans l'onglet `Models` et observer le changement par rapport √† pr√©c√©demment.\n",
        "3. Mettre √† jour le code dans `mlflow/predict.py` pour utiliser la version en\n",
        "production :\n",
        "\n",
        "```{.python filename = \"mlflow/predict.py\"}\n",
        "model_name = \"titanic\"\n",
        "model_version = 1\n",
        "loaded_model = mlflow.pyfunc.load_model(\n",
        "    model_uri=f\"models:/{model_name}/{model_version}\"\n",
        ")\n",
        "```\n",
        "\n",
        "4. Tester cette application. Si celle-ci fonctionne,\n",
        "modifier la r√©cup√©ration du mod√®le dans votre script d'API.\n",
        "\n",
        "5. Tester en local cette API mise √† jour\n",
        "\n",
        "```{.shell filename=\"terminal\"}\n",
        "uvicorn api.main:app --reload --host \"0.0.0.0\" --port 5000\n",
        "```\n",
        "\n",
        "6. Ajouter `mlflow` au `requirements.txt`\n",
        "\n",
        "7. Mettre √† jour\n",
        "les fichiers `.github/worflows/prod.yaml` et `kubernetes/deployment.yaml`\n",
        "pour produire et utiliser le tag `v0.0.5`\n"
      ],
      "id": "6930e7d8"
    },
    {
      "cell_type": "code",
      "metadata": {
        "filename": ".github/worflows/prod.yaml",
        "file": ".github/worflows/prod.yaml"
      },
      "source": [
        "#| eval: false\n",
        "\n",
        "name: Construction image Docker\n",
        "\n",
        "on:\n",
        "  push:\n",
        "    branches:\n",
        "      - main\n",
        "      - dev\n",
        "\n",
        "jobs:\n",
        "  docker:\n",
        "    runs-on: ubuntu-latest\n",
        "    steps:\n",
        "      -\n",
        "        name: Set up QEMU\n",
        "        uses: docker/setup-qemu-action@v3\n",
        "      -\n",
        "        name: Set up Docker Buildx\n",
        "        uses: docker/setup-buildx-action@v3\n",
        "      -\n",
        "        name: Login to Docker Hub\n",
        "        uses: docker/login-action@v3\n",
        "        with:\n",
        "          username: ${{ secrets.DOCKERHUB_USERNAME }}\n",
        "          password: ${{ secrets.DOCKERHUB_TOKEN }}\n",
        "      -\n",
        "        name: Build and push\n",
        "        uses: docker/build-push-action@v5\n",
        "        with:\n",
        "          push: true\n",
        "          tags: linogaliana/application:v0.0.7 #<1>"
      ],
      "id": "39635fff",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "1. Modifier l'image ici\n"
      ],
      "id": "474859aa"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| eval: false\n",
        "# Creating MLflow deployment\n",
        "apiVersion: apps/v1\n",
        "kind: Deployment\n",
        "metadata:\n",
        "  name: titanicml\n",
        "spec:\n",
        "  replicas: 1\n",
        "  selector:\n",
        "    matchLabels:\n",
        "      app: titanicml\n",
        "  template:\n",
        "    metadata:\n",
        "      labels:\n",
        "        app: titanicml\n",
        "    spec:\n",
        "      containers:\n",
        "        - name: api\n",
        "          image: linogaliana/application:v0.0.7 #<1>\n",
        "          imagePullPolicy: Always\n",
        "          env:\n",
        "            - name: MLFLOW_TRACKING_URI\n",
        "              value: https://user-{USERNAME}-mlflow.user.lab.sspcloud.fr #<2>\n",
        "            - name: MLFLOW_MODEL_NAME\n",
        "              value: titanic\n",
        "            - name: MLFLOW_MODEL_VERSION\n",
        "              value: \"1\"\n",
        "          resources:\n",
        "            limits:\n",
        "              memory: \"2Gi\"\n",
        "              cpu: \"1000m\""
      ],
      "id": "387f7fb7",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "1. Modifier l'image `Docker`\n",
        "2. Modifier l'URL de `MLFlow`\n",
        "\n",
        ":::\n",
        "\n",
        "\n",
        "\n",
        "\n",
        "::: {.callout-caution collapse=\"true\"}\n",
        "## Checkpoint\n",
        "\n",
        "```{.bash filename=\"terminal\"}\n",
        "git stash #<1>\n",
        "git checkout appli23\n",
        "```\n",
        "1. Pour annuler les modifications depuis le dernier _commit_\n",
        "\n",
        "\n",
        "![](/checkpoint.jpg){width=80% fig-align=\"center\"}\n",
        "\n",
        ":::\n",
        "\n",
        "### Industrialiser les entra√Ænements de nos mod√®les\n",
        "\n",
        "Pour industrialiser nos entra√Ænements, nous allons cr√©er des processus\n",
        "parall√®les ind√©pendants pour chaque combinaison de nos hyperparam√®tres.\n",
        "Pour cela, l'outil pratique sur le SSPCloud est `Argo workflows`.\n",
        "Chaque combinaison d'hyperparam√®tres sera un processus isol√© √† l'issue duquel sera\n",
        "loggu√© le r√©sultat dans `MLFlow`. Ces entra√Ænements auront lieu en parall√®le.\n",
        "\n",
        "\n",
        "![](https://inseefrlab.github.io/formation-mlops/slides/img/pokemon_workflow.png)\n",
        "\n",
        "\n",
        "1. Lancer un service Argo Workflows\n",
        "2. Dans `mlflow/training.yaml`\n"
      ],
      "id": "66fe1e68"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| eval: false\n",
        "apiVersion: argoproj.io/v1alpha1\n",
        "kind: Workflow\n",
        "metadata:\n",
        "  generateName: titanic-training-workflow-\n",
        "spec:\n",
        "  entrypoint: main\n",
        "  arguments:\n",
        "    parameters:\n",
        "      # The MLflow tracking server is responsible to log the hyper-parameter and model metrics.\n",
        "      - name: mlflow-tracking-uri\n",
        "        value: https://user-lgaliana-argo-workflows.user.lab.sspcloud.fr #<1>\n",
        "      - name: mlflow-experiment-name\n",
        "        value: titanicml #<2>\n",
        "      - name: model-training-conf-list\n",
        "        value: |\n",
        "          [\n",
        "            { \"dim\": 25, \"lr\": 0.1 },\n",
        "            { \"dim\": 100, \"lr\": 0.2 },\n",
        "            { \"dim\": 150, \"lr\": 0.3 }\n",
        "          ]\n",
        "  templates:\n",
        "    # Entrypoint DAG template\n",
        "    - name: main\n",
        "      dag:\n",
        "        tasks:\n",
        "          # Task 0: Start pipeline\n",
        "          - name: start-pipeline\n",
        "            template: start-pipeline-wt\n",
        "          # Task 1: Train model with given params\n",
        "          - name: train-model-with-params\n",
        "            dependencies: [ start-pipeline ]\n",
        "            template: run-model-training-wt\n",
        "            arguments:\n",
        "              parameters:\n",
        "                - name: dim\n",
        "                  value: \"{{item.dim}}\"\n",
        "                - name: lr\n",
        "                  value: \"{{item.lr}}\"\n",
        "            # Pass the inputs to the task using \"withParam\"\n",
        "            withParam: \"{{workflow.parameters.model-training-conf-list}}\"\n",
        "\n",
        "    # Now task container templates are defined\n",
        "    # Worker template for task 0 : start-pipeline\n",
        "    - name: start-pipeline-wt\n",
        "      inputs:\n",
        "      container:\n",
        "        image: busybox\n",
        "        command: [ sh, -c ]\n",
        "        args: [ \"echo Starting pipeline\" ]\n",
        "\n",
        "    # Worker template for task-1 : train model with params\n",
        "    - name: run-model-training-wt\n",
        "      inputs:\n",
        "        parameters:\n",
        "          - name: dim\n",
        "          - name: lr\n",
        "      container:\n",
        "        image: inseefrlab/formation-mlops:main\n",
        "        imagePullPolicy: Always\n",
        "        command: [sh, -c]\n",
        "        args: [\"mlflow run .\n",
        "                --env-manager=local\n",
        "                -P remote_server_uri=$MLFLOW_TRACKING_URI\n",
        "                -P experiment_name=$MLFLOW_EXPERIMENT_NAME\n",
        "                -P dim={{inputs.parameters.dim}}\n",
        "                -P lr={{inputs.parameters.lr}}\"]\n",
        "        env:\n",
        "          - name: MLFLOW_TRACKING_URI\n",
        "            value: \"{{workflow.parameters.mlflow-tracking-uri}}\"\n",
        "          - name: MLFLOW_EXPERIMENT_NAME\n",
        "            value: \"{{workflow.parameters.mlflow-experiment-name}}\""
      ],
      "id": "9581f1c0",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "1. Changer\n",
        "2. `titanicml`\n",
        "\n",
        "max_depth\n",
        "\n",
        "max_features ‚Äúsqrt‚Äù, ‚Äúlog2‚Äù\n",
        "\n",
        "## Pour aller plus loin\n",
        "\n",
        "Cr√©er un service label studio pour √©valuer la qualit√© du mod√®le"
      ],
      "id": "3b4ac959"
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "python3",
      "language": "python",
      "display_name": "Python 3 (ipykernel)",
      "path": "/opt/conda/share/jupyter/kernels/python3"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}