<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Une application fil rouge pour illustrer l’intérêt d’appliquer graduellement les bonnes pratiques dans une optique de mise en production d’une application de data science.">

<title>Mise en production - Application</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Mise en production</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../chapters/introduction.html"> 
<span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-les-bases" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Les bases</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-les-bases">    
        <li>
    <a class="dropdown-item" href="../chapters/linux-101.html">
 <span class="dropdown-text">Linux 101</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/git.html">
 <span class="dropdown-text">Git</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bonnes-pratiques-de-développement" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Bonnes pratiques de développement</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-bonnes-pratiques-de-développement">    
        <li>
    <a class="dropdown-item" href="../chapters/code-quality.html">
 <span class="dropdown-text">Qualité du code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/projects-architecture.html">
 <span class="dropdown-text">Structure des projets</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/big-data.html">
 <span class="dropdown-text">Traitement des données volumineuses</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/portability.html">
 <span class="dropdown-text">Portabilité</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-mise-en-production" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Mise en production</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-mise-en-production">    
        <li>
    <a class="dropdown-item" href="../chapters/deployment.html">
 <span class="dropdown-text">Déploiement</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/mlops.html">
 <span class="dropdown-text">MLOps</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link active" href="../chapters/application.html" aria-current="page"> 
<span class="menu-text">Application</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/evaluation.html"> 
<span class="menu-text">Evaluation</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="button" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/website">
 <span class="dropdown-text">Site web</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/slides">
 <span class="dropdown-text">Slides</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/application-correction">
 <span class="dropdown-text">Application fil rouge</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#partie-0-initialisation-du-projet" id="toc-partie-0-initialisation-du-projet" class="nav-link active" data-scroll-target="#partie-0-initialisation-du-projet">Partie 0 : initialisation du projet</a></li>
  <li><a href="#partie-1-qualité-du-script" id="toc-partie-1-qualité-du-script" class="nav-link" data-scroll-target="#partie-1-qualité-du-script">Partie 1 : qualité du script</a>
  <ul class="collapse">
  <li><a href="#étape-1-sassurer-que-le-script-sexécute-correctement" id="toc-étape-1-sassurer-que-le-script-sexécute-correctement" class="nav-link" data-scroll-target="#étape-1-sassurer-que-le-script-sexécute-correctement">Étape 1 : s’assurer que le script s’exécute correctement</a></li>
  <li><a href="#étape-2-utiliser-un-linter-puis-un-formatter" id="toc-étape-2-utiliser-un-linter-puis-un-formatter" class="nav-link" data-scroll-target="#étape-2-utiliser-un-linter-puis-un-formatter">Étape 2: utiliser un <em>linter</em> puis un <em>formatter</em></a></li>
  <li><a href="#étape-3-gestion-des-paramètres" id="toc-étape-3-gestion-des-paramètres" class="nav-link" data-scroll-target="#étape-3-gestion-des-paramètres">Étape 3: gestion des paramètres</a></li>
  <li><a href="#étape-4-privilégier-la-programmation-fonctionnelle" id="toc-étape-4-privilégier-la-programmation-fonctionnelle" class="nav-link" data-scroll-target="#étape-4-privilégier-la-programmation-fonctionnelle">Étape 4 : Privilégier la programmation fonctionnelle</a></li>
  </ul></li>
  <li><a href="#partie2" id="toc-partie2" class="nav-link" data-scroll-target="#partie2">Partie 2 : adoption d’une structure modulaire</a>
  <ul class="collapse">
  <li><a href="#étape-1-modularisation" id="toc-étape-1-modularisation" class="nav-link" data-scroll-target="#étape-1-modularisation">Étape 1 : modularisation</a></li>
  <li><a href="#étape-2-adopter-une-architecture-standardisée-de-projet" id="toc-étape-2-adopter-une-architecture-standardisée-de-projet" class="nav-link" data-scroll-target="#étape-2-adopter-une-architecture-standardisée-de-projet">Étape 2 : adopter une architecture standardisée de projet</a></li>
  <li><a href="#étape-3-indiquer-lenvironnement-minimal-de-reproductibilité" id="toc-étape-3-indiquer-lenvironnement-minimal-de-reproductibilité" class="nav-link" data-scroll-target="#étape-3-indiquer-lenvironnement-minimal-de-reproductibilité">Étape 3: indiquer l’environnement minimal de reproductibilité</a></li>
  <li><a href="#stockageS3" id="toc-stockageS3" class="nav-link" data-scroll-target="#stockageS3">Étape 4 : stocker les données de manière externe</a></li>
  </ul></li>
  <li><a href="#partie-2bis-packagisation-de-son-projet-optionnel" id="toc-partie-2bis-packagisation-de-son-projet-optionnel" class="nav-link" data-scroll-target="#partie-2bis-packagisation-de-son-projet-optionnel">Partie 2bis: packagisation de son projet (optionnel)</a>
  <ul class="collapse">
  <li><a href="#étape-1-proposer-des-tests-unitaires-optionnel" id="toc-étape-1-proposer-des-tests-unitaires-optionnel" class="nav-link" data-scroll-target="#étape-1-proposer-des-tests-unitaires-optionnel">Étape 1 : proposer des tests unitaires (optionnel)</a></li>
  <li><a href="#étape-2-transformer-son-projet-en-package-optionnel" id="toc-étape-2-transformer-son-projet-en-package-optionnel" class="nav-link" data-scroll-target="#étape-2-transformer-son-projet-en-package-optionnel">Étape 2 : transformer son projet en package (optionnel)</a></li>
  </ul></li>
  <li><a href="#partie3" id="toc-partie3" class="nav-link" data-scroll-target="#partie3">Partie 3 : construction d’un projet portable et reproductible</a>
  <ul class="collapse">
  <li><a href="#anaconda" id="toc-anaconda" class="nav-link" data-scroll-target="#anaconda">Étape 1 : un environnement pour rendre le projet portable</a></li>
  <li><a href="#shell" id="toc-shell" class="nav-link" data-scroll-target="#shell">Étape 2: construire l’environnement de notre application via un script <code>shell</code></a></li>
  <li><a href="#docker" id="toc-docker" class="nav-link" data-scroll-target="#docker">Étape 3: conteneuriser l’application avec <code>Docker</code></a></li>
  </ul></li>
  <li><a href="#partie-4-automatisation-avec-lintégration-continue" id="toc-partie-4-automatisation-avec-lintégration-continue" class="nav-link" data-scroll-target="#partie-4-automatisation-avec-lintégration-continue">Partie 4 : automatisation avec l’intégration continue</a>
  <ul class="collapse">
  <li><a href="#étape-1-mise-en-place-de-tests-automatisés" id="toc-étape-1-mise-en-place-de-tests-automatisés" class="nav-link" data-scroll-target="#étape-1-mise-en-place-de-tests-automatisés">Étape 1: mise en place de tests automatisés</a></li>
  <li><a href="#étape-2-automatisation-de-la-livraison-de-limage-docker" id="toc-étape-2-automatisation-de-la-livraison-de-limage-docker" class="nav-link" data-scroll-target="#étape-2-automatisation-de-la-livraison-de-limage-docker">Étape 2: Automatisation de la livraison de l’image <code>Docker</code></a></li>
  </ul></li>
  <li><a href="#partie-5-expérimenter-en-local-des-valorisations-puis-automatiser-leur-production" id="toc-partie-5-expérimenter-en-local-des-valorisations-puis-automatiser-leur-production" class="nav-link" data-scroll-target="#partie-5-expérimenter-en-local-des-valorisations-puis-automatiser-leur-production">Partie 5: expérimenter en local des valorisations puis automatiser leur production</a>
  <ul class="collapse">
  <li><a href="#étape-1-développer-une-api-en-local" id="toc-étape-1-développer-une-api-en-local" class="nav-link" data-scroll-target="#étape-1-développer-une-api-en-local">Étape 1: développer une API en local</a></li>
  <li><a href="#étape-2-déployer-lapi-de-manière-manuelle" id="toc-étape-2-déployer-lapi-de-manière-manuelle" class="nav-link" data-scroll-target="#étape-2-déployer-lapi-de-manière-manuelle">Étape 2: déployer l’API de manière manuelle</a></li>
  <li><a href="#etape-3-automatiser-le-déploiement-déploiement-en-continu" id="toc-etape-3-automatiser-le-déploiement-déploiement-en-continu" class="nav-link" data-scroll-target="#etape-3-automatiser-le-déploiement-déploiement-en-continu">Etape 3: automatiser le déploiement (déploiement en continu)</a></li>
  <li><a href="#etape-4-construire-un-site-web" id="toc-etape-4-construire-un-site-web" class="nav-link" data-scroll-target="#etape-4-construire-un-site-web">Etape 4: construire un site web</a></li>
  </ul></li>
  <li><a href="#partie-6-adopter-une-approche-mlops-pour-améliorer-notre-modèle" id="toc-partie-6-adopter-une-approche-mlops-pour-améliorer-notre-modèle" class="nav-link" data-scroll-target="#partie-6-adopter-une-approche-mlops-pour-améliorer-notre-modèle">Partie 6: adopter une approche MLOps pour améliorer notre modèle</a>
  <ul class="collapse">
  <li><a href="#restructurer-le-pipeline-pour-fluidifier-la-mise-en-production" id="toc-restructurer-le-pipeline-pour-fluidifier-la-mise-en-production" class="nav-link" data-scroll-target="#restructurer-le-pipeline-pour-fluidifier-la-mise-en-production">Restructurer le <em>pipeline</em> pour fluidifier la mise en production</a></li>
  <li><a href="#garder-une-trace-des-entraînements-de-notre-modèle-grâce-au-register-de-mlflow" id="toc-garder-une-trace-des-entraînements-de-notre-modèle-grâce-au-register-de-mlflow" class="nav-link" data-scroll-target="#garder-une-trace-des-entraînements-de-notre-modèle-grâce-au-register-de-mlflow">Garder une trace des entraînements de notre modèle grâce au <em>register</em> de <code>MLFlow</code></a>
  <ul class="collapse">
  <li><a href="#mise-en-production-dun-modèle" id="toc-mise-en-production-dun-modèle" class="nav-link" data-scroll-target="#mise-en-production-dun-modèle">Mise en production d’un modèle</a></li>
  <li><a href="#industrialiser-les-entraînements-de-nos-modèles" id="toc-industrialiser-les-entraînements-de-nos-modèles" class="nav-link" data-scroll-target="#industrialiser-les-entraînements-de-nos-modèles">Industrialiser les entraînements de nos modèles</a></li>
  </ul></li>
  <li><a href="#pour-aller-plus-loin" id="toc-pour-aller-plus-loin" class="nav-link" data-scroll-target="#pour-aller-plus-loin">Pour aller plus loin</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Application</h1>
</div>

<div>
  <div class="description">
    <p>Une application fil rouge pour illustrer l’intérêt d’appliquer graduellement les bonnes pratiques dans une optique de mise en production d’une application de data science.</p>
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<details>
<summary>
Dérouler les <em>slides</em> ci-dessous ou <a href="https://ensae-reproductibilite.github.io/slides/#/title-slide">cliquer ici</a> pour afficher les slides en plein écran.
</summary>
<div id="cb1" class="sourceCode">
<pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
<iframe class="sourceCode yaml code-with-copy" src="https://ensae-reproductibilite.github.io/slides/#/title-slide">
</iframe>
</div>
</details>
<p>L’objectif de cette mise en application est d’<strong>illustrer les différentes étapes qui séparent la phase de développement d’un projet de celle de la mise en production</strong>. Elle permettra de mettre en pratique les différents concepts présentés tout au long du cours.</p>
<p>Celle-ci est un tutoriel pas à pas pour avoir un projet reproductible et disponible sous plusieurs livrables. Toutes les étapes ne sont pas indispensables à tous les projets de <em>data science</em>.</p>
<p>Nous nous plaçons dans une situation initiale correspondant à la fin de la phase de développement d’un projet de data science. On a un <em>notebook</em> un peu monolithique, qui réalise les étapes classiques d’un <em>pipeline</em> de <em>machine learning</em> :</p>
<ul>
<li>Import de données ;</li>
<li>Statistiques descriptives et visualisations ;</li>
<li><em>Feature engineering</em> ;</li>
<li>Entraînement d’un modèle ;</li>
<li>Evaluation du modèle.</li>
</ul>
<p><strong>L’objectif est d’améliorer le projet de manière incrémentale jusqu’à pouvoir le mettre en production, en le valorisant sous une forme adaptée.</strong></p>
<details>
<summary>
Illustration de notre point de départ
</summary>
<img src="../workflow1.png" class="img-fluid">
</details>
<details>
<summary>
Illustration de l’horizon vers lequel on se dirige
</summary>
<img src="../workflow2.png" class="img-fluid">
</details>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Il est important de bien lire les consignes et d’y aller progressivement. Certaines étapes peuvent être rapides, d’autres plus fastidieuses ; certaines être assez guidées, d’autres vous laisser plus de liberté. Si vous n’effectuez pas une étape, vous risquez de ne pas pouvoir passer à l’étape suivante qui en dépend.</p>
<p>Bien que l’exercice soit applicable sur toute configuration bien faite, nous recommandons de privilégier l’utilisation du <a href="https://datalab.sspcloud.fr/home">SSP Cloud</a>, où tous les outils nécessaires sont pré-installés et pré-configurés. Le service <code>VSCode</code> ne sera en effet que le point d’entrée pour l’utilisation d’outils plus exigeants sur le plan de l’infrastructure: <em>Argo</em>, <em>MLFLow</em>, etc.</p>
</div>
</div>
<section id="partie-0-initialisation-du-projet" class="level1">
<h1>Partie 0 : initialisation du projet</h1>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application préliminaire: forker le dépôt d’exemple
</div>
</div>
<div class="callout-body-container callout-body">
<p>Les premières étapes consistent à mettre en place son environnement de travail sur <code>Github</code>:</p>
<ul>
<li><p>Générer un jeton d’accès (<em>token</em>) sur <code>GitHub</code> afin de permettre l’authentification en ligne de commande à votre compte. La procédure est décrite <a href="https://docs.sspcloud.fr/onyxia-guide/controle-de-version#creer-un-jeton-dacces-token">ici</a>. <strong>Vous ne voyez ce jeton qu’une fois, ne fermez pas la page de suite</strong>.</p></li>
<li><p>Mettez de côté ce jeton en l’enregistrant dans un gestionnaire de mot de passe ou dans l’espace <em><a href="https://datalab.sspcloud.fr/account/third-party-integration">“Mon compte”</a></em> du <code>SSP Cloud</code>.</p></li>
<li><p>Forker le dépôt <code>Github</code> : <a href="https://github.com/ensae-reproductibilite/application-correction">https://github.com/ensae-reproductibilite/application-correction</a> en faisant attention à deux choses:</p>
<ul>
<li>Décocher la case <em>“Copy the <code>main</code> branch only”</em> afin de copier également les <em>tags</em> <code>Git</code> qui nous permettront de faire les <em>checkpoint</em></li>
</ul></li>
</ul>
<details>
<summary>
Ce que vous devriez voir sur la page de création du <em>fork</em>
</summary>
<p><img src="../fork-example.png" class="img-fluid"></p>
</details>
<p>Il est maintenant possible de ce lancer dans la création de l’environnement de travail:</p>
<ul>
<li>Ouvrir un service <code>VSCode</code> sur le <a href="https://datalab.sspcloud.fr/home">SSP Cloud</a>. Vous pouvez aller dans la page <code>My Services</code> et cliquer sur <code>New service</code>. Sinon, vous pouvez initialiser la création du service en cliquant directement <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?autoLaunch=false">ici</a>. <strong>Modifier les options suivantes</strong>:
<ul>
<li>Dans l’onglet <code>Kubernetes</code>, sélectionner le rôle <code>Admin</code> ;</li>
<li>Dans l’onglet <code>Networking</code>, cliquer sur <em>“Enable a custom service port”</em> et laisser la valeur par défaut 5000 pour le numéro du port</li>
</ul></li>
<li>Clôner <strong>votre</strong> dépôt <code>Github</code> en utilisant le terminal depuis <code>Visual Studio</code> (<code>Terminal &gt; New Terminal</code>) et en passant directement le token dans l’URL selon cette structure:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb1" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git clone https://<span class="va">$TOKEN</span>@github.com/<span class="va">$USERNAME</span>/application-correction.git</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>où <code>$TOKEN</code> et <code>$USERNAME</code> sont à remplacer, respectivement, par le jeton que vous avez généré précédemment et votre nom d’utilisateur.</p>
<ul>
<li>Se placer avec le terminal dans le dossier en question :</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb2" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd application-correction</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Se placer sur une branche de travail en faisant:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb3" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout <span class="at">-b</span> dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="partie-1-qualité-du-script" class="level1">
<h1>Partie 1 : qualité du script</h1>
<p>Cette première partie vise à <strong>rendre le projet conforme aux bonnes pratiques</strong> présentées dans le cours.</p>
<p>Elle fait intervenir les notions suivantes :</p>
<ul>
<li>Utilisation du <strong>terminal</strong> (voir <a href="../chapters/linux-101.html">Linux 101</a>) ;</li>
<li><strong>Qualité du code</strong> (voir <a href="../chapters/code-quality.html">Qualité du code</a>) ;</li>
<li><strong>Architecture de projets</strong> (voir <a href="../chapters/projects-architecture.html">Architecture des projets</a>) ;</li>
<li><strong>Contrôle de version</strong> avec <code>Git</code> (voir <a href="../chapters/git.html">Rappels <code>Git</code></a>) ;</li>
<li><strong>Travail collaboratif</strong> avec <code>Git</code> et <code>GitHub</code> (voir <a href="../chapters/git.html">Rappels <code>Git</code></a>).</li>
</ul>
<p>Le plan de la partie est le suivant :</p>
<ol type="1">
<li>S’assurer que le script fonctionne ;</li>
<li>Nettoyer le code des scories formelles avec un <em>linter</em> et un <em>formatter</em> ;</li>
<li>Paramétrisation du script ;</li>
<li>Utilisation de fonctions.</li>
</ol>
<section id="étape-1-sassurer-que-le-script-sexécute-correctement" class="level2">
<h2 class="anchored" data-anchor-id="étape-1-sassurer-que-le-script-sexécute-correctement">Étape 1 : s’assurer que le script s’exécute correctement</h2>
<p>On va partir du fichier <code>notebook.py</code> qui reprend le contenu du <em>notebook</em><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> mais dans un script classique. Le travail de nettoyage en sera facilité.</p>
<p>La première étape est simple, mais souvent oubliée : <strong>vérifier que le code fonctionne correctement</strong>. Pour cela, nous recommandons de faire un aller-retour entre le script ouvert dans <code>VSCode</code> et un terminal pour le lancer.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 1: corriger les erreurs
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Ouvrir dans <code>VSCode</code> le script <code>titanic.py</code> ;</li>
<li>Exécuter le script en ligne de commande (<code>python titanic.py</code>)<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> pour détecter les erreurs ;</li>
<li>Corriger les deux erreurs qui empêchent la bonne exécution ;</li>
<li>Vérifier le fonctionnement du script en utilisant la ligne de commande:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb4" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python titanic.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Le code devrait afficher des sorties.</p>
<details>
<summary>
Aide sur les erreurs rencontrées
</summary>
<p>La première erreur rencontrée est une alerte <code>FileNotFoundError</code>, la seconde est liée à un <em>package</em>.</p>
</details>
<p>Il est maintenant temps de <em>commit</em> les changements effectués avec <code>Git</code><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> :</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git add titanic.py</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git commit <span class="at">-m</span> <span class="st">"Corrige l'erreur qui empêchait l'exécution"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git push</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!---- 
Temps estimé: 3mn
------>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-19" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-19-1" class="code-annotation-target"><a href="#annotated-cell-19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-19-2"><a href="#annotated-cell-19-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli1</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-19" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="étape-2-utiliser-un-linter-puis-un-formatter" class="level2">
<h2 class="anchored" data-anchor-id="étape-2-utiliser-un-linter-puis-un-formatter">Étape 2: utiliser un <em>linter</em> puis un <em>formatter</em></h2>
<p>On va maintenant améliorer la qualité de notre code en appliquant les standards communautaires. Pour cela, on va utiliser le <em>linter</em> classique <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et le <em>formatter</em> <a href="https://github.com/psf/black"><code>Black</code></a>. Si vous désirez un outil deux en un, il est possible d’utiliser <a href="https://github.com/astral-sh/ruff-vscode"><code>Ruff</code></a> en complément ou substitut.</p>
<p>Ce nettoyage automatique du code permettra, au passage, de restructurer notre script de manière plus naturelle.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a> sont des <em>packages</em> <code>Python</code> qui s’utilisent principalement en ligne de commande.</p>
<p>Si vous avez une erreur qui suggère que votre terminal ne connait pas <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> ou <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a>, n’oubliez pas d’exécuter la commande <code>pip install pylint</code> ou <code>pip install black</code>.</p>
</div>
</div>
<p>Le <em>linter</em> renvoie alors une série d’irrégularités, en précisant à chaque fois la ligne de l’erreur et le message d’erreur associé (ex : mauvaise identation). Il renvoie finalement une note sur 10, qui estime la qualité du code à l’aune des standards communautaires évoqués dans la partie <a href="../chapters/code-quality.html">Qualité du code</a>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 2: rendre lisible le script
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Diagnostiquer et évaluer la qualité de <code>titanic.py</code> avec <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a>. Regarder la note obtenue.</li>
<li>Utiliser <code>black titanic.py --diff --color</code> pour observer les changements de forme que va induire l’utilisation du <em>formatter</em> <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a>. Cette étape n’applique pas les modifications, elle ne fait que vous les montrer.</li>
<li>Appliquer le <em>formatter</em> <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a></li>
<li>Réutiliser <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> pour diagnostiquer l’amélioration de la qualité du script et le travail qui reste à faire.</li>
<li>Comme la majorité du travail restant est à consacrer aux imports:
<ul>
<li>Mettre tous les <em>imports</em> ensemble en début de script</li>
<li>Retirer les <em>imports</em> redondants en s’aidant des diagnostics de votre éditeur</li>
<li>Réordonner les <em>imports</em> si <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> vous indique de le faire</li>
<li>Corriger les dernières fautes formelles suggérées par <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a></li>
</ul></li>
<li>Délimiter des parties dans votre code pour rendre sa structure plus lisible. Si des parties vous semblent être dans le désordre, vous pouvez réordonner le script (mais n’oubliez pas de le tester)</li>
</ul>
<!-----
Temps test Julien: 22mn
------>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-20" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-20-1" class="code-annotation-target"><a href="#annotated-cell-20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-20-2"><a href="#annotated-cell-20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli2</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-20" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>Le code est maintenant lisible, il obtient à ce stade une note formelle proche de 10. Mais il n’est pas encore totalement intelligible ou fiable. Il y a notamment quelques redondances de code auxquelles nous allons nous attaquer par la suite. Néanmoins, avant cela, occupons-nous de mieux gérer certains paramètres du script: jetons d’API et chemin des fichiers.</p>
</section>
<section id="étape-3-gestion-des-paramètres" class="level2">
<h2 class="anchored" data-anchor-id="étape-3-gestion-des-paramètres">Étape 3: gestion des paramètres</h2>
<p>L’exécution du code et les résultats obtenus dépendent de certains paramètres définis dans le code. L’étude de résultats alternatifs, en jouant sur des variantes des (hyper)paramètres, est à ce stade compliquée car il est nécessaire de parcourir le code pour trouver ces paramètres. De plus, certains paramètres personnels comme des jetons d’API ou des mots de passe n’ont pas vocation à être présents dans le code.</p>
<p>Il est plus judicieux de considérer ces paramètres comme des variables d’entrée du script. Cela peut être fait de deux manières:</p>
<ol type="1">
<li>Avec des <strong>arguments optionnels</strong> appelés depuis la ligne de commande <em>(Application 3a)</em>. Cela peut être pratique pour mettre en oeuvre des tests automatisés mais n’est pas forcément pertinent pour toutes les variables. Nous allons montrer cet usage avec le nombre d’arbres de notre <em>random forest</em> ;</li>
<li>En utilisant un <strong>fichier de configuration</strong> dont les valeurs sont importées dans le script principal <em>(Application 3b)</em>.</li>
</ol>
<details>
<summary>
Un exemple de définition d’un argument pour l’utilisation en ligne de commande
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>prenom.py</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="prenom.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span><span class="st">"Qui êtes-vous?"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>parser.add_argument(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"--prenom"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, default<span class="op">=</span><span class="st">"Toto"</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Un prénom à afficher"</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>args <span class="op">=</span> parser.parse_args()</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(args.prenom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Exemples d’utilisations en ligne de commande</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb7" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python prenom.py</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python prenom.py <span class="at">--prenom</span> <span class="st">"Zinedine"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 3a: Paramétrisation du script
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>En s’inspirant de l’exemple ci-dessus 👆️, créer une variable <code>n_trees</code> qui peut éventuellement être paramétrée en ligne de commande et dont la valeur par défaut est 20 ;</li>
<li>Tester cette paramétrisation en ligne de commande avec la valeur par défaut puis 2, 10 et 50 arbres.</li>
</ol>
</div>
</div>
<p>L’exercice suivant permet de mettre en application le fait de paramétriser un script en utilisant des variables définies dans un fichier YAML.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 3b: La configuration dans un fichier YAML
</div>
</div>
<div class="callout-body-container callout-body">
<p>Nous allons mettre 4 paramètres dans notre YAML. Celui-ci prendra la forme suivante:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>config.yaml</strong></pre>
</div>
<div class="sourceCode" id="cb8" data-filename="config.yaml" data-code-line-numbers=""><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">jeton_api</span><span class="kw">:</span><span class="co"> ####</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data_path</span><span class="kw">:</span><span class="co"> ####</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Avec <code>####</code> des valeurs à remplacer.</p>
<ol type="1">
<li>Créer à la racine du projet un fichier <code>config.yaml</code> à partir du modèle 👆️ ;</li>
<li>Repérer les valeurs dans le code associé et compléter.</li>
</ol>
<p>Maintenant, nous allons exploiter ce fichier:</p>
<ol start="3" type="1">
<li>Pour éviter d’avoir à le faire plus tard, créer une fonction <code>import_yaml_config</code> qui prend en argument le chemin d’un fichier <code>YAML</code> et renvoie le contenu de celui-ci en <em>output</em>. Vous pouvez suivre le conseil du chapitre sur la <a href="../chapters/code-quality.html">Qualité du code</a> en adoptant le <em>type hinting</em> ;</li>
</ol>
<details>
<summary>
Indice si vous ne trouvez pas comment lire un fichier <code>YAML</code>
</summary>
<p>Si le fichier s’appelle <code>toto.yaml</code>, vous pouvez l’importer de cette manière:</p>
<div id="8467cdb1" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb9" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"toto.yaml"</span>, <span class="st">"r"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> stream:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    dict_config <span class="op">=</span> yaml.safe_load(stream)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ol start="4" type="1">
<li>Dans la fonction <code>import_yaml_config</code>, créer une condition logique pour tenir compte du fait que le YAML de configuration peut ne pas exister<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> ;</li>
</ol>
<details>
<summary>
Indice si vous ne savez comment conditionner la création de la configuration à l’existence du fichier
</summary>
<p>Voici la ligne qui peut vous aider. L’idéal est d’insérer ceci dans <code>import_yaml_config</code>:</p>
<div id="da1a6826" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb10" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>CONFIG_PATH <span class="op">=</span> <span class="st">'config.yaml'</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> {}</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(CONFIG_PATH):</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lecture du fichier</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ol start="5" type="1">
<li>Utiliser le canevas de code suivant pour créer les variables adéquates</li>
</ol>
<div id="b413bf29" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb11" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>API_TOKEN <span class="op">=</span> config.get(<span class="st">"jeton_api"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>TRAIN_PATH <span class="op">=</span> config.get(<span class="st">"train_path"</span>, <span class="st">"train.csv"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>TEST_PATH <span class="op">=</span> config.get(<span class="st">"test_path"</span>, <span class="st">"test.csv"</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>TEST_FRACTION <span class="op">=</span> config.get(<span class="st">"test_fraction"</span>, <span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>et remplacer dans le code ;</p>
<ol start="5" type="1">
<li>Tester en ligne de commande que l’exécution du fichier est toujours sans erreur et sinon corriger ;</li>
<li>Refaire un diagnostic avec <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et corriger les éventuels messages ;</li>
<li>Créer un fichier <code>.gitignore</code> (cf.&nbsp;<a href="../chapters/git.html">Chapitre <code>Git</code></a>). Ajouter dans ce fichier <code>config.yaml</code> car il ne faut pas committer ce fichier. Au passage ajouter <code>__pycache__/</code> au <code>.gitignore</code><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>, cela évitera d’avoir à le faire ultérieurement ;</li>
<li>Créer un fichier <code>README.md</code> où vous indiquez qu’il faut créer un fichier <code>config.yaml</code> pour pouvoir utiliser l’API.</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-28" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-28-1" class="code-annotation-target"><a href="#annotated-cell-28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-28-2"><a href="#annotated-cell-28-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli3</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-28" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="étape-4-privilégier-la-programmation-fonctionnelle" class="level2">
<h2 class="anchored" data-anchor-id="étape-4-privilégier-la-programmation-fonctionnelle">Étape 4 : Privilégier la programmation fonctionnelle</h2>
<p>Nous allons <strong>mettre en fonctions les parties importantes de l’analyse</strong>. Ceci facilitera l’étape ultérieure de modularisation de notre projet.</p>
<p>Cet exercice étant chronophage, il n’est <strong>pas obligatoire de le réaliser en entier</strong>. L’important est de comprendre la démarche et d’adopter fréquemment une approche fonctionnelle<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>. Pour obtenir une chaine entièrement fonctionnalisée, vous pouvez reprendre le <em>checkpoint</em>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 4: adoption des standards de programmation fonctionnelle
</div>
</div>
<div class="callout-body-container callout-body">
<p>Cette application peut être chronophage, vous pouvez aller plus ou moins loin dans la fonctionalisation de votre script en fonction du temps dont vous disposez.</p>
<ul>
<li>Créer une fonction générique pour réduire la redondance de code dans l’étape d’exploration des données où on utilise <code>split</code> ;</li>
<li>Créer une fonction qui réalise le <em>split train/test</em> en fonction d’un paramètre représentant la proportion de l’échantillon de test et d’arguments optionnels sur les chemins d’écriture des deux échantillons en csv.</li>
<li>Créer une fonction qui intègre les différentes étapes du <em>pipeline</em> (preprocessing et définition du modèle). Cette fonction prend en paramètre le nombre d’arbres (argument obligatoire) et des arguments optionnels supplémentaires (les colonnes sur lesquelles s’appliquent les différentes étapes du <em>pipeline</em>, <code>max_depth</code> et <code>max_features</code>).</li>
<li>Créer une fonction d’évaluation renvoyant le score obtenu et la matrice de confusion, à l’issue d’une estimation (mais cette estimation est faite en amont de la fonction, pas au sein de celle-ci)</li>
<li>Déplacer toutes les fonctions ensemble, en début de script.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Le fait d’appliquer des fonctions a déjà amélioré la fiabilité du processus en réduisant le nombre d’erreurs de copier-coller. Néanmoins, pour vraiment fiabiliser le processus, il faudrait utiliser un <em>pipeline</em> de transformations de données.</p>
<p>Ceci n’est pas encore au programme du cours mais le sera dans une prochaine version.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-13-contents" aria-controls="callout-13" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-13" class="callout-13-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-29" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-29-1" class="code-annotation-target"><a href="#annotated-cell-29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-29-2"><a href="#annotated-cell-29-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli4</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-29" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>Cela ne se remarque pas encore vraiment car nous avons de nombreuses définitions de fonctions mais notre chaine de production est beaucoup plus concise (le script fait environ 300 lignes dont 250 de définitions de fonctions génériques). Cette auto-discipline facilitera grandement les étapes ultérieures. Cela aurait été néanmoins beaucoup moins coûteux en temps d’adopter ces bons gestes de manière plus précoce.</p>
</section>
</section>
<section id="partie2" class="level1">
<h1>Partie 2 : adoption d’une structure modulaire</h1>
<p>Dans la partie précédente, on a appliqué de manière incrémentale de nombreuses bonnes pratiques vues tout au long du cours. Ce faisant, on s’est déjà considérablement rapprochés d’un possible partage du code : celui-ci est lisible et intelligible. Le code est proprement versionné sur un dépôt <code>GitHub</code>. Cependant, le projet est encore perfectible: il est encore difficile de rentrer dedans si on ne sait pas exactement ce qu’on recherche. L’objectif de cette partie est d’isoler les différentes étapes de notre <em>pipeline</em>. Outre le gain de clarté pour notre projet, nous économiserons beaucoup de peines pour la mise en production ultérieure de notre modèle.</p>
<details>
<summary>
Illustration de l’état actuel du projet
</summary>
<img src="../schema_post_appli4.png" class="img-fluid">
</details>
<p>Dans cette partie nous allons continuer les améliorations incrémentales de notre projet avec les étapes suivantes:</p>
<ol type="1">
<li>Modularisation du code <code>Python</code> pour séparer les différentes étapes de notre <em>pipeline</em> ;</li>
<li>Adopter une structure standardisée pour notre projet afin d’autodocumenter l’organisation de celui-ci ;</li>
<li>Documenter les <em>packages</em> indispensables à l’exécution du code ;</li>
<li>Stocker les données dans un environnement adéquat afin de continuer la démarche de séparer conceptuellement les données du code en de la configuration.</li>
</ol>
<section id="étape-1-modularisation" class="level2">
<h2 class="anchored" data-anchor-id="étape-1-modularisation">Étape 1 : modularisation</h2>
<p>Nous allons profiter de la modularisation pour adopter une structure applicative pour notre code. Celui-ci n’étant en effet plus lancé que depuis la ligne de commande, on peut considérer qu’on construit une application générique où un script principal (<code>main.py</code>) encapsule des éléments issus d’autres scripts <code>Python</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 5: modularisation
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Déplacer les fonctions dans une série de fichiers dédiés:
<ul>
<li><code>import_data.py</code>: fonctions d’import et d’exploration de données</li>
<li><code>build_features.py</code>: fonctions regroupant la définition des échantillons d’apprentissage et de test ainsi que le <em>pipeline</em></li>
<li><code>train_evaluate.py</code>: fonctions d’évaluation du modèle</li>
</ul></li>
<li>Spécifier les dépendances (i.e.&nbsp;les packages à importer) dans les modules pour que ceux-ci puissent s’exécuter indépendamment ;</li>
<li>Renommer <code>titanic.py</code> en <code>main.py</code> pour suivre la convention de nommage des projets <code>Python</code> ;</li>
<li>Importer les fonctions nécessaires à partir des modules.</li>
<li>Vérifier que tout fonctionne bien en exécutant le <em>script</em> <code>main</code> à partir de la ligne de commande :</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb12" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python main.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-32" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-32" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-32-1" class="code-annotation-target"><a href="#annotated-cell-32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-32-2"><a href="#annotated-cell-32-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli5</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-32" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-32" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="étape-2-adopter-une-architecture-standardisée-de-projet" class="level2">
<h2 class="anchored" data-anchor-id="étape-2-adopter-une-architecture-standardisée-de-projet">Étape 2 : adopter une architecture standardisée de projet</h2>
<p>On dispose maintenant d’une application <code>Python</code> fonctionnelle. Néanmoins, le projet est certes plus fiable mais sa structuration laisse à désirer et il serait difficile de rentrer à nouveau dans le projet dans quelques temps.</p>
<details>
<summary>
Etat actuel du projet 🙈
</summary>
<pre data-code-line-numbers=""><code>├── .gitignore
├── data.csv
├── train.csv
├── test.csv
├── README.md
├── config.yaml
├── import_data.py
├── build_features.py
├── train_evaluate.py
├── titanic.ipynb
└── main.py</code></pre>
</details>
<p>Comme cela est expliqué dans la partie <a href="../chapters/projects-architecture.html">Structure des projets</a>, on va adopter une structure certes arbitraire mais qui va faciliter l’autodocumentation de notre projet. De plus, une telle structure va faciliter des évolutions optionnelles comme la <em>packagisation</em> du projet. Passer d’une structure modulaire bien faite à un <em>package</em> est quasi-immédiat en <code>Python</code>.</p>
<p>On va donc modifier l’architecture de notre projet pour la rendre plus standardisée. Pour cela, on va s’inspirer des structures <a href="https://cookiecutter.readthedocs.io/en/stable/"><code>cookiecutter</code></a> qui génèrent des <em>templates</em> de projet. En l’occurrence notre source d’inspiration sera le <a href="https://drivendata.github.io/cookiecutter-data-science/"><em>template datascience</em></a> issu d’un effort communautaire.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>L’idée de <a href="https://cookiecutter.readthedocs.io/en/stable/"><code>cookiecutter</code></a> est de proposer des <em>templates</em> que l’on utilise pour <strong>initialiser</strong> un projet, afin de bâtir à l’avance une structure évolutive. La syntaxe à utiliser dans ce cas est la suivante :</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb14" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install cookiecutter</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cookiecutter https://github.com/drivendata/cookiecutter-data-science</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ici, on a déjà un projet, on va donc faire les choses dans l’autre sens : on va s’inspirer de la structure proposée afin de réorganiser celle de notre projet selon les standards communautaires.</p>
</div>
</div>
<p>En s’inspirant du <em>cookiecutter data science</em> on va adopter la structure suivante:</p>
<details>
<summary>
Structure recommandée
</summary>
<pre data-code-line-numbers=""><code>application
├── main.py
├── README.md
├── data
│   ├── raw
│   │   └── data.csv
│   └── derived
│       ├── test.csv
│       └── train.csv
├── configuration
│   └── config.yaml
├── notebooks
│   └── titanic.ipynb
└── src
    ├── data
    │   └── import_data.py
    ├── pipeline
    │   └── build_pipeline.py
    └── models
        └── train_evaluate.py</code></pre>
</details>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 6: adopter une structure lisible
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><em>(optionnel)</em> Analyser et comprendre la <a href="https://drivendata.github.io/cookiecutter-data-science/#directory-structure">structure de projet</a> proposée par le template ;</li>
<li>Modifier l’arborescence du projet selon le modèle ;</li>
<li>Mettre à jour l’import des dépendances, le fichier de configuration et <code>main.py</code> avec les nouveaux chemins ;</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-18-contents" aria-controls="callout-18" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-18" class="callout-18-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-35" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-35" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-35-1" class="code-annotation-target"><a href="#annotated-cell-35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-35-2"><a href="#annotated-cell-35-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli6</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-35" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-35" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="étape-3-indiquer-lenvironnement-minimal-de-reproductibilité" class="level2">
<h2 class="anchored" data-anchor-id="étape-3-indiquer-lenvironnement-minimal-de-reproductibilité">Étape 3: indiquer l’environnement minimal de reproductibilité</h2>
<p>Le script <code>main.py</code> nécessite un certain nombre de packages pour être fonctionnel. Chez vous les packages nécessaires sont bien sûr installés mais êtes-vous assuré que c’est le cas chez la personne qui testera votre code ?</p>
<p>Afin de favoriser la portabilité du projet, il est d’usage de <em>“fixer l’environnement”</em>, c’est-à-dire d’indiquer dans un fichier toutes les dépendances utilisées ainsi que leurs version. Nous proposons de créer un fichier <code>requirements.txt</code> minimal, sur lequel nous reviendrons dans la partie consacrée aux environnements reproductibles.</p>
<p>Le fichier <code>requirements.txt</code> est conventionnellement localisé à la racine du projet. Ici on ne va pas fixer les versions, on raffinera ce fichier ultérieurement.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 7: création du <code>requirements.txt</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Créer un fichier <code>requirements.txt</code> avec la liste des packages nécessaires</li>
<li>Ajouter une indication dans <code>README.md</code> sur l’installation des <em>packages</em> grâce au fichier <code>requirements.txt</code></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-20-contents" aria-controls="callout-20" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-20" class="callout-20-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-36" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-36-1" class="code-annotation-target"><a href="#annotated-cell-36-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-36-2"><a href="#annotated-cell-36-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli7</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-36" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-36" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="stockageS3" class="level2">
<h2 class="anchored" data-anchor-id="stockageS3">Étape 4 : stocker les données de manière externe</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-21-contents" aria-controls="callout-21" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pour en savoir plus sur le système de stockage <code>S3</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-21" class="callout-21-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Pour mettre en oeuvre cette étape, il peut être utile de comprendre un peu comme fonctionne le SSP Cloud. Vous devrez suivre la <a href="https://inseefrlab.github.io/docs.sspcloud.fr/docs/fr/storage.html">documentation du SSP Cloud</a> pour la réaliser. Une aide-mémoire est également disponible dans le cours de 2e année de l’ENSAE <a href="https://linogaliana-teaching.netlify.app/reads3/#">Python pour la <em>data science</em></a>.</p>
</div>
</div>
</div>
<p>Le chapitre sur la <a href="../chapters/projects-architecture.html">structure des projets</a> développe l’idée qu’il est recommandé de converger vers un modèle où environnements d’exécution, de stockage du code et des données sont conceptuellement séparés. Ce haut niveau d’exigence est un gain de temps important lors de la mise en production car au cours de cette dernière, le projet est amené à être exécuté sur une infrastructure informatique dédiée qu’il est bon d’anticiper.</p>
<p>A l’heure actuelle, les données sont stockées dans le dépôt. C’est une mauvaise pratique. En premier lieu, <code>Git</code> n’est techniquement pas bien adapté au stockage de données. Ici ce n’est pas très grave car il ne s’agit pas de données volumineuses et ces dernières ne sont pas modifiées au cours de notre chaine de traitement. La raison principale est que les données traitées par les <em>data scientists</em> sont généralement soumises à des clauses de confidentialités (<a href="https://www.cnil.fr/fr/rgpd-de-quoi-parle-t-on">RGPD</a>, <a href="https://www.insee.fr/fr/information/1300624">secret statistique</a>…). Mettre ces données sous contrôle de version c’est prendre le risque de les divulguer à un public non habilité. Il est donc recommandé de privilégier des outils techniques adaptés au stockage de données.</p>
<p>L’idéal, dans notre cas, est d’utiliser une solution de stockage externe. On va utiliser pour cela <code>MinIO</code>, la solution de stockage de type <code>S3</code> offerte par le SSP Cloud. Cela nous permettra de supprimer les données de <code>Github</code> tout en maintenant la reproductibilité de notre projet <a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 8: utilisation d’un système de stockage distant
</div>
</div>
<div class="callout-body-container callout-body">
<p>A partir de la ligne de commande, utiliser l’utilitaire <a href="https://min.io/docs/minio/linux/reference/minio-mc.html">MinIO</a> pour copier les données <code>data/raw/data.csv</code> vers votre bucket personnel. Les données intermédiaires peuvent être laissées en local mais doivent être ajoutées au <code>.gitignore</code>.</p>
<details>
<summary>
Indice
</summary>
<p>Structure à adopter:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb16" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mc cp data/raw/data.csv s3/<span class="va">$BUCKET_PERSONNEL</span>/ensae-reproductibilite/data/raw/data.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
en modifiant <code>$BUCKET_PERSONNEL</code>, l’emplacement de votre bucket personnel
</details>
<p>Pour se simplifier la vie, on va utiliser des URL de téléchargement des fichiers (comme si ceux-ci étaient sur n’importe quel espace de stockage) plutôt que d’utiliser une librairie <code>S3</code> compatible comme <code>boto3</code> ou <code>s3fs</code>. Par défaut, le contenu de votre <em>bucket</em> est privé, seul vous y avez accès. Néanmoins, vous pouvez rendre accessible à tous en lecture le contenu de votre <em>bucket</em> en faisant lui donnant des droits anonymes. Pour cela, en ligne de commande, faire:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb17" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mc anonymous set download s3/<span class="va">$BUCKET_PERSONNEL</span>/ensae-reproductibilite/data/raw/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>en modifiant <code>$BUCKET_PERSONNEL</code>. Les URL de téléchargement seront de la forme <code>https://minio.lab.sspcloud.fr/$BUCKET_PERSONNEL/ensae-reproductibilite/data/raw/data.csv</code></p>
<ul>
<li>Modifier <code>configuration/config.yaml</code> pour utiliser directement les URL dans l’import ;</li>
<li>Modifier les valeurs par défaut dans votre code ;</li>
<li>Ajouter le dossier <code>data/</code> au <code>.gitignore</code></li>
<li>Supprimer le dossier <code>data</code> de votre projet et faites <code>git rm --cached -r data</code></li>
<li>Vérifier le bon fonctionnement de votre application.</li>
</ul>
<p>Maintenant qu’on a arrangé la structure de notre projet, c’est l’occasion de supprimer le code qui n’est plus nécessaire au bon fonctionnement de notre projet (cela réduit la charge de maintenance<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>).</p>
<p>Pour vous aider, vous pouvez utiliser <a href="https://pypi.org/project/vulture/"><code>vulture</code></a> de manière itérative pour vous assister dans le nettoyage de votre code.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb18" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> vulture main.py src/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<details>
<summary>
Exemple de sortie
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb19" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> vulture main.py src/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb20" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>main.py:<span class="dv">21</span>: unused variable <span class="st">'jeton_api'</span> (<span class="dv">60</span><span class="op">%</span> confidence)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>main.py:<span class="dv">36</span>: unused variable <span class="st">'ticket_count'</span> (<span class="dv">60</span><span class="op">%</span> confidence)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>main.py:<span class="dv">37</span>: unused variable <span class="st">'name_count'</span> (<span class="dv">60</span><span class="op">%</span> confidence)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-23-contents" aria-controls="callout-23" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-23" class="callout-23-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-46" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-46" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-46-1" class="code-annotation-target"><a href="#annotated-cell-46-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-46-2"><a href="#annotated-cell-46-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli8</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-46" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-46" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="partie-2bis-packagisation-de-son-projet-optionnel" class="level1">
<h1>Partie 2bis: packagisation de son projet (optionnel)</h1>
<p>Cette série d’actions n’est pas forcément pertinente pour tous les projets. Elle fait un peu la transition entre la modularité et la portabilité.</p>
<section id="étape-1-proposer-des-tests-unitaires-optionnel" class="level2">
<h2 class="anchored" data-anchor-id="étape-1-proposer-des-tests-unitaires-optionnel">Étape 1 : proposer des tests unitaires (optionnel)</h2>
<p>Notre code comporte un certain nombre de fonctions génériques. On peut vouloir tester leur usage sur des données standardisées, différentes de celles du Titanic.</p>
<p>Même si la notion de tests unitaires prend plus de sens dans un <em>package</em>, nous pouvons proposer dans le projet des exemples d’utilisation de la fonction, ceci peut être pédagogique.</p>
<p>Nous allons utiliser <a href="https://docs.python.org/3/library/unittest.html"><code>unittest</code></a> pour effectuer des tests unitaires. Cette approche nécessite quelques notions de programmation orientée objet ou une bonne discussion avec <code>ChatGPT</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 9: test unitaire <em>(optionnel)</em>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Dans le dossier <code>tests/</code>, créer avec l’aide de <code>ChatGPT</code> ou de <code>Copilot</code> un test pour la fonction <code>split_and_count</code>.</p>
<ul>
<li>Effectuer le test unitaire en ligne de commande avec <code>unittest</code> (<code>python -m unittest tests/test_split.py</code>). Corriger le test unitaire en cas d’erreur.</li>
<li>Si le temps le permet, proposer des variantes ou d’autres tests.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-25-contents" aria-controls="callout-25" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-25" class="callout-25-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-47" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-47" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-47-1" class="code-annotation-target"><a href="#annotated-cell-47-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-47-2"><a href="#annotated-cell-47-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli9</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-47" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-47" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Lorsqu’on effectue des tests unitaires, on cherche généralement à tester le plus de lignes possibles de son code. On parle de <strong>taux de couverture</strong> (<em>coverage rate</em>) pour désigner la statistique mesurant cela.</p>
<p>Cela peut s’effectuer de la manière suivante avec le package <a href="https://coverage.readthedocs.io/en/7.2.2/"><code>coverage</code></a>:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb21" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> coverage run <span class="at">-m</span> unittest tests/test_create_variable_title.py</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> coverage report <span class="at">-m</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb22" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>Name                                  Stmts   Miss  Cover   Missing</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="op">-------------------------------------------------------------------</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>src<span class="op">/</span>features<span class="op">/</span>build_features.py           <span class="dv">34</span>     <span class="dv">21</span>    <span class="dv">38</span><span class="op">%</span>   <span class="dv">35</span><span class="op">-</span><span class="dv">36</span>, <span class="dv">48</span><span class="op">-</span><span class="dv">58</span>, <span class="dv">71</span><span class="op">-</span><span class="dv">74</span>, <span class="dv">85</span><span class="op">-</span><span class="dv">89</span>, <span class="dv">99</span><span class="op">-</span><span class="dv">101</span>, <span class="dv">111</span><span class="op">-</span><span class="dv">113</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>tests<span class="op">/</span>test_create_variable_title.py      <span class="dv">21</span>      <span class="dv">1</span>    <span class="dv">95</span><span class="op">%</span>   <span class="dv">54</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="op">-------------------------------------------------------------------</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>TOTAL                                    <span class="dv">55</span>     <span class="dv">22</span>    <span class="dv">60</span><span class="op">%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Le taux de couverture est souvent mis en avant par les gros projets comme indicateur de leur qualité. Il existe d’ailleurs des badges <code>Github</code> dédiés.</p>
</div>
</div>
</section>
<section id="étape-2-transformer-son-projet-en-package-optionnel" class="level2">
<h2 class="anchored" data-anchor-id="étape-2-transformer-son-projet-en-package-optionnel">Étape 2 : transformer son projet en package (optionnel)</h2>
<p>Notre projet est modulaire, ce qui le rend assez simple à transformer en <em>package</em>, en s’inspirant de la structure du <code>cookiecutter</code> adapté, issu de <a href="https://py-pkgs.org/03-how-to-package-a-python#package-structure">cet ouvrage</a>.</p>
<p>On va créer un <em>package</em> nommé <code>titanicml</code> qui encapsule tout notre code et qui sera appelé par notre script <code>main.py</code>. La structure attendue est la suivante:</p>
<details>
<summary>
Structure visée
</summary>
<pre data-code-line-numbers=""><code>ensae-reproductibilite-application
├── docs                                    ┐ 
│   ├── main.py                             │ 
│   └── notebooks                           │ Package documentation and examples
│       └── titanic.ipynb                   │ 
├── configuration                           ┐ Configuration (pas à partager avec Git)
│   └── config.yaml                         ┘ 
├── README.md                                
├── pyproject.toml                          ┐ 
├── requirements.txt                        │
├── titanicml                               │                
│   ├── __init__.py                         │ Package source code, metadata
│   ├── data                                │ and build instructions 
│   │   ├── import_data.py                  │  
│   │   └── test_create_variable_title.py   │   
│   ├── features                            │
│   │   └── build_features.py               │
│   └── models                              │
│       └── train_evaluate.py               ┘
└── tests                                   ┐
    └── test_create_variable_title.py       ┘ Package tests</code></pre>
</details>
<details>
<summary>
Rappel: structure actuelle
</summary>
<pre data-code-line-numbers=""><code>ensae-reproductibilite-application
├── notebooks                                 
│   └── titanic.ipynb                  
├── configuration                                 
│   └── config.yaml                  
├── main.py                              
├── README.md                 
├── requirements.txt                      
└── src 
    ├── data                                
    │   ├── import_data.py                    
    │   └── test_create_variable_title.py      
    ├── features                           
    │   └── build_features.py      
    └── models                          
        └── train_evaluate.py              </code></pre>
</details>
<p>Il existe plusieurs <em>frameworks</em> pour construire un <em>package</em>. Nous allons privilégier <a href="https://python-poetry.org/"><code>Poetry</code></a> à <a href="https://pypi.org/project/setuptools/"><code>Setuptools</code></a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour créer la structure minimale d’un <em>package</em>, le plus simple est d’utiliser le <code>cookiecutter</code> adapté, issu de <a href="https://py-pkgs.org/03-how-to-package-a-python#package-structure">cet ouvrage</a>.</p>
<p>Comme on a déjà une structure très modulaire, on va plutôt recréer cette structure dans notre projet déjà existant. En fait, il ne manque qu’un fichier essentiel, le principal distinguant un projet classique d’un package : <code>pyproject.toml</code>.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb25" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cookiecutter https://github.com/py-pkgs/py-pkgs-cookiecutter.git</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<details>
<summary>
Dérouler pour voir les choix possibles
</summary>
<div class="sourceCode" id="cb26" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>author_name [Monty Python]: Daffy Duck</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>package_name [mypkg]: titanicml</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>package_short_description []: Impressive Titanic survival analysis</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>package_version [<span class="fl">0.1.0</span>]: </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>python_version [<span class="fl">3.9</span>]: </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>Select open_source_license:</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="op">-</span> MIT</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="op">-</span> Apache License <span class="fl">2.0</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="op">-</span> GNU General Public License v3<span class="fl">.0</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="op">-</span> Creative Commons Attribution <span class="fl">4.0</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span> <span class="op">-</span> BSD <span class="dv">3</span><span class="op">-</span>Clause</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span> <span class="op">-</span> Proprietary</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="dv">7</span> <span class="op">-</span> <span class="va">None</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>Choose <span class="im">from</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span> [<span class="dv">1</span>]: </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>Select include_github_actions:</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="op">-</span> no</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="op">-</span> ci</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="op">-</span> ci<span class="op">+</span>cd</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>Choose <span class="im">from</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> [<span class="dv">1</span>]:</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 10: packagisation <em>(optionnel)</em>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Renommer le dossier <code>titanicml</code> pour respecter la nouvelle arborescence ;</li>
<li>Créer un fichier <code>pyproject.toml</code> sur cette base ;</li>
</ul>
<div id="2e0c9a1a" class="cell" data-execution_count="4">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>pyproject.toml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb27" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>[tool.poetry]</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"titanicml"</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>version <span class="op">=</span> <span class="st">"0.0.1"</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>description <span class="op">=</span> <span class="st">"Awesome Machine Learning project"</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>authors <span class="op">=</span> [<span class="st">"Daffy Duck &lt;daffy.duck@fauxmail.fr&gt;"</span>, <span class="st">"Mickey Mouse"</span>]</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>license <span class="op">=</span> <span class="st">"MIT"</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>readme <span class="op">=</span> <span class="st">"README.md"</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>[build<span class="op">-</span>system]</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>requires <span class="op">=</span> [<span class="st">"poetry-core"</span>]</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>build<span class="op">-</span>backend <span class="op">=</span> <span class="st">"poetry.core.masonry.api"</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>[tool.pytest.ini_options]</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>log_cli <span class="op">=</span> true</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>log_cli_level <span class="op">=</span> <span class="st">"WARNING"</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>log_cli_format <span class="op">=</span> <span class="st">"</span><span class="sc">%(asctime)s</span><span class="st"> [</span><span class="sc">%(levelname)8s</span><span class="st">] </span><span class="sc">%(message)s</span><span class="st"> (</span><span class="sc">%(filename)s</span><span class="st">:</span><span class="sc">%(lineno)s</span><span class="st">)"</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>log_cli_date_format <span class="op">=</span> <span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ul>
<li>Créer le dossier <code>docs</code> et mettre les fichiers indiqués dedans</li>
<li>Dans <code>titanicml/</code>, créer un fichier <code>__init__.py</code><a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a></li>
</ul>
<div id="53b5042f" class="cell" data-execution_count="5">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>__init__.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb28" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .import_data <span class="im">import</span> (</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    import_data, import_yaml_config</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .build_features <span class="im">import</span> (</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    create_variable_title,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    fill_na_titanic,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    label_encoder_titanic,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    check_has_cabin,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    ticket_length</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .train_evaluate <span class="im">import</span> random_forest_titanic</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>__all__ <span class="op">=</span> [</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"import_data"</span>, <span class="st">"import_yaml_config"</span>,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"create_variable_title"</span>,</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fill_na_titanic"</span>,</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"label_encoder_titanic"</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"check_has_cabin"</span>,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ticket_length"</span>,</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_forest_titanic"</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ul>
<li>Installer le package en local avec <code>pip install -e .</code></li>
<li>Modifier le contenu de <code>docs/main.py</code> pour importer les fonctions de notre <em>package</em> <code>titanicml</code> et tester en ligne de commande notre fichier <code>main.py</code></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-29-contents" aria-controls="callout-29" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-29" class="callout-29-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-58" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-58" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-58-1" class="code-annotation-target"><a href="#annotated-cell-58-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-58-2"><a href="#annotated-cell-58-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli10</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-58" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-58" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="partie3" class="level1">
<h1>Partie 3 : construction d’un projet portable et reproductible</h1>
<p>Dans la partie précédente, on a appliqué de manière incrémentale de nombreuses bonnes pratiques vues dans les chapitres <a href="../chapters/code-quality.html">Qualité du code</a> et <a href="../chapters/projects-architecture.html">Structure des projets</a> tout au long du cours.</p>
<p>Ce faisant, on s’est déjà considérablement rapprochés d’une possible mise en production : le code est lisible, la structure du projet est normalisée et évolutive, et le code est proprement versionné sur un dépôt <code>GitHub</code> <i class="fa-brands fa-github" aria-label="github"></i>.</p>
<details>
<summary>
Illustration de l’état actuel du projet
</summary>
<img src="../schema_post_appli8.png" class="img-fluid">
</details>
<p>A présent, nous avons une version du projet qui est largement partageable. Du moins en théorie, car la pratique est souvent plus compliquée : il y a fort à parier que si vous essayez d’exécuter votre projet sur un autre environnement (typiquement, votre ordinateur personnel), les choses ne se passent pas du tout comme attendu. Cela signifie qu’<strong>en l’état, le projet n’est pas portable : il n’est pas possible, sans modifications coûteuses, de l’exécuter dans un environnement différent de celui dans lequel il a été développé</strong>.</p>
<p>Dans cette troisème partie de notre travail vers la mise en production, nous allons voir comment <strong>normaliser l’environnement d’exécution afin de produire un projet portable</strong>. Autrement dit, nous n’allons plus nous contenter de modularité mais allons rechercher la portabilité. On sera alors tout proche de pouvoir mettre le projet en production.</p>
<p>On progressera dans l’échelle de la reproductibilité de la manière suivante:</p>
<ol type="1">
<li><a href="#anaconda"><strong>Environnements virtuels</strong></a> ;</li>
<li>Créer un <a href="#shell">script shell</a> qui permet, depuis un environnement minimal, de construire l’application de A à Z ;</li>
<li><a href="#docker"><strong>Images et conteneurs <code>Docker</code></strong></a>.</li>
</ol>
<p>Nous allons repartir de l’application 8, c’est-à-dire d’un projet modulaire mais qui n’est pas, à strictement parler, un <em>package</em> (objet des applications optionnelles suivantes 9 et 10).</p>
<p>Pour se replacer dans l’état du projet à ce niveau, il est possible d’utiliser le <em>tag</em> <em>ad hoc</em>.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb29" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli8</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="anaconda" class="level2">
<h2 class="anchored" data-anchor-id="anaconda">Étape 1 : un environnement pour rendre le projet portable</h2>
<p>Pour qu’un projet soit portable, il doit remplir deux conditions:</p>
<ul>
<li>Ne pas nécessiter de dépendance qui ne soient pas renseignées quelque part ;</li>
<li>Ne pas proposer des dépendances inutiles, qui ne sont pas utilisées dans le cadre du projet.</li>
</ul>
<p>Le prochain exercice vise à mettre ceci en oeuvre. Comme expliqué dans le <a href="../chapters/portability.html">chapitre portabilité</a>, le choix du gestionnaire d’environnement est laissé libre. Il est recommandé de privilégier <code>venv</code> si vous découvrez la problématique de la portabilité.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Environnement virtuel <code>venv</code></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Environnement <code>conda</code></a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>L’approche la plus légère est l’environnement virtuel. Nous avons en fait implicitement déjà commencé à aller vers cette direction en créant un fichier <code>requirements.txt</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 11a: environnement virtuel <code>venv</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Exécuter <code>pip freeze</code> en ligne de commande et observer la (très) longue liste de package</li>
<li>Créer l’environnement virtuel <code>titanic</code> en s’inspirant de <a href="https://packaging.python.org/en/latest/guides/installing-using-pip-and-virtual-environments/">la documentation officielle</a><a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> ou du <a href="../chapters/portability.html">chapitre dédié</a></li>
<li>Utiliser <code>ls</code> pour observer et comprendre le contenu du dossier <code>titanic/bin</code> installé</li>
<li>Activer l’environnement et vérifier l’installation de <code>Python</code> maintenant utilisée par votre machine <!---source titanic/bin/activate && which python----></li>
<li>Vérifier directement depuis la ligne de commande que <code>Python</code> exécute bien une commande<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a> avec:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb30" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python <span class="at">-c</span> <span class="st">"print('Hello')"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="6" type="1">
<li>Faire la même chose mais avec <code>import pandas as pd</code></li>
<li>Installer les <em>packages</em> à partir du <code>requirements.txt</code>. Tester à nouveau <code>import pandas as pd</code> pour comprendre la différence.</li>
<li>Exécuter <code>pip freeze</code> et comprendre la différence avec la situation précédente.</li>
<li>Vérifier que le script <code>main.py</code> fonctionne bien. Sinon ajouter les <em>packages</em> manquants dans le <code>requirements.txt</code> et reprendre de manière itérative à partir de la question 7.</li>
<li>Ajouter le dossier <code>titanic/</code> au <code>.gitignore</code> pour ne pas ajouter ce dossier à <code>Git</code>.</li>
</ol>
<details>
<summary>
Aide pour la question 4
</summary>
<p>Après l’activation, vous pouvez vérifier quel <code>python</code> est utilisé de cette manière</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb31" data-filename="terminal" data-env="titanic" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">titanic</span><span class="kw">)</span> <span class="ex">$</span> which python</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-31-contents" aria-controls="callout-31" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-31" class="callout-31-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-64" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-64" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-64-1" class="code-annotation-target"><a href="#annotated-cell-64-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-64-2"><a href="#annotated-cell-64-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli11a</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-64" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-64" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>Les environnements <code>conda</code> sont plus lourds à mettre en oeuvre que les environnements virtuels mais peuvent permettre un contrôle plus formel des dépendances.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 11b: environnement <code>conda</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Exécuter <code>conda env export</code> en ligne de commande et observer la (très) longue liste de package</li>
<li>Créer un environnement <code>titanic</code> avec <a href="https://conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html#creating-an-environment-with-commands"><code>conda create</code></a></li>
<li>Activer l’environnement et vérifier l’installation de <code>Python</code> maintenant utilisée par votre machine <!---conda activate titanic && which python----></li>
<li>Vérifier directement depuis la ligne de commande que <code>Python</code> exécute bien une commande<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a> avec:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb32" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python <span class="at">-c</span> <span class="st">"print('Hello')"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="6" type="1">
<li>Faire la même chose mais avec <code>import pandas as pd</code></li>
<li>Installer les <em>packages</em> qu’on avait listé dans le <code>requirements.txt</code> précédemment. Ne pas faire un <code>pip install -r requirements.txt</code> afin de privilégier <code>conda install</code></li>
<li>Exécuter à nouveau <code>conda env export</code> et comprendre la différence avec la situation précédente<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a>.</li>
<li>Vérifier que le script <code>main.py</code> fonctionne bien. Sinon installer les <em>packages</em> manquants et reprndre de manière itérative à partir de la question 7.</li>
<li>Quand <code>main.py</code> fonctionne, faire <code>conda env export &gt; environment.yml</code> pour figer l’environnement de travail.</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-33-contents" aria-controls="callout-33" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-33" class="callout-33-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-67" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-67" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-67-1" class="code-annotation-target"><a href="#annotated-cell-67-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-67-2"><a href="#annotated-cell-67-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli11b</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-67" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-67" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="shell" class="level2">
<h2 class="anchored" data-anchor-id="shell">Étape 2: construire l’environnement de notre application via un script <code>shell</code></h2>
<p>Les environnements virtuels permettent de mieux spécifier les dépendances de notre projet, mais ne permettent pas de garantir une portabilité optimale. Pour cela, il faut recourir à la technologie des conteneurs. L’idée est de construire une machine, en partant d’une base quasi-vierge, qui permette de construire étape par étape l’environnement nécessaire au bon fonctionnement de notre projet. C’est le principe des conteneurs <code>Docker</code> <i class="fa-brands fa-docker" aria-label="docker"></i>.</p>
<p>Leur méthode de construction étant un peu difficile à prendre en main au début, nous allons passer par une étape intermédiaire afin de bien comprendre le processus de production.</p>
<ul>
<li>Nous allons d’abord créer un script <code>shell</code>, c’est à dire une suite de commandes <code>Linux</code> permettant de construire l’environnement à partir d’une machine vierge ;</li>
<li>Nous transformerons celui-ci en <code>Dockerfile</code> dans un deuxième temps. C’est l’objet de l’étape suivante.</li>
</ul>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Environnement virtuel <code>venv</code></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Environnement <code>conda</code></a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 12a : créer un fichier d’installation de A à Z
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Créer un service <code>ubuntu</code> sur le SSP Cloud</li>
<li>Ouvrir un terminal</li>
<li>Cloner le dépôt</li>
<li>Se placer dans le dossier du projet avec <code>cd</code></li>
<li>Se placer au niveau du checkpoint 11a avec <code>git checkout appli11a</code></li>
<li>Via l’explorateur de fichiers, créer le fichier <code>install.sh</code> à la racine du projet avec le contenu suivant:</li>
</ol>
<details>
<summary>
Script à créer sous le nom <code>install.sh</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>install.sh</strong></pre>
</div>
<div class="sourceCode" id="cb33" data-filename="terminal" data-no-prefix="true" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Install Python</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="ex">apt-get</span> <span class="at">-y</span> update</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="ex">apt-get</span> install <span class="at">-y</span> python3-pip python3-venv</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create empty virtual environment</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> venv titanic</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> titanic/bin/activate</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Install project dependencies</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ol start="6" type="1">
<li>Changer les permissions sur le script pour le rendre exécutable</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb34" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> chmod +x install.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="7" type="1">
<li>Exécuter le script depuis la ligne de commande avec des droits de super-utilisateur (nécessaires pour installer des <em>packages</em> via <code>apt</code>)</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb35" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo ./install.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="8" type="1">
<li>Vérifier que le script <code>main.py</code> fonctionne correctement dans l’environnement virtuel créé</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb36" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> source titanic/bin/activate</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 main.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-35-contents" aria-controls="callout-35" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-35" class="callout-35-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-76" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-76" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-76-1" class="code-annotation-target"><a href="#annotated-cell-76-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-76-2"><a href="#annotated-cell-76-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli12a</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-76" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-76" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 12b : créer un fichier d’installation de A à Z
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Créer un service <code>ubuntu</code> sur le SSP Cloud</li>
<li>Ouvrir un terminal</li>
<li>Cloner le dépôt</li>
<li>Se placer dans le dossier du projet avec <code>cd</code></li>
<li>Se placer au niveau du checkpoint 11b avec <code>git checkout appli11b</code></li>
<li>Via l’explorateur de fichiers, créer le fichier <code>install.sh</code> à la racine du projet avec le contenu suivant:</li>
</ol>
<details>
<summary>
Script à créer sous le nom <code>install.sh</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>install.sh</strong></pre>
</div>
<div class="sourceCode" id="cb37" data-filename="terminal" data-no-prefix="true" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apt-get</span> <span class="at">-y</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> <span class="at">-y</span> install wget</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bash</span> Miniconda3-latest-Linux-x86_64.sh <span class="at">-b</span> <span class="at">-p</span> /miniconda <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span> <span class="at">-f</span> Miniconda3-latest-Linux-x86_64.sh</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="va">PATH</span><span class="op">=</span><span class="st">"/miniconda/bin:</span><span class="va">${PATH}</span><span class="st">"</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create environment</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">-n</span> titanic pandas PyYAML scikit-learn <span class="at">-c</span> conda-forge</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate titanic</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="va">PATH</span><span class="op">=</span><span class="st">"/miniconda/envs/titanic/bin:</span><span class="va">${PATH}</span><span class="st">"</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> main.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ol start="6" type="1">
<li>Changer les permissions sur le script pour le rendre exécutable</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb38" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> chmod +x install.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="7" type="1">
<li>Exécuter le script depuis la ligne de commande avec des droits de super-utilisateur (nécessaires pour installer des <em>packages</em> via <code>apt</code>)</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb39" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo ./install.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="8" type="1">
<li>Vérifier que le script <code>main.py</code> fonctionne correctement dans l’environnement virtuel créé</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb40" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> conda activate titanic</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 main.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-37-contents" aria-controls="callout-37" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-37" class="callout-37-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-85" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-85" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-85-1" class="code-annotation-target"><a href="#annotated-cell-85-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-85-2"><a href="#annotated-cell-85-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli12b</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-85" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-85" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="docker" class="level2">
<h2 class="anchored" data-anchor-id="docker">Étape 3: conteneuriser l’application avec <code>Docker</code></h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Cette application nécessite l’accès à une version interactive de <code>Docker</code>. Il n’y a pas beaucoup d’instances en ligne disponibles.</p>
<p>Nous proposons deux solutions:</p>
<ul>
<li><a href="https://docs.docker.com/get-docker/">Installer <code>Docker</code></a> sur sa machine ;</li>
<li>Se rendre sur l’environnement bac à sable <em><a href="https://labs.play-with-docker.com">Play with Docker</a></em></li>
</ul>
<p>Sinon, elle peut être réalisée en essai-erreur par le biais des services d’intégration continue de <code>Github</code> <i class="fa-brands fa-github" aria-label="github"></i> ou <code>Gitlab</code> <i class="fa-brands fa-gitlab" aria-label="gitlab"></i>. Néanmoins, nous présenterons l’utilisation de ces services plus tard, dans la prochaine partie.</p>
</div>
</div>
<p>Maintenant qu’on sait que ce script préparatoire fonctionne, on va le transformer en <code>Dockerfile</code> pour anticiper la mise en production. Comme la syntaxe <code>Docker</code> est légèrement différente de la syntaxe <code>Linux</code> classique (voir le <a href="../chapters/portability.html">chapitre portabilité</a>), il va être nécessaire de changer quelques instructions mais ceci sera très léger.</p>
<p>On va tester le <code>Dockerfile</code> dans un environnement bac à sable pour ensuite pouvoir plus facilement automatiser la construction de l’image <code>Docker</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 13: création de l’image <code>Docker</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Se placer dans un environnement avec <code>Docker</code>, par exemple <em><a href="https://labs.play-with-docker.com">Play with Docker</a></em></p>
<section id="création-du-dockerfile" class="level4">
<h4 class="anchored" data-anchor-id="création-du-dockerfile">Création du <code>Dockerfile</code></h4>
<ul>
<li>Dans le terminal <code>Linux</code>, cloner votre dépôt <code>Github</code></li>
<li>Repartir de la dernière version à disposition. Par exemple, si vous avez privilégié l’environnement virtuel <code>venv</code>, ce sera:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-86" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-86" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-86-1" class="code-annotation-target"><a href="#annotated-cell-86-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-86-2"><a href="#annotated-cell-86-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli12a</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-86" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-86" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<ul>
<li>Créer via la ligne de commande un fichier texte vierge nommé <code>Dockerfile</code> (la majuscule au début du mot est importante)</li>
</ul>
<details>
<summary>
Commande pour créer un <code>Dockerfile</code> vierge depuis la ligne de commande
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb41" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> touch Dockerfile</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ul>
<li>Ouvrir ce fichier via un éditeur de texte et copier le contenu suivant dedans:</li>
</ul>
<details>
<summary>
Premier <code>Dockerfile</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb42" data-filename="terminal" data-no-prefix="true" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="ex">FROM</span> ubuntu:22.04</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WORKDIR</span> <span class="va">${HOME}</span>/titanic</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Install Python</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="ex">RUN</span> apt-get <span class="at">-y</span> update <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">apt-get</span> install <span class="at">-y</span> python3-pip</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Install project dependencies</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="ex">COPY</span> requirements.txt .</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="ex">RUN</span> pip install <span class="at">-r</span> requirements.txt</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="ex">CMD</span> [<span class="st">"python3"</span>, <span class="st">"main.py"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
</section>
<section id="construire-build-limage" class="level4">
<h4 class="anchored" data-anchor-id="construire-build-limage">Construire (<em>build</em>) l’image</h4>
<ul>
<li>Utiliser <code>docker build</code> pour créer une image avec le tag <code>my-python-app</code></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb43" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker build . <span class="at">-t</span> my-python-app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Vérifier les images dont vous disposez. Vous devriez avoir un résultat proche de celui-ci :</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb44" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker images</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb45" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>REPOSITORY      TAG       IMAGE ID       CREATED              SIZE</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>my<span class="op">-</span>python<span class="op">-</span>app   latest    <span class="fl">188957e16594</span>   About a minute ago   <span class="dv">879</span><span class="er">MB</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="tester-limage-découverte-du-cache" class="level4">
<h4 class="anchored" data-anchor-id="tester-limage-découverte-du-cache">Tester l’image: découverte du cache</h4>
<p>L’étape de <code>build</code> a fonctionné: une image a été construite.</p>
<p>Mais fait-elle effectivement ce que l’on attend d’elle ?</p>
<p>Pour le savoir, il faut passer à l’étape suivante, l’étape de <code>run</code>.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb46" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker run <span class="at">-it</span> my-python-app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb47" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>python3: can<span class="st">'t open file '</span><span class="op">/~/</span>titanic<span class="op">/</span>main.py<span class="st">': [Errno 2] No such file or directory</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Le message d’erreur est clair : <code>Docker</code> ne sait pas où trouver le fichier <code>main.py</code>. D’ailleurs, il ne connait pas non plus les autres fichiers de notre application qui sont nécessaires pour faire tourner le code, par exemple le dossier <code>src</code>.</p>
<ul>
<li>Avant l’étape <code>CMD</code>, copier les fichiers nécessaires sur l’image afin que l’application dispose de tous les éléments nécessaires pour être en mesure de fonctionner.</li>
</ul>
<details>
<summary>
Nouveau <code>Dockerfile</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb48" data-filename="terminal" data-no-prefix="true" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="ex">FROM</span> ubuntu:22.04</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WORKDIR</span> <span class="va">${HOME}</span>/titanic</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Install Python</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="ex">RUN</span> apt-get <span class="at">-y</span> update <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">apt-get</span> install <span class="at">-y</span> python3-pip</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Install project dependencies</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="ex">COPY</span> requirements.txt .</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="ex">RUN</span> pip install <span class="at">-r</span> requirements.txt</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="ex">COPY</span> main.py .</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="ex">COPY</span> src ./src</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="ex">CMD</span> [<span class="st">"python3"</span>, <span class="st">"main.py"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ul>
<li><p>Refaire tourner l’étape de <code>build</code></p></li>
<li><p>Refaire tourner l’étape de <code>run</code>. A ce stade, la matrice de confusion doit fonctionner 🎉. Vous avez créé votre première application reproductible !</p></li>
</ul>
</section>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ici, le <em>cache</em> permet d’économiser beaucoup de temps. Par besoin de refaire tourner toutes les étapes, <code>Docker</code> agit de manière intelligente en faisant tourner uniquement les étapes qui ont changé.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-41-contents" aria-controls="callout-41" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-41" class="callout-41-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-101" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-101" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-101-1" class="code-annotation-target"><a href="#annotated-cell-101-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-101-2"><a href="#annotated-cell-101-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli13</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-101" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-101" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="partie-4-automatisation-avec-lintégration-continue" class="level1">
<h1>Partie 4 : automatisation avec l’intégration continue</h1>
<p>Imaginez que vous êtes au restaurant et qu’on ne vous serve pas le plat mais seulement la recette et que, de plus, on vous demande de préparer le plat chez vous avec les ingrédients dans votre frigo. Vous seriez quelque peu déçu. En revanche, si vous avez goûté au plat, que vous êtes un réel cordon bleu et qu’on vous donne la recette pour refaire ce plat ultérieurement, peut-être que vous appréciriez plus.</p>
<p>Cette analogie illustre l’enjeu de définir le public cible et ses attentes afin de fournir un livrable adapté. Une image <code>Docker</code> est un livrable qui n’est pas forcément intéressant pour tous les publics. Certains préféreront avoir un plat bien préparé qu’une recette ; certains apprécieront avoir une image <code>Docker</code> mais d’autres ne seront pas en mesure de construire celle-ci ou ne sauront pas la faire fonctionner. Une image <code>Docker</code> est plus souvent un moyen pour faciliter la mise en service d’une production qu’une fin en soi.</p>
<p>Nous allons donc proposer plusieurs types de livrables plus classiques par la suite. Ceux-ci correspondront mieux aux attendus des publics utilisateurs de services construits à partir de techniques de <em>data science</em>. <code>Docker</code> est néanmoins un passage obligé car l’ensemble des types de livrables que nous allons explorer reposent sur la standardisation permise par les conteneurs.</p>
<p>Cette approche nous permettra de quitter le domaine de l’artisanat pour s’approcher d’une industrialisation de la mise à disposition de notre projet. Ceci va notamment nous amener à mettre en oeuvre l’approche pragmatique du <code>DevOps</code> qui consiste à intégrer dès la phase de développement d’un projet les contraintes liées à sa mise à disposition au public cible (cette approche est détaillée plus amplement dans le chapitre sur la <a href="../chapters/deployment.html">mise en production</a>).</p>
<p>L’automatisation et la mise à disposition automatisée de nos productions sera faite progressivement, au cours des prochaines parties. Tous les projets n’ont pas vocation à aller aussi loin dans ce domaine. L’opportunité doit être comparée aux coûts humains et financiers de leur mise en oeuvre et de leur cycle de vie. Avant de faire une production en série de nos modèles, nous allons déjà commencer par automatiser quelques tests de conformité de notre code. On va ici utiliser l’intégration continue pour deux objectifs distincts:</p>
<ul>
<li>la mise à disposition de l’image <code>Docker</code> ;</li>
<li>la mise en place de tests automatisés de la qualité du code sur le modèle de notre <code>linter</code> précédent.</li>
</ul>
<p>Nous allons utiliser <code>Github Actions</code> pour cela. Il s’agit de serveurs standardisés mis à disposition gratuitement par <code>Github</code> <i class="fa-brands fa-github" aria-label="github"></i>. <code>Gitlab</code> <i class="fa-brands fa-gitlab" aria-label="gitlab"></i>, l’autre principal acteur du domaine, propose des services similaires. L’implémentation est légèrement différente mais les principes sont identiques.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-42-contents" aria-controls="callout-42" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Si vous prenez ce projet fil rouge en cours de route
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-42" class="callout-42-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb49" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli13</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<section id="étape-1-mise-en-place-de-tests-automatisés" class="level2">
<h2 class="anchored" data-anchor-id="étape-1-mise-en-place-de-tests-automatisés">Étape 1: mise en place de tests automatisés</h2>
<p>Avant d’essayer de mettre en oeuvre la création de notre image <code>Docker</code> de manière automatisée, nous allons présenter la logique de l’intégration continue en testant de manière automatisée notre script <code>main.py</code>.</p>
<p>Pour cela, nous allons partir de la structure proposée dans l’<a href="https://github.com/actions/setup-python">action officielle</a>. La documentation associée est <a href="https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python">ici</a>. Des éléments succincts de présentation de la logique déclarative des actions <code>Github</code> sont disponibles dans le chapitre sur la <a href="../chapters/deployment.html">mise en production</a>. Néanmoins, la meilleure école pour comprendre le fonctionnement de celles-ci est de parcourir la documentation du service et d’observer les actions <code>Github</code> mises en oeuvre par vos projets favoris, celles-ci seront fort instructives !</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 14: premier script d’intégration continue
</div>
</div>
<div class="callout-body-container callout-body">
<p>A partir de l’exemple présent dans la <a href="https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python#using-a-specific-python-version">documentation officielle</a> de <code>Github</code> <i class="fa-brands fa-github" aria-label="github"></i>, on a déjà une base de départ qui peut être modifiée. Les questions suivantes permettront d’automatiser les tests et le diagnostic qualité de notre code<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a></p>
<ol type="1">
<li>Créer un fichier <code>.github/workflows/test.yaml</code> avec le contenu de l’exemple de la documentation</li>
<li>Avec l’aide de la documentation, introduire une étape d’installation des dépendances. Utiliser le fichier <code>requirements.txt</code> pour installer les dépendances.</li>
<li>Utiliser <code>pylint</code> pour vérifier la qualité du code. Ajouter l’argument <code>--fail-under=6</code> pour renvoyer une erreur en cas de note trop basse<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a></li>
<li>Utiliser une étape appelant notre application en ligne de commande (<code>python main.py</code>) pour tester que la matrice de confusion s’affiche bien.</li>
<li>Aller voir votre test automatisé dans l’onglet <code>Actions</code> de votre dépôt sur <code>Github</code></li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-44-contents" aria-controls="callout-44" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-44" class="callout-44-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-104" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-104" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-104-1" class="code-annotation-target"><a href="#annotated-cell-104-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-104-2"><a href="#annotated-cell-104-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli14</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-104" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-104" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>Maintenant, nous pouvons observer que l’onglet <code>Actions</code> s’est enrichi. Chaque <code>commit</code> va entraîner une série d’actions automatisées.</p>
<p>Si l’une des étapes échoue, ou si la note de notre projet est mauvaise, nous aurons une croix rouge (et nous recevrons un mail). On pourra ainsi détecter, en développant son projet, les moments où on dégrade la qualité du script afin de la rétablir immédiatemment.</p>
</section>
<section id="étape-2-automatisation-de-la-livraison-de-limage-docker" class="level2">
<h2 class="anchored" data-anchor-id="étape-2-automatisation-de-la-livraison-de-limage-docker">Étape 2: Automatisation de la livraison de l’image <code>Docker</code></h2>
<p>Maintenant, nous allons automatiser la mise à disposition de notre image sur <code>DockerHub</code> (le lieu de partage des images <code>Docker</code>). Cela facilitera sa réutilisation mais aussi des valorisations ultérieures.</p>
<p>Là encore, nous allons utiliser une série d’actions pré-configurées.</p>
<p>Pour que <code>Github</code> puisse s’authentifier auprès de <code>DockerHub</code>, il va falloir d’abord interfacer les deux plateformes. Pour cela, nous allons utiliser un jeton (<em>token</em>) <code>DockerHub</code> que nous allons mettre dans un espace sécurisé associé à votre dépôt <code>Github</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 15a: configuration
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Se rendre sur <a href="https://hub.docker.com/">https://hub.docker.com/</a> et créer un compte. Il est recommandé d’associer ce compte à votre compte <code>Github</code>.</li>
<li>Créer un dépôt public <code>application-correction</code></li>
<li>Aller dans les <a href="https://hub.docker.com/settings/general">paramètres de votre compte</a> et cliquer, à gauche, sur <code>Security</code></li>
<li>Créer un jeton personnel d’accès, ne fermez pas l’onglet en question, vous ne pouvez voir sa valeur qu’une fois.</li>
<li>Dans le dépôt <code>Github</code> de votre projet, cliquer sur l’onglet <code>Settings</code> et cliquer, à gauche, sur <code>Secrets and variables</code> puis dans le menu déroulant en dessous sur <code>Actions</code>. Sur la page qui s’affiche, aller dans la section <code>Repository secrets</code></li>
<li>Créer un jeton <code>DOCKERHUB_TOKEN</code> à partir du jeton que vous aviez créé sur <code>Dockerhub</code>. Valider</li>
<li>Créer un deuxième secret nommé <code>DOCKERHUB_USERNAME</code> ayant comme valeur le nom d’utilisateur que vous avez créé sur <code>Dockerhub</code></li>
</ul>
<details>
<summary>
Etape optionnelle supplémentaire si on met en production un site web
</summary>
<ul>
<li>Dans le dépôt <code>Github</code> de votre projet, cliquer sur l’onglet <code>Settings</code> et cliquer, à gauche, sur <code>Actions</code>. Donner les droits d’écriture à vos actions sur le dépôt du projet (ce sera nécessaire pour <code>Github Pages</code>)</li>
</ul>
<p><img src="../permissions.png" class="img-fluid"></p>
</details>
</div>
</div>
<p>A ce stade, nous avons donné les moyens à <code>Github</code> de s’authentifier avec notre identité sur <code>Dockerhub</code>. Il nous reste à mettre en oeuvre l’action en s’inspirant de la <a href="https://github.com/docker/build-push-action/#usage">documentation officielle</a>. On ne va modifier que trois éléments dans ce fichier. Effectuer les actions suivantes:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 15b: automatisation de l’image <code>Docker</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>En s’inspirant de ce <a href="https://github.com/marketplace/actions/build-and-push-docker-images"><em>template</em></a>, créer le fichier <code>.github/workflows/prod.yml</code> qui va <em>build</em> et <em>push</em> l’image sur le <code>DockerHub</code>. Il va être nécessaire de changer légèrement ce modèle :
<ul>
<li>Retirer la condition restrictive sur les <em>commits</em> pour lesquels sont lancés cette automatisation. Pour cela, remplacer le contenu de <code>on</code> de sorte à avoir <code>on: push:   branches:     - main     - dev</code></li>
<li>Changer le tag à la fin pour mettre <code>username/application-correction:latest</code> où <code>username</code> est le nom d’utilisateur sur <code>DockerHub</code>;</li>
<li>Optionnel: changer le nom de l’action</li>
</ul></li>
<li>Faire un <code>commit</code> et un <code>push</code> de ces fichiers</li>
</ul>
<p>Comme on est fier de notre travail, on va afficher ça avec un badge sur le <code>README</code> <em>(partie optionnelle)</em>.</p>
<ul>
<li>Se rendre dans l’onglet <code>Actions</code> et cliquer sur une des actions listées.</li>
<li>En haut à droite, cliquer sur <code>...</code></li>
<li>Sélectionner <code>Create status badge</code></li>
<li>Récupérer le code <code>Markdown</code> proposé</li>
<li>Copier dans votre <code>README.md</code> le code <em>markdown</em> proposé</li>
</ul>
<details>
<summary>
Créer le badge
</summary>
<img src="../create-badge.png" class="img-fluid">
</details>
</div>
</div>
<p>Maintenant, il nous reste à tester notre application dans l’espace bac à sable ou en local, si <code>Docker</code> est installé.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 15b (partie optionnelle): Tester l’application
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Se rendre sur l’environnement bac à sable <em><a href="https://labs.play-with-docker.com">Play with Docker</a></em> ou dans votre environnement <code>Docker</code> de prédilection.</li>
<li>Récupérer et lancer l’image :</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb50" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker run <span class="at">-it</span> username/application-correction:latest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>🎉 La matrice de confusion doit s’afficher ! Vous avez grandement facilité la réutilisation de votre image.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-48-contents" aria-controls="callout-48" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-48" class="callout-48-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-107" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-107" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-107-1" class="code-annotation-target"><a href="#annotated-cell-107-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-107-2"><a href="#annotated-cell-107-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli15</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-107" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-107" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="partie-5-expérimenter-en-local-des-valorisations-puis-automatiser-leur-production" class="level1">
<h1>Partie 5: expérimenter en local des valorisations puis automatiser leur production</h1>
<p>Nous avons automatisé les étapes intermédiaires de notre projet. Néanmoins nous n’avons pas encore réfléchi à la valorisation à mettre en oeuvre pour notre projet. On va supposer que notre projet s’adresse à des <em>data scientists</em> mais aussi à une audience moins technique. Pour ces premiers, nous pourrions nous contenter de valorisations techniques, comme des API, mais pour ces derniers il est conseillé de privilégier des formats plus <em>user friendly</em>.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-49-contents" aria-controls="callout-49" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Si vous prenez ce projet fil rouge en cours de route
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-49" class="callout-49-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb51" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli15</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>Afin de faire le parallèle avec les parcours possibles pour l’évaluation, nous allons proposer trois valorisations<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a>:</p>
<ul>
<li>Une <a href="https://titanic.kub.sspcloud.fr/docs">API</a> facilitant la réutilisation du modèle en “production” ;</li>
<li>Un <a href="https://ensae-reproductibilite.github.io/application-correction/">site web statique</a> exploitant cette API pour exposer les prédictions à une audience moins technique.</li>
</ul>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-50-contents" aria-controls="callout-50" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Site statique vs application réactive
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-50" class="callout-50-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>La solution que nous allons proposer pour les sites statiques, <code>Quarto</code> associé à <code>Github Pages</code>, peut être utilisée dans le cadre des parcours <em>“rapport reproductible”</em> ou <em>“dashboard / application interactive”</em>.</p>
<p>Pour ce dernier parcours, d’autres approches techniques sont néanmoins possibles, comme <code>Streamlit</code>. Celles-ci sont plus exigeantes sur le plan technique puisqu’elles nécessitent de mettre en production sur des serveurs conteuneurisés (comme la mise en production de l’API) là où le site statique ne nécessite qu’un serveur web, mis à disposition gratuitement par <code>Github</code>.</p>
<p>La distinction principale entre ces deux approches est qu’elles s’appuient sur des serveurs différents. Un site statique repose sur un serveur web là où <code>Streamlit</code> s’appuie sur serveur classique en <em>backend</em>. La différence principale entre ces deux types de serveurs réside principalement dans leur fonction et leur utilisation:</p>
<ul>
<li>Un <strong>serveur web</strong> est spécifiquement conçu pour stocker, traiter et livrer des pages web aux clients. Cela inclut des fichiers HTML, CSS, JavaScript, images, etc. Les serveurs web écoutent les requêtes HTTP/HTTPS provenant des navigateurs des utilisateurs et y répondent en envoyant les données demandées.</li>
<li>Un <strong>serveur <em>backend</em></strong> classique est conçu pour effectuer des opérations en réponse à un <em>front</em>, en l’occurrence une page web. Dans le contexte d’une application <code>Streamlit</code>, il s’agit d’un serveur avec l’environnement <code>Python</code> <em>ad hoc</em> pour exécuter le code nécessaire à répondre à toute action d’un utilisateur de l’appliacation.</li>
</ul>
</div>
</div>
</div>
<section id="étape-1-développer-une-api-en-local" class="level2">
<h2 class="anchored" data-anchor-id="étape-1-développer-une-api-en-local">Étape 1: développer une API en local</h2>
<p>Le premier livrable devenu classique dans un projet impliquant du <em>machine learning</em> est la mise à disposition d’un modèle par le biais d’une API (voir chapitre sur la <a href="../chapters/deployment.html">mise en production</a>). Le <em>framework</em> <a href="https://fastapi.tiangolo.com/"><code>FastAPI</code></a> va permettre de rapidement transformer notre application <code>Python</code> en une API fonctionnelle.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-51-contents" aria-controls="callout-51" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Si vous prenez ce projet fil rouge en cours de route
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-51" class="callout-51-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb52" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli15</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 16: Mise à disposition sous forme d’API locale
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Installer <code>fastAPI</code> et <code>uvicorn</code> puis les ajouter au <code>requirements.txt</code></li>
<li>Renommer le fichier <code>main.py</code> en <code>train.py</code>. Dans ce script, ajouter une sauvegarde du modèle après l’avoir entraîné, sous le format <a href="https://scikit-learn.org/stable/model_persistence.html#python-specific-serialization"><code>joblib</code></a>.</li>
<li>Faire tourner</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb53" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python train.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>pour enregistrer en local votre modèle de production.</p>
<ul>
<li><p>Modifier les appels à <code>main.py</code> dans votre <code>Dockerfile</code> et vos actions <code>Github</code> sous peine d’essuyer des échecs lors de vos actions <code>Github</code> après le prochain <em>push</em>.</p></li>
<li><p>Ajouter <code>model.joblib</code> au <code>.gitignore</code> car <code>Git</code> n’est pas fait pour ce type de fichiers.</p></li>
</ul>
<p>Nous allons maintenant passer au développement de l’API. Comme découvrir <code>FastAPI</code> n’est pas l’objet de cet enseignement, nous donnons directement le modèle pour créer l’API. Si vous désirez tester de vous-mêmes, vous pouvez créer votre fichier sans vous référer à l’exemple</p>
<ul>
<li>Créer le fichier <code>api.py</code> permettant d’initialiser l’API:</li>
</ul>
<details>
<summary>
Fichier <code>api.py</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/models/train_evaluation.py</strong></pre>
</div>
<div class="sourceCode" id="cb54" data-filename="src/models/train_evaluation.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""A simple API to expose our trained RandomForest model for Tutanic survival."""</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastapi <span class="im">import</span> FastAPI</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> load</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> load(<span class="st">'model.joblib'</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> FastAPI(</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Prédiction de survie sur le Titanic"</span>,</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Application de prédiction de survie sur le Titanic 🚢 &lt;br&gt;Une version par API pour faciliter la réutilisation du modèle 🚀"</span> <span class="op">+\</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;br&gt;&lt;br&gt;&lt;img src=</span><span class="ch">\"</span><span class="st">https://media.vogue.fr/photos/5faac06d39c5194ff9752ec9/1:1/w_2404,h_2404,c_limit/076_CHL_126884.jpg</span><span class="ch">\"</span><span class="st"> width=</span><span class="ch">\"</span><span class="st">200</span><span class="ch">\"</span><span class="st">&gt;"</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">"/"</span>, tags<span class="op">=</span>[<span class="st">"Welcome"</span>])</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_welcome_page():</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Show welcome page with model name and version.</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Message"</span>: <span class="st">"API de prédiction de survie sur le Titanic"</span>,</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Model_name"</span>: <span class="st">'Titanic ML'</span>,</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Model_version"</span>: <span class="st">"0.1"</span>,</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">"/predict"</span>, tags<span class="op">=</span>[<span class="st">"Predict"</span>])</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> predict(</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>    sex: <span class="bu">str</span> <span class="op">=</span> <span class="st">"female"</span>,</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>    age: <span class="bu">float</span> <span class="op">=</span> <span class="fl">29.0</span>,</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>    fare: <span class="bu">float</span> <span class="op">=</span> <span class="fl">16.5</span>,</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>    embarked: <span class="bu">str</span> <span class="op">=</span> <span class="st">"S"</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Sex"</span>: [sex],</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Age"</span>: [age],</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Fare"</span>: [fare],</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Embarked"</span>: [embarked],</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> <span class="st">"Survived 🎉"</span> <span class="cf">if</span> <span class="bu">int</span>(model.predict(df)) <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">"Dead ⚰️"</span></span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prediction</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ul>
<li>Déployer en local l’API avec la commande</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb55" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> uvicorn api:app <span class="at">--reload</span> <span class="at">--host</span> <span class="st">"0.0.0.0"</span> <span class="at">--port</span> 5000</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>A partir du <code>README</code> du service, se rendre sur l’URL de déploiement, ajouter <code>/docs/</code> à celui-ci et observer la documentation de l’API</li>
<li>Se servir de la documentation pour tester les requêtes <code>/predict</code></li>
<li>Récupérer l’URL d’une des requêtes proposées. La tester dans le navigateur et depuis <code>Python</code> avec <code>requests</code> :</li>
</ul>
<div class="sourceCode" id="cb56" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> request</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>requests.get(url).json()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Une fois que vous avez testé, vous pouvez tuer l’application en faisant <kbd>CTRL</kbd>+<kbd>C</kbd>. Retester votre bout de code <code>Python</code> et comprendre l’origine du problème.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-53-contents" aria-controls="callout-53" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-53" class="callout-53-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-119" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-119" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-119-1" class="code-annotation-target"><a href="#annotated-cell-119-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-119-2"><a href="#annotated-cell-119-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli17</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-119" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-119" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="étape-2-déployer-lapi-de-manière-manuelle" class="level2">
<h2 class="anchored" data-anchor-id="étape-2-déployer-lapi-de-manière-manuelle">Étape 2: déployer l’API de manière manuelle</h2>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-54-contents" aria-controls="callout-54" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Si vous prenez ce projet fil rouge en cours de route
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-54" class="callout-54-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb57" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli16</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>A ce stade, nous avons déployé l’API seulement localement, dans le cadre d’un terminal qui tourne en arrière-plan. C’est une mise en production manuelle, pas franchement pérenne. Ce mode de déploiement est très pratique pour la phase de développement, afin de s’assurer que l’API fonctionne comme attendu. Pour pérenniser la mise en production, on va éliminer l’aspect artisanal de celle-ci.</p>
<p>Il est temps de passer à l’étape de déploiement, qui permettra à notre API d’être accessible via une URL sur le web et d’avoir un serveur, en arrière plan, qui effectuera les opérations pour répondre à une requête. Pour se faire, on va utiliser les possibilités offertes par <code>Kubernetes</code>, sur lequel est basé le <a href="https://datalab.sspcloud.fr">SSP Cloud</a>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 17: Dockeriser l’API (intégration continue)
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Pour rendre la structure du projet plus lisible, déplacer <code>api.py</code> -&gt; <code>api/main.py</code></p></li>
<li><p>Créer un script <code>api/run.sh</code> à la racine du projet qui lance le script <code>train.py</code> puis déploie localement l’API</p></li>
</ul>
<details>
<summary>
Fichier <code>run.sh</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>api/run.sh</strong></pre>
</div>
<div class="sourceCode" id="cb58" data-filename="terminal" data-no-prefix="true" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">#/bin/bash</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> train.py</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="ex">uvicorn</span> api.main:app <span class="at">--reload</span> <span class="at">--host</span> <span class="st">"0.0.0.0"</span> <span class="at">--port</span> 5000</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ul>
<li><p>Donner au script <code>api/run.sh</code> des permissions d’exécution : <code>chmod +x api/run.sh</code></p></li>
<li><p>Ajouter <code>COPY api ./api</code> pour avoir les fichiers nécessaires au lancement dans l’API dans l’image</p></li>
<li><p>Changer l’instruction <code>CMD</code> du <code>Dockerfile</code> pour exécuter le script <code>api/run.sh</code> au lancement du conteneur (<code>CMD ["bash", "-c", "./api/run.sh"]</code>)</p></li>
<li><p>Mettre à jour votre <code>requirements.txt</code> pour tenir compte des nouveaux <em>packages</em> utilisés</p></li>
<li><p><em>Commit</em> et <em>push</em> les changements</p></li>
<li><p>Une fois le CI terminé, récupérer la nouvelle image dans votre environnement de test de <code>Docker</code> et vérifier que l’API se déploie correctement</p></li>
</ul>
</div>
</div>
<p>Nous avons préparé la mise à disposition de notre API mais à l’heure actuelle elle n’est pas disponible de manière aisée car il est nécessaire de lancer manuellement une image <code>Docker</code> pour pouvoir y accéder. Ce type de travail est la spécialité de <code>Kubernetes</code> que nous allons utiliser pour gérer la mise à disposition de notre API.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 18b: Mettre à disposition l’API (déploiement manuel)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Cette partie nécessite d’avoir à disposition une infrastructure <em>cloud</em>.</p>
<ul>
<li><p>Créer un dossier <code>deployment</code> à la racine du projet qui va contenir les fichiers de configuration nécessaires pour déployer sur un cluster <code>Kubernetes</code></p></li>
<li><p>En vous inspirant de la <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment">documentation</a>, y ajouter un premier fichier <code>deployment.yaml</code> qui va spécifier la configuration du <em>Pod</em> à lancer sur le cluster</p></li>
</ul>
<details>
<summary>
Fichier <code>deployment/deployment.yaml</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deployment/deployment.yaml</strong></pre>
</div>
<div class="sourceCode" id="cb59" data-filename="deployment/deployment.yaml" data-code-line-numbers=""><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> titanic-deployment</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> linogaliana/application-correction:latest</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ul>
<li>En vous inspirant de la <a href="https://kubernetes.io/fr/docs/concepts/services-networking/service/#d%C3%A9finition-d-un-service">documentation</a>, y ajouter un second fichier <code>service.yaml</code> qui va créer une ressource <code>Service</code> permettant de donner une identité fixe au <code>Pod</code> précédemment créé au sein du cluster</li>
</ul>
<details>
<summary>
Fichier <code>deployment/service.yaml</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deployment/service.yaml</strong></pre>
</div>
<div class="sourceCode" id="cb60" data-filename="deployment/service.yaml" data-code-line-numbers=""><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> titanic-service</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">protocol</span><span class="kw">:</span><span class="at"> TCP</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ul>
<li>En vous inspirant de la <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#the-ingress-resource">documentation</a>, y ajouter un troisième fichier <code>ingress.yaml</code> qui va créer une ressource <code>Ingress</code> permettant d’exposer le service via une URL en dehors du cluster</li>
</ul>
<details>
<summary>
Fichier <code>deployment/ingress.yaml</code>
</summary>
<div id="df2eb80d" class="cell" data-source-line-numbers="10-13" data-execution_count="6">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deployment/ingress.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="annotated-cell-126" data-source-line-numbers="10-13" data-code-line-numbers="10-13"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-126-1"><a href="#annotated-cell-126-1" aria-hidden="true" tabindex="-1"></a>apiVersion: networking.k8s.io<span class="op">/</span>v1</span>
<span id="annotated-cell-126-2"><a href="#annotated-cell-126-2" aria-hidden="true" tabindex="-1"></a>kind: Ingress</span>
<span id="annotated-cell-126-3"><a href="#annotated-cell-126-3" aria-hidden="true" tabindex="-1"></a>metadata:</span>
<span id="annotated-cell-126-4"><a href="#annotated-cell-126-4" aria-hidden="true" tabindex="-1"></a>  name: titanic<span class="op">-</span>ingress</span>
<span id="annotated-cell-126-5"><a href="#annotated-cell-126-5" aria-hidden="true" tabindex="-1"></a>  annotations:</span>
<span id="annotated-cell-126-6"><a href="#annotated-cell-126-6" aria-hidden="true" tabindex="-1"></a>    nginx.ingress.kubernetes.io<span class="op">/</span>rewrite<span class="op">-</span>target: <span class="op">/</span></span>
<span id="annotated-cell-126-7"><a href="#annotated-cell-126-7" aria-hidden="true" tabindex="-1"></a>spec:</span>
<span id="annotated-cell-126-8"><a href="#annotated-cell-126-8" aria-hidden="true" tabindex="-1"></a>  ingressClassName: nginx</span>
<span id="annotated-cell-126-9"><a href="#annotated-cell-126-9" aria-hidden="true" tabindex="-1"></a>  tls:</span>
<span id="annotated-cell-126-10"><a href="#annotated-cell-126-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span> hosts:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-126" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-126-11" class="code-annotation-target"><a href="#annotated-cell-126-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> <span class="co"># METTRE URL ICI</span></span>
<span id="annotated-cell-126-12"><a href="#annotated-cell-126-12" aria-hidden="true" tabindex="-1"></a>  rules:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-126" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-126-13" class="code-annotation-target"><a href="#annotated-cell-126-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span> host: <span class="co"># METTRE URL ICI</span></span>
<span id="annotated-cell-126-14"><a href="#annotated-cell-126-14" aria-hidden="true" tabindex="-1"></a>    http:</span>
<span id="annotated-cell-126-15"><a href="#annotated-cell-126-15" aria-hidden="true" tabindex="-1"></a>      paths:</span>
<span id="annotated-cell-126-16"><a href="#annotated-cell-126-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> path: <span class="op">/</span></span>
<span id="annotated-cell-126-17"><a href="#annotated-cell-126-17" aria-hidden="true" tabindex="-1"></a>        pathType: Prefix</span>
<span id="annotated-cell-126-18"><a href="#annotated-cell-126-18" aria-hidden="true" tabindex="-1"></a>        backend:</span>
<span id="annotated-cell-126-19"><a href="#annotated-cell-126-19" aria-hidden="true" tabindex="-1"></a>          service:</span>
<span id="annotated-cell-126-20"><a href="#annotated-cell-126-20" aria-hidden="true" tabindex="-1"></a>            name: titanic<span class="op">-</span>service</span>
<span id="annotated-cell-126-21"><a href="#annotated-cell-126-21" aria-hidden="true" tabindex="-1"></a>            port:</span>
<span id="annotated-cell-126-22"><a href="#annotated-cell-126-22" aria-hidden="true" tabindex="-1"></a>              number: <span class="dv">80</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-126" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-126" data-code-lines="11" data-code-annotation="1">Mettez l’URL auquel vous voulez exposer votre service. Sur le modèle de <code>titanic.kub.sspcloud.fr</code> (mais ne tentez pas celui-là, il est déjà pris 😃)</span>
</dd>
<dt data-target-cell="annotated-cell-126" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-126" data-code-lines="13" data-code-annotation="2">Mettre ici aussi</span>
</dd>
</dl>
</div>
</div>
</details>
<ul>
<li><p>Appliquer ces fichiers de configuration sur le cluster : <code>kubectl apply -f deployment/</code></p></li>
<li><p>Si tout a correctement fonctionné, vous devriez pouvoir accéder depuis votre navigateur à l’API à l’URL spécifiée dans le fichier <code>deployment/ingress.yaml</code>. Par exemple <code>https://toto.kub.sspcloud.fr/</code> si vous avez mis celui-ci plus tôt (et <code>https://toto.kub.sspcloud.fr/docs</code> pour la documentation).</p></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-57-contents" aria-controls="callout-57" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-57" class="callout-57-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-129" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-129" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-129-1" class="code-annotation-target"><a href="#annotated-cell-129-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-129-2"><a href="#annotated-cell-129-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli18</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-129" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-129" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Gérer le CORS">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Gérer le CORS
</div>
</div>
<div class="callout-body-container callout-body">
<p>Notre API est accessible sans problème depuis <code>Python</code> ou notre navigateur.</p>
<p>En revanche, si on désire utiliser <code>JavaScript</code> pour créer une application interactive il est indispensable de mettre les lignes un peu obscure sur le CORS dans le fichier <code>ingress.yaml</code>.</p>
<p>Comme c’est un point technique qui ne concerne pas les compétences liées à ce cours, nous donnons directement les mises à jour nécessaires du projet.</p>
</div>
</div>
<p>On peut remarquer quelques voies d’amélioration de notre approche qui seront ultérieurement traitées:</p>
<ul>
<li>L’entraînement du modèle est ré-effectué à chaque lancement d’un nouveau conteneur. On relance donc autant de fois un entraînement qu’on déploie de conteneurs pour répondre à nos utilisateurs. Ce sera l’objet de la partie MLOps de fiabiliser et optimiser cette partie du <em>pipeline</em>.</li>
<li>il est nécessaire de (re)lancer manuellement <code>kubectl apply -f deployment/</code> à chaque changement de notre code. Autrement dit, lors de cette application, on a amélioré la fiabilité du lancement de notre API mais un lancement manuel est encore indispensable. Comme dans le reste de ce cours, on va essayer d’éviter un geste manuel pouvant être source d’erreur en privilégiant l’automatisation et l’archivage dans des scripts. C’est l’objet de la prochaine étape.</li>
</ul>
</section>
<section id="etape-3-automatiser-le-déploiement-déploiement-en-continu" class="level2">
<h2 class="anchored" data-anchor-id="etape-3-automatiser-le-déploiement-déploiement-en-continu">Etape 3: automatiser le déploiement (déploiement en continu)</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Clarification sur la branche de travail
</div>
</div>
<div class="callout-body-container callout-body">
<p>A partir de maintenant, il est nécessaire de clarifier la branche principale sur laquelle nous travaillons. De manière traditionnelle, on utilise la branche <code>main</code>. Néanmoins, pour être cohérent avec les instructions du début, qui étaient de créer une branche <code>dev</code>, tous les exemples ultérieures partiront de cette hypothèse.</p>
<p>Si vous avez fait les applications les unes après les autres, et que vous vous situez toujours sur <code>dev</code>, vous pouvez passer aux applications suivantes. Si vous avez changé de branche, vous pouvez continuer mais en tenir compte dans les exemples ultérieurs.</p>
<p>Si vous avez utilisé un <code>tag</code> pour sauter une ou plusieurs étapes, il va être nécessaire de se placer sur une branche car vous êtes en <em>head detached</em>. Pour cela, après avoir <em>committé</em> les fichiers que vous désirez garder</p>
<div id="6d2c15aa" class="cell" data-file="terminal" data-execution_count="7">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode cell-code" id="annotated-cell-130" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-130" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-130-1" class="code-annotation-target"><a href="#annotated-cell-130-1" aria-hidden="true" tabindex="-1"></a>$ git branch <span class="op">-</span>D dev</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-130" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-130-2" class="code-annotation-target"><a href="#annotated-cell-130-2" aria-hidden="true" tabindex="-1"></a>$ git push origin <span class="op">-</span>d dev</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-130" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-130-3" class="code-annotation-target"><a href="#annotated-cell-130-3" aria-hidden="true" tabindex="-1"></a>$ git checkout <span class="op">-</span>b dev</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-130" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-130-4" class="code-annotation-target"><a href="#annotated-cell-130-4" aria-hidden="true" tabindex="-1"></a>$ git push <span class="op">--</span><span class="bu">set</span><span class="op">-</span>upstream origin dev</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-130" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-130" data-code-lines="1" data-code-annotation="1">Supprime la branche <code>dev</code> <em>locale</em> (si elle existe).</span>
</dd>
<dt data-target-cell="annotated-cell-130" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-130" data-code-lines="2" data-code-annotation="2">Supprime la branche <code>dev</code> <em>remote</em> (si elle existe).</span>
</dd>
<dt data-target-cell="annotated-cell-130" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-130" data-code-lines="3" data-code-annotation="3">Crée une nouvelle branche <code>dev</code> <em>locale</em> et on se place sur cette branche.</span>
</dd>
<dt data-target-cell="annotated-cell-130" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-130" data-code-lines="4" data-code-annotation="4">Pousse la branche <code>dev</code> et active la synchronisation entre la branche <em>locale</em> et la branche <em>remote</em>.</span>
</dd>
</dl>
</div>
</div>
</div>
</div>
<p>Qu’est-ce qui peut déclencher une évolution nécessitant de mettre à jour l’ensemble de notre processus de production ?</p>
<p>Regardons à nouveau notre <em>pipeline</em>:</p>
<p><img src="../workflow2.png" class="img-fluid"></p>
<p>Les <em>inputs</em> de notre <em>pipeline</em> sont donc:</p>
<ul>
<li>La <strong>configuration</strong>. Ici, on peut considérer que notre YAML de configuration relève de cette catégorie ;</li>
<li>Les <strong>données</strong>. Nos données sont statiques et n’ont pas vocation à évoluer. Si c’était le cas, il faudrait en tenir compte dans notre automatisation. ;</li>
<li>Le <strong>code</strong>. C’est l’élément principal qui évolue chez nous. Idéalement, on veut automatiser le processus au maximum en faisant en sorte qu’à chaque mise à jour de notre code (un <em>push</em> sur <code>Github</code>), les étapes ultérieures (production de l’image <code>Docker</code>, etc.) se lancent. Néanmoins, on veut aussi éviter qu’une erreur puisse donner lieu à une mise en production non-fonctionnelle, on va donc maintenir une action manuelle minimale comme garde-fou.</li>
</ul>
<p>Pour automatiser au maximum la mise en production, on va utiliser un nouvel outil : <code>ArgoCD</code>. Ainsi, au lieu de devoir appliquer manuellement la commande <code>kubectl apply</code> à chaque modification des fichiers de déploiement (présents dans le dossier <code>kubernetes/</code>), c’est l’<strong>opérateur</strong> <code>ArgoCD</code>, déployé sur le cluster, qui va détecter les changements de configuration du déploiement et les appliquer automatiquement. C’est l’approche dite <strong>GitOps</strong> : le dépôt <code>Git</code> du déploiement fait office de <strong>source de vérité unique</strong> de l’état voulu de l’application, tout changement sur ce dernier doit donc se répercuter immédiatement sur le déploiement effectif.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 19a: Automatiser la mise à disposition de l’API (déploiement continu)
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Lancer un service <code>ArgoCD</code> sur le <code>SSPCloud</code> depuis la page <code>Mes services</code> (catalogue <code>Automation</code>). Laisser les configurations par défaut.</li>
<li>Sur <code>GitHub</code>, créer un dépôt <code>application-deployment</code> qui va servir de <strong>dépôt GitOps</strong>, c’est à dire un dépôt qui spécifie le paramétrage du déploiement de votre application.</li>
<li>Ajouter un dossier <code>deployment</code> à votre dépôt <code>GitOps</code>, dans lequel on mettra les trois fichiers de déploiement qui permettent de déployer notre application sur <code>Kubernetes</code> (<code>deployment.yaml</code>, <code>service.yaml</code>, <code>ingress.yaml</code>).</li>
<li>A la racine de votre dépôt <code>GitOps</code>, créez un fichier <code>application.yml</code> avec le contenu suivant, en prenant bien soin de modifier les lignes surlignées avec les informations pertinentes :</li>
</ul>
<div id="045a54a3" class="cell" data-file="application.yaml" data-source-line-numbers="8-9,13" data-execution_count="8">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>application.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="annotated-cell-131" data-source-line-numbers="8-9,13" data-code-line-numbers="8-9,13"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-131-1"><a href="#annotated-cell-131-1" aria-hidden="true" tabindex="-1"></a>apiVersion: argoproj.io<span class="op">/</span>v1alpha1</span>
<span id="annotated-cell-131-2"><a href="#annotated-cell-131-2" aria-hidden="true" tabindex="-1"></a>kind: Application</span>
<span id="annotated-cell-131-3"><a href="#annotated-cell-131-3" aria-hidden="true" tabindex="-1"></a>metadata:</span>
<span id="annotated-cell-131-4"><a href="#annotated-cell-131-4" aria-hidden="true" tabindex="-1"></a>  name: ensae<span class="op">-</span>mlops</span>
<span id="annotated-cell-131-5"><a href="#annotated-cell-131-5" aria-hidden="true" tabindex="-1"></a>spec:</span>
<span id="annotated-cell-131-6"><a href="#annotated-cell-131-6" aria-hidden="true" tabindex="-1"></a>  project: default</span>
<span id="annotated-cell-131-7"><a href="#annotated-cell-131-7" aria-hidden="true" tabindex="-1"></a>  source:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-131" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-131-8" class="code-annotation-target"><a href="#annotated-cell-131-8" aria-hidden="true" tabindex="-1"></a>    repoURL: https:<span class="op">//</span>github.com<span class="op">/&lt;</span>your_github_username<span class="op">&gt;/</span>application<span class="op">-</span>deployment.git</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-131" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-131-9" class="code-annotation-target"><a href="#annotated-cell-131-9" aria-hidden="true" tabindex="-1"></a>    targetRevision: main</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-131" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-131-10" class="code-annotation-target"><a href="#annotated-cell-131-10" aria-hidden="true" tabindex="-1"></a>    path: deployment</span>
<span id="annotated-cell-131-11"><a href="#annotated-cell-131-11" aria-hidden="true" tabindex="-1"></a>  destination:</span>
<span id="annotated-cell-131-12"><a href="#annotated-cell-131-12" aria-hidden="true" tabindex="-1"></a>    server: https:<span class="op">//</span>kubernetes.default.svc</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-131" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-131-13" class="code-annotation-target"><a href="#annotated-cell-131-13" aria-hidden="true" tabindex="-1"></a>    namespace: user<span class="op">-&lt;</span>your_sspcloud_username<span class="op">&gt;</span></span>
<span id="annotated-cell-131-14"><a href="#annotated-cell-131-14" aria-hidden="true" tabindex="-1"></a>  syncPolicy:</span>
<span id="annotated-cell-131-15"><a href="#annotated-cell-131-15" aria-hidden="true" tabindex="-1"></a>    automated:</span>
<span id="annotated-cell-131-16"><a href="#annotated-cell-131-16" aria-hidden="true" tabindex="-1"></a>      selfHeal: true</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-131" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-131" data-code-lines="8" data-code-annotation="1">L’URL de votre dépôt <code>Github</code> <i class="fa-brands fa-github" aria-label="github"></i></span>
</dd>
<dt data-target-cell="annotated-cell-131" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-131" data-code-lines="9" data-code-annotation="2">La branche à partir de laquelle vous déployez</span>
</dd>
<dt data-target-cell="annotated-cell-131" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-131" data-code-lines="10" data-code-annotation="3">Le nom du dossier contenant vos fichiers de déploiement <code>Kubernetes</code></span>
</dd>
<dt data-target-cell="annotated-cell-131" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-131" data-code-lines="13" data-code-annotation="4">Votre <em>namespace</em> <code>Kubernetes</code>. Sur le SSPCloud, cela prend la forme <code>user-${username}</code></span>
</dd>
</dl>
</div>
</div>
<ul>
<li>Dans <code>ArgoCD</code>, cliquez sur <code>New App</code> puis <code>Edit as a YAML</code>. Copiez-collez le contenu de <code>application.yml</code> et cliquez sur <code>Create</code>.</li>
<li>Observez dans l’interface d’<code>ArgoCD</code> le déploiement progressif des ressources nécessaires à votre application sur le cluster. Joli non ?</li>
<li>Vérifiez que votre API est bien déployée en utilisant l’URL définie dans le fichier <code>ingress.yml</code>.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-61-contents" aria-controls="callout-61" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-61" class="callout-61-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-132" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-132" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-132-1" class="code-annotation-target"><a href="#annotated-cell-132-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-132-2"><a href="#annotated-cell-132-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli19a</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-132" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-132" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>A présent, nous avons tous les outils à notre disposition pour construire un vrai <strong>pipeline de CI/CD, automatisé de bout en bout</strong>. Il va nous suffire pour cela de mettre à bout les composants :</p>
<ul>
<li><p>dans la partie 4 de l’application, nous avons construit un <strong>pipeline de CI</strong> : on a donc seulement à faire un commit sur le dépôt de l’application pour lancer l’étape de <strong>build</strong> et de mise à disposition de la nouvelle image sur le <code>DockerHub</code> ;</p></li>
<li><p>dans l’application précédente, nous avons construit un <strong>pipeline de CD</strong> : <code>ArgoCD</code> suit en permanence l’état du dépôt <code>GitOps</code>, tout commit sur ce dernier lancera donc automatiquement un redéploiement de l’application.</p></li>
</ul>
<p>Il y a donc un élément qui fait la liaison entre ces deux pipelines et qui nous sert de garde-fou en cas d’erreur : la <strong>version de l’application</strong>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 19b : Mettre à jour la version en production
</div>
</div>
<div class="callout-body-container callout-body">
<p>Jusqu’à maintenant, on a utilisé le tag <em>latest</em> pour définir la version de notre application. En pratique, lorsqu’on passe de la phase de développement à celle de production, on a plutôt envie de versionner proprement les versions de l’application afin de savoir ce qui est déployé. On va pour cela utiliser les <strong><em>tags</em></strong> avec <code>Git</code>, qui vont se propager au nommage de l’image <code>Docker</code>.</p>
<ul>
<li>Modifier le fichier de CI <code>prod.yml</code> pour assurer la propagation des tags.</li>
</ul>
<details>
<summary>
<p>Fichier <code>.github/workflows/prod.yml</code></p>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.github/workflows/prod.yml</strong></pre>
</div>
<div class="sourceCode" id="cb61" data-filename=".github/workflows/prod.yml" data-code-line-numbers=""><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Construction image Docker</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> main</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> dev</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">tags</span><span class="kw">:</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">'v*.*.*'</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">docker</span><span class="kw">:</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up QEMU</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/setup-qemu-action@v3</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Docker Buildx</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/setup-buildx-action@v3</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Docker meta</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> meta</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/metadata-action@v5</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">images</span><span class="kw">:</span><span class="at"> linogaliana/application-correction</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Login to Docker Hub</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/login-action@v3</span></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">username</span><span class="kw">:</span><span class="at"> ${{ secrets.DOCKERHUB_USERNAME }}</span></span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">password</span><span class="kw">:</span><span class="at"> ${{ secrets.DOCKERHUB_TOKEN }}</span></span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span></span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build and push</span></span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/build-push-action@v5</span></span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">push</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">tags</span><span class="kw">:</span><span class="at"> ${{ steps.meta.outputs.tags }}</span></span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">labels</span><span class="kw">:</span><span class="at"> ${{ steps.meta.outputs.labels }}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ul>
<li>Dans le dépôt de l’application, mettre à jour le code dans <code>api/main.py</code> pour changer un élément de l’interface de votre documentation. Par exemple, mettre en gras un titre.</li>
</ul>
<div class="sourceCode" id="cb62" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> FastAPI(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Prédiction de survie sur le Titanic"</span>,</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"&lt;b&gt;Application de prédiction de survie sur le Titanic&lt;/b&gt; 🚢 &lt;br&gt;Une version par API pour faciliter la réutilisation du modèle 🚀"</span> <span class="op">+\</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;br&gt;&lt;br&gt;&lt;img src=</span><span class="ch">\"</span><span class="st">https://media.vogue.fr/photos/5faac06d39c5194ff9752ec9/1:1/w_2404,h_2404,c_limit/076_CHL_126884.jpg</span><span class="ch">\"</span><span class="st"> width=</span><span class="ch">\"</span><span class="st">200</span><span class="ch">\"</span><span class="st">&gt;"</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><em>Commit</em> et <em>push</em> les changements.</p></li>
<li><p>Tagger le commit effectué précédemment et <em>push</em> le nouveau tag :</p></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb63" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git tag v1.0.0</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git push <span class="at">--tags</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Vérifier sur le dépôt <code>GitHub</code> de l’application que ce <em>commit</em> lance bien un pipeline de CI <strong>associé au tag v1.0.0</strong>. Une fois terminé, vérifier sur le <code>DockerHub</code> que le tag <code>v1.0.0</code> existe bien parmi les tags disponibles de l’image.</li>
</ul>
<p>La partie CI a correctement fonctionné. Intéressons-nous à présent à la partie CD.</p>
<ul>
<li>Sur le dépôt <code>GitOps</code> de l’application, mettre à jour la version de l’image à déployer en production dans le fichier <code>deployment/deployment.yaml</code></li>
</ul>
<details>
<summary>
<p>Fichier <code>deployment/deployment.yaml</code></p>
</summary>
<div id="88164354" class="cell" data-file="deployment/deployment.yaml" data-source-line-numbers="19" data-execution_count="9">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deployment/deployment.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb64" data-source-line-numbers="19" data-code-line-numbers="19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>apiVersion: apps<span class="op">/</span>v1</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>kind: Deployment</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>metadata:</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  name: titanic<span class="op">-</span>deployment</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  labels:</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    app: titanic</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>spec:</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  replicas: <span class="dv">1</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  selector:</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    matchLabels:</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>      app: titanic</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  template:</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>    metadata:</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>      labels:</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>        app: titanic</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>    spec:</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>      containers:</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> name: titanic</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>        image: linogaliana<span class="op">/</span>application<span class="op">-</span>correction:v1<span class="fl">.0.0</span></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>        ports:</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> containerPort: <span class="dv">5000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ol type="1">
<li>Remplacer <code>username</code> par la valeur adéquate</li>
</ol>
</details>
<ul>
<li>Après avoir <em>committé</em> et <em>pushé</em>, observer dans <code>ArgoCD</code> le statut de votre application. Normalement, l’opérateur devrait avoir automatiquement identifié le changement, et mettre à jour le déploiement pour en tenir compte.</li>
</ul>
<p><img src="../argocd-waiting.png" class="img-fluid"></p>
<ul>
<li>Vérifier que l’API a bien été mise à jour.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-63-contents" aria-controls="callout-63" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-63" class="callout-63-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-140" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-140" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-140-1" class="code-annotation-target"><a href="#annotated-cell-140-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-140-2"><a href="#annotated-cell-140-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli19b</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-140" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-140" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="etape-4-construire-un-site-web" class="level2">
<h2 class="anchored" data-anchor-id="etape-4-construire-un-site-web">Etape 4: construire un site web</h2>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-64-contents" aria-controls="callout-64" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Si vous prenez ce projet fil rouge en cours de route
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-64" class="callout-64-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb65" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli19</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout <span class="at">-b</span> dev</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git push origin dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>On va proposer un nouveau livrable pour parler à un public plus large. Pour faire ce site web, on va utiliser <code>Quarto</code> et déployer sur <code>Github Pages</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 20: Création d’un site web pour valoriser le projet
</div>
</div>
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb66" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> quarto create project website mysite</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Faire remonter d’un niveau <code>_quarto.yml</code></li>
<li>Supprimer <code>about.qmd</code>, déplacer <code>index.qmd</code> vers la racine de notre projet.</li>
<li>Remplacer le contenu de <code>index.qmd</code> par <a href="https://raw.githubusercontent.com/ensae-reproductibilite/application-correction/tree/appli19/index.qmd">celui-ci</a> et retirer <code>about.qmd</code> des fichiers à compiler.</li>
<li>Déplacer <code>styles.css</code> à la racine du projet</li>
<li>Mettre à jour le <code>.gitignore</code> avec les instructions suivantes</li>
</ul>
<div class="sourceCode" id="cb67" data-file=".gitignore" data-no-prefix="true" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/.quarto/</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="ex">*.html</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="ex">*_files</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="ex">_site/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>En ligne de commande, faire <code>quarto preview</code> (ajouter les arguments <code>--port 5000 --host 0.0.0.0</code> si vous passez par le <code>SSPCloud</code>)</li>
<li>Observer le site web généré en local</li>
</ul>
<p>Enfin, on va construire et déployer automatiquement ce site web grâce au combo <code>Github Actions</code> et <code>Github Pages</code>:</p>
<ul>
<li>Créer une branche <code>gh-pages</code> à partir du contenu de <a href="https://quarto.org/docs/publishing/github-pages.html#source-branch">cette page</a></li>
<li>Revenir à votre branche</li>
<li>Créer un fichier <code>.github/workflows/website.yaml</code> avec le contenu de <a href="https://raw.githubusercontent.com/ensae-reproductibilite/application-correction/tree/appli20/.github/workflows/publish.yaml">ce fichier</a></li>
<li>Modifier le <code>README</code> pour indiquer l’URL de votre site web et de votre API</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-66-contents" aria-controls="callout-66" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-66" class="callout-66-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-146" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-146" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-146-1" class="code-annotation-target"><a href="#annotated-cell-146-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-146-2"><a href="#annotated-cell-146-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli20</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-146" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-146" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="partie-6-adopter-une-approche-mlops-pour-améliorer-notre-modèle" class="level1">
<h1>Partie 6: adopter une approche MLOps pour améliorer notre modèle</h1>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-67-contents" aria-controls="callout-67" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Si vous prenez ce projet fil rouge en cours de route
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-67" class="callout-67-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb68" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli20</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout <span class="at">-b</span> dev</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git push origin dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>Nous allons dans cette partie faire de la validation croisée. Pour éviter le problème du <a href="https://machinelearningmastery.com/data-leakage-machine-learning/"><em>data leakage</em></a>, nous proposons de revoir notre <em>pipeline</em> pour exclure la variable <code>Title</code> dont certaines modalités rares posent problème dans les découpages multiples d’échantillons lors de la validation croisée.</p>
<section id="restructurer-le-pipeline-pour-fluidifier-la-mise-en-production" class="level2">
<h2 class="anchored" data-anchor-id="restructurer-le-pipeline-pour-fluidifier-la-mise-en-production">Restructurer le <em>pipeline</em> pour fluidifier la mise en production</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 21 <em>(optionnelle)</em>: restructuration de la chaîne
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Faire les modifications suivantes pour restructurer notre <em>pipeline</em> afin de mieux distinguer les étapes d’estimation et d’évaluation</li>
</ol>
<details>
<summary>
Modification de <code>src/models/train_evaluation.py</code> à effectuer
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/models/train_evaluation.py</strong></pre>
</div>
<div class="sourceCode" id="cb69" data-filename="src/models/train_evaluation.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_pipeline(</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    n_trees: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>,</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    numeric_features<span class="op">=</span>[<span class="st">"Age"</span>, <span class="st">"Fare"</span>],</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    categorical_features<span class="op">=</span>[<span class="st">"Title"</span>, <span class="st">"Embarked"</span>, <span class="st">"Sex"</span>]):</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Random forest model for Titanic survival</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="co">        n_trees (int, optional): _description_. Defaults to 20.</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="co">        _type_: _description_</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>    numeric_transformer <span class="op">=</span> Pipeline(</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>        steps<span class="op">=</span>[</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"imputer"</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>)),</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"scaler"</span>, MinMaxScaler()),</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>    categorical_transformer <span class="op">=</span> Pipeline(</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>        steps<span class="op">=</span>[</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"imputer"</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">"most_frequent"</span>)),</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"onehot"</span>, OneHotEncoder()),</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>    preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>[</span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"Preprocessing numerical"</span>, numeric_transformer, numeric_features),</span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Preprocessing categorical"</span>,</span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>                categorical_transformer,</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>                categorical_features,</span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>    pipe <span class="op">=</span> Pipeline(</span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"preprocessor"</span>, preprocessor),</span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"classifier"</span>, RandomForestClassifier(n_estimators<span class="op">=</span>n_trees)),</span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pipe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<details>
<summary>
Modification de <code>src/features/build_features.py</code> pour enchaîner les étapes de <em>feature engineering</em>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/features/build_features.py</strong></pre>
</div>
<div class="sourceCode" id="cb70" data-filename="src/features/build_features.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> feature_engineering(data: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Applying our feature engineering pipeline</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="co">        data (pd.DataFrame): Initial dataframe</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co">        pd.DataFrame: Dataframe with feature engineering being handled</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    data_training <span class="op">=</span> create_variable_title(data)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    data_training <span class="op">=</span> check_has_cabin(data_training)</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    data_training <span class="op">=</span> ticket_length(data_training)</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_training</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<details>
<summary>
Modification de <code>train.py</code> pour faire une <em>grid search</em>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>train.py</strong></pre>
</div>
<div class="sourceCode" id="cb71" data-filename="train.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="co">Prediction de la survie d'un individu sur le Titanic</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="co"># GESTION ENVIRONNEMENT --------------------------------</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> dump</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> src.data.import_data <span class="im">as</span> imp</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> src.features.build_features <span class="im">as</span> bf</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> src.models.train_evaluate <span class="im">as</span> te</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a><span class="co"># PARAMETRES -------------------------------</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Paramètres ligne de commande</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span><span class="st">"Paramètres du random forest"</span>)</span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">"--n_trees"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">20</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Nombre d'arbres"</span>)</span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">"--appli"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, default<span class="op">=</span><span class="st">"appli21"</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Application number"</span>)</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>args <span class="op">=</span> parser.parse_args()</span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Paramètres YAML</span></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> imp.import_yaml_config(<span class="st">"configuration/config.yaml"</span>)</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>base_url <span class="op">=</span> (</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://minio.lab.sspcloud.fr/projet-formation/ensae-reproductibilite/data/raw"</span></span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>API_TOKEN <span class="op">=</span> config.get(<span class="st">"jeton_api"</span>)</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>LOCATION_TRAIN <span class="op">=</span> config.get(<span class="st">"train_path"</span>, <span class="ss">f"</span><span class="sc">{</span>base_url<span class="sc">}</span><span class="ss">/train.csv"</span>)</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>LOCATION_TEST <span class="op">=</span> config.get(<span class="st">"test_path"</span>, <span class="ss">f"</span><span class="sc">{</span>base_url<span class="sc">}</span><span class="ss">/test.csv"</span>)</span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>TEST_FRACTION <span class="op">=</span> config.get(<span class="st">"test_fraction"</span>, <span class="fl">0.1</span>)</span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a>N_TREES <span class="op">=</span> args.n_trees</span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>APPLI_ID <span class="op">=</span> args.appli</span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a>EXPERIMENT_NAME <span class="op">=</span> <span class="st">"titanicml"</span></span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a><span class="co"># FEATURE ENGINEERING --------------------------------</span></span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true" tabindex="-1"></a>titanic_raw <span class="op">=</span> imp.import_data(LOCATION_TRAIN)</span>
<span id="cb71-40"><a href="#cb71-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-41"><a href="#cb71-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 'Title' variable</span></span>
<span id="cb71-42"><a href="#cb71-42" aria-hidden="true" tabindex="-1"></a>titanic_intermediate <span class="op">=</span> bf.feature_engineering(titanic_raw)</span>
<span id="cb71-43"><a href="#cb71-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-44"><a href="#cb71-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-45"><a href="#cb71-45" aria-hidden="true" tabindex="-1"></a>train, test <span class="op">=</span> te.split_train_test_titanic(</span>
<span id="cb71-46"><a href="#cb71-46" aria-hidden="true" tabindex="-1"></a>    titanic_intermediate, fraction_test<span class="op">=</span>TEST_FRACTION</span>
<span id="cb71-47"><a href="#cb71-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-48"><a href="#cb71-48" aria-hidden="true" tabindex="-1"></a>X_train, y_train <span class="op">=</span> train.drop(<span class="st">"Survived"</span>, axis<span class="op">=</span><span class="st">"columns"</span>), train[<span class="st">"Survived"</span>]</span>
<span id="cb71-49"><a href="#cb71-49" aria-hidden="true" tabindex="-1"></a>X_test, y_test <span class="op">=</span> test.drop(<span class="st">"Survived"</span>, axis<span class="op">=</span><span class="st">"columns"</span>), test[<span class="st">"Survived"</span>]</span>
<span id="cb71-50"><a href="#cb71-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-51"><a href="#cb71-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-52"><a href="#cb71-52" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_local_data(data, filename):</span>
<span id="cb71-53"><a href="#cb71-53" aria-hidden="true" tabindex="-1"></a>    data.to_csv(<span class="ss">f"data/intermediate/</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb71-54"><a href="#cb71-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-55"><a href="#cb71-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-56"><a href="#cb71-56" aria-hidden="true" tabindex="-1"></a>output_dir <span class="op">=</span> Path(<span class="st">"data/intermediate"</span>)</span>
<span id="cb71-57"><a href="#cb71-57" aria-hidden="true" tabindex="-1"></a>output_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb71-58"><a href="#cb71-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-59"><a href="#cb71-59" aria-hidden="true" tabindex="-1"></a>log_local_data(X_train, <span class="st">"X_train"</span>)</span>
<span id="cb71-60"><a href="#cb71-60" aria-hidden="true" tabindex="-1"></a>log_local_data(X_test, <span class="st">"X_test"</span>)</span>
<span id="cb71-61"><a href="#cb71-61" aria-hidden="true" tabindex="-1"></a>log_local_data(y_train, <span class="st">"y_train"</span>)</span>
<span id="cb71-62"><a href="#cb71-62" aria-hidden="true" tabindex="-1"></a>log_local_data(y_test, <span class="st">"y_test"</span>)</span>
<span id="cb71-63"><a href="#cb71-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-64"><a href="#cb71-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-65"><a href="#cb71-65" aria-hidden="true" tabindex="-1"></a><span class="co"># MODELISATION: RANDOM FOREST ----------------------------</span></span>
<span id="cb71-66"><a href="#cb71-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-67"><a href="#cb71-67" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> te.build_pipeline(n_trees<span class="op">=</span>N_TREES, categorical_features<span class="op">=</span>[<span class="st">"Embarked"</span>, <span class="st">"Sex"</span>])</span>
<span id="cb71-68"><a href="#cb71-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-69"><a href="#cb71-69" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {</span>
<span id="cb71-70"><a href="#cb71-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">"classifier__n_estimators"</span>: [<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>],</span>
<span id="cb71-71"><a href="#cb71-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">"classifier__max_leaf_nodes"</span>: [<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">50</span>],</span>
<span id="cb71-72"><a href="#cb71-72" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-73"><a href="#cb71-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-74"><a href="#cb71-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-75"><a href="#cb71-75" aria-hidden="true" tabindex="-1"></a>pipe_cross_validation <span class="op">=</span> GridSearchCV(</span>
<span id="cb71-76"><a href="#cb71-76" aria-hidden="true" tabindex="-1"></a>    pipe,</span>
<span id="cb71-77"><a href="#cb71-77" aria-hidden="true" tabindex="-1"></a>    param_grid<span class="op">=</span>param_grid,</span>
<span id="cb71-78"><a href="#cb71-78" aria-hidden="true" tabindex="-1"></a>    scoring<span class="op">=</span>[<span class="st">"accuracy"</span>, <span class="st">"precision"</span>, <span class="st">"recall"</span>, <span class="st">"f1"</span>],</span>
<span id="cb71-79"><a href="#cb71-79" aria-hidden="true" tabindex="-1"></a>    refit<span class="op">=</span><span class="st">"f1"</span>,</span>
<span id="cb71-80"><a href="#cb71-80" aria-hidden="true" tabindex="-1"></a>    cv<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb71-81"><a href="#cb71-81" aria-hidden="true" tabindex="-1"></a>    n_jobs<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb71-82"><a href="#cb71-82" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb71-83"><a href="#cb71-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-84"><a href="#cb71-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-85"><a href="#cb71-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-86"><a href="#cb71-86" aria-hidden="true" tabindex="-1"></a>pipe_cross_validation.fit(X_train, y_train)</span>
<span id="cb71-87"><a href="#cb71-87" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> pipe_cross_validation.best_estimator_</span>
<span id="cb71-88"><a href="#cb71-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-89"><a href="#cb71-89" aria-hidden="true" tabindex="-1"></a>dump(pipe, <span class="st">"model.joblib"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<details>
<summary>
Fichier <code>eval.py</code> pour évaluer la meilleure validation croisée
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>eval.py</strong></pre>
</div>
<div class="sourceCode" id="cb72" data-filename="eval.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix, accuracy_score</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> load</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="co"># EVALUATE ----------------------------</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>loaded_model <span class="op">=</span> load(<span class="st">"model.joblib"</span>)</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict on a Pandas DataFrame.</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> pd.read_csv(<span class="st">"data/intermediate/X_test.csv"</span>)</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> pd.read_csv(<span class="st">"data/intermediate/y_test.csv"</span>)</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>y_test_predict <span class="op">=</span> loaded_model.predict(X_test)</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="co"># EVALUATE ----------------------------</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>matrix <span class="op">=</span> confusion_matrix(y_test, y_test_predict)</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Accuracy:"</span>)</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>accuracy_score(y_test, y_test_predict)<span class="sc">:.0%}</span><span class="ss">"</span>)</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Matrice de confusion:"</span>)</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(matrix)</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<details>
<summary>
Modification de <code>api/main.py</code> à effectuer
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>api/main.py</strong></pre>
</div>
<div class="sourceCode" id="cb73" data-filename="api/main.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""A simple API to expose our trained RandomForest model for Tutanic survival."""</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastapi <span class="im">import</span> FastAPI</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> load</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="co"># GET PRODUCTION MODEL -------------</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>username_sspcloud <span class="op">=</span> <span class="st">"lgaliana"</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="ss">f"https://minio.lab.sspcloud.fr/</span><span class="sc">{</span>username_sspcloud<span class="sc">}</span><span class="ss">/ensae-reproductibilite/model/model.joblib"</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>local_filename <span class="op">=</span> <span class="st">"model.joblib"</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(local_filename, mode <span class="op">=</span> <span class="st">"wb"</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span>.write(requests.get(url).content)</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> load(local_filename)</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a><span class="co"># USE PRODUCTION MODEL IN APP ----------</span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> FastAPI(</span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Prédiction de survie sur le Titanic"</span>,</span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"&lt;b&gt;Application de prédiction de survie sur le Titanic&lt;/b&gt; 🚢 &lt;br&gt;Une version par API pour faciliter la réutilisation du modèle 🚀"</span> <span class="op">+\</span></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;br&gt;&lt;br&gt;&lt;img src=</span><span class="ch">\"</span><span class="st">https://media.vogue.fr/photos/5faac06d39c5194ff9752ec9/1:1/w_2404,h_2404,c_limit/076_CHL_126884.jpg</span><span class="ch">\"</span><span class="st"> width=</span><span class="ch">\"</span><span class="st">200</span><span class="ch">\"</span><span class="st">&gt;"</span></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">"/"</span>, tags<span class="op">=</span>[<span class="st">"Welcome"</span>])</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_welcome_page():</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a><span class="co">    Show welcome page with model name and version.</span></span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Message"</span>: <span class="st">"API de prédiction de survie sur le Titanic"</span>,</span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Model_name"</span>: <span class="st">'Titanic ML'</span>,</span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Model_version"</span>: <span class="st">"0.1"</span>,</span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">"/predict"</span>, tags<span class="op">=</span>[<span class="st">"Predict"</span>])</span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> predict(</span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a>    pclass: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>,</span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a>    sex: <span class="bu">str</span> <span class="op">=</span> <span class="st">"female"</span>,</span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a>    age: <span class="bu">float</span> <span class="op">=</span> <span class="fl">29.0</span>,</span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a>    sib_sp: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a>    parch: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a>    fare: <span class="bu">float</span> <span class="op">=</span> <span class="fl">16.5</span>,</span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a>    embarked: <span class="bu">str</span> <span class="op">=</span> <span class="st">"S"</span>,</span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a>    has_cabin: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a>    ticket_len: <span class="bu">int</span> <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-59"><a href="#cb73-59" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb73-60"><a href="#cb73-60" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb73-61"><a href="#cb73-61" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Pclass"</span>: [pclass],</span>
<span id="cb73-62"><a href="#cb73-62" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Sex"</span>: [sex],</span>
<span id="cb73-63"><a href="#cb73-63" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Age"</span>: [age],</span>
<span id="cb73-64"><a href="#cb73-64" aria-hidden="true" tabindex="-1"></a>            <span class="st">"SibSp"</span>: [sib_sp],</span>
<span id="cb73-65"><a href="#cb73-65" aria-hidden="true" tabindex="-1"></a>            <span class="st">"parch"</span>: [parch],</span>
<span id="cb73-66"><a href="#cb73-66" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Fare"</span>: [fare],</span>
<span id="cb73-67"><a href="#cb73-67" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Embarked"</span>: [embarked],</span>
<span id="cb73-68"><a href="#cb73-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">"hasCabin"</span>: [has_cabin],</span>
<span id="cb73-69"><a href="#cb73-69" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Ticket_Len"</span>: [ticket_len] </span>
<span id="cb73-70"><a href="#cb73-70" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb73-71"><a href="#cb73-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-72"><a href="#cb73-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-73"><a href="#cb73-73" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> <span class="st">"Survived 🎉"</span> <span class="cf">if</span> <span class="bu">int</span>(model.predict(df)) <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">"Dead ⚰️"</span></span>
<span id="cb73-74"><a href="#cb73-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-75"><a href="#cb73-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prediction</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ol start="2" type="1">
<li>Tester votre script <code>train.py</code> et uploader le meilleur modèle sur S3 de la manière suivante:</li>
</ol>
<div id="16a319db" class="cell" data-file="terminal" data-execution_count="10">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode cell-code" id="annotated-cell-154" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-154" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-154-1" class="code-annotation-target"><a href="#annotated-cell-154-1" aria-hidden="true" tabindex="-1"></a>mc cp model.joblib s3<span class="op">/&lt;</span>BUCKET_PERSONNEL<span class="op">&gt;/</span>ensae<span class="op">-</span>reproductibilite<span class="op">/</span>model<span class="op">/</span>model.joblib</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-154" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-154-2" class="code-annotation-target"><a href="#annotated-cell-154-2" aria-hidden="true" tabindex="-1"></a>mc anonymous <span class="bu">set</span> download s3<span class="op">/&lt;</span>BUCKET_PERSONNEL<span class="op">&gt;/</span>ensae<span class="op">-</span>reproductibilite<span class="op">/</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-154" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-154" data-code-lines="1" data-code-annotation="1"><em>Uploader</em> sur <code>S3</code></span>
</dd>
<dt data-target-cell="annotated-cell-154" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-154" data-code-lines="2" data-code-annotation="2">Ouvrir les droits en lecture de ce fichier pour simplifier la récupération<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a></span>
</dd>
</dl>
</div>
</div>
<p>où <code>&lt;BUCKET_PERSONNEL&gt;</code> est à remplacer par votre nom d’utilisateur sur le SSPCloud</p>
<ol start="3" type="1">
<li><p>Tester en local <code>api/main.py</code> pour vérifier le caractère fonctionnel de l’API. Les deux modifications principales de celle-ci sont les suivantes:</p>
<ul>
<li>On n’utilise plus la variable <code>Title</code> puisque celle-ci a été retirée des données en entrée du modèle</li>
<li>On récupère la version de “production” sur le système de stockage S3, on ne fait plus l’entraînement à chaque initialisation d’un conteneur</li>
</ul></li>
<li><p>Modifier <code>deployment/deployment.yaml</code> et <code>.github/workflows/prod.yaml</code> pour définir et utiliser le tag <code>v0.0.3</code> de l’image <code>Docker</code></p></li>
<li><p>Retirer la ligne <code>python train.py</code> du fichier <code>run.sh</code></p></li>
<li><p>Dans <code>index.qmd</code>, remplacer la ligne suivante:</p></li>
</ol>
<div class="sourceCode" id="cb74" data-code-line-numbers=""><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="in">prediction = `https://titanic.kub.sspcloud.fr/predict?pclass=${class_boat}&amp;sex=${gender}&amp;age=${age}&amp;sib_sp=1&amp;parch=1&amp;fare=16.5&amp;embarked=S&amp;has_cabin=1&amp;ticket_len=7`</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>par celle-ci</p>
<div class="sourceCode" id="cb75" data-code-line-numbers=""><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{ojs}</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="in">prediction = `https://titanic.kub.sspcloud.fr/predict?pclass=${class_boat}&amp;sex=${gender}&amp;age=${age}&amp;sib_sp=1&amp;parch=1&amp;fare=16.5&amp;embarked=S&amp;has_cabin=1&amp;ticket_len=7`</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Faire un <em>commit</em> et un <em>push</em> des modifications</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-69-contents" aria-controls="callout-69" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-69" class="callout-69-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-162" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-162" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-162-1" class="code-annotation-target"><a href="#annotated-cell-162-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-162-2"><a href="#annotated-cell-162-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli21</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-162" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-162" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="garder-une-trace-des-entraînements-de-notre-modèle-grâce-au-register-de-mlflow" class="level2">
<h2 class="anchored" data-anchor-id="garder-une-trace-des-entraînements-de-notre-modèle-grâce-au-register-de-mlflow">Garder une trace des entraînements de notre modèle grâce au <em>register</em> de <code>MLFlow</code></h2>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-70-contents" aria-controls="callout-70" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Si vous prenez ce projet fil rouge en cours de route
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-70" class="callout-70-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb76" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli21</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout <span class="at">-b</span> dev</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git push origin dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 22 : archiver nos entraînements avec <code>MLFlow</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>Lancer <code>MLFlow</code> depuis l’onflet <a href="https://datalab.sspcloud.fr/catalog/automation">Mes services</a> du SSPCloud. Attendre que le service soit bien lancé. Cela créera un service dont l’URL est de la forme <code>https://user-{username}-{pod_id}.user.lab.sspcloud.fr</code>, où <code>pod_id</code> est un identifiant aléatoire. Ce service <code>MLFlow</code> communiquera avec les <code>VSCode</code> que vous ouvrirez ultérieurement à partir de cet URL ainsi qu’avec le système de stockage <code>S3</code><a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a>.</p></li>
<li><p>Regarder la page <code>Experiments</code>. Elle est vide à ce stade, c’est normal</p></li>
</ol>
<ol start="2" type="1">
<li><p>Une fois le service <code>MLFlow</code> fonctionnel, lancer un nouveau <code>VSCode</code> pour bénéficier de la configuration automatisée</p></li>
<li><p>Clôner votre projet, vous situer sur la branche de travail (nous supposerons qu’il s’agit de <code>dev</code>).</p></li>
<li><p>Depuis un terminal <code>Python</code>, lancer les commandes suivantes:</p></li>
</ol>
<div class="sourceCode" id="cb77" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>mlflow_experiment_name <span class="op">=</span> <span class="st">"titanicml"</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(experiment_name<span class="op">=</span>mlflow_experiment_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Retourner sur l’UI et observer la différence, à gauche.</p>
<ol start="5" type="1">
<li>Créer un fichier <code>src/models/log.py</code></li>
</ol>
<details>
<summary>
Contenu du fichier <code>src/models/log.py</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/models/log.py</strong></pre>
</div>
<div class="sourceCode" id="cb78" data-filename="src/models/log.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_gsvc_to_mlflow(</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    gscv, mlflow_experiment_name, application_number: <span class="bu">str</span> <span class="op">=</span> <span class="st">"appli21"</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Log a scikit-learn trained GridSearchCV object as an MLflow experiment."""</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set up MLFlow context</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    mlflow.set_experiment(experiment_name<span class="op">=</span>mlflow_experiment_name)</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> run_idx <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(gscv.cv_results_[<span class="st">"params"</span>])):</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each hyperparameter combination we trained the model with, we log a run in MLflow</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>        run_name <span class="op">=</span> <span class="ss">f"run </span><span class="sc">{</span>run_idx<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span>run_name):</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Log hyperparameters</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>            params <span class="op">=</span> gscv.cv_results_[<span class="st">"params"</span>][run_idx]</span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> param <span class="kw">in</span> params:</span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>                mlflow.log_param(param, params[param])</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Log fit metrics</span></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> [</span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>                score</span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> score <span class="kw">in</span> gscv.cv_results_</span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">"mean_test"</span> <span class="kw">in</span> score <span class="kw">or</span> <span class="st">"std_test"</span> <span class="kw">in</span> score</span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> score <span class="kw">in</span> scores:</span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>                mlflow.log_metric(score, gscv.cv_results_[score][run_idx])</span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Log model as an artifact</span></span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a>            mlflow.sklearn.log_model(gscv, <span class="st">"gscv_model"</span>)</span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Log training data URL</span></span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a>            mlflow.log_param(<span class="st">"appli"</span>, application_number)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ol start="6" type="1">
<li>Modifier le fichier <code>train.py</code> pour ajouter la ligne</li>
</ol>
<div class="sourceCode" id="cb79" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>mlog.log_gsvc_to_mlflow(pipe_cross_validation, EXPERIMENT_NAME, APPLI_ID)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>avec</p>
<div class="sourceCode" id="cb80" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> src.models.log <span class="im">as</span> mlog</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="7" type="1">
<li>Faire tourner avec le paramètre <code>--appli appli22</code>:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb81" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python train.py <span class="at">--appli</span> appli22</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="8" type="1">
<li><p>Observer l’évolution de la page <code>Experiments</code>. Cliquer sur un des <em>run</em>. Observer toutes les métadonnées archivées (hyperparamètres, métriques d’évaluation, <code>requirements.txt</code> dont <code>MLFlow</code> a fait l’inférence, etc.)</p></li>
<li><p>Observer le code proposé par <code>MLFlow</code> pour récupérer le <em>run</em> en question. Modifier le fichier <code>eval.py</code> à partir de cet exemple et du modèle suivant pour utiliser un des modèles archivés dans <code>MLFlow</code></p></li>
<li><p>Retourner à la liste des <em>runs</em> en cliquant à nouveau sur <em>“titanicml”</em> dans les expérimentations</p></li>
<li><p>Dans l’onglet <code>Table</code>, sélectionner plusieurs expérimentations, cliquer sur <code>Columns</code> et ajouter <code>mean_test_f1</code>. Ajuster la taille des colonnes pour la voir et classer les modèles par score décroissants</p></li>
<li><p>Cliquer sur <code>Compare</code> après en avoir sélectionné plusieurs. Afficher un <em>scatterplot</em> des performances en fonction du nombre d’estimateurs. Conclure.</p></li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-72-contents" aria-controls="callout-72" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-72" class="callout-72-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-172" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-172" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-172-1" class="code-annotation-target"><a href="#annotated-cell-172-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-172-2"><a href="#annotated-cell-172-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli22</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-172" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-172" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>Cette appplication illustre l’un des premiers apports de <code>MLFlow</code>: on garde une trace de nos expérimentations et on peut déjà mieux comprendre la manière dont certains paramètres de notre modèle peuvent influencer la qualité de nos prédictions.</p>
<p>Néanmoins, persistent un certain nombre de voies d’amélioration:</p>
<ul>
<li>On entraîne le modèle en local, de manière séquentielle, et en lançant nous-mêmes le script <code>train.py</code></li>
<li>On n’archive pas les jeux de données associés à ces modèles (les jeux d’entraînement et de test). On doit alors le faire manuellement si on désire évaluer les performances <em>ex post</em>, ce qui est pénible.</li>
<li>On récupère manuellement les modèles ce qui n’est pas très pérenne.</li>
<li>Notre API n’utilise pas encore l’un des modèles archivé sur <code>MLFlow</code>.</li>
</ul>
<p>Les prochaines applications permettront d’améliorer ceci.</p>
<section id="mise-en-production-dun-modèle" class="level3">
<h3 class="anchored" data-anchor-id="mise-en-production-dun-modèle">Mise en production d’un modèle</h3>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 23a : réutiliser un modèle archivé sur MLFlow
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>A partir du tableau de performance précédent, choisir le modèle avec le F1 score maximal. Accéder à celui-ci.</li>
</ol>
<p>Créer un script dans <code>mlflow/predict.py</code> pour illustrer l’utilisation d’un modèle depuis MLFlow. Nous allons progressivement l’améliorer.</p>
<ol type="1">
<li>Copier-coller le contenu ci-dessous afin de se simplifier la création de données en entrée de notre code</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>mlflow/predict.py</strong></pre>
</div>
<div class="sourceCode" id="cb82" data-filename="mlflow/predict.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_data(</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    pclass: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>,</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    sex: <span class="bu">str</span> <span class="op">=</span> <span class="st">"female"</span>,</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    age: <span class="bu">float</span> <span class="op">=</span> <span class="fl">29.0</span>,</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    sib_sp: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>    parch: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>    fare: <span class="bu">float</span> <span class="op">=</span> <span class="fl">16.5</span>,</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    embarked: <span class="bu">str</span> <span class="op">=</span> <span class="st">"S"</span>,</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    has_cabin: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    ticket_len: <span class="bu">int</span> <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Pclass"</span>: [pclass],</span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Sex"</span>: [sex],</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Age"</span>: [age],</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"SibSp"</span>: [sib_sp],</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"parch"</span>: [parch],</span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Fare"</span>: [fare],</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Embarked"</span>: [embarked],</span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">"hasCabin"</span>: [has_cabin],</span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Ticket_Len"</span>: [ticket_len] </span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.concat([</span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a>    create_data(),</span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a>    create_data(sex<span class="op">=</span><span class="st">"male"</span>)</span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Cliquer sur votre meilleur modèle et introduire dans <code>mlflow/predict.py</code> le morceau de code suggéré par <code>MLFlow</code>, du type de celui-ci:</li>
</ol>
<div id="f3e9bbde" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="annotated-cell-174" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-174-1"><a href="#annotated-cell-174-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-174" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-174-2" class="code-annotation-target"><a href="#annotated-cell-174-2" aria-hidden="true" tabindex="-1"></a>logged_model <span class="op">=</span> <span class="co">#A CHANGER</span></span>
<span id="annotated-cell-174-3"><a href="#annotated-cell-174-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-174-4"><a href="#annotated-cell-174-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load model as a PyFuncModel.</span></span>
<span id="annotated-cell-174-5"><a href="#annotated-cell-174-5" aria-hidden="true" tabindex="-1"></a>loaded_model <span class="op">=</span> mlflow.pyfunc.load_model(logged_model)</span>
<span id="annotated-cell-174-6"><a href="#annotated-cell-174-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-174-7"><a href="#annotated-cell-174-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict on a Pandas DataFrame.</span></span>
<span id="annotated-cell-174-8"><a href="#annotated-cell-174-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="annotated-cell-174-9"><a href="#annotated-cell-174-9" aria-hidden="true" tabindex="-1"></a>loaded_model.predict(pd.DataFrame(data))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-174" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-174" data-code-lines="2" data-code-annotation="1"><em>Hash</em> du modèle</span>
</dd>
</dl>
</div>
</div>
<p>Lancer depuis la ligne de commande ce script et observer l’application obtenue.</p>
</div>
</div>
<p>A ce stade, nous avons amélioré la fiabilité de notre modèle car nous utilisons le meilleur. Néanmoins, celui-ci n’est pas forcément pratique à récupérer car nous utilisons un <em>hash</em> qui certes identifie de manière unique notre modèle mais présente l’inconvénient d’être peu intelligible. Nous allons passer de l’expérimentation à la mise en production en sélectionnant explicitement notre meilleur modèle.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 23b : passer en production un modèle
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Dans la page du modèle en question sur <code>MLFlow</code>, cliquer sur <code>Register model</code> et le nommer <code>titanic</code>.</li>
<li>Aller dans l’onglet <code>Models</code> et observer le changement par rapport à précédemment.</li>
<li>Mettre à jour le code dans <code>mlflow/predict.py</code> pour utiliser la version en production :</li>
</ol>
<p><code>{.python filename = "mlflow/predict.py"} model_name = "titanic" model_version = 1 loaded_model = mlflow.pyfunc.load_model(     model_uri=f"models:/{model_name}/{model_version}" )</code></p>
<ol start="4" type="1">
<li><p>Tester cette application. Si celle-ci fonctionne, modifier la récupération du modèle dans votre script d’API.</p></li>
<li><p>Tester en local cette API mise à jour</p></li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<pre class="shell" data-filename="terminal" data-code-line-numbers=""><code>uvicorn api.main:app --reload --host "0.0.0.0" --port 5000</code></pre>
</div>
<ol start="6" type="1">
<li><p>Ajouter <code>mlflow</code> au <code>requirements.txt</code></p></li>
<li><p>Mettre à jour les fichiers <code>.github/worflows/prod.yaml</code> et <code>kubernetes/deployment.yaml</code> pour produire et utiliser le tag <code>v0.0.5</code></p></li>
</ol>
<div id="5b2a7cdc" class="cell" data-file=".github/worflows/prod.yaml" data-execution_count="12">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.github/worflows/prod.yaml</strong></pre>
</div>
<div class="sourceCode cell-code" id="annotated-cell-177" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-177-1"><a href="#annotated-cell-177-1" aria-hidden="true" tabindex="-1"></a>name: Construction image Docker</span>
<span id="annotated-cell-177-2"><a href="#annotated-cell-177-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-177-3"><a href="#annotated-cell-177-3" aria-hidden="true" tabindex="-1"></a>on:</span>
<span id="annotated-cell-177-4"><a href="#annotated-cell-177-4" aria-hidden="true" tabindex="-1"></a>  push:</span>
<span id="annotated-cell-177-5"><a href="#annotated-cell-177-5" aria-hidden="true" tabindex="-1"></a>    branches:</span>
<span id="annotated-cell-177-6"><a href="#annotated-cell-177-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> main</span>
<span id="annotated-cell-177-7"><a href="#annotated-cell-177-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> dev</span>
<span id="annotated-cell-177-8"><a href="#annotated-cell-177-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-177-9"><a href="#annotated-cell-177-9" aria-hidden="true" tabindex="-1"></a>jobs:</span>
<span id="annotated-cell-177-10"><a href="#annotated-cell-177-10" aria-hidden="true" tabindex="-1"></a>  docker:</span>
<span id="annotated-cell-177-11"><a href="#annotated-cell-177-11" aria-hidden="true" tabindex="-1"></a>    runs<span class="op">-</span>on: ubuntu<span class="op">-</span>latest</span>
<span id="annotated-cell-177-12"><a href="#annotated-cell-177-12" aria-hidden="true" tabindex="-1"></a>    steps:</span>
<span id="annotated-cell-177-13"><a href="#annotated-cell-177-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span></span>
<span id="annotated-cell-177-14"><a href="#annotated-cell-177-14" aria-hidden="true" tabindex="-1"></a>        name: Set up QEMU</span>
<span id="annotated-cell-177-15"><a href="#annotated-cell-177-15" aria-hidden="true" tabindex="-1"></a>        uses: docker<span class="op">/</span>setup<span class="op">-</span>qemu<span class="op">-</span>action<span class="op">@</span>v3</span>
<span id="annotated-cell-177-16"><a href="#annotated-cell-177-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span></span>
<span id="annotated-cell-177-17"><a href="#annotated-cell-177-17" aria-hidden="true" tabindex="-1"></a>        name: Set up Docker Buildx</span>
<span id="annotated-cell-177-18"><a href="#annotated-cell-177-18" aria-hidden="true" tabindex="-1"></a>        uses: docker<span class="op">/</span>setup<span class="op">-</span>buildx<span class="op">-</span>action<span class="op">@</span>v3</span>
<span id="annotated-cell-177-19"><a href="#annotated-cell-177-19" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span></span>
<span id="annotated-cell-177-20"><a href="#annotated-cell-177-20" aria-hidden="true" tabindex="-1"></a>        name: Login to Docker Hub</span>
<span id="annotated-cell-177-21"><a href="#annotated-cell-177-21" aria-hidden="true" tabindex="-1"></a>        uses: docker<span class="op">/</span>login<span class="op">-</span>action<span class="op">@</span>v3</span>
<span id="annotated-cell-177-22"><a href="#annotated-cell-177-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span>:</span>
<span id="annotated-cell-177-23"><a href="#annotated-cell-177-23" aria-hidden="true" tabindex="-1"></a>          username: ${{ secrets.DOCKERHUB_USERNAME }}</span>
<span id="annotated-cell-177-24"><a href="#annotated-cell-177-24" aria-hidden="true" tabindex="-1"></a>          password: ${{ secrets.DOCKERHUB_TOKEN }}</span>
<span id="annotated-cell-177-25"><a href="#annotated-cell-177-25" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span></span>
<span id="annotated-cell-177-26"><a href="#annotated-cell-177-26" aria-hidden="true" tabindex="-1"></a>        name: Build <span class="kw">and</span> push</span>
<span id="annotated-cell-177-27"><a href="#annotated-cell-177-27" aria-hidden="true" tabindex="-1"></a>        uses: docker<span class="op">/</span>build<span class="op">-</span>push<span class="op">-</span>action<span class="op">@</span>v5</span>
<span id="annotated-cell-177-28"><a href="#annotated-cell-177-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span>:</span>
<span id="annotated-cell-177-29"><a href="#annotated-cell-177-29" aria-hidden="true" tabindex="-1"></a>          push: true</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-177" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-177-30" class="code-annotation-target"><a href="#annotated-cell-177-30" aria-hidden="true" tabindex="-1"></a>          tags: linogaliana<span class="op">/</span>application<span class="op">-</span>correction:v0<span class="fl">.0.7</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-177" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-177" data-code-lines="30" data-code-annotation="1">Modifier l’image ici</span>
</dd>
</dl>
</div>
</div>
<div id="a69f5e02" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="annotated-cell-178" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-178-1"><a href="#annotated-cell-178-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating MLflow deployment</span></span>
<span id="annotated-cell-178-2"><a href="#annotated-cell-178-2" aria-hidden="true" tabindex="-1"></a>apiVersion: apps<span class="op">/</span>v1</span>
<span id="annotated-cell-178-3"><a href="#annotated-cell-178-3" aria-hidden="true" tabindex="-1"></a>kind: Deployment</span>
<span id="annotated-cell-178-4"><a href="#annotated-cell-178-4" aria-hidden="true" tabindex="-1"></a>metadata:</span>
<span id="annotated-cell-178-5"><a href="#annotated-cell-178-5" aria-hidden="true" tabindex="-1"></a>  name: titanicml</span>
<span id="annotated-cell-178-6"><a href="#annotated-cell-178-6" aria-hidden="true" tabindex="-1"></a>spec:</span>
<span id="annotated-cell-178-7"><a href="#annotated-cell-178-7" aria-hidden="true" tabindex="-1"></a>  replicas: <span class="dv">1</span></span>
<span id="annotated-cell-178-8"><a href="#annotated-cell-178-8" aria-hidden="true" tabindex="-1"></a>  selector:</span>
<span id="annotated-cell-178-9"><a href="#annotated-cell-178-9" aria-hidden="true" tabindex="-1"></a>    matchLabels:</span>
<span id="annotated-cell-178-10"><a href="#annotated-cell-178-10" aria-hidden="true" tabindex="-1"></a>      app: titanicml</span>
<span id="annotated-cell-178-11"><a href="#annotated-cell-178-11" aria-hidden="true" tabindex="-1"></a>  template:</span>
<span id="annotated-cell-178-12"><a href="#annotated-cell-178-12" aria-hidden="true" tabindex="-1"></a>    metadata:</span>
<span id="annotated-cell-178-13"><a href="#annotated-cell-178-13" aria-hidden="true" tabindex="-1"></a>      labels:</span>
<span id="annotated-cell-178-14"><a href="#annotated-cell-178-14" aria-hidden="true" tabindex="-1"></a>        app: titanicml</span>
<span id="annotated-cell-178-15"><a href="#annotated-cell-178-15" aria-hidden="true" tabindex="-1"></a>    spec:</span>
<span id="annotated-cell-178-16"><a href="#annotated-cell-178-16" aria-hidden="true" tabindex="-1"></a>      containers:</span>
<span id="annotated-cell-178-17"><a href="#annotated-cell-178-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> name: api</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-178" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-178-18" class="code-annotation-target"><a href="#annotated-cell-178-18" aria-hidden="true" tabindex="-1"></a>          image: linogaliana<span class="op">/</span>application<span class="op">-</span>correction:v0<span class="fl">.0.7</span></span>
<span id="annotated-cell-178-19"><a href="#annotated-cell-178-19" aria-hidden="true" tabindex="-1"></a>          imagePullPolicy: Always</span>
<span id="annotated-cell-178-20"><a href="#annotated-cell-178-20" aria-hidden="true" tabindex="-1"></a>          env:</span>
<span id="annotated-cell-178-21"><a href="#annotated-cell-178-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span> name: MLFLOW_TRACKING_URI</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-178" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-178-22" class="code-annotation-target"><a href="#annotated-cell-178-22" aria-hidden="true" tabindex="-1"></a>              value: https:<span class="op">//</span>user<span class="op">-</span>{USERNAME}<span class="op">-</span>mlflow.user.lab.sspcloud.fr</span>
<span id="annotated-cell-178-23"><a href="#annotated-cell-178-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span> name: MLFLOW_MODEL_NAME</span>
<span id="annotated-cell-178-24"><a href="#annotated-cell-178-24" aria-hidden="true" tabindex="-1"></a>              value: titanic</span>
<span id="annotated-cell-178-25"><a href="#annotated-cell-178-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span> name: MLFLOW_MODEL_VERSION</span>
<span id="annotated-cell-178-26"><a href="#annotated-cell-178-26" aria-hidden="true" tabindex="-1"></a>              value: <span class="st">"1"</span></span>
<span id="annotated-cell-178-27"><a href="#annotated-cell-178-27" aria-hidden="true" tabindex="-1"></a>          resources:</span>
<span id="annotated-cell-178-28"><a href="#annotated-cell-178-28" aria-hidden="true" tabindex="-1"></a>            limits:</span>
<span id="annotated-cell-178-29"><a href="#annotated-cell-178-29" aria-hidden="true" tabindex="-1"></a>              memory: <span class="st">"2Gi"</span></span>
<span id="annotated-cell-178-30"><a href="#annotated-cell-178-30" aria-hidden="true" tabindex="-1"></a>              cpu: <span class="st">"1000m"</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-178" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-178" data-code-lines="18" data-code-annotation="1">Modifier l’image <code>Docker</code></span>
</dd>
<dt data-target-cell="annotated-cell-178" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-178" data-code-lines="22" data-code-annotation="2">Modifier l’URL de <code>MLFlow</code></span>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-75-contents" aria-controls="callout-75" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-75" class="callout-75-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-180" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-180" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-180-1" class="code-annotation-target"><a href="#annotated-cell-180-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-180-2"><a href="#annotated-cell-180-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli23</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-180" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-180" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="industrialiser-les-entraînements-de-nos-modèles" class="level3">
<h3 class="anchored" data-anchor-id="industrialiser-les-entraînements-de-nos-modèles">Industrialiser les entraînements de nos modèles</h3>
<p>Pour industrialiser nos entraînements, nous allons créer des processus parallèles indépendants pour chaque combinaison de nos hyperparamètres. Pour cela, l’outil pratique sur le SSPCloud est <code>Argo workflows</code>. Chaque combinaison d’hyperparamètres sera un processus isolé à l’issue duquel sera loggué le résultat dans <code>MLFlow</code>. Ces entraînements auront lieu en parallèle.</p>
<p><img src="https://inseefrlab.github.io/formation-mlops/slides/img/pokemon_workflow.png" class="img-fluid"></p>
<ol type="1">
<li>Lancer un service Argo Workflows</li>
<li>Dans <code>mlflow/training.yaml</code></li>
</ol>
<div id="2c5c354b" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="annotated-cell-8" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-8-1"><a href="#annotated-cell-8-1" aria-hidden="true" tabindex="-1"></a>apiVersion: argoproj.io<span class="op">/</span>v1alpha1</span>
<span id="annotated-cell-8-2"><a href="#annotated-cell-8-2" aria-hidden="true" tabindex="-1"></a>kind: Workflow</span>
<span id="annotated-cell-8-3"><a href="#annotated-cell-8-3" aria-hidden="true" tabindex="-1"></a>metadata:</span>
<span id="annotated-cell-8-4"><a href="#annotated-cell-8-4" aria-hidden="true" tabindex="-1"></a>  generateName: titanic<span class="op">-</span>training<span class="op">-</span>workflow<span class="op">-</span></span>
<span id="annotated-cell-8-5"><a href="#annotated-cell-8-5" aria-hidden="true" tabindex="-1"></a>spec:</span>
<span id="annotated-cell-8-6"><a href="#annotated-cell-8-6" aria-hidden="true" tabindex="-1"></a>  entrypoint: main</span>
<span id="annotated-cell-8-7"><a href="#annotated-cell-8-7" aria-hidden="true" tabindex="-1"></a>  arguments:</span>
<span id="annotated-cell-8-8"><a href="#annotated-cell-8-8" aria-hidden="true" tabindex="-1"></a>    parameters:</span>
<span id="annotated-cell-8-9"><a href="#annotated-cell-8-9" aria-hidden="true" tabindex="-1"></a>      <span class="co"># The MLflow tracking server is responsible to log the hyper-parameter and model metrics.</span></span>
<span id="annotated-cell-8-10"><a href="#annotated-cell-8-10" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> name: mlflow<span class="op">-</span>tracking<span class="op">-</span>uri</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-8-11" class="code-annotation-target"><a href="#annotated-cell-8-11" aria-hidden="true" tabindex="-1"></a>        value: https:<span class="op">//</span>user<span class="op">-</span>lgaliana<span class="op">-</span>argo<span class="op">-</span>workflows.user.lab.sspcloud.fr</span>
<span id="annotated-cell-8-12"><a href="#annotated-cell-8-12" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> name: mlflow<span class="op">-</span>experiment<span class="op">-</span>name</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-8-13" class="code-annotation-target"><a href="#annotated-cell-8-13" aria-hidden="true" tabindex="-1"></a>        value: titanicml</span>
<span id="annotated-cell-8-14"><a href="#annotated-cell-8-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> name: model<span class="op">-</span>training<span class="op">-</span>conf<span class="op">-</span><span class="bu">list</span></span>
<span id="annotated-cell-8-15"><a href="#annotated-cell-8-15" aria-hidden="true" tabindex="-1"></a>        value: <span class="op">|</span></span>
<span id="annotated-cell-8-16"><a href="#annotated-cell-8-16" aria-hidden="true" tabindex="-1"></a>          [</span>
<span id="annotated-cell-8-17"><a href="#annotated-cell-8-17" aria-hidden="true" tabindex="-1"></a>            { <span class="st">"dim"</span>: <span class="dv">25</span>, <span class="st">"lr"</span>: <span class="fl">0.1</span> },</span>
<span id="annotated-cell-8-18"><a href="#annotated-cell-8-18" aria-hidden="true" tabindex="-1"></a>            { <span class="st">"dim"</span>: <span class="dv">100</span>, <span class="st">"lr"</span>: <span class="fl">0.2</span> },</span>
<span id="annotated-cell-8-19"><a href="#annotated-cell-8-19" aria-hidden="true" tabindex="-1"></a>            { <span class="st">"dim"</span>: <span class="dv">150</span>, <span class="st">"lr"</span>: <span class="fl">0.3</span> }</span>
<span id="annotated-cell-8-20"><a href="#annotated-cell-8-20" aria-hidden="true" tabindex="-1"></a>          ]</span>
<span id="annotated-cell-8-21"><a href="#annotated-cell-8-21" aria-hidden="true" tabindex="-1"></a>  templates:</span>
<span id="annotated-cell-8-22"><a href="#annotated-cell-8-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Entrypoint DAG template</span></span>
<span id="annotated-cell-8-23"><a href="#annotated-cell-8-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> name: main</span>
<span id="annotated-cell-8-24"><a href="#annotated-cell-8-24" aria-hidden="true" tabindex="-1"></a>      dag:</span>
<span id="annotated-cell-8-25"><a href="#annotated-cell-8-25" aria-hidden="true" tabindex="-1"></a>        tasks:</span>
<span id="annotated-cell-8-26"><a href="#annotated-cell-8-26" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Task 0: Start pipeline</span></span>
<span id="annotated-cell-8-27"><a href="#annotated-cell-8-27" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: start<span class="op">-</span>pipeline</span>
<span id="annotated-cell-8-28"><a href="#annotated-cell-8-28" aria-hidden="true" tabindex="-1"></a>            template: start<span class="op">-</span>pipeline<span class="op">-</span>wt</span>
<span id="annotated-cell-8-29"><a href="#annotated-cell-8-29" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Task 1: Train model with given params</span></span>
<span id="annotated-cell-8-30"><a href="#annotated-cell-8-30" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: train<span class="op">-</span>model<span class="op">-</span><span class="cf">with</span><span class="op">-</span>params</span>
<span id="annotated-cell-8-31"><a href="#annotated-cell-8-31" aria-hidden="true" tabindex="-1"></a>            dependencies: [ start<span class="op">-</span>pipeline ]</span>
<span id="annotated-cell-8-32"><a href="#annotated-cell-8-32" aria-hidden="true" tabindex="-1"></a>            template: run<span class="op">-</span>model<span class="op">-</span>training<span class="op">-</span>wt</span>
<span id="annotated-cell-8-33"><a href="#annotated-cell-8-33" aria-hidden="true" tabindex="-1"></a>            arguments:</span>
<span id="annotated-cell-8-34"><a href="#annotated-cell-8-34" aria-hidden="true" tabindex="-1"></a>              parameters:</span>
<span id="annotated-cell-8-35"><a href="#annotated-cell-8-35" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span> name: dim</span>
<span id="annotated-cell-8-36"><a href="#annotated-cell-8-36" aria-hidden="true" tabindex="-1"></a>                  value: <span class="st">"</span><span class="sc">{{</span><span class="st">item.dim</span><span class="sc">}}</span><span class="st">"</span></span>
<span id="annotated-cell-8-37"><a href="#annotated-cell-8-37" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span> name: lr</span>
<span id="annotated-cell-8-38"><a href="#annotated-cell-8-38" aria-hidden="true" tabindex="-1"></a>                  value: <span class="st">"</span><span class="sc">{{</span><span class="st">item.lr</span><span class="sc">}}</span><span class="st">"</span></span>
<span id="annotated-cell-8-39"><a href="#annotated-cell-8-39" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Pass the inputs to the task using "withParam"</span></span>
<span id="annotated-cell-8-40"><a href="#annotated-cell-8-40" aria-hidden="true" tabindex="-1"></a>            withParam: <span class="st">"</span><span class="sc">{{</span><span class="st">workflow.parameters.model-training-conf-list</span><span class="sc">}}</span><span class="st">"</span></span>
<span id="annotated-cell-8-41"><a href="#annotated-cell-8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-42"><a href="#annotated-cell-8-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Now task container templates are defined</span></span>
<span id="annotated-cell-8-43"><a href="#annotated-cell-8-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Worker template for task 0 : start-pipeline</span></span>
<span id="annotated-cell-8-44"><a href="#annotated-cell-8-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> name: start<span class="op">-</span>pipeline<span class="op">-</span>wt</span>
<span id="annotated-cell-8-45"><a href="#annotated-cell-8-45" aria-hidden="true" tabindex="-1"></a>      inputs:</span>
<span id="annotated-cell-8-46"><a href="#annotated-cell-8-46" aria-hidden="true" tabindex="-1"></a>      container:</span>
<span id="annotated-cell-8-47"><a href="#annotated-cell-8-47" aria-hidden="true" tabindex="-1"></a>        image: busybox</span>
<span id="annotated-cell-8-48"><a href="#annotated-cell-8-48" aria-hidden="true" tabindex="-1"></a>        command: [ sh, <span class="op">-</span>c ]</span>
<span id="annotated-cell-8-49"><a href="#annotated-cell-8-49" aria-hidden="true" tabindex="-1"></a>        args: [ <span class="st">"echo Starting pipeline"</span> ]</span>
<span id="annotated-cell-8-50"><a href="#annotated-cell-8-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-51"><a href="#annotated-cell-8-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Worker template for task-1 : train model with params</span></span>
<span id="annotated-cell-8-52"><a href="#annotated-cell-8-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> name: run<span class="op">-</span>model<span class="op">-</span>training<span class="op">-</span>wt</span>
<span id="annotated-cell-8-53"><a href="#annotated-cell-8-53" aria-hidden="true" tabindex="-1"></a>      inputs:</span>
<span id="annotated-cell-8-54"><a href="#annotated-cell-8-54" aria-hidden="true" tabindex="-1"></a>        parameters:</span>
<span id="annotated-cell-8-55"><a href="#annotated-cell-8-55" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: dim</span>
<span id="annotated-cell-8-56"><a href="#annotated-cell-8-56" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: lr</span>
<span id="annotated-cell-8-57"><a href="#annotated-cell-8-57" aria-hidden="true" tabindex="-1"></a>      container:</span>
<span id="annotated-cell-8-58"><a href="#annotated-cell-8-58" aria-hidden="true" tabindex="-1"></a>        image: inseefrlab<span class="op">/</span>formation<span class="op">-</span>mlops:main</span>
<span id="annotated-cell-8-59"><a href="#annotated-cell-8-59" aria-hidden="true" tabindex="-1"></a>        imagePullPolicy: Always</span>
<span id="annotated-cell-8-60"><a href="#annotated-cell-8-60" aria-hidden="true" tabindex="-1"></a>        command: [sh, <span class="op">-</span>c]</span>
<span id="annotated-cell-8-61"><a href="#annotated-cell-8-61" aria-hidden="true" tabindex="-1"></a>        args: [<span class="st">"mlflow run .</span></span>
<span id="annotated-cell-8-62"><a href="#annotated-cell-8-62" aria-hidden="true" tabindex="-1"></a><span class="er">                --env-manager=local</span></span>
<span id="annotated-cell-8-63"><a href="#annotated-cell-8-63" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span>P remote_server_uri<span class="op">=</span>$MLFLOW_TRACKING_URI</span>
<span id="annotated-cell-8-64"><a href="#annotated-cell-8-64" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span>P experiment_name<span class="op">=</span>$MLFLOW_EXPERIMENT_NAME</span>
<span id="annotated-cell-8-65"><a href="#annotated-cell-8-65" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span>P dim<span class="op">=</span>{{inputs.parameters.dim}}</span>
<span id="annotated-cell-8-66"><a href="#annotated-cell-8-66" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span>P lr<span class="op">=</span>{{inputs.parameters.lr}}<span class="st">"]</span></span>
<span id="annotated-cell-8-67"><a href="#annotated-cell-8-67" aria-hidden="true" tabindex="-1"></a><span class="er">        env:</span></span>
<span id="annotated-cell-8-68"><a href="#annotated-cell-8-68" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: MLFLOW_TRACKING_URI</span>
<span id="annotated-cell-8-69"><a href="#annotated-cell-8-69" aria-hidden="true" tabindex="-1"></a>            value: <span class="st">"</span><span class="sc">{{</span><span class="st">workflow.parameters.mlflow-tracking-uri</span><span class="sc">}}</span><span class="st">"</span></span>
<span id="annotated-cell-8-70"><a href="#annotated-cell-8-70" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: MLFLOW_EXPERIMENT_NAME</span>
<span id="annotated-cell-8-71"><a href="#annotated-cell-8-71" aria-hidden="true" tabindex="-1"></a>            value: <span class="st">"</span><span class="sc">{{</span><span class="st">workflow.parameters.mlflow-experiment-name</span><span class="sc">}}</span><span class="st">"</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="11" data-code-annotation="1">Changer</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="13" data-code-annotation="2"><code>titanicml</code></span>
</dd>
</dl>
</div>
</div>
<p>max_depth</p>
<p>max_features “sqrt”, “log2”</p>
</section>
</section>
<section id="pour-aller-plus-loin" class="level2">
<h2 class="anchored" data-anchor-id="pour-aller-plus-loin">Pour aller plus loin</h2>
<p>Créer un service label studio pour évaluer la qualité du modèle</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>L’export dans un script <code>.py</code> a été fait directement depuis <code>VSCode</code>. Comme cela n’est pas vraiment l’objet du cours, nous passons cette étape et fournissons directement le script expurgé du texte intermédiaire. Mais n’oubliez pas que cette démarche, fréquente quand on a démarré sur un <em>notebook</em> et qu’on désire consolider en faisant la transition vers des scripts, nécessite d’être attentif pour ne pas risquer de faire une erreur.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Il est également possible avec <code>VSCode</code> d’exécuter le script ligne à ligne de manière interactive ligne à ligne (<kbd>MAJ</kbd>+<kbd>ENTER</kbd>). Néanmoins, cela nécessite de s’assurer que le <em>working directory</em> de votre console interactive est le bon. Celle-ci se lance selon les paramètres préconfigurés de <code>VSCode</code> et les votres ne sont peut-être pas les mêmes que les notres. Vous pouvez changer le <em>working directory</em> dans le script en utilisant le <em>package</em> <code>os</code> mais peut-être allez vous découvrir ultérieurement qu’il y a de meilleures pratiques…<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Essayez de <em>commit</em> vos changements à chaque étape de l’exercice, c’est une bonne habitude à prendre.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Ici, le jeton d’API n’est pas indispensable pour que le code fonctionne. Afin d’éviter une erreur non nécessaire lorsqu’on automatisera le processus, on peut créer une condition qui vérifie la présence ou non de ce fichier. Le script reste donc reproductible même pour un utilisateur n’ayant pas le fichier <code>secrets.yaml</code>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Il est normal d’avoir des dossiers <code>__pycache__</code> qui traînent en local : ils se créent automatiquement à l’exécution d’un script en <code>Python</code>. Néanmoins, il ne faut pas associer ces fichiers à <code>Git</code>, voilà pourquoi on les ajoute au <code>.gitignore</code>.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Nous proposons ici d’adopter le principe de la <strong>programmation fonctionnelle</strong>. Pour encore fiabiliser un processus, il serait possible d’adopter le paradigme de la <strong>programmation orientée objet (POO)</strong>. Celle-ci est plus rebutante et demande plus de temps au développeur. L’arbitrage coût-avantage est négatif pour notre exemple, nous proposons donc de nous en passer. Néanmoins, pour une mise en production réelle d’un modèle, il est recommandé de l’adopter. C’est d’ailleurs obligatoire avec des <a href="https://pythonds.linogaliana.fr/pipeline-scikit/"><em>pipelines</em> <code>scikit</code></a>.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Attention, les données ont été <em>committées</em> au moins une fois. Les supprimer du dépôt ne les efface pas de l’historique. Si cette erreur arrive, le mieux est de supprimer le dépôt en ligne, créer un nouvel historique <code>Git</code> et partir de celui-ci pour des publications ultérieures sur <code>Github</code>. Néanmoins l’idéal serait de ne pas s’exposer à cela. C’est justement l’objet des bonnes pratiques de ce cours: un <code>.gitignore</code> bien construit et une séparation des environnements de stockage du code et des données seront bien plus efficaces pour vous éviter ces problèmes que tout les conseils de vigilance que vous pourrez trouver ailleurs.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>Lorsqu’on développe du code qui finalement ne s’avère plus nécessaire, on a souvent un cas de conscience à le supprimer et on préfère le mettre de côté. Au final, ce syndrôme de Diogène est mauvais pour la pérennité du projet : on se retrouve à devoir maintenir une base de code qui n’est, en pratique, pas utilisée. Ce n’est pas un problème de supprimer un code ; si finalement celui-ci s’avère utile, on peut le retrouver grâce à l’historique <code>Git</code> et les outils de recherche sur <code>Github</code>. Le <em>package</em> <code>vulture</code> est très pratique pour diagnostiquer les morceaux de code inutiles dans un projet.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>Le fichier <code>__init__.py</code> indique à <code>Python</code> que le dossier est un <em>package</em>. Il permet de proposer certaines configurations lors de l’import du <em>package</em>. Il permet également de contrôler les objets exportés (c’est-à-dire mis à disposition de l’utilisateur) par le <em>package</em> par rapport aux objets internes au <em>package</em>. En le laissant vide, nous allons utiliser ce fichier pour importer l’ensemble des fonctions de nos sous-modules. Ce n’est pas la meilleure pratique mais un contrôle plus fin des objets exportés demanderait un investissement qui ne vaut, ici, pas le coût.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>Si vous désirez aussi contrôler la version de <code>Python</code>, ce qui peut être important dans une perspective de portabilité, vous pouvez ajouter une option, par exemple <code>-p python3.10</code>. Néanmoins nous n’allons pas nous embarasser de cette nuance pour la suite car nous pourrons contrôler la version de <code>Python</code> plus finement par le biais de <code>Docker</code>.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>L’option <code>-c</code> passée après la commande <code>python</code> permet d’indiquer à <code>Python</code> que la commande ne se trouve pas dans un fichier mais sera dans le texte qu’on va directement lui fournir.<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p>L’option <code>-c</code> passée après la commande <code>python</code> permet d’indiquer à <code>Python</code> que la commande ne se trouve pas dans un fichier mais sera dans le texte qu’on va directement lui fournir.<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13"><p>Pour comparer les deux listes, vous pouvez utiliser la fonctionnalité de <em>split</em> du terminal sur <code>VSCode</code> pour comparer les outputs de <code>conda env export</code> en les mettant en face à face.<a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn14"><p>Il est tout à fait normal de ne pas parvenir à créer une action fonctionnelle du premier coup. N’hésitez pas à <em>pusher</em> votre code après chaque question pour vérifier que vous parvenez bien à réaliser chaque étape. Sinon vous risquez de devoir corriger bout par bout un fichier plus conséquent.<a href="#fnref14" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn15"><p>Il existe une approche alternative pour faire des tests réguliers: les <em>hooks</em> <code>Git</code>. Il s’agit de règles qui doivent être satisfaites pour que le fichier puisse être committé. Cela assure que chaque <code>commit</code> remplisse des critères de qualité afin d’éviter le problème de la procrastination.</p>
<p>La <a href="https://pylint.pycqa.org/en/latest/user_guide/pre-commit-integration.html">documentation de pylint</a> offre des explications supplémentaires. Ici, nous allons adopter une approche moins ambitieuse en demandant à notre action de faire ce travail d’évaluation de la qualité de notre code<a href="#fnref15" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn16"><p>Vous n’êtes pas obligés pour l’évaluation de mettre en oeuvre les jalons de plusieurs parcours. Néanmoins, vous découvrirez que chaque nouveau pas en avant est moins coûteux que le précédent si vous avez mis en oeuvre les réflexes des bonnes pratiques.<a href="#fnref16" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn17"><p>Ce n’est pas indispensable si vous avez une manière cohérente de gérer vos jetons d’accès aux données dans votre API, par exemple par le biais de <em>service account</em>. Néanmoins, pour se faciliter la tâche, on ne va pas se poser de question sur les droits d’accès au modèle.<a href="#fnref17" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn18"><p>Par conséquent, <code>MLFLow</code> bénéficie de l’injection automatique des <em>tokens</em> pour pouvoir lire/écrire sur S3. Ces jetons ont la même durée avant expiration que ceux de vos services interactifs <code>VSCode</code>. Il faut donc supprimer et rouvrir un service <code>MLFLow</code> régulièrement. La manière d’éviter cela est de créer des <em>service account</em> sur <a href="https://minio-console.lab.sspcloud.fr/login">https://minio-console.lab.sspcloud.fr/</a> et de les renseigner sur <a href="https://datalab.sspcloud.fr/project-settings/s3-configs">la page</a>.<a href="#fnref18" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/ensae-reproductibilite\.github\.io\/website\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<script src="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>