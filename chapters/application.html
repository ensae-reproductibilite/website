<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Romain Avouac et Lino Galiana">

<title>Mise en production de projets data science - Appliquer les concepts √©tudi√©s √† un projet de data science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Mise en production de projets data science</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/introduction.html">
 <span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/code-quality.html">
 <span class="menu-text">Qualit√© du code</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/projects-architecture.html">
 <span class="menu-text">Architecture des projets</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/portability.html">
 <span class="menu-text">Portabilit√©</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/deployment.html">
 <span class="menu-text">Mise en production</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../chapters/application.html" aria-current="page">
 <span class="menu-text">Application</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-suppl√©ments" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Suppl√©ments</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-suppl√©ments">    
        <li>
    <a class="dropdown-item" href="../chapters/application.html">
 <span class="dropdown-text">Linux 101</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/git.html">
 <span class="dropdown-text">Git</span></a>
  </li>  
    </ul>
  </li>
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#partie-1-qualit√©-du-script" id="toc-partie-1-qualit√©-du-script" class="nav-link active" data-scroll-target="#partie-1-qualit√©-du-script">Partie 1 : qualit√© du script</a>
  <ul class="collapse">
  <li><a href="#etape-0-forker-le-d√©p√¥t-dexemple-et-cr√©er-une-branche-de-travail" id="toc-etape-0-forker-le-d√©p√¥t-dexemple-et-cr√©er-une-branche-de-travail" class="nav-link" data-scroll-target="#etape-0-forker-le-d√©p√¥t-dexemple-et-cr√©er-une-branche-de-travail">Etape 0: forker le d√©p√¥t d‚Äôexemple et cr√©er une branche de travail</a></li>
  <li><a href="#etape-1-sassurer-que-le-script-sex√©cute-correctement" id="toc-etape-1-sassurer-que-le-script-sex√©cute-correctement" class="nav-link" data-scroll-target="#etape-1-sassurer-que-le-script-sex√©cute-correctement">Etape 1 : s‚Äôassurer que le script s‚Äôex√©cute correctement</a></li>
  <li><a href="#etape-2-utiliser-un-linter-puis-un-formatter" id="toc-etape-2-utiliser-un-linter-puis-un-formatter" class="nav-link" data-scroll-target="#etape-2-utiliser-un-linter-puis-un-formatter">Etape 2: utiliser un <em>linter</em> puis un <em>formatter</em></a></li>
  <li><a href="#etape-3-gestion-des-param√®tres" id="toc-etape-3-gestion-des-param√®tres" class="nav-link" data-scroll-target="#etape-3-gestion-des-param√®tres">Etape 3: gestion des param√®tres</a></li>
  <li><a href="#etape-4-adopter-la-programmation-fonctionnelle" id="toc-etape-4-adopter-la-programmation-fonctionnelle" class="nav-link" data-scroll-target="#etape-4-adopter-la-programmation-fonctionnelle">Etape 4 : Adopter la programmation fonctionnelle</a></li>
  </ul></li>
  <li><a href="#partie2" id="toc-partie2" class="nav-link" data-scroll-target="#partie2">Partie 2 : adoption d‚Äôune structure modulaire</a>
  <ul class="collapse">
  <li><a href="#etape-1-modularisation" id="toc-etape-1-modularisation" class="nav-link" data-scroll-target="#etape-1-modularisation">Etape 1 : modularisation</a></li>
  <li><a href="#etape-2-adopter-une-architecture-standardis√©e-de-projet" id="toc-etape-2-adopter-une-architecture-standardis√©e-de-projet" class="nav-link" data-scroll-target="#etape-2-adopter-une-architecture-standardis√©e-de-projet">Etape 2 : adopter une architecture standardis√©e de projet</a>
  <ul class="collapse">
  <li><a href="#etape-3-indiquer-lenvironnement-minimal-de-reproductibilit√©" id="toc-etape-3-indiquer-lenvironnement-minimal-de-reproductibilit√©" class="nav-link" data-scroll-target="#etape-3-indiquer-lenvironnement-minimal-de-reproductibilit√©">Etape 3: indiquer l‚Äôenvironnement minimal de reproductibilit√©</a></li>
  </ul></li>
  <li><a href="#stockageS3" id="toc-stockageS3" class="nav-link" data-scroll-target="#stockageS3">Etape 4 : stocker les donn√©es de mani√®re externe</a></li>
  </ul></li>
  <li><a href="#partie-2bis-packagisation-de-son-projet-optionnel" id="toc-partie-2bis-packagisation-de-son-projet-optionnel" class="nav-link" data-scroll-target="#partie-2bis-packagisation-de-son-projet-optionnel">Partie 2bis: packagisation de son projet (optionnel)</a>
  <ul class="collapse">
  <li><a href="#etape-1-proposer-des-tests-unitaires-optionnel" id="toc-etape-1-proposer-des-tests-unitaires-optionnel" class="nav-link" data-scroll-target="#etape-1-proposer-des-tests-unitaires-optionnel">Etape 1 : proposer des tests unitaires (optionnel)</a></li>
  <li><a href="#etape-2-transformer-son-projet-en-package-optionnel" id="toc-etape-2-transformer-son-projet-en-package-optionnel" class="nav-link" data-scroll-target="#etape-2-transformer-son-projet-en-package-optionnel">Etape 2 : transformer son projet en package (optionnel)</a></li>
  </ul></li>
  <li><a href="#partie3" id="toc-partie3" class="nav-link" data-scroll-target="#partie3">Partie 2 : construction d‚Äôun projet portable et reproductible</a>
  <ul class="collapse">
  <li><a href="#configyaml" id="toc-configyaml" class="nav-link" data-scroll-target="#configyaml">Etape 1: cr√©er un r√©pertoire de variables servant d‚Äôinput</a>
  <ul class="collapse">
  <li><a href="#enjeu" id="toc-enjeu" class="nav-link" data-scroll-target="#enjeu">Enjeu</a></li>
  <li><a href="#application" id="toc-application" class="nav-link" data-scroll-target="#application">Application</a></li>
  </ul></li>
  <li><a href="#anaconda" id="toc-anaconda" class="nav-link" data-scroll-target="#anaconda">Etape 2 : cr√©er un environnement conda √† partir du fichier <code>environment.yml</code></a></li>
  <li><a href="#docker" id="toc-docker" class="nav-link" data-scroll-target="#docker">Etape 3: conteneuriser avec Docker <i class="fab fa-docker"></i></a>
  <ul class="collapse">
  <li><a href="#pr√©liminaire" id="toc-pr√©liminaire" class="nav-link" data-scroll-target="#pr√©liminaire">Pr√©liminaire</a></li>
  <li><a href="#cr√©ation-dun-premier-dockerfile" id="toc-cr√©ation-dun-premier-dockerfile" class="nav-link" data-scroll-target="#cr√©ation-dun-premier-dockerfile">Cr√©ation d‚Äôun premier Dockerfile</a></li>
  <li><a href="#construire-limage" id="toc-construire-limage" class="nav-link" data-scroll-target="#construire-limage">Construire l‚Äôimage</a></li>
  <li><a href="#tester-limage-d√©couverte-du-cache" id="toc-tester-limage-d√©couverte-du-cache" class="nav-link" data-scroll-target="#tester-limage-d√©couverte-du-cache">Tester l‚Äôimage: d√©couverte du cache</a></li>
  <li><a href="#corriger-une-faille-de-reproductibilit√©" id="toc-corriger-une-faille-de-reproductibilit√©" class="nav-link" data-scroll-target="#corriger-une-faille-de-reproductibilit√©">Corriger une faille de reproductibilit√©</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#partie-3-mise-en-production" id="toc-partie-3-mise-en-production" class="nav-link" data-scroll-target="#partie-3-mise-en-production">Partie 3 : mise en production</a>
  <ul class="collapse">
  <li><a href="#etape-pr√©liminaire" id="toc-etape-pr√©liminaire" class="nav-link" data-scroll-target="#etape-pr√©liminaire">Etape pr√©liminaire</a></li>
  <li><a href="#etape-1-mise-en-place-de-tests-automatis√©s" id="toc-etape-1-mise-en-place-de-tests-automatis√©s" class="nav-link" data-scroll-target="#etape-1-mise-en-place-de-tests-automatis√©s">Etape 1: mise en place de tests automatis√©s</a></li>
  <li><a href="#etape-2-automatisation-de-la-livraison-de-limage-docker" id="toc-etape-2-automatisation-de-la-livraison-de-limage-docker" class="nav-link" data-scroll-target="#etape-2-automatisation-de-la-livraison-de-limage-docker">Etape 2: Automatisation de la livraison de l‚Äôimage <code>Docker</code></a></li>
  <li><a href="#etape-3-cr√©ation-dun-rapport-automatique" id="toc-etape-3-cr√©ation-dun-rapport-automatique" class="nav-link" data-scroll-target="#etape-3-cr√©ation-dun-rapport-automatique">Etape 3: cr√©ation d‚Äôun rapport automatique</a>
  <ul class="collapse">
  <li><a href="#rapport-minimal-en-local" id="toc-rapport-minimal-en-local" class="nav-link" data-scroll-target="#rapport-minimal-en-local">1. Rapport minimal en local</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#feature-importance" id="toc-feature-importance" class="nav-link" data-scroll-target="#feature-importance">Feature importance</a></li>
  <li><a href="#qualit√©-pr√©dictive-du-mod√®le" id="toc-qualit√©-pr√©dictive-du-mod√®le" class="nav-link" data-scroll-target="#qualit√©-pr√©dictive-du-mod√®le">Qualit√© pr√©dictive du mod√®le</a>
  <ul class="collapse">
  <li><a href="#enrichir-limage-docker" id="toc-enrichir-limage-docker" class="nav-link" data-scroll-target="#enrichir-limage-docker">3. Enrichir l‚Äôimage <code>Docker</code></a></li>
  <li><a href="#automatisation-avec-github-actions" id="toc-automatisation-avec-github-actions" class="nav-link" data-scroll-target="#automatisation-avec-github-actions">4. Automatisation avec <code>Github Actions</code></a></li>
  <li><a href="#etape-4-d√©ploiement-de-ce-rapport-automatique-sur-le-web" id="toc-etape-4-d√©ploiement-de-ce-rapport-automatique-sur-le-web" class="nav-link" data-scroll-target="#etape-4-d√©ploiement-de-ce-rapport-automatique-sur-le-web">Etape 4: D√©ploiement de ce rapport automatique sur le web</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Appliquer les concepts √©tudi√©s √† un projet de data science</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Romain Avouac et Lino Galiana </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<p>L‚Äôobjectif de cette mise en application est d‚Äô<strong>illustrer les diff√©rentes √©tapes qui s√©parent la phase de d√©veloppement d‚Äôun projet de celle de la mise en production</strong>. Elle permettra de mettre en pratique les diff√©rents concepts pr√©sent√©s tout au long du cours.</p>
<p>Nous nous pla√ßons dans une situation initiale correspondant √† la fin de la phase de d√©veloppement d‚Äôun projet de data science. On a un notebook un peu monolithique, qui r√©alise les √©tapes classiques d‚Äôun <em>pipeline</em> de <em>machine learning</em> :</p>
<ul>
<li>Import de donn√©es ;</li>
<li>Statistiques descriptives et visualisations ;</li>
<li><em>Feature engineering</em> ;</li>
<li>Entra√Ænement d‚Äôun mod√®le ;</li>
<li>Evaluation du mod√®le</li>
</ul>
<p><strong>L‚Äôobjectif est d‚Äôam√©liorer le projet de mani√®re incr√©mentale jusqu‚Äô√† pouvoir le mettre en production, en le valorisant sous une forme adapt√©e.</strong></p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Il est important de bien lire les consignes et d‚Äôy aller progressivement. Certaines √©tapes peuvent √™tre rapides, d‚Äôautres plus fastidieuses ; certaines √™tre assez guid√©es, d‚Äôautres vous laisser plus de libert√©. Si vous n‚Äôeffectuez pas une √©tape, vous risquez de ne pas pouvoir passer √† l‚Äô√©tape suivante qui en d√©pend.</p>
<p>Bien que l‚Äôexercice soit applicable sur toute configuration bien faite, nous recommandons de privil√©gier l‚Äôutilisation du <a href="https://datalab.sspcloud.fr/home">SSP Cloud</a>, o√π tous les outils n√©cessaires sont pr√©-install√©s et pr√©-configur√©s.</p>
</div>
</div>
<section id="partie-1-qualit√©-du-script" class="level1">
<h1>Partie 1 : qualit√© du script</h1>
<p>Cette premi√®re partie vise √† <strong>rendre le projet conforme aux bonnes pratiques</strong> pr√©sent√©es dans le cours.</p>
<p>Elle fait intervenir les notions suivantes :</p>
<ul>
<li>Utilisation du <strong>terminal</strong> (voir <a href="../chapters/linux-101.html">Linux 101</a>) ;</li>
<li><strong>Qualit√© du code</strong> (voir <a href="../chapters/code-quality.html">Qualit√© du code</a>) ;</li>
<li><strong>Architecture de projets</strong> (voir <a href="../chapters/projects-architecture.html">Architecture des projets</a>) ;</li>
<li><strong>Contr√¥le de version</strong> avec <code>Git</code> (voir <a href="../chapters/git.html">Rappels <code>Git</code></a>) ;</li>
<li><strong>Travail collaboratif</strong> avec <code>Git</code> et <code>GitHub</code> (voir <a href="../chapters/git.html">Rappels <code>Git</code></a>).</li>
</ul>
<p>Le plan de la partie est le suivant :</p>
<!----
0. :zero: _Forker_ le d√©p√¥t et cr√©er une branche de travail
1. :one: S'assurer que le _notebook_ s'ex√©cute correctement
2. :two: Modularisation : mise en fonctions et mise en module
3. :three: Utiliser un `main` script
4. :four:  Appliquer les standards de qualit√© de code
5. :five: Adopter une architecture standardis√©e de projet
6. :six: Fixer l'environnement d'ex√©cution
7. :seven: Stocker les donn√©es de mani√®re externe
8. :eight: Nettoyer le projet `Git`
9. :nine: Ouvrir une *pull request* sur le d√©p√¥t du projet.
------------->
<p>Nous allons partir de ce <em>Notebook</em> <code>Jupyter</code>, que vous pouvez pr√©visualiser voire tester en cliquant sur l‚Äôun des liens suivants:</p>
<p><a href="https://datalab.sspcloud.fr/launcher/ide/jupyter-python?autoLaunch=false&amp;init.personalInit=%C2%ABhttps%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fensae-reproductibilite-website%2Fmaster%2Fpreview-notebook.sh%C2%BB" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/SSPcloud-Tester%20notebook%20sur%20SSP--cloud-informational&amp;color=yellow?logo=Python" alt="Onyxia"></a> <a href="http://colab.research.google.com/github/linogaliana/ensae-reproductibilite-application/blob/main/titanic.ipynb" target="_blank" rel="noopener"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<section id="etape-0-forker-le-d√©p√¥t-dexemple-et-cr√©er-une-branche-de-travail" class="level2">
<h2 class="anchored" data-anchor-id="etape-0-forker-le-d√©p√¥t-dexemple-et-cr√©er-une-branche-de-travail">Etape 0: forker le d√©p√¥t d‚Äôexemple et cr√©er une branche de travail</h2>
<ul>
<li><p>Ouvrir un service <code>VSCode</code> sur le <a href="https://datalab.sspcloud.fr/home">SSP Cloud</a>. Vous pouvez aller dans la page <code>My Services</code> et cliquer sur <code>New service</code>. Sinon, vous pouvez lancer le service en cliquant directement <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?autoLaunch=false">ici</a>.</p></li>
<li><p>G√©n√©rer un jeton d‚Äôacc√®s (<em>token</em>) sur <code>GitHub</code> afin de permettre l‚Äôauthentification en ligne de commande √† votre compte. La proc√©dure est d√©crite <a href="https://docs.sspcloud.fr/onyxia-guide/controle-de-version#creer-un-jeton-dacces-token">ici</a>. Garder le jeton g√©n√©r√© de c√¥t√©.</p></li>
<li><p>Forker le d√©p√¥t <code>Github</code> : https://github.com/linogaliana/ensae-reproductibilite-application</p></li>
<li><p>Cl√¥ner <strong>votre</strong> d√©p√¥t <code>Github</code> en utilisant le terminal depuis <code>Visual Studio</code> (<code>Terminal &gt; New Terminal</code>) :</p></li>
</ul>
<pre class="shell"><code>$ git clone https://&lt;TOKEN&gt;@github.com/&lt;USERNAME&gt;/ensae-reproductibilite-application.git</code></pre>
<p>o√π <code>&lt;TOKEN&gt;</code> et <code>&lt;USERNAME&gt;</code> sont √† remplacer, respectivement, par le jeton que vous avez g√©n√©r√© pr√©c√©demment et votre nom d‚Äôutilisateur.</p>
<ul>
<li>Se placer avec le terminal dans le dossier en question :</li>
</ul>
<pre class="shell"><code>$ cd ensae-reproductibilite-application</code></pre>
<ul>
<li>Cr√©ez une branche <code>nettoyage</code> :</li>
</ul>
<pre class="shell"><code>$ git checkout -b nettoyage
Switched to a new branch 'nettoyage'</code></pre>
</section>
<section id="etape-1-sassurer-que-le-script-sex√©cute-correctement" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-sassurer-que-le-script-sex√©cute-correctement">Etape 1 : s‚Äôassurer que le script s‚Äôex√©cute correctement</h2>
<p>On va partir du fichier <code>notebook.py</code> qui reprend le contenu du <em>notebook</em><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> mais dans un script classique.</p>
<p>La premi√®re √©tape est simple, mais souvent oubli√©e : <strong>v√©rifier que le code fonctionne correctement</strong>.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 1: corriger les erreurs
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Ouvrir dans <code>VSCode</code> le script <code>titanic.py</code> ;</li>
<li>Ex√©cuter le script ligne √† ligne pour d√©tecter les erreurs ;</li>
<li>Corriger les deux erreurs qui emp√™chent la bonne ex√©cution ;</li>
<li>V√©rifier le fonctionnement du script en utilisant la ligne de commande</li>
</ul>
<pre class="shell"><code>python titanic.py</code></pre>
</div>
</div>
<p>Il est maintenant temps de <em>commit</em> les changements effectu√©s avec <code>Git</code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> :</p>
<pre class="shell"><code>$ git add titanic.py
$ git commit -m "Corrige l'erreur qui emp√™chait l'ex√©cution"
$ git push</code></pre>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application1/titanic.py">Script <em>checkpoint</em></a></p>
</div>
</div>
</div>
</section>
<section id="etape-2-utiliser-un-linter-puis-un-formatter" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-utiliser-un-linter-puis-un-formatter">Etape 2: utiliser un <em>linter</em> puis un <em>formatter</em></h2>
<p>On va maintenant am√©liorer la qualit√© de notre code en appliquant les standards communautaires. Pour cela, on va utiliser le <em>linter</em> classique <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a>.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>N‚Äôh√©sitez pas √† taper un code d‚Äôerreur sur un moteur de recherche pour obtenir plus d‚Äôinformations si jamais le message n‚Äôest pas clair !</p>
</div>
</div>
<p>Pour appliquer le <em>linter</em> √† un script <code>.py</code>, la syntaxe √† entrer dans le terminal est la suivante :</p>
<pre class="shell"><code>$ pylint mon_script.py</code></pre>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a> sont des <em>packages</em> <code>Python</code> qui s‚Äôutilisent principalement en ligne de commande.</p>
<p>Si vous avez une erreur qui sugg√®re que votre terminal ne connait pas <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> ou <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a>, n‚Äôoubliez pas d‚Äôex√©cuter la commande <code>pip install pylint</code> ou <code>pip install black</code>.</p>
</div>
</div>
<p>Le <em>linter</em> renvoie alors une s√©rie d‚Äôirr√©gularit√©s, en pr√©cisant √† chaque fois la ligne de l‚Äôerreur et le message d‚Äôerreur associ√© (ex : mauvaise identation). Il renvoie finalement une note sur 10, qui estime la qualit√© du code √† l‚Äôaune des standards communautaires √©voqu√©s dans la partie <a href="../chapters/code-quality.html">Qualit√© du code</a>.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 2: rendre lisible le script
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Diagnostiquer et √©valuer la qualit√© de <code>titanic.py</code> avec <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a>. Regarder la note obtenue.</li>
<li>Utiliser <code>black titanic.py --diff --color</code> pour observer les changements de forme que va induire l‚Äôutilisation du <em>formatter</em> <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a></li>
<li>Appliquer le <em>formatter</em> <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a></li>
<li>R√©utiliser <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> pour diagnostiquer l‚Äôam√©lioration de la qualit√© du script et le travail qui reste √† faire.</li>
<li>Comme la majorit√© du travail restant est √† consacrer aux imports:
<ul>
<li>Mettre tous les <em>imports</em> ensemble en d√©but de script</li>
<li>Retirer les <em>imports</em> redondants en s‚Äôaidant des diagnostics de votre √©diteur</li>
<li>R√©ordonner les <em>imports</em> si <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> vous indique de le faire</li>
<li>Corriger les derni√®res fautes formelles sugg√©r√©es par <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a></li>
</ul></li>
<li>D√©limiter des parties dans votre code pour rendre sa structure plus lisible</li>
</ul>
</div>
</div>
<p>Le code est maintenant lisible, il obtient √† ce stade une note formelle proche de 10. Mais il n‚Äôest pas encore totalement intelligible ou fiable. Il y a notamment beaucoup de redondance de code auxquelles nous allons nous attaquer par la suite. N√©anmoins, avant cela, occupons-nous de mieux g√©rer certains param√®tres du script: jetons d‚ÄôAPI et chemin des fichiers.</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application2/titanic.py"><code>titanic.py</code></a></p>
</div>
</div>
</div>
</section>
<section id="etape-3-gestion-des-param√®tres" class="level2">
<h2 class="anchored" data-anchor-id="etape-3-gestion-des-param√®tres">Etape 3: gestion des param√®tres</h2>
<p>L‚Äôex√©cution du code et les r√©sultats obtenus d√©pendent de certains param√®tres. L‚Äô√©tude de r√©sultats alternatifs, en jouant sur des variantes des param√®tres, est √† ce stade compliqu√©e car il est n√©cessaire de parcourir le code pour trouver ces param√®tres. De plus, certains param√®tres personnels comme des jetons d‚ÄôAPI ou des mots de passe n‚Äôont pas vocation √† √™tre pr√©sents dans le code.</p>
<p>Il est plus judicieux de consid√©rer ces param√®tres comme des variables d‚Äôentr√©e du script. Cela peut √™tre fait de deux mani√®res:</p>
<ol type="1">
<li>Avec des arguments optionnels appel√©s depuis la ligne de commande. Cela peut √™tre pratique pour mettre en oeuvre des tests automatis√©s<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> mais n‚Äôest pas forc√©ment pertinent pour toutes les variables. Nous allons montrer cet usage avec le nombre d‚Äôarbres de notre <em>random forest</em> ;</li>
<li>En utilisant un fichier de configuration dont les valeurs sont import√©es dans le script principal. Nous allons le mettre en oeuvre pour deux types de fichiers: les √©l√©ments de configuration √† partager et ceux √† conserver pour soi mais pouvant servir.</li>
</ol>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 3: Param√©trisation du script
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>En s‚Äôinspirant de <a href="https://stackoverflow.com/a/69377311/9197726">cette r√©ponse</a>, cr√©er une variable <code>n_trees</code> qui peut √©ventuellement √™tre param√©tr√©e en ligne de commande et dont la valeur par d√©faut est 20.</li>
<li>Tester cette param√©trisation en ligne de commande avec la valeur par d√©faut puis 2, 10 et 50 arbres</li>
<li>Rep√©rer le jeton d‚ÄôAPI dans le code. Retirer le jeton d‚ÄôAPI du code et cr√©er √† la racine du projet un fichier YAML nomm√© <code>secrets.yaml</code> o√π vous √©crivez ce secret sous la forme <code>key: value</code></li>
<li>Pour √©viter d‚Äôavoir √† le faire plus tard, cr√©er une fonction <code>import_yaml_config</code> qui prend en argument le chemin d‚Äôun fichier <code>YAML</code> et renvoie le contenu de celui-ci en <em>output</em>. Vous pouvez suivre le conseil du chapitre sur la <a href="../chapters/code-quality.html">Qualit√© du code</a> en adoptant le <em>type hinting</em>.</li>
<li>Cr√©er la variable <code>API_TOKEN</code> ayant la valeur stock√©e dans <code>secrets.yaml</code><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</li>
<li>Tester en ligne de commande que l‚Äôex√©cution du fichier est toujours sans erreur</li>
<li>Refaire un diagnostic avec <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et corriger les √©ventuels messages.</li>
<li>Cr√©er un fichier <code>config.yaml</code> stockant trois informations: le chemin des donn√©es d‚Äôentra√Ænement, des donn√©es de test et la r√©partition train/test utilis√©e dans le code. Cr√©er les variables correspondantes dans le code apr√®s avoir utilis√© <code>import_yaml_config</code></li>
<li>Cr√©er un fichier <code>.gitignore</code>. Ajouter dans ce fichier <code>secrets.yaml</code> car il ne faut pas committer ce fichier.</li>
<li>Cr√©er un fichier <code>README.md</code> o√π vous indiquez qu‚Äôil faut cr√©er un fichier <code>secrets.yaml</code> pour pouvoir utiliser l‚ÄôAPI.</li>
</ol>
<details>
<summary>
Indice si vous ne trouvez pas comment lire un fichier <code>YAML</code>
</summary>
<p>Si le fichier s‚Äôappelle <code>toto.yaml</code>, vous pouvez l‚Äôimporter de cette mani√®re:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"toto.yaml"</span>, <span class="st">"r"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> stream:</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    dict_config <span class="op">=</span> yaml.safe_load(stream)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/titanic.py"><code>titanic.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/readme.md"><code>README.md</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/config.yaml"><code>config.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/secrets.yaml"><code>secrets.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/.gitignore"><code>.gitignore</code></a></li>
</ul>
</div>
</div>
</div>
</section>
<section id="etape-4-adopter-la-programmation-fonctionnelle" class="level2">
<h2 class="anchored" data-anchor-id="etape-4-adopter-la-programmation-fonctionnelle">Etape 4 : Adopter la programmation fonctionnelle</h2>
<p>Nous allons <strong>mettre en fonctions les parties importantes de l‚Äôanalyse, et les mettre dans un module afin de pouvoir les importer directement depuis le notebook</strong>.</p>
<p>Cet exercice √©tant chronophage, il n‚Äôest <strong>pas obligatoire de le r√©aliser en entier</strong>. L‚Äôimportant est de comprendre la d√©marche et d‚Äôadopter fr√©quemment une approche fonctionnelle<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. Pour obtenir une chaine enti√®rement fonctionnalis√©e, vous pouvez reprendre le <em>checkpoint</em>.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 4: adoption des standards de programmation fonctionnelle
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Cr√©er une fonction qui importe les donn√©es d‚Äôentra√Ænement (<code>train.csv</code>) et de test (<code>test.csv</code>) et renvoie des <code>DataFrames</code> <code>Pandas</code> ;</li>
<li>En fonction du temps disponible, cr√©er plusieurs fonctions pour r√©aliser les √©tapes de <em>feature engineering</em>:
<ul>
<li>La cr√©ation de la variable <em>‚ÄúTitle‚Äù</em> peut √™tre automatis√©e en vertu du principe <em>‚Äúdo not repeat yourself‚Äù</em><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</li>
<li>Regrouper ensemble les <code>fillna</code> et essayer de cr√©er une fonction g√©n√©ralisant l‚Äôop√©ration.</li>
<li>Les <em>label encoders</em> peuvent √™tre transform√©s en deux fonctions: une premi√®re pour encoder une colonne puis une seconde qui utilise la premi√®re de mani√®re r√©p√©t√©e pour encoder plusieurs colonnes. <em>Remarquez les erreurs de copier-coller que cela corrige</em></li>
<li>Finaliser les derni√®res transformations avec des fonctions</li>
</ul></li>
<li>Cr√©er une fonction qui r√©alise le <em>split train/test</em> de validation en fonction d‚Äôun param√®tre repr√©sentant la proportion de l‚Äô√©chantillon de test.</li>
<li>Cr√©er une fonction qui entra√Æne et √©value un classifieur <code>RandomForest</code>, et qui prend en param√®tre le nombre d‚Äôarbres (<code>n_estimators</code>). La fonction doit imprimer √† la fin la performance obtenue et la matrice de confusion.</li>
<li>D√©placer toutes les fonctions ensemble, en d√©but de script. <!----- plus tard ?
- Mettre ces fonctions dans un module `functions.py`
- importer les fonctions via le module dans le notebook et v√©rifier que l'on retrouve bien les diff√©rents r√©sultats en utilisant les fonctions.
-------></li>
</ul>
</div>
</div>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Le fait d‚Äôappliquer des fonctions a d√©j√† am√©lior√© la fiabilit√© du processus en r√©duisant le nombre d‚Äôerreurs de copier-coller. N√©anmoins, pour vraiment fiabiliser le processus, il faudrait utiliser un <em>pipeline</em> de transformations de donn√©es.</p>
<p>Ceci n‚Äôest pas encore au programme du cours mais le sera dans une prochaine version.</p>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application4/titanic.py"><code>titanic.py</code></a></li>
</ul>
<p>Les autres fichiers inchang√©s:</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/readme.md"><code>README.md</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/config.yaml"><code>config.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/secrets.yaml"><code>secrets.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/.gitignore"><code>.gitignore</code></a></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="partie2" class="level1">
<h1>Partie 2 : adoption d‚Äôune structure modulaire</h1>
<p>Dans la partie pr√©c√©dente, on a appliqu√© de mani√®re incr√©mentale de nombreuses bonnes pratiques vues tout au long du cours. Ce faisant, on s‚Äôest d√©j√† consid√©rablement rapproch√©s d‚Äôun possible partage du code : celui-ci est lisible et intelligible. Le code est proprement versionn√© sur un d√©p√¥t <code>GitHub</code>.</p>
<p>N√©anmoins, la structure du projet n‚Äôest pas encore normalis√©e. De plus, l‚Äôadoption d‚Äôune structure plus modulaire facilitera la compr√©hension de la chaine de traitement.</p>
<section id="etape-1-modularisation" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-modularisation">Etape 1 : modularisation</h2>
<p>Fini le temps de l‚Äôexp√©rimentation : on va maintenant essayer de se passer compl√®tement du <em>notebook</em>. Pour cela, on va utiliser un <code>main</code> script, c‚Äôest √† dire un script qui reproduit l‚Äôanalyse en important et en ex√©cutant les diff√©rentes fonctions dans l‚Äôordre attendu.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 5: modularisation
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>D√©placer les fonctions dans une s√©rie de fichiers d√©di√©s:
<ul>
<li><code>import_data.py</code>: fonctions d‚Äôimport de donn√©es</li>
<li><code>build_features.py</code>: fonctions regroupant les √©tapes de <em>feature engineering</em></li>
<li><code>train_evaluate.py</code>: fonctions d‚Äôentrainement et d‚Äô√©valuation du mod√®le</li>
</ul></li>
<li>Sp√©cifier les d√©pendances (i.e.&nbsp;les packages √† importer) dans les modules pour que ceux-ci puissent s‚Äôex√©cuter ind√©pendamment ;</li>
<li>Renommer <code>titanic.py</code> en <code>main.py</code> pour suivre la convention de nommage des projets <code>Python</code> ;</li>
<li>Importer les fonctions n√©cessaires √† partir des modules. ‚ö†Ô∏è Ne pas utiliser <code>from XXX import *</code>, ce n‚Äôest pas une bonne pratique !</li>
<li>V√©rifier que tout fonctionne bien en ex√©cutant le <em>script</em> <code>main</code> √† partir de la ligne de commande :</li>
</ul>
<pre class="shell"><code>$ python main.py</code></pre>
</div>
</div>
<p>On dispose maintenant d‚Äôune application <code>Python</code> fonctionnelle. N√©anmoins, le projet est certes plus fiable mais sa structuration laisse √† d√©sirer et il serait difficile de rentrer √† nouveau dans le projet dans quelques temps.</p>
<details>
<summary>
Etat actuel du projet üôà
</summary>
<pre class="shell"><code>‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ train.csv
‚îú‚îÄ‚îÄ test.csv
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ config.yaml
‚îú‚îÄ‚îÄ secrets.yaml
‚îú‚îÄ‚îÄ import_data.py
‚îú‚îÄ‚îÄ build_features.py
‚îú‚îÄ‚îÄ train_evaluate.py
‚îî‚îÄ‚îÄmain.py</code></pre>
</details>
<p>Comme cela est expliqu√© dans la partie <a href="../chapters/projects-architecture.html">Structure des projets</a>, on va adopter une structure certes arbitraire mais qui va faciliter l‚Äôautodocumentation de notre projet.</p>
<p>De plus, une telle structure va faciliter des √©volutions optionnelles comme la packagisation du projet. Passer d‚Äôune structure modulaire bien faite √† un <em>package</em> est quasi-imm√©diat en <code>Python</code>.</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/build_features.py"><code>build_features.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/import_data.py"><code>import_data.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/train_evaluate.py"><code>train_evaluate.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/main.py"><code>main.py</code></a></li>
</ul>
<p>Les autres fichiers inchang√©s:</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/readme.md"><code>README.md</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/config.yaml"><code>config.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/secrets.yaml"><code>secrets.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/.gitignore"><code>.gitignore</code></a></li>
</ul>
</div>
</div>
</div>
</section>
<section id="etape-2-adopter-une-architecture-standardis√©e-de-projet" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-adopter-une-architecture-standardis√©e-de-projet">Etape 2 : adopter une architecture standardis√©e de projet</h2>
<p>On va maintenant modifier l‚Äôarchitecture de notre projet pour la rendre plus standardis√©e. Pour cela, on va s‚Äôinspirer des structures <a href="https://cookiecutter.readthedocs.io/en/stable/"><code>cookiecutter</code></a> qui g√©n√®rent des <em>templates</em> de projet.</p>
<p>On va s‚Äôinspirer de la structure du <a href="https://drivendata.github.io/cookiecutter-data-science/"><em>template datascience</em></a> d√©velopp√© par la communaut√©.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>L‚Äôid√©e de <a href="https://cookiecutter.readthedocs.io/en/stable/"><code>cookiecutter</code></a> est de proposer des <em>templates</em> que l‚Äôon utilise pour <strong>initialiser</strong> un projet, afin de b√¢tir √† l‚Äôavance une structure √©volutive. La syntaxe √† utiliser dans ce cas est la suivante :</p>
<pre class="shell"><code>$ pip install cookiecutter
$ cookiecutter https://github.com/drivendata/cookiecutter-data-science</code></pre>
<p>Ici, on a d√©j√† un projet, on va donc faire les choses dans l‚Äôautre sens : on va s‚Äôinspirer de la structure propos√©e afin de r√©organiser celle de notre projet selon les standards communautaires.</p>
</div>
</div>
<p>En s‚Äôinspirant du <em>cookiecutter data science</em> on va adopter la structure suivante:</p>
<pre class="shell"><code>ensae-reproductibilite-application
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ data
‚îÇ   ‚îî‚îÄ‚îÄ raw
‚îÇ       ‚îú‚îÄ‚îÄ test.csv
‚îÇ       ‚îî‚îÄ‚îÄ train.csv
‚îú‚îÄ‚îÄ configuration
‚îÇ   ‚îú‚îÄ‚îÄ secrets.yaml
‚îÇ   ‚îî‚îÄ‚îÄ config.yaml
‚îú‚îÄ‚îÄ notebooks
‚îÇ   ‚îî‚îÄ‚îÄ titanic.ipynb
‚îî‚îÄ‚îÄ src
    ‚îú‚îÄ‚îÄ data
    ‚îÇ   ‚îî‚îÄ‚îÄ import_data.py
    ‚îú‚îÄ‚îÄ features
    ‚îÇ   ‚îî‚îÄ‚îÄ build_features.py
    ‚îî‚îÄ‚îÄ models
        ‚îî‚îÄ‚îÄ train_evaluate.py</code></pre>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 6: adopter une structure lisible
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><em>(optionnel)</em> Analyser et comprendre la <a href="https://drivendata.github.io/cookiecutter-data-science/#directory-structure">structure de projet</a> propos√©e par le template</li>
<li>Modifier l‚Äôarborescence du projet selon le mod√®le</li>
<li>Adapter les scripts et les fichiers de configuration √† la nouvelle arborescence</li>
<li>Ajouter le dossier <strong>pycache</strong> au <code>.gitignore</code><a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> et le dossier <code>data</code></li>
</ul>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/build_features.py"><code>build_features.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/import_data.py"><code>import_data.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/train_evaluate.py"><code>train_evaluate.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/main.py"><code>main.py</code></a></li>
</ul>
<p>Les autres fichiers sont inchang√©s, √† l‚Äôexception de leur emplacement.</p>
</div>
</div>
</div>
<section id="etape-3-indiquer-lenvironnement-minimal-de-reproductibilit√©" class="level3">
<h3 class="anchored" data-anchor-id="etape-3-indiquer-lenvironnement-minimal-de-reproductibilit√©">Etape 3: indiquer l‚Äôenvironnement minimal de reproductibilit√©</h3>
<p>Le script <code>main.py</code> n√©cessite un certain nombre de packages pour √™tre fonctionnel. Chez vous les packages n√©cessaires sont bien s√ªr install√©s mais √™tes-vous assur√© que c‚Äôest le cas chez la personne qui testera votre code ?</p>
<p>Afin de favoriser la portabilit√© du projet, il est d‚Äôusage de <em>‚Äúfixer l‚Äôenvironnement‚Äù</em>, c‚Äôest-√†-dire d‚Äôindiquer dans un fichier toutes les d√©pendances utilis√©es ainsi que leurs version. Nous proposons de cr√©er un fichier <code>requirements.txt</code> minimal, sur lequel nous reviendrons dans la partie consacr√©e aux environnements reproductibles.</p>
<p>Le fichier <code>requirements.txt</code> est conventionnellement localis√© √† la racine du projet. Ici on ne va pas fixer les versions, on raffinera ce fichier plus tard.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 7: cr√©ation du <code>requirements.txt</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Cr√©er un fichier <code>requirements.txt</code> avec la liste des packages n√©cessaires</li>
<li>Ajouter une indication dans <code>README.md</code> sur l‚Äôinstallation des <em>packages</em> gr√¢ce au fichier <code>requirements.txt</code></li>
</ul>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-19-contents" aria-controls="callout-19" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-19" class="callout-19-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application7/requirements.txt"><code>requirements.txt</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application7/README.md"><code>README.md</code></a></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="stockageS3" class="level2">
<h2 class="anchored" data-anchor-id="stockageS3">Etape 4 : stocker les donn√©es de mani√®re externe</h2>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour mettre en oeuvre cette √©tape, il peut √™tre utile de comprendre un peu comme fonctionne le SSP Cloud. Vous devrez suivre la <a href="https://docs.sspcloud.fr/onyxia-guide/stockage-de-donnees">documentation du SSP Cloud</a> pour la r√©aliser. Une aide-m√©moire est √©galement disponible dans le cours de 2e ann√©e de l‚ÄôENSAE <a href="https://linogaliana-teaching.netlify.app/reads3/#">Python pour la data science</a></p>
</div>
</div>
<p>Comme on l‚Äôa vu dans le cours (<a href="../chapters/project-structure.html">partie structure des projets</a>), les donn√©es ne sont pas cens√©es √™tre versionn√©es sur un projet <code>Git</code>.</p>
<p>L‚Äôid√©al pour √©viter cela tout en maintenant la reproductibilit√© est d‚Äôutiliser une solution de stockage externe. On va utiliser pour cela <code>MinIO</code>, la solution de stockage de type <code>S3</code> offerte par le SSP Cloud.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 8: utilisation d‚Äôun syst√®me de stockage distant
</div>
</div>
<div class="callout-body-container callout-body">
<p>A partir de la ligne de commande, utiliser l‚Äôutilitaire <a href="https://min.io/docs/minio/linux/reference/minio-mc.html">MinIO</a> pour copier les donn√©es <code>data/raw/train.csv</code> et <code>data/raw/test.csv</code> vers votre bucket personnel, respectivement dans les dossiers <code>ensae-reproductibilite/data/raw/train.csv</code> et <code>ensae-reproductibilite/data/raw/test.csv</code>.</p>
<details>
<summary>
Indice
</summary>
<p>Structure √† adopter:</p>
<pre class="shell"><code>$ mc cp data/raw/train.csv s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/train.csv
$ mc cp data/raw/test.csv s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/test.csv</code></pre>
en modifiant l‚Äôemplacement de votre bucket personnel
</details>
<ul>
<li>Pour se simplifier la vie, on va utiliser des URL de t√©l√©chargement des fichiers (comme si ceux-ci √©taient sur n‚Äôimporte quel espace de stockage) plut√¥t que d‚Äôutiliser une librairie <code>S3</code> compatible comme <code>boto3</code> ou <code>s3fs</code>. Pour cela, en ligne de commande, faire:</li>
</ul>
<pre class="shell"><code>mc anonymous set download s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/</code></pre>
<p>en modifiant <code>&lt;BUCKET_PERSONNEL&gt;</code>. Les URL de t√©l√©chargement seront de la forme <code>https://minio.lab.sspcloud.fr/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/test.csv</code> et <code>https://minio.lab.sspcloud.fr/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/train.csv</code></p>
<ul>
<li>Modifier <code>configuration.yaml</code> pour utiliser directement les URL dans l‚Äôimport</li>
<li>Supprimer les fichiers <code>.csv</code> du dossier <code>data</code> de votre projet, on n‚Äôen a plus besoin vu qu‚Äôon les importe de l‚Äôext√©rieur</li>
<li>V√©rifier le bon fonctionnement de votre application</li>
</ul>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application8/config.yaml"><code>config.yaml</code></a></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="partie-2bis-packagisation-de-son-projet-optionnel" class="level1">
<h1>Partie 2bis: packagisation de son projet (optionnel)</h1>
<p>Cette s√©rie d‚Äôactions n‚Äôest pas forc√©ment pertinente pour tous les projets. Elle fait un peu la transition entre la modularit√© et la portabilit√©.</p>
<section id="etape-1-proposer-des-tests-unitaires-optionnel" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-proposer-des-tests-unitaires-optionnel">Etape 1 : proposer des tests unitaires (optionnel)</h2>
<p>Notre code comporte un certain nombre de fonctions g√©n√©riques. On peut vouloir tester leur usage sur des donn√©es standardis√©es, diff√©rentes de celles du Titanic.</p>
<p>M√™me si la notion de tests unitaires prend plus de sens dans un <em>package</em>, nous pouvons proposer dans le projet des exemples d‚Äôutilisation de la fonction, ceci peut √™tre p√©dagogique.</p>
<p>Nous allons utiliser <a href="https://docs.python.org/3/library/unittest.html"><code>unittest</code></a> et <code>pytest</code> pour effectuer des tests unitaires. Cette approche n√©cessite une ma√Ætrise de la programmation orient√©e objet.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 9: test unitaire <em>(optionnel)</em>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Dans le dossier <code>src/data/</code>, cr√©er un fichier <code>test_create_variable_title.py</code><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>.</p>
<p>En s‚Äôinspirant de l‚Äô<a href="https://docs.python.org/3/library/unittest.html#basic-example">exemple de base</a>, cr√©er une classe <code>TestCreateVariableTitle</code> qui effectue les op√©rations suivantes:</p>
<ul>
<li><p>Cr√©ation d‚Äôune fonction <code>test_create_variable_title_default_variable_name</code> qui permet de comparer les objets suivants:</p>
<ul>
<li>Cr√©ation d‚Äôun <code>DataFrame</code> de test :</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Name'</span>: [<span class="st">'Braund, Mr. Owen Harris'</span>, <span class="st">'Cumings, Mrs. John Bradley (Florence Briggs Thayer)'</span>,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Heikkinen, Miss. Laina'</span>, <span class="st">'Futrelle, Mrs. Jacques Heath (Lily May Peel)'</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Allen, Mr. William Henry'</span>, <span class="st">'Moran, Mr. James'</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'McCarthy, Mr. Timothy J'</span>, <span class="st">'Palsson, Master. Gosta Leonard'</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Johnson, Mrs. Oscar W (Elisabeth Vilhelmina Berg)'</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Nasser, Mrs. Nicholas (Adele Achem)'</span>],</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Age'</span>: [<span class="dv">22</span>, <span class="dv">38</span>, <span class="dv">26</span>, <span class="dv">35</span>, <span class="dv">35</span>, <span class="dv">27</span>, <span class="dv">54</span>, <span class="dv">2</span>, <span class="dv">27</span>, <span class="dv">14</span>],</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Survived'</span>: [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Utilisation de la fonction <code>create_variable_title</code> sur ce <code>DataFrame</code></li>
<li>Comparaison au <code>DataFrame</code> attendu:</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>expected_result <span class="op">=</span> pd.DataFrame({</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Title'</span>: [<span class="st">'Mr.'</span>, <span class="st">'Mrs.'</span>, <span class="st">'Miss.'</span>, <span class="st">'Mrs.'</span>, <span class="st">'Mr.'</span>, <span class="st">'Mr.'</span>, <span class="st">'Mr.'</span>, <span class="st">'Master.'</span>, <span class="st">'Mrs.'</span>, <span class="st">'Mrs.'</span>],</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Age'</span>: [<span class="dv">22</span>, <span class="dv">38</span>, <span class="dv">26</span>, <span class="dv">35</span>, <span class="dv">35</span>, <span class="dv">27</span>, <span class="dv">54</span>, <span class="dv">2</span>, <span class="dv">27</span>, <span class="dv">14</span>],</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Survived'</span>: [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Effectuer le test unitaire en ligne de commande avec <code>unittest</code>. Corriger le test unitaire en cas d‚Äôerreur.</p></li>
<li><p>Si le temps le permet, proposer des variantes pour tenir compte de param√®tres (comme la variable <code>variable_name</code>) ou d‚Äôexceptions (comme la gestion du cas <em>‚ÄúDona‚Äù</em>)</p></li>
</ul>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Lorsqu‚Äôon effectue des tests unitaires, on cherche g√©n√©ralement √† tester le plus de lignes possibles de son code. On parle de taux de couverture (<em>coverage rate</em>) pour d√©signer la statistique mesurant cela.</p>
<p>Cela peut s‚Äôeffectuer de la mani√®re suivante avec le package <a href="https://coverage.readthedocs.io/en/7.2.2/"><code>coverage</code></a>:</p>
<pre class="shell"><code>$ coverage run -m pytest test_create_variable_title.py
$ coverage report -m

Name                            Stmts   Miss  Cover   Missing
-------------------------------------------------------------
import_data.py                     15      6    60%   16-19, 31-34
test_create_variable_title.py      21      1    95%   54
-------------------------------------------------------------
TOTAL                              36      7    81%</code></pre>
<p>Le taux de couverture est souvent mis en avant par les gros projets comme indicateur de leur qualit√©. Il existe d‚Äôailleurs des badges <code>Github</code> d√©di√©s.</p>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-25-contents" aria-controls="callout-25" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-25" class="callout-25-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application9/test_create_variable_title.py"><code>test_create_variable_title.py</code></a></li>
</ul>
<p>Les autres fichiers sont inchang√©s.</p>
</div>
</div>
</div>
</section>
<section id="etape-2-transformer-son-projet-en-package-optionnel" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-transformer-son-projet-en-package-optionnel">Etape 2 : transformer son projet en package (optionnel)</h2>
<p>Notre projet est modulaire, ce qui le rend assez simple √† transformer en package, en s‚Äôinspirant du <code>cookiecutter</code> adapt√©, issu de <a href="https://py-pkgs.org/03-how-to-package-a-python#package-structure">cet ouvrage</a>.</p>
<details>
<summary>
Structure vis√©e
</summary>
<pre class="shell"><code>ensae-reproductibilite-application
‚îú‚îÄ‚îÄ docs                                    ‚îê 
‚îÇ   ‚îú‚îÄ‚îÄ main.py                             ‚îÇ 
‚îÇ   ‚îî‚îÄ‚îÄ notebooks                           ‚îÇ Package documentation and examples
‚îÇ       ‚îú‚îÄ‚îÄ titanic.ipynb                   ‚îÇ 
‚îú‚îÄ‚îÄ README.md                               ‚îò 
‚îú‚îÄ‚îÄ pyproject.toml                          ‚îê 
‚îú‚îÄ‚îÄ requirements.txt                        ‚îÇ
‚îú‚îÄ‚îÄ src                                     ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ titanicml                           ‚îÇ Package source code, metadata,
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py                     ‚îÇ and build instructions 
‚îÇ       ‚îú‚îÄ‚îÄ config.yaml                     ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ import_data.py                  ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ build_features.py               ‚îÇ 
‚îÇ       ‚îî‚îÄ‚îÄ train_evaluate.py               ‚îò
‚îî‚îÄ‚îÄ tests                                   ‚îê
    ‚îî‚îÄ‚îÄ test_create_variable_title.py       ‚îò Package tests</code></pre>
</details>
<details>
<summary>
Rappel: structure actuelle
</summary>
<pre class="shell"><code>ensae-reproductibilite-application
‚îú‚îÄ‚îÄ notebooks                                 
‚îÇ   ‚îî‚îÄ‚îÄ titanic.ipynb                  
‚îú‚îÄ‚îÄ configuration                                 
‚îÇ   ‚îî‚îÄ‚îÄ config.yaml                  
‚îú‚îÄ‚îÄ main.py                              
‚îú‚îÄ‚îÄ README.md                 
‚îú‚îÄ‚îÄ requirements.txt                      
‚îî‚îÄ‚îÄ src 
    ‚îú‚îÄ‚îÄ data                                
    ‚îÇ   ‚îú‚îÄ‚îÄ import_data.py                    
    ‚îÇ   ‚îî‚îÄ‚îÄ test_create_variable_title.py      
    ‚îú‚îÄ‚îÄ features                           
    ‚îÇ   ‚îî‚îÄ‚îÄ build_features.py      
    ‚îî‚îÄ‚îÄ models                          
        ‚îî‚îÄ‚îÄ train_evaluate.py              </code></pre>
</details>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 10: packagisation <em>(optionnel)</em>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>D√©placer les fichiers dans le dossier <code>src</code> pour respecter la nouvelle arborescence ;</li>
<li>Dans <code>src/titanicml</code>, cr√©er un fichier vide <code>__init__.py</code><a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> ;</li>
<li>D√©placer le fichier de configuration dans le <em>package</em> (n√©cessaire √† la reproductibilit√©) ;</li>
<li>Cr√©er le dossier <code>docs</code> et mettre les fichiers indiqu√©s dedans</li>
<li>Modifier <code>src/titanicml/import_data.py</code> :
<ul>
<li>Ajouter la variable <code>config_file = os.path.join(os.path.dirname(__file__), "config.yaml")</code>. Cela permettra d‚Äôutiliser directement le fichier ;</li>
<li>Proposer un argument par d√©faut √† la fonction <code>import_config_yaml</code> √©gal √† <code>config_file</code></li>
</ul></li>
<li>Cr√©er un fichier <code>pyproject.toml</code> √† partir du contenu de <a href="https://github.com/linogaliana/ensae-reproductibilite-application/blob/main/checkpoints/application10/pyproject.toml">ce mod√®le de <code>pyproject</code></a><a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a></li>
<li>Installer le package en local avec <code>pip install .</code></li>
<li>Modifier le contenu de <code>docs/main.py</code> pour importer les fonctions de notre <em>package</em> <code>titanicml</code> et tester en ligne de commande notre fichier <code>main.py</code></li>
</ul>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour cr√©er la structure minimale d‚Äôun <em>package</em>, le plus simple est d‚Äôutiliser le <code>cookiecutter</code> adapt√©, issu de <a href="https://py-pkgs.org/03-how-to-package-a-python#package-structure">cet ouvrage</a>.</p>
<p>Comme on a d√©j√† une structure tr√®s modulaire, on va plut√¥t recr√©er cette structure dans notre projet d√©j√† existant. En fait, il ne manque qu‚Äôun fichier essentiel, le principal distinguant un projet classique d‚Äôun package : <code>pyproject.toml</code>.</p>
<pre class="shell"><code>cookiecutter https://github.com/py-pkgs/py-pkgs-cookiecutter.git</code></pre>
<details>
<summary>
D√©rouler pour voir les choix possibles
</summary>
<pre class="shell"><code>author_name [Monty Python]: Daffy Duck
package_name [mypkg]: titanicml
package_short_description []: Impressive Titanic survival analysis
package_version [0.1.0]: 
python_version [3.9]: 
Select open_source_license:
1 - MIT
2 - Apache License 2.0
3 - GNU General Public License v3.0
4 - Creative Commons Attribution 4.0
5 - BSD 3-Clause
6 - Proprietary
7 - None
Choose from 1, 2, 3, 4, 5, 6 [1]: 
Select include_github_actions:
1 - no
2 - ci
3 - ci+cd
Choose from 1, 2, 3 [1]:</code></pre>
</details>
</div>
</div>
<!-----
## Etape 9 : ouvrir une *pull request* sur le d√©p√¥t du projet

Enfin termin√© ! Enfin presque... On s'est donn√© beaucoup de mal √† nettoyer ce d√©p√¥t et le mettre aux standards, autant valoriser ce travail. On va pour cela faire une *pull request* sur le [d√©p√¥t du projet initial](https://github.com/avouacr/ensae-reproductibilite-projet), c'est √† dire proposer √† l'auteur d'int√©grer tous les changements que vous avez effectu√© en committant √† chaque √©tape. 

Suivre la proc√©dure d√©crite dans la [documentation GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request-from-a-fork) pour cr√©er une *pull request* √† partir de votre *fork*. Pour la branche *upstream* (le d√©p√¥t cible), on va choisir `master`. Par contre, pour la branche locale (celle sur votre d√©p√¥t), on va choisir la branche `nettoyage`.

Si tout s'est bien pass√©, vous devriez √† pr√©sent voir votre *pull request* sur le d√©p√¥t cible ([ici](https://github.com/avouacr/ensae-reproductibilite-projet/pulls)). Bravo, vous venez de faire votre premi√®re contribution √† l'open source !

{{% box status="warning" title="Warning" icon="fa fa-exclamation-triangle" %}}
Faire une *pull request* via la branche `master` d‚Äôun *fork* est tr√®s mal vu. En effet, il faut souvent faire des contorsionnements pour r√©ussir √† faire co√Øncider deux histoires qui n‚Äôont pas de raison de co√Øncider. On s'√©vite beaucoup de probl√®mes en prenant l'habitude de toujours faire ses *pull requests* √† partir d'une autre branche que `master`.
{{% /box %}}
------------------>
</section>
</section>
<section id="partie3" class="level1">
<h1>Partie 2 : construction d‚Äôun projet portable et reproductible</h1>
<p>Dans la partie pr√©c√©dente, on a appliqu√© de mani√®re incr√©mentale de nombreuses bonnes pratiques vues tout au long du cours. Ce faisant, on s‚Äôest d√©j√† consid√©rablement rapproch√©s d‚Äôune possible mise en production : le code est lisible, la structure du projet est normalis√©e et √©volutive, et le code est proprement versionn√© sur un d√©p√¥t <code>GitHub</code> <i class="fab fa-github"></i>.</p>
<p>A pr√©sent, nous avons une version du projet qui est largement partageable. Du moins en th√©orie, car la pratique est souvent plus compliqu√©e : il y a fort √† parier que si vous essayez d‚Äôex√©cuter votre projet sur un autre environnement (typiquement, votre ordinateur personnel), les choses ne se passent pas du tout comme attendu. Cela signifie qu‚Äô<strong>en l‚Äô√©tat, le projet n‚Äôest pas portable : il n‚Äôest pas possible, sans modifications co√ªteuses, de l‚Äôex√©cuter dans un environnement diff√©rent de celui dans lequel il a √©t√© d√©velopp√©</strong>.</p>
<p>Dans cette seconde partie, nous allons voir comment <strong>normaliser l‚Äôenvironnement d‚Äôex√©cution afin de produire un projet portable</strong>. On sera alors tout proche de pouvoir mettre le projet en production. On progressera dans l‚Äô√©chelle de la reproductibilit√© de la mani√®re suivante: - <span class="emoji" data-emoji="one">1Ô∏è‚É£</span> <a href="#configyaml"><strong>G√©rer des variables d‚Äôenvironnement hors du code</strong></a> ; - <span class="emoji" data-emoji="two">2Ô∏è‚É£</span> <a href="#anaconda"><strong>Environnements virtuels</strong></a> ; - <span class="emoji" data-emoji="three">3Ô∏è‚É£</span> <a href="#docker"><strong>Images et conteneurs <code>Docker</code></strong></a>.</p>
<section id="configyaml" class="level2">
<h2 class="anchored" data-anchor-id="configyaml">Etape 1: cr√©er un r√©pertoire de variables servant d‚Äôinput</h2>
<section id="enjeu" class="level3">
<h3 class="anchored" data-anchor-id="enjeu">Enjeu</h3>
<p>Lors de l‚Äô<a href="#stockageS3">√©tape 7</a>, nous avons am√©lior√© la qualit√© du script en s√©parant stockage et code. Cependant, peut-√™tre avez-vous remarqu√© que nous avons introduit un nom de <em>bucket</em> personnel dans le script (voir <a href="https://github.com/linogaliana/ensae-reproductibilite-projet-1/blob/v7/main.py#L9">le fichier <code>main.py</code></a>). Il s‚Äôagit typiquement du genre de petit vice cach√© d‚Äôun script qui peut g√©n√©rer une erreur: vous n‚Äôavez pas acc√®s au bucket en question donc si vous essayez de faire tourner ce script en l‚Äô√©tat, vous allez rencontrer une erreur.</p>
<p>Une bonne pratique pour g√©rer ce type de configuration est d‚Äôutiliser un fichier <code>YAML</code> qui stocke de mani√®re hi√©rarchis√©e les variables globales <a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>.</p>
<p>En l‚Äôoccurrence, nous n‚Äôavons besoin que de deux √©l√©ments pour pouvoir d√©-personnaliser ce script :</p>
<ul>
<li>le nom du bucket</li>
<li>l‚Äôemplacement dans le bucket</li>
</ul>
</section>
<section id="application" class="level3">
<h3 class="anchored" data-anchor-id="application">Application</h3>
<p>Dans <code>VSCode</code>, cr√©er un fichier nomm√© <code>config.yaml</code> et le localiser √† la racine de votre d√©p√¥t. Voici, une proposition de hi√©rarchisation de l‚Äôinformation que vous devez adapter √† votre nom d‚Äôutilisateur :</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">input</span><span class="kw">:</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">bucket</span><span class="kw">:</span><span class="at"> </span><span class="st">"lgaliana"</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">path</span><span class="kw">:</span><span class="at"> </span><span class="st">"ensae-reproductibilite"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Dans <code>main.py</code>, importer ce fichier et remplacer la ligne pr√©c√©demment √©voqu√©e par les valeurs du fichier. Tester en faisant tourner <code>main.py</code> <!-----
https://github.com/linogaliana/ensae-reproductibilite-projet-1/commit/4a9d935223b6af366d4cf2a2a208d98a25407fc6
-----></p>
</section>
</section>
<section id="anaconda" class="level2">
<h2 class="anchored" data-anchor-id="anaconda">Etape 2 : cr√©er un environnement conda √† partir du fichier <code>environment.yml</code></h2>
<p>L‚Äôenvironnement <code>conda</code> cr√©√© avec <code>conda env export</code> (<a href="#conda-export">√©tape 6</a>) contient √©norm√©ment de d√©pendances, dont de nombreuses qui ne nous sont pas n√©cessaires (il en serait de m√™me avec <code>pip freeze</code>). Nous n‚Äôavons en effet besoin que des <em>packages</em> pr√©sents dans la section <code>import</code> de nos scripts et les d√©pendances n√©cessaires pour que ces <em>packages</em> soient fonctionnels.</p>
<p>Vous allez chercher √† obtenir un <code>environment.yml</code> beaucoup plus parcimonieux que celui g√©n√©r√© par <code>conda env export</code></p>
<p></p>
<p>{{% panel name=‚ÄúApproche g√©n√©rale <span class="emoji" data-emoji="koala">üê®</span>‚Äù %}}</p>
<p>Le tableau r√©capitulatif pr√©sent dans la <a href="../portability/#aide-m√©moire">partie portabilit√©</a> peut √™tre utile dans cette partie. L‚Äôid√©e est de partir <em>from scratch</em> et figer l‚Äôenvironnement qui permet d‚Äôavoir une appli fonctionnelle.</p>
<ul>
<li><p>Cr√©er un environnement vide avec <code>Python 3.10</code> <!---
conda create -n monenv python=3.10.0
----></p></li>
<li><p>Activer cet environnement</p></li>
<li><p>Installer en ligne de commande avec <code>pip</code> les packages n√©cessaires pour faire tourner votre code</p></li>
</ul>
<!---
pip install pandas PyYAML s3fs scikit-learn
---->
<ul>
<li><p>Faire un <code>pip freeze &gt; requirements.txt</code> ou <code>conda env export &gt; environment.yml</code> (privil√©gier la deuxi√®me option)</p></li>
<li><p>Retirer la section <code>prefix</code> (si elle est pr√©sente) et changer la section <code>name</code> en <code>monenv</code></p></li>
</ul>
<p>{{% /panel %}}</p>
<p>{{% panel name=‚ÄúApproche fain√©ante <span class="emoji" data-emoji="sloth">ü¶•</span>‚Äù %}}</p>
<p>Nous allons g√©n√©rer une version plus minimaliste gr√¢ce √† l‚Äôutilitaire <a href="https://github.com/bndr/pipreqs"><code>pipreqs</code></a></p>
<ul>
<li>Installer <code>pipreqs</code> en <code>pip install</code></li>
<li>En ligne de commande, depuis la racine du projet, faire <code>pipreqs</code></li>
<li>Ouvrir le <code>requirements.txt</code> automatiquement g√©n√©r√©. Il est beaucoup plus minimal que celui que vous obtiendriez avec <code>pip freeze</code> ou l‚Äô<code>environment.yml</code> obtenu √† <a href="#conda-export">l‚Äô√©tape 6</a>.</li>
<li>Remplacer toute la section <code>dependencies</code> du <code>environment.yml</code> par le contenu du <code>requirements.txt</code> (<span class="emoji" data-emoji="warning">‚ö†Ô∏è</span> ne pas oublier l‚Äôindentation et le tiret en d√©but de ligne)</li>
<li><span class="emoji" data-emoji="warning">‚ö†Ô∏è</span> Modifier le tiret √† <code>scikit learn</code>. Il ne faut pas un <em>underscore</em> mais un tiret</li>
<li>Ajouter la version de python (par exemple <code>python=3.10.0</code>) au d√©but de la section <code>dependencies</code></li>
<li>Retirer la section <code>prefix</code> du fichier <code>environment.yml</code> (si elle est pr√©sente) et changer le contenu de la section <code>name</code> en <code>monenv</code></li>
<li>Cr√©er l‚Äôenvironnement (<a href="../portability/#aide-m√©moire">voir le tableau r√©capitulatif dans la partie portabilit√©</a>)</li>
</ul>
<!----
conda env create -f environment.yml
------>
<p>{{% /panel %}}</p>
<p>{{% /panelset %}}</p>
<p>Maintenant, il reste √† tester si tout fonctionne bien dans notre environnement plus minimaliste:</p>
<ul>
<li>Activer l‚Äôenvironnement</li>
<li>Tester votre script en ligne de commande</li>
<li>Faire un <code>commit</code> quand vous √™tes contents</li>
</ul>
</section>
<section id="docker" class="level2">
<h2 class="anchored" data-anchor-id="docker">Etape 3: conteneuriser avec Docker <i class="fab fa-docker"></i></h2>
<section id="pr√©liminaire" class="level3">
<h3 class="anchored" data-anchor-id="pr√©liminaire">Pr√©liminaire</h3>
<ul>
<li>Se rendre sur l‚Äôenvironnement bac √† sable <a href="https://labs.play-with-docker.com">Play with Docker</a></li>
<li>Dans le terminal <code>Linux</code>, cloner votre d√©p√¥t <code>Github</code> <i class="fab fa-github"></i></li>
<li>Cr√©er via la ligne de commande un fichier <code>Dockerfile</code>. Il y a plusieurs mani√®res de proc√©der, en voici un exemple:</li>
</ul>
<pre class="shell"><code>echo "#Dockerfile pour reproduire mon super travail" &gt; Dockerfile</code></pre>
<ul>
<li>Ouvrir ce fichier via l‚Äô√©diteur propos√© par l‚Äôenvironnement bac √† sable.</li>
</ul>
</section>
<section id="cr√©ation-dun-premier-dockerfile" class="level3">
<h3 class="anchored" data-anchor-id="cr√©ation-dun-premier-dockerfile">Cr√©ation d‚Äôun premier Dockerfile</h3>
<ul>
<li><span class="emoji" data-emoji="one">1Ô∏è‚É£</span> Comme couche de d√©part, partir d‚Äôune image l√©g√®re comme <code>ubuntu:20.04</code></li>
<li><span class="emoji" data-emoji="two">2Ô∏è‚É£</span> Dans une deuxi√®me couche, faire un <code>apt get -y update</code> et installer <code>wget</code> qui va √™tre n√©cessaire pour t√©l√©charger <code>Miniconda</code> depuis la ligne de commande</li>
<li><span class="emoji" data-emoji="three">3Ô∏è‚É£</span> Dans la troisi√®me couche, nous allons installer <code>Miniconda</code> :
<ul>
<li>T√©l√©charger la derni√®re version de <code>Miniconda</code> avec <code>wget</code> depuis l‚Äôurl de t√©l√©chargement direct https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh</li>
<li>Installer <code>Miniconda</code> dans le chemin <code>/home/coder/local/bin/conda</code></li>
<li>Effacer le fichier d‚Äôinstallation pour lib√©rer de la place sur l‚Äôimage</li>
</ul></li>
<li><span class="emoji" data-emoji="four">4Ô∏è‚É£</span> En quatri√®me couche, on va installer <code>mamba</code> pour acc√©l√©rer l‚Äôinstallation des packages dans notre environnement.</li>
<li><span class="emoji" data-emoji="five">5Ô∏è‚É£</span> En cinqui√®me couche, nous allons cr√©er l‚Äôenvironnement <code>conda</code>:
<ul>
<li>Utiliser <code>COPY</code> pour que <code>Docker</code> soit en mesure d‚Äôutiliser le fichier <code>environment.yml</code> (sinon <code>Docker</code> renverra une erreur)</li>
<li>Cr√©er l‚Äôenvironnement vide <code>monenv</code> (pr√©sentant uniquement <code>Python</code> 3.10) avec la commande <code>conda</code> ad√©quate</li>
<li>Mettre √† jour l‚Äôenvironnement en utilisant <code>environment.yml</code> avec <code>mamba</code></li>
</ul></li>
<li><span class="emoji" data-emoji="six">6Ô∏è‚É£</span> Utiliser <code>ENV</code> pour ajouter l‚Äôenvironnement <code>monenv</code> au <code>PATH</code> et utiliser le <em>fix</em> suivant:</li>
</ul>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>RUN echo <span class="st">"export PATH=$PATH"</span> <span class="op">&gt;&gt;</span> <span class="op">/</span>home<span class="op">/</span>coder<span class="op">/</span>.bashrc  <span class="co"># Temporary fix while PATH gets overwritten by code-server</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><span class="emoji" data-emoji="seven">7Ô∏è‚É£</span> Exposer sur le port <code>5000</code></li>
<li><span class="emoji" data-emoji="eight">8Ô∏è‚É£</span> En derni√®re √©tape, utiliser <code>CMD</code> pour reproduire le comportement de <code>python main.py</code></li>
</ul>
<p>{{% box status=‚Äúhint‚Äù title=‚ÄúHint: <code>mamba</code>‚Äù icon=‚Äúfa fa-lightbulb‚Äù %}} <code>mamba</code> est une alternative √† <code>conda</code> pour installer des <em>packages</em> dans un environnement <code>Miniconda</code>/<code>Anaconda</code>. <code>mamba</code> n‚Äôest pas obligatoire, <code>conda</code> peut suffire. Cependant, <code>mamba</code> est beaucoup plus rapide que <code>conda</code> pour installer des packages √† installer ; il s‚Äôagit donc d‚Äôun utilitaire tr√®s pratique. {{% /box %}}</p>
<p></p>
<p>{{% panel name=‚ÄúIndications suppl√©mentaires‚Äù %}}</p>
<p>Cliquer sur les onglets ci-dessus <span class="emoji" data-emoji="point_up_2">üëÜ</span> pour b√©n√©ficier d‚Äôindications suppl√©mentaires, pour vous aider. Cependant, essayez de ne pas les consulter imm√©diatement: n‚Äôh√©sitez pas √† t√¢tonner.</p>
<p>{{% /panel %}}</p>
<p>{{% panel name=‚ÄúInstallation de Miniconda‚Äù %}}</p>
<pre class="shell"><code># INSTALL MINICONDA -------------------------------
ARG CONDA_DIR=/home/coder/local/bin/conda
RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
RUN bash Miniconda3-latest-Linux-x86_64.sh -b -p $CONDA_DIR
RUN rm -f Miniconda3-latest-Linux-x86_64.sh</code></pre>
<p>{{% /panel %}}</p>
<p>{{% panel name=‚ÄúInstallation de mamba‚Äù %}}</p>
<pre class="shell"><code>ENV PATH="/home/coder/local/bin/conda/bin:${PATH}"
RUN conda install mamba -n base -c conda-forge</code></pre>
<p>{{% /panel %}}</p>
<p>{{% panel name=‚ÄúCr√©ation de l‚Äôenvironnement‚Äù %}}</p>
<pre class="shell"><code>COPY environment.yml .
RUN conda create -n monenv python=3.10
RUN mamba env update -n monenv -f environment.yml</code></pre>
<p>{{% /panel %}}</p>
<p></p>
</section>
<section id="construire-limage" class="level3">
<h3 class="anchored" data-anchor-id="construire-limage">Construire l‚Äôimage</h3>
<p>Maintenant, nous avons d√©fini notre recette. Il nous reste √† faire notre plat et √† le go√ªter</p>
<ul>
<li>Utiliser <code>docker build</code> pour cr√©er une image avec le tag <code>my-python-app</code></li>
<li>V√©rifier les images dont vous disposez. Vous devriez avoir un r√©sultat proche de celui-ci</li>
</ul>
<!---
docker build . -t my-python-app
docker images
---->
<pre class="shell"><code>REPOSITORY      TAG       IMAGE ID       CREATED         SIZE
my-python-app   latest    c0dfa42d8520   6 minutes ago   2.23GB
ubuntu          20.04     825d55fb6340   6 days ago      72.8MB</code></pre>
</section>
<section id="tester-limage-d√©couverte-du-cache" class="level3">
<h3 class="anchored" data-anchor-id="tester-limage-d√©couverte-du-cache">Tester l‚Äôimage: d√©couverte du cache</h3>
<p>Il ne reste plus qu‚Äô√† go√ªter la recette et voir si le plat est bon.</p>
<p>Utiliser <code>docker run</code> avec l‚Äôoption <code>it</code> pour pouvoir appeler l‚Äôimage depuis son tag</p>
<!----
docker run -it my-python-app
---->
<p><span class="emoji" data-emoji="warning">‚ö†Ô∏è</span> <span class="emoji" data-emoji="bomb">üí£</span> <span class="emoji" data-emoji="fire">üî•</span> <code>Docker</code> ne sait pas o√π trouver le fichier <code>main.py</code>. D‚Äôailleurs, il ne connait pas d‚Äôautres fichiers de notre application qui sont n√©cessaires pour faire tourner le code: <code>config.yaml</code> et le dossier <code>src</code></p>
<ul>
<li><p>Avant l‚Äô√©tape <code>EXPOSE</code> utiliser plusieurs <code>ADD</code> et/ou <code>COPY</code> pour que l‚Äôapplication dispose de tous les √©l√©ments minimaux pour √™tre en mesure de fonctionner</p></li>
<li><p>Refaire tourner <code>docker run</code> <!---
docker run -it my-python-app
---></p></li>
</ul>
<p>{{% box status=‚Äútip‚Äù title=‚ÄúNote‚Äù icon=‚Äúfa fa-hint‚Äù %}} Ici, le <em>cache</em> permet d‚Äô√©conomiser beaucoup de temps. Par besoin de refaire tourner toutes les √©tapes, <code>Docker</code> agit de mani√®re intelligente en faisant tourner uniquement les nouvelles √©tapes. {{% /box %}}</p>
</section>
<section id="corriger-une-faille-de-reproductibilit√©" class="level3">
<h3 class="anchored" data-anchor-id="corriger-une-faille-de-reproductibilit√©">Corriger une faille de reproductibilit√©</h3>
<p>Vous devriez rencontrer une erreur li√©e √† la variable d‚Äôenvironnement <code>AWS_ENDPOINT_URL</code>. C‚Äôest normal, elle est inconnue de cet environnement minimaliste. D‚Äôailleurs, <code>Docker</code> n‚Äôa aucune raison de conna√Ætre votre espace de stockage sur le <code>S3</code> du <code>SSP-Cloud</code> si vous ne lui dites pas. Donc cet environnement ne sait pas comment acc√©der aux fichiers pr√©sents dans votre <code>minio</code>.</p>
<p>Vous allez r√©gler ce probl√®me avec les √©tapes suivantes, :</p>
<ul>
<li><span class="emoji" data-emoji="one">1Ô∏è‚É£</span> Naviguer dans l‚Äô<a href="https://datalab.sspcloud.fr/mes-fichiers">interface du SSP-Cloud</a> pour retrouver les liens d‚Äôacc√®s direct de vos fichiers</li>
<li><span class="emoji" data-emoji="two">2Ô∏è‚É£</span> Dans <code>VSCode</code>, les mettre dans <code>config.yaml</code> (faire de nouvelles cl√©s)</li>
<li><span class="emoji" data-emoji="three">3Ô∏è‚É£</span> Dans <code>VSCode</code>, modifier la fonction d‚Äôimport pour s‚Äôadapter √† ce changement.</li>
<li><span class="emoji" data-emoji="four">4Ô∏è‚É£</span> Faire un <code>commit</code> et pusher les fichiers</li>
<li><span class="emoji" data-emoji="five">5Ô∏è‚É£</span> Dans l‚Äôenvironnement bac √† sable, faire un <code>pull</code> pour r√©cup√©rer ces modifications</li>
<li><span class="emoji" data-emoji="six">6Ô∏è‚É£</span> Tester √† nouveau le <code>build</code> (l√† encore le <em>cache</em> est bien pratique !)</li>
</ul>
<!---
cf. 
https://github.com/linogaliana/ensae-reproductibilite-projet-1/commit/56946b4c5cb860d50b908d98a87fb549624314a6
----->
<p><span class="emoji" data-emoji="tada">üéâ</span> A ce stade, la matrice de confusion doit fonctionner. Vous avez cr√©√© votre premi√®re application reproductible !</p>
</section>
</section>
</section>
<section id="partie-3-mise-en-production" class="level1">
<h1>Partie 3 : mise en production</h1>
<p>Une image <code>Docker</code> est un livrable qui n‚Äôest pas forc√©ment int√©ressant pour tous les publics. Certains pr√©f√©reront avoir un plat bien pr√©par√© qu‚Äôune recette. Nous allons donc proposer d‚Äôaller plus loin en proposant plusieurs types de livrables. Cela va nous amener √† d√©couvrir les outils du CI/CD (<em>Continuous Integration / Continuous Delivery</em>) qui sont au coeur de l‚Äôapproche <code>DevOps</code>. Notre approche appliqu√©e au <em>machine learning</em> va nous entra√Æner plut√¥t du c√¥t√© du <code>MLOps</code> qui devient une approche de plus en plus fr√©quente dans l‚Äôindustrie de la <em>data science</em>.</p>
<p>Nous allons am√©liorer notre approche de trois mani√®res:</p>
<ul>
<li>Automatisation de la cr√©ation de l‚Äôimage <code>Docker</code> et tests automatis√©s de la qualit√© du code ;</li>
<li>Production d‚Äôun site <em>web</em> automatis√© permettant de documenter et valoriser le mod√®le de <em>Machine Learning</em> ;</li>
<li>Mise √† disposition du mod√®le entra√Æn√© par le biais d‚Äôune API pour ne pas le r√©-entra√Æner √† chaque fois et faciliter sa r√©utilisation ;</li>
</ul>
<p>A chaque fois, nous allons d‚Äôabord tester en local notre travail puis essayer d‚Äôautomatiser cela avec les outils de <code>Github</code>.</p>
<p>On va ici utiliser l‚Äôint√©gration continue pour deux objectifs distincts:</p>
<ul>
<li>la mise √† disposition de l‚Äôimage <code>Docker</code> ;</li>
<li>la mise en place de tests automatis√©s de la qualit√© du code sur le mod√®le de notre <code>linter</code> pr√©c√©dent</li>
</ul>
<p>Nous allons utiliser <code>Github Actions</code> pour cela.</p>
<section id="etape-pr√©liminaire" class="level2">
<h2 class="anchored" data-anchor-id="etape-pr√©liminaire">Etape pr√©liminaire</h2>
<p>Pour ne pas risquer de tout casser sur notre branche <code>master</code>, nous allons nous placer sur une branche nomm√©e <code>dev</code>:</p>
<ul>
<li>si dans l‚Äô√©tape suivante vous appliquez la m√©thode la plus simple, vous allez pouvoir la cr√©er depuis l‚Äôinterface de <code>Github</code> ;</li>
<li>si vous utilisez l‚Äôautre m√©thode, vous allez devoir la cr√©er en local ( via la commande <code>git checkout -b dev</code>)</li>
</ul>
</section>
<section id="etape-1-mise-en-place-de-tests-automatis√©s" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-mise-en-place-de-tests-automatis√©s">Etape 1: mise en place de tests automatis√©s</h2>
<p>Avant d‚Äôessayer de mettre en oeuvre la cr√©ation de notre image <code>Docker</code> de mani√®re automatis√©e, nous allons pr√©senter la logique de l‚Äôint√©gration continue en g√©n√©ralisant les √©valuations de qualit√© du code avec le <code>linter</code></p>
<p></p>
<p>{{% panel name=‚ÄúUtilisation d‚Äôun <em>template</em> <code>Github</code> <span class="emoji" data-emoji="cat">üê±</span>‚Äù %}}</p>
<p><strong>Methode la plus simple: utilisation d‚Äôun <em>template</em> Github</strong></p>
<p>Si vous cliquez sur l‚Äôonglet <code>Actions</code> de votre d√©p√¥t, <code>Github</code> vous propose des <em>workflows</em> standardis√©s reli√©s √† <code>Python</code>. Choisir l‚Äôoption <code>Python Package using Anaconda</code>.</p>
<p>warning: Nous n‚Äôallons modifier que deux √©l√©ments de ce fichier.</p>
<p><span class="emoji" data-emoji="one">1Ô∏è‚É£</span> La derni√®re √©tape (<code>Test with pytest</code>) ne nous est pas n√©cessaire car nous n‚Äôavons pas de tests unitaires Nous allons donc remplacer celle-ci par l‚Äôutilisation de <code>pylint</code> pour avoir une note de qualit√© du package.</p>
<ul>
<li>Utiliser <code>pylint</code> √† cette √©tape pour noter les scripts ;</li>
<li>Vous pouvez fixer un score minimal √† 5 (option <code>--fail-under=5</code>)</li>
</ul>
<p><span class="emoji" data-emoji="two">2Ô∏è‚É£</span> Mettre entre guillements la version de <code>Python</code> pour que celle-ci soit reconnue.</p>
<p><span class="emoji" data-emoji="three">3Ô∏è‚É£</span> Enfin, finaliser la cr√©ation de ce script:</p>
<ul>
<li>En cliquant sur le bouton <code>Start Commit</code>, choisir la m√©thode <code>Create a new branch for this commit and start a pull request</code> en nommant la branche <code>dev</code></li>
<li>Cr√©er la <code>Pull Request</code> en lui donnant un nom signifiant</li>
</ul>
<p>{{% /panel %}}</p>
<p>{{% panel name=‚ÄúM√©thode manuelle‚Äù %}}</p>
<p><span class="emoji" data-emoji="warning">‚ö†Ô∏è</span> On est plut√¥t sur une m√©thode de gal√©rien. Il vaut mieux privil√©gier l‚Äôautre approche</p>
<p>On va √©diter depuis <code>VisualStudio</code> nos fichiers.</p>
<ul>
<li>Cr√©er une branche <code>dev</code> en ligne de commande</li>
<li>Cr√©er un dossier <code>.github/workflows</code> via la ligne de commande ou l‚Äôexplorateur de fichier <!---mkdir .github/workflows -p ----></li>
<li>Cr√©er un fichier <code>.github/workflows/quality.yml</code>.</li>
</ul>
<p>Nous allons construire, par √©tape, une version simplifi√©e du <code>Dockerfile</code> pr√©sent dans <a href="https://medium.com/swlh/enhancing-code-quality-with-github-actions-67561c6f7063">ce post</a> et dans <a href="https://autobencoder.com/2020-08-24-conda-actions/">celui-ci</a></p>
<p><span class="emoji" data-emoji="one">1Ô∏è‚É£</span> D‚Äôabord, d√©finissons des param√®tres pour indiquer √† <code>Github</code> quand faire tourner notre script:</p>
<ul>
<li>Commencez par nommer votre <em>workflow</em> par exemple <code>Python Linting</code> avec la cl√© <code>name</code></li>
<li>Nous allons faire tourner ce <em>workflow</em> dans la branche <code>master</code> et dans la branche actuelle (<code>dev</code>). Ici, nous laissons de c√¥t√© les autres √©l√©ments (par exemple le fait de faire tourner √† chaque <em>pull request</em>). La cl√© <code>on</code> est d√©di√©e √† cet usage</li>
</ul>
<p><span class="emoji" data-emoji="two">2Ô∏è‚É£</span> Ensuite, d√©fnissons le contexte d‚Äôex√©cution des t√¢ches (<code>jobs</code>) de notre script dans les options de la partie <code>build</code>:</p>
<ul>
<li>Utilisons une machine <code>ubuntu-latest</code>. Nous verrons plus tard comment am√©liorer cela.</li>
</ul>
<p><span class="emoji" data-emoji="three">3Ô∏è‚É£</span> Nous allons ensuite m√©langer des √©tapes pr√©-d√©finies (des actions du <em>marketplace</em>) et des instructions que nous faisons :</p>
<ul>
<li>Le <em>runner</em> <code>Github</code> doit r√©cup√©rer le contenu de notre d√©p√¥t, pour cela utiliser l‚Äôaction <code>checkout</code>. Par rapport √† l‚Äôexemple, il convient d‚Äôajouter, pour le moment, un param√®tre <code>ref</code> avec le nom de la branche (par exemple <code>dev</code>)</li>
<li><del>On installe ensuite <code>Python</code> avec l‚Äôaction <code>setup-python</code></del> Pas besoin d‚Äôinstaller <code>Python</code>, on va utiliser l‚Äôoption <code>conda-incubator/setup-miniconda@v2</code></li>
<li>Pour installer <code>Python</code> et l‚Äôenvironnement <code>conda</code>, on va plut√¥t utiliser l‚Äôastuce de <a href="https://autobencoder.com/2020-08-24-conda-actions/">ce blog</a> avec l‚Äôoption <code>conda-incubator/setup-miniconda@v2</code></li>
<li>On utilise ensuite <code>flake8</code> et <code>pylint</code> (option <code>--fail-under=5</code>) pour effectuer des diagnostics de qualit√©</li>
</ul>
<p>Il ne reste plus qu‚Äô√† faire un <code>commit</code> et esp√©rer que cela fonctionne. Cela devrait donner le fichier suivant :</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Python Linting</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">master</span><span class="kw">,</span><span class="at"> dev</span><span class="kw">]</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest    </span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">ref</span><span class="kw">:</span><span class="at"> </span><span class="st">"dev"</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> conda-incubator/setup-miniconda@v2</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">activate-environment</span><span class="kw">:</span><span class="at"> monenv</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">environment-file</span><span class="kw">:</span><span class="at"> environment.yml</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">python-version</span><span class="kw">:</span><span class="at"> </span><span class="st">'3.10'</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">auto-activate-base</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">shell</span><span class="kw">:</span><span class="at"> bash -l {0}</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>          conda info</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>          conda list</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Lint with flake8</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>          pip install flake8</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>          flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>          flake8 src --count --max-complexity=10 --max-line-length=79 --statistics</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Lint with Pylint</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>          pip install pylint</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>          pylint src</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>{{% /panel %}}</p>
<p></p>
<p>Maintenant, nous pouvons observer que l‚Äôonglet <code>Actions</code> s‚Äôest enrichi. Chaque <code>commit</code> va entra√Æner une action pour tester nos scripts.</p>
<p>Si la note est mauvaise, nous aurons une croix rouge (et nous recevrons un mail). On pourra ainsi d√©tecter, en d√©veloppant son projet, les moments o√π on d√©grade la qualit√© du script afin de la r√©tablir imm√©diatemment.</p>
<p>{{% box status=‚Äúhint‚Äù title=‚ÄúUn <code>linter</code> sous forme de <em>hook</em> pre-commit‚Äù icon=‚Äúfa fa-lightbulb‚Äù %}}</p>
<p><code>Git</code> offre une fonctionalit√© int√©ressante lorsqu‚Äôon est puriste: les <em>hooks</em>. Il s‚Äôagit de r√®gles qui doivent √™tre satisfaites pour que le fichier puisse √™tre committ√©. Cela assurera que chaque <code>commit</code> remplisse des crit√®res de qualit√© afin d‚Äô√©viter le probl√®me de la procrastination.</p>
<p>La <a href="https://pylint.pycqa.org/en/latest/user_guide/pre-commit-integration.html">documentation de pylint</a> offre des explications suppl√©mentaires.</p>
<p>{{% /box %}}</p>
</section>
<section id="etape-2-automatisation-de-la-livraison-de-limage-docker" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-automatisation-de-la-livraison-de-limage-docker">Etape 2: Automatisation de la livraison de l‚Äôimage <code>Docker</code></h2>
<p>Maintenant, nous allons automatiser la mise √† disposition de notre image sur <code>DockerHub</code>. Cela facilitera sa r√©utilisation mais aussi des valorisations ult√©rieures.</p>
<p>L√† encore, nous allons utiliser une s√©rie d‚Äôactions pr√©-configur√©es.</p>
<p><span class="emoji" data-emoji="one">1Ô∏è‚É£</span> Pour que <code>Github</code> puisse s‚Äôauthentifier aupr√®s de <code>DockerHub</code>, il va falloir d‚Äôabord interfacer les deux plateformes. Pour cela, nous allons utiliser un jeton (<em>token</em>) <code>DockerHub</code> que nous allons mettre dans un espace s√©curis√© associ√© √† votre d√©p√¥t <code>Github</code>. Cette d√©marche sera l√† m√™me ult√©rieurement lorsque nous connecterons notre d√©p√¥t √† un autre service tiers, √† savoir <code>Netlify</code>:</p>
<ul>
<li>Se rendre sur https://hub.docker.com/ et cr√©er un compte.</li>
<li>Aller dans les param√®tres (https://hub.docker.com/settings/general) et cliquer, √† gauche, sur <code>Security</code></li>
<li>Cr√©er un jeton personnel d‚Äôacc√®s, ne fermez pas l‚Äôonglet en question, vous ne pouvez voir sa valeur qu‚Äôune fois.</li>
<li>Dans votre d√©p√¥t <code>Github</code>, cliquer sur l‚Äôonglet <code>Settings</code> et cliquer, √† gauche, sur <code>Actions</code>. Sur la page qui s‚Äôaffiche, cliquer sur <code>New repository secret</code></li>
<li>Donner le nom <code>DOCKERHUB_TOKEN</code> √† ce jeton et copier la valeur. Valider</li>
<li>Cr√©er un deuxi√®me secret nomm√© <code>DOCKERHUB_USERNAME</code> ayant comme valeur le nom d‚Äôutilisateur que vous avez cr√©√© sur <code>Dockerhub</code></li>
</ul>
<p><span class="emoji" data-emoji="two">2Ô∏è‚É£</span> A ce stade, nous avons donn√© les moyens √† <code>Github</code> de s‚Äôauthentifier avec notre identit√© sur <code>Dockerhub</code>. Il nous reste √† mettre en oeuvre l‚Äôaction en s‚Äôinspirant de https://github.com/docker/build-push-action/#usage. On ne va modifier que trois √©l√©ments dans ce fichier. Effectuer les actions suivantes:</p>
<ul>
<li>Cr√©er depuis <code>VSCode</code> un fichier <code>.github/workflows/docker.yml</code> et coller le contenu du <em>template</em> dedans ;</li>
<li>Changer le nom en un titre plus signifiant (par exemple <em>‚ÄúProduction de l‚Äôimage Docker‚Äù</em>)</li>
<li>Ajouter <code>master</code> et <code>dev</code> √† la liste des branches sur lesquelles tourne le pipeline ;</li>
<li>Changer le tag √† la fin pour mettre <code>&lt;username&gt;/ensae-repro-docker:latest</code> o√π <code>username</code> est le nom d‚Äôutilisateur sur <code>DockerHub</code>;</li>
<li>Faire un <code>commit</code> et un <code>push</code> de ces fichiers</li>
</ul>
<p><span class="emoji" data-emoji="four">4Ô∏è‚É£</span> Comme on est fier de notre travail, on va afficher √ßa avec un badge sur le <code>README</code>. Pour cela, on se rend dans l‚Äôonglet <code>Actions</code> et on clique sur un des scripts en train de tourner.</p>
<ul>
<li>En haut √† droite, on clique sur <code>...</code></li>
<li>S√©lectionner <code>Create status badge</code></li>
<li>R√©cup√©rer le code <code>Markdown</code> propos√©</li>
<li>Copier dans le <code>README</code> depuis <code>VSCode</code></li>
<li>Faire de m√™me pour l‚Äôautre <em>workflow</em></li>
</ul>
<p><span class="emoji" data-emoji="five">5Ô∏è‚É£</span> Maintenant, il nous reste √† tester notre application dans l‚Äôespace bac √† sable:</p>
<ul>
<li>Se rendre sur l‚Äôenvironnement bac √† sable</li>
<li>Cr√©er un fichier <code>Dockerfile</code> ne contenant que l‚Äôimport et le d√©ploiement de l‚Äôappli:</li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="at">FROM &lt;username&gt;/ensae-repro-docker:latest</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="at">EXPOSE 5000</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="at">CMD ["python", "main.py"]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Comme pr√©c√©demment, faire un <em>build</em></li>
<li>Tester l‚Äôimage avec <code>run</code></li>
</ul>
<p><span class="emoji" data-emoji="tada">üéâ</span> La matrice de confusion doit s‚Äôafficher ! Vous avez grandement facilit√© la r√©utilisation de votre image.</p>
</section>
<section id="etape-3-cr√©ation-dun-rapport-automatique" class="level2">
<h2 class="anchored" data-anchor-id="etape-3-cr√©ation-dun-rapport-automatique">Etape 3: cr√©ation d‚Äôun rapport automatique</h2>
<p>Maintenant, nous allons cr√©er et d√©ployer un site web pour valoriser notre travail. Cela va impliquer trois √©tapes:</p>
<ul>
<li>Tester en local le logiciel <code>quarto</code> et cr√©er un rapport minimal qui sera compil√© par <code>quarto</code> ;</li>
<li>Enrichir l‚Äôimage docker avec le logiciel <code>quarto</code> ;</li>
<li>Compiler le document en utilisant cette image sur les serveurs de <code>Github</code> ;</li>
<li>D√©ployer ce rapport minimal pour le rendre disponible √† tous sur le <em>web</em>.</li>
</ul>
<p>Le but est de proposer un rapport minimal qui illustre la performance du mod√®le est la <em>feature importance</em>. Pour ce dernier √©l√©ment, le rapport qui sera propos√© utilise <code>shap</code> qui est une librairie d√©di√©e √† l‚Äôinterpr√©tabilit√© des mod√®les de <em>machine learning</em></p>
<section id="rapport-minimal-en-local" class="level3">
<h3 class="anchored" data-anchor-id="rapport-minimal-en-local">1. Rapport minimal en local</h3>
<p><span class="emoji" data-emoji="one">1Ô∏è‚É£</span> La premi√®re √©tape consiste √† installer <code>quarto</code> sur notre machine <code>Linux</code> sur laquelle tourne <code>VSCode</code>:</p>
<ul>
<li>Dans un terminal, installer <code>quarto</code> avec les commandes suivantes:</li>
</ul>
<pre class="shell"><code>QUARTO_VERSION="0.9.287"
wget "https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.deb"
sudo apt install "./quarto-${QUARTO_VERSION}-linux-amd64.deb"</code></pre>
<ul>
<li>S‚Äôassurer qu‚Äôon travaille bien depuis l‚Äôenvironnement <code>conda</code> <code>monenv</code>. Sinon l‚Äôactiver</li>
</ul>
<p><span class="emoji" data-emoji="two">2Ô∏è‚É£</span> Il va √™tre n√©cessaire d‚Äôenrichir l‚Äôenvironnement <code>conda</code>. Certaines d√©pendances sont n√©cessaires pour que <code>quarto</code> fonctionne bien avec <code>Python</code> (<code>jupyter</code>, <code>nbclient</code>‚Ä¶) alors que d‚Äôautres ne sont n√©cessaires que parce qu‚Äôils sont utilis√©s dans le document (<code>seaborn</code>, <code>shap</code>‚Ä¶). Changer la section <code>dependencies</code> avec la liste suivante:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> python=3.10.0</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> ipykernel==6.13.0</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> jupyter==1.0.0</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> matplotlib==3.5.1</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> nbconvert==6.5.0</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> nbclient==0.6.0</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> nbformat==5.3.0</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> pandas==1.4.1</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> PyYAML==6.0</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> s3fs==2022.2.0</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> scikit-learn==1.0.2</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> seaborn==0.11.2</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> shap==0.40.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table">
<caption>three: Cr√©er un fichier nomm√© <code>report.qmd</code></caption>
<thead>
<tr class="header">
<th>~markdown</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>title: ‚ÄúComprendre les facteurs de survie sur le Titanic‚Äù</td>
</tr>
<tr class="even">
<td>subtitle: ‚ÄúUn rapport innovant‚Äù</td>
</tr>
<tr class="odd">
<td>format:</td>
</tr>
<tr class="even">
<td>html:</td>
</tr>
<tr class="odd">
<td>self-contained: true</td>
</tr>
<tr class="even">
<td>ipynb: default</td>
</tr>
<tr class="odd">
<td>jupyter: python3</td>
</tr>
</tbody>
</table>
<p>Voici un rapport pr√©sentant quelques intuitions issues d‚Äôun mod√®le <em>random forest</em> sur le jeu de donn√©es <code>Titanic</code> entra√Æn√© et d√©ploy√© de mani√®re automatique.</p>
<p>Il est possible de t√©l√©charger cette page sous format <code>Jupyter Notebook</code> <a href="report.ipynb" download="">ici</a></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> main</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> main.X_train</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> main.y_train</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>training_data <span class="op">=</span> main.training_data</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>rdmf <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>rdmf.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="feature-importance" class="level1">
<h1>Feature importance</h1>
<p>La <strong>?@fig-feature-importance</strong> repr√©sente l‚Äôimportance des variables :</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>feature_imp <span class="op">=</span> pd.Series(rdmf.feature_importances_, index<span class="op">=</span>training_data.iloc[:,<span class="dv">1</span>:].columns).sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-feature-importance</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Feature importance"</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">6</span>))</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span>feature_imp, y<span class="op">=</span>feature_imp.index)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels to your graph</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Feature Importance Score'</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Features'</span>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Visualizing Important Features"</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Celle-ci peut √©galement √™tre obtenue gr√¢ce √† la librairie <code>shap</code>:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo : true</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shap</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>shap_values <span class="op">=</span> shap.TreeExplainer(rdmf).shap_values(X_train)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>shap.summary_plot(shap_values, X_train, plot_type<span class="op">=</span><span class="st">"bar"</span>, feature_names <span class="op">=</span> training_data.iloc[:,<span class="dv">1</span>:].columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On peut √©galement utiliser cette librairie pour interpr√©ter la pr√©diction de notre mod√®le:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># explain all the predictions in the test set</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>explainer <span class="op">=</span> shap.TreeExplainer(rdmf)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Shap values</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>choosen_instance <span class="op">=</span> main.X_test[<span class="dv">15</span>]</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>shap_values <span class="op">=</span> explainer.shap_values(choosen_instance)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>shap.initjs()</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>shap.force_plot(explainer.expected_value[<span class="dv">1</span>], shap_values[<span class="dv">1</span>], choosen_instance, feature_names <span class="op">=</span> training_data.iloc[:,<span class="dv">1</span>:].columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="qualit√©-pr√©dictive-du-mod√®le" class="level1">
<h1>Qualit√© pr√©dictive du mod√®le</h1>
<p>La matrice de confusion est pr√©sent√©e sur la <strong>?@fig-confusion</strong></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-confusion</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Matrice de confusion"</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>conf_matrix <span class="op">=</span> confusion_matrix(main.y_test, rdmf.predict(main.X_test))</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">5</span>))</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>sns.heatmap(conf_matrix, annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Confusion Matrix'</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ou, sous forme de tableau:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(conf_matrix, columns<span class="op">=</span>[<span class="st">'Predicted'</span>,<span class="st">'Observed'</span>], index <span class="op">=</span> [<span class="st">'Predicted'</span>,<span class="st">'Observed'</span>]).to_html()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>~~~</p>
<p><span class="emoji" data-emoji="four">4Ô∏è‚É£</span> On va tenter de compiler ce document</p>
<ul>
<li><p>Le compiler en local avec la commande <code>quarto render report.qmd</code></p></li>
<li><p>Vous devriez rencontrer l‚Äôerreur suivante:</p></li>
</ul>
<div class="sourceCode" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="op">---------------------------------------------------------------------------</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="pp">AttributeError</span>                            Traceback (most recent call last)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>Input In [<span class="dv">1</span>], <span class="kw">in</span> <span class="op">&lt;</span>cell line: <span class="dv">6</span><span class="op">&gt;</span>()</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>      <span class="dv">4</span> <span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>      <span class="dv">5</span> <span class="im">import</span> main</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="op">----&gt;</span> <span class="dv">6</span> X_train <span class="op">=</span> main.X_train</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>      <span class="dv">7</span> y_train <span class="op">=</span> main.y_train</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>      <span class="dv">8</span> training_data <span class="op">=</span> main.training_data</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="pp">AttributeError</span>: module <span class="st">'main'</span> has no attribute <span class="st">'X_train'</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="pp">AttributeError</span>: module <span class="st">'main'</span> has no attribute <span class="st">'X_train'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>Refactoriser <code>main.py</code> pour que toutes les op√©rations, √† l‚Äôexception du print de la matrice de confusion ne soient plus dans la section <code>__main__</code> afin qu‚Äôils soient syst√©matiquement ex√©cut√©s.</p></li>
<li><p>Tenter √† nouveau <code>quarto render report.qmd</code></p></li>
<li><p>Deux fichiers ont √©t√© g√©n√©r√©s:</p>
<ul>
<li>un <code>Notebook</code> que vous pouvez ouvrir et dont vous pouvez ex√©cuter des cellules</li>
<li>un fichier <code>HTML</code> que vous pouvez t√©l√©charger et ouvrir</li>
</ul></li>
</ul>
<p><span class="emoji" data-emoji="five">5Ô∏è‚É£</span> On a d√©j√† un r√©sultat assez esth√©tique en ce qui concerne la page <code>HTML</code>. Cependant, on peut se dire que certains param√®tres par d√©faut, comme l‚Äôaffichage des blocs de code, ne conviennent pas au public cibl√©. De m√™me, certains param√®tres de style, comme l‚Äôaffichage des tableaux peuvent ne pas convenir √† notre charte graphique. On va rem√©dier √† cela en deux √©tapes:</p>
<ul>
<li>enrichir le <em>header</em> d‚Äôoptions globales contr√¥lant le comportement de <code>quarto</code></li>
<li>cr√©er un fichier <code>CSS</code> pour avoir de beaux tableaux</li>
</ul>
<p><span class="emoji" data-emoji="six">6Ô∏è‚É£</span> Changer la section <code>format</code> du <em>header</em> avec les options suivantes:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">format</span><span class="kw">:</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">html</span><span class="kw">:</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">echo</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">code-fold</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">self-contained</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">code-summary</span><span class="kw">:</span><span class="at"> </span><span class="st">"Show the code"</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">warning</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">message</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">theme</span><span class="kw">:</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> cosmo</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> css/custom.scss</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ipynb</span><span class="kw">:</span><span class="at"> default</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><span class="emoji" data-emoji="seven">7Ô∏è‚É£</span> Cr√©er le fichier <code>css/custom.scss</code> avec le contenu suivant:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode css code-with-copy"><code class="sourceCode css"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*-- scss:rules --*/</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>table {</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">border-collapse</span>: <span class="dv">collapse</span><span class="op">;</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">margin</span>: <span class="dv">25</span><span class="dt">px</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-size</span>: <span class="dv">0.9</span><span class="dt">em</span><span class="op">;</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-family</span>: <span class="dv">sans-serif</span><span class="op">;</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">min-width</span>: <span class="dv">400</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">box-shadow</span>: <span class="dv">0</span> <span class="dv">0</span> <span class="dv">20</span><span class="dt">px</span> <span class="fu">rgba(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0.15</span><span class="fu">)</span><span class="op">;</span>  </span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>thead tr {</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">background-color</span>: <span class="cn">#516db0</span><span class="op">;</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">color</span>: <span class="cn">#ffffff</span><span class="op">;</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">text-align</span>: <span class="dv">center</span><span class="op">;</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>th<span class="op">,</span> td {</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">padding</span>: <span class="dv">12</span><span class="dt">px</span> <span class="dv">15</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>tbody tr {</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">border-bottom</span>: <span class="dv">1</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#dddddd</span><span class="op">;</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>tbody tr<span class="in">:nth-of-type(even)</span> {</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">background-color</span>: <span class="cn">#f3f3f3</span><span class="op">;</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>tbody tr<span class="in">:last-of-type</span> {</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">border-bottom</span>: <span class="dv">2</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#516db0</span><span class="op">;</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>tbody tr<span class="fu">.active-row</span> {</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-weight</span>: <span class="dv">bold</span><span class="op">;</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">color</span>: <span class="cn">#009879</span><span class="op">;</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><span class="emoji" data-emoji="eight">8Ô∏è‚É£</span> Compiler √† nouveau et observer le changement d‚Äôesth√©tique du <code>HTML</code></p>
<p><span class="emoji" data-emoji="nine">9Ô∏è‚É£</span> Commit des nouveaux fichier <code>report.qmd</code>, <code>custom.scss</code> et des fichiers d√©j√† existants.</p>
<p>{{% box status=‚Äúhint‚Äù title=‚ÄúUn <code>linter</code> sous forme de <em>hook</em> pre-commit‚Äù icon=‚Äúfa fa-lightbulb‚Äù %}}</p>
<p>On ne <code>commit</code> pas les <em>output</em>, ici le notebook et le fichier html. Les mettre sur le d√©p√¥t <code>Github</code> n‚Äôest pas la bonne mani√®re de les mettre √† disposition. On va le voir, on va utiliser l‚Äôapproche CI/CD pour cela.</p>
<p>Id√©alement, on ajoute au <code>.gitignore</code> les fichiers concern√©s, ici <code>report.ipynb</code> et <code>report.html</code></p>
<p>{{% /box %}}</p>
<section id="enrichir-limage-docker" class="level3">
<h3 class="anchored" data-anchor-id="enrichir-limage-docker">3. Enrichir l‚Äôimage <code>Docker</code></h3>
<p>On va vouloir mettre √† jour notre image pour automatiser, √† terme, la production de nos livrables (le notebook et la page web).</p>
<p>Pour cela, il est n√©cessaire que notre image int√®gre le logiciel <code>quarto</code>.</p>
<p><span class="emoji" data-emoji="one">1Ô∏è‚É£</span> A partir du script pr√©c√©dent d‚Äôinstallation de <code>quarto</code>, enrichir l‚Äôimage <code>Docker</code><a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a></p>
<!----
ENV QUARTO_VERSION="0.9.287"
RUN wget "https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.deb"
RUN apt install "./quarto-${QUARTO_VERSION}-linux-amd64.deb"
----->
</section>
<section id="automatisation-avec-github-actions" class="level3">
<h3 class="anchored" data-anchor-id="automatisation-avec-github-actions">4. Automatisation avec <code>Github Actions</code></h3>
<p><span class="emoji" data-emoji="one">1Ô∏è‚É£</span> Cr√©er un nouveau fichier <code>.github/workflows.report.yml</code></p>
<p>Si les d√©pendances et l‚Äôimage ont bien √©t√© enrichis, cette √©tape est quasi directe avec</p>
<p></p>
<p>{{% panel name=‚ÄúVersion autonome <span class="emoji" data-emoji="car">üöó</span>‚Äù %}}</p>
<ul>
<li>Donner comme nom <code>Deploy as website</code></li>
<li>Effectuer cette action √† chaque <code>push</code> sur les branches <code>main</code>, <code>master</code> et <code>dev</code></li>
<li>Le job doit tourner sur une machine <code>ubuntu</code></li>
<li>Cependant, il convient d‚Äôutiliser comme <code>container</code> votre image Docker</li>
<li>Les <code>steps</code>:
<ul>
<li>R√©cup√©rer le contenu du dossier avec <code>checkout</code></li>
<li>Faire un <code>quarto render</code></li>
<li>R√©cup√©rer le notebook sous forme d‚Äôartefact</li>
</ul></li>
</ul>
<p>{{% /panel %}}</p>
<p>{{% panel name=‚ÄúVersion guid√©e :map:‚Äù %}}</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy as website</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> main</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> master</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> dev</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container</span><span class="kw">:</span><span class="at"> linogaliana/ensae-repro-docker:latest</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Render site</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> quarto render report.qmd</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/upload-artifact@v1</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Report</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> report.ipynb</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>{{% /panel %}}</p>
<p></p>
<p>Si vous √™tes fier de vous, vous pouvez ajouter le badge de ce workflow sur le <code>README</code> <span class="emoji" data-emoji="sunglasses">üòé</span></p>
<p>Cette √©tape nous a permis d‚Äôautomatiser la construction de nos livrables. Mais la mise √† disposition de ce livrable est encore assez manuelle: il faut aller chercher √† la main la derni√®re version du notebook pour la partager.</p>
<p>On va am√©liorer cela en d√©ployant automatiquement un site <em>web</em> pr√©sentant en page d‚Äôaccueil notre rapport et permettant le t√©l√©chargement du notebook.</p>
</section>
<section id="etape-4-d√©ploiement-de-ce-rapport-automatique-sur-le-web" class="level2">
<h2 class="anchored" data-anchor-id="etape-4-d√©ploiement-de-ce-rapport-automatique-sur-le-web">Etape 4: D√©ploiement de ce rapport automatique sur le web</h2>
<p><span class="emoji" data-emoji="one">1Ô∏è‚É£</span> Dans un premier temps, nous allons connecter notre d√©p√¥t <code>Github</code> au service tiers <code>Netlify</code></p>
<ul>
<li>Aller sur https://www.netlify.com/ et faire <code>Sign up</code> (utiliser son compte <code>Github</code>)</li>
<li>Dans la page d‚Äôaccueil de votre profil, vous pouvez cliquer sur <code>Add new site &gt; Import an existing project</code></li>
<li>Cliquer sur <code>Github</code>. S‚Äôil y a des autorisations √† donner, les accorder. Rechercher votre projet dans la liste de vos projets <code>Github</code></li>
<li>Cliquer sur le nom du projet et laisser les param√®tres par d√©faut (nous allons modifier par la suite)</li>
<li>Cliquer sur <code>Deploy site</code></li>
</ul>
<p><span class="emoji" data-emoji="two">2Ô∏è‚É£</span> A ce stade, votre d√©ploiement devrait √©chouer. C‚Äôest normal, vous essayez de d√©ployer depuis <code>master</code> qui ne comporte pas de html. Mais le rapport n‚Äôest pas non plus pr√©sent dans la branche <code>dev</code>. En fait, aucune branche ne comporte le rapport: celui-ci est g√©n√©r√© dans votre <em>pipeline</em> mais n‚Äôest jamais pr√©sent dans le d√©p√¥t car il s‚Äôagit d‚Äôun <em>output</em>. On va d√©sactiver le d√©ploiement automatique pour privil√©gier un d√©ploiement depuis <code>Github Actions</code>:</p>
<ul>
<li>Aller dans <code>Site Settings</code> puis, √† gauche, cliquer sur <code>Build and Deploy</code></li>
<li>Dans la section <code>Build settings</code>, cliquer sur <code>Stop builds</code> et valider</li>
</ul>
<p>On vient de d√©sactiver le d√©ploiement automatique par d√©faut. On va faire communiquer notre d√©p√¥t <code>Github</code> et <code>Netlify</code> par le biais de l‚Äôint√©gration continue.</p>
<p><span class="emoji" data-emoji="three">3Ô∏è‚É£</span> Pour cela, il faut cr√©er un jeton <code>Netlify</code> pour que les serveurs de <code>Github</code>, lorsqu‚Äôils disposent d‚Äôun rapport, puissent l‚Äôenvoyer √† <code>Netlify</code> pour la mise sur le <em>web</em>. Il va √™tre n√©cessaire de cr√©er deux variables d‚Äôenvironnement pour connecter <code>Github</code> et <code>Netlify</code>: l‚Äôidentifiant du site et le <em>token</em></p>
<ul>
<li>Pour le token :
<ul>
<li>Cr√©er un jeton en cliquant, en haut √† droite, sur l‚Äôicone de votre profil. Aller dans <code>User settings</code>. A gauche, cliquer sur <code>Applications</code> et cr√©er un jeton personnel d‚Äôacc√®s avec un nom signifiant (par exemple <code>PAT_ENSAE_reproductibilite</code>)</li>
<li>Mettre de c√¥t√© (conseil : garder l‚Äôonglet ouvert)</li>
</ul></li>
<li>Pour l‚Äôidentifiant du site:
<ul>
<li>cliquer sur <code>Site Settings</code> dans les onglets en haut</li>
<li>Garder l‚Äôonglet ouvert pour copier la valeur quand n√©cessaire</li>
</ul></li>
<li>Il est maintenant n√©cessaire d‚Äôaller dans le d√©p√¥t <code>Github</code> et de cr√©er les secrets (<code>Settings &gt; Secrets &gt; Actions</code>):
<ul>
<li>Cr√©er le secret <code>NETLIFY_AUTH_TOKEN</code> en collant la valeur du jeton d‚Äôauthentification <code>Netlify</code></li>
<li>Cr√©er le secret <code>NETLIFY_SITE_ID</code> en collant l‚Äôidentifiant du site</li>
</ul></li>
</ul>
<p><span class="emoji" data-emoji="four">4Ô∏è‚É£</span> Nous avons effectu√© toutes les configurations n√©cessaires. On va maintenant mettre √† jour l‚Äôint√©gration continue afin de mettre √† disposition sur le <em>web</em> notre rapport. On va utiliser l‚Äôinterface en ligne de commande (CLI) de <code>Netlify</code>. Celle-ci attend que le site <em>web</em> se trouve dans un dossier <code>public</code> et que la page d‚Äôaccueil soit nomm√©e <code>index.html</code>:</p>
<p></p>
<p>{{% panel name=‚ÄúVision d‚Äôensemble‚Äù %}}</p>
<ul>
<li>une installation de <code>npm</code></li>
<li>une √©tape de d√©ploiement via la CLI de netlify</li>
</ul>
<div class="sourceCode" id="cb44"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install npm</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-node@v2</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">node-version</span><span class="kw">:</span><span class="at"> </span><span class="st">'14'</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to Netlify</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">  # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repo's secrets</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">NETLIFY_AUTH_TOKEN</span><span class="kw">:</span><span class="at"> ${{ secrets.NETLIFY_AUTH_TOKEN }}</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">NETLIFY_SITE_ID</span><span class="kw">:</span><span class="at"> ${{ secrets.NETLIFY_SITE_ID }}</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="fu">  run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    mkdir -p public</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    mv report.html public/index.html</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    mv report.ipynb public/report.ipynb</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    npm install --unsafe-perm=true netlify-cli -g</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    netlify init</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    netlify deploy --prod --dir="public" --message "Deploy master"</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>{{% /panel %}}</p>
<p>{{% panel name=‚ÄúD√©tails npm‚Äù %}}</p>
<p></p>
<ul>
<li>name: Install npm uses: actions/setup-node@v2 with: node-version: ‚Äò14‚Äô</li>
</ul>
<p></p>
<p><code>npm</code> est le gestionnaire de paquet de JS. Il est n√©cessaire de le configurer, ce qui est fait automatiquement gr√¢ce √† l‚Äôaction <code>actions/setup-node@v2</code></p>
<p>{{% /panel %}}</p>
<p>{{% panel name=‚ÄúD√©tails <code>Netlify CLI</code>‚Äù %}}</p>
<ul>
<li>On rappelle √† <code>Github Actions</code> nos param√®tres d‚Äôauthentification sous forme de variables d‚Äôenvironnement. Cela permet de les garder secr√®tes</li>
</ul>
<p></p>
<ul>
<li>name: Deploy to Netlify # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repo‚Äôs secrets env: NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }} run: | mkdir -p public mv report.html public/index.html mv report.ipynb public/report.ipynb npm install ‚Äìunsafe-perm=true netlify-cli -g netlify init netlify deploy ‚Äìprod ‚Äìdir=‚Äúpublic‚Äù ‚Äìmessage ‚ÄúDeploy master‚Äù</li>
</ul>
<p></p>
<ul>
<li>On d√©place les rapports de la racine vers le dossier <code>public</code></li>
</ul>
<p></p>
<ul>
<li>name: Deploy to Netlify # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repo‚Äôs secrets env: NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }} run: | mkdir -p public mv report.html public/index.html mv report.ipynb public/report.ipynb npm install ‚Äìunsafe-perm=true netlify-cli -g netlify init netlify deploy ‚Äìprod ‚Äìdir=‚Äúpublic‚Äù ‚Äìmessage ‚ÄúDeploy master‚Äù</li>
</ul>
<p></p>
<ul>
<li>On installe et initialise <code>Netlify</code></li>
</ul>
<p></p>
<ul>
<li>name: Deploy to Netlify # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repo‚Äôs secrets env: NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }} run: | mkdir -p public mv report.html public/index.html mv report.ipynb public/report.ipynb npm install ‚Äìunsafe-perm=true netlify-cli -g netlify init netlify deploy ‚Äìprod ‚Äìdir=‚Äúpublic‚Äù ‚Äìmessage ‚ÄúDeploy master‚Äù</li>
</ul>
<p></p>
<ul>
<li>On d√©ploie sur l‚Äôurl par d√©faut (<code>-- prod</code>) depuis le dossier <code>public</code></li>
</ul>
<p></p>
<ul>
<li>name: Deploy to Netlify # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repo‚Äôs secrets env: NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }} run: | mkdir -p public mv report.html public/index.html mv report.ipynb public/report.ipynb npm install ‚Äìunsafe-perm=true netlify-cli -g netlify init netlify deploy ‚Äìprod ‚Äìdir=‚Äúpublic‚Äù ‚Äìmessage ‚ÄúDeploy master‚Äù</li>
</ul>
<p></p>
<p>{{% /panel %}}</p>
<p></p>
<p>Au bout de quelques minutes, le rapport est disponible en ligne sur l‚ÄôURL <code>Netlify</code> (par exemple https://spiffy-florentine-c913b9.netlify.app)</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>L‚Äôexport dans un script <code>.py</code> a √©t√© fait avec <a href="https://jupytext.readthedocs.io/en/latest/index.html"><code>Jupytext</code></a>. Comme cela n‚Äôest pas vraiment l‚Äôobjet du cours, nous passons cette √©tape et fournissons directement le script. Mais n‚Äôoubliez pas que cette d√©marche, fr√©quente quand on a d√©marr√© sur un <em>notebook</em> et qu‚Äôon d√©sire consolider en faisant la transition vers des scripts, n√©cessite d‚Äô√™tre attentif pour ne pas risquer de faire une erreur.<a href="#fnref1" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn2"><p>Essayez de <em>commit</em> vos changements √† chaque √©tape de l‚Äôexercice, c‚Äôest une bonne habitude √† prendre.<a href="#fnref2" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn3"><p>Nous le verrons lorsque nous mettrons en oeuvre l‚Äôint√©gration continue.<a href="#fnref3" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn4"><p>Ici, le jeton d‚ÄôAPI n‚Äôest pas indispensable pour que le code fonctionne. Afin d‚Äô√©viter une erreur non n√©cessaire lorsqu‚Äôon automatisera le processus, on peut cr√©er une condition qui v√©rifie la pr√©sence ou non de ce fichier.</p>
<p>Cela peut √™tre fait avec la fonction <code>os.path.exists</code> :</p>
<pre><code>if os.path.exists('secrets.yaml'):
    secrets = import_yaml_config("secrets.yaml")</code></pre>
<p>La variable <code>secrets</code> n‚Äôexistera que dans le cas o√π un fichier <code>secrets.yaml</code> existe. Le script reste donc reproductible m√™me pour un utilisateur n‚Äôayant pas le fichier <code>secrets.yaml</code>.<a href="#fnref4" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn5"><p>Nous proposons ici d‚Äôadopter le principe de la <strong>programmation fonctionnelle</strong>. Pour encore fiabiliser un processus, il serait possible d‚Äôadopter le paradigme de la <strong>programmation orient√©e objet (POO)</strong>. Celle-ci est plus rebutante et demande plus de temps au d√©veloppeur. L‚Äôarbitrage co√ªt-avantage est n√©gatif pour notre exemple, nous proposons donc de nous en passer. N√©anmoins, pour une mise en production r√©elle d‚Äôun mod√®le, il est recommand√© de l‚Äôadopter. C‚Äôest d‚Äôailleurs obligatoire avec des <a href="https://pythonds.linogaliana.fr/pipeline-scikit/"><em>pipelines</em> <code>scikit</code></a>.<a href="#fnref5" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn6"><p>Au passage vous pouvez noter que mauvaises pratiques discutables, peuvent √™tre corrig√©es, notamment l‚Äôutilisation excessive de <code>apply</code> l√† o√π il serait possible d‚Äôutiliser des m√©thodes embarqu√©es par <code>Pandas</code>. Cela est plut√¥t de l‚Äôordre du bon style de programmation que de la qualit√© formelle du script. Ce n‚Äôest donc pas obligatoire mais c‚Äôest mieux.<a href="#fnref6" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn7"><p>Il est normal d‚Äôavoir des dossiers <code>__pycache__</code> qui tra√Ænent : ils se cr√©ent automatiquement √† l‚Äôex√©cution d‚Äôun script en <code>Python</code>.<a href="#fnref7" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn8"><p>L‚Äôemplacement de ce fichier est amen√© √† √©voluer dans le cadre d‚Äôune packagisation. Dans un package, ces tests seront dans un dossier sp√©cifique <code>/tests</code> car <code>Python</code> sait g√©rer de mani√®re plus formelle les imports de fonctions depuis des modules. Ici, on est dans une situation transitoire, raison pour laquelle les tests sont dans les m√™mes dossiers que les fonctions.<a href="#fnref8" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn9"><p>Le fichier <code>__init__.py</code> indique √† <code>Python</code> que le dossier est un <em>package</em>. Il permet de proposer certaines configurations lors de l‚Äôimport du <em>package</em>. Il permet √©galement de contr√¥ler les objets export√©s (c‚Äôest-√†-dire mis √† disposition de l‚Äôutilisateur) par le <em>package</em> par rapport aux objets internes au <em>package</em>. En le laissant vide, nous allons utiliser ce fichier pour importer l‚Äôensemble des fonctions de nos sous-modules. Ce n‚Äôest pas la meilleure pratique mais un contr√¥le plus fin des objets export√©s demanderait un investissement qui ne vaut, ici, pas le co√ªt.<a href="#fnref9" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn10"><p>Ce <code>pyproject.toml</code> est un mod√®le qui utilise <code>setuptools</code> pour <em>build</em> le <em>package</em>. C‚Äôest l‚Äôoutil classique. N√©anmoins, pour des usages plus raffin√©s, il peut √™tre utile d‚Äôutiliser <a href="https://python-poetry.org/"><code>poetry</code></a> qui propose des fonctionnalit√©s plus compl√®tes.<a href="#fnref10" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn11"><p>Le format <code>YAML</code> est un format de fichier o√π les informations sont hi√©rarchis√©es. Avec le <em>package</em> <code>YAML</code> on peut tr√®s facilement le transformer en <code>dict</code>, ce qui est tr√®s pratique pour acc√©der √† une information.<a href="#fnref11" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn12"><p>Le <code>sudo</code> n‚Äôest pas n√©cessaire puisque vous √™tes d√©j√† en <code>root</code><a href="#fnref12" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>