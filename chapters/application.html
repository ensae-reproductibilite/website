<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Romain Avouac et Lino Galiana">
<meta name="description" content="Une application fil rouge pour illustrer l‚Äôint√©r√™t d‚Äôappliquer graduellement les bonnes pratiques dans une optique de mise en production d‚Äôune application de data science.">

<title>Mise en production des projets de data science - Application</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Mise en production des projets de data science</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-les-bases" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Les bases</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-les-bases">    
        <li>
    <a class="dropdown-item" href="../chapters/introduction.html">
 <span class="dropdown-text">Introduction</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/linux-101.html">
 <span class="dropdown-text">Linux 101</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/git.html">
 <span class="dropdown-text">Versionner son code et travailler collaborativement avec Git</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../chapters/code-quality.html"> 
<span class="menu-text">Qualit√© du code</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/projects-architecture.html"> 
<span class="menu-text">Architecture des projets</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/portability.html"> 
<span class="menu-text">Portabilit√©</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/deployment.html"> 
<span class="menu-text">Mise en production</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../chapters/application.html" aria-current="page"> 
<span class="menu-text">Application</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/evaluation.qmd"> 
<span class="menu-text">Evaluation</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="button" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/website">
 <span class="dropdown-text">Site web</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/slides">
 <span class="dropdown-text">Slides</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/application-correction">
 <span class="dropdown-text">Application fil rouge</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#partie-0-initialisation-du-projet" id="toc-partie-0-initialisation-du-projet" class="nav-link active" data-scroll-target="#partie-0-initialisation-du-projet">Partie 0 : initialisation du projet</a></li>
  <li><a href="#partie-1-qualit√©-du-script" id="toc-partie-1-qualit√©-du-script" class="nav-link" data-scroll-target="#partie-1-qualit√©-du-script">Partie 1 : qualit√© du script</a>
  <ul class="collapse">
  <li><a href="#√©tape-1-sassurer-que-le-script-sex√©cute-correctement" id="toc-√©tape-1-sassurer-que-le-script-sex√©cute-correctement" class="nav-link" data-scroll-target="#√©tape-1-sassurer-que-le-script-sex√©cute-correctement">√âtape 1 : s‚Äôassurer que le script s‚Äôex√©cute correctement</a></li>
  <li><a href="#√©tape-2-utiliser-un-linter-puis-un-formatter" id="toc-√©tape-2-utiliser-un-linter-puis-un-formatter" class="nav-link" data-scroll-target="#√©tape-2-utiliser-un-linter-puis-un-formatter">√âtape 2: utiliser un <em>linter</em> puis un <em>formatter</em></a></li>
  <li><a href="#√©tape-3-gestion-des-param√®tres" id="toc-√©tape-3-gestion-des-param√®tres" class="nav-link" data-scroll-target="#√©tape-3-gestion-des-param√®tres">√âtape 3: gestion des param√®tres</a></li>
  <li><a href="#√©tape-4-privil√©gier-la-programmation-fonctionnelle" id="toc-√©tape-4-privil√©gier-la-programmation-fonctionnelle" class="nav-link" data-scroll-target="#√©tape-4-privil√©gier-la-programmation-fonctionnelle">√âtape 4 : Privil√©gier la programmation fonctionnelle</a></li>
  </ul></li>
  <li><a href="#partie2" id="toc-partie2" class="nav-link" data-scroll-target="#partie2">Partie 2 : adoption d‚Äôune structure modulaire</a>
  <ul class="collapse">
  <li><a href="#√©tape-1-modularisation" id="toc-√©tape-1-modularisation" class="nav-link" data-scroll-target="#√©tape-1-modularisation">√âtape 1 : modularisation</a></li>
  <li><a href="#√©tape-2-adopter-une-architecture-standardis√©e-de-projet" id="toc-√©tape-2-adopter-une-architecture-standardis√©e-de-projet" class="nav-link" data-scroll-target="#√©tape-2-adopter-une-architecture-standardis√©e-de-projet">√âtape 2 : adopter une architecture standardis√©e de projet</a></li>
  <li><a href="#√©tape-3-indiquer-lenvironnement-minimal-de-reproductibilit√©" id="toc-√©tape-3-indiquer-lenvironnement-minimal-de-reproductibilit√©" class="nav-link" data-scroll-target="#√©tape-3-indiquer-lenvironnement-minimal-de-reproductibilit√©">√âtape 3: indiquer l‚Äôenvironnement minimal de reproductibilit√©</a></li>
  <li><a href="#stockageS3" id="toc-stockageS3" class="nav-link" data-scroll-target="#stockageS3">√âtape 4 : stocker les donn√©es de mani√®re externe</a></li>
  </ul></li>
  <li><a href="#partie-2bis-packagisation-de-son-projet-optionnel" id="toc-partie-2bis-packagisation-de-son-projet-optionnel" class="nav-link" data-scroll-target="#partie-2bis-packagisation-de-son-projet-optionnel">Partie 2bis: packagisation de son projet (optionnel)</a>
  <ul class="collapse">
  <li><a href="#√©tape-1-proposer-des-tests-unitaires-optionnel" id="toc-√©tape-1-proposer-des-tests-unitaires-optionnel" class="nav-link" data-scroll-target="#√©tape-1-proposer-des-tests-unitaires-optionnel">√âtape 1 : proposer des tests unitaires (optionnel)</a></li>
  <li><a href="#√©tape-2-transformer-son-projet-en-package-optionnel" id="toc-√©tape-2-transformer-son-projet-en-package-optionnel" class="nav-link" data-scroll-target="#√©tape-2-transformer-son-projet-en-package-optionnel">√âtape 2 : transformer son projet en package (optionnel)</a></li>
  </ul></li>
  <li><a href="#partie3" id="toc-partie3" class="nav-link" data-scroll-target="#partie3">Partie 3 : construction d‚Äôun projet portable et reproductible</a>
  <ul class="collapse">
  <li><a href="#anaconda" id="toc-anaconda" class="nav-link" data-scroll-target="#anaconda">√âtape 1 : un environnement pour rendre le projet portable</a></li>
  <li><a href="#√©tape-2-construire-lenvironnement-de-notre-application-via-un-script-shell" id="toc-√©tape-2-construire-lenvironnement-de-notre-application-via-un-script-shell" class="nav-link" data-scroll-target="#√©tape-2-construire-lenvironnement-de-notre-application-via-un-script-shell">√âtape 2: construire l‚Äôenvironnement de notre application via un script <code>shell</code></a></li>
  <li><a href="#docker" id="toc-docker" class="nav-link" data-scroll-target="#docker">√âtape 3: conteneuriser l‚Äôapplication avec <code>Docker</code></a></li>
  </ul></li>
  <li><a href="#partie-4-automatisation-avec-lint√©gration-continue" id="toc-partie-4-automatisation-avec-lint√©gration-continue" class="nav-link" data-scroll-target="#partie-4-automatisation-avec-lint√©gration-continue">Partie 4 : automatisation avec l‚Äôint√©gration continue</a>
  <ul class="collapse">
  <li><a href="#√©tape-1-mise-en-place-de-tests-automatis√©s" id="toc-√©tape-1-mise-en-place-de-tests-automatis√©s" class="nav-link" data-scroll-target="#√©tape-1-mise-en-place-de-tests-automatis√©s">√âtape 1: mise en place de tests automatis√©s</a></li>
  <li><a href="#√©tape-2-automatisation-de-la-livraison-de-limage-docker" id="toc-√©tape-2-automatisation-de-la-livraison-de-limage-docker" class="nav-link" data-scroll-target="#√©tape-2-automatisation-de-la-livraison-de-limage-docker">√âtape 2: Automatisation de la livraison de l‚Äôimage <code>Docker</code></a></li>
  </ul></li>
  <li><a href="#partie-5-mise-en-production-dune-api-servant-un-mod√®le-de-machine-learning" id="toc-partie-5-mise-en-production-dune-api-servant-un-mod√®le-de-machine-learning" class="nav-link" data-scroll-target="#partie-5-mise-en-production-dune-api-servant-un-mod√®le-de-machine-learning">Partie 5: mise en production d‚Äôune API servant un mod√®le de machine learning</a>
  <ul class="collapse">
  <li><a href="#√©tape-1-cr√©ation-dun-pipeline-scikit" id="toc-√©tape-1-cr√©ation-dun-pipeline-scikit" class="nav-link" data-scroll-target="#√©tape-1-cr√©ation-dun-pipeline-scikit">√âtape 1: cr√©ation d‚Äôun pipeline <code>scikit</code></a></li>
  <li><a href="#√©tape-2-d√©velopper-une-api-en-local" id="toc-√©tape-2-d√©velopper-une-api-en-local" class="nav-link" data-scroll-target="#√©tape-2-d√©velopper-une-api-en-local">√âtape 2: d√©velopper une API en local</a></li>
  <li><a href="#√©tape-3-d√©ployer-lapi" id="toc-√©tape-3-d√©ployer-lapi" class="nav-link" data-scroll-target="#√©tape-3-d√©ployer-lapi">√âtape 3: d√©ployer l‚ÄôAPI</a></li>
  </ul></li>
  <li><a href="#partie-6-un-workflow-complet-de-mlops" id="toc-partie-6-un-workflow-complet-de-mlops" class="nav-link" data-scroll-target="#partie-6-un-workflow-complet-de-mlops">Partie 6: un workflow complet de MLOps</a></li>
  <li><a href="#partie-7-livrer-un-site-web-de-mani√®re-automatis√©e" id="toc-partie-7-livrer-un-site-web-de-mani√®re-automatis√©e" class="nav-link" data-scroll-target="#partie-7-livrer-un-site-web-de-mani√®re-automatis√©e">Partie 7: livrer un site web de mani√®re automatis√©e</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Application</h1>
<p class="subtitle lead">Appliquer pas √† pas les concepts √©tudi√©s √† un projet de data science</p>
</div>

<div>
  <div class="description">
    <p>Une application fil rouge pour illustrer l‚Äôint√©r√™t d‚Äôappliquer graduellement les bonnes pratiques dans une optique de mise en production d‚Äôune application de data science.</p>
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Romain Avouac et Lino Galiana </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<details>
<summary>
D√©rouler les <em>slides</em> ci-dessous ou <a href="https://ensae-reproductibilite.github.io/slides/#/title-slide">cliquer ici</a> pour afficher les slides en plein √©cran.
</summary>
<div id="cb1" class="sourceCode">
<pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
<iframe class="sourceCode yaml code-with-copy" src="https://ensae-reproductibilite.github.io/slides/#/title-slide">
</iframe>
</div>
</details>
<p>L‚Äôobjectif de cette mise en application est d‚Äô<strong>illustrer les diff√©rentes √©tapes qui s√©parent la phase de d√©veloppement d‚Äôun projet de celle de la mise en production</strong>. Elle permettra de mettre en pratique les diff√©rents concepts pr√©sent√©s tout au long du cours.</p>
<p>Celle-ci est un tutoriel pas √† pas pour avoir un projet reproductible et disponible sous plusieurs livrables. Toutes les √©tapes ne sont pas indispensables √† tous les projets de <em>data science</em>.</p>
<p>Nous nous pla√ßons dans une situation initiale correspondant √† la fin de la phase de d√©veloppement d‚Äôun projet de data science. On a un <em>notebook</em> un peu monolithique, qui r√©alise les √©tapes classiques d‚Äôun <em>pipeline</em> de <em>machine learning</em> :</p>
<ul>
<li>Import de donn√©es ;</li>
<li>Statistiques descriptives et visualisations ;</li>
<li><em>Feature engineering</em> ;</li>
<li>Entra√Ænement d‚Äôun mod√®le ;</li>
<li>Evaluation du mod√®le.</li>
</ul>
<p><strong>L‚Äôobjectif est d‚Äôam√©liorer le projet de mani√®re incr√©mentale jusqu‚Äô√† pouvoir le mettre en production, en le valorisant sous une forme adapt√©e.</strong></p>
<details>
<summary>
Illustration de notre point de d√©part
</summary>
<img src="../workflow1.png" class="img-fluid">
</details>
<details>
<summary>
Illustration de l‚Äôhorizon vers lequel on se dirige
</summary>
<img src="../workflow2.png" class="img-fluid">
</details>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Il est important de bien lire les consignes et d‚Äôy aller progressivement. Certaines √©tapes peuvent √™tre rapides, d‚Äôautres plus fastidieuses ; certaines √™tre assez guid√©es, d‚Äôautres vous laisser plus de libert√©. Si vous n‚Äôeffectuez pas une √©tape, vous risquez de ne pas pouvoir passer √† l‚Äô√©tape suivante qui en d√©pend.</p>
<p>Bien que l‚Äôexercice soit applicable sur toute configuration bien faite, nous recommandons de privil√©gier l‚Äôutilisation du <a href="https://datalab.sspcloud.fr/home">SSP Cloud</a>, o√π tous les outils n√©cessaires sont pr√©-install√©s et pr√©-configur√©s. Le service <code>VSCode</code> ne sera en effet que le point d‚Äôentr√©e pour l‚Äôutilisation d‚Äôoutils plus exigeants sur le plan de l‚Äôinfrastructure: <em>Argo</em>, <em>MLFLow</em>, etc.</p>
</div>
</div>
<section id="partie-0-initialisation-du-projet" class="level1">
<h1>Partie 0 : initialisation du projet</h1>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application pr√©liminaire: forker le d√©p√¥t d‚Äôexemple
</div>
</div>
<div class="callout-body-container callout-body">
<p>Les premi√®res √©tapes consistent √† mettre en place son environnement de travail sur <code>Github</code>:</p>
<ul>
<li><p>G√©n√©rer un jeton d‚Äôacc√®s (<em>token</em>) sur <code>GitHub</code> afin de permettre l‚Äôauthentification en ligne de commande √† votre compte. La proc√©dure est d√©crite <a href="https://docs.sspcloud.fr/onyxia-guide/controle-de-version#creer-un-jeton-dacces-token">ici</a>. <strong>Vous ne voyez ce jeton qu‚Äôune fois, ne fermez pas la page de suite</strong>.</p></li>
<li><p>Mettez de c√¥t√© ce jeton en l‚Äôenregistrant dans un gestionnaire de mot de passe ou dans l‚Äôespace <em><a href="https://datalab.sspcloud.fr/account/third-party-integration">‚ÄúMon compte‚Äù</a></em> du <code>SSP Cloud</code>.</p></li>
<li><p>Forker le d√©p√¥t <code>Github</code> : <a href="https://github.com/ensae-reproductibilite/application-correction">https://github.com/ensae-reproductibilite/application-correction</a> en faisant attention √† deux choses:</p>
<ul>
<li>Renommer le d√©p√¥t en <code>ensae-reproductibilite-application-correction.git</code> ;</li>
<li>D√©cocher la case <em>‚ÄúCopy the <code>main</code> branch only‚Äù</em> afin de copier √©galement les <em>tags</em> <code>Git</code> qui nous permettront de faire les <em>checkpoint</em></li>
</ul></li>
</ul>
<details>
<summary>
Ce que vous devriez voir sur la page de cr√©ation du <em>fork</em>
</summary>
<p><img src="../fork-example.png" class="img-fluid"></p>
</details>
<p>Il est maintenant possible de ce lancer dans la cr√©ation de l‚Äôenvironnement de travail:</p>
<ul>
<li>Ouvrir un service <code>VSCode</code> sur le <a href="https://datalab.sspcloud.fr/home">SSP Cloud</a>. Vous pouvez aller dans la page <code>My Services</code> et cliquer sur <code>New service</code>. Sinon, vous pouvez initialiser la cr√©ation du service en cliquant directement <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?autoLaunch=false">ici</a>. <strong>Modifier les options suivantes</strong>:
<ul>
<li>Dans l‚Äôonglet <code>Kubernetes</code>, s√©lectionner le r√¥le <code>Admin</code> ;</li>
<li>Dans l‚Äôonglet <code>Networking</code>, cliquer sur ‚ÄúEnable a custom service port‚Äù et laisser la valeur par d√©faut 5000 pour le num√©ro du port</li>
</ul></li>
<li>Cl√¥ner <strong>votre</strong> d√©p√¥t <code>Github</code> en utilisant le terminal depuis <code>Visual Studio</code> (<code>Terminal &gt; New Terminal</code>) et en passant directement le token dans l‚ÄôURL selon cette structure:</li>
</ul>
<pre class="shell"><code>$ git clone https://&lt;TOKEN&gt;@github.com/&lt;USERNAME&gt;/ensae-reproductibilite-application-correction.git</code></pre>
<p>o√π <code>&lt;TOKEN&gt;</code> et <code>&lt;USERNAME&gt;</code> sont √† remplacer, respectivement, par le jeton que vous avez g√©n√©r√© pr√©c√©demment et votre nom d‚Äôutilisateur.</p>
<ul>
<li>Se placer avec le terminal dans le dossier en question :</li>
</ul>
<pre class="shell"><code>$ cd ensae-reproductibilite-application-correction</code></pre>
<ul>
<li>Se placer sur une branche de travail en faisant:</li>
</ul>
<pre class="shell"><code>$ git checkout -b dev</code></pre>
</div>
</div>
</section>
<section id="partie-1-qualit√©-du-script" class="level1">
<h1>Partie 1 : qualit√© du script</h1>
<p>Cette premi√®re partie vise √† <strong>rendre le projet conforme aux bonnes pratiques</strong> pr√©sent√©es dans le cours.</p>
<p>Elle fait intervenir les notions suivantes :</p>
<ul>
<li>Utilisation du <strong>terminal</strong> (voir <a href="../chapters/linux-101.html">Linux 101</a>) ;</li>
<li><strong>Qualit√© du code</strong> (voir <a href="../chapters/code-quality.html">Qualit√© du code</a>) ;</li>
<li><strong>Architecture de projets</strong> (voir <a href="../chapters/projects-architecture.html">Architecture des projets</a>) ;</li>
<li><strong>Contr√¥le de version</strong> avec <code>Git</code> (voir <a href="../chapters/git.html">Rappels <code>Git</code></a>) ;</li>
<li><strong>Travail collaboratif</strong> avec <code>Git</code> et <code>GitHub</code> (voir <a href="../chapters/git.html">Rappels <code>Git</code></a>).</li>
</ul>
<p>Nous allons partir de ce <em>Notebook</em> <code>Jupyter</code>, que vous pouvez pr√©visualiser voire tester en cliquant sur l‚Äôun des liens suivants:</p>
<p><em>to do bouton onyxia</em> <a href="https://github.com/ensae-reproductibilite/application-correction/blob/main/titanic.ipynb" target="_blank" rel="noopener"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<p>Le plan de la partie est le suivant :</p>
<ol type="1">
<li>S‚Äôassurer que le script fonctionne ;</li>
<li>Nettoyer le code des scories formelles avec un <em>linter</em> et un <em>formatter</em> ;</li>
<li>Param√©trisation du script ;</li>
<li>Utilisation de fonctions.</li>
</ol>
<section id="√©tape-1-sassurer-que-le-script-sex√©cute-correctement" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-1-sassurer-que-le-script-sex√©cute-correctement">√âtape 1 : s‚Äôassurer que le script s‚Äôex√©cute correctement</h2>
<p>On va partir du fichier <code>notebook.py</code> qui reprend le contenu du <em>notebook</em><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> mais dans un script classique. Le travail de nettoyage en sera facilit√©.</p>
<p>La premi√®re √©tape est simple, mais souvent oubli√©e : <strong>v√©rifier que le code fonctionne correctement</strong>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 1: corriger les erreurs
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Ouvrir dans <code>VSCode</code> le script <code>titanic.py</code> ;</li>
<li>Ex√©cuter le script en ligne de commande (<code>python titanic.py</code>) ou de mani√®re interactive ligne √† ligne (<kbd>MAJ</kbd>+<kbd>ENTER</kbd>)pour d√©tecter les erreurs ;</li>
<li>Corriger les deux erreurs qui emp√™chent la bonne ex√©cution ;</li>
<li>V√©rifier le fonctionnement du script en utilisant la ligne de commande:</li>
</ul>
<pre class="shell"><code>python titanic.py</code></pre>
<p>Le code devrait afficher des sorties.</p>
<details>
<summary>
Aide sur les erreurs rencontr√©es
</summary>
<p>La premi√®re erreur rencontr√©e est une alerte <code>FileNotFoundError</code>, la seconde est li√©e √† un <em>package</em>.</p>
</details>
<p>Il est maintenant temps de <em>commit</em> les changements effectu√©s avec <code>Git</code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> :</p>
<pre class="shell"><code>$ git add titanic.py
$ git commit -m "Corrige l'erreur qui emp√™chait l'ex√©cution"
$ git push</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli1</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="√©tape-2-utiliser-un-linter-puis-un-formatter" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-2-utiliser-un-linter-puis-un-formatter">√âtape 2: utiliser un <em>linter</em> puis un <em>formatter</em></h2>
<p>On va maintenant am√©liorer la qualit√© de notre code en appliquant les standards communautaires. Pour cela, on va utiliser le <em>linter</em> classique <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et le <em>formatter</em> <a href="https://github.com/psf/black"><code>Black</code></a>.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a> sont des <em>packages</em> <code>Python</code> qui s‚Äôutilisent principalement en ligne de commande.</p>
<p>Si vous avez une erreur qui sugg√®re que votre terminal ne connait pas <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> ou <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a>, n‚Äôoubliez pas d‚Äôex√©cuter la commande <code>pip install pylint</code> ou <code>pip install black</code>.</p>
</div>
</div>
<p>Le <em>linter</em> renvoie alors une s√©rie d‚Äôirr√©gularit√©s, en pr√©cisant √† chaque fois la ligne de l‚Äôerreur et le message d‚Äôerreur associ√© (ex : mauvaise identation). Il renvoie finalement une note sur 10, qui estime la qualit√© du code √† l‚Äôaune des standards communautaires √©voqu√©s dans la partie <a href="../chapters/code-quality.html">Qualit√© du code</a>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 2: rendre lisible le script
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Diagnostiquer et √©valuer la qualit√© de <code>titanic.py</code> avec <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a>. Regarder la note obtenue.</li>
<li>Utiliser <code>black titanic.py --diff --color</code> pour observer les changements de forme que va induire l‚Äôutilisation du <em>formatter</em> <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a></li>
<li>Appliquer le <em>formatter</em> <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a></li>
<li>R√©utiliser <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> pour diagnostiquer l‚Äôam√©lioration de la qualit√© du script et le travail qui reste √† faire.</li>
<li>Comme la majorit√© du travail restant est √† consacrer aux imports:
<ul>
<li>Mettre tous les <em>imports</em> ensemble en d√©but de script</li>
<li>Retirer les <em>imports</em> redondants en s‚Äôaidant des diagnostics de votre √©diteur</li>
<li>R√©ordonner les <em>imports</em> si <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> vous indique de le faire</li>
<li>Corriger les derni√®res fautes formelles sugg√©r√©es par <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a></li>
</ul></li>
<li>D√©limiter des parties dans votre code pour rendre sa structure plus lisible</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli2</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>Le code est maintenant lisible, il obtient √† ce stade une note formelle proche de 10. Mais il n‚Äôest pas encore totalement intelligible ou fiable. Il y a notamment beaucoup de redondance de code auxquelles nous allons nous attaquer par la suite. N√©anmoins, avant cela, occupons-nous de mieux g√©rer certains param√®tres du script: jetons d‚ÄôAPI et chemin des fichiers.</p>
</section>
<section id="√©tape-3-gestion-des-param√®tres" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-3-gestion-des-param√®tres">√âtape 3: gestion des param√®tres</h2>
<p>L‚Äôex√©cution du code et les r√©sultats obtenus d√©pendent de certains param√®tres d√©finis dans le code. L‚Äô√©tude de r√©sultats alternatifs, en jouant sur des variantes des (hyper)param√®tres, est √† ce stade compliqu√©e car il est n√©cessaire de parcourir le code pour trouver ces param√®tres. De plus, certains param√®tres personnels comme des jetons d‚ÄôAPI ou des mots de passe n‚Äôont pas vocation √† √™tre pr√©sents dans le code.</p>
<p>Il est plus judicieux de consid√©rer ces param√®tres comme des variables d‚Äôentr√©e du script. Cela peut √™tre fait de deux mani√®res:</p>
<ol type="1">
<li>Avec des <strong>arguments optionnels</strong> appel√©s depuis la ligne de commande <em>(Application 3a)</em>. Cela peut √™tre pratique pour mettre en oeuvre des tests automatis√©s[^noteCI] mais n‚Äôest pas forc√©ment pertinent pour toutes les variables. Nous allons montrer cet usage avec le nombre d‚Äôarbres de notre <em>random forest</em> ;</li>
<li>En utilisant un <strong>fichier de configuration</strong> dont les valeurs sont import√©es dans le script principal <em>(Application 3b)</em>.</li>
</ol>
<details>
<summary>
Un exemple de d√©finition d‚Äôun argument pour l‚Äôutilisation en ligne de commande
</summary>
<div id="dd4cefac" class="cell" data-file="prenom.py" data-execution_count="1">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>prenom.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span><span class="st">"Qui √™tes-vous?"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>parser.add_argument(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"--prenom"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, default<span class="op">=</span><span class="st">"Toto"</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Un pr√©nom √† afficher"</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>args <span class="op">=</span> parser.parse_args()</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(args.prenom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Exemples d‚Äôutilisations en ligne de commande</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> prenom.py</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> prenom.py <span class="at">--prenom</span> <span class="st">"Zinedine"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 3a: Param√©trisation du script
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>En s‚Äôinspirant de l‚Äôexemple ci-dessus üëÜÔ∏è, cr√©er une variable <code>n_trees</code> qui peut √©ventuellement √™tre param√©tr√©e en ligne de commande et dont la valeur par d√©faut est 20 ;</li>
<li>Tester cette param√©trisation en ligne de commande avec la valeur par d√©faut puis 2, 10 et 50 arbres.</li>
</ol>
</div>
</div>
<p>L‚Äôexercice suivant permet de mettre en application le fait de param√©triser un script en utilisant des variables d√©finies dans un fichier YAML.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 3b: La configuration dans un fichier YAML
</div>
</div>
<div class="callout-body-container callout-body">
<p>Nous allons mettre 4 param√®tres dans notre YAML. Celui-ci prendra la forme suivante:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>config.yaml</strong></pre>
</div>
<div class="sourceCode" id="cb10" data-filename="config.yaml"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">jeton_api</span><span class="kw">:</span><span class="co"> ####</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">train_path</span><span class="kw">:</span><span class="co"> ####</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">test_path</span><span class="kw">:</span><span class="co"> ####</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">test_fraction</span><span class="kw">:</span><span class="co"> ####</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Avec <code>####</code> des valeurs √† remplacer.</p>
<ol type="1">
<li>Cr√©er √† la racine du projet un fichier <code>config.yaml</code> √† partir du mod√®le üëÜÔ∏è ;</li>
<li>Rep√©rer les valeurs dans le code associ√©es et compl√©ter.</li>
</ol>
<p>Maintenant, nous allons exploiter ce fichier:</p>
<ol start="3" type="1">
<li>Pour √©viter d‚Äôavoir √† le faire plus tard, cr√©er une fonction <code>import_yaml_config</code> qui prend en argument le chemin d‚Äôun fichier <code>YAML</code> et renvoie le contenu de celui-ci en <em>output</em>. Vous pouvez suivre le conseil du chapitre sur la <a href="../chapters/code-quality.html">Qualit√© du code</a> en adoptant le <em>type hinting</em> ;</li>
<li>Dans la fonction <code>import_yaml_config</code>, cr√©er une condition logique pour tenir compte du fait que le YAML de configuration peut ne pas exister<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> ;</li>
<li>Utiliser le canevas de code suivant pour cr√©er les variables ad√©quates</li>
</ol>
<div id="5daf1793" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>API_TOKEN <span class="op">=</span> config.get(<span class="st">"jeton_api"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>TRAIN_PATH <span class="op">=</span> config.get(<span class="st">"train_path"</span>, <span class="st">"train.csv"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>TEST_PATH <span class="op">=</span> config.get(<span class="st">"test_path"</span>, <span class="st">"test.csv"</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>TEST_FRACTION <span class="op">=</span> config.get(<span class="st">"test_fraction"</span>, <span class="fl">.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>et remplacer dans le code ;</p>
<ol start="5" type="1">
<li>Tester en ligne de commande que l‚Äôex√©cution du fichier est toujours sans erreur et sinon corriger ;</li>
<li>Refaire un diagnostic avec <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et corriger les √©ventuels messages ;</li>
<li>Cr√©er un fichier <code>.gitignore</code> (cf.&nbsp;<a href="../chapters/git.html">Chapitre <code>Git</code></a>). Ajouter dans ce fichier <code>config.yaml</code> car il ne faut pas committer ce fichier. Au passage ajouter <code>__pycache__/</code> au <code>.gitignore</code><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>, cela √©vitera d‚Äôavoir √† le faire ult√©rieurement ;</li>
<li>Cr√©er un fichier <code>README.md</code> o√π vous indiquez qu‚Äôil faut cr√©er un fichier <code>config.yaml</code> pour pouvoir utiliser l‚ÄôAPI.</li>
</ol>
<details>
<summary>
Indice si vous ne trouvez pas comment lire un fichier <code>YAML</code>
</summary>
<p>Si le fichier s‚Äôappelle <code>toto.yaml</code>, vous pouvez l‚Äôimporter de cette mani√®re:</p>
<div id="8bcc13cf" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"toto.yaml"</span>, <span class="st">"r"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> stream:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    dict_config <span class="op">=</span> yaml.safe_load(stream)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<details>
<summary>
Indice si vous ne savez comment conditionner la cr√©ation de la configuration √† l‚Äôexistence du fichier
</summary>
<p>Voici la ligne qui peut vous aider. L‚Äôid√©al est d‚Äôins√©rer ceci dans <code>import_yaml_config</code>:</p>
<div id="efe8f96f" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>CONFIG_PATH <span class="op">=</span> <span class="st">'config.yaml'</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> {}</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(CONFIG_PATH):</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lecture du fichier</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli3</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="√©tape-4-privil√©gier-la-programmation-fonctionnelle" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-4-privil√©gier-la-programmation-fonctionnelle">√âtape 4 : Privil√©gier la programmation fonctionnelle</h2>
<p>Nous allons <strong>mettre en fonctions les parties importantes de l‚Äôanalyse</strong>. Ceci facilitera l‚Äô√©tape ult√©rieure de modularisation de notre projet.</p>
<p>Cet exercice √©tant chronophage, il n‚Äôest <strong>pas obligatoire de le r√©aliser en entier</strong>. L‚Äôimportant est de comprendre la d√©marche et d‚Äôadopter fr√©quemment une approche fonctionnelle<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. Pour obtenir une chaine enti√®rement fonctionnalis√©e, vous pouvez reprendre le <em>checkpoint</em>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 4: adoption des standards de programmation fonctionnelle
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Cr√©er une fonction qui importe les donn√©es d‚Äôentra√Ænement (<code>train.csv</code>) et de test (<code>test.csv</code>) et renvoie des <code>DataFrames</code> <code>Pandas</code> ;</li>
<li>En fonction du temps disponible, cr√©er plusieurs fonctions pour r√©aliser les √©tapes de <em>feature engineering</em>:
<ul>
<li>La cr√©ation de la variable <em>‚ÄúTitle‚Äù</em> peut √™tre automatis√©e en vertu du principe <em>‚Äúdo not repeat yourself‚Äù</em><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</li>
<li>Regrouper ensemble les <code>fillna</code> et essayer de cr√©er une fonction g√©n√©ralisant l‚Äôop√©ration.</li>
<li>Les <em>label encoders</em> peuvent √™tre transform√©s en deux fonctions: une premi√®re pour encoder une colonne puis une seconde qui utilise la premi√®re de mani√®re r√©p√©t√©e pour encoder plusieurs colonnes. <em>Remarquez les erreurs de copier-coller que cela corrige</em></li>
<li>Finaliser les derni√®res transformations avec des fonctions</li>
</ul></li>
<li>Cr√©er une fonction qui r√©alise le <em>split train/test</em> de validation en fonction d‚Äôun param√®tre repr√©sentant la proportion de l‚Äô√©chantillon de test.</li>
<li>Cr√©er une fonction qui entra√Æne et √©value un classifieur <code>RandomForest</code>, et qui prend en param√®tre le nombre d‚Äôarbres (<code>n_estimators</code>). La fonction doit imprimer √† la fin la performance obtenue et la matrice de confusion.</li>
<li>D√©placer toutes les fonctions ensemble, en d√©but de script.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Le fait d‚Äôappliquer des fonctions a d√©j√† am√©lior√© la fiabilit√© du processus en r√©duisant le nombre d‚Äôerreurs de copier-coller. N√©anmoins, pour vraiment fiabiliser le processus, il faudrait utiliser un <em>pipeline</em> de transformations de donn√©es.</p>
<p>Ceci n‚Äôest pas encore au programme du cours mais le sera dans une prochaine version.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-13-contents" aria-controls="callout-13" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-13" class="callout-13-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli4</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>Cela ne se remarque pas encore vraiment car nous avons de nombreuses d√©finitions de fonctions mais notre chaine de production est beaucoup plus concise (le script fait environ 300 lignes dont 250 de d√©finitions de fonctions g√©n√©riques). Cette auto-discipline facilitera grandement les √©tapes ult√©rieures. Cela aurait √©t√© n√©anmoins beaucoup moins co√ªteux en temps d‚Äôadopter ces bons gestes de mani√®re plus pr√©coce.</p>
</section>
</section>
<section id="partie2" class="level1">
<h1>Partie 2 : adoption d‚Äôune structure modulaire</h1>
<p>Dans la partie pr√©c√©dente, on a appliqu√© de mani√®re incr√©mentale de nombreuses bonnes pratiques vues tout au long du cours. Ce faisant, on s‚Äôest d√©j√† consid√©rablement rapproch√©s d‚Äôun possible partage du code : celui-ci est lisible et intelligible. Le code est proprement versionn√© sur un d√©p√¥t <code>GitHub</code>. Cependant, le projet est encore perfectible: il est encore difficile de rentrer dedans si on ne sait pas exactement ce qu‚Äôon recherche. L‚Äôobjectif de cette partie est d‚Äôisoler les diff√©rentes √©tapes de notre <em>pipeline</em>. Outre le gain de clart√© pour notre projet, nous √©conomiserons beaucoup de peines pour la mise en production ult√©rieure de notre mod√®le.</p>
<details>
<summary>
Illustration de l‚Äô√©tat actuel du projet
</summary>
<img src="../schema_post_appli4.png" class="img-fluid">
</details>
<p>Dans cette partie nous allons continuer les am√©liorations incr√©mentales de notre projet avec les √©tapes suivantes:</p>
<ol type="1">
<li>Modularisation du code <code>Python</code> pour s√©parer les diff√©rentes √©tapes de notre <em>pipeline</em> ;</li>
<li>Adopter une structure standardis√©e pour notre projet afin d‚Äôautodocumenter l‚Äôorganisation de celui-ci ;</li>
<li>Documenter les <em>packages</em> indispensables √† l‚Äôex√©cution du code ;</li>
<li>Stocker les donn√©es dans un environnement ad√©quat afin de continuer la d√©marche de s√©parer conceptuellement les donn√©es du code en de la configuration.</li>
</ol>
<section id="√©tape-1-modularisation" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-1-modularisation">√âtape 1 : modularisation</h2>
<p>Nous allons profiter de la modularisation pour adopter une structure applicative pour notre code. Celui-ci n‚Äô√©tant en effet plus lanc√© que la ligne de commande, on peut consid√©rer qu‚Äôon construit une application g√©n√©rique o√π un script principal (<code>main.py</code>) encapsule des √©l√©ments issus d‚Äôautres scripts.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 5: modularisation
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>D√©placer les fonctions dans une s√©rie de fichiers d√©di√©s:
<ul>
<li><code>import_data.py</code>: fonctions d‚Äôimport de donn√©es</li>
<li><code>build_features.py</code>: fonctions regroupant les √©tapes de <em>feature engineering</em></li>
<li><code>train_evaluate.py</code>: fonctions d‚Äôentrainement et d‚Äô√©valuation du mod√®le</li>
</ul></li>
<li>Sp√©cifier les d√©pendances (i.e.&nbsp;les packages √† importer) dans les modules pour que ceux-ci puissent s‚Äôex√©cuter ind√©pendamment ;</li>
<li>Renommer <code>titanic.py</code> en <code>main.py</code> pour suivre la convention de nommage des projets <code>Python</code> ;</li>
<li>Importer les fonctions n√©cessaires √† partir des modules.</li>
<li>V√©rifier que tout fonctionne bien en ex√©cutant le <em>script</em> <code>main</code> √† partir de la ligne de commande :</li>
</ul>
<pre class="shell"><code>$ python main.py</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli5</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="√©tape-2-adopter-une-architecture-standardis√©e-de-projet" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-2-adopter-une-architecture-standardis√©e-de-projet">√âtape 2 : adopter une architecture standardis√©e de projet</h2>
<p>On dispose maintenant d‚Äôune application <code>Python</code> fonctionnelle. N√©anmoins, le projet est certes plus fiable mais sa structuration laisse √† d√©sirer et il serait difficile de rentrer √† nouveau dans le projet dans quelques temps.</p>
<details>
<summary>
Etat actuel du projet üôà
</summary>
<pre class="shell"><code>‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ train.csv
‚îú‚îÄ‚îÄ test.csv
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ config.yaml
‚îú‚îÄ‚îÄ secrets.yaml
‚îú‚îÄ‚îÄ import_data.py
‚îú‚îÄ‚îÄ build_features.py
‚îú‚îÄ‚îÄ train_evaluate.py
‚îî‚îÄ‚îÄ main.py</code></pre>
</details>
<p>Comme cela est expliqu√© dans la partie <a href="../chapters/projects-architecture.html">Structure des projets</a>, on va adopter une structure certes arbitraire mais qui va faciliter l‚Äôautodocumentation de notre projet. De plus, une telle structure va faciliter des √©volutions optionnelles comme la <em>packagisation</em> du projet. Passer d‚Äôune structure modulaire bien faite √† un <em>package</em> est quasi-imm√©diat en <code>Python</code>.</p>
<p>On va donc modifier l‚Äôarchitecture de notre projet pour la rendre plus standardis√©e. Pour cela, on va s‚Äôinspirer des structures <a href="https://cookiecutter.readthedocs.io/en/stable/"><code>cookiecutter</code></a> qui g√©n√®rent des <em>templates</em> de projet. En l‚Äôoccurrence notre source d‚Äôinspiration sera le <a href="https://drivendata.github.io/cookiecutter-data-science/"><em>template datascience</em></a> issu d‚Äôun effort communautaire.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>L‚Äôid√©e de <a href="https://cookiecutter.readthedocs.io/en/stable/"><code>cookiecutter</code></a> est de proposer des <em>templates</em> que l‚Äôon utilise pour <strong>initialiser</strong> un projet, afin de b√¢tir √† l‚Äôavance une structure √©volutive. La syntaxe √† utiliser dans ce cas est la suivante :</p>
<pre class="shell"><code>$ pip install cookiecutter
$ cookiecutter https://github.com/drivendata/cookiecutter-data-science</code></pre>
<p>Ici, on a d√©j√† un projet, on va donc faire les choses dans l‚Äôautre sens : on va s‚Äôinspirer de la structure propos√©e afin de r√©organiser celle de notre projet selon les standards communautaires.</p>
</div>
</div>
<p>En s‚Äôinspirant du <em>cookiecutter data science</em> on va adopter la structure suivante:</p>
<details>
<summary>
Structure recommand√©e
</summary>
<pre class="shell"><code>ensae-reproductibilite-application
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ data
‚îÇ   ‚îî‚îÄ‚îÄ raw
‚îÇ       ‚îú‚îÄ‚îÄ test.csv
‚îÇ       ‚îî‚îÄ‚îÄ train.csv
‚îú‚îÄ‚îÄ configuration
‚îÇ   ‚îî‚îÄ‚îÄ config.yaml
‚îú‚îÄ‚îÄ notebooks
‚îÇ   ‚îî‚îÄ‚îÄ titanic.ipynb
‚îî‚îÄ‚îÄ src
    ‚îú‚îÄ‚îÄ data
    ‚îÇ   ‚îî‚îÄ‚îÄ import_data.py
    ‚îú‚îÄ‚îÄ features
    ‚îÇ   ‚îî‚îÄ‚îÄ build_features.py
    ‚îî‚îÄ‚îÄ models
        ‚îî‚îÄ‚îÄ train_evaluate.py</code></pre>
</details>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 6: adopter une structure lisible
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><em>(optionnel)</em> Analyser et comprendre la <a href="https://drivendata.github.io/cookiecutter-data-science/#directory-structure">structure de projet</a> propos√©e par le template ;</li>
<li>Modifier l‚Äôarborescence du projet selon le mod√®le ;</li>
<li>Mettre √† jour l‚Äôimport des d√©pendances et le fichier de configuration avec les nouveaux chemins ;</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-18-contents" aria-controls="callout-18" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-18" class="callout-18-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli6</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="√©tape-3-indiquer-lenvironnement-minimal-de-reproductibilit√©" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-3-indiquer-lenvironnement-minimal-de-reproductibilit√©">√âtape 3: indiquer l‚Äôenvironnement minimal de reproductibilit√©</h2>
<p>Le script <code>main.py</code> n√©cessite un certain nombre de packages pour √™tre fonctionnel. Chez vous les packages n√©cessaires sont bien s√ªr install√©s mais √™tes-vous assur√© que c‚Äôest le cas chez la personne qui testera votre code ?</p>
<p>Afin de favoriser la portabilit√© du projet, il est d‚Äôusage de <em>‚Äúfixer l‚Äôenvironnement‚Äù</em>, c‚Äôest-√†-dire d‚Äôindiquer dans un fichier toutes les d√©pendances utilis√©es ainsi que leurs version. Nous proposons de cr√©er un fichier <code>requirements.txt</code> minimal, sur lequel nous reviendrons dans la partie consacr√©e aux environnements reproductibles.</p>
<p>Le fichier <code>requirements.txt</code> est conventionnellement localis√© √† la racine du projet. Ici on ne va pas fixer les versions, on raffinera ce fichier ult√©rieurement.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 7: cr√©ation du <code>requirements.txt</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Cr√©er un fichier <code>requirements.txt</code> avec la liste des packages n√©cessaires</li>
<li>Ajouter une indication dans <code>README.md</code> sur l‚Äôinstallation des <em>packages</em> gr√¢ce au fichier <code>requirements.txt</code></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-20-contents" aria-controls="callout-20" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-20" class="callout-20-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli7</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="stockageS3" class="level2">
<h2 class="anchored" data-anchor-id="stockageS3">√âtape 4 : stocker les donn√©es de mani√®re externe</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-21-contents" aria-controls="callout-21" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pour en savoir plus sur le syst√®me de stockage <code>S3</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-21" class="callout-21-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Pour mettre en oeuvre cette √©tape, il peut √™tre utile de comprendre un peu comme fonctionne le SSP Cloud. Vous devrez suivre la <a href="https://inseefrlab.github.io/docs.sspcloud.fr/docs/fr/storage.html">documentation du SSP Cloud</a> pour la r√©aliser. Une aide-m√©moire est √©galement disponible dans le cours de 2e ann√©e de l‚ÄôENSAE <a href="https://linogaliana-teaching.netlify.app/reads3/#">Python pour la data science</a>.</p>
</div>
</div>
</div>
<p>Le chapitre sur la <a href="../chapters/project-structure.qmd">structure des projets</a> d√©veloppe l‚Äôid√©e qu‚Äôil est recommand√© de converger vers un mod√®le o√π environnements d‚Äôex√©cution, de stockage du code et des donn√©es sont conceptuellement s√©par√©s. Ce haut niveau d‚Äôexigence est un gain de temps important lors de la mise en production car au cours de cette derni√®re, le projet est amen√© √† √™tre ex√©cut√© sur une infrastructure informatique d√©di√©e qu‚Äôil est bon d‚Äôanticiper.</p>
<p>A l‚Äôheure actuelle, les donn√©es sont stock√©es dans le d√©p√¥t. C‚Äôest une mauvaise pratique. En premier lieu, <code>Git</code> n‚Äôest techniquement pas bien adapt√© au stockage de donn√©es. Ici ce n‚Äôest pas tr√®s grave car il ne s‚Äôagit pas de donn√©es volumineuses et ces derni√®res ne sont pas modifi√©es au cours de notre chaine de traitement. La raison principale est que les donn√©es trait√©es par les <em>data scientists</em> sont g√©n√©ralement soumises √† des clauses de confidentialit√©s (<a href="https://www.cnil.fr/fr/rgpd-de-quoi-parle-t-on">RGPD</a>, <a href="https://www.insee.fr/fr/information/1300624">secret statistique</a>‚Ä¶). Mettre ces donn√©es sous contr√¥le de version c‚Äôest prendre le risque de les divulguer √† un public non habilit√©. Il est donc recommand√© de privil√©gier des outils techniques adapt√©s au stockage de donn√©es.</p>
<p>L‚Äôid√©al, dans notre cas, est d‚Äôutiliser une solution de stockage externe. On va utiliser pour cela <code>MinIO</code>, la solution de stockage de type <code>S3</code> offerte par le SSP Cloud. Cela nous permettra de supprimer les donn√©es de <code>Github</code> tout en maintenant la reproductibilit√© de notre projet <a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 8: utilisation d‚Äôun syst√®me de stockage distant
</div>
</div>
<div class="callout-body-container callout-body">
<p>A partir de la ligne de commande, utiliser l‚Äôutilitaire <a href="https://min.io/docs/minio/linux/reference/minio-mc.html">MinIO</a> pour copier les donn√©es <code>data/raw/train.csv</code> et <code>data/raw/test.csv</code> vers votre bucket personnel, respectivement dans les dossiers <code>ensae-reproductibilite/data/raw/train.csv</code> et <code>ensae-reproductibilite/data/raw/test.csv</code>.</p>
<details>
<summary>
Indice
</summary>
<p>Structure √† adopter:</p>
<pre class="shell"><code>$ mc cp data/raw/train.csv s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/train.csv
$ mc cp data/raw/test.csv s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/test.csv</code></pre>
en modifiant l‚Äôemplacement de votre bucket personnel
</details>
<ul>
<li>Pour se simplifier la vie, on va utiliser des URL de t√©l√©chargement des fichiers (comme si ceux-ci √©taient sur n‚Äôimporte quel espace de stockage) plut√¥t que d‚Äôutiliser une librairie <code>S3</code> compatible comme <code>boto3</code> ou <code>s3fs</code>. Pour cela, en ligne de commande, faire:</li>
</ul>
<pre class="shell"><code>mc anonymous set download s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/</code></pre>
<p>en modifiant <code>&lt;BUCKET_PERSONNEL&gt;</code>. Les URL de t√©l√©chargement seront de la forme <code>https://minio.lab.sspcloud.fr/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/test.csv</code> et <code>https://minio.lab.sspcloud.fr/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/train.csv</code></p>
<ul>
<li>Modifier <code>configuration/config.yaml</code> pour utiliser directement les URL dans l‚Äôimport ;</li>
<li>Modifier les valeurs par d√©faut dans votre code ;</li>
<li>Supprimer les fichiers <code>.csv</code> du dossier <code>data</code> de votre projet, on n‚Äôen a plus besoin vu qu‚Äôon les importe de l‚Äôext√©rieur ;</li>
<li>V√©rifier le bon fonctionnement de votre application.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-23-contents" aria-controls="callout-23" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-23" class="callout-23-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli8</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="partie-2bis-packagisation-de-son-projet-optionnel" class="level1">
<h1>Partie 2bis: packagisation de son projet (optionnel)</h1>
<p>Cette s√©rie d‚Äôactions n‚Äôest pas forc√©ment pertinente pour tous les projets. Elle fait un peu la transition entre la modularit√© et la portabilit√©.</p>
<section id="√©tape-1-proposer-des-tests-unitaires-optionnel" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-1-proposer-des-tests-unitaires-optionnel">√âtape 1 : proposer des tests unitaires (optionnel)</h2>
<p>Notre code comporte un certain nombre de fonctions g√©n√©riques. On peut vouloir tester leur usage sur des donn√©es standardis√©es, diff√©rentes de celles du Titanic.</p>
<p>M√™me si la notion de tests unitaires prend plus de sens dans un <em>package</em>, nous pouvons proposer dans le projet des exemples d‚Äôutilisation de la fonction, ceci peut √™tre p√©dagogique.</p>
<p>Nous allons utiliser <a href="https://docs.python.org/3/library/unittest.html"><code>unittest</code></a> pour effectuer des tests unitaires. Cette approche n√©cessite quelques notions de programmation orient√©e objet ou une bonne discussion avec <code>ChatGPT</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 9: test unitaire <em>(optionnel)</em>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Dans le dossier <code>tests/</code>, cr√©er un fichier <code>test_create_variable_title.py</code>.</p>
<p>En s‚Äôinspirant de l‚Äô<a href="https://docs.python.org/3/library/unittest.html#basic-example">exemple de base</a>, cr√©er une classe <code>TestCreateVariableTitle</code> qui effectue les op√©rations suivantes:</p>
<ul>
<li><p>Cr√©ation d‚Äôune fonction <code>test_create_variable_title_default_variable_name</code> qui permet de comparer les objets suivants:</p>
<ul>
<li>Cr√©ation d‚Äôun <code>DataFrame</code> de test :</li>
</ul>
<div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Name'</span>: [<span class="st">'Braund, Mr. Owen Harris'</span>, <span class="st">'Cumings, Mrs. John Bradley (Florence Briggs Thayer)'</span>,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Heikkinen, Miss. Laina'</span>, <span class="st">'Futrelle, Mrs. Jacques Heath (Lily May Peel)'</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Allen, Mr. William Henry'</span>, <span class="st">'Moran, Mr. James'</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'McCarthy, Mr. Timothy J'</span>, <span class="st">'Palsson, Master. Gosta Leonard'</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Johnson, Mrs. Oscar W (Elisabeth Vilhelmina Berg)'</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Nasser, Mrs. Nicholas (Adele Achem)'</span>],</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Age'</span>: [<span class="dv">22</span>, <span class="dv">38</span>, <span class="dv">26</span>, <span class="dv">35</span>, <span class="dv">35</span>, <span class="dv">27</span>, <span class="dv">54</span>, <span class="dv">2</span>, <span class="dv">27</span>, <span class="dv">14</span>],</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Survived'</span>: [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Utilisation de la fonction <code>create_variable_title</code> sur ce <code>DataFrame</code></li>
<li>Comparaison au <code>DataFrame</code> attendu:</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>expected_result <span class="op">=</span> pd.DataFrame({</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Title'</span>: [<span class="st">'Mr.'</span>, <span class="st">'Mrs.'</span>, <span class="st">'Miss.'</span>, <span class="st">'Mrs.'</span>, <span class="st">'Mr.'</span>, <span class="st">'Mr.'</span>, <span class="st">'Mr.'</span>, <span class="st">'Master.'</span>, <span class="st">'Mrs.'</span>, <span class="st">'Mrs.'</span>],</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Age'</span>: [<span class="dv">22</span>, <span class="dv">38</span>, <span class="dv">26</span>, <span class="dv">35</span>, <span class="dv">35</span>, <span class="dv">27</span>, <span class="dv">54</span>, <span class="dv">2</span>, <span class="dv">27</span>, <span class="dv">14</span>],</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Survived'</span>: [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Effectuer le test unitaire en ligne de commande avec <code>unittest</code> (<code>python -m unittest tests/test_create_variable_title.py</code>). Corriger le test unitaire en cas d‚Äôerreur.</p></li>
<li><p>Si le temps le permet, proposer des variantes pour tenir compte de param√®tres (comme la variable <code>variable_name</code>) ou d‚Äôexceptions (comme la gestion du cas <em>‚ÄúDona‚Äù</em>).</p></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-25-contents" aria-controls="callout-25" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-25" class="callout-25-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli9</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Lorsqu‚Äôon effectue des tests unitaires, on cherche g√©n√©ralement √† tester le plus de lignes possibles de son code. On parle de <strong>taux de couverture</strong> (<em>coverage rate</em>) pour d√©signer la statistique mesurant cela.</p>
<p>Cela peut s‚Äôeffectuer de la mani√®re suivante avec le package <a href="https://coverage.readthedocs.io/en/7.2.2/"><code>coverage</code></a>:</p>
<pre class="shell"><code>$ coverage run -m unittest tests/test_create_variable_title.py
$ coverage report -m

Name                                  Stmts   Miss  Cover   Missing
-------------------------------------------------------------------
src/features/build_features.py           34     21    38%   35-36, 48-58, 71-74, 85-89, 99-101, 111-113
tests/test_create_variable_title.py      21      1    95%   54
-------------------------------------------------------------------
TOTAL                                    55     22    60%</code></pre>
<p>Le taux de couverture est souvent mis en avant par les gros projets comme indicateur de leur qualit√©. Il existe d‚Äôailleurs des badges <code>Github</code> d√©di√©s.</p>
</div>
</div>
</section>
<section id="√©tape-2-transformer-son-projet-en-package-optionnel" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-2-transformer-son-projet-en-package-optionnel">√âtape 2 : transformer son projet en package (optionnel)</h2>
<p>Notre projet est modulaire, ce qui le rend assez simple √† transformer en <em>package</em>, en s‚Äôinspirant de la structure du <code>cookiecutter</code> adapt√©, issu de <a href="https://py-pkgs.org/03-how-to-package-a-python#package-structure">cet ouvrage</a>.</p>
<p>On va cr√©er un <em>package</em> nomm√© <code>titanicml</code> qui encapsule tout notre code et qui sera appel√© par notre script <code>main.py</code>. La structure attendue est la suivante:</p>
<details>
<summary>
Structure vis√©e
</summary>
<pre class="shell"><code>ensae-reproductibilite-application
‚îú‚îÄ‚îÄ docs                                    ‚îê 
‚îÇ   ‚îú‚îÄ‚îÄ main.py                             ‚îÇ 
‚îÇ   ‚îî‚îÄ‚îÄ notebooks                           ‚îÇ Package documentation and examples
‚îÇ       ‚îî‚îÄ‚îÄ titanic.ipynb                   ‚îÇ 
‚îú‚îÄ‚îÄ configuration                           ‚îê Configuration (pas √† partager avec Git)
‚îÇ   ‚îî‚îÄ‚îÄ config.yaml                         ‚îò 
‚îú‚îÄ‚îÄ README.md                                
‚îú‚îÄ‚îÄ pyproject.toml                          ‚îê 
‚îú‚îÄ‚îÄ requirements.txt                        ‚îÇ
‚îú‚îÄ‚îÄ titanicml                               ‚îÇ                
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                         ‚îÇ Package source code, metadata
‚îÇ   ‚îú‚îÄ‚îÄ config.yaml                         ‚îÇ and build instructions 
‚îÇ   ‚îú‚îÄ‚îÄ import_data.py                      ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ build_features.py                   ‚îÇ 
‚îÇ   ‚îî‚îÄ‚îÄ train_evaluate.py                   ‚îò
‚îî‚îÄ‚îÄ tests                                   ‚îê
    ‚îî‚îÄ‚îÄ test_create_variable_title.py       ‚îò Package tests</code></pre>
</details>
<details>
<summary>
Rappel: structure actuelle
</summary>
<pre class="shell"><code>ensae-reproductibilite-application
‚îú‚îÄ‚îÄ notebooks                                 
‚îÇ   ‚îî‚îÄ‚îÄ titanic.ipynb                  
‚îú‚îÄ‚îÄ configuration                                 
‚îÇ   ‚îî‚îÄ‚îÄ config.yaml                  
‚îú‚îÄ‚îÄ main.py                              
‚îú‚îÄ‚îÄ README.md                 
‚îú‚îÄ‚îÄ requirements.txt                      
‚îî‚îÄ‚îÄ src 
    ‚îú‚îÄ‚îÄ data                                
    ‚îÇ   ‚îú‚îÄ‚îÄ import_data.py                    
    ‚îÇ   ‚îî‚îÄ‚îÄ test_create_variable_title.py      
    ‚îú‚îÄ‚îÄ features                           
    ‚îÇ   ‚îî‚îÄ‚îÄ build_features.py      
    ‚îî‚îÄ‚îÄ models                          
        ‚îî‚îÄ‚îÄ train_evaluate.py              </code></pre>
</details>
<p>Il existe plusieurs <em>frameworks</em> pour construire un <em>package</em>. Nous allons privil√©gier <a href="https://python-poetry.org/"><code>Poetry</code></a> √† <a href="https://pypi.org/project/setuptools/"><code>Setuptools</code></a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour cr√©er la structure minimale d‚Äôun <em>package</em>, le plus simple est d‚Äôutiliser le <code>cookiecutter</code> adapt√©, issu de <a href="https://py-pkgs.org/03-how-to-package-a-python#package-structure">cet ouvrage</a>.</p>
<p>Comme on a d√©j√† une structure tr√®s modulaire, on va plut√¥t recr√©er cette structure dans notre projet d√©j√† existant. En fait, il ne manque qu‚Äôun fichier essentiel, le principal distinguant un projet classique d‚Äôun package : <code>pyproject.toml</code>.</p>
<pre class="shell"><code>cookiecutter https://github.com/py-pkgs/py-pkgs-cookiecutter.git</code></pre>
<details>
<summary>
D√©rouler pour voir les choix possibles
</summary>
<pre class="shell"><code>author_name [Monty Python]: Daffy Duck
package_name [mypkg]: titanicml
package_short_description []: Impressive Titanic survival analysis
package_version [0.1.0]: 
python_version [3.9]: 
Select open_source_license:
1 - MIT
2 - Apache License 2.0
3 - GNU General Public License v3.0
4 - Creative Commons Attribution 4.0
5 - BSD 3-Clause
6 - Proprietary
7 - None
Choose from 1, 2, 3, 4, 5, 6 [1]: 
Select include_github_actions:
1 - no
2 - ci
3 - ci+cd
Choose from 1, 2, 3 [1]:</code></pre>
</details>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 10: packagisation <em>(optionnel)</em>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Renommer le dossier <code>titanicml</code> pour respecter la nouvelle arborescence ;</li>
<li>Dans <code>titanicml/</code>, cr√©er un fichier <code>__init__.py</code><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a> ;</li>
</ul>
<div id="02bce168" class="cell" data-execution_count="5">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>pyproject.toml</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>[tool.poetry]</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"titanicml"</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>version <span class="op">=</span> <span class="st">"0.0.1"</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>description <span class="op">=</span> <span class="st">"Awesome Machine Learning project"</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>authors <span class="op">=</span> [<span class="st">"Daffy Duck &lt;daffy.duck@fauxmail.fr&gt;"</span>, <span class="st">"Mickey Mouse"</span>]</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>license <span class="op">=</span> <span class="st">"MIT"</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>readme <span class="op">=</span> <span class="st">"README.md"</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>[build<span class="op">-</span>system]</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>requires <span class="op">=</span> [<span class="st">"poetry-core"</span>]</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>build<span class="op">-</span>backend <span class="op">=</span> <span class="st">"poetry.core.masonry.api"</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>[tool.pytest.ini_options]</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>log_cli <span class="op">=</span> true</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>log_cli_level <span class="op">=</span> <span class="st">"WARNING"</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>log_cli_format <span class="op">=</span> <span class="st">"</span><span class="sc">%(asctime)s</span><span class="st"> [</span><span class="sc">%(levelname)8s</span><span class="st">] </span><span class="sc">%(message)s</span><span class="st"> (</span><span class="sc">%(filename)s</span><span class="st">:</span><span class="sc">%(lineno)s</span><span class="st">)"</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>log_cli_date_format <span class="op">=</span> <span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ul>
<li>Cr√©er le dossier <code>docs</code> et mettre les fichiers indiqu√©s dedans</li>
<li>Cr√©er un fichier <code>pyproject.toml</code> sur cette base</li>
</ul>
<div id="4dd118ae" class="cell" data-execution_count="6">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>__init__.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .import_data <span class="im">import</span> (</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    import_data, import_yaml_config</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .build_features <span class="im">import</span> (</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    create_variable_title,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    fill_na_titanic,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    label_encoder_titanic,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    check_has_cabin,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    ticket_length</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .train_evaluate <span class="im">import</span> random_forest_titanic</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>__all__ <span class="op">=</span> [</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"import_data"</span>, <span class="st">"import_yaml_config"</span>,</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"create_variable_title"</span>,</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fill_na_titanic"</span>,</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"label_encoder_titanic"</span>,</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"check_has_cabin"</span>,</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ticket_length"</span>,</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"random_forest_titanic"</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ul>
<li>Installer le package en local avec <code>pip install -e .</code></li>
<li>Modifier le contenu de <code>docs/main.py</code> pour importer les fonctions de notre <em>package</em> <code>titanicml</code> et tester en ligne de commande notre fichier <code>main.py</code></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-29-contents" aria-controls="callout-29" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-29" class="callout-29-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli10</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="partie3" class="level1">
<h1>Partie 3 : construction d‚Äôun projet portable et reproductible</h1>
<p>Dans la partie pr√©c√©dente, on a appliqu√© de mani√®re incr√©mentale de nombreuses bonnes pratiques vues dans les chapitres <a href="../chapters/code-quality.html">Qualit√© du code</a> et <a href="../chapters/projects-architecture.html">Structure des projets</a> tout au long du cours.</p>
<p>Ce faisant, on s‚Äôest d√©j√† consid√©rablement rapproch√©s d‚Äôune possible mise en production : le code est lisible, la structure du projet est normalis√©e et √©volutive, et le code est proprement versionn√© sur un d√©p√¥t <code>GitHub</code> <i class="fa-brands fa-github" aria-label="github"></i>.</p>
<details>
<summary>
Illustration de l‚Äô√©tat actuel du projet
</summary>
<img src="../schema_post_appli8.png" class="img-fluid">
</details>
<p>A pr√©sent, nous avons une version du projet qui est largement partageable. Du moins en th√©orie, car la pratique est souvent plus compliqu√©e : il y a fort √† parier que si vous essayez d‚Äôex√©cuter votre projet sur un autre environnement (typiquement, votre ordinateur personnel), les choses ne se passent pas du tout comme attendu. Cela signifie qu‚Äô<strong>en l‚Äô√©tat, le projet n‚Äôest pas portable : il n‚Äôest pas possible, sans modifications co√ªteuses, de l‚Äôex√©cuter dans un environnement diff√©rent de celui dans lequel il a √©t√© d√©velopp√©</strong>.</p>
<p>Dans cette seconde partie, nous allons voir comment <strong>normaliser l‚Äôenvironnement d‚Äôex√©cution afin de produire un projet portable</strong>. Autrement dit, nous n‚Äôallons plus nous contenter de modularit√© mais allons rechercher la portabilit√©. On sera alors tout proche de pouvoir mettre le projet en production. On progressera dans l‚Äô√©chelle de la reproductibilit√© de la mani√®re suivante:</p>
<ul>
<li>:one: <a href="#anaconda"><strong>Environnements virtuels</strong></a> ;</li>
<li>:two: Cr√©er un script shell qui permet, depuis un environnement minimal, de construire l‚Äôapplication de A √† Z ;</li>
<li>:three: <a href="#docker"><strong>Images et conteneurs <code>Docker</code></strong></a>.</li>
</ul>
<p>Nous allons repartir de l‚Äôapplication 8, c‚Äôest-√†-dire d‚Äôun projet modulaire mais qui n‚Äôest pas, √† strictement parler, un package (objet des applications optionnelles suivantes 9 et 10).</p>
<p>Pour se replacer dans l‚Äô√©tat du projet √† ce niveau, il est possible d‚Äôutiliser le <em>tag</em> <em>ad hoc</em>.</p>
<pre class="shell"><code>git checkout appli8</code></pre>
<section id="anaconda" class="level2">
<h2 class="anchored" data-anchor-id="anaconda">√âtape 1 : un environnement pour rendre le projet portable</h2>
<p>Pour qu‚Äôun projet soit portable, il doit remplir deux conditions:</p>
<ul>
<li>Ne pas n√©cessiter de d√©pendance qui ne soient pas renseign√©es quelque part</li>
<li>Ne pas proposer des d√©pendances inutiles, qui ne sont pas utilis√©es dans le cadre du projet.</li>
</ul>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Environnement virtuel</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Environnement conda</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>L‚Äôapproche la plus l√©g√®re est l‚Äôenvironnement virtuel. Nous avons en fait implicitement d√©j√† commenc√© √† aller vers cette direction en cr√©ant un fichier <code>requirements.txt</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 11a: environnement virtuel <code>venv</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>Ex√©cuter <code>pip freeze</code> en ligne de commande et observer la (tr√®s) longue liste de package</p></li>
<li><p>Cr√©er l‚Äôenvironnement virtuel <code>titanic</code> en s‚Äôinspirant de <a href="https://packaging.python.org/en/latest/guides/installing-using-pip-and-virtual-environments/">la documentation officielle</a><a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a></p></li>
<li><p>Utiliser <code>ls</code> pour observer et comprendre le contenu du dossier <code>titanic/bin</code> install√©</p></li>
<li><p>Activer l‚Äôenvironnement et v√©rifier l‚Äôinstallation de <code>Python</code> maintenant utilis√©e par votre machine <!---source titanic/bin/activate && which python----></p></li>
<li><p>V√©rifier directement depuis la ligne de commande que <code>Python</code> ex√©cute bien une commande avec:</p>
<pre class="shell"><code>python -c "print('Hello')"</code></pre></li>
<li><p>Faire la m√™me chose mais avec <code>import pandas as pd</code></p></li>
<li><p>Installer les packages √† partir du <code>requirements.txt</code>. Tester √† nouveau <code>import pandas as pd</code> pour comprendre la diff√©rence.</p></li>
<li><p>Ex√©cuter <code>pip freeze</code> et comprendre la diff√©rence avec la situation pr√©c√©dente.</p></li>
<li><p>V√©rifier que le script <code>main.py</code> fonctionne bien. Sinon ajouter les <em>packages</em> manquants dans le <code>requirements.txt</code> et reprendre de mani√®re it√©rative √† partir de la question 7</p></li>
<li><p>Ajouter le dossier <code>titanic/</code> au <code>.gitignore</code> pour ne pas ajouter ce dossier √† <code>Git</code></p></li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-31-contents" aria-controls="callout-31" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-31" class="callout-31-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli11a</code></pre>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>Les environnements <code>conda</code> sont plus lourds √† mettre en oeuvre que les environnements virtuels mais peuvent permettre un contr√¥le plus formel des d√©pendances.</p>
<p><code>conda</code> est √† la fois un gestionnaire de packages (alternative √† <code>pip</code>) et d‚Äôenvironnements virtuels. L‚Äôinconv√©nient de l‚Äôutilisation de <code>conda</code> pour g√©rer les environnements virtuels est que cet outil est assez lent car l‚Äôalgorithme de v√©rification des conflits de version n‚Äôest pas extr√™mement rapide.</p>
<p>Pour cette raison, nous allons utiliser <a href="https://mamba.readthedocs.io/en/latest/user_guide/mamba.html"><code>mamba</code></a>, un utilitaire de gestion des environnements <code>conda</code> qui est plus rapide.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 11b: environnement <code>conda</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>Ex√©cuter <code>conda env export</code> en ligne de commande et observer la (tr√®s) longue liste de package</p></li>
<li><p>Tester l‚Äôutilisation d‚Äôun package qu‚Äôon n‚Äôutilise pas dans notre chaine de production, par exemple <code>seaborn</code>:</p>
<pre class="shell"><code>python -c "import seaborn as sns"</code></pre></li>
<li><p>Cr√©er un environnement <code>titanic</code> avec <a href="https://mamba.readthedocs.io/en/latest/user_guide/mamba.html#quickstart"><code>mamba create</code></a> en listant les packages que vous aviez mis dans le <code>requirements.txt</code> et en ajoutant l‚Äôoption <code>-c conda-forge</code> √† la fin pour utiliser <a href="https://conda-forge.org/">la <em>conda forge</em></a></p></li>
<li><p>Activer l‚Äôenvironnement et v√©rifier l‚Äôinstallation de <code>Python</code> maintenant utilis√©e par votre machine <!---mamba activate titanic && which python----></p></li>
<li><p><em>(optionnel)</em> Utiliser <code>ls</code> dans le dossier parent de <code>Python</code> pour observer et comprendre le contenu de celui-ci</p></li>
<li><p>V√©rifier que cette fois <code>seaborn</code> n‚Äôest pas install√© dans l‚Äôenvironnement :</p>
<pre class="shell"><code>python -c "import seaborn as sns"</code></pre></li>
<li><p>Ex√©cuter √† nouveau <code>conda env export</code> et comprendre la diff√©rence avec la situation pr√©c√©dente<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>.</p></li>
<li><p>V√©rifier que le script <code>main.py</code> fonctionne bien. Sinon utiliser <code>mamba install</code> avec les <em>packages</em> manquants jusqu‚Äô√† ce que la chaine de production fonctionne</p></li>
<li><p>Cr√©er le fichier <code>environment.yaml</code> √† partir de <code>conda env export</code>:</p>
<pre class="shell"><code>conda env export &gt; environment.yaml</code></pre></li>
<li><p>Ajouter le dossier <code>titanic/</code> au <code>.gitignore</code> pour ne pas ajouter ce dossier √† <code>Git</code></p></li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-33-contents" aria-controls="callout-33" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-33" class="callout-33-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli11b</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="√©tape-2-construire-lenvironnement-de-notre-application-via-un-script-shell" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-2-construire-lenvironnement-de-notre-application-via-un-script-shell">√âtape 2: construire l‚Äôenvironnement de notre application via un script <code>shell</code></h2>
<p>Les environnements virtuels permettent de mieux sp√©cifier les d√©pendances de notre projet, mais ne permettent pas de garantir une portabilit√© optimale. Pour cela, il faut recourir √† la technologie des conteneurs. L‚Äôid√©e est de construire une machine, en partant d‚Äôune base quasi-vierge, qui permette de construire √©tape par √©tape l‚Äôenvironnement n√©cessaire au bon fonctionnement de notre projet. C‚Äôest le principe des conteneurs <code>Docker</code>.</p>
<p>Leur m√©thode de construction √©tant un peu difficile √† prendre en main au d√©but, nous allons passer par une √©tape interm√©diaire afin de bien comprendre le processus de production.</p>
<ul>
<li>Nous allons d‚Äôabord cr√©er un script <code>shell</code>, c‚Äôest √† dire une suite de commandes <code>Linux</code> permettant de construire l‚Äôenvironnement √† partir d‚Äôune machine vierge ;</li>
<li>Nous transformerons celui-ci en <code>Dockerfile</code> dans un deuxi√®me temps. C‚Äôest l‚Äôobjet de l‚Äô√©tape suivante.</li>
</ul>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Environnement virtuel</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Environnement <code>conda</code></a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 12a : cr√©er un fichier d‚Äôinstallation de A √† Z
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Cr√©er un service <code>ubuntu</code> sur le SSP Cloud</li>
<li>Ouvrir un terminal</li>
<li>Cloner le d√©p√¥t</li>
<li>Se placer dans le dossier du projet avec <code>cd</code></li>
<li>Se placer au niveau du checkpoint 11a avec <code>git checkout appli11a</code></li>
<li>Via l‚Äôexplorateur de fichiers, cr√©er le fichier <code>install.sh</code> √† la racine du projet avec le contenu suivant:</li>
</ol>
<details>
<summary>
Script √† cr√©er sous le nom <code>install.sh</code>
</summary>
<pre class="shell"><code>#!/bin/bash

# Install Python
apt-get -y update
apt-get install -y python3-pip python3-venv

# Create empty virtual environment
python3 -m venv titanic
source titanic/bin/activate

# Install project dependencies
pip install -r requirements.txt</code></pre>
</details>
<ol start="6" type="1">
<li>Changer les permissions sur le script pour le rendre ex√©cutable</li>
</ol>
<pre class="shell"><code>chmod +x install.sh</code></pre>
<ol start="7" type="1">
<li>Ex√©cuter le script depuis la ligne de commande avec des droits de super-utilisateur (n√©cessaires pour installer des <em>packages</em> via <code>apt</code>)</li>
</ol>
<pre class="shell"><code>sudo ./install.sh</code></pre>
<ol start="8" type="1">
<li>V√©rifier que le script <code>main.py</code> fonctionne correctement dans l‚Äôenvironnement virtuel cr√©√©</li>
</ol>
<pre class="shell"><code>source titanic/bin/activate
python3 main.py</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-35-contents" aria-controls="callout-35" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-35" class="callout-35-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli12a</code></pre>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 12b : cr√©er un fichier d‚Äôinstallation de A √† Z
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Cr√©er un service <code>ubuntu</code> sur le SSP Cloud en cliquant sur <a href="https://datalab.sspcloud.fr/launcher/inseefrlab-helm-charts-datascience/ubuntu?autoLaunch=false&amp;git.cache=%C2%AB36000%C2%BB&amp;git.repository=%C2%ABhttps%3A%2F%2Fgithub.com%2Flinogaliana%2Fensae-reproductibilite-application-correction.git%C2%BB">ce lien</a></li>
<li>Cloner le d√©p√¥t et se placer au niveau du checkpoint 11b avec <code>git checkout appli11b</code></li>
<li>Se placer dans le dossier du projet avec <code>cd</code></li>
<li>On va se placer en super-utilisateur dans la ligne de commande en tapant</li>
</ol>
<pre class="shell"><code>sudo bash</code></pre>
<ol start="5" type="1">
<li>Cr√©er le fichier <code>install.sh</code> avec le contenu suivant:</li>
</ol>
<details>
<summary>
Script √† cr√©er sous le nom <code>install.sh</code>
</summary>
<pre class="shell"><code>apt-get -y update &amp;&amp; apt-get -y install wget

wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh &amp;&amp; \
    bash Miniconda3-latest-Linux-x86_64.sh -b -p /miniconda &amp;&amp; \
    rm -f Miniconda3-latest-Linux-x86_64.sh

PATH="/miniconda/bin:${PATH}"

# Create environment
conda install mamba -c conda-forge
mamba create -n titanic pandas PyYAML scikit-learn -c conda-forge
mamba activate titanic

PATH="/miniconda/envs/titanic/bin:${PATH}"

python main.py</code></pre>
</details>
<ol start="6" type="1">
<li>Changer les permissions sur le fichier</li>
</ol>
<pre class="shell"><code>chmod u+x ./install.sh</code></pre>
<ol start="7" type="1">
<li>Ex√©cuter le script depuis la ligne de commande</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-37-contents" aria-controls="callout-37" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-37" class="callout-37-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli12b</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="docker" class="level2">
<h2 class="anchored" data-anchor-id="docker">√âtape 3: conteneuriser l‚Äôapplication avec <code>Docker</code></h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Cette application n√©cessite l‚Äôacc√®s √† une version interactive de <code>Docker</code>. Il n‚Äôy a pas beaucoup d‚Äôinstances en ligne disponibles.</p>
<p>Nous proposons deux solutions:</p>
<ul>
<li><a href="https://docs.docker.com/get-docker/">Installer <code>Docker</code></a> sur sa machine ;</li>
<li>Se rendre sur l‚Äôenvironnement bac √† sable <em><a href="https://labs.play-with-docker.com">Play with Docker</a></em></li>
</ul>
</div>
</div>
<p>Maintenant qu‚Äôon sait que ce script pr√©paratoire fonctionne, on va le transformer en <code>Dockerfile</code> (la syntaxe <code>Docker</code> est l√©g√®rement diff√©rente de la syntaxe <code>Linux</code> classique). Puis on va le tester dans un environnement bac √† sable (pour ensuite pouvoir plus facilement automatiser la construction de l‚Äôimage <code>Docker</code> par la suite).</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 13: cr√©ation de l‚Äôimage <code>Docker</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Se placer dans un environnement avec <code>Docker</code></p>
<ul>
<li>Dans le terminal <code>Linux</code>, cloner votre d√©p√¥t <code>Github</code></li>
<li>Cr√©er via la ligne de commande un fichier texte vierge nomm√© <code>Dockerfile</code> (la majuscule au d√©but du mot est importante)</li>
</ul>
<details>
<summary>
Commande pour cr√©er un <code>Dockerfile</code> vierge depuis la ligne de commande
</summary>
<pre class="shell"><code>touch Dockerfile</code></pre>
</details>
<ul>
<li>Ouvrir ce fichier via un √©diteur de texte et copier le contenu suivant dedans:</li>
</ul>
<details>
<summary>
Premier <code>Dockerfile</code>
</summary>
<pre class="shell"><code>FROM ubuntu:22.04

WORKDIR ${HOME}/titanic

# Install Python
RUN apt-get -y update &amp;&amp; \
    apt-get install -y python3-pip

# Install project dependencies
COPY requirements.txt .
RUN pip install -r requirements.txt

CMD ["python3", "main.py"]</code></pre>
</details>
<section id="construire-limage" class="level3">
<h3 class="anchored" data-anchor-id="construire-limage">Construire l‚Äôimage</h3>
<p>Le <code>Dockerfile</code> est la recette de construction de l‚Äôimage. La construction effective de l‚Äôimage √† partir de cette recette s‚Äôappelle l‚Äô√©tape de <code>build</code>.</p>
<ul>
<li>Utiliser <code>docker build</code> pour cr√©er une image avec le tag <code>my-python-app</code></li>
</ul>
<pre class="shell"><code>docker build . -t my-python-app</code></pre>
<ul>
<li>V√©rifier les images dont vous disposez. Vous devriez avoir un r√©sultat proche de celui-ci :</li>
</ul>
<pre class="shell"><code>$ docker images

REPOSITORY      TAG       IMAGE ID       CREATED         SIZE
my-python-app   latest    c0dfa42d8520   6 minutes ago   836MB
ubuntu          25.04     825d55fb6340   6 days ago      77.8MB</code></pre>
</section>
<section id="tester-limage-d√©couverte-du-cache" class="level3">
<h3 class="anchored" data-anchor-id="tester-limage-d√©couverte-du-cache">Tester l‚Äôimage: d√©couverte du cache</h3>
<p>L‚Äô√©tape de <code>build</code> a fonctionn√©: une image a √©t√© construite.</p>
<p>Mais fait-elle effectivement ce que l‚Äôon attend d‚Äôelle ?</p>
<p>Pour le savoir, il faut passer √† l‚Äô√©tape suivante, l‚Äô√©tape de <code>run</code>.</p>
<pre class="shell"><code>$ docker run -it my-python-app

python3: can't open file '/~/titanic/main.py': [Errno 2] No such file or directory</code></pre>
<p>Le message d‚Äôerreur est clair : <code>Docker</code> ne sait pas o√π trouver le fichier <code>main.py</code>. D‚Äôailleurs, il ne connait pas non plus les autres fichiers de notre application qui sont n√©cessaires pour faire tourner le code: <code>config.yaml</code> et le dossier <code>src</code>.</p>
<ul>
<li>Avant l‚Äô√©tape <code>CMD</code>, copier les fichiers n√©cessaires sur l‚Äôimage afin que l‚Äôapplication dispose de tous les √©l√©ments n√©cessaires pour √™tre en mesure de fonctionner.</li>
</ul>
<details>
<summary>
Nouveau <code>Dockerfile</code>
</summary>
<pre class="shell"><code>FROM ubuntu:22.04

WORKDIR ${HOME}/titanic

# Install Python
RUN apt-get -y update &amp;&amp; \
    apt-get install -y python3-pip

# Install project dependencies
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY main.py .
COPY src ./src
COPY configuration ./configuration
CMD ["python3", "main.py"]</code></pre>
</details>
<ul>
<li><p>Refaire tourner l‚Äô√©tape de <code>build</code></p></li>
<li><p>Refaire tourner l‚Äô√©tape de <code>run</code>. A ce stade, la matrice de confusion doit fonctionner üéâ. Vous avez cr√©√© votre premi√®re application reproductible !</p></li>
</ul>
</section>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ici, le <em>cache</em> permet d‚Äô√©conomiser beaucoup de temps. Par besoin de refaire tourner toutes les √©tapes, <code>Docker</code> agit de mani√®re intelligente en faisant tourner uniquement les √©tapes qui ont chang√©.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-41-contents" aria-controls="callout-41" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-41" class="callout-41-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli13</code></pre>
</div>
</div>
</div>
</section>
</section>
<section id="partie-4-automatisation-avec-lint√©gration-continue" class="level1">
<h1>Partie 4 : automatisation avec l‚Äôint√©gration continue</h1>
<p>Une image <code>Docker</code> est un livrable qui n‚Äôest pas forc√©ment int√©ressant pour tous les publics. Certains pr√©f√©reront avoir un plat bien pr√©par√© qu‚Äôune recette. Nous allons donc proposer d‚Äôaller plus loin en proposant plusieurs types de livrables.</p>
<p>Cela va nous amener √† d√©couvrir les outils du <code>CI/CD</code> (<em>Continuous Integration / Continuous Delivery</em>) qui sont au coeur de l‚Äôapproche <code>DevOps</code>.</p>
<p>Notre approche appliqu√©e au <em>machine learning</em> va nous entra√Æner plut√¥t du c√¥t√© du <code>MLOps</code> qui devient une approche de plus en plus fr√©quente dans l‚Äôindustrie de la <em>data science</em>.</p>
<p>Nous allons am√©liorer notre approche de trois mani√®res:</p>
<ul>
<li>Automatisation de la cr√©ation de l‚Äôimage <code>Docker</code> et tests automatis√©s de la qualit√© du code ;</li>
<li>Production d‚Äôun site <em>web</em> automatis√© permettant de documenter et valoriser le mod√®le de <em>Machine Learning</em> ;</li>
<li>Mise √† disposition du mod√®le entra√Æn√© par le biais d‚Äôune API pour ne pas le r√©-entra√Æner √† chaque fois et faciliter sa r√©utilisation ;</li>
</ul>
<p>A chaque fois, nous allons d‚Äôabord tester en local notre travail puis essayer d‚Äôautomatiser cela avec les outils de <code>Github</code>.</p>
<p>On va ici utiliser l‚Äôint√©gration continue pour deux objectifs distincts:</p>
<ul>
<li>la mise √† disposition de l‚Äôimage <code>Docker</code> ;</li>
<li>la mise en place de tests automatis√©s de la qualit√© du code sur le mod√®le de notre <code>linter</code> pr√©c√©dent</li>
</ul>
<p>Nous allons utiliser <code>Github Actions</code> pour cela.</p>
<section id="√©tape-1-mise-en-place-de-tests-automatis√©s" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-1-mise-en-place-de-tests-automatis√©s">√âtape 1: mise en place de tests automatis√©s</h2>
<p>Avant d‚Äôessayer de mettre en oeuvre la cr√©ation de notre image <code>Docker</code> de mani√®re automatis√©e, nous allons pr√©senter la logique de l‚Äôint√©gration continue en testant de mani√®re automatis√©e notre script <code>main.py</code>.</p>
<p>Pour cela, nous allons partir de la structure propos√©e dans l‚Äô<a href="https://github.com/actions/setup-python">action officielle</a>. La documentation associ√©e est <a href="https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python">ici</a></p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 14: premier script d‚Äôint√©gration continue
</div>
</div>
<div class="callout-body-container callout-body">
<p>A partir de l‚Äôexemple pr√©sent dans la <a href="https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python">documentation officielle</a> de <code>Github</code>, on a d√©j√† une base de d√©part qui peut √™tre modifi√©e:</p>
<ol type="1">
<li>Cr√©er un fichier <code>.github/workflows/ci.yaml</code> avec le contenu de l‚Äôexemple de la documentation</li>
<li>Retirer la <code>strategy matrix</code> et ne tester qu‚Äôavec la version <code>3.10</code> de <code>Python</code></li>
<li>Utiliser le fichier <code>requirements.txt</code> pour installer les d√©pendances.</li>
<li>Remplacer <code>russ</code> par <code>pylint</code> pour v√©rifier la qualit√© du code. Ajouter l‚Äôargument <code>--fail-under=6</code> pour renvoyer une erreur en cas de note trop basse<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a></li>
<li>Plut√¥t que <code>pytest</code>, utiliser <code>python main.py</code> pour tester que la matrice de confusion s‚Äôaffiche bien.</li>
</ol>
<details>
<summary>
Fichier <code>.github/workflows/ci.yaml</code> obtenu
</summary>
<div class="sourceCode" id="cb60"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Build, test and push</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">push</span><span class="kw">]</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Python</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-python@v4</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">python-version</span><span class="kw">:</span><span class="at"> </span><span class="st">'3.10'</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dependencies</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>          python -m pip install --upgrade pip</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>          pip install pylint</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>          pip install -r requirements.txt</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Lint</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>          pylint src --fail-under=6</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Test workflow</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>          python main.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-43-contents" aria-controls="callout-43" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-43" class="callout-43-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli14</code></pre>
</div>
</div>
</div>
<p>Maintenant, nous pouvons observer que l‚Äôonglet <code>Actions</code> s‚Äôest enrichi. Chaque <code>commit</code> va entra√Æner une action pour tester nos scripts.</p>
<p>Si la note est mauvaise, nous aurons une croix rouge (et nous recevrons un mail). On pourra ainsi d√©tecter, en d√©veloppant son projet, les moments o√π on d√©grade la qualit√© du script afin de la r√©tablir imm√©diatemment.</p>
</section>
<section id="√©tape-2-automatisation-de-la-livraison-de-limage-docker" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-2-automatisation-de-la-livraison-de-limage-docker">√âtape 2: Automatisation de la livraison de l‚Äôimage <code>Docker</code></h2>
<p>Maintenant, nous allons automatiser la mise √† disposition de notre image sur <code>DockerHub</code>. Cela facilitera sa r√©utilisation mais aussi des valorisations ult√©rieures.</p>
<p>L√† encore, nous allons utiliser une s√©rie d‚Äôactions pr√©-configur√©es.</p>
<p>Pour que <code>Github</code> puisse s‚Äôauthentifier aupr√®s de <code>DockerHub</code>, il va falloir d‚Äôabord interfacer les deux plateformes. Pour cela, nous allons utiliser un jeton (<em>token</em>) <code>DockerHub</code> que nous allons mettre dans un espace s√©curis√© associ√© √† votre d√©p√¥t <code>Github</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 15a: configuration
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Se rendre sur https://hub.docker.com/ et cr√©er un compte.</li>
<li>Cr√©er un d√©p√¥t public <code>application-correction</code></li>
<li>Aller dans les param√®tres (https://hub.docker.com/settings/general) et cliquer, √† gauche, sur <code>Security</code></li>
<li>Cr√©er un jeton personnel d‚Äôacc√®s, ne fermez pas l‚Äôonglet en question, vous ne pouvez voir sa valeur qu‚Äôune fois.</li>
<li>Dans votre d√©p√¥t <code>Github</code>, cliquer sur l‚Äôonglet <code>Settings</code> et cliquer, √† gauche, sur <code>Actions</code>. Sur la page qui s‚Äôaffiche, cliquer sur <code>New repository secret</code></li>
<li>Donner le nom <code>DOCKERHUB_TOKEN</code> √† ce jeton et copier la valeur. Valider</li>
<li>Cr√©er un deuxi√®me secret nomm√© <code>DOCKERHUB_USERNAME</code> ayant comme valeur le nom d‚Äôutilisateur que vous avez cr√©√© sur <code>Dockerhub</code></li>
</ul>
</div>
</div>
<p>A ce stade, nous avons donn√© les moyens √† <code>Github</code> de s‚Äôauthentifier avec notre identit√© sur <code>Dockerhub</code>. Il nous reste √† mettre en oeuvre l‚Äôaction en s‚Äôinspirant de https://github.com/docker/build-push-action/#usage. On ne va modifier que trois √©l√©ments dans ce fichier. Effectuer les actions suivantes:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 15b: automatisation de l‚Äôimage <code>Docker</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>En s‚Äôinspirant de ce <a href="https://github.com/marketplace/actions/build-and-push-docker-images"><em>template</em></a>, ajouter un nouveau job <code>docker</code> dans le fichier <code>ci.yaml</code> qui va <em>build</em> et <em>push</em> l‚Äôimage sur le <code>DockerHub</code></li>
<li>D√©finir le job <code>test</code> comme pr√©requis du job <code>docker</code> en vous r√©f√©rant √† cette <a href="https://docs.github.com/en/actions/using-jobs/using-jobs-in-a-workflow#defining-prerequisite-jobs">documentation</a></li>
<li>Changer le tag √† la fin pour mettre <code>&lt;username&gt;/application-correction:latest</code> o√π <code>username</code> est le nom d‚Äôutilisateur sur <code>DockerHub</code>;</li>
</ul>
<details>
<summary>
Fichier <code>.github/workflows/ci.yaml</code> obtenu
</summary>
<div class="sourceCode" id="cb62"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Build, test and push</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">push</span><span class="kw">]</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Python</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-python@v4</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">python-version</span><span class="kw">:</span><span class="at"> </span><span class="st">'3.10'</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dependencies</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>          python -m pip install --upgrade pip</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>          pip install pylint</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>          pip install -r requirements.txt</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Lint</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>          pylint src --fail-under=6</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Test workflow</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>          python main.py</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">docker</span><span class="kw">:</span></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> test</span></span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up QEMU</span></span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/setup-qemu-action@v2</span></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Docker Buildx</span></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/setup-buildx-action@v2</span></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Login to Docker Hub</span></span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/login-action@v2</span></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">username</span><span class="kw">:</span><span class="at"> ${{ secrets.DOCKERHUB_USERNAME }}</span></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">password</span><span class="kw">:</span><span class="at"> ${{ secrets.DOCKERHUB_TOKEN }}</span></span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build and push</span></span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/build-push-action@v4</span></span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">push</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">tags</span><span class="kw">:</span><span class="at"> linogaliana/application-correction:latest</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li>Faire un <code>commit</code> et un <code>push</code> de ces fichiers</li>
</ul>
</div>
</div>
<p>Comme on est fier de notre travail, on va afficher √ßa avec un badge sur le <code>README</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 15c: Afficher un badge dans le <code>README</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Se rendre dans l‚Äôonglet <code>Actions</code> et cliquer sur un des scripts en train de tourner.</li>
<li>En haut √† droite, cliquer sur <code>...</code></li>
<li>S√©lectionner <code>Create status badge</code></li>
<li>R√©cup√©rer le code <code>Markdown</code> propos√©</li>
<li>Copier dans le <code>README</code> depuis <code>VSCode</code></li>
<li>Faire de m√™me pour l‚Äôautre <em>workflow</em></li>
</ul>
</div>
</div>
<p>Maintenant, il nous reste √† tester notre application dans l‚Äôespace bac √† sable ou en local, si <code>Docker</code> est install√©.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 15d: Tester l‚Äôapplication
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Se rendre sur l‚Äôenvironnement bac √† sable <em><a href="https://labs.play-with-docker.com">Play with Docker</a></em></li>
<li>R√©cup√©rer l‚Äôimage :</li>
</ul>
<div class="sourceCode" id="cb63"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="at">docker pull &lt;username_dockerhub&gt;/application-correction:latest</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Tester le bon fonctionnement de l‚Äôimage</li>
</ul>
<div class="sourceCode" id="cb64"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="at">docker run -it &lt;username_dockerhub&gt;/application-correction:latest</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>:tada: La matrice de confusion doit s‚Äôafficher ! Vous avez grandement facilit√© la r√©utilisation de votre image.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-48-contents" aria-controls="callout-48" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-48" class="callout-48-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli15</code></pre>
</div>
</div>
</div>
</section>
</section>
<section id="partie-5-mise-en-production-dune-api-servant-un-mod√®le-de-machine-learning" class="level1">
<h1>Partie 5: mise en production d‚Äôune API servant un mod√®le de machine learning</h1>
<section id="√©tape-1-cr√©ation-dun-pipeline-scikit" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-1-cr√©ation-dun-pipeline-scikit">√âtape 1: cr√©ation d‚Äôun pipeline <code>scikit</code></h2>
<p>Notre code respecte des bonnes pratiques formelles. Cependant, la mise en production n√©cessite d‚Äô√™tre exigeant sur la mise en oeuvre op√©rationnelle de notre <em>pipeline</em>.</p>
<p>Quand on utilise <code>scikit</code>, la bonne pratique est d‚Äôutiliser les <a href="https://scikit-learn.org/stable/modules/generated/sklearn.pipeline.Pipeline.html"><em>pipelines</em></a> qui s√©curisent les √©tapes de <em>feature engineering</em> avant la mise en oeuvre d‚Äôun mod√®le (que ce soit pour l‚Äôentra√Ænement ou le test sur un nouveau jeu de donn√©es).</p>
<p>On va donc devoir refactoriser notre application pour utiliser un <em>pipeline</em> <code>scikit</code>. Les raisons sont expliqu√©es <a href="https://scikit-learn.org/stable/common_pitfalls.html">ici</a>. Cela aura aussi l‚Äôavantage de rendre les √©tapes plus lisibles.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 16: Un <em>pipeline</em> de <em>machine learning</em>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Refactoriser le code de <code>random_forest_titanic</code> pour cr√©er un vrai pipeline de <em>preprocessing</em> avant la mod√©lisation</p></li>
<li><p>Simplifier la fonction <code>split_train_test_titanic</code> en la r√©duisant au d√©coupage train/test</p></li>
<li><p>Modifier <code>main.py</code> pour que ce soit √† ce niveau qu‚Äôa lieu le d√©coupage en train/test, l‚Äôentrainement et l‚Äô√©valuation du mod√®le</p></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-50-contents" aria-controls="callout-50" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-50" class="callout-50-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli16</code></pre>
</div>
</div>
</div>
</section>
<section id="√©tape-2-d√©velopper-une-api-en-local" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-2-d√©velopper-une-api-en-local">√âtape 2: d√©velopper une API en local</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 17: Mise √† disposition sous forme d‚ÄôAPI locale
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Cr√©er un nouveau service <code>SSPCloud</code> en param√©trant dans l‚Äôonglet <code>Networking</code> le port 5000 ;</li>
<li>Cloner le d√©p√¥t et se placer au niveau de l‚Äôapplication pr√©c√©dente (<code>git checkout appli16</code>)</li>
<li>Installer <code>fastAPI</code> et <code>uvicorn</code> puis les ajouter au <code>requirements.txt</code></li>
<li>Renommer le fichier <code>main.py</code> en <code>train.py</code> et ins√©rer le contenu suivant dedans :</li>
</ul>
<details>
<summary>
Fichier <code>train.py</code>
</summary>
R√©cup√©rer le contenu sur <a href="https://raw.githubusercontent.com/ensae-reproductibilite/application-correction/appli17/train.py">cette page</a>
</details>
<ul>
<li>Cr√©er le fichier <code>api.py</code> permettant d‚Äôinitialiser l‚ÄôAPI:</li>
</ul>
<details>
<summary>
Fichier <code>api.py</code>
</summary>
R√©cup√©rer le contenu sur <a href="https://raw.githubusercontent.com/ensae-reproductibilite/application-correction/appli17/api.py">cette page</a>
</details>
<ul>
<li>Ex√©cuter <code>train.py</code> pour stocker en local le mod√®le entra√Æn√©</li>
<li>Ajouter <code>model.joblib</code> au <code>.gitignore</code></li>
<li>D√©ployer en local l‚ÄôAPI avec la commande</li>
</ul>
<pre class="shell"><code>uvicorn api:app --reload --host "0.0.0.0" --port 5000</code></pre>
<ul>
<li>A partir du <code>README</code> du service, se rendre sur l‚ÄôURL de d√©ploiement, ajouter <code>/docs/</code> √† celui-ci et observer la documentation de l‚ÄôAPI</li>
<li>Se servir de la documentation pour tester les requ√™tes <code>/predict</code></li>
<li>R√©cup√©rer l‚ÄôURL d‚Äôune des requ√™tes propos√©es. La tester dans le navigateur et depuis <code>Python</code> avec <code>requests</code> (<code>requests.get(url).json()</code>)</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-52-contents" aria-controls="callout-52" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-52" class="callout-52-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli17</code></pre>
</div>
</div>
</div>
</section>
<section id="√©tape-3-d√©ployer-lapi" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-3-d√©ployer-lapi">√âtape 3: d√©ployer l‚ÄôAPI</h2>
<p>A ce stade, nous avons d√©ploy√© l‚ÄôAPI seulement localement, dans le cadre d‚Äôun service. Ce mode de d√©ploiement est tr√®s pratique pour la phase de d√©veloppement, afin de s‚Äôassurer que l‚ÄôAPI fonctionne comme attendu. A pr√©sent, il est temps de passer √† l‚Äô√©tape de d√©ploiement, qui permettra √† notre API d‚Äô√™tre accessible via une URL sur le web, et donc aux utilisateurs potentiels de la requ√™ter. Pour se faire, on va utiliser les possibilit√©s offertes par <code>Kubernetes</code>, sur lequel est bas√© le <a href="https://datalab.sspcloud.fr">SSP Cloud</a>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 18: Dockeriser l‚ÄôAPI
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Modifier le <code>Dockerfile</code> pour tenir compte des changements dans les noms de fichier effecut√©s dans l‚Äôapplication pr√©c√©dente</p></li>
<li><p>Cr√©er un script <code>run.sh</code> √† la racine du projet qui lance le script <code>train.py</code> puis d√©ploie localement l‚ÄôAPI</p></li>
</ul>
<details>
<summary>
Fichier <code>run.sh</code>
</summary>
<pre class="shell"><code>#/bin/bash

python3 train.py
uvicorn api:app --reload --host "0.0.0.0" --port 5000</code></pre>
</details>
<ul>
<li><p>Donner au script <code>run.sh</code> des permissions d‚Äôex√©cution : <code>chmod +x run.sh</code></p></li>
<li><p>Changer l‚Äôinstruction <code>CMD</code> du <code>Dockerfile</code> pour ex√©cuter le script <code>run.sh</code> au lancement du conteneur</p></li>
<li><p><em>Commit</em> et <em>push</em> les changements</p></li>
<li><p>Une fois le CI termin√©, r√©cup√©rer la nouvelle image dans l‚Äôenvironnement de test et v√©rifier que l‚ÄôAPI se d√©ploie correctement</p></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-54-contents" aria-controls="callout-54" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-54" class="callout-54-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli18</code></pre>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 19: D√©ployer l‚ÄôAPI
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Cr√©er un dossier <code>deployment</code> √† la racine du projet qui va contenir les fichiers de configuration n√©cessaires pour d√©ployer sur un cluster <code>Kubernetes</code></p></li>
<li><p>En vous inspirant de la <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment">documentation</a>, y ajouter un premier fichier <code>deployment.yaml</code> qui va sp√©cifier la configuration du <em>Pod</em> √† lancer sur le cluster</p></li>
</ul>
<details>
<summary>
Fichier <code>deployment/deployment.yaml</code>
</summary>
<div class="sourceCode" id="cb71"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> titanic-deployment</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> linogaliana/application-correction:latest</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li>En vous inspirant de la <a href="https://kubernetes.io/fr/docs/concepts/services-networking/service/#d%C3%A9finition-d-un-service">documentation</a>, y ajouter un second fichier <code>service.yaml</code> qui va cr√©er une ressource <code>Service</code> permettant de donner une identit√© fixe au <code>Pod</code> pr√©c√©demment cr√©√© au sein du cluster</li>
</ul>
<details>
<summary>
Fichier <code>deployment/service.yaml</code>
</summary>
<div class="sourceCode" id="cb72"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> titanic-service</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">protocol</span><span class="kw">:</span><span class="at"> TCP</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li>En vous inspirant de la <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#the-ingress-resource">documentation</a>, y ajouter un troisi√®me fichier <code>ingress.yaml</code> qui va cr√©er une ressource <code>Ingress</code> permettant d‚Äôexposer le service via une URL en dehors du cluster</li>
</ul>
<details>
<summary>
Fichier <code>deployment/ingress.yaml</code>
</summary>
<div class="sourceCode" id="cb73"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> networking.k8s.io/v1</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Ingress</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> titanic-ingress</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">annotations</span><span class="kw">:</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">nginx.ingress.kubernetes.io/rewrite-target</span><span class="kw">:</span><span class="at"> /</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ingressClassName</span><span class="kw">:</span><span class="at"> nginx</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">tls</span><span class="kw">:</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">hosts</span><span class="kw">:</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> titanic.kub.sspcloud.fr</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">rules</span><span class="kw">:</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">host</span><span class="kw">:</span><span class="at"> titanic.kub.sspcloud.fr</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">http</span><span class="kw">:</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">paths</span><span class="kw">:</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /</span></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">pathType</span><span class="kw">:</span><span class="at"> Prefix</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">backend</span><span class="kw">:</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">service</span><span class="kw">:</span></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> titanic-service</span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">port</span><span class="kw">:</span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">number</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li><p>Appliquer ces fichiers de configuration sur le cluster : <code>kubectl apply -f deployement/</code></p></li>
<li><p>Si tout a correctement fonctionn√©, vous devriez pouvoir acc√©der √† l‚ÄôAPI √† l‚ÄôURL sp√©cifi√©e dans le fichier <code>deployment/ingress.yaml</code></p></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-56-contents" aria-controls="callout-56" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-56" class="callout-56-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli19</code></pre>
</div>
</div>
</div>
</section>
</section>
<section id="partie-6-un-workflow-complet-de-mlops" class="level1">
<h1>Partie 6: un workflow complet de MLOps</h1>
<p>Ce sera l‚Äôan prochain, d√©sol√© !</p>
</section>
<section id="partie-7-livrer-un-site-web-de-mani√®re-automatis√©e" class="level1">
<h1>Partie 7: livrer un site web de mani√®re automatis√©e</h1>
<p>On va proposer un nouveau livrable pour parler √† un public plus large. Pour cela, on va d√©ployer un site web statique qui permet de visualiser rapidement les r√©sultats du mod√®le.</p>
<p>On propose de cr√©er un site web qui permet de comprendre, avec l‚Äôappui des <a href="https://christophm.github.io/interpretable-ml-book/shapley.html">valeurs de Shapley</a>, les facteurs qui auraient pu nous mettre la puce √† l‚Äôoreille sur les destins de Jake et de Rose.</p>
<p>Pour faire ce site web, on va utiliser <code>Quarto</code> et d√©ployer sur <code>Github Pages</code>. Des √©tapes pr√©liminaires sont r√©alis√©es en <code>Python</code> puis l‚Äôaffichage interactif sera contr√¥l√© par du <code>JavaScript</code> gr√¢ce √† des <a href="https://quarto.org/docs/interactive/ojs/">blocs <code>Observable</code></a>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 19: D√©ploiement automatis√© d‚Äôun site web
</div>
</div>
<div class="callout-body-container callout-body">
<p>Dans un premier temps, on va cr√©er un projet <code>Quarto</code> au sein de notre d√©p√¥t:</p>
<ul>
<li>Installer <code>Quarto</code> dans votre environnement local (s‚Äôil n‚Äôest pas d√©j√† disponible) ;</li>
<li>Dans le projet, utiliser la commande <code>quarto create-project</code> pour initialiser le projet <code>Quarto</code> ;</li>
<li>Supprimer le fichier automatiquement g√©n√©r√© avec l‚Äôextension <code>.qmd</code> ;</li>
<li>R√©cup√©rer le contenu du mod√®le de fichier <code>Quarto Markdown</code> <a href="https://raw.githubusercontent.com/ensae-reproductibilite/application-correction/tree/appli19/index.qmd">cette page</a>. Celui-ci permet de g√©n√©rer la page d‚Äôaccueil de notre site. Enregistrer dans un fichier nomm√© <code>index.qmd</code></li>
</ul>
<p>On teste ensuite la compilation en local du fichier:</p>
<ul>
<li>Modifier le fichier <code>train.py</code> √† partir de <a href="https://raw.githubusercontent.com/ensae-reproductibilite/application-correction/tree/appli19/train.py">cette page</a> pour √™tre en mesure de compiler le fichier</li>
<li>Ex√©cuter le fichier <code>train.py</code></li>
<li>En ligne de commande, faire <code>quarto preview</code> (ajouter les arguments <code>--port 5000 --host 0.0.0.0</code> si vous passez par le <code>SSPCloud</code>)</li>
<li>Observer le site web g√©n√©r√© en local</li>
</ul>
<p>Enfin, on va construire et d√©ployer automatiquement ce site web gr√¢ce au combo <code>Github Actions</code> et <code>Github Pages</code>:</p>
<ul>
<li>Cr√©er une branche <code>gh-pages</code> √† partir du contenu de <a href="https://quarto.org/docs/publishing/github-pages.html">cette page</a></li>
<li>Cr√©er un fichier <code>.github/workflows/website.yaml</code> avec le contenu de <a href="https://raw.githubusercontent.com/ensae-reproductibilite/application-correction/tree/appli19/.github/workflows/publish.yaml">ce fichier</a></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>On doit dans cette application modifier le fichier <code>train.py</code> pour enregistrer en local une duplication du mod√®le de <em>machine learning</em> et de l‚Äôensemble d‚Äôentra√Ænement car pour ces deux √©l√©ments on n‚Äôest pas all√© au bout de la d√©marche MLOps d‚Äôenregistrement dans un <em>model registry</em> et un <em>feature store</em>.</p>
<p>Dans la prochaine version de ce cours, qui int√®grera <code>MLFlow</code>, on aura une d√©marche plus propre car on utilisera bien le mod√®le de production et le jeu d‚Äôentrainement associ√©.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-59-contents" aria-controls="callout-59" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-59" class="callout-59-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli20</code></pre>
</div>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>L‚Äôexport dans un script <code>.py</code> a √©t√© fait directement depuis <code>VSCode</code>. Comme cela n‚Äôest pas vraiment l‚Äôobjet du cours, nous passons cette √©tape et fournissons directement le script expurg√© du texte interm√©diaire. Mais n‚Äôoubliez pas que cette d√©marche, fr√©quente quand on a d√©marr√© sur un <em>notebook</em> et qu‚Äôon d√©sire consolider en faisant la transition vers des scripts, n√©cessite d‚Äô√™tre attentif pour ne pas risquer de faire une erreur.<a href="#fnref1" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn2"><p>Essayez de <em>commit</em> vos changements √† chaque √©tape de l‚Äôexercice, c‚Äôest une bonne habitude √† prendre.<a href="#fnref2" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn3"><p>Ici, le jeton d‚ÄôAPI n‚Äôest pas indispensable pour que le code fonctionne. Afin d‚Äô√©viter une erreur non n√©cessaire lorsqu‚Äôon automatisera le processus, on peut cr√©er une condition qui v√©rifie la pr√©sence ou non de ce fichier. Le script reste donc reproductible m√™me pour un utilisateur n‚Äôayant pas le fichier <code>secrets.yaml</code>.<a href="#fnref3" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn4"><p>Il est normal d‚Äôavoir des dossiers <code>__pycache__</code> qui tra√Ænent en local : ils se cr√©ent automatiquement √† l‚Äôex√©cution d‚Äôun script en <code>Python</code>. N√©anmoins, il ne faut pas associer ces fichiers √† <code>Git</code>, voil√† pourquoi on les ajoute au <code>.gitignore</code>.<a href="#fnref4" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn5"><p>Nous proposons ici d‚Äôadopter le principe de la <strong>programmation fonctionnelle</strong>. Pour encore fiabiliser un processus, il serait possible d‚Äôadopter le paradigme de la <strong>programmation orient√©e objet (POO)</strong>. Celle-ci est plus rebutante et demande plus de temps au d√©veloppeur. L‚Äôarbitrage co√ªt-avantage est n√©gatif pour notre exemple, nous proposons donc de nous en passer. N√©anmoins, pour une mise en production r√©elle d‚Äôun mod√®le, il est recommand√© de l‚Äôadopter. C‚Äôest d‚Äôailleurs obligatoire avec des <a href="https://pythonds.linogaliana.fr/pipeline-scikit/"><em>pipelines</em> <code>scikit</code></a>.<a href="#fnref5" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn6"><p>Au passage vous pouvez noter que mauvaises pratiques discutables, peuvent √™tre corrig√©es, notamment l‚Äôutilisation excessive de <code>apply</code> l√† o√π il serait possible d‚Äôutiliser des m√©thodes embarqu√©es par <code>Pandas</code>. Cela est plut√¥t de l‚Äôordre du bon style de programmation que de la qualit√© formelle du script. Ce n‚Äôest donc pas obligatoire mais c‚Äôest mieux.<a href="#fnref6" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn7"><p>Attention, les donn√©es ont √©t√© <em>committ√©es</em> au moins une fois. Les supprimer du d√©p√¥t ne les efface pas de l‚Äôhistorique. Si cette erreur arrive, le mieux est de supprimer le d√©p√¥t en ligne, cr√©er un nouvel historique <code>Git</code> et partir de celui-ci pour des publications ult√©rieures sur <code>Github</code>. N√©anmoins l‚Äôid√©al serait de ne pas s‚Äôexposer √† cela. C‚Äôest justement l‚Äôobjet des bonnes pratiques de ce cours: un <code>.gitignore</code> bien construit et une s√©paration des environnements de stockage du code et des donn√©es seront bien plus efficaces pour vous √©viter ces probl√®mes que tout les conseils de vigilance que vous pourrez trouver ailleurs.<a href="#fnref7" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn8"><p>Le fichier <code>__init__.py</code> indique √† <code>Python</code> que le dossier est un <em>package</em>. Il permet de proposer certaines configurations lors de l‚Äôimport du <em>package</em>. Il permet √©galement de contr√¥ler les objets export√©s (c‚Äôest-√†-dire mis √† disposition de l‚Äôutilisateur) par le <em>package</em> par rapport aux objets internes au <em>package</em>. En le laissant vide, nous allons utiliser ce fichier pour importer l‚Äôensemble des fonctions de nos sous-modules. Ce n‚Äôest pas la meilleure pratique mais un contr√¥le plus fin des objets export√©s demanderait un investissement qui ne vaut, ici, pas le co√ªt.<a href="#fnref8" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn9"><p>Si vous d√©sirez aussi contr√¥ler la version de <code>Python</code>, ce qui peut √™tre important dans une perspective de portabilit√©, vous pouvez ajouter une option, par exemple <code>-p python3.9</code>.<a href="#fnref9" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn10"><p>Pour comparer les deux listes, vous pouvez utiliser la fonctionnalit√© de <em>split</em> du terminal sur <code>VSCode</code> pour comparer les outputs de <code>conda env export</code> en les mettant en face √† face.<a href="#fnref10" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn11"><p>Il existe une approche alternative pour faire des tests r√©guliers: les <em>hooks</em> <code>Git</code>. Il s‚Äôagit de r√®gles qui doivent √™tre satisfaites pour que le fichier puisse √™tre committ√©. Cela assurera que chaque <code>commit</code> remplisse des crit√®res de qualit√© afin d‚Äô√©viter le probl√®me de la procrastination.</p>
<p>La <a href="https://pylint.pycqa.org/en/latest/user_guide/pre-commit-integration.html">documentation de pylint</a> offre des explications suppl√©mentaires.<a href="#fnref11" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>