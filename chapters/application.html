<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Romain Avouac et Lino Galiana">

<title>Mise en production de projets data science - Appliquer les concepts Ã©tudiÃ©s Ã  un projet de data science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Mise en production de projets data science</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/introduction.html">
 <span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/code-quality.html">
 <span class="menu-text">QualitÃ© du code</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/projects-architecture.html">
 <span class="menu-text">Architecture des projets</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/portability.html">
 <span class="menu-text">PortabilitÃ©</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/deployment.html">
 <span class="menu-text">Mise en production</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../chapters/application.html" aria-current="page">
 <span class="menu-text">Application</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-supplÃ©ments" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">SupplÃ©ments</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-supplÃ©ments">    
        <li>
    <a class="dropdown-item" href="../chapters/application.html">
 <span class="dropdown-text">Linux 101</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/git.html">
 <span class="dropdown-text">Git</span></a>
  </li>  
    </ul>
  </li>
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#partie-1-qualitÃ©-du-script" id="toc-partie-1-qualitÃ©-du-script" class="nav-link active" data-scroll-target="#partie-1-qualitÃ©-du-script">Partie 1 : qualitÃ© du script</a>
  <ul class="collapse">
  <li><a href="#etape-0-forker-le-dÃ©pÃ´t-dexemple-et-crÃ©er-une-branche-de-travail" id="toc-etape-0-forker-le-dÃ©pÃ´t-dexemple-et-crÃ©er-une-branche-de-travail" class="nav-link" data-scroll-target="#etape-0-forker-le-dÃ©pÃ´t-dexemple-et-crÃ©er-une-branche-de-travail">Etape 0: forker le dÃ©pÃ´t dâ€™exemple et crÃ©er une branche de travail</a></li>
  <li><a href="#etape-1-sassurer-que-le-script-sexÃ©cute-correctement" id="toc-etape-1-sassurer-que-le-script-sexÃ©cute-correctement" class="nav-link" data-scroll-target="#etape-1-sassurer-que-le-script-sexÃ©cute-correctement">Etape 1 : sâ€™assurer que le script sâ€™exÃ©cute correctement</a></li>
  <li><a href="#etape-2-utiliser-un-linter-puis-un-formatter" id="toc-etape-2-utiliser-un-linter-puis-un-formatter" class="nav-link" data-scroll-target="#etape-2-utiliser-un-linter-puis-un-formatter">Etape 2: utiliser un <em>linter</em> puis un <em>formatter</em></a></li>
  <li><a href="#etape-3-gestion-des-paramÃ¨tres" id="toc-etape-3-gestion-des-paramÃ¨tres" class="nav-link" data-scroll-target="#etape-3-gestion-des-paramÃ¨tres">Etape 3: gestion des paramÃ¨tres</a></li>
  <li><a href="#etape-4-adopter-la-programmation-fonctionnelle" id="toc-etape-4-adopter-la-programmation-fonctionnelle" class="nav-link" data-scroll-target="#etape-4-adopter-la-programmation-fonctionnelle">Etape 4 : Adopter la programmation fonctionnelle</a></li>
  </ul></li>
  <li><a href="#partie2" id="toc-partie2" class="nav-link" data-scroll-target="#partie2">Partie 2 : adoption dâ€™une structure modulaire</a>
  <ul class="collapse">
  <li><a href="#etape-1-modularisation" id="toc-etape-1-modularisation" class="nav-link" data-scroll-target="#etape-1-modularisation">Etape 1 : modularisation</a></li>
  <li><a href="#etape-2-adopter-une-architecture-standardisÃ©e-de-projet" id="toc-etape-2-adopter-une-architecture-standardisÃ©e-de-projet" class="nav-link" data-scroll-target="#etape-2-adopter-une-architecture-standardisÃ©e-de-projet">Etape 2 : adopter une architecture standardisÃ©e de projet</a>
  <ul class="collapse">
  <li><a href="#etape-3-indiquer-lenvironnement-minimal-de-reproductibilitÃ©" id="toc-etape-3-indiquer-lenvironnement-minimal-de-reproductibilitÃ©" class="nav-link" data-scroll-target="#etape-3-indiquer-lenvironnement-minimal-de-reproductibilitÃ©">Etape 3: indiquer lâ€™environnement minimal de reproductibilitÃ©</a></li>
  </ul></li>
  <li><a href="#stockageS3" id="toc-stockageS3" class="nav-link" data-scroll-target="#stockageS3">Etape 4 : stocker les donnÃ©es de maniÃ¨re externe</a></li>
  </ul></li>
  <li><a href="#partie3" id="toc-partie3" class="nav-link" data-scroll-target="#partie3">Partie 2 : construction dâ€™un projet portable et reproductible</a>
  <ul class="collapse">
  <li><a href="#configyaml" id="toc-configyaml" class="nav-link" data-scroll-target="#configyaml">Etape 1: crÃ©er un rÃ©pertoire de variables servant dâ€™input</a>
  <ul class="collapse">
  <li><a href="#enjeu" id="toc-enjeu" class="nav-link" data-scroll-target="#enjeu">Enjeu</a></li>
  <li><a href="#application" id="toc-application" class="nav-link" data-scroll-target="#application">Application</a></li>
  </ul></li>
  <li><a href="#anaconda" id="toc-anaconda" class="nav-link" data-scroll-target="#anaconda">Etape 2 : crÃ©er un environnement conda Ã  partir du fichier <code>environment.yml</code></a></li>
  <li><a href="#docker" id="toc-docker" class="nav-link" data-scroll-target="#docker">Etape 3: conteneuriser avec Docker <i class="fab fa-docker"></i></a>
  <ul class="collapse">
  <li><a href="#prÃ©liminaire" id="toc-prÃ©liminaire" class="nav-link" data-scroll-target="#prÃ©liminaire">PrÃ©liminaire</a></li>
  <li><a href="#crÃ©ation-dun-premier-dockerfile" id="toc-crÃ©ation-dun-premier-dockerfile" class="nav-link" data-scroll-target="#crÃ©ation-dun-premier-dockerfile">CrÃ©ation dâ€™un premier Dockerfile</a></li>
  <li><a href="#construire-limage" id="toc-construire-limage" class="nav-link" data-scroll-target="#construire-limage">Construire lâ€™image</a></li>
  <li><a href="#tester-limage-dÃ©couverte-du-cache" id="toc-tester-limage-dÃ©couverte-du-cache" class="nav-link" data-scroll-target="#tester-limage-dÃ©couverte-du-cache">Tester lâ€™image: dÃ©couverte du cache</a></li>
  <li><a href="#corriger-une-faille-de-reproductibilitÃ©" id="toc-corriger-une-faille-de-reproductibilitÃ©" class="nav-link" data-scroll-target="#corriger-une-faille-de-reproductibilitÃ©">Corriger une faille de reproductibilitÃ©</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#partie-3-mise-en-production" id="toc-partie-3-mise-en-production" class="nav-link" data-scroll-target="#partie-3-mise-en-production">Partie 3 : mise en production</a>
  <ul class="collapse">
  <li><a href="#etape-prÃ©liminaire" id="toc-etape-prÃ©liminaire" class="nav-link" data-scroll-target="#etape-prÃ©liminaire">Etape prÃ©liminaire</a></li>
  <li><a href="#etape-1-mise-en-place-de-tests-automatisÃ©s" id="toc-etape-1-mise-en-place-de-tests-automatisÃ©s" class="nav-link" data-scroll-target="#etape-1-mise-en-place-de-tests-automatisÃ©s">Etape 1: mise en place de tests automatisÃ©s</a></li>
  <li><a href="#etape-2-automatisation-de-la-livraison-de-limage-docker" id="toc-etape-2-automatisation-de-la-livraison-de-limage-docker" class="nav-link" data-scroll-target="#etape-2-automatisation-de-la-livraison-de-limage-docker">Etape 2: Automatisation de la livraison de lâ€™image <code>Docker</code></a></li>
  <li><a href="#etape-3-crÃ©ation-dun-rapport-automatique" id="toc-etape-3-crÃ©ation-dun-rapport-automatique" class="nav-link" data-scroll-target="#etape-3-crÃ©ation-dun-rapport-automatique">Etape 3: crÃ©ation dâ€™un rapport automatique</a>
  <ul class="collapse">
  <li><a href="#rapport-minimal-en-local" id="toc-rapport-minimal-en-local" class="nav-link" data-scroll-target="#rapport-minimal-en-local">1. Rapport minimal en local</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#feature-importance" id="toc-feature-importance" class="nav-link" data-scroll-target="#feature-importance">Feature importance</a></li>
  <li><a href="#qualitÃ©-prÃ©dictive-du-modÃ¨le" id="toc-qualitÃ©-prÃ©dictive-du-modÃ¨le" class="nav-link" data-scroll-target="#qualitÃ©-prÃ©dictive-du-modÃ¨le">QualitÃ© prÃ©dictive du modÃ¨le</a>
  <ul class="collapse">
  <li><a href="#enrichir-limage-docker" id="toc-enrichir-limage-docker" class="nav-link" data-scroll-target="#enrichir-limage-docker">3. Enrichir lâ€™image <code>Docker</code></a></li>
  <li><a href="#automatisation-avec-github-actions" id="toc-automatisation-avec-github-actions" class="nav-link" data-scroll-target="#automatisation-avec-github-actions">4. Automatisation avec <code>Github Actions</code></a></li>
  <li><a href="#etape-4-dÃ©ploiement-de-ce-rapport-automatique-sur-le-web" id="toc-etape-4-dÃ©ploiement-de-ce-rapport-automatique-sur-le-web" class="nav-link" data-scroll-target="#etape-4-dÃ©ploiement-de-ce-rapport-automatique-sur-le-web">Etape 4: DÃ©ploiement de ce rapport automatique sur le web</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Appliquer les concepts Ã©tudiÃ©s Ã  un projet de data science</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Romain Avouac et Lino Galiana </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<p>Lâ€™objectif de cette mise en application est dâ€™<strong>illustrer les diffÃ©rentes Ã©tapes qui sÃ©parent la phase de dÃ©veloppement dâ€™un projet de celle de la mise en production</strong>. Elle permettra de mettre en pratique les diffÃ©rents concepts prÃ©sentÃ©s tout au long du cours.</p>
<p>Nous nous plaÃ§ons dans une situation initiale correspondant Ã  la fin de la phase de dÃ©veloppement dâ€™un projet de data science. On a un notebook un peu monolithique, qui rÃ©alise les Ã©tapes classiques dâ€™un <em>pipeline</em> de <em>machine learning</em> :</p>
<ul>
<li>Import de donnÃ©es ;</li>
<li>Statistiques descriptives et visualisations ;</li>
<li><em>Feature engineering</em> ;</li>
<li>EntraÃ®nement dâ€™un modÃ¨le ;</li>
<li>Evaluation du modÃ¨le</li>
</ul>
<p><strong>Lâ€™objectif est dâ€™amÃ©liorer le projet de maniÃ¨re incrÃ©mentale jusquâ€™Ã  pouvoir le mettre en production, en le valorisant sous une forme adaptÃ©e.</strong></p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Il est important de bien lire les consignes et dâ€™y aller progressivement. Certaines Ã©tapes peuvent Ãªtre rapides, dâ€™autres plus fastidieuses ; certaines Ãªtre assez guidÃ©es, dâ€™autres vous laisser plus de libertÃ©. Si vous nâ€™effectuez pas une Ã©tape, vous risquez de ne pas pouvoir passer Ã  lâ€™Ã©tape suivante qui en dÃ©pend.</p>
<p>Bien que lâ€™exercice soit applicable sur toute configuration bien faite, nous recommandons de privilÃ©gier lâ€™utilisation du <a href="https://datalab.sspcloud.fr/home">SSP Cloud</a>, oÃ¹ tous les outils nÃ©cessaires sont prÃ©-installÃ©s et prÃ©-configurÃ©s.</p>
</div>
</div>
<section id="partie-1-qualitÃ©-du-script" class="level1">
<h1>Partie 1 : qualitÃ© du script</h1>
<p>Cette premiÃ¨re partie vise Ã  <strong>rendre le projet conforme aux bonnes pratiques</strong> prÃ©sentÃ©es dans le cours.</p>
<p>Elle fait intervenir les notions suivantes :</p>
<ul>
<li>Utilisation du <strong>terminal</strong> (voir <a href="../chapters/linux-101.html">Linux 101</a>) ;</li>
<li><strong>QualitÃ© du code</strong> (voir <a href="../chapters/code-quality.html">QualitÃ© du code</a>) ;</li>
<li><strong>Architecture de projets</strong> (voir <a href="../chapters/projects-architecture.html">Architecture des projets</a>) ;</li>
<li><strong>ContrÃ´le de version</strong> avec <code>Git</code> (voir <a href="../chapters/git.html">Rappels <code>Git</code></a>) ;</li>
<li><strong>Travail collaboratif</strong> avec <code>Git</code> et <code>GitHub</code> (voir <a href="../chapters/git.html">Rappels <code>Git</code></a>).</li>
</ul>
<p>Le plan de la partie est le suivant :</p>
<!----
0. :zero: _Forker_ le dÃ©pÃ´t et crÃ©er une branche de travail
1. :one: S'assurer que le _notebook_ s'exÃ©cute correctement
2. :two: Modularisation : mise en fonctions et mise en module
3. :three: Utiliser un `main` script
4. :four:  Appliquer les standards de qualitÃ© de code
5. :five: Adopter une architecture standardisÃ©e de projet
6. :six: Fixer l'environnement d'exÃ©cution
7. :seven: Stocker les donnÃ©es de maniÃ¨re externe
8. :eight: Nettoyer le projet `Git`
9. :nine: Ouvrir une *pull request* sur le dÃ©pÃ´t du projet.
------------->
<p>Nous allons partir de ce <em>Notebook</em> <code>Jupyter</code>, que vous pouvez prÃ©visualiser voire tester en cliquant sur lâ€™un des liens suivants:</p>
<p><a href="https://datalab.sspcloud.fr/launcher/ide/jupyter-python?autoLaunch=false&amp;init.personalInit=%C2%ABhttps%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fensae-reproductibilite-website%2Fmaster%2Fpreview-notebook.sh%C2%BB" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/SSPcloud-Tester%20notebook%20sur%20SSP--cloud-informational&amp;color=yellow?logo=Python" alt="Onyxia"></a> <a href="http://colab.research.google.com/github/linogaliana/ensae-reproductibilite-application/blob/main/titanic.ipynb" target="_blank" rel="noopener"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<section id="etape-0-forker-le-dÃ©pÃ´t-dexemple-et-crÃ©er-une-branche-de-travail" class="level2">
<h2 class="anchored" data-anchor-id="etape-0-forker-le-dÃ©pÃ´t-dexemple-et-crÃ©er-une-branche-de-travail">Etape 0: forker le dÃ©pÃ´t dâ€™exemple et crÃ©er une branche de travail</h2>
<ul>
<li><p>Ouvrir un service <code>VSCode</code> sur le <a href="https://datalab.sspcloud.fr/home">SSP Cloud</a>. Vous pouvez aller dans la page <code>My Services</code> et cliquer sur <code>New service</code>. Sinon, vous pouvez lancer le service en cliquant directement <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?autoLaunch=false">ici</a>.</p></li>
<li><p>GÃ©nÃ©rer un jeton dâ€™accÃ¨s (<em>token</em>) sur <code>GitHub</code> afin de permettre lâ€™authentification en ligne de commande Ã  votre compte. La procÃ©dure est dÃ©crite <a href="https://docs.sspcloud.fr/onyxia-guide/controle-de-version#creer-un-jeton-dacces-token">ici</a>. Garder le jeton gÃ©nÃ©rÃ© de cÃ´tÃ©.</p></li>
<li><p>Forker le dÃ©pÃ´t <code>Github</code> : https://github.com/linogaliana/ensae-reproductibilite-application</p></li>
<li><p>ClÃ´ner <strong>votre</strong> dÃ©pÃ´t <code>Github</code> en utilisant le terminal depuis <code>Visual Studio</code> (<code>Terminal &gt; New Terminal</code>) :</p></li>
</ul>
<pre class="shell"><code>$ git clone https://&lt;TOKEN&gt;@github.com/&lt;USERNAME&gt;/ensae-reproductibilite-application.git</code></pre>
<p>oÃ¹ <code>&lt;TOKEN&gt;</code> et <code>&lt;USERNAME&gt;</code> sont Ã  remplacer, respectivement, par le jeton que vous avez gÃ©nÃ©rÃ© prÃ©cÃ©demment et votre nom dâ€™utilisateur.</p>
<ul>
<li>Se placer avec le terminal dans le dossier en question :</li>
</ul>
<pre class="shell"><code>$ cd ensae-reproductibilite-application</code></pre>
<ul>
<li>CrÃ©ez une branche <code>nettoyage</code> :</li>
</ul>
<pre class="shell"><code>$ git checkout -b nettoyage
Switched to a new branch 'nettoyage'</code></pre>
</section>
<section id="etape-1-sassurer-que-le-script-sexÃ©cute-correctement" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-sassurer-que-le-script-sexÃ©cute-correctement">Etape 1 : sâ€™assurer que le script sâ€™exÃ©cute correctement</h2>
<p>On va partir du fichier <code>notebook.py</code> qui reprend le contenu du <em>notebook</em><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> mais dans un script classique.</p>
<p>La premiÃ¨re Ã©tape est simple, mais souvent oubliÃ©e : <strong>vÃ©rifier que le code fonctionne correctement</strong>.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 1: corriger les erreurs
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Ouvrir dans <code>VSCode</code> le script <code>titanic.py</code> ;</li>
<li>ExÃ©cuter le script ligne Ã  ligne pour dÃ©tecter les erreurs ;</li>
<li>Corriger les deux erreurs qui empÃªchent la bonne exÃ©cution ;</li>
<li>VÃ©rifier le fonctionnement du script en utilisant la ligne de commande</li>
</ul>
<pre class="shell"><code>python titanic.py</code></pre>
</div>
</div>
<p>Il est maintenant temps de <em>commit</em> les changements effectuÃ©s avec <code>Git</code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> :</p>
<pre class="shell"><code>$ git add titanic.py
$ git commit -m "Corrige l'erreur qui empÃªchait l'exÃ©cution"
$ git push</code></pre>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application1/titanic.py">Script <em>checkpoint</em></a></p>
</div>
</div>
</div>
</section>
<section id="etape-2-utiliser-un-linter-puis-un-formatter" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-utiliser-un-linter-puis-un-formatter">Etape 2: utiliser un <em>linter</em> puis un <em>formatter</em></h2>
<p>On va maintenant amÃ©liorer la qualitÃ© de notre code en appliquant les standards communautaires. Pour cela, on va utiliser le <em>linter</em> classique <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a>.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Nâ€™hÃ©sitez pas Ã  taper un code dâ€™erreur sur un moteur de recherche pour obtenir plus dâ€™informations si jamais le message nâ€™est pas clair !</p>
</div>
</div>
<p>Pour appliquer le <em>linter</em> Ã  un script <code>.py</code>, la syntaxe Ã  entrer dans le terminal est la suivante :</p>
<pre class="shell"><code>$ pylint mon_script.py</code></pre>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a> sont des <em>packages</em> <code>Python</code> qui sâ€™utilisent principalement en ligne de commande.</p>
<p>Si vous avez une erreur qui suggÃ¨re que votre terminal ne connait pas <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> ou <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a>, nâ€™oubliez pas dâ€™exÃ©cuter la commande <code>pip install pylint</code> ou <code>pip install black</code>.</p>
</div>
</div>
<p>Le <em>linter</em> renvoie alors une sÃ©rie dâ€™irrÃ©gularitÃ©s, en prÃ©cisant Ã  chaque fois la ligne de lâ€™erreur et le message dâ€™erreur associÃ© (ex : mauvaise identation). Il renvoie finalement une note sur 10, qui estime la qualitÃ© du code Ã  lâ€™aune des standards communautaires Ã©voquÃ©s dans la partie <a href="../chapters/code-quality.html">QualitÃ© du code</a>.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 2: rendre lisible le script
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Diagnostiquer et Ã©valuer la qualitÃ© de <code>titanic.py</code> avec <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a>. Regarder la note obtenue.</li>
<li>Utiliser <code>black titanic.py --diff --color</code> pour observer les changements de forme que va induire lâ€™utilisation du <em>formatter</em> <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a></li>
<li>Appliquer le <em>formatter</em> <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a></li>
<li>RÃ©utiliser <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> pour diagnostiquer lâ€™amÃ©lioration de la qualitÃ© du script et le travail qui reste Ã  faire.</li>
<li>Comme la majoritÃ© du travail restant est Ã  consacrer aux imports:
<ul>
<li>Mettre tous les <em>imports</em> ensemble en dÃ©but de script</li>
<li>Retirer les <em>imports</em> redondants en sâ€™aidant des diagnostics de votre Ã©diteur</li>
<li>RÃ©ordonner les <em>imports</em> si <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> vous indique de le faire</li>
<li>Corriger les derniÃ¨res fautes formelles suggÃ©rÃ©es par <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a></li>
</ul></li>
<li>DÃ©limiter des parties dans votre code pour rendre sa structure plus lisible</li>
</ul>
</div>
</div>
<p>Le code est maintenant lisible, il obtient Ã  ce stade une note formelle proche de 10. Mais il nâ€™est pas encore totalement intelligible ou fiable. Il y a notamment beaucoup de redondance de code auxquelles nous allons nous attaquer par la suite. NÃ©anmoins, avant cela, occupons-nous de mieux gÃ©rer certains paramÃ¨tres du script: jetons dâ€™API et chemin des fichiers.</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application2/titanic.py"><code>titanic.py</code></a></p>
</div>
</div>
</div>
</section>
<section id="etape-3-gestion-des-paramÃ¨tres" class="level2">
<h2 class="anchored" data-anchor-id="etape-3-gestion-des-paramÃ¨tres">Etape 3: gestion des paramÃ¨tres</h2>
<p>Lâ€™exÃ©cution du code et les rÃ©sultats obtenus dÃ©pendent de certains paramÃ¨tres. Lâ€™Ã©tude de rÃ©sultats alternatifs, en jouant sur des variantes des paramÃ¨tres, est Ã  ce stade compliquÃ©e car il est nÃ©cessaire de parcourir le code pour trouver ces paramÃ¨tres. De plus, certains paramÃ¨tres personnels comme des jetons dâ€™API ou des mots de passe nâ€™ont pas vocation Ã  Ãªtre prÃ©sents dans le code.</p>
<p>Il est plus judicieux de considÃ©rer ces paramÃ¨tres comme des variables dâ€™entrÃ©e du script. Cela peut Ãªtre fait de deux maniÃ¨res:</p>
<ol type="1">
<li>Avec des arguments optionnels appelÃ©s depuis la ligne de commande. Cela peut Ãªtre pratique pour mettre en oeuvre des tests automatisÃ©s<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> mais nâ€™est pas forcÃ©ment pertinent pour toutes les variables. Nous allons montrer cet usage avec le nombre dâ€™arbres de notre <em>random forest</em> ;</li>
<li>En utilisant un fichier de configuration dont les valeurs sont importÃ©es dans le script principal. Nous allons le mettre en oeuvre pour deux types de fichiers: les Ã©lÃ©ments de configuration Ã  partager et ceux Ã  conserver pour soi mais pouvant servir.</li>
</ol>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 3: ParamÃ©trisation du script
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>En sâ€™inspirant de <a href="https://stackoverflow.com/a/69377311/9197726">cette rÃ©ponse</a>, crÃ©er une variable <code>n_trees</code> qui peut Ã©ventuellement Ãªtre paramÃ©trÃ©e en ligne de commande et dont la valeur par dÃ©faut est 20.</li>
<li>Tester cette paramÃ©trisation en ligne de commande avec la valeur par dÃ©faut puis 2, 10 et 50 arbres</li>
<li>RepÃ©rer le jeton dâ€™API dans le code. Retirer le jeton dâ€™API du code et crÃ©er Ã  la racine du projet un fichier YAML nommÃ© <code>secrets.yaml</code> oÃ¹ vous Ã©crivez ce secret sous la forme <code>key: value</code></li>
<li>Pour Ã©viter dâ€™avoir Ã  le faire plus tard, crÃ©er une fonction <code>import_yaml_config</code> qui prend en argument le chemin dâ€™un fichier <code>YAML</code> et renvoie le contenu de celui-ci en <em>output</em>. Vous pouvez suivre le conseil du chapitre sur la <a href="../chapters/code-quality.html">QualitÃ© du code</a> en adoptant le <em>type hinting</em>.</li>
<li>CrÃ©er la variable <code>API_TOKEN</code> ayant la valeur stockÃ©e dans <code>secrets.yaml</code><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</li>
<li>Tester en ligne de commande que lâ€™exÃ©cution du fichier est toujours sans erreur</li>
<li>Refaire un diagnostic avec <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et corriger les Ã©ventuels messages.</li>
<li>CrÃ©er un fichier <code>config.yaml</code> stockant trois informations: le chemin des donnÃ©es dâ€™entraÃ®nement, des donnÃ©es de test et la rÃ©partition train/test utilisÃ©e dans le code. CrÃ©er les variables correspondantes dans le code aprÃ¨s avoir utilisÃ© <code>import_yaml_config</code></li>
<li>CrÃ©er un fichier <code>.gitignore</code>. Ajouter dans ce fichier <code>secrets.yaml</code> car il ne faut pas committer ce fichier.</li>
<li>CrÃ©er un fichier <code>README.md</code> oÃ¹ vous indiquez quâ€™il faut crÃ©er un fichier <code>secrets.yaml</code> pour pouvoir utiliser lâ€™API.</li>
</ol>
<details>
<summary>
Indice si vous ne trouvez pas comment lire un fichier <code>YAML</code>
</summary>
<p>Si le fichier sâ€™appelle <code>toto.yaml</code>, vous pouvez lâ€™importer de cette maniÃ¨re:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"toto.yaml"</span>, <span class="st">"r"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> stream:</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    dict_config <span class="op">=</span> yaml.safe_load(stream)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/titanic.py"><code>titanic.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/readme.md"><code>README.md</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/config.yaml"><code>config.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/secrets.yaml"><code>secrets.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/.gitignore"><code>.gitignore</code></a></li>
</ul>
</div>
</div>
</div>
</section>
<section id="etape-4-adopter-la-programmation-fonctionnelle" class="level2">
<h2 class="anchored" data-anchor-id="etape-4-adopter-la-programmation-fonctionnelle">Etape 4 : Adopter la programmation fonctionnelle</h2>
<p>Nous allons <strong>mettre en fonctions les parties importantes de lâ€™analyse, et les mettre dans un module afin de pouvoir les importer directement depuis le notebook</strong>.</p>
<p>Cet exercice Ã©tant chronophage, il nâ€™est <strong>pas obligatoire de le rÃ©aliser en entier</strong>. Lâ€™important est de comprendre la dÃ©marche et dâ€™adopter frÃ©quemment une approche fonctionnelle<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. Pour obtenir une chaine entiÃ¨rement fonctionnalisÃ©e, vous pouvez reprendre le <em>checkpoint</em>.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 4: adoption des standards de programmation fonctionnelle
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>CrÃ©er une fonction qui importe les donnÃ©es dâ€™entraÃ®nement (<code>train.csv</code>) et de test (<code>test.csv</code>) et renvoie des <code>DataFrames</code> <code>Pandas</code> ;</li>
<li>En fonction du temps disponible, crÃ©er plusieurs fonctions pour rÃ©aliser les Ã©tapes de <em>feature engineering</em>:
<ul>
<li>La crÃ©ation de la variable <em>â€œTitleâ€</em> peut Ãªtre automatisÃ©e en vertu du principe <em>â€œdo not repeat yourselfâ€</em><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</li>
<li>Regrouper ensemble les <code>fillna</code> et essayer de crÃ©er une fonction gÃ©nÃ©ralisant lâ€™opÃ©ration.</li>
<li>Les <em>label encoders</em> peuvent Ãªtre transformÃ©s en deux fonctions: une premiÃ¨re pour encoder une colonne puis une seconde qui utilise la premiÃ¨re de maniÃ¨re rÃ©pÃ©tÃ©e pour encoder plusieurs colonnes. <em>Remarquez les erreurs de copier-coller que cela corrige</em></li>
<li>Finaliser les derniÃ¨res transformations avec des fonctions</li>
</ul></li>
<li>CrÃ©er une fonction qui rÃ©alise le <em>split train/test</em> de validation en fonction dâ€™un paramÃ¨tre reprÃ©sentant la proportion de lâ€™Ã©chantillon de test.</li>
<li>CrÃ©er une fonction qui entraÃ®ne et Ã©value un classifieur <code>RandomForest</code>, et qui prend en paramÃ¨tre le nombre dâ€™arbres (<code>n_estimators</code>). La fonction doit imprimer Ã  la fin la performance obtenue et la matrice de confusion.</li>
<li>DÃ©placer toutes les fonctions ensemble, en dÃ©but de script. <!----- plus tard ?
- Mettre ces fonctions dans un module `functions.py`
- importer les fonctions via le module dans le notebook et vÃ©rifier que l'on retrouve bien les diffÃ©rents rÃ©sultats en utilisant les fonctions.
-------></li>
</ul>
</div>
</div>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Le fait dâ€™appliquer des fonctions a dÃ©jÃ  amÃ©liorÃ© la fiabilitÃ© du processus en rÃ©duisant le nombre dâ€™erreurs de copier-coller. NÃ©anmoins, pour vraiment fiabiliser le processus, il faudrait utiliser un <em>pipeline</em> de transformations de donnÃ©es.</p>
<p>Ceci nâ€™est pas encore au programme du cours mais le sera dans une prochaine version.</p>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application4/titanic.py"><code>titanic.py</code></a></li>
</ul>
<p>Les autres fichiers inchangÃ©s:</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/readme.md"><code>README.md</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/config.yaml"><code>config.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/secrets.yaml"><code>secrets.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/.gitignore"><code>.gitignore</code></a></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="partie2" class="level1">
<h1>Partie 2 : adoption dâ€™une structure modulaire</h1>
<p>Dans la partie prÃ©cÃ©dente, on a appliquÃ© de maniÃ¨re incrÃ©mentale de nombreuses bonnes pratiques vues tout au long du cours. Ce faisant, on sâ€™est dÃ©jÃ  considÃ©rablement rapprochÃ©s dâ€™un possible partage du code : celui-ci est lisible et intelligible. Le code est proprement versionnÃ© sur un dÃ©pÃ´t <code>GitHub</code>.</p>
<p>NÃ©anmoins, la structure du projet nâ€™est pas encore normalisÃ©e. De plus, lâ€™adoption dâ€™une structure plus modulaire facilitera la comprÃ©hension de la chaine de traitement.</p>
<section id="etape-1-modularisation" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-modularisation">Etape 1 : modularisation</h2>
<p>Fini le temps de lâ€™expÃ©rimentation : on va maintenant essayer de se passer complÃ¨tement du <em>notebook</em>. Pour cela, on va utiliser un <code>main</code> script, câ€™est Ã  dire un script qui reproduit lâ€™analyse en important et en exÃ©cutant les diffÃ©rentes fonctions dans lâ€™ordre attendu.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 5: modularisation
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>DÃ©placer les fonctions dans une sÃ©rie de fichiers dÃ©diÃ©s:
<ul>
<li><code>import_data.py</code>: fonctions dâ€™import de donnÃ©es</li>
<li><code>build_features.py</code>: fonctions regroupant les Ã©tapes de <em>feature engineering</em></li>
<li><code>train_evaluate.py</code>: fonctions dâ€™entrainement et dâ€™Ã©valuation du modÃ¨le</li>
</ul></li>
<li>SpÃ©cifier les dÃ©pendances (i.e.&nbsp;les packages Ã  importer) dans les modules pour que ceux-ci puissent sâ€™exÃ©cuter indÃ©pendamment ;</li>
<li>Renommer <code>titanic.py</code> en <code>main.py</code> pour suivre la convention de nommage des projets <code>Python</code> ;</li>
<li>Importer les fonctions nÃ©cessaires Ã  partir des modules. âš ï¸ Ne pas utiliser <code>from XXX import *</code>, ce nâ€™est pas une bonne pratique !</li>
<li>VÃ©rifier que tout fonctionne bien en exÃ©cutant le <em>script</em> <code>main</code> Ã  partir de la ligne de commande :</li>
</ul>
<pre class="shell"><code>$ python main.py</code></pre>
</div>
</div>
<p>On dispose maintenant dâ€™une application <code>Python</code> fonctionnelle. NÃ©anmoins, le projet est certes plus fiable mais sa structuration laisse Ã  dÃ©sirer et il serait difficile de rentrer Ã  nouveau dans le projet dans quelques temps.</p>
<details>
<summary>
Etat actuel du projet ğŸ™ˆ
</summary>
<pre class="shell"><code>â”œâ”€â”€ README.md
â”œâ”€â”€ train.csv
â”œâ”€â”€ test.csv
â”œâ”€â”€ .gitignore
â”œâ”€â”€ config.yaml
â”œâ”€â”€ secrets.yaml
â”œâ”€â”€ import_data.py
â”œâ”€â”€ build_features.py
â”œâ”€â”€ train_evaluate.py
â””â”€â”€main.py</code></pre>
</details>
<p>Comme cela est expliquÃ© dans la partie <a href="../chapters/projects-architecture.html">Structure des projets</a>, on va adopter une structure certes arbitraire mais qui va faciliter lâ€™autodocumentation de notre projet.</p>
<p>De plus, une telle structure va faciliter des Ã©volutions optionnelles comme la packagisation du projet. Passer dâ€™une structure modulaire bien faite Ã  un <em>package</em> est quasi-immÃ©diat en <code>Python</code>.</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/build_features.py"><code>build_features.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/import_data.py"><code>import_data.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/train_evaluate.py"><code>train_evaluate.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/main.py"><code>main.py</code></a></li>
</ul>
<p>Les autres fichiers inchangÃ©s:</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/readme.md"><code>README.md</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/config.yaml"><code>config.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/secrets.yaml"><code>secrets.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/.gitignore"><code>.gitignore</code></a></li>
</ul>
</div>
</div>
</div>
</section>
<section id="etape-2-adopter-une-architecture-standardisÃ©e-de-projet" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-adopter-une-architecture-standardisÃ©e-de-projet">Etape 2 : adopter une architecture standardisÃ©e de projet</h2>
<p>On va maintenant modifier lâ€™architecture de notre projet pour la rendre plus standardisÃ©e. Pour cela, on va sâ€™inspirer des structures <a href="https://cookiecutter.readthedocs.io/en/stable/"><code>cookiecutter</code></a> qui gÃ©nÃ¨rent des <em>templates</em> de projet.</p>
<p>On va sâ€™inspirer de la structure du <a href="https://drivendata.github.io/cookiecutter-data-science/"><em>template datascience</em></a> dÃ©veloppÃ© par la communautÃ©.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Lâ€™idÃ©e de <a href="https://cookiecutter.readthedocs.io/en/stable/"><code>cookiecutter</code></a> est de proposer des <em>templates</em> que lâ€™on utilise pour <strong>initialiser</strong> un projet, afin de bÃ¢tir Ã  lâ€™avance une structure Ã©volutive. La syntaxe Ã  utiliser dans ce cas est la suivante :</p>
<pre class="shell"><code>$ pip install cookiecutter
$ cookiecutter https://github.com/drivendata/cookiecutter-data-science</code></pre>
<p>Ici, on a dÃ©jÃ  un projet, on va donc faire les choses dans lâ€™autre sens : on va sâ€™inspirer de la structure proposÃ©e afin de rÃ©organiser celle de notre projet selon les standards communautaires.</p>
</div>
</div>
<p>En sâ€™inspirant du <em>cookiecutter data science</em> on va adopter la structure suivante:</p>
<pre class="shell"><code>ensae-reproductibilite-application
â”œâ”€â”€ main.py
â”œâ”€â”€ README.md
â”œâ”€â”€ data
â”‚   â””â”€â”€ raw
â”‚       â”œâ”€â”€ test.csv
â”‚       â””â”€â”€ train.csv
â”œâ”€â”€ configuration
â”‚   â”œâ”€â”€ secrets.yaml
â”‚   â””â”€â”€ config.yaml
â”œâ”€â”€ notebooks
â”‚   â””â”€â”€ titanic.ipynb
â””â”€â”€ src
    â”œâ”€â”€ data
    â”‚   â””â”€â”€ import_data.py
    â”œâ”€â”€ features
    â”‚   â””â”€â”€ build_features.py
    â””â”€â”€ models
        â””â”€â”€ train_evaluate.py</code></pre>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 6: adopter une structure lisible
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><em>(optionnel)</em> Analyser et comprendre la <a href="https://drivendata.github.io/cookiecutter-data-science/#directory-structure">structure de projet</a> proposÃ©e par le template</li>
<li>Modifier lâ€™arborescence du projet selon le modÃ¨le</li>
<li>Adapter les scripts et les fichiers de configuration Ã  la nouvelle arborescence</li>
<li>Ajouter le dossier <strong>pycache</strong> au <code>.gitignore</code><a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> et le dossier <code>data</code></li>
</ul>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/build_features.py"><code>build_features.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/import_data.py"><code>import_data.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/train_evaluate.py"><code>train_evaluate.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/main.py"><code>main.py</code></a></li>
</ul>
<p>Les autres fichiers sont inchangÃ©s, Ã  lâ€™exception de leur emplacement.</p>
</div>
</div>
</div>
<section id="etape-3-indiquer-lenvironnement-minimal-de-reproductibilitÃ©" class="level3">
<h3 class="anchored" data-anchor-id="etape-3-indiquer-lenvironnement-minimal-de-reproductibilitÃ©">Etape 3: indiquer lâ€™environnement minimal de reproductibilitÃ©</h3>
<p>Le script <code>main.py</code> nÃ©cessite un certain nombre de packages pour Ãªtre fonctionnel. Chez vous les packages nÃ©cessaires sont bien sÃ»r installÃ©s mais Ãªtes-vous assurÃ© que câ€™est le cas chez la personne qui testera votre code ?</p>
<p>Afin de favoriser la portabilitÃ© du projet, il est dâ€™usage de <em>â€œfixer lâ€™environnementâ€</em>, câ€™est-Ã -dire dâ€™indiquer dans un fichier toutes les dÃ©pendances utilisÃ©es ainsi que leurs version. Nous proposons de crÃ©er un fichier <code>requirements.txt</code> minimal, sur lequel nous reviendrons dans la partie consacrÃ©e aux environnements reproductibles.</p>
<p>Le fichier <code>requirements.txt</code> est conventionnellement localisÃ© Ã  la racine du projet. Ici on ne va pas fixer les versions, on raffinera ce fichier plus tard.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 7: crÃ©ation du <code>requirements.txt</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>CrÃ©er un fichier <code>requirements.txt</code> avec la liste des packages nÃ©cessaires</li>
<li>Ajouter une indication dans <code>README.md</code> sur lâ€™installation des <em>packages</em> grÃ¢ce au fichier <code>requirements.txt</code></li>
</ul>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-19-contents" aria-controls="callout-19" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-19" class="callout-19-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application7/requirements.txt"><code>requirements.txt</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application7/README.md"><code>README.md</code></a></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="stockageS3" class="level2">
<h2 class="anchored" data-anchor-id="stockageS3">Etape 4 : stocker les donnÃ©es de maniÃ¨re externe</h2>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour mettre en oeuvre cette Ã©tape, il peut Ãªtre utile de comprendre un peu comme fonctionne le SSP Cloud. Vous devrez suivre la <a href="https://docs.sspcloud.fr/onyxia-guide/stockage-de-donnees">documentation du SSP Cloud</a> pour la rÃ©aliser. Une aide-mÃ©moire est Ã©galement disponible dans le cours de 2e annÃ©e de lâ€™ENSAE <a href="https://linogaliana-teaching.netlify.app/reads3/#">Python pour la data science</a></p>
</div>
</div>
<p>Comme on lâ€™a vu dans le cours (<a href="../chapters/project-structure.html">partie structure des projets</a>), les donnÃ©es ne sont pas censÃ©es Ãªtre versionnÃ©es sur un projet <code>Git</code>.</p>
<p>Lâ€™idÃ©al pour Ã©viter cela tout en maintenant la reproductibilitÃ© est dâ€™utiliser une solution de stockage externe. On va utiliser pour cela <code>MinIO</code>, la solution de stockage de type <code>S3</code> offerte par le SSP Cloud.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Application 8: utilisation dâ€™un systÃ¨me de stockage distant
</div>
</div>
<div class="callout-body-container callout-body">
<p>A partir de la ligne de commande, utiliser lâ€™utilitaire <a href="https://min.io/docs/minio/linux/reference/minio-mc.html">MinIO</a> pour copier les donnÃ©es <code>data/raw/train.csv</code> et <code>data/raw/test.csv</code> vers votre bucket personnel, respectivement dans les dossiers <code>ensae-reproductibilite/data/raw/train.csv</code> et <code>ensae-reproductibilite/data/raw/test.csv</code>.</p>
<details>
<summary>
Indice
</summary>
<p>Structure Ã  adopter:</p>
<pre class="shell"><code>$ mc cp data/raw/train.csv s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/train.csv
$ mc cp data/raw/test.csv s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/test.csv</code></pre>
en modifiant lâ€™emplacement de votre bucket personnel
</details>
<ul>
<li>Pour se simplifier la vie, on va utiliser des URL de tÃ©lÃ©chargement des fichiers (comme si ceux-ci Ã©taient sur nâ€™importe quel espace de stockage) plutÃ´t que dâ€™utiliser une librairie <code>S3</code> compatible comme <code>boto3</code> ou <code>s3fs</code>. Pour cela, en ligne de commande, faire:</li>
</ul>
<pre class="shell"><code>mc anonymous set download s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/</code></pre>
<p>en modifiant <code>&lt;BUCKET_PERSONNEL&gt;</code>. Les URL de tÃ©lÃ©chargement seront de la forme <code>https://minio.lab.sspcloud.fr/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/test.csv</code> et <code>https://minio.lab.sspcloud.fr/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/train.csv</code></p>
<ul>
<li>Modifier <code>configuration.yaml</code> pour utiliser directement les URL dans lâ€™import</li>
<li>Supprimer les fichiers <code>.csv</code> du dossier <code>data</code> de votre projet, on nâ€™en a plus besoin vu quâ€™on les importe de lâ€™extÃ©rieur</li>
<li>VÃ©rifier le bon fonctionnement de votre application</li>
</ul>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application8/config.yaml"><code>config.yaml</code></a></li>
</ul>
</div>
</div>
</div>
<!-----
## Etape 9 : ouvrir une *pull request* sur le dÃ©pÃ´t du projet

Enfin terminÃ© ! Enfin presque... On s'est donnÃ© beaucoup de mal Ã  nettoyer ce dÃ©pÃ´t et le mettre aux standards, autant valoriser ce travail. On va pour cela faire une *pull request* sur le [dÃ©pÃ´t du projet initial](https://github.com/avouacr/ensae-reproductibilite-projet), c'est Ã  dire proposer Ã  l'auteur d'intÃ©grer tous les changements que vous avez effectuÃ© en committant Ã  chaque Ã©tape. 

Suivre la procÃ©dure dÃ©crite dans la [documentation GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request-from-a-fork) pour crÃ©er une *pull request* Ã  partir de votre *fork*. Pour la branche *upstream* (le dÃ©pÃ´t cible), on va choisir `master`. Par contre, pour la branche locale (celle sur votre dÃ©pÃ´t), on va choisir la branche `nettoyage`.

Si tout s'est bien passÃ©, vous devriez Ã  prÃ©sent voir votre *pull request* sur le dÃ©pÃ´t cible ([ici](https://github.com/avouacr/ensae-reproductibilite-projet/pulls)). Bravo, vous venez de faire votre premiÃ¨re contribution Ã  l'open source !

{{% box status="warning" title="Warning" icon="fa fa-exclamation-triangle" %}}
Faire une *pull request* via la branche `master` dâ€™un *fork* est trÃ¨s mal vu. En effet, il faut souvent faire des contorsionnements pour rÃ©ussir Ã  faire coÃ¯ncider deux histoires qui nâ€™ont pas de raison de coÃ¯ncider. On s'Ã©vite beaucoup de problÃ¨mes en prenant l'habitude de toujours faire ses *pull requests* Ã  partir d'une autre branche que `master`.
{{% /box %}}
------------------>
</section>
</section>
<section id="partie3" class="level1">
<h1>Partie 2 : construction dâ€™un projet portable et reproductible</h1>
<p>Dans la partie prÃ©cÃ©dente, on a appliquÃ© de maniÃ¨re incrÃ©mentale de nombreuses bonnes pratiques vues tout au long du cours. Ce faisant, on sâ€™est dÃ©jÃ  considÃ©rablement rapprochÃ©s dâ€™une possible mise en production : le code est lisible, la structure du projet est normalisÃ©e et Ã©volutive, et le code est proprement versionnÃ© sur un dÃ©pÃ´t <code>GitHub</code> <i class="fab fa-github"></i>.</p>
<p>A prÃ©sent, nous avons une version du projet qui est largement partageable. Du moins en thÃ©orie, car la pratique est souvent plus compliquÃ©e : il y a fort Ã  parier que si vous essayez dâ€™exÃ©cuter votre projet sur un autre environnement (typiquement, votre ordinateur personnel), les choses ne se passent pas du tout comme attendu. Cela signifie quâ€™<strong>en lâ€™Ã©tat, le projet nâ€™est pas portable : il nâ€™est pas possible, sans modifications coÃ»teuses, de lâ€™exÃ©cuter dans un environnement diffÃ©rent de celui dans lequel il a Ã©tÃ© dÃ©veloppÃ©</strong>.</p>
<p>Dans cette seconde partie, nous allons voir comment <strong>normaliser lâ€™environnement dâ€™exÃ©cution afin de produire un projet portable</strong>. On sera alors tout proche de pouvoir mettre le projet en production. On progressera dans lâ€™Ã©chelle de la reproductibilitÃ© de la maniÃ¨re suivante: - <span class="emoji" data-emoji="one">1ï¸âƒ£</span> <a href="#configyaml"><strong>GÃ©rer des variables dâ€™environnement hors du code</strong></a> ; - <span class="emoji" data-emoji="two">2ï¸âƒ£</span> <a href="#anaconda"><strong>Environnements virtuels</strong></a> ; - <span class="emoji" data-emoji="three">3ï¸âƒ£</span> <a href="#docker"><strong>Images et conteneurs <code>Docker</code></strong></a>.</p>
<section id="configyaml" class="level2">
<h2 class="anchored" data-anchor-id="configyaml">Etape 1: crÃ©er un rÃ©pertoire de variables servant dâ€™input</h2>
<section id="enjeu" class="level3">
<h3 class="anchored" data-anchor-id="enjeu">Enjeu</h3>
<p>Lors de lâ€™<a href="#stockageS3">Ã©tape 7</a>, nous avons amÃ©liorÃ© la qualitÃ© du script en sÃ©parant stockage et code. Cependant, peut-Ãªtre avez-vous remarquÃ© que nous avons introduit un nom de <em>bucket</em> personnel dans le script (voir <a href="https://github.com/linogaliana/ensae-reproductibilite-projet-1/blob/v7/main.py#L9">le fichier <code>main.py</code></a>). Il sâ€™agit typiquement du genre de petit vice cachÃ© dâ€™un script qui peut gÃ©nÃ©rer une erreur: vous nâ€™avez pas accÃ¨s au bucket en question donc si vous essayez de faire tourner ce script en lâ€™Ã©tat, vous allez rencontrer une erreur.</p>
<p>Une bonne pratique pour gÃ©rer ce type de configuration est dâ€™utiliser un fichier <code>YAML</code> qui stocke de maniÃ¨re hiÃ©rarchisÃ©e les variables globales <a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>.</p>
<p>En lâ€™occurrence, nous nâ€™avons besoin que de deux Ã©lÃ©ments pour pouvoir dÃ©-personnaliser ce script :</p>
<ul>
<li>le nom du bucket</li>
<li>lâ€™emplacement dans le bucket</li>
</ul>
</section>
<section id="application" class="level3">
<h3 class="anchored" data-anchor-id="application">Application</h3>
<p>Dans <code>VSCode</code>, crÃ©er un fichier nommÃ© <code>config.yaml</code> et le localiser Ã  la racine de votre dÃ©pÃ´t. Voici, une proposition de hiÃ©rarchisation de lâ€™information que vous devez adapter Ã  votre nom dâ€™utilisateur :</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">input</span><span class="kw">:</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">bucket</span><span class="kw">:</span><span class="at"> </span><span class="st">"lgaliana"</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">path</span><span class="kw">:</span><span class="at"> </span><span class="st">"ensae-reproductibilite"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Dans <code>main.py</code>, importer ce fichier et remplacer la ligne prÃ©cÃ©demment Ã©voquÃ©e par les valeurs du fichier. Tester en faisant tourner <code>main.py</code> <!-----
https://github.com/linogaliana/ensae-reproductibilite-projet-1/commit/4a9d935223b6af366d4cf2a2a208d98a25407fc6
-----></p>
</section>
</section>
<section id="anaconda" class="level2">
<h2 class="anchored" data-anchor-id="anaconda">Etape 2 : crÃ©er un environnement conda Ã  partir du fichier <code>environment.yml</code></h2>
<p>Lâ€™environnement <code>conda</code> crÃ©Ã© avec <code>conda env export</code> (<a href="#conda-export">Ã©tape 6</a>) contient Ã©normÃ©ment de dÃ©pendances, dont de nombreuses qui ne nous sont pas nÃ©cessaires (il en serait de mÃªme avec <code>pip freeze</code>). Nous nâ€™avons en effet besoin que des <em>packages</em> prÃ©sents dans la section <code>import</code> de nos scripts et les dÃ©pendances nÃ©cessaires pour que ces <em>packages</em> soient fonctionnels.</p>
<p>Vous allez chercher Ã  obtenir un <code>environment.yml</code> beaucoup plus parcimonieux que celui gÃ©nÃ©rÃ© par <code>conda env export</code></p>
<p></p>
<p>{{% panel name=â€œApproche gÃ©nÃ©rale <span class="emoji" data-emoji="koala">ğŸ¨</span>â€ %}}</p>
<p>Le tableau rÃ©capitulatif prÃ©sent dans la <a href="../portability/#aide-mÃ©moire">partie portabilitÃ©</a> peut Ãªtre utile dans cette partie. Lâ€™idÃ©e est de partir <em>from scratch</em> et figer lâ€™environnement qui permet dâ€™avoir une appli fonctionnelle.</p>
<ul>
<li><p>CrÃ©er un environnement vide avec <code>Python 3.10</code> <!---
conda create -n monenv python=3.10.0
----></p></li>
<li><p>Activer cet environnement</p></li>
<li><p>Installer en ligne de commande avec <code>pip</code> les packages nÃ©cessaires pour faire tourner votre code</p></li>
</ul>
<!---
pip install pandas PyYAML s3fs scikit-learn
---->
<ul>
<li><p>Faire un <code>pip freeze &gt; requirements.txt</code> ou <code>conda env export &gt; environment.yml</code> (privilÃ©gier la deuxiÃ¨me option)</p></li>
<li><p>Retirer la section <code>prefix</code> (si elle est prÃ©sente) et changer la section <code>name</code> en <code>monenv</code></p></li>
</ul>
<p>{{% /panel %}}</p>
<p>{{% panel name=â€œApproche fainÃ©ante <span class="emoji" data-emoji="sloth">ğŸ¦¥</span>â€ %}}</p>
<p>Nous allons gÃ©nÃ©rer une version plus minimaliste grÃ¢ce Ã  lâ€™utilitaire <a href="https://github.com/bndr/pipreqs"><code>pipreqs</code></a></p>
<ul>
<li>Installer <code>pipreqs</code> en <code>pip install</code></li>
<li>En ligne de commande, depuis la racine du projet, faire <code>pipreqs</code></li>
<li>Ouvrir le <code>requirements.txt</code> automatiquement gÃ©nÃ©rÃ©. Il est beaucoup plus minimal que celui que vous obtiendriez avec <code>pip freeze</code> ou lâ€™<code>environment.yml</code> obtenu Ã  <a href="#conda-export">lâ€™Ã©tape 6</a>.</li>
<li>Remplacer toute la section <code>dependencies</code> du <code>environment.yml</code> par le contenu du <code>requirements.txt</code> (<span class="emoji" data-emoji="warning">âš ï¸</span> ne pas oublier lâ€™indentation et le tiret en dÃ©but de ligne)</li>
<li><span class="emoji" data-emoji="warning">âš ï¸</span> Modifier le tiret Ã  <code>scikit learn</code>. Il ne faut pas un <em>underscore</em> mais un tiret</li>
<li>Ajouter la version de python (par exemple <code>python=3.10.0</code>) au dÃ©but de la section <code>dependencies</code></li>
<li>Retirer la section <code>prefix</code> du fichier <code>environment.yml</code> (si elle est prÃ©sente) et changer le contenu de la section <code>name</code> en <code>monenv</code></li>
<li>CrÃ©er lâ€™environnement (<a href="../portability/#aide-mÃ©moire">voir le tableau rÃ©capitulatif dans la partie portabilitÃ©</a>)</li>
</ul>
<!----
conda env create -f environment.yml
------>
<p>{{% /panel %}}</p>
<p>{{% /panelset %}}</p>
<p>Maintenant, il reste Ã  tester si tout fonctionne bien dans notre environnement plus minimaliste:</p>
<ul>
<li>Activer lâ€™environnement</li>
<li>Tester votre script en ligne de commande</li>
<li>Faire un <code>commit</code> quand vous Ãªtes contents</li>
</ul>
</section>
<section id="docker" class="level2">
<h2 class="anchored" data-anchor-id="docker">Etape 3: conteneuriser avec Docker <i class="fab fa-docker"></i></h2>
<section id="prÃ©liminaire" class="level3">
<h3 class="anchored" data-anchor-id="prÃ©liminaire">PrÃ©liminaire</h3>
<ul>
<li>Se rendre sur lâ€™environnement bac Ã  sable <a href="https://labs.play-with-docker.com">Play with Docker</a></li>
<li>Dans le terminal <code>Linux</code>, cloner votre dÃ©pÃ´t <code>Github</code> <i class="fab fa-github"></i></li>
<li>CrÃ©er via la ligne de commande un fichier <code>Dockerfile</code>. Il y a plusieurs maniÃ¨res de procÃ©der, en voici un exemple:</li>
</ul>
<pre class="shell"><code>echo "#Dockerfile pour reproduire mon super travail" &gt; Dockerfile</code></pre>
<ul>
<li>Ouvrir ce fichier via lâ€™Ã©diteur proposÃ© par lâ€™environnement bac Ã  sable.</li>
</ul>
</section>
<section id="crÃ©ation-dun-premier-dockerfile" class="level3">
<h3 class="anchored" data-anchor-id="crÃ©ation-dun-premier-dockerfile">CrÃ©ation dâ€™un premier Dockerfile</h3>
<ul>
<li><span class="emoji" data-emoji="one">1ï¸âƒ£</span> Comme couche de dÃ©part, partir dâ€™une image lÃ©gÃ¨re comme <code>ubuntu:20.04</code></li>
<li><span class="emoji" data-emoji="two">2ï¸âƒ£</span> Dans une deuxiÃ¨me couche, faire un <code>apt get -y update</code> et installer <code>wget</code> qui va Ãªtre nÃ©cessaire pour tÃ©lÃ©charger <code>Miniconda</code> depuis la ligne de commande</li>
<li><span class="emoji" data-emoji="three">3ï¸âƒ£</span> Dans la troisiÃ¨me couche, nous allons installer <code>Miniconda</code> :
<ul>
<li>TÃ©lÃ©charger la derniÃ¨re version de <code>Miniconda</code> avec <code>wget</code> depuis lâ€™url de tÃ©lÃ©chargement direct https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh</li>
<li>Installer <code>Miniconda</code> dans le chemin <code>/home/coder/local/bin/conda</code></li>
<li>Effacer le fichier dâ€™installation pour libÃ©rer de la place sur lâ€™image</li>
</ul></li>
<li><span class="emoji" data-emoji="four">4ï¸âƒ£</span> En quatriÃ¨me couche, on va installer <code>mamba</code> pour accÃ©lÃ©rer lâ€™installation des packages dans notre environnement.</li>
<li><span class="emoji" data-emoji="five">5ï¸âƒ£</span> En cinquiÃ¨me couche, nous allons crÃ©er lâ€™environnement <code>conda</code>:
<ul>
<li>Utiliser <code>COPY</code> pour que <code>Docker</code> soit en mesure dâ€™utiliser le fichier <code>environment.yml</code> (sinon <code>Docker</code> renverra une erreur)</li>
<li>CrÃ©er lâ€™environnement vide <code>monenv</code> (prÃ©sentant uniquement <code>Python</code> 3.10) avec la commande <code>conda</code> adÃ©quate</li>
<li>Mettre Ã  jour lâ€™environnement en utilisant <code>environment.yml</code> avec <code>mamba</code></li>
</ul></li>
<li><span class="emoji" data-emoji="six">6ï¸âƒ£</span> Utiliser <code>ENV</code> pour ajouter lâ€™environnement <code>monenv</code> au <code>PATH</code> et utiliser le <em>fix</em> suivant:</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>RUN echo <span class="st">"export PATH=$PATH"</span> <span class="op">&gt;&gt;</span> <span class="op">/</span>home<span class="op">/</span>coder<span class="op">/</span>.bashrc  <span class="co"># Temporary fix while PATH gets overwritten by code-server</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><span class="emoji" data-emoji="seven">7ï¸âƒ£</span> Exposer sur le port <code>5000</code></li>
<li><span class="emoji" data-emoji="eight">8ï¸âƒ£</span> En derniÃ¨re Ã©tape, utiliser <code>CMD</code> pour reproduire le comportement de <code>python main.py</code></li>
</ul>
<p>{{% box status=â€œhintâ€ title=â€œHint: <code>mamba</code>â€ icon=â€œfa fa-lightbulbâ€ %}} <code>mamba</code> est une alternative Ã  <code>conda</code> pour installer des <em>packages</em> dans un environnement <code>Miniconda</code>/<code>Anaconda</code>. <code>mamba</code> nâ€™est pas obligatoire, <code>conda</code> peut suffire. Cependant, <code>mamba</code> est beaucoup plus rapide que <code>conda</code> pour installer des packages Ã  installer ; il sâ€™agit donc dâ€™un utilitaire trÃ¨s pratique. {{% /box %}}</p>
<p></p>
<p>{{% panel name=â€œIndications supplÃ©mentairesâ€ %}}</p>
<p>Cliquer sur les onglets ci-dessus <span class="emoji" data-emoji="point_up_2">ğŸ‘†</span> pour bÃ©nÃ©ficier dâ€™indications supplÃ©mentaires, pour vous aider. Cependant, essayez de ne pas les consulter immÃ©diatement: nâ€™hÃ©sitez pas Ã  tÃ¢tonner.</p>
<p>{{% /panel %}}</p>
<p>{{% panel name=â€œInstallation de Minicondaâ€ %}}</p>
<pre class="shell"><code># INSTALL MINICONDA -------------------------------
ARG CONDA_DIR=/home/coder/local/bin/conda
RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
RUN bash Miniconda3-latest-Linux-x86_64.sh -b -p $CONDA_DIR
RUN rm -f Miniconda3-latest-Linux-x86_64.sh</code></pre>
<p>{{% /panel %}}</p>
<p>{{% panel name=â€œInstallation de mambaâ€ %}}</p>
<pre class="shell"><code>ENV PATH="/home/coder/local/bin/conda/bin:${PATH}"
RUN conda install mamba -n base -c conda-forge</code></pre>
<p>{{% /panel %}}</p>
<p>{{% panel name=â€œCrÃ©ation de lâ€™environnementâ€ %}}</p>
<pre class="shell"><code>COPY environment.yml .
RUN conda create -n monenv python=3.10
RUN mamba env update -n monenv -f environment.yml</code></pre>
<p>{{% /panel %}}</p>
<p></p>
</section>
<section id="construire-limage" class="level3">
<h3 class="anchored" data-anchor-id="construire-limage">Construire lâ€™image</h3>
<p>Maintenant, nous avons dÃ©fini notre recette. Il nous reste Ã  faire notre plat et Ã  le goÃ»ter</p>
<ul>
<li>Utiliser <code>docker build</code> pour crÃ©er une image avec le tag <code>my-python-app</code></li>
<li>VÃ©rifier les images dont vous disposez. Vous devriez avoir un rÃ©sultat proche de celui-ci</li>
</ul>
<!---
docker build . -t my-python-app
docker images
---->
<pre class="shell"><code>REPOSITORY      TAG       IMAGE ID       CREATED         SIZE
my-python-app   latest    c0dfa42d8520   6 minutes ago   2.23GB
ubuntu          20.04     825d55fb6340   6 days ago      72.8MB</code></pre>
</section>
<section id="tester-limage-dÃ©couverte-du-cache" class="level3">
<h3 class="anchored" data-anchor-id="tester-limage-dÃ©couverte-du-cache">Tester lâ€™image: dÃ©couverte du cache</h3>
<p>Il ne reste plus quâ€™Ã  goÃ»ter la recette et voir si le plat est bon.</p>
<p>Utiliser <code>docker run</code> avec lâ€™option <code>it</code> pour pouvoir appeler lâ€™image depuis son tag</p>
<!----
docker run -it my-python-app
---->
<p><span class="emoji" data-emoji="warning">âš ï¸</span> <span class="emoji" data-emoji="bomb">ğŸ’£</span> <span class="emoji" data-emoji="fire">ğŸ”¥</span> <code>Docker</code> ne sait pas oÃ¹ trouver le fichier <code>main.py</code>. Dâ€™ailleurs, il ne connait pas dâ€™autres fichiers de notre application qui sont nÃ©cessaires pour faire tourner le code: <code>config.yaml</code> et le dossier <code>src</code></p>
<ul>
<li><p>Avant lâ€™Ã©tape <code>EXPOSE</code> utiliser plusieurs <code>ADD</code> et/ou <code>COPY</code> pour que lâ€™application dispose de tous les Ã©lÃ©ments minimaux pour Ãªtre en mesure de fonctionner</p></li>
<li><p>Refaire tourner <code>docker run</code> <!---
docker run -it my-python-app
---></p></li>
</ul>
<p>{{% box status=â€œtipâ€ title=â€œNoteâ€ icon=â€œfa fa-hintâ€ %}} Ici, le <em>cache</em> permet dâ€™Ã©conomiser beaucoup de temps. Par besoin de refaire tourner toutes les Ã©tapes, <code>Docker</code> agit de maniÃ¨re intelligente en faisant tourner uniquement les nouvelles Ã©tapes. {{% /box %}}</p>
</section>
<section id="corriger-une-faille-de-reproductibilitÃ©" class="level3">
<h3 class="anchored" data-anchor-id="corriger-une-faille-de-reproductibilitÃ©">Corriger une faille de reproductibilitÃ©</h3>
<p>Vous devriez rencontrer une erreur liÃ©e Ã  la variable dâ€™environnement <code>AWS_ENDPOINT_URL</code>. Câ€™est normal, elle est inconnue de cet environnement minimaliste. Dâ€™ailleurs, <code>Docker</code> nâ€™a aucune raison de connaÃ®tre votre espace de stockage sur le <code>S3</code> du <code>SSP-Cloud</code> si vous ne lui dites pas. Donc cet environnement ne sait pas comment accÃ©der aux fichiers prÃ©sents dans votre <code>minio</code>.</p>
<p>Vous allez rÃ©gler ce problÃ¨me avec les Ã©tapes suivantes, :</p>
<ul>
<li><span class="emoji" data-emoji="one">1ï¸âƒ£</span> Naviguer dans lâ€™<a href="https://datalab.sspcloud.fr/mes-fichiers">interface du SSP-Cloud</a> pour retrouver les liens dâ€™accÃ¨s direct de vos fichiers</li>
<li><span class="emoji" data-emoji="two">2ï¸âƒ£</span> Dans <code>VSCode</code>, les mettre dans <code>config.yaml</code> (faire de nouvelles clÃ©s)</li>
<li><span class="emoji" data-emoji="three">3ï¸âƒ£</span> Dans <code>VSCode</code>, modifier la fonction dâ€™import pour sâ€™adapter Ã  ce changement.</li>
<li><span class="emoji" data-emoji="four">4ï¸âƒ£</span> Faire un <code>commit</code> et pusher les fichiers</li>
<li><span class="emoji" data-emoji="five">5ï¸âƒ£</span> Dans lâ€™environnement bac Ã  sable, faire un <code>pull</code> pour rÃ©cupÃ©rer ces modifications</li>
<li><span class="emoji" data-emoji="six">6ï¸âƒ£</span> Tester Ã  nouveau le <code>build</code> (lÃ  encore le <em>cache</em> est bien pratique !)</li>
</ul>
<!---
cf. 
https://github.com/linogaliana/ensae-reproductibilite-projet-1/commit/56946b4c5cb860d50b908d98a87fb549624314a6
----->
<p><span class="emoji" data-emoji="tada">ğŸ‰</span> A ce stade, la matrice de confusion doit fonctionner. Vous avez crÃ©Ã© votre premiÃ¨re application reproductible !</p>
</section>
</section>
</section>
<section id="partie-3-mise-en-production" class="level1">
<h1>Partie 3 : mise en production</h1>
<p>Une image <code>Docker</code> est un livrable qui nâ€™est pas forcÃ©ment intÃ©ressant pour tous les publics. Certains prÃ©fÃ©reront avoir un plat bien prÃ©parÃ© quâ€™une recette. Nous allons donc proposer dâ€™aller plus loin en proposant plusieurs types de livrables. Cela va nous amener Ã  dÃ©couvrir les outils du CI/CD (<em>Continuous Integration / Continuous Delivery</em>) qui sont au coeur de lâ€™approche <code>DevOps</code>. Notre approche appliquÃ©e au <em>machine learning</em> va nous entraÃ®ner plutÃ´t du cÃ´tÃ© du <code>MLOps</code> qui devient une approche de plus en plus frÃ©quente dans lâ€™industrie de la <em>data science</em>.</p>
<p>Nous allons amÃ©liorer notre approche de trois maniÃ¨res:</p>
<ul>
<li>Automatisation de la crÃ©ation de lâ€™image <code>Docker</code> et tests automatisÃ©s de la qualitÃ© du code ;</li>
<li>Production dâ€™un site <em>web</em> automatisÃ© permettant de documenter et valoriser le modÃ¨le de <em>Machine Learning</em> ;</li>
<li>Mise Ã  disposition du modÃ¨le entraÃ®nÃ© par le biais dâ€™une API pour ne pas le rÃ©-entraÃ®ner Ã  chaque fois et faciliter sa rÃ©utilisation ;</li>
</ul>
<p>A chaque fois, nous allons dâ€™abord tester en local notre travail puis essayer dâ€™automatiser cela avec les outils de <code>Github</code>.</p>
<p>On va ici utiliser lâ€™intÃ©gration continue pour deux objectifs distincts:</p>
<ul>
<li>la mise Ã  disposition de lâ€™image <code>Docker</code> ;</li>
<li>la mise en place de tests automatisÃ©s de la qualitÃ© du code sur le modÃ¨le de notre <code>linter</code> prÃ©cÃ©dent</li>
</ul>
<p>Nous allons utiliser <code>Github Actions</code> pour cela.</p>
<section id="etape-prÃ©liminaire" class="level2">
<h2 class="anchored" data-anchor-id="etape-prÃ©liminaire">Etape prÃ©liminaire</h2>
<p>Pour ne pas risquer de tout casser sur notre branche <code>master</code>, nous allons nous placer sur une branche nommÃ©e <code>dev</code>:</p>
<ul>
<li>si dans lâ€™Ã©tape suivante vous appliquez la mÃ©thode la plus simple, vous allez pouvoir la crÃ©er depuis lâ€™interface de <code>Github</code> ;</li>
<li>si vous utilisez lâ€™autre mÃ©thode, vous allez devoir la crÃ©er en local ( via la commande <code>git checkout -b dev</code>)</li>
</ul>
</section>
<section id="etape-1-mise-en-place-de-tests-automatisÃ©s" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-mise-en-place-de-tests-automatisÃ©s">Etape 1: mise en place de tests automatisÃ©s</h2>
<p>Avant dâ€™essayer de mettre en oeuvre la crÃ©ation de notre image <code>Docker</code> de maniÃ¨re automatisÃ©e, nous allons prÃ©senter la logique de lâ€™intÃ©gration continue en gÃ©nÃ©ralisant les Ã©valuations de qualitÃ© du code avec le <code>linter</code></p>
<p></p>
<p>{{% panel name=â€œUtilisation dâ€™un <em>template</em> <code>Github</code> <span class="emoji" data-emoji="cat">ğŸ±</span>â€ %}}</p>
<p><strong>Methode la plus simple: utilisation dâ€™un <em>template</em> Github</strong></p>
<p>Si vous cliquez sur lâ€™onglet <code>Actions</code> de votre dÃ©pÃ´t, <code>Github</code> vous propose des <em>workflows</em> standardisÃ©s reliÃ©s Ã  <code>Python</code>. Choisir lâ€™option <code>Python Package using Anaconda</code>.</p>
<p>warning: Nous nâ€™allons modifier que deux Ã©lÃ©ments de ce fichier.</p>
<p><span class="emoji" data-emoji="one">1ï¸âƒ£</span> La derniÃ¨re Ã©tape (<code>Test with pytest</code>) ne nous est pas nÃ©cessaire car nous nâ€™avons pas de tests unitaires Nous allons donc remplacer celle-ci par lâ€™utilisation de <code>pylint</code> pour avoir une note de qualitÃ© du package.</p>
<ul>
<li>Utiliser <code>pylint</code> Ã  cette Ã©tape pour noter les scripts ;</li>
<li>Vous pouvez fixer un score minimal Ã  5 (option <code>--fail-under=5</code>)</li>
</ul>
<p><span class="emoji" data-emoji="two">2ï¸âƒ£</span> Mettre entre guillements la version de <code>Python</code> pour que celle-ci soit reconnue.</p>
<p><span class="emoji" data-emoji="three">3ï¸âƒ£</span> Enfin, finaliser la crÃ©ation de ce script:</p>
<ul>
<li>En cliquant sur le bouton <code>Start Commit</code>, choisir la mÃ©thode <code>Create a new branch for this commit and start a pull request</code> en nommant la branche <code>dev</code></li>
<li>CrÃ©er la <code>Pull Request</code> en lui donnant un nom signifiant</li>
</ul>
<p>{{% /panel %}}</p>
<p>{{% panel name=â€œMÃ©thode manuelleâ€ %}}</p>
<p><span class="emoji" data-emoji="warning">âš ï¸</span> On est plutÃ´t sur une mÃ©thode de galÃ©rien. Il vaut mieux privilÃ©gier lâ€™autre approche</p>
<p>On va Ã©diter depuis <code>VisualStudio</code> nos fichiers.</p>
<ul>
<li>CrÃ©er une branche <code>dev</code> en ligne de commande</li>
<li>CrÃ©er un dossier <code>.github/workflows</code> via la ligne de commande ou lâ€™explorateur de fichier <!---mkdir .github/workflows -p ----></li>
<li>CrÃ©er un fichier <code>.github/workflows/quality.yml</code>.</li>
</ul>
<p>Nous allons construire, par Ã©tape, une version simplifiÃ©e du <code>Dockerfile</code> prÃ©sent dans <a href="https://medium.com/swlh/enhancing-code-quality-with-github-actions-67561c6f7063">ce post</a> et dans <a href="https://autobencoder.com/2020-08-24-conda-actions/">celui-ci</a></p>
<p><span class="emoji" data-emoji="one">1ï¸âƒ£</span> Dâ€™abord, dÃ©finissons des paramÃ¨tres pour indiquer Ã  <code>Github</code> quand faire tourner notre script:</p>
<ul>
<li>Commencez par nommer votre <em>workflow</em> par exemple <code>Python Linting</code> avec la clÃ© <code>name</code></li>
<li>Nous allons faire tourner ce <em>workflow</em> dans la branche <code>master</code> et dans la branche actuelle (<code>dev</code>). Ici, nous laissons de cÃ´tÃ© les autres Ã©lÃ©ments (par exemple le fait de faire tourner Ã  chaque <em>pull request</em>). La clÃ© <code>on</code> est dÃ©diÃ©e Ã  cet usage</li>
</ul>
<p><span class="emoji" data-emoji="two">2ï¸âƒ£</span> Ensuite, dÃ©fnissons le contexte dâ€™exÃ©cution des tÃ¢ches (<code>jobs</code>) de notre script dans les options de la partie <code>build</code>:</p>
<ul>
<li>Utilisons une machine <code>ubuntu-latest</code>. Nous verrons plus tard comment amÃ©liorer cela.</li>
</ul>
<p><span class="emoji" data-emoji="three">3ï¸âƒ£</span> Nous allons ensuite mÃ©langer des Ã©tapes prÃ©-dÃ©finies (des actions du <em>marketplace</em>) et des instructions que nous faisons :</p>
<ul>
<li>Le <em>runner</em> <code>Github</code> doit rÃ©cupÃ©rer le contenu de notre dÃ©pÃ´t, pour cela utiliser lâ€™action <code>checkout</code>. Par rapport Ã  lâ€™exemple, il convient dâ€™ajouter, pour le moment, un paramÃ¨tre <code>ref</code> avec le nom de la branche (par exemple <code>dev</code>)</li>
<li><del>On installe ensuite <code>Python</code> avec lâ€™action <code>setup-python</code></del> Pas besoin dâ€™installer <code>Python</code>, on va utiliser lâ€™option <code>conda-incubator/setup-miniconda@v2</code></li>
<li>Pour installer <code>Python</code> et lâ€™environnement <code>conda</code>, on va plutÃ´t utiliser lâ€™astuce de <a href="https://autobencoder.com/2020-08-24-conda-actions/">ce blog</a> avec lâ€™option <code>conda-incubator/setup-miniconda@v2</code></li>
<li>On utilise ensuite <code>flake8</code> et <code>pylint</code> (option <code>--fail-under=5</code>) pour effectuer des diagnostics de qualitÃ©</li>
</ul>
<p>Il ne reste plus quâ€™Ã  faire un <code>commit</code> et espÃ©rer que cela fonctionne. Cela devrait donner le fichier suivant :</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Python Linting</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">master</span><span class="kw">,</span><span class="at"> dev</span><span class="kw">]</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest    </span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">ref</span><span class="kw">:</span><span class="at"> </span><span class="st">"dev"</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> conda-incubator/setup-miniconda@v2</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">activate-environment</span><span class="kw">:</span><span class="at"> monenv</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">environment-file</span><span class="kw">:</span><span class="at"> environment.yml</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">python-version</span><span class="kw">:</span><span class="at"> </span><span class="st">'3.10'</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">auto-activate-base</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">shell</span><span class="kw">:</span><span class="at"> bash -l {0}</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>          conda info</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>          conda list</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Lint with flake8</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>          pip install flake8</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>          flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>          flake8 src --count --max-complexity=10 --max-line-length=79 --statistics</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Lint with Pylint</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>          pip install pylint</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>          pylint src</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>{{% /panel %}}</p>
<p></p>
<p>Maintenant, nous pouvons observer que lâ€™onglet <code>Actions</code> sâ€™est enrichi. Chaque <code>commit</code> va entraÃ®ner une action pour tester nos scripts.</p>
<p>Si la note est mauvaise, nous aurons une croix rouge (et nous recevrons un mail). On pourra ainsi dÃ©tecter, en dÃ©veloppant son projet, les moments oÃ¹ on dÃ©grade la qualitÃ© du script afin de la rÃ©tablir immÃ©diatemment.</p>
<p>{{% box status=â€œhintâ€ title=â€œUn <code>linter</code> sous forme de <em>hook</em> pre-commitâ€ icon=â€œfa fa-lightbulbâ€ %}}</p>
<p><code>Git</code> offre une fonctionalitÃ© intÃ©ressante lorsquâ€™on est puriste: les <em>hooks</em>. Il sâ€™agit de rÃ¨gles qui doivent Ãªtre satisfaites pour que le fichier puisse Ãªtre committÃ©. Cela assurera que chaque <code>commit</code> remplisse des critÃ¨res de qualitÃ© afin dâ€™Ã©viter le problÃ¨me de la procrastination.</p>
<p>La <a href="https://pylint.pycqa.org/en/latest/user_guide/pre-commit-integration.html">documentation de pylint</a> offre des explications supplÃ©mentaires.</p>
<p>{{% /box %}}</p>
</section>
<section id="etape-2-automatisation-de-la-livraison-de-limage-docker" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-automatisation-de-la-livraison-de-limage-docker">Etape 2: Automatisation de la livraison de lâ€™image <code>Docker</code></h2>
<p>Maintenant, nous allons automatiser la mise Ã  disposition de notre image sur <code>DockerHub</code>. Cela facilitera sa rÃ©utilisation mais aussi des valorisations ultÃ©rieures.</p>
<p>LÃ  encore, nous allons utiliser une sÃ©rie dâ€™actions prÃ©-configurÃ©es.</p>
<p><span class="emoji" data-emoji="one">1ï¸âƒ£</span> Pour que <code>Github</code> puisse sâ€™authentifier auprÃ¨s de <code>DockerHub</code>, il va falloir dâ€™abord interfacer les deux plateformes. Pour cela, nous allons utiliser un jeton (<em>token</em>) <code>DockerHub</code> que nous allons mettre dans un espace sÃ©curisÃ© associÃ© Ã  votre dÃ©pÃ´t <code>Github</code>. Cette dÃ©marche sera lÃ  mÃªme ultÃ©rieurement lorsque nous connecterons notre dÃ©pÃ´t Ã  un autre service tiers, Ã  savoir <code>Netlify</code>:</p>
<ul>
<li>Se rendre sur https://hub.docker.com/ et crÃ©er un compte.</li>
<li>Aller dans les paramÃ¨tres (https://hub.docker.com/settings/general) et cliquer, Ã  gauche, sur <code>Security</code></li>
<li>CrÃ©er un jeton personnel dâ€™accÃ¨s, ne fermez pas lâ€™onglet en question, vous ne pouvez voir sa valeur quâ€™une fois.</li>
<li>Dans votre dÃ©pÃ´t <code>Github</code>, cliquer sur lâ€™onglet <code>Settings</code> et cliquer, Ã  gauche, sur <code>Actions</code>. Sur la page qui sâ€™affiche, cliquer sur <code>New repository secret</code></li>
<li>Donner le nom <code>DOCKERHUB_TOKEN</code> Ã  ce jeton et copier la valeur. Valider</li>
<li>CrÃ©er un deuxiÃ¨me secret nommÃ© <code>DOCKERHUB_USERNAME</code> ayant comme valeur le nom dâ€™utilisateur que vous avez crÃ©Ã© sur <code>Dockerhub</code></li>
</ul>
<p><span class="emoji" data-emoji="two">2ï¸âƒ£</span> A ce stade, nous avons donnÃ© les moyens Ã  <code>Github</code> de sâ€™authentifier avec notre identitÃ© sur <code>Dockerhub</code>. Il nous reste Ã  mettre en oeuvre lâ€™action en sâ€™inspirant de https://github.com/docker/build-push-action/#usage. On ne va modifier que trois Ã©lÃ©ments dans ce fichier. Effectuer les actions suivantes:</p>
<ul>
<li>CrÃ©er depuis <code>VSCode</code> un fichier <code>.github/workflows/docker.yml</code> et coller le contenu du <em>template</em> dedans ;</li>
<li>Changer le nom en un titre plus signifiant (par exemple <em>â€œProduction de lâ€™image Dockerâ€</em>)</li>
<li>Ajouter <code>master</code> et <code>dev</code> Ã  la liste des branches sur lesquelles tourne le pipeline ;</li>
<li>Changer le tag Ã  la fin pour mettre <code>&lt;username&gt;/ensae-repro-docker:latest</code> oÃ¹ <code>username</code> est le nom dâ€™utilisateur sur <code>DockerHub</code>;</li>
<li>Faire un <code>commit</code> et un <code>push</code> de ces fichiers</li>
</ul>
<p><span class="emoji" data-emoji="four">4ï¸âƒ£</span> Comme on est fier de notre travail, on va afficher Ã§a avec un badge sur le <code>README</code>. Pour cela, on se rend dans lâ€™onglet <code>Actions</code> et on clique sur un des scripts en train de tourner.</p>
<ul>
<li>En haut Ã  droite, on clique sur <code>...</code></li>
<li>SÃ©lectionner <code>Create status badge</code></li>
<li>RÃ©cupÃ©rer le code <code>Markdown</code> proposÃ©</li>
<li>Copier dans le <code>README</code> depuis <code>VSCode</code></li>
<li>Faire de mÃªme pour lâ€™autre <em>workflow</em></li>
</ul>
<p><span class="emoji" data-emoji="five">5ï¸âƒ£</span> Maintenant, il nous reste Ã  tester notre application dans lâ€™espace bac Ã  sable:</p>
<ul>
<li>Se rendre sur lâ€™environnement bac Ã  sable</li>
<li>CrÃ©er un fichier <code>Dockerfile</code> ne contenant que lâ€™import et le dÃ©ploiement de lâ€™appli:</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="at">FROM &lt;username&gt;/ensae-repro-docker:latest</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="at">EXPOSE 5000</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="at">CMD ["python", "main.py"]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Comme prÃ©cÃ©demment, faire un <em>build</em></li>
<li>Tester lâ€™image avec <code>run</code></li>
</ul>
<p><span class="emoji" data-emoji="tada">ğŸ‰</span> La matrice de confusion doit sâ€™afficher ! Vous avez grandement facilitÃ© la rÃ©utilisation de votre image.</p>
</section>
<section id="etape-3-crÃ©ation-dun-rapport-automatique" class="level2">
<h2 class="anchored" data-anchor-id="etape-3-crÃ©ation-dun-rapport-automatique">Etape 3: crÃ©ation dâ€™un rapport automatique</h2>
<p>Maintenant, nous allons crÃ©er et dÃ©ployer un site web pour valoriser notre travail. Cela va impliquer trois Ã©tapes:</p>
<ul>
<li>Tester en local le logiciel <code>quarto</code> et crÃ©er un rapport minimal qui sera compilÃ© par <code>quarto</code> ;</li>
<li>Enrichir lâ€™image docker avec le logiciel <code>quarto</code> ;</li>
<li>Compiler le document en utilisant cette image sur les serveurs de <code>Github</code> ;</li>
<li>DÃ©ployer ce rapport minimal pour le rendre disponible Ã  tous sur le <em>web</em>.</li>
</ul>
<p>Le but est de proposer un rapport minimal qui illustre la performance du modÃ¨le est la <em>feature importance</em>. Pour ce dernier Ã©lÃ©ment, le rapport qui sera proposÃ© utilise <code>shap</code> qui est une librairie dÃ©diÃ©e Ã  lâ€™interprÃ©tabilitÃ© des modÃ¨les de <em>machine learning</em></p>
<section id="rapport-minimal-en-local" class="level3">
<h3 class="anchored" data-anchor-id="rapport-minimal-en-local">1. Rapport minimal en local</h3>
<p><span class="emoji" data-emoji="one">1ï¸âƒ£</span> La premiÃ¨re Ã©tape consiste Ã  installer <code>quarto</code> sur notre machine <code>Linux</code> sur laquelle tourne <code>VSCode</code>:</p>
<ul>
<li>Dans un terminal, installer <code>quarto</code> avec les commandes suivantes:</li>
</ul>
<pre class="shell"><code>QUARTO_VERSION="0.9.287"
wget "https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.deb"
sudo apt install "./quarto-${QUARTO_VERSION}-linux-amd64.deb"</code></pre>
<ul>
<li>Sâ€™assurer quâ€™on travaille bien depuis lâ€™environnement <code>conda</code> <code>monenv</code>. Sinon lâ€™activer</li>
</ul>
<p><span class="emoji" data-emoji="two">2ï¸âƒ£</span> Il va Ãªtre nÃ©cessaire dâ€™enrichir lâ€™environnement <code>conda</code>. Certaines dÃ©pendances sont nÃ©cessaires pour que <code>quarto</code> fonctionne bien avec <code>Python</code> (<code>jupyter</code>, <code>nbclient</code>â€¦) alors que dâ€™autres ne sont nÃ©cessaires que parce quâ€™ils sont utilisÃ©s dans le document (<code>seaborn</code>, <code>shap</code>â€¦). Changer la section <code>dependencies</code> avec la liste suivante:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> python=3.10.0</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> ipykernel==6.13.0</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> jupyter==1.0.0</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> matplotlib==3.5.1</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> nbconvert==6.5.0</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> nbclient==0.6.0</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> nbformat==5.3.0</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> pandas==1.4.1</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> PyYAML==6.0</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> s3fs==2022.2.0</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> scikit-learn==1.0.2</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> seaborn==0.11.2</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> shap==0.40.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table">
<caption>three: CrÃ©er un fichier nommÃ© <code>report.qmd</code></caption>
<thead>
<tr class="header">
<th>~markdown</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>title: â€œComprendre les facteurs de survie sur le Titanicâ€</td>
</tr>
<tr class="even">
<td>subtitle: â€œUn rapport innovantâ€</td>
</tr>
<tr class="odd">
<td>format:</td>
</tr>
<tr class="even">
<td>html:</td>
</tr>
<tr class="odd">
<td>self-contained: true</td>
</tr>
<tr class="even">
<td>ipynb: default</td>
</tr>
<tr class="odd">
<td>jupyter: python3</td>
</tr>
</tbody>
</table>
<p>Voici un rapport prÃ©sentant quelques intuitions issues dâ€™un modÃ¨le <em>random forest</em> sur le jeu de donnÃ©es <code>Titanic</code> entraÃ®nÃ© et dÃ©ployÃ© de maniÃ¨re automatique.</p>
<p>Il est possible de tÃ©lÃ©charger cette page sous format <code>Jupyter Notebook</code> <a href="report.ipynb" download="">ici</a></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> main</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> main.X_train</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> main.y_train</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>training_data <span class="op">=</span> main.training_data</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>rdmf <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>rdmf.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="feature-importance" class="level1">
<h1>Feature importance</h1>
<p>La <strong>?@fig-feature-importance</strong> reprÃ©sente lâ€™importance des variables :</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>feature_imp <span class="op">=</span> pd.Series(rdmf.feature_importances_, index<span class="op">=</span>training_data.iloc[:,<span class="dv">1</span>:].columns).sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-feature-importance</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Feature importance"</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">6</span>))</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span>feature_imp, y<span class="op">=</span>feature_imp.index)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels to your graph</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Feature Importance Score'</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Features'</span>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Visualizing Important Features"</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Celle-ci peut Ã©galement Ãªtre obtenue grÃ¢ce Ã  la librairie <code>shap</code>:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo : true</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shap</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>shap_values <span class="op">=</span> shap.TreeExplainer(rdmf).shap_values(X_train)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>shap.summary_plot(shap_values, X_train, plot_type<span class="op">=</span><span class="st">"bar"</span>, feature_names <span class="op">=</span> training_data.iloc[:,<span class="dv">1</span>:].columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On peut Ã©galement utiliser cette librairie pour interprÃ©ter la prÃ©diction de notre modÃ¨le:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># explain all the predictions in the test set</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>explainer <span class="op">=</span> shap.TreeExplainer(rdmf)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Shap values</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>choosen_instance <span class="op">=</span> main.X_test[<span class="dv">15</span>]</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>shap_values <span class="op">=</span> explainer.shap_values(choosen_instance)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>shap.initjs()</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>shap.force_plot(explainer.expected_value[<span class="dv">1</span>], shap_values[<span class="dv">1</span>], choosen_instance, feature_names <span class="op">=</span> training_data.iloc[:,<span class="dv">1</span>:].columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="qualitÃ©-prÃ©dictive-du-modÃ¨le" class="level1">
<h1>QualitÃ© prÃ©dictive du modÃ¨le</h1>
<p>La matrice de confusion est prÃ©sentÃ©e sur la <strong>?@fig-confusion</strong></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-confusion</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Matrice de confusion"</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>conf_matrix <span class="op">=</span> confusion_matrix(main.y_test, rdmf.predict(main.X_test))</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">5</span>))</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>sns.heatmap(conf_matrix, annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Confusion Matrix'</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ou, sous forme de tableau:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(conf_matrix, columns<span class="op">=</span>[<span class="st">'Predicted'</span>,<span class="st">'Observed'</span>], index <span class="op">=</span> [<span class="st">'Predicted'</span>,<span class="st">'Observed'</span>]).to_html()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>~~~</p>
<p><span class="emoji" data-emoji="four">4ï¸âƒ£</span> On va tenter de compiler ce document</p>
<ul>
<li><p>Le compiler en local avec la commande <code>quarto render report.qmd</code></p></li>
<li><p>Vous devriez rencontrer lâ€™erreur suivante:</p></li>
</ul>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="op">---------------------------------------------------------------------------</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="pp">AttributeError</span>                            Traceback (most recent call last)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>Input In [<span class="dv">1</span>], <span class="kw">in</span> <span class="op">&lt;</span>cell line: <span class="dv">6</span><span class="op">&gt;</span>()</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>      <span class="dv">4</span> <span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>      <span class="dv">5</span> <span class="im">import</span> main</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="op">----&gt;</span> <span class="dv">6</span> X_train <span class="op">=</span> main.X_train</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>      <span class="dv">7</span> y_train <span class="op">=</span> main.y_train</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>      <span class="dv">8</span> training_data <span class="op">=</span> main.training_data</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="pp">AttributeError</span>: module <span class="st">'main'</span> has no attribute <span class="st">'X_train'</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="pp">AttributeError</span>: module <span class="st">'main'</span> has no attribute <span class="st">'X_train'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>Refactoriser <code>main.py</code> pour que toutes les opÃ©rations, Ã  lâ€™exception du print de la matrice de confusion ne soient plus dans la section <code>__main__</code> afin quâ€™ils soient systÃ©matiquement exÃ©cutÃ©s.</p></li>
<li><p>Tenter Ã  nouveau <code>quarto render report.qmd</code></p></li>
<li><p>Deux fichiers ont Ã©tÃ© gÃ©nÃ©rÃ©s:</p>
<ul>
<li>un <code>Notebook</code> que vous pouvez ouvrir et dont vous pouvez exÃ©cuter des cellules</li>
<li>un fichier <code>HTML</code> que vous pouvez tÃ©lÃ©charger et ouvrir</li>
</ul></li>
</ul>
<p><span class="emoji" data-emoji="five">5ï¸âƒ£</span> On a dÃ©jÃ  un rÃ©sultat assez esthÃ©tique en ce qui concerne la page <code>HTML</code>. Cependant, on peut se dire que certains paramÃ¨tres par dÃ©faut, comme lâ€™affichage des blocs de code, ne conviennent pas au public ciblÃ©. De mÃªme, certains paramÃ¨tres de style, comme lâ€™affichage des tableaux peuvent ne pas convenir Ã  notre charte graphique. On va remÃ©dier Ã  cela en deux Ã©tapes:</p>
<ul>
<li>enrichir le <em>header</em> dâ€™options globales contrÃ´lant le comportement de <code>quarto</code></li>
<li>crÃ©er un fichier <code>CSS</code> pour avoir de beaux tableaux</li>
</ul>
<p><span class="emoji" data-emoji="six">6ï¸âƒ£</span> Changer la section <code>format</code> du <em>header</em> avec les options suivantes:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">format</span><span class="kw">:</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">html</span><span class="kw">:</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">echo</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">code-fold</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">self-contained</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">code-summary</span><span class="kw">:</span><span class="at"> </span><span class="st">"Show the code"</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">warning</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">message</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">theme</span><span class="kw">:</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> cosmo</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> css/custom.scss</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ipynb</span><span class="kw">:</span><span class="at"> default</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><span class="emoji" data-emoji="seven">7ï¸âƒ£</span> CrÃ©er le fichier <code>css/custom.scss</code> avec le contenu suivant:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode css code-with-copy"><code class="sourceCode css"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*-- scss:rules --*/</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>table {</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">border-collapse</span>: <span class="dv">collapse</span><span class="op">;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">margin</span>: <span class="dv">25</span><span class="dt">px</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-size</span>: <span class="dv">0.9</span><span class="dt">em</span><span class="op">;</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-family</span>: <span class="dv">sans-serif</span><span class="op">;</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">min-width</span>: <span class="dv">400</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">box-shadow</span>: <span class="dv">0</span> <span class="dv">0</span> <span class="dv">20</span><span class="dt">px</span> <span class="fu">rgba(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0.15</span><span class="fu">)</span><span class="op">;</span>  </span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>thead tr {</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">background-color</span>: <span class="cn">#516db0</span><span class="op">;</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">color</span>: <span class="cn">#ffffff</span><span class="op">;</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">text-align</span>: <span class="dv">center</span><span class="op">;</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>th<span class="op">,</span> td {</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">padding</span>: <span class="dv">12</span><span class="dt">px</span> <span class="dv">15</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>tbody tr {</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">border-bottom</span>: <span class="dv">1</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#dddddd</span><span class="op">;</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>tbody tr<span class="in">:nth-of-type(even)</span> {</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">background-color</span>: <span class="cn">#f3f3f3</span><span class="op">;</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>tbody tr<span class="in">:last-of-type</span> {</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">border-bottom</span>: <span class="dv">2</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#516db0</span><span class="op">;</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>tbody tr<span class="fu">.active-row</span> {</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-weight</span>: <span class="dv">bold</span><span class="op">;</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">color</span>: <span class="cn">#009879</span><span class="op">;</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><span class="emoji" data-emoji="eight">8ï¸âƒ£</span> Compiler Ã  nouveau et observer le changement dâ€™esthÃ©tique du <code>HTML</code></p>
<p><span class="emoji" data-emoji="nine">9ï¸âƒ£</span> Commit des nouveaux fichier <code>report.qmd</code>, <code>custom.scss</code> et des fichiers dÃ©jÃ  existants.</p>
<p>{{% box status=â€œhintâ€ title=â€œUn <code>linter</code> sous forme de <em>hook</em> pre-commitâ€ icon=â€œfa fa-lightbulbâ€ %}}</p>
<p>On ne <code>commit</code> pas les <em>output</em>, ici le notebook et le fichier html. Les mettre sur le dÃ©pÃ´t <code>Github</code> nâ€™est pas la bonne maniÃ¨re de les mettre Ã  disposition. On va le voir, on va utiliser lâ€™approche CI/CD pour cela.</p>
<p>IdÃ©alement, on ajoute au <code>.gitignore</code> les fichiers concernÃ©s, ici <code>report.ipynb</code> et <code>report.html</code></p>
<p>{{% /box %}}</p>
<section id="enrichir-limage-docker" class="level3">
<h3 class="anchored" data-anchor-id="enrichir-limage-docker">3. Enrichir lâ€™image <code>Docker</code></h3>
<p>On va vouloir mettre Ã  jour notre image pour automatiser, Ã  terme, la production de nos livrables (le notebook et la page web).</p>
<p>Pour cela, il est nÃ©cessaire que notre image intÃ¨gre le logiciel <code>quarto</code>.</p>
<p><span class="emoji" data-emoji="one">1ï¸âƒ£</span> A partir du script prÃ©cÃ©dent dâ€™installation de <code>quarto</code>, enrichir lâ€™image <code>Docker</code><a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a></p>
<!----
ENV QUARTO_VERSION="0.9.287"
RUN wget "https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.deb"
RUN apt install "./quarto-${QUARTO_VERSION}-linux-amd64.deb"
----->
</section>
<section id="automatisation-avec-github-actions" class="level3">
<h3 class="anchored" data-anchor-id="automatisation-avec-github-actions">4. Automatisation avec <code>Github Actions</code></h3>
<p><span class="emoji" data-emoji="one">1ï¸âƒ£</span> CrÃ©er un nouveau fichier <code>.github/workflows.report.yml</code></p>
<p>Si les dÃ©pendances et lâ€™image ont bien Ã©tÃ© enrichis, cette Ã©tape est quasi directe avec</p>
<p></p>
<p>{{% panel name=â€œVersion autonome <span class="emoji" data-emoji="car">ğŸš—</span>â€ %}}</p>
<ul>
<li>Donner comme nom <code>Deploy as website</code></li>
<li>Effectuer cette action Ã  chaque <code>push</code> sur les branches <code>main</code>, <code>master</code> et <code>dev</code></li>
<li>Le job doit tourner sur une machine <code>ubuntu</code></li>
<li>Cependant, il convient dâ€™utiliser comme <code>container</code> votre image Docker</li>
<li>Les <code>steps</code>:
<ul>
<li>RÃ©cupÃ©rer le contenu du dossier avec <code>checkout</code></li>
<li>Faire un <code>quarto render</code></li>
<li>RÃ©cupÃ©rer le notebook sous forme dâ€™artefact</li>
</ul></li>
</ul>
<p>{{% /panel %}}</p>
<p>{{% panel name=â€œVersion guidÃ©e :map:â€ %}}</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy as website</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> main</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> master</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> dev</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container</span><span class="kw">:</span><span class="at"> linogaliana/ensae-repro-docker:latest</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Render site</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> quarto render report.qmd</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/upload-artifact@v1</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Report</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> report.ipynb</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>{{% /panel %}}</p>
<p></p>
<p>Si vous Ãªtes fier de vous, vous pouvez ajouter le badge de ce workflow sur le <code>README</code> <span class="emoji" data-emoji="sunglasses">ğŸ˜</span></p>
<p>Cette Ã©tape nous a permis dâ€™automatiser la construction de nos livrables. Mais la mise Ã  disposition de ce livrable est encore assez manuelle: il faut aller chercher Ã  la main la derniÃ¨re version du notebook pour la partager.</p>
<p>On va amÃ©liorer cela en dÃ©ployant automatiquement un site <em>web</em> prÃ©sentant en page dâ€™accueil notre rapport et permettant le tÃ©lÃ©chargement du notebook.</p>
</section>
<section id="etape-4-dÃ©ploiement-de-ce-rapport-automatique-sur-le-web" class="level2">
<h2 class="anchored" data-anchor-id="etape-4-dÃ©ploiement-de-ce-rapport-automatique-sur-le-web">Etape 4: DÃ©ploiement de ce rapport automatique sur le web</h2>
<p><span class="emoji" data-emoji="one">1ï¸âƒ£</span> Dans un premier temps, nous allons connecter notre dÃ©pÃ´t <code>Github</code> au service tiers <code>Netlify</code></p>
<ul>
<li>Aller sur https://www.netlify.com/ et faire <code>Sign up</code> (utiliser son compte <code>Github</code>)</li>
<li>Dans la page dâ€™accueil de votre profil, vous pouvez cliquer sur <code>Add new site &gt; Import an existing project</code></li>
<li>Cliquer sur <code>Github</code>. Sâ€™il y a des autorisations Ã  donner, les accorder. Rechercher votre projet dans la liste de vos projets <code>Github</code></li>
<li>Cliquer sur le nom du projet et laisser les paramÃ¨tres par dÃ©faut (nous allons modifier par la suite)</li>
<li>Cliquer sur <code>Deploy site</code></li>
</ul>
<p><span class="emoji" data-emoji="two">2ï¸âƒ£</span> A ce stade, votre dÃ©ploiement devrait Ã©chouer. Câ€™est normal, vous essayez de dÃ©ployer depuis <code>master</code> qui ne comporte pas de html. Mais le rapport nâ€™est pas non plus prÃ©sent dans la branche <code>dev</code>. En fait, aucune branche ne comporte le rapport: celui-ci est gÃ©nÃ©rÃ© dans votre <em>pipeline</em> mais nâ€™est jamais prÃ©sent dans le dÃ©pÃ´t car il sâ€™agit dâ€™un <em>output</em>. On va dÃ©sactiver le dÃ©ploiement automatique pour privilÃ©gier un dÃ©ploiement depuis <code>Github Actions</code>:</p>
<ul>
<li>Aller dans <code>Site Settings</code> puis, Ã  gauche, cliquer sur <code>Build and Deploy</code></li>
<li>Dans la section <code>Build settings</code>, cliquer sur <code>Stop builds</code> et valider</li>
</ul>
<p>On vient de dÃ©sactiver le dÃ©ploiement automatique par dÃ©faut. On va faire communiquer notre dÃ©pÃ´t <code>Github</code> et <code>Netlify</code> par le biais de lâ€™intÃ©gration continue.</p>
<p><span class="emoji" data-emoji="three">3ï¸âƒ£</span> Pour cela, il faut crÃ©er un jeton <code>Netlify</code> pour que les serveurs de <code>Github</code>, lorsquâ€™ils disposent dâ€™un rapport, puissent lâ€™envoyer Ã  <code>Netlify</code> pour la mise sur le <em>web</em>. Il va Ãªtre nÃ©cessaire de crÃ©er deux variables dâ€™environnement pour connecter <code>Github</code> et <code>Netlify</code>: lâ€™identifiant du site et le <em>token</em></p>
<ul>
<li>Pour le token :
<ul>
<li>CrÃ©er un jeton en cliquant, en haut Ã  droite, sur lâ€™icone de votre profil. Aller dans <code>User settings</code>. A gauche, cliquer sur <code>Applications</code> et crÃ©er un jeton personnel dâ€™accÃ¨s avec un nom signifiant (par exemple <code>PAT_ENSAE_reproductibilite</code>)</li>
<li>Mettre de cÃ´tÃ© (conseil : garder lâ€™onglet ouvert)</li>
</ul></li>
<li>Pour lâ€™identifiant du site:
<ul>
<li>cliquer sur <code>Site Settings</code> dans les onglets en haut</li>
<li>Garder lâ€™onglet ouvert pour copier la valeur quand nÃ©cessaire</li>
</ul></li>
<li>Il est maintenant nÃ©cessaire dâ€™aller dans le dÃ©pÃ´t <code>Github</code> et de crÃ©er les secrets (<code>Settings &gt; Secrets &gt; Actions</code>):
<ul>
<li>CrÃ©er le secret <code>NETLIFY_AUTH_TOKEN</code> en collant la valeur du jeton dâ€™authentification <code>Netlify</code></li>
<li>CrÃ©er le secret <code>NETLIFY_SITE_ID</code> en collant lâ€™identifiant du site</li>
</ul></li>
</ul>
<p><span class="emoji" data-emoji="four">4ï¸âƒ£</span> Nous avons effectuÃ© toutes les configurations nÃ©cessaires. On va maintenant mettre Ã  jour lâ€™intÃ©gration continue afin de mettre Ã  disposition sur le <em>web</em> notre rapport. On va utiliser lâ€™interface en ligne de commande (CLI) de <code>Netlify</code>. Celle-ci attend que le site <em>web</em> se trouve dans un dossier <code>public</code> et que la page dâ€™accueil soit nommÃ©e <code>index.html</code>:</p>
<p></p>
<p>{{% panel name=â€œVision dâ€™ensembleâ€ %}}</p>
<ul>
<li>une installation de <code>npm</code></li>
<li>une Ã©tape de dÃ©ploiement via la CLI de netlify</li>
</ul>
<div class="sourceCode" id="cb37"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install npm</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-node@v2</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">node-version</span><span class="kw">:</span><span class="at"> </span><span class="st">'14'</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to Netlify</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co">  # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repo's secrets</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">NETLIFY_AUTH_TOKEN</span><span class="kw">:</span><span class="at"> ${{ secrets.NETLIFY_AUTH_TOKEN }}</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">NETLIFY_SITE_ID</span><span class="kw">:</span><span class="at"> ${{ secrets.NETLIFY_SITE_ID }}</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="fu">  run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    mkdir -p public</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    mv report.html public/index.html</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    mv report.ipynb public/report.ipynb</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    npm install --unsafe-perm=true netlify-cli -g</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    netlify init</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    netlify deploy --prod --dir="public" --message "Deploy master"</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>{{% /panel %}}</p>
<p>{{% panel name=â€œDÃ©tails npmâ€ %}}</p>
<p></p>
<ul>
<li>name: Install npm uses: actions/setup-node@v2 with: node-version: â€˜14â€™</li>
</ul>
<p></p>
<p><code>npm</code> est le gestionnaire de paquet de JS. Il est nÃ©cessaire de le configurer, ce qui est fait automatiquement grÃ¢ce Ã  lâ€™action <code>actions/setup-node@v2</code></p>
<p>{{% /panel %}}</p>
<p>{{% panel name=â€œDÃ©tails <code>Netlify CLI</code>â€ %}}</p>
<ul>
<li>On rappelle Ã  <code>Github Actions</code> nos paramÃ¨tres dâ€™authentification sous forme de variables dâ€™environnement. Cela permet de les garder secrÃ¨tes</li>
</ul>
<p></p>
<ul>
<li>name: Deploy to Netlify # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repoâ€™s secrets env: NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }} run: | mkdir -p public mv report.html public/index.html mv report.ipynb public/report.ipynb npm install â€“unsafe-perm=true netlify-cli -g netlify init netlify deploy â€“prod â€“dir=â€œpublicâ€ â€“message â€œDeploy masterâ€</li>
</ul>
<p></p>
<ul>
<li>On dÃ©place les rapports de la racine vers le dossier <code>public</code></li>
</ul>
<p></p>
<ul>
<li>name: Deploy to Netlify # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repoâ€™s secrets env: NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }} run: | mkdir -p public mv report.html public/index.html mv report.ipynb public/report.ipynb npm install â€“unsafe-perm=true netlify-cli -g netlify init netlify deploy â€“prod â€“dir=â€œpublicâ€ â€“message â€œDeploy masterâ€</li>
</ul>
<p></p>
<ul>
<li>On installe et initialise <code>Netlify</code></li>
</ul>
<p></p>
<ul>
<li>name: Deploy to Netlify # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repoâ€™s secrets env: NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }} run: | mkdir -p public mv report.html public/index.html mv report.ipynb public/report.ipynb npm install â€“unsafe-perm=true netlify-cli -g netlify init netlify deploy â€“prod â€“dir=â€œpublicâ€ â€“message â€œDeploy masterâ€</li>
</ul>
<p></p>
<ul>
<li>On dÃ©ploie sur lâ€™url par dÃ©faut (<code>-- prod</code>) depuis le dossier <code>public</code></li>
</ul>
<p></p>
<ul>
<li>name: Deploy to Netlify # NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID added in the repoâ€™s secrets env: NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }} run: | mkdir -p public mv report.html public/index.html mv report.ipynb public/report.ipynb npm install â€“unsafe-perm=true netlify-cli -g netlify init netlify deploy â€“prod â€“dir=â€œpublicâ€ â€“message â€œDeploy masterâ€</li>
</ul>
<p></p>
<p>{{% /panel %}}</p>
<p></p>
<p>Au bout de quelques minutes, le rapport est disponible en ligne sur lâ€™URL <code>Netlify</code> (par exemple https://spiffy-florentine-c913b9.netlify.app)</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Lâ€™export dans un script <code>.py</code> a Ã©tÃ© fait avec <a href="https://jupytext.readthedocs.io/en/latest/index.html"><code>Jupytext</code></a>. Comme cela nâ€™est pas vraiment lâ€™objet du cours, nous passons cette Ã©tape et fournissons directement le script. Mais nâ€™oubliez pas que cette dÃ©marche, frÃ©quente quand on a dÃ©marrÃ© sur un <em>notebook</em> et quâ€™on dÃ©sire consolider en faisant la transition vers des scripts, nÃ©cessite dâ€™Ãªtre attentif pour ne pas risquer de faire une erreur.<a href="#fnref1" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn2"><p>Essayez de <em>commit</em> vos changements Ã  chaque Ã©tape de lâ€™exercice, câ€™est une bonne habitude Ã  prendre.<a href="#fnref2" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn3"><p>Nous le verrons lorsque nous mettrons en oeuvre lâ€™intÃ©gration continue.<a href="#fnref3" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn4"><p>Ici, le jeton dâ€™API nâ€™est pas indispensable pour que le code fonctionne. Afin dâ€™Ã©viter une erreur non nÃ©cessaire lorsquâ€™on automatisera le processus, on peut crÃ©er une condition qui vÃ©rifie la prÃ©sence ou non de ce fichier.</p>
<p>Cela peut Ãªtre fait avec la fonction <code>os.path.exists</code> :</p>
<pre><code>if os.path.exists('secrets.yaml'):
    secrets = import_yaml_config("secrets.yaml")</code></pre>
<p>La variable <code>secrets</code> nâ€™existera que dans le cas oÃ¹ un fichier <code>secrets.yaml</code> existe. Le script reste donc reproductible mÃªme pour un utilisateur nâ€™ayant pas le fichier <code>secrets.yaml</code>.<a href="#fnref4" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn5"><p>Nous proposons ici dâ€™adopter le principe de la <strong>programmation fonctionnelle</strong>. Pour encore fiabiliser un processus, il serait possible dâ€™adopter le paradigme de la <strong>programmation orientÃ©e objet (POO)</strong>. Celle-ci est plus rebutante et demande plus de temps au dÃ©veloppeur. Lâ€™arbitrage coÃ»t-avantage est nÃ©gatif pour notre exemple, nous proposons donc de nous en passer. NÃ©anmoins, pour une mise en production rÃ©elle dâ€™un modÃ¨le, il est recommandÃ© de lâ€™adopter. Câ€™est dâ€™ailleurs obligatoire avec des <a href="https://pythonds.linogaliana.fr/pipeline-scikit/"><em>pipelines</em> <code>scikit</code></a>.<a href="#fnref5" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn6"><p>Au passage vous pouvez noter que mauvaises pratiques discutables, peuvent Ãªtre corrigÃ©es, notamment lâ€™utilisation excessive de <code>apply</code> lÃ  oÃ¹ il serait possible dâ€™utiliser des mÃ©thodes embarquÃ©es par <code>Pandas</code>. Cela est plutÃ´t de lâ€™ordre du bon style de programmation que de la qualitÃ© formelle du script. Ce nâ€™est donc pas obligatoire mais câ€™est mieux.<a href="#fnref6" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn7"><p>Il est normal dâ€™avoir des dossiers <code>__pycache__</code> qui traÃ®nent : ils se crÃ©ent automatiquement Ã  lâ€™exÃ©cution dâ€™un script en <code>Python</code>.<a href="#fnref7" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn8"><p>Le format <code>YAML</code> est un format de fichier oÃ¹ les informations sont hiÃ©rarchisÃ©es. Avec le <em>package</em> <code>YAML</code> on peut trÃ¨s facilement le transformer en <code>dict</code>, ce qui est trÃ¨s pratique pour accÃ©der Ã  une information.<a href="#fnref8" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn9"><p>Le <code>sudo</code> nâ€™est pas nÃ©cessaire puisque vous Ãªtes dÃ©jÃ  en <code>root</code><a href="#fnref9" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>