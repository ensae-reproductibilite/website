<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Romain Avouac et Lino Galiana">
<meta name="description" content="Une application fil rouge pour illustrer lâ€™intÃ©rÃªt dâ€™appliquer graduellement les bonnes pratiques dans une optique de mise en production dâ€™une application de data science.">

<title>Mise en production des projets de data science - Application</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Mise en production des projets de data science</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/introduction.html" rel="" target="">
 <span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/linux-101.html" rel="" target="">
 <span class="menu-text">Linux 101</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/git.html" rel="" target="">
 <span class="menu-text">Git</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/code-quality.html" rel="" target="">
 <span class="menu-text">QualitÃ© du code</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/projects-architecture.html" rel="" target="">
 <span class="menu-text">Architecture des projets</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/portability.html" rel="" target="">
 <span class="menu-text">PortabilitÃ©</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/deployment.html" rel="" target="">
 <span class="menu-text">Mise en production</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../chapters/application.html" rel="" target="" aria-current="page">
 <span class="menu-text">Application</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/evaluation.qmd" rel="" target="">
 <span class="menu-text">Evaluation</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/website" rel="" target="">
 <span class="dropdown-text">Site web</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/slides" rel="" target="">
 <span class="dropdown-text">Slides</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/application-correction" rel="" target="">
 <span class="dropdown-text">Application fil rouge</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#partie-0-initialisation-du-projet" id="toc-partie-0-initialisation-du-projet" class="nav-link active" data-scroll-target="#partie-0-initialisation-du-projet">Partie 0 : initialisation du projet</a>
  <ul class="collapse">
  <li><a href="#etape-1-forker-le-dÃ©pÃ´t-dexemple-et-crÃ©er-une-branche-de-travail" id="toc-etape-1-forker-le-dÃ©pÃ´t-dexemple-et-crÃ©er-une-branche-de-travail" class="nav-link" data-scroll-target="#etape-1-forker-le-dÃ©pÃ´t-dexemple-et-crÃ©er-une-branche-de-travail">Etape 1 : forker le dÃ©pÃ´t dâ€™exemple et crÃ©er une branche de travail</a></li>
  </ul></li>
  <li><a href="#partie-1-qualitÃ©-du-script" id="toc-partie-1-qualitÃ©-du-script" class="nav-link" data-scroll-target="#partie-1-qualitÃ©-du-script">Partie 1 : qualitÃ© du script</a>
  <ul class="collapse">
  <li><a href="#etape-1-sassurer-que-le-script-sexÃ©cute-correctement" id="toc-etape-1-sassurer-que-le-script-sexÃ©cute-correctement" class="nav-link" data-scroll-target="#etape-1-sassurer-que-le-script-sexÃ©cute-correctement">Etape 1 : sâ€™assurer que le script sâ€™exÃ©cute correctement</a></li>
  <li><a href="#etape-2-utiliser-un-linter-puis-un-formatter" id="toc-etape-2-utiliser-un-linter-puis-un-formatter" class="nav-link" data-scroll-target="#etape-2-utiliser-un-linter-puis-un-formatter">Etape 2: utiliser un <em>linter</em> puis un <em>formatter</em></a></li>
  <li><a href="#etape-3-gestion-des-paramÃ¨tres" id="toc-etape-3-gestion-des-paramÃ¨tres" class="nav-link" data-scroll-target="#etape-3-gestion-des-paramÃ¨tres">Etape 3: gestion des paramÃ¨tres</a></li>
  <li><a href="#etape-4-adopter-la-programmation-fonctionnelle" id="toc-etape-4-adopter-la-programmation-fonctionnelle" class="nav-link" data-scroll-target="#etape-4-adopter-la-programmation-fonctionnelle">Etape 4 : Adopter la programmation fonctionnelle</a></li>
  </ul></li>
  <li><a href="#partie2" id="toc-partie2" class="nav-link" data-scroll-target="#partie2">Partie 2 : adoption dâ€™une structure modulaire</a>
  <ul class="collapse">
  <li><a href="#etape-1-modularisation" id="toc-etape-1-modularisation" class="nav-link" data-scroll-target="#etape-1-modularisation">Etape 1 : modularisation</a></li>
  <li><a href="#etape-2-adopter-une-architecture-standardisÃ©e-de-projet" id="toc-etape-2-adopter-une-architecture-standardisÃ©e-de-projet" class="nav-link" data-scroll-target="#etape-2-adopter-une-architecture-standardisÃ©e-de-projet">Etape 2 : adopter une architecture standardisÃ©e de projet</a>
  <ul class="collapse">
  <li><a href="#etape-3-indiquer-lenvironnement-minimal-de-reproductibilitÃ©" id="toc-etape-3-indiquer-lenvironnement-minimal-de-reproductibilitÃ©" class="nav-link" data-scroll-target="#etape-3-indiquer-lenvironnement-minimal-de-reproductibilitÃ©">Etape 3: indiquer lâ€™environnement minimal de reproductibilitÃ©</a></li>
  </ul></li>
  <li><a href="#stockageS3" id="toc-stockageS3" class="nav-link" data-scroll-target="#stockageS3">Etape 3 : stocker les donnÃ©es de maniÃ¨re externe</a></li>
  </ul></li>
  <li><a href="#partie-2bis-packagisation-de-son-projet-optionnel" id="toc-partie-2bis-packagisation-de-son-projet-optionnel" class="nav-link" data-scroll-target="#partie-2bis-packagisation-de-son-projet-optionnel">Partie 2bis: packagisation de son projet (optionnel)</a>
  <ul class="collapse">
  <li><a href="#etape-1-proposer-des-tests-unitaires-optionnel" id="toc-etape-1-proposer-des-tests-unitaires-optionnel" class="nav-link" data-scroll-target="#etape-1-proposer-des-tests-unitaires-optionnel">Etape 1 : proposer des tests unitaires (optionnel)</a></li>
  <li><a href="#etape-2-transformer-son-projet-en-package-optionnel" id="toc-etape-2-transformer-son-projet-en-package-optionnel" class="nav-link" data-scroll-target="#etape-2-transformer-son-projet-en-package-optionnel">Etape 2 : transformer son projet en package (optionnel)</a></li>
  </ul></li>
  <li><a href="#partie3" id="toc-partie3" class="nav-link" data-scroll-target="#partie3">Partie 3 : construction dâ€™un projet portable et reproductible</a>
  <ul class="collapse">
  <li><a href="#anaconda" id="toc-anaconda" class="nav-link" data-scroll-target="#anaconda">Etape 1 : un environnement pour rendre le projet portable</a></li>
  <li><a href="#etape-2-construire-lenvironnement-de-notre-application-via-un-script-shell" id="toc-etape-2-construire-lenvironnement-de-notre-application-via-un-script-shell" class="nav-link" data-scroll-target="#etape-2-construire-lenvironnement-de-notre-application-via-un-script-shell">Etape 2: construire lâ€™environnement de notre application via un script <code>shell</code></a></li>
  <li><a href="#docker" id="toc-docker" class="nav-link" data-scroll-target="#docker">Etape 3: conteneuriser lâ€™application avec <code>Docker</code></a></li>
  </ul></li>
  <li><a href="#partie-4-automatisation-avec-lintÃ©gration-continue" id="toc-partie-4-automatisation-avec-lintÃ©gration-continue" class="nav-link" data-scroll-target="#partie-4-automatisation-avec-lintÃ©gration-continue">Partie 4 : automatisation avec lâ€™intÃ©gration continue</a>
  <ul class="collapse">
  <li><a href="#etape-1-mise-en-place-de-tests-automatisÃ©s" id="toc-etape-1-mise-en-place-de-tests-automatisÃ©s" class="nav-link" data-scroll-target="#etape-1-mise-en-place-de-tests-automatisÃ©s">Etape 1: mise en place de tests automatisÃ©s</a></li>
  <li><a href="#etape-2-automatisation-de-la-livraison-de-limage-docker" id="toc-etape-2-automatisation-de-la-livraison-de-limage-docker" class="nav-link" data-scroll-target="#etape-2-automatisation-de-la-livraison-de-limage-docker">Etape 2: Automatisation de la livraison de lâ€™image <code>Docker</code></a></li>
  </ul></li>
  <li><a href="#partie-5-mise-en-production-dune-api-servant-un-modÃ¨le-de-machine-learning" id="toc-partie-5-mise-en-production-dune-api-servant-un-modÃ¨le-de-machine-learning" class="nav-link" data-scroll-target="#partie-5-mise-en-production-dune-api-servant-un-modÃ¨le-de-machine-learning">Partie 5: mise en production dâ€™une API servant un modÃ¨le de machine learning</a>
  <ul class="collapse">
  <li><a href="#etape-1-crÃ©ation-dun-pipeline-scikit" id="toc-etape-1-crÃ©ation-dun-pipeline-scikit" class="nav-link" data-scroll-target="#etape-1-crÃ©ation-dun-pipeline-scikit">Etape 1: crÃ©ation dâ€™un pipeline <code>scikit</code></a></li>
  <li><a href="#etape-2-dÃ©velopper-une-api-en-local" id="toc-etape-2-dÃ©velopper-une-api-en-local" class="nav-link" data-scroll-target="#etape-2-dÃ©velopper-une-api-en-local">Etape 2: dÃ©velopper une API en local</a></li>
  <li><a href="#etape-3-dÃ©ployer-lapi" id="toc-etape-3-dÃ©ployer-lapi" class="nav-link" data-scroll-target="#etape-3-dÃ©ployer-lapi">Etape 3: dÃ©ployer lâ€™API</a></li>
  </ul></li>
  <li><a href="#partie-6-un-workflow-complet-de-mlops" id="toc-partie-6-un-workflow-complet-de-mlops" class="nav-link" data-scroll-target="#partie-6-un-workflow-complet-de-mlops">Partie 6: un workflow complet de MLOps</a></li>
  <li><a href="#partie-7-livrer-un-site-web-de-maniÃ¨re-automatisÃ©e" id="toc-partie-7-livrer-un-site-web-de-maniÃ¨re-automatisÃ©e" class="nav-link" data-scroll-target="#partie-7-livrer-un-site-web-de-maniÃ¨re-automatisÃ©e">Partie 7: livrer un site web de maniÃ¨re automatisÃ©e</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Application</h1>
<p class="subtitle lead">Appliquer pas Ã  pas les concepts Ã©tudiÃ©s Ã  un projet de data science</p>
</div>

<div>
  <div class="description">
    <p>Une application fil rouge pour illustrer lâ€™intÃ©rÃªt dâ€™appliquer graduellement les bonnes pratiques dans une optique de mise en production dâ€™une application de data science.</p>
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Romain Avouac et Lino Galiana </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<details>
<summary>
DÃ©rouler les <em>slides</em> ci-dessous ou <a href="https://ensae-reproductibilite.github.io/slides/#/title-slide">cliquer ici</a> pour afficher les slides en plein Ã©cran.
</summary>
<div id="cb1" class="sourceCode">
<pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
<iframe class="sourceCode yaml code-with-copy" src="https://ensae-reproductibilite.github.io/slides/#/title-slide">
</iframe>
</div>
</details>
<p>Lâ€™objectif de cette mise en application est dâ€™<strong>illustrer les diffÃ©rentes Ã©tapes qui sÃ©parent la phase de dÃ©veloppement dâ€™un projet de celle de la mise en production</strong>. Elle permettra de mettre en pratique les diffÃ©rents concepts prÃ©sentÃ©s tout au long du cours.</p>
<p>Celle-ci est un tutoriel pas Ã  pas pour avoir un projet reproductible et disponible sous plusieurs livrables. Toutes les Ã©tapes ne sont pas indispensables Ã  tous les projets de <em>data science</em>.</p>
<p>Nous nous plaÃ§ons dans une situation initiale correspondant Ã  la fin de la phase de dÃ©veloppement dâ€™un projet de data science. On a un notebook un peu monolithique, qui rÃ©alise les Ã©tapes classiques dâ€™un <em>pipeline</em> de <em>machine learning</em> :</p>
<ul>
<li>Import de donnÃ©es ;</li>
<li>Statistiques descriptives et visualisations ;</li>
<li><em>Feature engineering</em> ;</li>
<li>EntraÃ®nement dâ€™un modÃ¨le ;</li>
<li>Evaluation du modÃ¨le</li>
</ul>
<p><strong>Lâ€™objectif est dâ€™amÃ©liorer le projet de maniÃ¨re incrÃ©mentale jusquâ€™Ã  pouvoir le mettre en production, en le valorisant sous une forme adaptÃ©e.</strong></p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Il est important de bien lire les consignes et dâ€™y aller progressivement. Certaines Ã©tapes peuvent Ãªtre rapides, dâ€™autres plus fastidieuses ; certaines Ãªtre assez guidÃ©es, dâ€™autres vous laisser plus de libertÃ©. Si vous nâ€™effectuez pas une Ã©tape, vous risquez de ne pas pouvoir passer Ã  lâ€™Ã©tape suivante qui en dÃ©pend.</p>
<p>Bien que lâ€™exercice soit applicable sur toute configuration bien faite, nous recommandons de privilÃ©gier lâ€™utilisation du <a href="https://datalab.sspcloud.fr/home">SSP Cloud</a>, oÃ¹ tous les outils nÃ©cessaires sont prÃ©-installÃ©s et prÃ©-configurÃ©s.</p>
</div>
</div>
<details>
<summary>
Illustration de notre point de dÃ©part
</summary>
<img src="../workflow1.png" class="img-fluid">
</details>
<details>
<summary>
Illustration de lâ€™horizon vers lequel on se dirige
</summary>
<img src="../workflow2.png" class="img-fluid">
</details>
<section id="partie-0-initialisation-du-projet" class="level1">
<h1>Partie 0 : initialisation du projet</h1>
<section id="etape-1-forker-le-dÃ©pÃ´t-dexemple-et-crÃ©er-une-branche-de-travail" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-forker-le-dÃ©pÃ´t-dexemple-et-crÃ©er-une-branche-de-travail">Etape 1 : forker le dÃ©pÃ´t dâ€™exemple et crÃ©er une branche de travail</h2>
<ul>
<li><p>Ouvrir un service <code>VSCode</code> sur le <a href="https://datalab.sspcloud.fr/home">SSP Cloud</a>. Vous pouvez aller dans la page <code>My Services</code> et cliquer sur <code>New service</code>. Sinon, vous pouvez lancer le service en cliquant directement <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?autoLaunch=false">ici</a>.</p></li>
<li><p>GÃ©nÃ©rer un jeton dâ€™accÃ¨s (<em>token</em>) sur <code>GitHub</code> afin de permettre lâ€™authentification en ligne de commande Ã  votre compte. La procÃ©dure est dÃ©crite <a href="https://docs.sspcloud.fr/onyxia-guide/controle-de-version#creer-un-jeton-dacces-token">ici</a>. Garder le jeton gÃ©nÃ©rÃ© de cÃ´tÃ©.</p></li>
<li><p>Forker le dÃ©pÃ´t <code>Github</code> : <a href="https://github.com/ensae-reproductibilite/application-correction">https://github.com/ensae-reproductibilite/application-correction</a></p></li>
<li><p>ClÃ´ner <strong>votre</strong> dÃ©pÃ´t <code>Github</code> en utilisant le terminal depuis <code>Visual Studio</code> (<code>Terminal &gt; New Terminal</code>) :</p></li>
</ul>
<pre class="shell"><code>$ git clone https://&lt;TOKEN&gt;@github.com/&lt;USERNAME&gt;/ensae-reproductibilite-application-correction.git</code></pre>
<p>oÃ¹ <code>&lt;TOKEN&gt;</code> et <code>&lt;USERNAME&gt;</code> sont Ã  remplacer, respectivement, par le jeton que vous avez gÃ©nÃ©rÃ© prÃ©cÃ©demment et votre nom dâ€™utilisateur.</p>
<ul>
<li>Se placer avec le terminal dans le dossier en question :</li>
</ul>
<pre class="shell"><code>$ cd ensae-reproductibilite-application-correction</code></pre>
</section>
</section>
<section id="partie-1-qualitÃ©-du-script" class="level1">
<h1>Partie 1 : qualitÃ© du script</h1>
<p>Cette premiÃ¨re partie vise Ã  <strong>rendre le projet conforme aux bonnes pratiques</strong> prÃ©sentÃ©es dans le cours.</p>
<p>Elle fait intervenir les notions suivantes :</p>
<ul>
<li>Utilisation du <strong>terminal</strong> (voir <a href="../chapters/linux-101.html">Linux 101</a>) ;</li>
<li><strong>QualitÃ© du code</strong> (voir <a href="../chapters/code-quality.html">QualitÃ© du code</a>) ;</li>
<li><strong>Architecture de projets</strong> (voir <a href="../chapters/projects-architecture.html">Architecture des projets</a>) ;</li>
<li><strong>ContrÃ´le de version</strong> avec <code>Git</code> (voir <a href="../chapters/git.html">Rappels <code>Git</code></a>) ;</li>
<li><strong>Travail collaboratif</strong> avec <code>Git</code> et <code>GitHub</code> (voir <a href="../chapters/git.html">Rappels <code>Git</code></a>).</li>
</ul>
<p>Le plan de la partie est le suivant :</p>
<!----
0. :zero: _Forker_ le dÃ©pÃ´t et crÃ©er une branche de travail
1. :one: S'assurer que le _notebook_ s'exÃ©cute correctement
2. :two: Modularisation : mise en fonctions et mise en module
3. :three: Utiliser un `main` script
4. :four:  Appliquer les standards de qualitÃ© de code
5. :five: Adopter une architecture standardisÃ©e de projet
6. :six: Fixer l'environnement d'exÃ©cution
7. :seven: Stocker les donnÃ©es de maniÃ¨re externe
8. :eight: Nettoyer le projet `Git`
9. :nine: Ouvrir une *pull request* sur le dÃ©pÃ´t du projet.
------------->
<p>Nous allons partir de ce <em>Notebook</em> <code>Jupyter</code>, que vous pouvez prÃ©visualiser voire tester en cliquant sur lâ€™un des liens suivants:</p>
<p><a href="https://datalab.sspcloud.fr/launcher/ide/jupyter-python?autoLaunch=false&amp;init.personalInit=%C2%ABhttps%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fensae-reproductibilite-website%2Fmaster%2Fpreview-notebook.sh%C2%BB" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/SSPcloud-Tester%20notebook%20sur%20SSP--cloud-informational&amp;color=yellow?logo=Python" alt="Onyxia"></a> <a href="http://colab.research.google.com/github/linogaliana/ensae-reproductibilite-application/blob/main/titanic.ipynb" target="_blank" rel="noopener"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<section id="etape-1-sassurer-que-le-script-sexÃ©cute-correctement" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-sassurer-que-le-script-sexÃ©cute-correctement">Etape 1 : sâ€™assurer que le script sâ€™exÃ©cute correctement</h2>
<p>On va partir du fichier <code>notebook.py</code> qui reprend le contenu du <em>notebook</em><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> mais dans un script classique.</p>
<p>La premiÃ¨re Ã©tape est simple, mais souvent oubliÃ©e : <strong>vÃ©rifier que le code fonctionne correctement</strong>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 1: corriger les erreurs
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Ouvrir dans <code>VSCode</code> le script <code>titanic.py</code> ;</li>
<li>ExÃ©cuter le script ligne Ã  ligne pour dÃ©tecter les erreurs ;</li>
<li>Corriger les deux erreurs qui empÃªchent la bonne exÃ©cution ;</li>
<li>VÃ©rifier le fonctionnement du script en utilisant la ligne de commande</li>
</ul>
<pre class="shell"><code>python titanic.py</code></pre>
</div>
</div>
<p>Il est maintenant temps de <em>commit</em> les changements effectuÃ©s avec <code>Git</code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> :</p>
<pre class="shell"><code>$ git add titanic.py
$ git commit -m "Corrige l'erreur qui empÃªchait l'exÃ©cution"
$ git push</code></pre>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli1</code></pre>
<p>ou</p>
<p><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application1/titanic.py">Script <em>checkpoint</em></a></p>
</div>
</div>
</div>
</section>
<section id="etape-2-utiliser-un-linter-puis-un-formatter" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-utiliser-un-linter-puis-un-formatter">Etape 2: utiliser un <em>linter</em> puis un <em>formatter</em></h2>
<p>On va maintenant amÃ©liorer la qualitÃ© de notre code en appliquant les standards communautaires. Pour cela, on va utiliser le <em>linter</em> classique <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Nâ€™hÃ©sitez pas Ã  taper un code dâ€™erreur sur un moteur de recherche pour obtenir plus dâ€™informations si jamais le message nâ€™est pas clair !</p>
</div>
</div>
<p>Pour appliquer le <em>linter</em> Ã  un script <code>.py</code>, la syntaxe Ã  entrer dans le terminal est la suivante :</p>
<pre class="shell"><code>$ pylint mon_script.py</code></pre>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a> sont des <em>packages</em> <code>Python</code> qui sâ€™utilisent principalement en ligne de commande.</p>
<p>Si vous avez une erreur qui suggÃ¨re que votre terminal ne connait pas <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> ou <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a>, nâ€™oubliez pas dâ€™exÃ©cuter la commande <code>pip install pylint</code> ou <code>pip install black</code>.</p>
</div>
</div>
<p>Le <em>linter</em> renvoie alors une sÃ©rie dâ€™irrÃ©gularitÃ©s, en prÃ©cisant Ã  chaque fois la ligne de lâ€™erreur et le message dâ€™erreur associÃ© (ex : mauvaise identation). Il renvoie finalement une note sur 10, qui estime la qualitÃ© du code Ã  lâ€™aune des standards communautaires Ã©voquÃ©s dans la partie <a href="../chapters/code-quality.html">QualitÃ© du code</a>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 2: rendre lisible le script
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Diagnostiquer et Ã©valuer la qualitÃ© de <code>titanic.py</code> avec <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a>. Regarder la note obtenue.</li>
<li>Utiliser <code>black titanic.py --diff --color</code> pour observer les changements de forme que va induire lâ€™utilisation du <em>formatter</em> <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a></li>
<li>Appliquer le <em>formatter</em> <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a></li>
<li>RÃ©utiliser <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> pour diagnostiquer lâ€™amÃ©lioration de la qualitÃ© du script et le travail qui reste Ã  faire.</li>
<li>Comme la majoritÃ© du travail restant est Ã  consacrer aux imports:
<ul>
<li>Mettre tous les <em>imports</em> ensemble en dÃ©but de script</li>
<li>Retirer les <em>imports</em> redondants en sâ€™aidant des diagnostics de votre Ã©diteur</li>
<li>RÃ©ordonner les <em>imports</em> si <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> vous indique de le faire</li>
<li>Corriger les derniÃ¨res fautes formelles suggÃ©rÃ©es par <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a></li>
</ul></li>
<li>DÃ©limiter des parties dans votre code pour rendre sa structure plus lisible</li>
</ul>
</div>
</div>
<p>Le code est maintenant lisible, il obtient Ã  ce stade une note formelle proche de 10. Mais il nâ€™est pas encore totalement intelligible ou fiable. Il y a notamment beaucoup de redondance de code auxquelles nous allons nous attaquer par la suite. NÃ©anmoins, avant cela, occupons-nous de mieux gÃ©rer certains paramÃ¨tres du script: jetons dâ€™API et chemin des fichiers.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli2</code></pre>
<p>ou</p>
<p><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application2/titanic.py"><code>titanic.py</code></a></p>
</div>
</div>
</div>
</section>
<section id="etape-3-gestion-des-paramÃ¨tres" class="level2">
<h2 class="anchored" data-anchor-id="etape-3-gestion-des-paramÃ¨tres">Etape 3: gestion des paramÃ¨tres</h2>
<p>Lâ€™exÃ©cution du code et les rÃ©sultats obtenus dÃ©pendent de certains paramÃ¨tres. Lâ€™Ã©tude de rÃ©sultats alternatifs, en jouant sur des variantes des paramÃ¨tres, est Ã  ce stade compliquÃ©e car il est nÃ©cessaire de parcourir le code pour trouver ces paramÃ¨tres. De plus, certains paramÃ¨tres personnels comme des jetons dâ€™API ou des mots de passe nâ€™ont pas vocation Ã  Ãªtre prÃ©sents dans le code.</p>
<p>Il est plus judicieux de considÃ©rer ces paramÃ¨tres comme des variables dâ€™entrÃ©e du script. Cela peut Ãªtre fait de deux maniÃ¨res:</p>
<ol type="1">
<li>Avec des arguments optionnels appelÃ©s depuis la ligne de commande. Cela peut Ãªtre pratique pour mettre en oeuvre des tests automatisÃ©s<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> mais nâ€™est pas forcÃ©ment pertinent pour toutes les variables. Nous allons montrer cet usage avec le nombre dâ€™arbres de notre <em>random forest</em> ;</li>
<li>En utilisant un fichier de configuration dont les valeurs sont importÃ©es dans le script principal. Nous allons le mettre en oeuvre pour deux types de fichiers: les Ã©lÃ©ments de configuration Ã  partager et ceux Ã  conserver pour soi mais pouvant servir.</li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 3: ParamÃ©trisation du script
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>En sâ€™inspirant de <a href="https://stackoverflow.com/a/69377311/9197726">cette rÃ©ponse</a>, crÃ©er une variable <code>n_trees</code> qui peut Ã©ventuellement Ãªtre paramÃ©trÃ©e en ligne de commande et dont la valeur par dÃ©faut est 20.</li>
<li>Tester cette paramÃ©trisation en ligne de commande avec la valeur par dÃ©faut puis 2, 10 et 50 arbres</li>
<li>RepÃ©rer le jeton dâ€™API dans le code. Retirer le jeton dâ€™API du code et crÃ©er Ã  la racine du projet un fichier YAML nommÃ© <code>secrets.yaml</code> oÃ¹ vous Ã©crivez ce secret sous la forme <code>key: value</code></li>
<li>Pour Ã©viter dâ€™avoir Ã  le faire plus tard, crÃ©er une fonction <code>import_yaml_config</code> qui prend en argument le chemin dâ€™un fichier <code>YAML</code> et renvoie le contenu de celui-ci en <em>output</em>. Vous pouvez suivre le conseil du chapitre sur la <a href="../chapters/code-quality.html">QualitÃ© du code</a> en adoptant le <em>type hinting</em>.</li>
<li>CrÃ©er la variable <code>API_TOKEN</code> ayant la valeur stockÃ©e dans <code>secrets.yaml</code><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</li>
<li>Tester en ligne de commande que lâ€™exÃ©cution du fichier est toujours sans erreur</li>
<li>Refaire un diagnostic avec <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et corriger les Ã©ventuels messages.</li>
<li>CrÃ©er un fichier <code>config.yaml</code> stockant trois informations: le chemin des donnÃ©es dâ€™entraÃ®nement, des donnÃ©es de test et la rÃ©partition train/test utilisÃ©e dans le code. CrÃ©er les variables correspondantes dans le code aprÃ¨s avoir utilisÃ© <code>import_yaml_config</code></li>
<li>CrÃ©er un fichier <code>.gitignore</code>. Ajouter dans ce fichier <code>secrets.yaml</code> car il ne faut pas committer ce fichier.</li>
<li>CrÃ©er un fichier <code>README.md</code> oÃ¹ vous indiquez quâ€™il faut crÃ©er un fichier <code>secrets.yaml</code> pour pouvoir utiliser lâ€™API.</li>
</ol>
<details>
<summary>
Indice si vous ne trouvez pas comment lire un fichier <code>YAML</code>
</summary>
<p>Si le fichier sâ€™appelle <code>toto.yaml</code>, vous pouvez lâ€™importer de cette maniÃ¨re:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"toto.yaml"</span>, <span class="st">"r"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> stream:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    dict_config <span class="op">=</span> yaml.safe_load(stream)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli3</code></pre>
<p>ou</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/titanic.py"><code>titanic.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/readme.md"><code>README.md</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/config.yaml"><code>config.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/secrets.yaml"><code>secrets.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/.gitignore"><code>.gitignore</code></a></li>
</ul>
</div>
</div>
</div>
</section>
<section id="etape-4-adopter-la-programmation-fonctionnelle" class="level2">
<h2 class="anchored" data-anchor-id="etape-4-adopter-la-programmation-fonctionnelle">Etape 4 : Adopter la programmation fonctionnelle</h2>
<p>Nous allons <strong>mettre en fonctions les parties importantes de lâ€™analyse, et les mettre dans un module afin de pouvoir les importer directement depuis le notebook</strong>.</p>
<p>Cet exercice Ã©tant chronophage, il nâ€™est <strong>pas obligatoire de le rÃ©aliser en entier</strong>. Lâ€™important est de comprendre la dÃ©marche et dâ€™adopter frÃ©quemment une approche fonctionnelle<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. Pour obtenir une chaine entiÃ¨rement fonctionnalisÃ©e, vous pouvez reprendre le <em>checkpoint</em>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 4: adoption des standards de programmation fonctionnelle
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>CrÃ©er une fonction qui importe les donnÃ©es dâ€™entraÃ®nement (<code>train.csv</code>) et de test (<code>test.csv</code>) et renvoie des <code>DataFrames</code> <code>Pandas</code> ;</li>
<li>En fonction du temps disponible, crÃ©er plusieurs fonctions pour rÃ©aliser les Ã©tapes de <em>feature engineering</em>:
<ul>
<li>La crÃ©ation de la variable <em>â€œTitleâ€</em> peut Ãªtre automatisÃ©e en vertu du principe <em>â€œdo not repeat yourselfâ€</em><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</li>
<li>Regrouper ensemble les <code>fillna</code> et essayer de crÃ©er une fonction gÃ©nÃ©ralisant lâ€™opÃ©ration.</li>
<li>Les <em>label encoders</em> peuvent Ãªtre transformÃ©s en deux fonctions: une premiÃ¨re pour encoder une colonne puis une seconde qui utilise la premiÃ¨re de maniÃ¨re rÃ©pÃ©tÃ©e pour encoder plusieurs colonnes. <em>Remarquez les erreurs de copier-coller que cela corrige</em></li>
<li>Finaliser les derniÃ¨res transformations avec des fonctions</li>
</ul></li>
<li>CrÃ©er une fonction qui rÃ©alise le <em>split train/test</em> de validation en fonction dâ€™un paramÃ¨tre reprÃ©sentant la proportion de lâ€™Ã©chantillon de test.</li>
<li>CrÃ©er une fonction qui entraÃ®ne et Ã©value un classifieur <code>RandomForest</code>, et qui prend en paramÃ¨tre le nombre dâ€™arbres (<code>n_estimators</code>). La fonction doit imprimer Ã  la fin la performance obtenue et la matrice de confusion.</li>
<li>DÃ©placer toutes les fonctions ensemble, en dÃ©but de script.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Le fait dâ€™appliquer des fonctions a dÃ©jÃ  amÃ©liorÃ© la fiabilitÃ© du processus en rÃ©duisant le nombre dâ€™erreurs de copier-coller. NÃ©anmoins, pour vraiment fiabiliser le processus, il faudrait utiliser un <em>pipeline</em> de transformations de donnÃ©es.</p>
<p>Ceci nâ€™est pas encore au programme du cours mais le sera dans une prochaine version.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli4</code></pre>
<p>ou</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application4/titanic.py"><code>titanic.py</code></a></li>
</ul>
<p>Les autres fichiers inchangÃ©s:</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/readme.md"><code>README.md</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/config.yaml"><code>config.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/secrets.yaml"><code>secrets.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/.gitignore"><code>.gitignore</code></a></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="partie2" class="level1">
<h1>Partie 2 : adoption dâ€™une structure modulaire</h1>
<p>Dans la partie prÃ©cÃ©dente, on a appliquÃ© de maniÃ¨re incrÃ©mentale de nombreuses bonnes pratiques vues tout au long du cours. Ce faisant, on sâ€™est dÃ©jÃ  considÃ©rablement rapprochÃ©s dâ€™un possible partage du code : celui-ci est lisible et intelligible. Le code est proprement versionnÃ© sur un dÃ©pÃ´t <code>GitHub</code>.</p>
<details>
<summary>
Illustration de lâ€™Ã©tat actuel du projet
</summary>
<img src="../schema_post_appli4.png" class="img-fluid">
</details>
<p>NÃ©anmoins, la structure du projet nâ€™est pas encore normalisÃ©e. De plus, lâ€™adoption dâ€™une structure plus modulaire facilitera la comprÃ©hension de la chaine de traitement.</p>
<section id="etape-1-modularisation" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-modularisation">Etape 1 : modularisation</h2>
<p>Fini le temps de lâ€™expÃ©rimentation : on va maintenant essayer de se passer complÃ¨tement du <em>notebook</em>. Pour cela, on va utiliser un <code>main</code> script, câ€™est Ã  dire un script qui reproduit lâ€™analyse en important et en exÃ©cutant les diffÃ©rentes fonctions dans lâ€™ordre attendu.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 5: modularisation
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>DÃ©placer les fonctions dans une sÃ©rie de fichiers dÃ©diÃ©s:
<ul>
<li><code>import_data.py</code>: fonctions dâ€™import de donnÃ©es</li>
<li><code>build_features.py</code>: fonctions regroupant les Ã©tapes de <em>feature engineering</em></li>
<li><code>train_evaluate.py</code>: fonctions dâ€™entrainement et dâ€™Ã©valuation du modÃ¨le</li>
</ul></li>
<li>SpÃ©cifier les dÃ©pendances (i.e.&nbsp;les packages Ã  importer) dans les modules pour que ceux-ci puissent sâ€™exÃ©cuter indÃ©pendamment ;</li>
<li>Renommer <code>titanic.py</code> en <code>main.py</code> pour suivre la convention de nommage des projets <code>Python</code> ;</li>
<li>Importer les fonctions nÃ©cessaires Ã  partir des modules. âš ï¸ Ne pas utiliser <code>from XXX import *</code>, ce nâ€™est pas une bonne pratique !</li>
<li>VÃ©rifier que tout fonctionne bien en exÃ©cutant le <em>script</em> <code>main</code> Ã  partir de la ligne de commande :</li>
</ul>
<pre class="shell"><code>$ python main.py</code></pre>
</div>
</div>
<p>On dispose maintenant dâ€™une application <code>Python</code> fonctionnelle. NÃ©anmoins, le projet est certes plus fiable mais sa structuration laisse Ã  dÃ©sirer et il serait difficile de rentrer Ã  nouveau dans le projet dans quelques temps.</p>
<details>
<summary>
Etat actuel du projet ğŸ™ˆ
</summary>
<pre class="shell"><code>â”œâ”€â”€ README.md
â”œâ”€â”€ train.csv
â”œâ”€â”€ test.csv
â”œâ”€â”€ .gitignore
â”œâ”€â”€ config.yaml
â”œâ”€â”€ secrets.yaml
â”œâ”€â”€ import_data.py
â”œâ”€â”€ build_features.py
â”œâ”€â”€ train_evaluate.py
â””â”€â”€main.py</code></pre>
</details>
<p>Comme cela est expliquÃ© dans la partie <a href="../chapters/projects-architecture.html">Structure des projets</a>, on va adopter une structure certes arbitraire mais qui va faciliter lâ€™autodocumentation de notre projet.</p>
<p>De plus, une telle structure va faciliter des Ã©volutions optionnelles comme la packagisation du projet. Passer dâ€™une structure modulaire bien faite Ã  un <em>package</em> est quasi-immÃ©diat en <code>Python</code>.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli5</code></pre>
<p>ou</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/build_features.py"><code>build_features.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/import_data.py"><code>import_data.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/train_evaluate.py"><code>train_evaluate.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/main.py"><code>main.py</code></a></li>
</ul>
<p>Les autres fichiers inchangÃ©s:</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/readme.md"><code>README.md</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/config.yaml"><code>config.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/secrets.yaml"><code>secrets.yaml</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application3/.gitignore"><code>.gitignore</code></a></li>
</ul>
</div>
</div>
</div>
</section>
<section id="etape-2-adopter-une-architecture-standardisÃ©e-de-projet" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-adopter-une-architecture-standardisÃ©e-de-projet">Etape 2 : adopter une architecture standardisÃ©e de projet</h2>
<p>On va maintenant modifier lâ€™architecture de notre projet pour la rendre plus standardisÃ©e. Pour cela, on va sâ€™inspirer des structures <a href="https://cookiecutter.readthedocs.io/en/stable/"><code>cookiecutter</code></a> qui gÃ©nÃ¨rent des <em>templates</em> de projet.</p>
<p>On va sâ€™inspirer de la structure du <a href="https://drivendata.github.io/cookiecutter-data-science/"><em>template datascience</em></a> dÃ©veloppÃ© par la communautÃ©.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Lâ€™idÃ©e de <a href="https://cookiecutter.readthedocs.io/en/stable/"><code>cookiecutter</code></a> est de proposer des <em>templates</em> que lâ€™on utilise pour <strong>initialiser</strong> un projet, afin de bÃ¢tir Ã  lâ€™avance une structure Ã©volutive. La syntaxe Ã  utiliser dans ce cas est la suivante :</p>
<pre class="shell"><code>$ pip install cookiecutter
$ cookiecutter https://github.com/drivendata/cookiecutter-data-science</code></pre>
<p>Ici, on a dÃ©jÃ  un projet, on va donc faire les choses dans lâ€™autre sens : on va sâ€™inspirer de la structure proposÃ©e afin de rÃ©organiser celle de notre projet selon les standards communautaires.</p>
</div>
</div>
<p>En sâ€™inspirant du <em>cookiecutter data science</em> on va adopter la structure suivante:</p>
<pre class="shell"><code>ensae-reproductibilite-application
â”œâ”€â”€ main.py
â”œâ”€â”€ README.md
â”œâ”€â”€ data
â”‚   â””â”€â”€ raw
â”‚       â”œâ”€â”€ test.csv
â”‚       â””â”€â”€ train.csv
â”œâ”€â”€ configuration
â”‚   â”œâ”€â”€ secrets.yaml
â”‚   â””â”€â”€ config.yaml
â”œâ”€â”€ notebooks
â”‚   â””â”€â”€ titanic.ipynb
â””â”€â”€ src
    â”œâ”€â”€ data
    â”‚   â””â”€â”€ import_data.py
    â”œâ”€â”€ features
    â”‚   â””â”€â”€ build_features.py
    â””â”€â”€ models
        â””â”€â”€ train_evaluate.py</code></pre>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 6: adopter une structure lisible
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><em>(optionnel)</em> Analyser et comprendre la <a href="https://drivendata.github.io/cookiecutter-data-science/#directory-structure">structure de projet</a> proposÃ©e par le template</li>
<li>Modifier lâ€™arborescence du projet selon le modÃ¨le</li>
<li>Adapter les scripts et les fichiers de configuration Ã  la nouvelle arborescence</li>
<li>Ajouter le dossier <strong>pycache</strong> au <code>.gitignore</code><a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> et le dossier <code>data</code></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli6</code></pre>
<p>ou</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/build_features.py"><code>build_features.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/import_data.py"><code>import_data.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/train_evaluate.py"><code>train_evaluate.py</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application5/main.py"><code>main.py</code></a></li>
</ul>
<p>Les autres fichiers sont inchangÃ©s, Ã  lâ€™exception de leur emplacement.</p>
</div>
</div>
</div>
<section id="etape-3-indiquer-lenvironnement-minimal-de-reproductibilitÃ©" class="level3">
<h3 class="anchored" data-anchor-id="etape-3-indiquer-lenvironnement-minimal-de-reproductibilitÃ©">Etape 3: indiquer lâ€™environnement minimal de reproductibilitÃ©</h3>
<p>Le script <code>main.py</code> nÃ©cessite un certain nombre de packages pour Ãªtre fonctionnel. Chez vous les packages nÃ©cessaires sont bien sÃ»r installÃ©s mais Ãªtes-vous assurÃ© que câ€™est le cas chez la personne qui testera votre code ?</p>
<p>Afin de favoriser la portabilitÃ© du projet, il est dâ€™usage de <em>â€œfixer lâ€™environnementâ€</em>, câ€™est-Ã -dire dâ€™indiquer dans un fichier toutes les dÃ©pendances utilisÃ©es ainsi que leurs version. Nous proposons de crÃ©er un fichier <code>requirements.txt</code> minimal, sur lequel nous reviendrons dans la partie consacrÃ©e aux environnements reproductibles.</p>
<p>Le fichier <code>requirements.txt</code> est conventionnellement localisÃ© Ã  la racine du projet. Ici on ne va pas fixer les versions, on raffinera ce fichier plus tard.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 7: crÃ©ation du <code>requirements.txt</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>CrÃ©er un fichier <code>requirements.txt</code> avec la liste des packages nÃ©cessaires</li>
<li>Ajouter une indication dans <code>README.md</code> sur lâ€™installation des <em>packages</em> grÃ¢ce au fichier <code>requirements.txt</code></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-19-contents" aria-controls="callout-19" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-19" class="callout-19-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli7</code></pre>
<p>ou</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application7/requirements.txt"><code>requirements.txt</code></a></li>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application7/README.md"><code>README.md</code></a></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="stockageS3" class="level2">
<h2 class="anchored" data-anchor-id="stockageS3">Etape 3 : stocker les donnÃ©es de maniÃ¨re externe</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour mettre en oeuvre cette Ã©tape, il peut Ãªtre utile de comprendre un peu comme fonctionne le SSP Cloud. Vous devrez suivre la <a href="https://docs.sspcloud.fr/onyxia-guide/stockage-de-donnees">documentation du SSP Cloud</a> pour la rÃ©aliser. Une aide-mÃ©moire est Ã©galement disponible dans le cours de 2e annÃ©e de lâ€™ENSAE <a href="https://linogaliana-teaching.netlify.app/reads3/#">Python pour la data science</a></p>
</div>
</div>
<p>Comme on lâ€™a vu dans le cours (<a href="../chapters/project-structure.html">partie structure des projets</a>), les donnÃ©es ne sont pas censÃ©es Ãªtre versionnÃ©es sur un projet <code>Git</code>.</p>
<p>Lâ€™idÃ©al pour Ã©viter cela tout en maintenant la reproductibilitÃ© est dâ€™utiliser une solution de stockage externe. On va utiliser pour cela <code>MinIO</code>, la solution de stockage de type <code>S3</code> offerte par le SSP Cloud.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 8: utilisation dâ€™un systÃ¨me de stockage distant
</div>
</div>
<div class="callout-body-container callout-body">
<p>A partir de la ligne de commande, utiliser lâ€™utilitaire <a href="https://min.io/docs/minio/linux/reference/minio-mc.html">MinIO</a> pour copier les donnÃ©es <code>data/raw/train.csv</code> et <code>data/raw/test.csv</code> vers votre bucket personnel, respectivement dans les dossiers <code>ensae-reproductibilite/data/raw/train.csv</code> et <code>ensae-reproductibilite/data/raw/test.csv</code>.</p>
<details>
<summary>
Indice
</summary>
<p>Structure Ã  adopter:</p>
<pre class="shell"><code>$ mc cp data/raw/train.csv s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/train.csv
$ mc cp data/raw/test.csv s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/test.csv</code></pre>
en modifiant lâ€™emplacement de votre bucket personnel
</details>
<ul>
<li>Pour se simplifier la vie, on va utiliser des URL de tÃ©lÃ©chargement des fichiers (comme si ceux-ci Ã©taient sur nâ€™importe quel espace de stockage) plutÃ´t que dâ€™utiliser une librairie <code>S3</code> compatible comme <code>boto3</code> ou <code>s3fs</code>. Pour cela, en ligne de commande, faire:</li>
</ul>
<pre class="shell"><code>mc anonymous set download s3/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/</code></pre>
<p>en modifiant <code>&lt;BUCKET_PERSONNEL&gt;</code>. Les URL de tÃ©lÃ©chargement seront de la forme <code>https://minio.lab.sspcloud.fr/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/test.csv</code> et <code>https://minio.lab.sspcloud.fr/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/train.csv</code></p>
<ul>
<li>Modifier <code>configuration.yaml</code> pour utiliser directement les URL dans lâ€™import</li>
<li>Supprimer les fichiers <code>.csv</code> du dossier <code>data</code> de votre projet, on nâ€™en a plus besoin vu quâ€™on les importe de lâ€™extÃ©rieur</li>
<li>VÃ©rifier le bon fonctionnement de votre application</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli8</code></pre>
<p>ou</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application8/config.yaml"><code>config.yaml</code></a></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="partie-2bis-packagisation-de-son-projet-optionnel" class="level1">
<h1>Partie 2bis: packagisation de son projet (optionnel)</h1>
<p>Cette sÃ©rie dâ€™actions nâ€™est pas forcÃ©ment pertinente pour tous les projets. Elle fait un peu la transition entre la modularitÃ© et la portabilitÃ©.</p>
<section id="etape-1-proposer-des-tests-unitaires-optionnel" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-proposer-des-tests-unitaires-optionnel">Etape 1 : proposer des tests unitaires (optionnel)</h2>
<p>Notre code comporte un certain nombre de fonctions gÃ©nÃ©riques. On peut vouloir tester leur usage sur des donnÃ©es standardisÃ©es, diffÃ©rentes de celles du Titanic.</p>
<p>MÃªme si la notion de tests unitaires prend plus de sens dans un <em>package</em>, nous pouvons proposer dans le projet des exemples dâ€™utilisation de la fonction, ceci peut Ãªtre pÃ©dagogique.</p>
<p>Nous allons utiliser <a href="https://docs.python.org/3/library/unittest.html"><code>unittest</code></a> pour effectuer des tests unitaires. Cette approche nÃ©cessite une maÃ®trise de la programmation orientÃ©e objet.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 9: test unitaire <em>(optionnel)</em>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Dans le dossier <code>src/data/</code>, crÃ©er un fichier <code>test_create_variable_title.py</code><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>.</p>
<p>En sâ€™inspirant de lâ€™<a href="https://docs.python.org/3/library/unittest.html#basic-example">exemple de base</a>, crÃ©er une classe <code>TestCreateVariableTitle</code> qui effectue les opÃ©rations suivantes:</p>
<ul>
<li><p>CrÃ©ation dâ€™une fonction <code>test_create_variable_title_default_variable_name</code> qui permet de comparer les objets suivants:</p>
<ul>
<li>CrÃ©ation dâ€™un <code>DataFrame</code> de test :</li>
</ul>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Name'</span>: [<span class="st">'Braund, Mr. Owen Harris'</span>, <span class="st">'Cumings, Mrs. John Bradley (Florence Briggs Thayer)'</span>,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Heikkinen, Miss. Laina'</span>, <span class="st">'Futrelle, Mrs. Jacques Heath (Lily May Peel)'</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Allen, Mr. William Henry'</span>, <span class="st">'Moran, Mr. James'</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'McCarthy, Mr. Timothy J'</span>, <span class="st">'Palsson, Master. Gosta Leonard'</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Johnson, Mrs. Oscar W (Elisabeth Vilhelmina Berg)'</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Nasser, Mrs. Nicholas (Adele Achem)'</span>],</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Age'</span>: [<span class="dv">22</span>, <span class="dv">38</span>, <span class="dv">26</span>, <span class="dv">35</span>, <span class="dv">35</span>, <span class="dv">27</span>, <span class="dv">54</span>, <span class="dv">2</span>, <span class="dv">27</span>, <span class="dv">14</span>],</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Survived'</span>: [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Utilisation de la fonction <code>create_variable_title</code> sur ce <code>DataFrame</code></li>
<li>Comparaison au <code>DataFrame</code> attendu:</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>expected_result <span class="op">=</span> pd.DataFrame({</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Title'</span>: [<span class="st">'Mr.'</span>, <span class="st">'Mrs.'</span>, <span class="st">'Miss.'</span>, <span class="st">'Mrs.'</span>, <span class="st">'Mr.'</span>, <span class="st">'Mr.'</span>, <span class="st">'Mr.'</span>, <span class="st">'Master.'</span>, <span class="st">'Mrs.'</span>, <span class="st">'Mrs.'</span>],</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Age'</span>: [<span class="dv">22</span>, <span class="dv">38</span>, <span class="dv">26</span>, <span class="dv">35</span>, <span class="dv">35</span>, <span class="dv">27</span>, <span class="dv">54</span>, <span class="dv">2</span>, <span class="dv">27</span>, <span class="dv">14</span>],</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Survived'</span>: [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Effectuer le test unitaire en ligne de commande avec <code>unittest</code>. Corriger le test unitaire en cas dâ€™erreur.</p></li>
<li><p>Si le temps le permet, proposer des variantes pour tenir compte de paramÃ¨tres (comme la variable <code>variable_name</code>) ou dâ€™exceptions (comme la gestion du cas <em>â€œDonaâ€</em>)</p></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Lorsquâ€™on effectue des tests unitaires, on cherche gÃ©nÃ©ralement Ã  tester le plus de lignes possibles de son code. On parle de taux de couverture (<em>coverage rate</em>) pour dÃ©signer la statistique mesurant cela.</p>
<p>Cela peut sâ€™effectuer de la maniÃ¨re suivante avec le package <a href="https://coverage.readthedocs.io/en/7.2.2/"><code>coverage</code></a>:</p>
<pre class="shell"><code>$ coverage run -m pytest test_create_variable_title.py
$ coverage report -m

Name                            Stmts   Miss  Cover   Missing
-------------------------------------------------------------
import_data.py                     15      6    60%   16-19, 31-34
test_create_variable_title.py      21      1    95%   54
-------------------------------------------------------------
TOTAL                              36      7    81%</code></pre>
<p>Le taux de couverture est souvent mis en avant par les gros projets comme indicateur de leur qualitÃ©. Il existe dâ€™ailleurs des badges <code>Github</code> dÃ©diÃ©s.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-25-contents" aria-controls="callout-25" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-25" class="callout-25-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli9</code></pre>
<p>ou</p>
<ul>
<li><a href="https://raw.githubusercontent.com/linogaliana/ensae-reproductibilite-application/main/checkpoints/application9/test_create_variable_title.py"><code>test_create_variable_title.py</code></a></li>
</ul>
<p>Les autres fichiers sont inchangÃ©s.</p>
</div>
</div>
</div>
</section>
<section id="etape-2-transformer-son-projet-en-package-optionnel" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-transformer-son-projet-en-package-optionnel">Etape 2 : transformer son projet en package (optionnel)</h2>
<p>Notre projet est modulaire, ce qui le rend assez simple Ã  transformer en package, en sâ€™inspirant du <code>cookiecutter</code> adaptÃ©, issu de <a href="https://py-pkgs.org/03-how-to-package-a-python#package-structure">cet ouvrage</a>.</p>
<details>
<summary>
Structure visÃ©e
</summary>
<pre class="shell"><code>ensae-reproductibilite-application
â”œâ”€â”€ docs                                    â” 
â”‚   â”œâ”€â”€ main.py                             â”‚ 
â”‚   â””â”€â”€ notebooks                           â”‚ Package documentation and examples
â”‚       â”œâ”€â”€ titanic.ipynb                   â”‚ 
â”œâ”€â”€ README.md                               â”˜ 
â”œâ”€â”€ pyproject.toml                          â” 
â”œâ”€â”€ requirements.txt                        â”‚
â”œâ”€â”€ src                                     â”‚
â”‚   â””â”€â”€ titanicml                           â”‚ Package source code, metadata,
â”‚       â”œâ”€â”€ __init__.py                     â”‚ and build instructions 
â”‚       â”œâ”€â”€ config.yaml                     â”‚
â”‚       â”œâ”€â”€ import_data.py                  â”‚
â”‚       â”œâ”€â”€ build_features.py               â”‚ 
â”‚       â””â”€â”€ train_evaluate.py               â”˜
â””â”€â”€ tests                                   â”
    â””â”€â”€ test_create_variable_title.py       â”˜ Package tests</code></pre>
</details>
<details>
<summary>
Rappel: structure actuelle
</summary>
<pre class="shell"><code>ensae-reproductibilite-application
â”œâ”€â”€ notebooks                                 
â”‚   â””â”€â”€ titanic.ipynb                  
â”œâ”€â”€ configuration                                 
â”‚   â””â”€â”€ config.yaml                  
â”œâ”€â”€ main.py                              
â”œâ”€â”€ README.md                 
â”œâ”€â”€ requirements.txt                      
â””â”€â”€ src 
    â”œâ”€â”€ data                                
    â”‚   â”œâ”€â”€ import_data.py                    
    â”‚   â””â”€â”€ test_create_variable_title.py      
    â”œâ”€â”€ features                           
    â”‚   â””â”€â”€ build_features.py      
    â””â”€â”€ models                          
        â””â”€â”€ train_evaluate.py              </code></pre>
</details>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 10: packagisation <em>(optionnel)</em>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>DÃ©placer les fichiers dans le dossier <code>src</code> pour respecter la nouvelle arborescence ;</li>
<li>Dans <code>src/titanicml</code>, crÃ©er un fichier vide <code>__init__.py</code><a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> ;</li>
<li>DÃ©placer le fichier de configuration dans le <em>package</em> (nÃ©cessaire Ã  la reproductibilitÃ©) ;</li>
<li>CrÃ©er le dossier <code>docs</code> et mettre les fichiers indiquÃ©s dedans</li>
<li>Modifier <code>src/titanicml/import_data.py</code> :
<ul>
<li>Ajouter la variable <code>config_file = os.path.join(os.path.dirname(__file__), "config.yaml")</code>. Cela permettra dâ€™utiliser directement le fichier ;</li>
<li>Proposer un argument par dÃ©faut Ã  la fonction <code>import_config_yaml</code> Ã©gal Ã  <code>config_file</code></li>
</ul></li>
<li>CrÃ©er un fichier <code>pyproject.toml</code> Ã  partir du contenu de <a href="https://github.com/linogaliana/ensae-reproductibilite-application/blob/main/checkpoints/application10/pyproject.toml">ce modÃ¨le de <code>pyproject</code></a><a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a></li>
<li>Installer le package en local avec <code>pip install .</code></li>
<li>Modifier le contenu de <code>docs/main.py</code> pour importer les fonctions de notre <em>package</em> <code>titanicml</code> et tester en ligne de commande notre fichier <code>main.py</code></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour crÃ©er la structure minimale dâ€™un <em>package</em>, le plus simple est dâ€™utiliser le <code>cookiecutter</code> adaptÃ©, issu de <a href="https://py-pkgs.org/03-how-to-package-a-python#package-structure">cet ouvrage</a>.</p>
<p>Comme on a dÃ©jÃ  une structure trÃ¨s modulaire, on va plutÃ´t recrÃ©er cette structure dans notre projet dÃ©jÃ  existant. En fait, il ne manque quâ€™un fichier essentiel, le principal distinguant un projet classique dâ€™un package : <code>pyproject.toml</code>.</p>
<pre class="shell"><code>cookiecutter https://github.com/py-pkgs/py-pkgs-cookiecutter.git</code></pre>
<details>
<summary>
DÃ©rouler pour voir les choix possibles
</summary>
<pre class="shell"><code>author_name [Monty Python]: Daffy Duck
package_name [mypkg]: titanicml
package_short_description []: Impressive Titanic survival analysis
package_version [0.1.0]: 
python_version [3.9]: 
Select open_source_license:
1 - MIT
2 - Apache License 2.0
3 - GNU General Public License v3.0
4 - Creative Commons Attribution 4.0
5 - BSD 3-Clause
6 - Proprietary
7 - None
Choose from 1, 2, 3, 4, 5, 6 [1]: 
Select include_github_actions:
1 - no
2 - ci
3 - ci+cd
Choose from 1, 2, 3 [1]:</code></pre>
</details>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-28-contents" aria-controls="callout-28" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-28" class="callout-28-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli10</code></pre>
</div>
</div>
</div>
</section>
</section>
<section id="partie3" class="level1">
<h1>Partie 3 : construction dâ€™un projet portable et reproductible</h1>
<p>Dans la partie prÃ©cÃ©dente, on a appliquÃ© de maniÃ¨re incrÃ©mentale de nombreuses bonnes pratiques vues dans les chapitres <a href="../chapters/code-quality.html">QualitÃ© du code</a> et <a href="../chapters/projects-architecture.html">Structure des projets</a> tout au long du cours.</p>
<p>Ce faisant, on sâ€™est dÃ©jÃ  considÃ©rablement rapprochÃ©s dâ€™une possible mise en production : le code est lisible, la structure du projet est normalisÃ©e et Ã©volutive, et le code est proprement versionnÃ© sur un dÃ©pÃ´t <code>GitHub</code>.</p>
<details>
<summary>
Illustration de lâ€™Ã©tat actuel du projet
</summary>
<img src="../schema_post_appli8.png" class="img-fluid">
</details>
<p>A prÃ©sent, nous avons une version du projet qui est largement partageable. Du moins en thÃ©orie, car la pratique est souvent plus compliquÃ©e : il y a fort Ã  parier que si vous essayez dâ€™exÃ©cuter votre projet sur un autre environnement (typiquement, votre ordinateur personnel), les choses ne se passent pas du tout comme attendu. Cela signifie quâ€™<strong>en lâ€™Ã©tat, le projet nâ€™est pas portable : il nâ€™est pas possible, sans modifications coÃ»teuses, de lâ€™exÃ©cuter dans un environnement diffÃ©rent de celui dans lequel il a Ã©tÃ© dÃ©veloppÃ©</strong>.</p>
<p>Dans cette seconde partie, nous allons voir comment <strong>normaliser lâ€™environnement dâ€™exÃ©cution afin de produire un projet portable</strong>. Autrement dit, nous nâ€™allons plus nous contenter de modularitÃ© mais allons rechercher la portabilitÃ©. On sera alors tout proche de pouvoir mettre le projet en production. On progressera dans lâ€™Ã©chelle de la reproductibilitÃ© de la maniÃ¨re suivante:</p>
<ul>
<li>:one: <a href="#anaconda"><strong>Environnements virtuels</strong></a> ;</li>
<li>:two: CrÃ©er un script shell qui permet, depuis un environnement minimal, de construire lâ€™application de A Ã  Z ;</li>
<li>:three: <a href="#docker"><strong>Images et conteneurs <code>Docker</code></strong></a>.</li>
</ul>
<p>Nous allons repartir de lâ€™application 8, câ€™est-Ã -dire dâ€™un projet modulaire mais qui nâ€™est pas, Ã  strictement parler, un package (objet des applications optionnelles suivantes 9 et 10).</p>
<p>Pour se replacer dans lâ€™Ã©tat du projet Ã  ce niveau, il est possible dâ€™utiliser le <em>tag</em> <em>ad hoc</em>.</p>
<pre class="shell"><code>git checkout appli8</code></pre>
<section id="anaconda" class="level2">
<h2 class="anchored" data-anchor-id="anaconda">Etape 1 : un environnement pour rendre le projet portable</h2>
<p>Pour quâ€™un projet soit portable, il doit remplir deux conditions:</p>
<ul>
<li>Ne pas nÃ©cessiter de dÃ©pendance qui ne soient pas renseignÃ©es quelque part</li>
<li>Ne pas proposer des dÃ©pendances inutiles, qui ne sont pas utilisÃ©es dans le cadre du projet.</li>
</ul>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Environnement virtuel</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Environnement conda</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>Lâ€™approche la plus lÃ©gÃ¨re est lâ€™environnement virtuel. Nous avons en fait implicitement dÃ©jÃ  commencÃ© Ã  aller vers cette direction en crÃ©ant un fichier <code>requirements.txt</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 11a: environnement virtuel <code>venv</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>ExÃ©cuter <code>pip freeze</code> en ligne de commande et observer la (trÃ¨s) longue liste de package</p></li>
<li><p>CrÃ©er lâ€™environnement virtuel <code>titanic</code> en sâ€™inspirant de <a href="https://packaging.python.org/en/latest/guides/installing-using-pip-and-virtual-environments/">la documentation officielle</a><a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a></p></li>
<li><p>Utiliser <code>ls</code> pour observer et comprendre le contenu du dossier <code>titanic/bin</code> installÃ©</p></li>
<li><p>Activer lâ€™environnement et vÃ©rifier lâ€™installation de <code>Python</code> maintenant utilisÃ©e par votre machine <!---source titanic/bin/activate && which python----></p></li>
<li><p>VÃ©rifier directement depuis la ligne de commande que <code>Python</code> exÃ©cute bien une commande avec:</p>
<pre class="shell"><code>python -c "print('Hello')"</code></pre></li>
<li><p>Faire la mÃªme chose mais avec <code>import pandas as pd</code></p></li>
<li><p>Installer les packages Ã  partir du <code>requirements.txt</code>. Tester Ã  nouveau <code>import pandas as pd</code> pour comprendre la diffÃ©rence.</p></li>
<li><p>ExÃ©cuter <code>pip freeze</code> et comprendre la diffÃ©rence avec la situation prÃ©cÃ©dente.</p></li>
<li><p>VÃ©rifier que le script <code>main.py</code> fonctionne bien. Sinon ajouter les <em>packages</em> manquants dans le <code>requirements.txt</code> et reprendre de maniÃ¨re itÃ©rative Ã  partir de la question 7</p></li>
<li><p>Ajouter le dossier <code>titanic/</code> au <code>.gitignore</code> pour ne pas ajouter ce dossier Ã  <code>Git</code></p></li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-30-contents" aria-controls="callout-30" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-30" class="callout-30-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli11a</code></pre>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>Les environnements <code>conda</code> sont plus lourds Ã  mettre en oeuvre que les environnements virtuels mais peuvent permettre un contrÃ´le plus formel des dÃ©pendances.</p>
<p><code>conda</code> est Ã  la fois un gestionnaire de packages (alternative Ã  <code>pip</code>) et dâ€™environnements virtuels. Lâ€™inconvÃ©nient de lâ€™utilisation de <code>conda</code> pour gÃ©rer les environnements virtuels est que cet outil est assez lent car lâ€™algorithme de vÃ©rification des conflits de version nâ€™est pas extrÃªmement rapide.</p>
<p>Pour cette raison, nous allons utiliser <a href="https://mamba.readthedocs.io/en/latest/user_guide/mamba.html"><code>mamba</code></a>, un utilitaire de gestion des environnements <code>conda</code> qui est plus rapide.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 11b: environnement <code>conda</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>ExÃ©cuter <code>conda env export</code> en ligne de commande et observer la (trÃ¨s) longue liste de package</p></li>
<li><p>Tester lâ€™utilisation dâ€™un package quâ€™on nâ€™utilise pas dans notre chaine de production, par exemple <code>seaborn</code>:</p>
<pre class="shell"><code>python -c "import seaborn as sns"</code></pre></li>
<li><p>CrÃ©er un environnement <code>titanic</code> avec <a href="https://mamba.readthedocs.io/en/latest/user_guide/mamba.html#quickstart"><code>mamba create</code></a> en listant les packages que vous aviez mis dans le <code>requirements.txt</code> et en ajoutant lâ€™option <code>-c conda-forge</code> Ã  la fin pour utiliser <a href="https://conda-forge.org/">la <em>conda forge</em></a></p></li>
<li><p>Activer lâ€™environnement et vÃ©rifier lâ€™installation de <code>Python</code> maintenant utilisÃ©e par votre machine <!---mamba activate titanic && which python----></p></li>
<li><p><em>(optionnel)</em> Utiliser <code>ls</code> dans le dossier parent de <code>Python</code> pour observer et comprendre le contenu de celui-ci</p></li>
<li><p>VÃ©rifier que cette fois <code>seaborn</code> nâ€™est pas installÃ© dans lâ€™environnement :</p>
<pre class="shell"><code>python -c "import seaborn as sns"</code></pre></li>
<li><p>ExÃ©cuter Ã  nouveau <code>conda env export</code> et comprendre la diffÃ©rence avec la situation prÃ©cÃ©dente<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a>.</p></li>
<li><p>VÃ©rifier que le script <code>main.py</code> fonctionne bien. Sinon utiliser <code>mamba install</code> avec les <em>packages</em> manquants jusquâ€™Ã  ce que la chaine de production fonctionne</p></li>
<li><p>CrÃ©er le fichier <code>environment.yaml</code> Ã  partir de <code>conda env export</code>:</p>
<pre class="shell"><code>conda env export &gt; environment.yaml</code></pre></li>
<li><p>Ajouter le dossier <code>titanic/</code> au <code>.gitignore</code> pour ne pas ajouter ce dossier Ã  <code>Git</code></p></li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-32-contents" aria-controls="callout-32" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-32" class="callout-32-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli11b</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="etape-2-construire-lenvironnement-de-notre-application-via-un-script-shell" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-construire-lenvironnement-de-notre-application-via-un-script-shell">Etape 2: construire lâ€™environnement de notre application via un script <code>shell</code></h2>
<p>Les environnements virtuels permettent de mieux spÃ©cifier les dÃ©pendances de notre projet, mais ne permettent pas de garantir une portabilitÃ© optimale. Pour cela, il faut recourir Ã  la technologie des conteneurs. Lâ€™idÃ©e est de construire une machine, en partant dâ€™une base quasi-vierge, qui permette de construire Ã©tape par Ã©tape lâ€™environnement nÃ©cessaire au bon fonctionnement de notre projet. Câ€™est le principe des conteneurs <code>Docker</code>.</p>
<p>Leur mÃ©thode de construction Ã©tant un peu difficile Ã  prendre en main au dÃ©but, nous allons passer par une Ã©tape intermÃ©diaire afin de bien comprendre le processus de production.</p>
<ul>
<li>Nous allons dâ€™abord crÃ©er un script <code>shell</code>, câ€™est Ã  dire une suite de commandes <code>Linux</code> permettant de construire lâ€™environnement Ã  partir dâ€™une machine vierge ;</li>
<li>Nous transformerons celui-ci en <code>Dockerfile</code> dans un deuxiÃ¨me temps. Câ€™est lâ€™objet de lâ€™Ã©tape suivante.</li>
</ul>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Environnement virtuel</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Environnement <code>conda</code></a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 12a : crÃ©er un fichier dâ€™installation de A Ã  Z
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>CrÃ©er un service <code>ubuntu</code> sur le SSP Cloud</li>
<li>Ouvrir un terminal</li>
<li>Cloner le dÃ©pÃ´t</li>
<li>Se placer dans le dossier du projet avec <code>cd</code></li>
<li>Se placer au niveau du checkpoint 11a avec <code>git checkout appli11a</code></li>
<li>Via lâ€™explorateur de fichiers, crÃ©er le fichier <code>install.sh</code> Ã  la racine du projet avec le contenu suivant:</li>
</ol>
<details>
<summary>
Script Ã  crÃ©er sous le nom <code>install.sh</code>
</summary>
<pre class="shell"><code>#!/bin/bash

# Install Python
apt-get -y update
apt-get install -y python3-pip python3-venv

# Create empty virtual environment
python3 -m venv titanic
source titanic/bin/activate

# Install project dependencies
pip install -r requirements.txt</code></pre>
</details>
<ol start="6" type="1">
<li>Changer les permissions sur le script pour le rendre exÃ©cutable</li>
</ol>
<pre class="shell"><code>chmod +x install.sh</code></pre>
<ol start="7" type="1">
<li>ExÃ©cuter le script depuis la ligne de commande avec des droits de super-utilisateur (nÃ©cessaires pour installer des <em>packages</em> via <code>apt</code>)</li>
</ol>
<pre class="shell"><code>sudo ./install.sh</code></pre>
<ol start="8" type="1">
<li>VÃ©rifier que le script <code>main.py</code> fonctionne correctement dans lâ€™environnement virtuel crÃ©Ã©</li>
</ol>
<pre class="shell"><code>source titanic/bin/activate
python3 main.py</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-34-contents" aria-controls="callout-34" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-34" class="callout-34-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli12a</code></pre>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 12b : crÃ©er un fichier dâ€™installation de A Ã  Z
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>CrÃ©er un service <code>ubuntu</code> sur le SSP Cloud en cliquant sur <a href="https://datalab.sspcloud.fr/launcher/inseefrlab-helm-charts-datascience/ubuntu?autoLaunch=false&amp;git.cache=%C2%AB36000%C2%BB&amp;git.repository=%C2%ABhttps%3A%2F%2Fgithub.com%2Flinogaliana%2Fensae-reproductibilite-application-correction.git%C2%BB">ce lien</a></li>
<li>Cloner le dÃ©pÃ´t et se placer au niveau du checkpoint 11b avec <code>git checkout appli11b</code></li>
<li>Se placer dans le dossier du projet avec <code>cd</code></li>
<li>On va se placer en super-utilisateur dans la ligne de commande en tapant</li>
</ol>
<pre class="shell"><code>sudo bash</code></pre>
<ol start="5" type="1">
<li>CrÃ©er le fichier <code>install.sh</code> avec le contenu suivant:</li>
</ol>
<details>
<summary>
Script Ã  crÃ©er sous le nom <code>install.sh</code>
</summary>
<pre class="shell"><code>apt-get -y update &amp;&amp; apt-get -y install wget

wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh &amp;&amp; \
    bash Miniconda3-latest-Linux-x86_64.sh -b -p /miniconda &amp;&amp; \
    rm -f Miniconda3-latest-Linux-x86_64.sh

PATH="/miniconda/bin:${PATH}"

# Create environment
conda install mamba -c conda-forge
mamba create -n titanic pandas PyYAML scikit-learn -c conda-forge
mamba activate titanic

PATH="/miniconda/envs/titanic/bin:${PATH}"

python main.py</code></pre>
</details>
<ol start="6" type="1">
<li>Changer les permissions sur le fichier</li>
</ol>
<pre class="shell"><code>chmod u+x ./install.sh</code></pre>
<ol start="7" type="1">
<li>ExÃ©cuter le script depuis la ligne de commande</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-36-contents" aria-controls="callout-36" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-36" class="callout-36-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli12b</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="docker" class="level2">
<h2 class="anchored" data-anchor-id="docker">Etape 3: conteneuriser lâ€™application avec <code>Docker</code></h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Cette application nÃ©cessite lâ€™accÃ¨s Ã  une version interactive de <code>Docker</code>. Il nâ€™y a pas beaucoup dâ€™instances en ligne disponibles.</p>
<p>Nous proposons deux solutions:</p>
<ul>
<li><a href="https://docs.docker.com/get-docker/">Installer <code>Docker</code></a> sur sa machine ;</li>
<li>Se rendre sur lâ€™environnement bac Ã  sable <em><a href="https://labs.play-with-docker.com">Play with Docker</a></em></li>
</ul>
</div>
</div>
<p>Maintenant quâ€™on sait que ce script prÃ©paratoire fonctionne, on va le transformer en <code>Dockerfile</code> (la syntaxe <code>Docker</code> est lÃ©gÃ¨rement diffÃ©rente de la syntaxe <code>Linux</code> classique). Puis on va le tester dans un environnement bac Ã  sable (pour ensuite pouvoir plus facilement automatiser la construction de lâ€™image <code>Docker</code> par la suite).</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 13: crÃ©ation de lâ€™image <code>Docker</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Se placer dans un environnement avec <code>Docker</code></p>
<ul>
<li>Dans le terminal <code>Linux</code>, cloner votre dÃ©pÃ´t <code>Github</code></li>
<li>CrÃ©er via la ligne de commande un fichier texte vierge nommÃ© <code>Dockerfile</code> (la majuscule au dÃ©but du mot est importante)</li>
</ul>
<details>
<summary>
Commande pour crÃ©er un <code>Dockerfile</code> vierge depuis la ligne de commande
</summary>
<pre class="shell"><code>touch Dockerfile</code></pre>
</details>
<ul>
<li>Ouvrir ce fichier via un Ã©diteur de texte et copier le contenu suivant dedans:</li>
</ul>
<details>
<summary>
Premier <code>Dockerfile</code>
</summary>
<pre class="shell"><code>FROM ubuntu:22.04

WORKDIR ${HOME}/titanic

# Install Python
RUN apt-get -y update &amp;&amp; \
    apt-get install -y python3-pip

# Install project dependencies
COPY requirements.txt .
RUN pip install -r requirements.txt

CMD ["python3", "main.py"]</code></pre>
</details>
<section id="construire-limage" class="level3">
<h3 class="anchored" data-anchor-id="construire-limage">Construire lâ€™image</h3>
<p>Le <code>Dockerfile</code> est la recette de construction de lâ€™image. La construction effective de lâ€™image Ã  partir de cette recette sâ€™appelle lâ€™Ã©tape de <code>build</code>.</p>
<ul>
<li>Utiliser <code>docker build</code> pour crÃ©er une image avec le tag <code>my-python-app</code></li>
</ul>
<pre class="shell"><code>docker build . -t my-python-app</code></pre>
<ul>
<li>VÃ©rifier les images dont vous disposez. Vous devriez avoir un rÃ©sultat proche de celui-ci :</li>
</ul>
<pre class="shell"><code>$ docker images

REPOSITORY      TAG       IMAGE ID       CREATED         SIZE
my-python-app   latest    c0dfa42d8520   6 minutes ago   836MB
ubuntu          25.04     825d55fb6340   6 days ago      77.8MB</code></pre>
</section>
<section id="tester-limage-dÃ©couverte-du-cache" class="level3">
<h3 class="anchored" data-anchor-id="tester-limage-dÃ©couverte-du-cache">Tester lâ€™image: dÃ©couverte du cache</h3>
<p>Lâ€™Ã©tape de <code>build</code> a fonctionnÃ©: une image a Ã©tÃ© construite.</p>
<p>Mais fait-elle effectivement ce que lâ€™on attend dâ€™elle ?</p>
<p>Pour le savoir, il faut passer Ã  lâ€™Ã©tape suivante, lâ€™Ã©tape de <code>run</code>.</p>
<pre class="shell"><code>$ docker run -it my-python-app

python3: can't open file '/~/titanic/main.py': [Errno 2] No such file or directory</code></pre>
<p>Le message dâ€™erreur est clair : <code>Docker</code> ne sait pas oÃ¹ trouver le fichier <code>main.py</code>. Dâ€™ailleurs, il ne connait pas non plus les autres fichiers de notre application qui sont nÃ©cessaires pour faire tourner le code: <code>config.yaml</code> et le dossier <code>src</code>.</p>
<ul>
<li>Avant lâ€™Ã©tape <code>CMD</code>, copier les fichiers nÃ©cessaires sur lâ€™image afin que lâ€™application dispose de tous les Ã©lÃ©ments nÃ©cessaires pour Ãªtre en mesure de fonctionner.</li>
</ul>
<details>
<summary>
Nouveau <code>Dockerfile</code>
</summary>
<pre class="shell"><code>FROM ubuntu:22.04

WORKDIR ${HOME}/titanic

# Install Python
RUN apt-get -y update &amp;&amp; \
    apt-get install -y python3-pip

# Install project dependencies
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY main.py .
COPY src ./src
COPY configuration ./configuration
CMD ["python3", "main.py"]</code></pre>
</details>
<ul>
<li><p>Refaire tourner lâ€™Ã©tape de <code>build</code></p></li>
<li><p>Refaire tourner lâ€™Ã©tape de <code>run</code>. A ce stade, la matrice de confusion doit fonctionner ğŸ‰. Vous avez crÃ©Ã© votre premiÃ¨re application reproductible !</p></li>
</ul>
</section>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ici, le <em>cache</em> permet dâ€™Ã©conomiser beaucoup de temps. Par besoin de refaire tourner toutes les Ã©tapes, <code>Docker</code> agit de maniÃ¨re intelligente en faisant tourner uniquement les Ã©tapes qui ont changÃ©.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-40-contents" aria-controls="callout-40" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-40" class="callout-40-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli13</code></pre>
</div>
</div>
</div>
</section>
</section>
<section id="partie-4-automatisation-avec-lintÃ©gration-continue" class="level1">
<h1>Partie 4 : automatisation avec lâ€™intÃ©gration continue</h1>
<p>Une image <code>Docker</code> est un livrable qui nâ€™est pas forcÃ©ment intÃ©ressant pour tous les publics. Certains prÃ©fÃ©reront avoir un plat bien prÃ©parÃ© quâ€™une recette. Nous allons donc proposer dâ€™aller plus loin en proposant plusieurs types de livrables.</p>
<p>Cela va nous amener Ã  dÃ©couvrir les outils du <code>CI/CD</code> (<em>Continuous Integration / Continuous Delivery</em>) qui sont au coeur de lâ€™approche <code>DevOps</code>.</p>
<p>Notre approche appliquÃ©e au <em>machine learning</em> va nous entraÃ®ner plutÃ´t du cÃ´tÃ© du <code>MLOps</code> qui devient une approche de plus en plus frÃ©quente dans lâ€™industrie de la <em>data science</em>.</p>
<p>Nous allons amÃ©liorer notre approche de trois maniÃ¨res:</p>
<ul>
<li>Automatisation de la crÃ©ation de lâ€™image <code>Docker</code> et tests automatisÃ©s de la qualitÃ© du code ;</li>
<li>Production dâ€™un site <em>web</em> automatisÃ© permettant de documenter et valoriser le modÃ¨le de <em>Machine Learning</em> ;</li>
<li>Mise Ã  disposition du modÃ¨le entraÃ®nÃ© par le biais dâ€™une API pour ne pas le rÃ©-entraÃ®ner Ã  chaque fois et faciliter sa rÃ©utilisation ;</li>
</ul>
<p>A chaque fois, nous allons dâ€™abord tester en local notre travail puis essayer dâ€™automatiser cela avec les outils de <code>Github</code>.</p>
<p>On va ici utiliser lâ€™intÃ©gration continue pour deux objectifs distincts:</p>
<ul>
<li>la mise Ã  disposition de lâ€™image <code>Docker</code> ;</li>
<li>la mise en place de tests automatisÃ©s de la qualitÃ© du code sur le modÃ¨le de notre <code>linter</code> prÃ©cÃ©dent</li>
</ul>
<p>Nous allons utiliser <code>Github Actions</code> pour cela.</p>
<section id="etape-1-mise-en-place-de-tests-automatisÃ©s" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-mise-en-place-de-tests-automatisÃ©s">Etape 1: mise en place de tests automatisÃ©s</h2>
<p>Avant dâ€™essayer de mettre en oeuvre la crÃ©ation de notre image <code>Docker</code> de maniÃ¨re automatisÃ©e, nous allons prÃ©senter la logique de lâ€™intÃ©gration continue en testant de maniÃ¨re automatisÃ©e notre script <code>main.py</code>.</p>
<p>Pour cela, nous allons partir de la structure proposÃ©e dans lâ€™<a href="https://github.com/actions/setup-python">action officielle</a>. La documentation associÃ©e est <a href="https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python">ici</a></p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 14: premier script dâ€™intÃ©gration continue
</div>
</div>
<div class="callout-body-container callout-body">
<p>A partir de lâ€™exemple prÃ©sent dans la <a href="https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python">documentation officielle</a> de <code>Github</code>, on a dÃ©jÃ  une base de dÃ©part qui peut Ãªtre modifiÃ©e:</p>
<ol type="1">
<li>CrÃ©er un fichier <code>.github/workflows/ci.yaml</code> avec le contenu de lâ€™exemple de la documentation</li>
<li>Retirer la <code>strategy matrix</code> et ne tester quâ€™avec la version <code>3.10</code> de <code>Python</code></li>
<li>Utiliser le fichier <code>requirements.txt</code> pour installer les dÃ©pendances.</li>
<li>Remplacer <code>russ</code> par <code>pylint</code> pour vÃ©rifier la qualitÃ© du code. Ajouter lâ€™argument <code>--fail-under=6</code> pour renvoyer une erreur en cas de note trop basse<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a></li>
<li>PlutÃ´t que <code>pytest</code>, utiliser <code>python main.py</code> pour tester que la matrice de confusion sâ€™affiche bien.</li>
</ol>
<details>
<summary>
Fichier <code>.github/workflows/ci.yaml</code> obtenu
</summary>
<div class="sourceCode" id="cb54"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Build, test and push</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">push</span><span class="kw">]</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Python</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-python@v4</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">python-version</span><span class="kw">:</span><span class="at"> </span><span class="st">'3.10'</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dependencies</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>          python -m pip install --upgrade pip</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>          pip install pylint</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>          pip install -r requirements.txt</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Lint</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>          pylint src --fail-under=6</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Test workflow</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>          python main.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-42-contents" aria-controls="callout-42" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-42" class="callout-42-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli14</code></pre>
</div>
</div>
</div>
<p>Maintenant, nous pouvons observer que lâ€™onglet <code>Actions</code> sâ€™est enrichi. Chaque <code>commit</code> va entraÃ®ner une action pour tester nos scripts.</p>
<p>Si la note est mauvaise, nous aurons une croix rouge (et nous recevrons un mail). On pourra ainsi dÃ©tecter, en dÃ©veloppant son projet, les moments oÃ¹ on dÃ©grade la qualitÃ© du script afin de la rÃ©tablir immÃ©diatemment.</p>
</section>
<section id="etape-2-automatisation-de-la-livraison-de-limage-docker" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-automatisation-de-la-livraison-de-limage-docker">Etape 2: Automatisation de la livraison de lâ€™image <code>Docker</code></h2>
<p>Maintenant, nous allons automatiser la mise Ã  disposition de notre image sur <code>DockerHub</code>. Cela facilitera sa rÃ©utilisation mais aussi des valorisations ultÃ©rieures.</p>
<p>LÃ  encore, nous allons utiliser une sÃ©rie dâ€™actions prÃ©-configurÃ©es.</p>
<p>Pour que <code>Github</code> puisse sâ€™authentifier auprÃ¨s de <code>DockerHub</code>, il va falloir dâ€™abord interfacer les deux plateformes. Pour cela, nous allons utiliser un jeton (<em>token</em>) <code>DockerHub</code> que nous allons mettre dans un espace sÃ©curisÃ© associÃ© Ã  votre dÃ©pÃ´t <code>Github</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 15a: configuration
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Se rendre sur https://hub.docker.com/ et crÃ©er un compte.</li>
<li>CrÃ©er un dÃ©pÃ´t public <code>application-correction</code></li>
<li>Aller dans les paramÃ¨tres (https://hub.docker.com/settings/general) et cliquer, Ã  gauche, sur <code>Security</code></li>
<li>CrÃ©er un jeton personnel dâ€™accÃ¨s, ne fermez pas lâ€™onglet en question, vous ne pouvez voir sa valeur quâ€™une fois.</li>
<li>Dans votre dÃ©pÃ´t <code>Github</code>, cliquer sur lâ€™onglet <code>Settings</code> et cliquer, Ã  gauche, sur <code>Actions</code>. Sur la page qui sâ€™affiche, cliquer sur <code>New repository secret</code></li>
<li>Donner le nom <code>DOCKERHUB_TOKEN</code> Ã  ce jeton et copier la valeur. Valider</li>
<li>CrÃ©er un deuxiÃ¨me secret nommÃ© <code>DOCKERHUB_USERNAME</code> ayant comme valeur le nom dâ€™utilisateur que vous avez crÃ©Ã© sur <code>Dockerhub</code></li>
</ul>
</div>
</div>
<p>A ce stade, nous avons donnÃ© les moyens Ã  <code>Github</code> de sâ€™authentifier avec notre identitÃ© sur <code>Dockerhub</code>. Il nous reste Ã  mettre en oeuvre lâ€™action en sâ€™inspirant de https://github.com/docker/build-push-action/#usage. On ne va modifier que trois Ã©lÃ©ments dans ce fichier. Effectuer les actions suivantes:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 15b: automatisation de lâ€™image <code>Docker</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>En sâ€™inspirant de ce <a href="https://github.com/marketplace/actions/build-and-push-docker-images"><em>template</em></a>, ajouter un nouveau job <code>docker</code> dans le fichier <code>ci.yaml</code> qui va <em>build</em> et <em>push</em> lâ€™image sur le <code>DockerHub</code></li>
<li>DÃ©finir le job <code>test</code> comme prÃ©requis du job <code>docker</code> en vous rÃ©fÃ©rant Ã  cette <a href="https://docs.github.com/en/actions/using-jobs/using-jobs-in-a-workflow#defining-prerequisite-jobs">documentation</a></li>
<li>Changer le tag Ã  la fin pour mettre <code>&lt;username&gt;/application-correction:latest</code> oÃ¹ <code>username</code> est le nom dâ€™utilisateur sur <code>DockerHub</code>;</li>
</ul>
<details>
<summary>
Fichier <code>.github/workflows/ci.yaml</code> obtenu
</summary>
<div class="sourceCode" id="cb56"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Build, test and push</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">push</span><span class="kw">]</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Python</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-python@v4</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">python-version</span><span class="kw">:</span><span class="at"> </span><span class="st">'3.10'</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dependencies</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>          python -m pip install --upgrade pip</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>          pip install pylint</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>          pip install -r requirements.txt</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Lint</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>          pylint src --fail-under=6</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Test workflow</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>          python main.py</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">docker</span><span class="kw">:</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> test</span></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up QEMU</span></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/setup-qemu-action@v2</span></span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Docker Buildx</span></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/setup-buildx-action@v2</span></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Login to Docker Hub</span></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/login-action@v2</span></span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">username</span><span class="kw">:</span><span class="at"> ${{ secrets.DOCKERHUB_USERNAME }}</span></span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">password</span><span class="kw">:</span><span class="at"> ${{ secrets.DOCKERHUB_TOKEN }}</span></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build and push</span></span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/build-push-action@v4</span></span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">push</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">tags</span><span class="kw">:</span><span class="at"> linogaliana/application-correction:latest</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li>Faire un <code>commit</code> et un <code>push</code> de ces fichiers</li>
</ul>
</div>
</div>
<p>Comme on est fier de notre travail, on va afficher Ã§a avec un badge sur le <code>README</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 15c: Afficher un badge dans le <code>README</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Se rendre dans lâ€™onglet <code>Actions</code> et cliquer sur un des scripts en train de tourner.</li>
<li>En haut Ã  droite, cliquer sur <code>...</code></li>
<li>SÃ©lectionner <code>Create status badge</code></li>
<li>RÃ©cupÃ©rer le code <code>Markdown</code> proposÃ©</li>
<li>Copier dans le <code>README</code> depuis <code>VSCode</code></li>
<li>Faire de mÃªme pour lâ€™autre <em>workflow</em></li>
</ul>
</div>
</div>
<p>Maintenant, il nous reste Ã  tester notre application dans lâ€™espace bac Ã  sable ou en local, si <code>Docker</code> est installÃ©.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 15d: Tester lâ€™application
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Se rendre sur lâ€™environnement bac Ã  sable <em><a href="https://labs.play-with-docker.com">Play with Docker</a></em></li>
<li>RÃ©cupÃ©rer lâ€™image :</li>
</ul>
<div class="sourceCode" id="cb57"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="at">docker pull &lt;username_dockerhub&gt;/application-correction:latest</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Tester le bon fonctionnement de lâ€™image</li>
</ul>
<div class="sourceCode" id="cb58"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="at">docker run -it &lt;username_dockerhub&gt;/application-correction:latest</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>:tada: La matrice de confusion doit sâ€™afficher ! Vous avez grandement facilitÃ© la rÃ©utilisation de votre image.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-47-contents" aria-controls="callout-47" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-47" class="callout-47-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli15</code></pre>
</div>
</div>
</div>
</section>
</section>
<section id="partie-5-mise-en-production-dune-api-servant-un-modÃ¨le-de-machine-learning" class="level1">
<h1>Partie 5: mise en production dâ€™une API servant un modÃ¨le de machine learning</h1>
<section id="etape-1-crÃ©ation-dun-pipeline-scikit" class="level2">
<h2 class="anchored" data-anchor-id="etape-1-crÃ©ation-dun-pipeline-scikit">Etape 1: crÃ©ation dâ€™un pipeline <code>scikit</code></h2>
<p>Notre code respecte des bonnes pratiques formelles. Cependant, la mise en production nÃ©cessite dâ€™Ãªtre exigeant sur la mise en oeuvre opÃ©rationnelle de notre <em>pipeline</em>.</p>
<p>Quand on utilise <code>scikit</code>, la bonne pratique est dâ€™utiliser les <a href="https://scikit-learn.org/stable/modules/generated/sklearn.pipeline.Pipeline.html"><em>pipelines</em></a> qui sÃ©curisent les Ã©tapes de <em>feature engineering</em> avant la mise en oeuvre dâ€™un modÃ¨le (que ce soit pour lâ€™entraÃ®nement ou le test sur un nouveau jeu de donnÃ©es).</p>
<p>On va donc devoir refactoriser notre application pour utiliser un <em>pipeline</em> <code>scikit</code>. Les raisons sont expliquÃ©es <a href="https://scikit-learn.org/stable/common_pitfalls.html">ici</a>. Cela aura aussi lâ€™avantage de rendre les Ã©tapes plus lisibles.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 16: Un <em>pipeline</em> de <em>machine learning</em>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Refactoriser le code de <code>random_forest_titanic</code> pour crÃ©er un vrai pipeline de <em>preprocessing</em> avant la modÃ©lisation</p></li>
<li><p>Simplifier la fonction <code>split_train_test_titanic</code> en la rÃ©duisant au dÃ©coupage train/test</p></li>
<li><p>Modifier <code>main.py</code> pour que ce soit Ã  ce niveau quâ€™a lieu le dÃ©coupage en train/test, lâ€™entrainement et lâ€™Ã©valuation du modÃ¨le</p></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-49-contents" aria-controls="callout-49" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-49" class="callout-49-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli16</code></pre>
</div>
</div>
</div>
</section>
<section id="etape-2-dÃ©velopper-une-api-en-local" class="level2">
<h2 class="anchored" data-anchor-id="etape-2-dÃ©velopper-une-api-en-local">Etape 2: dÃ©velopper une API en local</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 17: Mise Ã  disposition sous forme dâ€™API locale
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>CrÃ©er un nouveau service <code>SSPCloud</code> en paramÃ©trant dans lâ€™onglet <code>Networking</code> le port 5000 ;</li>
<li>Cloner le dÃ©pÃ´t et se placer au niveau de lâ€™application prÃ©cÃ©dente (<code>git checkout appli16</code>)</li>
<li>Installer <code>fastAPI</code> et <code>uvicorn</code> puis les ajouter au <code>requirements.txt</code></li>
<li>Renommer le fichier <code>main.py</code> en <code>train.py</code> et insÃ©rer le contenu suivant dedans :</li>
</ul>
<details>
<summary>
Fichier <code>train.py</code>
</summary>
RÃ©cupÃ©rer le contenu sur <a href="https://raw.githubusercontent.com/ensae-reproductibilite/application-correction/appli17/train.py">cette page</a>
</details>
<ul>
<li>CrÃ©er le fichier <code>api.py</code> permettant dâ€™initialiser lâ€™API:</li>
</ul>
<details>
<summary>
Fichier <code>api.py</code>
</summary>
RÃ©cupÃ©rer le contenu sur <a href="https://raw.githubusercontent.com/ensae-reproductibilite/application-correction/appli17/api.py">cette page</a>
</details>
<ul>
<li>ExÃ©cuter <code>train.py</code> pour stocker en local le modÃ¨le entraÃ®nÃ©</li>
<li>Ajouter <code>model.joblib</code> au <code>.gitignore</code></li>
<li>DÃ©ployer en local lâ€™API avec la commande</li>
</ul>
<pre class="shell"><code>uvicorn api:app --reload --host "0.0.0.0" --port 5000</code></pre>
<ul>
<li>A partir du <code>README</code> du service, se rendre sur lâ€™URL de dÃ©ploiement, ajouter <code>/docs/</code> Ã  celui-ci et observer la documentation de lâ€™API</li>
<li>Se servir de la documentation pour tester les requÃªtes <code>/predict</code></li>
<li>RÃ©cupÃ©rer lâ€™URL dâ€™une des requÃªtes proposÃ©es. La tester dans le navigateur et depuis <code>Python</code> avec <code>requests</code> (<code>requests.get(url).json()</code>)</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-51-contents" aria-controls="callout-51" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-51" class="callout-51-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli17</code></pre>
</div>
</div>
</div>
</section>
<section id="etape-3-dÃ©ployer-lapi" class="level2">
<h2 class="anchored" data-anchor-id="etape-3-dÃ©ployer-lapi">Etape 3: dÃ©ployer lâ€™API</h2>
<p>A ce stade, nous avons dÃ©ployÃ© lâ€™API seulement localement, dans le cadre dâ€™un service. Ce mode de dÃ©ploiement est trÃ¨s pratique pour la phase de dÃ©veloppement, afin de sâ€™assurer que lâ€™API fonctionne comme attendu. A prÃ©sent, il est temps de passer Ã  lâ€™Ã©tape de dÃ©ploiement, qui permettra Ã  notre API dâ€™Ãªtre accessible via une URL sur le web, et donc aux utilisateurs potentiels de la requÃªter. Pour se faire, on va utiliser les possibilitÃ©s offertes par <code>Kubernetes</code>, sur lequel est basÃ© le <a href="https://datalab.sspcloud.fr">SSP Cloud</a>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 18: Dockeriser lâ€™API
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Modifier le <code>Dockerfile</code> pour tenir compte des changements dans les noms de fichier effecutÃ©s dans lâ€™application prÃ©cÃ©dente</p></li>
<li><p>CrÃ©er un script <code>run.sh</code> Ã  la racine du projet qui lance le script <code>train.py</code> puis dÃ©ploie localement lâ€™API</p></li>
</ul>
<details>
<summary>
Fichier <code>run.sh</code>
</summary>
<pre class="shell"><code>#/bin/bash

python3 train.py
uvicorn api:app --reload --host "0.0.0.0" --port 5000</code></pre>
</details>
<ul>
<li><p>Donner au script <code>run.sh</code> des permissions dâ€™exÃ©cution : <code>chmod +x run.sh</code></p></li>
<li><p>Changer lâ€™instruction <code>CMD</code> du <code>Dockerfile</code> pour exÃ©cuter le script <code>run.sh</code> au lancement du conteneur</p></li>
<li><p><em>Commit</em> et <em>push</em> les changements</p></li>
<li><p>Une fois le CI terminÃ©, rÃ©cupÃ©rer la nouvelle image dans lâ€™environnement de test et vÃ©rifier que lâ€™API se dÃ©ploie correctement</p></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-53-contents" aria-controls="callout-53" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-53" class="callout-53-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli18</code></pre>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 19: DÃ©ployer lâ€™API
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>CrÃ©er un dossier <code>deployment</code> Ã  la racine du projet qui va contenir les fichiers de configuration nÃ©cessaires pour dÃ©ployer sur un cluster <code>Kubernetes</code></p></li>
<li><p>En vous inspirant de la <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment">documentation</a>, y ajouter un premier fichier <code>deployment.yaml</code> qui va spÃ©cifier la configuration du <em>Pod</em> Ã  lancer sur le cluster</p></li>
</ul>
<details>
<summary>
Fichier <code>deployment/deployment.yaml</code>
</summary>
<div class="sourceCode" id="cb65"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> titanic-deployment</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> linogaliana/application-correction:latest</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li>En vous inspirant de la <a href="https://kubernetes.io/fr/docs/concepts/services-networking/service/#d%C3%A9finition-d-un-service">documentation</a>, y ajouter un second fichier <code>service.yaml</code> qui va crÃ©er une ressource <code>Service</code> permettant de donner une identitÃ© fixe au <code>Pod</code> prÃ©cÃ©demment crÃ©Ã© au sein du cluster</li>
</ul>
<details>
<summary>
Fichier <code>deployment/service.yaml</code>
</summary>
<div class="sourceCode" id="cb66"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> titanic-service</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">protocol</span><span class="kw">:</span><span class="at"> TCP</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li>En vous inspirant de la <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#the-ingress-resource">documentation</a>, y ajouter un troisiÃ¨me fichier <code>ingress.yaml</code> qui va crÃ©er une ressource <code>Ingress</code> permettant dâ€™exposer le service via une URL en dehors du cluster</li>
</ul>
<details>
<summary>
Fichier <code>deployment/ingress.yaml</code>
</summary>
<div class="sourceCode" id="cb67"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> networking.k8s.io/v1</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Ingress</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> titanic-ingress</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">annotations</span><span class="kw">:</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">nginx.ingress.kubernetes.io/rewrite-target</span><span class="kw">:</span><span class="at"> /</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ingressClassName</span><span class="kw">:</span><span class="at"> nginx</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">tls</span><span class="kw">:</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">hosts</span><span class="kw">:</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> titanic.kub.sspcloud.fr</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">rules</span><span class="kw">:</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">host</span><span class="kw">:</span><span class="at"> titanic.kub.sspcloud.fr</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">http</span><span class="kw">:</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">paths</span><span class="kw">:</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">path</span><span class="kw">:</span><span class="at"> /</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">pathType</span><span class="kw">:</span><span class="at"> Prefix</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">backend</span><span class="kw">:</span></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">service</span><span class="kw">:</span></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">name</span><span class="kw">:</span><span class="at"> titanic-service</span></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">port</span><span class="kw">:</span></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="fu">number</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li><p>Appliquer ces fichiers de configuration sur le cluster : <code>kubectl apply -f deployement/</code></p></li>
<li><p>Si tout a correctement fonctionnÃ©, vous devriez pouvoir accÃ©der Ã  lâ€™API Ã  lâ€™URL spÃ©cifiÃ©e dans le fichier <code>deployment/ingress.yaml</code></p></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-55-contents" aria-controls="callout-55" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-55" class="callout-55-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli19</code></pre>
</div>
</div>
</div>
</section>
</section>
<section id="partie-6-un-workflow-complet-de-mlops" class="level1">
<h1>Partie 6: un workflow complet de MLOps</h1>
<p>Ce sera lâ€™an prochain, dÃ©solÃ© !</p>
</section>
<section id="partie-7-livrer-un-site-web-de-maniÃ¨re-automatisÃ©e" class="level1">
<h1>Partie 7: livrer un site web de maniÃ¨re automatisÃ©e</h1>
<p>On va proposer un nouveau livrable pour parler Ã  un public plus large. Pour cela, on va dÃ©ployer un site web statique qui permet de visualiser rapidement les rÃ©sultats du modÃ¨le.</p>
<p>On propose de crÃ©er un site web qui permet de comprendre, avec lâ€™appui des <a href="https://christophm.github.io/interpretable-ml-book/shapley.html">valeurs de Shapley</a>, les facteurs qui auraient pu nous mettre la puce Ã  lâ€™oreille sur les destins de Jake et de Rose.</p>
<p>Pour faire ce site web, on va utiliser <code>Quarto</code> et dÃ©ployer sur <code>Github Pages</code>. Des Ã©tapes prÃ©liminaires sont rÃ©alisÃ©es en <code>Python</code> puis lâ€™affichage interactif sera contrÃ´lÃ© par du <code>JavaScript</code> grÃ¢ce Ã  des <a href="https://quarto.org/docs/interactive/ojs/">blocs <code>Observable</code></a>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 19: DÃ©ploiement automatisÃ© dâ€™un site web
</div>
</div>
<div class="callout-body-container callout-body">
<p>Dans un premier temps, on va crÃ©er un projet <code>Quarto</code> au sein de notre dÃ©pÃ´t:</p>
<ul>
<li>Installer <code>Quarto</code> dans votre environnement local (sâ€™il nâ€™est pas dÃ©jÃ  disponible) ;</li>
<li>Dans le projet, utiliser la commande <code>quarto create-project</code> pour initialiser le projet <code>Quarto</code> ;</li>
<li>Supprimer le fichier automatiquement gÃ©nÃ©rÃ© avec lâ€™extension <code>.qmd</code> ;</li>
<li>RÃ©cupÃ©rer le contenu du modÃ¨le de fichier <code>Quarto Markdown</code> <a href="https://raw.githubusercontent.com/ensae-reproductibilite/application-correction/tree/appli19/index.qmd">cette page</a>. Celui-ci permet de gÃ©nÃ©rer la page dâ€™accueil de notre site. Enregistrer dans un fichier nommÃ© <code>index.qmd</code></li>
</ul>
<p>On teste ensuite la compilation en local du fichier:</p>
<ul>
<li>Modifier le fichier <code>train.py</code> Ã  partir de <a href="https://raw.githubusercontent.com/ensae-reproductibilite/application-correction/tree/appli19/train.py">cette page</a> pour Ãªtre en mesure de compiler le fichier</li>
<li>ExÃ©cuter le fichier <code>train.py</code></li>
<li>En ligne de commande, faire <code>quarto preview</code> (ajouter les arguments <code>--port 5000 --host 0.0.0.0</code> si vous passez par le <code>SSPCloud</code>)</li>
<li>Observer le site web gÃ©nÃ©rÃ© en local</li>
</ul>
<p>Enfin, on va construire et dÃ©ployer automatiquement ce site web grÃ¢ce au combo <code>Github Actions</code> et <code>Github Pages</code>:</p>
<ul>
<li>CrÃ©er une branche <code>gh-pages</code> Ã  partir du contenu de <a href="https://quarto.org/docs/publishing/github-pages.html">cette page</a></li>
<li>CrÃ©er un fichier <code>.github/workflows/website.yaml</code> avec le contenu de <a href="https://raw.githubusercontent.com/ensae-reproductibilite/application-correction/tree/appli19/.github/workflows/publish.yaml">ce fichier</a></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>On doit dans cette application modifier le fichier <code>train.py</code> pour enregistrer en local une duplication du modÃ¨le de <em>machine learning</em> et de lâ€™ensemble dâ€™entraÃ®nement car pour ces deux Ã©lÃ©ments on nâ€™est pas allÃ© au bout de la dÃ©marche MLOps dâ€™enregistrement dans un <em>model registry</em> et un <em>feature store</em>.</p>
<p>Dans la prochaine version de ce cours, qui intÃ¨grera <code>MLFlow</code>, on aura une dÃ©marche plus propre car on utilisera bien le modÃ¨le de production et le jeu dâ€™entrainement associÃ©.</p>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-58-contents" aria-controls="callout-58" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-58" class="callout-58-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre class="shell"><code>git checkout appli20</code></pre>
</div>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Lâ€™export dans un script <code>.py</code> a Ã©tÃ© fait avec <a href="https://jupytext.readthedocs.io/en/latest/index.html"><code>Jupytext</code></a>. Comme cela nâ€™est pas vraiment lâ€™objet du cours, nous passons cette Ã©tape et fournissons directement le script. Mais nâ€™oubliez pas que cette dÃ©marche, frÃ©quente quand on a dÃ©marrÃ© sur un <em>notebook</em> et quâ€™on dÃ©sire consolider en faisant la transition vers des scripts, nÃ©cessite dâ€™Ãªtre attentif pour ne pas risquer de faire une erreur.<a href="#fnref1" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn2"><p>Essayez de <em>commit</em> vos changements Ã  chaque Ã©tape de lâ€™exercice, câ€™est une bonne habitude Ã  prendre.<a href="#fnref2" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn3"><p>Nous le verrons lorsque nous mettrons en oeuvre lâ€™intÃ©gration continue.<a href="#fnref3" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn4"><p>Ici, le jeton dâ€™API nâ€™est pas indispensable pour que le code fonctionne. Afin dâ€™Ã©viter une erreur non nÃ©cessaire lorsquâ€™on automatisera le processus, on peut crÃ©er une condition qui vÃ©rifie la prÃ©sence ou non de ce fichier.</p>
<p>Cela peut Ãªtre fait avec la fonction <code>os.path.exists</code> :</p>
<pre><code>if os.path.exists('secrets.yaml'):
    secrets = import_yaml_config("secrets.yaml")</code></pre>
<p>La variable <code>secrets</code> nâ€™existera que dans le cas oÃ¹ un fichier <code>secrets.yaml</code> existe. Le script reste donc reproductible mÃªme pour un utilisateur nâ€™ayant pas le fichier <code>secrets.yaml</code>.<a href="#fnref4" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn5"><p>Nous proposons ici dâ€™adopter le principe de la <strong>programmation fonctionnelle</strong>. Pour encore fiabiliser un processus, il serait possible dâ€™adopter le paradigme de la <strong>programmation orientÃ©e objet (POO)</strong>. Celle-ci est plus rebutante et demande plus de temps au dÃ©veloppeur. Lâ€™arbitrage coÃ»t-avantage est nÃ©gatif pour notre exemple, nous proposons donc de nous en passer. NÃ©anmoins, pour une mise en production rÃ©elle dâ€™un modÃ¨le, il est recommandÃ© de lâ€™adopter. Câ€™est dâ€™ailleurs obligatoire avec des <a href="https://pythonds.linogaliana.fr/pipeline-scikit/"><em>pipelines</em> <code>scikit</code></a>.<a href="#fnref5" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn6"><p>Au passage vous pouvez noter que mauvaises pratiques discutables, peuvent Ãªtre corrigÃ©es, notamment lâ€™utilisation excessive de <code>apply</code> lÃ  oÃ¹ il serait possible dâ€™utiliser des mÃ©thodes embarquÃ©es par <code>Pandas</code>. Cela est plutÃ´t de lâ€™ordre du bon style de programmation que de la qualitÃ© formelle du script. Ce nâ€™est donc pas obligatoire mais câ€™est mieux.<a href="#fnref6" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn7"><p>Il est normal dâ€™avoir des dossiers <code>__pycache__</code> qui traÃ®nent : ils se crÃ©ent automatiquement Ã  lâ€™exÃ©cution dâ€™un script en <code>Python</code>.<a href="#fnref7" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn8"><p>Lâ€™emplacement de ce fichier est amenÃ© Ã  Ã©voluer dans le cadre dâ€™une packagisation. Dans un package, ces tests seront dans un dossier spÃ©cifique <code>/tests</code> car <code>Python</code> sait gÃ©rer de maniÃ¨re plus formelle les imports de fonctions depuis des modules. Ici, on est dans une situation transitoire, raison pour laquelle les tests sont dans les mÃªmes dossiers que les fonctions.<a href="#fnref8" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn9"><p>Le fichier <code>__init__.py</code> indique Ã  <code>Python</code> que le dossier est un <em>package</em>. Il permet de proposer certaines configurations lors de lâ€™import du <em>package</em>. Il permet Ã©galement de contrÃ´ler les objets exportÃ©s (câ€™est-Ã -dire mis Ã  disposition de lâ€™utilisateur) par le <em>package</em> par rapport aux objets internes au <em>package</em>. En le laissant vide, nous allons utiliser ce fichier pour importer lâ€™ensemble des fonctions de nos sous-modules. Ce nâ€™est pas la meilleure pratique mais un contrÃ´le plus fin des objets exportÃ©s demanderait un investissement qui ne vaut, ici, pas le coÃ»t.<a href="#fnref9" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn10"><p>Ce <code>pyproject.toml</code> est un modÃ¨le qui utilise <code>setuptools</code> pour <em>build</em> le <em>package</em>. Câ€™est lâ€™outil classique. NÃ©anmoins, pour des usages plus raffinÃ©s, il peut Ãªtre utile dâ€™utiliser <a href="https://python-poetry.org/"><code>poetry</code></a> qui propose des fonctionnalitÃ©s plus complÃ¨tes.<a href="#fnref10" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn11"><p>Si vous dÃ©sirez aussi contrÃ´ler la version de <code>Python</code>, ce qui peut Ãªtre important dans une perspective de portabilitÃ©, vous pouvez ajouter une option, par exemple <code>-p python3.9</code>.<a href="#fnref11" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn12"><p>Pour comparer les deux listes, vous pouvez utiliser la fonctionnalitÃ© de <em>split</em> du terminal sur <code>VSCode</code> pour comparer les outputs de <code>conda env export</code> en les mettant en face Ã  face.<a href="#fnref12" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
<li id="fn13"><p>Il existe une approche alternative pour faire des tests rÃ©guliers: les <em>hooks</em> <code>Git</code>. Il sâ€™agit de rÃ¨gles qui doivent Ãªtre satisfaites pour que le fichier puisse Ãªtre committÃ©. Cela assurera que chaque <code>commit</code> remplisse des critÃ¨res de qualitÃ© afin dâ€™Ã©viter le problÃ¨me de la procrastination.</p>
<p>La <a href="https://pylint.pycqa.org/en/latest/user_guide/pre-commit-integration.html">documentation de pylint</a> offre des explications supplÃ©mentaires.<a href="#fnref13" class="footnote-back" role="doc-backlink">â†©ï¸</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>