<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Une application fil rouge pour illustrer l‚Äôint√©r√™t d‚Äôappliquer graduellement les bonnes pratiques dans une optique de mise en production d‚Äôune application de data science.">

<title>Application ‚Äì Mise en production</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-bd706bf7cc79ec682822fd2bf903aab3.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-1.2.0/all.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-1.2.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>
div.callout-application.callout {
  border-left-color: #9c5bd9;
}
div.callout-application.callout-style-default > .callout-header {
  background-color: rgba(156, 91, 217, 0.13);
}
div.callout-application .callout-toggle::before {  background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgb(33, 37, 41)" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');}
div.callout-application.callout-style-default .callout-icon::before, div.callout-application.callout-titled .callout-icon::before {
  content: 'üß†';
  background-image: none;
}
</style>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://ensae-reproductibilite.github.io/"> 
<span class="menu-text">Mise en production</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/introduction.html"> 
<span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-les-bases" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Les bases</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-les-bases">    
        <li>
    <a class="dropdown-item" href="../chapters/linux-101.html">
 <span class="dropdown-text">Linux 101</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/git.html">
 <span class="dropdown-text">Git</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bonnes-pratiques-de-d√©veloppement" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Bonnes pratiques de d√©veloppement</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-bonnes-pratiques-de-d√©veloppement">    
        <li>
    <a class="dropdown-item" href="../chapters/code-quality.html">
 <span class="dropdown-text">Qualit√© du code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/projects-architecture.html">
 <span class="dropdown-text">Structure des projets</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/big-data.html">
 <span class="dropdown-text">Traitement des donn√©es volumineuses</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/portability.html">
 <span class="dropdown-text">Portabilit√©</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-mise-en-production" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Mise en production</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-mise-en-production">    
        <li>
    <a class="dropdown-item" href="../chapters/deployment.html">
 <span class="dropdown-text">D√©ploiement</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/mlops.html">
 <span class="dropdown-text">MLOps</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link active" href="../chapters/application.html" aria-current="page"> 
<span class="menu-text">Application</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-projets" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Projets</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-projets">    
        <li>
    <a class="dropdown-item" href="../chapters/evaluation.html">
 <span class="dropdown-text">Modalit√©s d‚Äô√©valuation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/galerie.html">
 <span class="dropdown-text">Galerie des projets pass√©s</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/website">
 <span class="dropdown-text">Site web</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/slides">
 <span class="dropdown-text">Slides</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/application">
 <span class="dropdown-text">Application fil rouge</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#objectif" id="toc-objectif" class="nav-link" data-scroll-target="#objectif">Objectif</a></li>
  <li><a href="#ce-que-cette-application-ne-couvre-pas-pour-le-moment" id="toc-ce-que-cette-application-ne-couvre-pas-pour-le-moment" class="nav-link" data-scroll-target="#ce-que-cette-application-ne-couvre-pas-pour-le-moment">Ce que cette application ne couvre pas (pour le moment)</a></li>
  <li><a href="#comment-g√©rer-les-checkpoints" id="toc-comment-g√©rer-les-checkpoints" class="nav-link" data-scroll-target="#comment-g√©rer-les-checkpoints">Comment g√©rer les <em>checkpoints</em> ?</a></li>
  </ul></li>
  <li><a href="#partie-0-initialisation-du-projet" id="toc-partie-0-initialisation-du-projet" class="nav-link" data-scroll-target="#partie-0-initialisation-du-projet">Partie 0 : initialisation du projet</a></li>
  <li><a href="#partie-1-qualit√©-du-script" id="toc-partie-1-qualit√©-du-script" class="nav-link" data-scroll-target="#partie-1-qualit√©-du-script">Partie 1 : qualit√© du script</a>
  <ul class="collapse">
  <li><a href="#√©tape-1-sassurer-que-le-script-sex√©cute-correctement" id="toc-√©tape-1-sassurer-que-le-script-sex√©cute-correctement" class="nav-link" data-scroll-target="#√©tape-1-sassurer-que-le-script-sex√©cute-correctement">√âtape 1 : s‚Äôassurer que le script s‚Äôex√©cute correctement</a></li>
  <li><a href="#√©tape-2-utiliser-un-linter-puis-un-formatter" id="toc-√©tape-2-utiliser-un-linter-puis-un-formatter" class="nav-link" data-scroll-target="#√©tape-2-utiliser-un-linter-puis-un-formatter">√âtape 2: utiliser un <em>linter</em> puis un <em>formatter</em></a></li>
  <li><a href="#√©tape-3-gestion-des-param√®tres" id="toc-√©tape-3-gestion-des-param√®tres" class="nav-link" data-scroll-target="#√©tape-3-gestion-des-param√®tres">√âtape 3: gestion des param√®tres</a></li>
  <li><a href="#√©tape-4-privil√©gier-la-programmation-fonctionnelle" id="toc-√©tape-4-privil√©gier-la-programmation-fonctionnelle" class="nav-link" data-scroll-target="#√©tape-4-privil√©gier-la-programmation-fonctionnelle">√âtape 4 : Privil√©gier la programmation fonctionnelle</a></li>
  </ul></li>
  <li><a href="#partie2" id="toc-partie2" class="nav-link" data-scroll-target="#partie2">Partie 2 : adoption d‚Äôune structure modulaire</a>
  <ul class="collapse">
  <li><a href="#√©tape-1-modularisation" id="toc-√©tape-1-modularisation" class="nav-link" data-scroll-target="#√©tape-1-modularisation">√âtape 1 : modularisation</a></li>
  <li><a href="#√©tape-2-adopter-une-architecture-standardis√©e-de-projet" id="toc-√©tape-2-adopter-une-architecture-standardis√©e-de-projet" class="nav-link" data-scroll-target="#√©tape-2-adopter-une-architecture-standardis√©e-de-projet">√âtape 2 : adopter une architecture standardis√©e de projet</a></li>
  <li><a href="#√©tape-3-mieux-tracer-notre-chaine-de-production" id="toc-√©tape-3-mieux-tracer-notre-chaine-de-production" class="nav-link" data-scroll-target="#√©tape-3-mieux-tracer-notre-chaine-de-production">√âtape 3: mieux tracer notre chaine de production</a>
  <ul class="collapse">
  <li><a href="#indiquer-lenvironnement-minimal-de-reproductibilit√©" id="toc-indiquer-lenvironnement-minimal-de-reproductibilit√©" class="nav-link" data-scroll-target="#indiquer-lenvironnement-minimal-de-reproductibilit√©">Indiquer l‚Äôenvironnement minimal de reproductibilit√©</a></li>
  <li><a href="#tracer-notre-cha√Æne" id="toc-tracer-notre-cha√Æne" class="nav-link" data-scroll-target="#tracer-notre-cha√Æne">Tracer notre cha√Æne</a></li>
  </ul></li>
  <li><a href="#stockageS3" id="toc-stockageS3" class="nav-link" data-scroll-target="#stockageS3">√âtape 4 : stocker les donn√©es de mani√®re externe</a></li>
  </ul></li>
  <li><a href="#partie-2bis-packagisation-de-son-projet-optionnel" id="toc-partie-2bis-packagisation-de-son-projet-optionnel" class="nav-link" data-scroll-target="#partie-2bis-packagisation-de-son-projet-optionnel">Partie 2bis: packagisation de son projet (optionnel)</a>
  <ul class="collapse">
  <li><a href="#√©tape-1-proposer-des-tests-unitaires-optionnel" id="toc-√©tape-1-proposer-des-tests-unitaires-optionnel" class="nav-link" data-scroll-target="#√©tape-1-proposer-des-tests-unitaires-optionnel">√âtape 1 : proposer des tests unitaires (optionnel)</a></li>
  <li><a href="#√©tape-2-transformer-son-projet-en-package-optionnel" id="toc-√©tape-2-transformer-son-projet-en-package-optionnel" class="nav-link" data-scroll-target="#√©tape-2-transformer-son-projet-en-package-optionnel">√âtape 2 : transformer son projet en package (optionnel)</a></li>
  </ul></li>
  <li><a href="#partie3" id="toc-partie3" class="nav-link" data-scroll-target="#partie3">Partie 3 : construction d‚Äôun projet portable et reproductible</a>
  <ul class="collapse">
  <li><a href="#anaconda" id="toc-anaconda" class="nav-link" data-scroll-target="#anaconda">√âtape 1 : un environnement pour rendre le projet portable</a></li>
  <li><a href="#shell" id="toc-shell" class="nav-link" data-scroll-target="#shell">√âtape 2: construire l‚Äôenvironnement de notre application via un script <code>shell</code></a></li>
  <li><a href="#docker" id="toc-docker" class="nav-link" data-scroll-target="#docker">√âtape 3: conteneuriser l‚Äôapplication avec <code>Docker</code></a></li>
  </ul></li>
  <li><a href="#partie-4-automatisation-avec-lint√©gration-continue" id="toc-partie-4-automatisation-avec-lint√©gration-continue" class="nav-link" data-scroll-target="#partie-4-automatisation-avec-lint√©gration-continue">Partie 4 : automatisation avec l‚Äôint√©gration continue</a>
  <ul class="collapse">
  <li><a href="#√©tape-1-mise-en-place-de-tests-automatis√©s" id="toc-√©tape-1-mise-en-place-de-tests-automatis√©s" class="nav-link" data-scroll-target="#√©tape-1-mise-en-place-de-tests-automatis√©s">√âtape 1: mise en place de tests automatis√©s</a></li>
  <li><a href="#√©tape-2-automatisation-de-la-livraison-de-limage-docker" id="toc-√©tape-2-automatisation-de-la-livraison-de-limage-docker" class="nav-link" data-scroll-target="#√©tape-2-automatisation-de-la-livraison-de-limage-docker">√âtape 2: Automatisation de la livraison de l‚Äôimage <code>Docker</code></a></li>
  </ul></li>
  <li><a href="#partie-5-exp√©rimenter-en-local-des-valorisations-puis-automatiser-leur-production" id="toc-partie-5-exp√©rimenter-en-local-des-valorisations-puis-automatiser-leur-production" class="nav-link" data-scroll-target="#partie-5-exp√©rimenter-en-local-des-valorisations-puis-automatiser-leur-production">Partie 5: exp√©rimenter en local des valorisations puis automatiser leur production</a>
  <ul class="collapse">
  <li><a href="#√©tape-1-d√©velopper-une-api-en-local" id="toc-√©tape-1-d√©velopper-une-api-en-local" class="nav-link" data-scroll-target="#√©tape-1-d√©velopper-une-api-en-local">√âtape 1: d√©velopper une API en local</a></li>
  <li><a href="#√©tape-2-d√©ployer-lapi-de-mani√®re-manuelle" id="toc-√©tape-2-d√©ployer-lapi-de-mani√®re-manuelle" class="nav-link" data-scroll-target="#√©tape-2-d√©ployer-lapi-de-mani√®re-manuelle">√âtape 2: d√©ployer l‚ÄôAPI de mani√®re manuelle</a></li>
  <li><a href="#etape-3-automatiser-le-d√©ploiement-d√©ploiement-en-continu" id="toc-etape-3-automatiser-le-d√©ploiement-d√©ploiement-en-continu" class="nav-link" data-scroll-target="#etape-3-automatiser-le-d√©ploiement-d√©ploiement-en-continu">Etape 3: automatiser le d√©ploiement (d√©ploiement en continu)</a></li>
  <li><a href="#etape-4-construire-un-site-web" id="toc-etape-4-construire-un-site-web" class="nav-link" data-scroll-target="#etape-4-construire-un-site-web">Etape 4: construire un site web</a></li>
  </ul></li>
  <li><a href="#partie-6-adopter-une-approche-mlops-pour-am√©liorer-notre-mod√®le" id="toc-partie-6-adopter-une-approche-mlops-pour-am√©liorer-notre-mod√®le" class="nav-link" data-scroll-target="#partie-6-adopter-une-approche-mlops-pour-am√©liorer-notre-mod√®le">Partie 6: adopter une approche MLOps pour am√©liorer notre mod√®le</a>
  <ul class="collapse">
  <li><a href="#revenir-sur-le-code-dentra√Ænement-du-mod√®le-pour-faire-de-la-validation-crois√©e" id="toc-revenir-sur-le-code-dentra√Ænement-du-mod√®le-pour-faire-de-la-validation-crois√©e" class="nav-link" data-scroll-target="#revenir-sur-le-code-dentra√Ænement-du-mod√®le-pour-faire-de-la-validation-crois√©e">Revenir sur le code d‚Äôentra√Ænement du mod√®le pour faire de la validation crois√©e</a></li>
  <li><a href="#garder-une-trace-des-entra√Ænements-de-notre-mod√®le-gr√¢ce-au-register-de-mlflow" id="toc-garder-une-trace-des-entra√Ænements-de-notre-mod√®le-gr√¢ce-au-register-de-mlflow" class="nav-link" data-scroll-target="#garder-une-trace-des-entra√Ænements-de-notre-mod√®le-gr√¢ce-au-register-de-mlflow">Garder une trace des entra√Ænements de notre mod√®le gr√¢ce au <em>register</em> de <code>MLFlow</code></a></li>
  <li><a href="#enregistrer-nos-premiers-entra√Ænements" id="toc-enregistrer-nos-premiers-entra√Ænements" class="nav-link" data-scroll-target="#enregistrer-nos-premiers-entra√Ænements">Enregistrer nos premiers entra√Ænements</a></li>
  <li><a href="#consommation-dun-mod√®le-archiv√©-sur-mlflow" id="toc-consommation-dun-mod√®le-archiv√©-sur-mlflow" class="nav-link" data-scroll-target="#consommation-dun-mod√®le-archiv√©-sur-mlflow">Consommation d‚Äôun mod√®le archiv√© sur <code>MLFlow</code></a>
  <ul class="collapse">
  <li><a href="#industrialiser-les-entra√Ænements-de-nos-mod√®les" id="toc-industrialiser-les-entra√Ænements-de-nos-mod√®les" class="nav-link" data-scroll-target="#industrialiser-les-entra√Ænements-de-nos-mod√®les">Industrialiser les entra√Ænements de nos mod√®les</a></li>
  </ul></li>
  <li><a href="#pour-aller-plus-loin" id="toc-pour-aller-plus-loin" class="nav-link" data-scroll-target="#pour-aller-plus-loin">Pour aller plus loin</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Application</h1>
</div>

<div>
  <div class="description">
    <p>Une application fil rouge pour illustrer l‚Äôint√©r√™t d‚Äôappliquer graduellement les bonnes pratiques dans une optique de mise en production d‚Äôune application de data science.</p>
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<details>
<summary>
D√©rouler les <em>slides</em> ci-dessous ou <a href="https://ensae-reproductibilite.github.io/slides/#/title-slide">cliquer ici</a> pour afficher les slides en plein √©cran.
</summary>
<div id="cb1" class="sourceCode">
<pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
<iframe class="sourceCode yaml code-with-copy" src="https://ensae-reproductibilite.github.io/slides/#/title-slide">
</iframe>
</div>
</details>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>L‚Äôobjectif de cette mise en application est d‚Äô<strong>illustrer les diff√©rentes √©tapes qui s√©parent la phase de d√©veloppement d‚Äôun projet de celle de la mise en production</strong>. Elle permettra de mettre en pratique les diff√©rents concepts pr√©sent√©s tout au long du cours.</p>
<p>L‚Äôobjectif p√©dagogique principal de cette application est d‚Äôadopter un point de vue pragmatique en choisissant des outils et des m√©thodes de travail qui permettent de r√©aliser des objectifs ambitieux de valorisation de donn√©es. <code>Python</code> sera le trait d‚Äôunion entre les diff√©rentes technologies ou infrastructures que nous utiliserons.</p>
<p>Cette application est un tutoriel pas √† pas pour avoir un projet reproductible et disponible sous plusieurs livrables. Toutes les √©tapes ne sont pas indispensables √† tous les projets de <em>data science</em> et il existe des outils alternatifs √† ceux pr√©sent√©s. N√©anmoins, les outils pr√©sent√©s ont l‚Äôavantage d‚Äô√™tre tr√®s bien int√©gr√©s √† <code>Python</code>, bien configur√©s si vous utilisez le <code>SSPCloud</code> comme nous le recommandons, tout en √©tant agnostiques sur le reste des outils que vous utilisez ; de sorte √† ne pas √™tre bloquants si on remplace l‚Äôune des briques logicielles par une autre.</p>
<p>Nous nous pla√ßons dans une situation initiale correspondant √† la fin de la phase de d√©veloppement d‚Äôun projet de data science. On a un <em>notebook</em> un peu monolithique, qui r√©alise les √©tapes classiques d‚Äôun <em>pipeline</em> de <em>machine learning</em> :</p>
<ul>
<li>Import de donn√©es ;</li>
<li>Statistiques descriptives et visualisations ;</li>
<li><em>Feature engineering</em> ;</li>
<li>Entra√Ænement d‚Äôun mod√®le ;</li>
<li>Evaluation du mod√®le.</li>
</ul>
<section id="objectif" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="objectif">Objectif</h2>
<p><strong>L‚Äôobjectif est d‚Äôam√©liorer le projet de mani√®re incr√©mentale jusqu‚Äô√† pouvoir le mettre en production, en le valorisant sous une forme adapt√©e et en adoptant une m√©thode de travail fluidifiant les √©volutions futures.</strong></p>
<p>La <a href="#fig-start" class="quarto-xref">Figure&nbsp;1</a> montre que notre point de d√©part initial, √† savoir un <em>notebook</em>, m√©lange tout. Ceci rend tr√®s complexe la mise √† jour de notre mod√®le ou l‚Äôexploitation de notre mod√®le sur de nouvelles donn√©es, ce qui est pourtant la raison d‚Äô√™tre du <em>machine learning</em> qui est pens√© pour l‚Äôextrapolation. Si on vous demande de valoriser votre mod√®le sur de nouvelles donn√©es, vous risquez de devoir refaire tourner tout votre <em>notebook</em>, avec le risque de ne pas retrouver les m√™mes r√©sultats que dans la version pr√©c√©dente.</p>
<p>La <a href="#fig-end" class="quarto-xref">Figure&nbsp;2</a> illustre l‚Äôhorizon auquel nous aboutirons √† la fin de cette application. Nous d√©synchronisons les √©tapes d‚Äôentra√Ænement et de pr√©diction, en identifiant mieux les pr√©-requis de chacune et en adoptant des briques technologiques adapt√©es √† celles-ci. Les noms pr√©sents sur cette figure sont encore obscurs, c‚Äôest normal, mais ils vous deviendrons familiers si vous adoptez une infrastructure et une m√©thode de travail √† l‚Äô√©tat de l‚Äôart.</p>
<div id="fig-start" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-start-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../drawio/starting_point.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-start-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Illustration de notre point de d√©part
</figcaption>
</figure>
</div>
<div id="fig-end" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-end-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../drawio/end_point.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-end-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Illustration de l‚Äôhorizon vers lequel on se dirige
</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Il est important de bien lire les consignes et d‚Äôy aller progressivement. Certaines √©tapes peuvent √™tre rapides, d‚Äôautres plus fastidieuses ; certaines √™tre assez guid√©es, d‚Äôautres vous laisser plus de libert√©. Si vous n‚Äôeffectuez pas une √©tape, vous risquez de ne pas pouvoir passer √† l‚Äô√©tape suivante qui en d√©pend.</p>
<p>Bien que l‚Äôexercice soit applicable sur toute configuration bien faite, nous recommandons de privil√©gier l‚Äôutilisation du <a href="https://datalab.sspcloud.fr/home">SSP Cloud</a>, o√π tous les outils n√©cessaires sont pr√©-install√©s et pr√©-configur√©s. Le service <code>VSCode</code> ne sera en effet que le point d‚Äôentr√©e pour l‚Äôutilisation d‚Äôoutils plus exigeants sur le plan de l‚Äôinfrastructure: <em>Argo</em>, <em>MLFLow</em>, etc.</p>
</div>
</div>
</section>
<section id="ce-que-cette-application-ne-couvre-pas-pour-le-moment" class="level2">
<h2 class="anchored" data-anchor-id="ce-que-cette-application-ne-couvre-pas-pour-le-moment">Ce que cette application ne couvre pas (pour le moment)</h2>
<p>A l‚Äôheure actuelle, cette application se concentre sur la mise en oeuvre fiable de l‚Äôentra√Ænement de mod√®les de machine learning. Comme vous pouvez le voir, quand on part d‚Äôaussi loin qu‚Äôun projet monolithique dans un <em>notebook</em>, c‚Äôest un travail cons√©quent d‚Äôen arriver √† un <em>pipeline</em> pens√© pour la production. Cette application vise √† vous sensibiliser au fait qu‚Äôavoir la <a href="#fig-end" class="quarto-xref">Figure&nbsp;2</a> en t√™te et adopter une organisation de travail et faire des choix techniques ad√©quats, vous fera √©conomiser des dizaines voire centaines d‚Äôheures lorsque votre mod√®le aura vocation √† passer en production.</p>
<p>A l‚Äôheure actuelle, cette application ne se concentre que sur une partie du cycle de vie d‚Äôun projet <em>data</em> ; il y a d√©j√† fort √† faire. Nous nous concentrons sur l‚Äôentra√Ænement et la mise √† disposition d‚Äôun mod√®le √† des fins op√©rationnelles. C‚Äôest la premi√®re partie du cycle de vie d‚Äôun mod√®le. Dans une approche MLOps, il faut √©galement penser la maintenance de ce mod√®le et les enjeux que repr√©sentent l‚Äôarriv√©e continue de nouvelles donn√©es, ou le besoin d‚Äôen collecter de nouvelles √† travers des annotations, sur la qualit√© pr√©dictive d‚Äôun mod√®le. Toute entreprise qui ne pense pas cet apr√®s est vou√©e √† se faire doubler par un nouveau venu. Une prochaine version de cette application permettra certainement d‚Äôillustrer certains des enjeux aff√©rants √† la vie en production d‚Äôun mod√®le (supervision, annotations‚Ä¶) sur notre cas d‚Äôusage.</p>
<p>Il convient aussi de noter que nous ne faisons que parcourir la surface des sujets que nous √©voquons. Ce cours, d√©j√† dense, deviendrait indigeste si nous devions pr√©senter chaque outil dans le d√©tail. Nous laissons donc les curieux approfondir chacun des outils que nous pr√©sentons pour d√©couvrir comment en tirer le maximum (et si vous avez l‚Äôimpression que nous oublions des √©l√©ments cruciaux, les <a href="https://github.com/ensae-reproductibilite/website"><em>issues</em> et <em>pull requests <i class="fa-brands fa-github" aria-label="github"></i></em></a> sont bienvenues).</p>
</section>
<section id="comment-g√©rer-les-checkpoints" class="level2">
<h2 class="anchored" data-anchor-id="comment-g√©rer-les-checkpoints">Comment g√©rer les <em>checkpoints</em> ?</h2>
<p>Pour simplifier la reprise en cours de ce fil rouge, nous proposons un syst√®me de <em>checkpoints</em> qui s‚Äôappuient sur des <em>tags</em> <code>Git</code>. Ces <em>tags</em> figent le projet tel qu‚Äôil est √† l‚Äôissue d‚Äôun exercice donn√©.</p>
<p>Si vous faites √©voluer votre projet de mani√®re exp√©rimentale mais d√©sirez tout de m√™me utiliser √† un moment ces checkpoints, il va falloir faire quelques acrobaties <code>Git</code>. Pour cela, nous mettons √† disposition un script qui permet de sauvegarder votre avanc√©e dans un <em>tag</em> donn√© (au cas o√π, √† un moment, vous vouliez revenir dessus) et √©craser la branche <code>main</code> avec le <em>tag</em> en question. Par exemple, si vous d√©sirez reprendre apr√®s l‚Äôexercice 9, vous devrez faire tourner le code dans cette boite :</p>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli9-contents" aria-controls="callout-appli9" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint d'exemple      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli9" class="callout-appli9-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli9<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli9" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli9</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<p>Celui-ci sauvegarde votre avanc√©e dans un tag nomm√© <code>dev_before_appli9</code>, le pousse sur votre d√©p√¥t <code>Github</code> <i class="fa-brands fa-github" aria-label="github"></i> puis force votre branche √† adopter l‚Äô√©tat du tag <code>appli9</code>.</p>
</section>
</section>
<section id="partie-0-initialisation-du-projet" class="level1">
<h1>Partie 0 : initialisation du projet</h1>
<p>Nous allons prendre comme point de d√©part un projet livr√© exclusivement avec un <em>notebook</em>, √† la mani√®re d‚Äôun challenge <em>Kaggle</em>. Vous pourrez ainsi voir √† quel point ce type de livrable est tr√®s loin d‚Äô√™tre satisfaisant si on veut que le projet soit r√©utilisable.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application pr√©liminaire 1: forker le d√©p√¥t d‚Äôexemple
</div>
</div>
<div class="callout-body-container callout-body">
<p>Les premi√®res √©tapes consistent √† mettre en place son environnement de travail sur <code>Github</code>:</p>
<ul>
<li><p>G√©n√©rer un jeton d‚Äôacc√®s (<em>token</em>) sur <code>GitHub</code> afin de permettre l‚Äôauthentification en ligne de commande √† votre compte. La proc√©dure est d√©crite <a href="https://docs.sspcloud.fr/onyxia-guide/controle-de-version#creer-un-jeton-dacces-token">ici</a>. <strong>Vous ne voyez ce jeton qu‚Äôune fois, ne fermez pas la page de suite</strong>.</p></li>
<li><p>Mettez de c√¥t√© ce jeton en l‚Äôenregistrant dans un gestionnaire de mot de passe ou dans l‚Äôespace <em><a href="https://datalab.sspcloud.fr/account/third-party-integration">‚ÄúMon compte‚Äù</a></em> du <code>SSP Cloud</code>.</p></li>
<li><p>Forker le d√©p√¥t <code>Github</code> <i class="fa-brands fa-github" aria-label="github"></i> : <a href="https://github.com/ensae-reproductibilite/application">https://github.com/ensae-reproductibilite/application</a> en faisant attention √† une option :</p>
<ul>
<li><strong>D√©cocher la case <em>‚ÄúCopy the <code>main</code> branch only‚Äù</em></strong> afin de copier √©galement les <em>tags</em> <code>Git</code> qui nous permettront de faire les <em>checkpoint</em>.</li>
</ul></li>
</ul>
<details>
<summary>
Ce que vous devriez voir sur la page de cr√©ation du <em>fork</em>.
</summary>
<p><img src="../fork-example.png" class="img-fluid"></p>
</details>
</div>
</div>
<p>Nous recommandons d‚Äôutiliser, tout au long de ce projet, l‚Äôenvironnement de d√©veloppement <code>VSCode</code>. En plus d‚Äô√™tre tr√®s bien construit, les nombreuses extensions disponibles rendent celui-ci adaptable √† tous nos besoins. Comme il s‚Äôagit de l‚Äôoutil sur lequel vous passerez votre quotidien, n‚Äôh√©sitez pas √† personnaliser celui-ci gr√¢ce aux nombreuses ressources disponibles en ligne<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application pr√©liminaire 2: mettre en place son environnement de travail
</div>
</div>
<div class="callout-body-container callout-body">
<p>Il est maintenant possible de ce lancer dans la cr√©ation de l‚Äôenvironnement de travail:</p>
<ul>
<li>Ouvrir un service <code>VSCode</code> sur le <a href="https://datalab.sspcloud.fr/home">SSP Cloud</a>. Vous pouvez aller dans la page <code>My Services</code> et cliquer sur <code>New service</code>. Sinon, vous pouvez initialiser la cr√©ation du service en cliquant directement <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?autoLaunch=false">ici</a>. <strong>Modifier les options suivantes</strong>:
<ul>
<li>Dans l‚Äôonglet <code>Role</code>, s√©lectionner le r√¥le <code>Admin</code> ;</li>
<li>Dans l‚Äôonglet <code>Networking</code>, cliquer sur <em>‚ÄúEnable a custom service port‚Äù</em> et laisser la valeur par d√©faut 5000 pour le num√©ro du port</li>
<li><em>(optionnel)</em> Pour pr√©installer quelques extensions suppl√©mentaires √† celles disponibles par d√©faut, dans l‚Äôonglet <code>Init</code>, dans le champ <code>PersonalInit</code>, renseigner l‚Äôadresse <a href="https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/init.sh">https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/init.sh</a></li>
</ul></li>
<li>Cl√¥ner <strong>votre</strong> d√©p√¥t <code>Github</code> en utilisant le terminal depuis <code>Visual Studio</code> (<code>Terminal &gt; New Terminal</code>) et en passant directement le token dans l‚ÄôURL selon cette structure:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb1" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git clone https://<span class="va">$TOKEN</span>@github.com/<span class="va">$USERNAME</span>/application.git</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>o√π <code>$TOKEN</code> et <code>$USERNAME</code> sont √† remplacer, respectivement, par le jeton que vous avez g√©n√©r√© pr√©c√©demment et votre nom d‚Äôutilisateur.</p>
<details>
<summary>
Le script d‚Äôinitialisation propos√©
</summary>
<p>Ce script initialise quelques extensions int√©ressantes pour le d√©veloppement de projets utilisant <code>Python</code> ou des fichiers textes type <code>Markdown</code> ou <code>YAML</code>: diagnostic, mise en forme automatis√©e, etc.</p>
<div class="sourceCode" id="cb2" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the configuration directory for VS Code</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>VSCODE_CONFIG_DIR<span class="op">=</span><span class="st">"$HOME/.local/share/code-server/User"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the configuration directory if necessary</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>mkdir <span class="op">-</span>p <span class="st">"$VSCODE_CONFIG_DIR"</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># User settings file</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>SETTINGS_FILE<span class="op">=</span><span class="st">"$VSCODE_CONFIG_DIR/settings.json"</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>code<span class="op">-</span>server <span class="op">--</span>install<span class="op">-</span>extension yzhang.markdown<span class="op">-</span><span class="bu">all</span><span class="op">-</span><span class="kw">in</span><span class="op">-</span>one</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>code<span class="op">-</span>server <span class="op">--</span>install<span class="op">-</span>extension oderwat.indent<span class="op">-</span>rainbow</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>code<span class="op">-</span>server <span class="op">--</span>install<span class="op">-</span>extension tamasfe.even<span class="op">-</span>better<span class="op">-</span>toml</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>code<span class="op">-</span>server <span class="op">--</span>install<span class="op">-</span>extension aaron<span class="op">-</span>bond.better<span class="op">-</span>comments</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>code<span class="op">-</span>server <span class="op">--</span>install<span class="op">-</span>extension github.vscode<span class="op">-</span>github<span class="op">-</span>actions</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace default flake8 linter with project-preconfigured ruff</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>code<span class="op">-</span>server <span class="op">--</span>uninstall<span class="op">-</span>extension ms<span class="op">-</span>python.flake8</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>code<span class="op">-</span>server <span class="op">--</span>install<span class="op">-</span>extension charliermarsh.ruff</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>jq <span class="st">'. + {</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="er">    "workbench.colorTheme": "Default Dark Modern",  # Set the theme</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">"editor.rulers"</span>: [<span class="dv">80</span>, <span class="dv">100</span>, <span class="dv">120</span>],  <span class="co"># Add specific vertical rulers</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">"files.trimTrailingWhitespace"</span>: true,  <span class="co"># Automatically trim trailing whitespace</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">"files.insertFinalNewline"</span>: true,  <span class="co"># Ensure files end with a newline</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">"flake8.args"</span>: [</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"--max-line-length=100"</span>  <span class="co"># Max line length for Python linting</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>}<span class="st">' "$SETTINGS_FILE" &gt; "$SETTINGS_FILE.tmp" &amp;&amp; mv "$SETTINGS_FILE.tmp" "$SETTINGS_FILE"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>Si, dans quelques jours, vous d√©sirez relancer un service avec cette configuration, vous pouvez cliquer sur ce lien:</p>
<p><a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false" target="_blank" rel="noopener" data-original-href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false"><img src="https://img.shields.io/badge/SSP%20Cloud-Lancer_avec_VSCode-blue?logo=visualstudiocode&amp;logoColor=blue" alt="Onyxia"></a></p>
<p>En cliquant sur l‚Äôonglet <code>Git</code>, vous pouvez renseigner directement votre URL de la forme <code>https://github.com/username/depot.git</code>: cela cl√¥nera votre d√©p√¥t dans le service et injectera le token pour vous √©conomiser l‚Äôauthentification √† venir lors de la phase de <code>push</code>.</p>
</div>
</div>
</section>
<section id="partie-1-qualit√©-du-script" class="level1">
<h1>Partie 1 : qualit√© du script</h1>
<p>Cette premi√®re partie vise √† <strong>rendre le projet conforme aux bonnes pratiques</strong> pr√©sent√©es dans le cours.</p>
<p>Elle fait intervenir les notions suivantes :</p>
<ul>
<li>Utilisation du <strong>terminal</strong> (voir <a href="../chapters/linux-101.html">Linux 101</a>) ;</li>
<li><strong>Qualit√© du code</strong> (voir <a href="../chapters/code-quality.html">Qualit√© du code</a>) ;</li>
<li><strong>Architecture de projets</strong> (voir <a href="../chapters/projects-architecture.html">Architecture des projets</a>) ;</li>
<li><strong>Contr√¥le de version</strong> avec <code>Git</code> (voir <a href="../chapters/git.html">Rappels <code>Git</code></a>) ;</li>
<li><strong>Travail collaboratif</strong> avec <code>Git</code> et <code>GitHub</code> (voir <a href="../chapters/git.html">Rappels <code>Git</code></a>).</li>
</ul>
<p>Le plan de la partie est le suivant :</p>
<ol type="1">
<li>S‚Äôassurer que le script fonctionne ;</li>
<li>Nettoyer le code des scories formelles avec un <em>linter</em> et un <em>formatter</em> ;</li>
<li>Param√©trisation du script ;</li>
<li>Utilisation de fonctions.</li>
</ol>
<section id="√©tape-1-sassurer-que-le-script-sex√©cute-correctement" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-1-sassurer-que-le-script-sex√©cute-correctement">√âtape 1 : s‚Äôassurer que le script s‚Äôex√©cute correctement</h2>
<p>On va partir du fichier <code>notebook.py</code> qui reprend le contenu du <em>notebook</em><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> mais dans un script classique. Le travail de nettoyage en sera facilit√©.</p>
<p>La premi√®re √©tape est simple, mais souvent oubli√©e : <strong>v√©rifier que le code fonctionne correctement</strong>. Pour cela, nous recommandons de faire un aller-retour entre le script ouvert dans <code>VSCode</code> et un terminal pour le lancer.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 1: corriger les erreurs
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Ouvrir dans <code>VSCode</code> le script <code>titanic.py</code> ;</li>
<li>Ex√©cuter le script en ligne de commande (<code>python titanic.py</code>)<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> pour d√©tecter les erreurs ;</li>
<li>Corriger les deux erreurs qui emp√™chent la bonne ex√©cution ;</li>
<li>V√©rifier le fonctionnement du script en utilisant la ligne de commande:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb3" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python titanic.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Le code devrait afficher des sorties.</p>
<details>
<summary>
Aide sur les erreurs rencontr√©es
</summary>
<p>La premi√®re erreur rencontr√©e est une alerte <code>FileNotFoundError</code>, la seconde est li√©e √† un <em>package</em>.</p>
</details>
<p>Il est maintenant temps de <em>commit</em> les changements effectu√©s avec <code>Git</code><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> :</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb4" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git add titanic.py</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git commit <span class="at">-m</span> <span class="st">"Corrige l'erreur qui emp√™chait l'ex√©cution"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git push</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!----
Temps estim√©: 3mn
------>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli1-contents" aria-controls="callout-appli1" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli1      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli1" class="callout-appli1-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli1<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli1" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli1</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</section>
<section id="√©tape-2-utiliser-un-linter-puis-un-formatter" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-2-utiliser-un-linter-puis-un-formatter">√âtape 2: utiliser un <em>linter</em> puis un <em>formatter</em></h2>
<p>On va maintenant am√©liorer la qualit√© de notre code en appliquant les standards communautaires. Pour cela, on va utiliser le <em>linter</em> classique <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> et le <em>formatter</em> <a href="https://github.com/psf/black"><code>Black</code></a>. Si vous d√©sirez un outil deux en un, il est possible d‚Äôutiliser <a href="https://github.com/astral-sh/ruff-vscode"><code>Ruff</code></a> en compl√©ment ou substitut.</p>
<p>Ce nettoyage automatique du code permettra, au passage, de restructurer notre script de mani√®re plus naturelle.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a>, <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a> et <a href="https://docs.astral.sh/ruff/"><code>Ruff</code></a> sont des <em>packages</em> <code>Python</code> qui s‚Äôutilisent principalement en ligne de commande.</p>
<p>Si vous avez une erreur qui sugg√®re que votre terminal ne connait pas <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a>, <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a>, ou <a href="https://docs.astral.sh/ruff/"><code>Ruff</code></a>, n‚Äôoubliez pas d‚Äôex√©cuter la commande <code>pip install pylint</code>, <code>pip install black</code> ou <code>pip install ruff</code>.</p>
</div>
</div>
<p>Le <em>linter</em> <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> renvoie alors une s√©rie d‚Äôirr√©gularit√©s, en pr√©cisant √† chaque fois la ligne de l‚Äôerreur et le message d‚Äôerreur associ√© (ex : mauvaise identation). Il renvoie finalement une note sur 10, qui estime la qualit√© du code √† l‚Äôaune des standards communautaires √©voqu√©s dans la partie <a href="../chapters/code-quality.html">Qualit√© du code</a>.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 2: rendre lisible le script
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Diagnostiquer et √©valuer la qualit√© de <code>titanic.py</code> avec <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a>. Regarder la note obtenue.</li>
<li>Utiliser <code>black titanic.py --diff --color</code> pour observer les changements de forme que va induire l‚Äôutilisation du <em>formatter</em> <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a>. Cette √©tape n‚Äôapplique pas les modifications, elle ne fait que vous les montrer.</li>
<li>Appliquer le <em>formatter</em> <a href="https://black.readthedocs.io/en/stable/"><code>Black</code></a></li>
<li>R√©utiliser <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> pour diagnostiquer l‚Äôam√©lioration de la qualit√© du script et le travail qui reste √† faire.</li>
<li>Comme la majorit√© du travail restant est √† consacrer aux imports:
<ul>
<li>Mettre tous les <em>imports</em> ensemble en d√©but de script</li>
<li>Retirer les <em>imports</em> redondants en s‚Äôaidant des diagnostics de votre √©diteur</li>
<li>R√©ordonner les <em>imports</em> si <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a> vous indique de le faire</li>
<li>Corriger les derni√®res fautes formelles sugg√©r√©es par <a href="https://pylint.readthedocs.io/en/latest/"><code>PyLint</code></a></li>
</ul></li>
<li>D√©limiter des parties dans votre code pour rendre sa structure plus lisible. Si des parties vous semblent √™tre dans le d√©sordre, vous pouvez r√©ordonner le script (mais n‚Äôoubliez pas de le tester)</li>
</ul>
<!-----
Temps test Julien: 22mn
------>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli2-contents" aria-controls="callout-appli2" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli2      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli2" class="callout-appli2-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli2<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli2" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli2</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<p>Le code est maintenant lisible, il obtient √† ce stade une note formelle proche de 10. Mais il n‚Äôest pas encore totalement intelligible ou fiable. Il y a notamment quelques redondances de code auxquelles nous allons nous attaquer par la suite. N√©anmoins, avant cela, occupons-nous de mieux g√©rer certains param√®tres du script: jetons d‚ÄôAPI et chemin des fichiers.</p>
</section>
<section id="√©tape-3-gestion-des-param√®tres" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-3-gestion-des-param√®tres">√âtape 3: gestion des param√®tres</h2>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-pre-appli3-contents" aria-controls="callout-appli2" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Reprendre √† partir d'ici      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-pre-appli3" class="callout-pre-appli3-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        <b>Si vous n'avez plus de <code>VSCode</code> actif avec la configuration propos√©e dans l'application pr√©liminaire</b>, vous pouvez repartir de ce service:<br><center>    <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false" target="_blank" rel="noopener" data-original-href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false">
      <img src="https://img.shields.io/badge/SSP%20Cloud-Lancer_avec_VSCode-blue?logo=visualstudiocode&amp;logoColor=blue" alt="Onyxia">
    </a>
    </center><br>Et ensuite, apr√®s avoir cl√¥n√© le d√©p√¥t<br><br>
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli2<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli2" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli2</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<p>L‚Äôex√©cution du code et les r√©sultats obtenus d√©pendent de certains param√®tres d√©finis dans le code. L‚Äô√©tude de r√©sultats alternatifs, en jouant sur des variantes des (hyper)param√®tres, est √† ce stade compliqu√©e car il est n√©cessaire de parcourir le code pour trouver ces param√®tres. De plus, certains param√®tres personnels comme des jetons d‚ÄôAPI ou des mots de passe n‚Äôont pas vocation √† √™tre pr√©sents dans le code.</p>
<p>Il est plus judicieux de consid√©rer ces param√®tres comme des variables d‚Äôentr√©e du script. Cela peut √™tre fait de deux mani√®res:</p>
<ol type="1">
<li>Avec des <strong>arguments optionnels</strong> appel√©s depuis la ligne de commande <em>(Application 3a)</em>. Cela peut √™tre pratique pour mettre en oeuvre des tests automatis√©s mais n‚Äôest pas forc√©ment pertinent pour toutes les variables. Nous allons montrer cet usage avec le nombre d‚Äôarbres de notre <em>random forest</em> ;</li>
<li>En utilisant un <strong>fichier de configuration</strong> dont les valeurs sont import√©es dans le script principal <em>(Application 3b)</em>.</li>
</ol>
<details>
<summary>
Un exemple de d√©finition d‚Äôun argument pour l‚Äôutilisation en ligne de commande
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>prenom.py</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-filename="prenom.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span><span class="st">"Qui √™tes-vous?"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>parser.add_argument(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"--prenom"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, default<span class="op">=</span><span class="st">"Toto"</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Un pr√©nom √† afficher"</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>args <span class="op">=</span> parser.parse_args()</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(args.prenom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Exemples d‚Äôutilisations en ligne de commande</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python prenom.py</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python prenom.py <span class="at">--prenom</span> <span class="st">"Zinedine"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 3a: Param√©trisation du script
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>En s‚Äôinspirant de l‚Äôexemple ci-dessus üëÜÔ∏è, cr√©er une variable <code>n_trees</code> qui peut √©ventuellement √™tre param√©tr√©e en ligne de commande et dont la valeur par d√©faut est 20 ;</li>
<li>Tester cette param√©trisation en ligne de commande avec la valeur par d√©faut puis 2, 10 et 50 arbres.</li>
</ol>
</div>
</div>
<p>L‚Äôexercice suivant permet de mettre en application le fait de param√©triser un script en utilisant des variables d√©finies dans un fichier YAML.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 3b: La configuration dans un fichier d√©di√©
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Installer le package <code>python-dotenv</code> que nous allons utiliser pour charger notre jeton d‚ÄôAPI √† partir d‚Äôune variable d‚Äôenvironnement.</li>
<li>A partir de l‚Äôexemple de la <a href="https://pypi.org/project/python-dotenv/">documentation</a>, utiliser la fonction <code>load_dotenv</code> pour charger dans <code>Python</code> nos variables d‚Äôenvironnement √† partir d‚Äôun fichier (vous pouvez le cr√©er mais ne pas le remplir encore avec les valeurs voulues, ce sera fait ensuite)</li>
<li>Cr√©er la variable et v√©rifier la sortie de <code>Python</code> en faisant tourner <code>titanic.py</code> en ligne de commande</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>titanic.py</strong></pre>
</div>
<div class="sourceCode" id="cb7" data-filename="titanic.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>jeton_api <span class="op">=</span> os.environ.get(<span class="st">"JETON_API"</span>, <span class="st">""</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> jeton_api.startswith(<span class="st">"$"</span>):</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"API token has been configured properly"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"API token has not been configured"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="4" type="1">
<li>Maintenant introduire la valeur voulue pour le jeton d‚ÄôAPI dans le fichier d‚Äôenvironnement lu par <code>dotenv</code></li>
<li>S‚Äôil n‚Äôexiste pas d√©j√†, cr√©er un fichier <code>.gitignore</code> (cf.&nbsp;<a href="../chapters/git.html">Chapitre <code>Git</code></a>). Ajouter dans ce fichier <code>.env</code> car il ne faut pas committer ce fichier. Au passage ajouter <code>__pycache__/</code> au <code>.gitignore</code><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>, cela √©vitera d‚Äôavoir √† le faire ult√©rieurement ;</li>
<li>Cr√©er un fichier <code>README.md</code> o√π vous indiquez qu‚Äôil faut cr√©er un fichier <code>.env</code> pour pouvoir utiliser l‚ÄôAPI.</li>
</ol>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli3-contents" aria-controls="callout-appli3" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli3      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli3" class="callout-appli3-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli3<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli3" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli3</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</section>
<section id="√©tape-4-privil√©gier-la-programmation-fonctionnelle" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-4-privil√©gier-la-programmation-fonctionnelle">√âtape 4 : Privil√©gier la programmation fonctionnelle</h2>
<p>Nous allons <strong>mettre en fonctions les parties importantes de l‚Äôanalyse</strong>. Ceci facilitera l‚Äô√©tape ult√©rieure de modularisation de notre projet. Comme cela est √©voqu√© dans les √©l√©ments magistraux de ce cours, l‚Äôutilisation de fonctions va rendre notre code plus concis, plus tra√ßable, mieux document√©.</p>
<p>Cet exercice √©tant chronophage, il n‚Äôest <strong>pas obligatoire de le r√©aliser en entier</strong>. L‚Äôimportant est de comprendre la d√©marche et d‚Äôadopter fr√©quemment une approche fonctionnelle<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>. Pour obtenir une chaine enti√®rement fonctionnalis√©e, vous pouvez reprendre le <em>checkpoint</em>.</p>
<p>Pour commencer, cet exercice fait un petit pas de c√¥t√© pour faire comprendre la mani√®re dont les <em>pipelines</em> scikit sont un outil au service des bonnes pratiques.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 4 (optionnelle): pourquoi utiliser un <em>pipeline</em> <code>Scikit</code> ?
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Le <em>pipeline</em> <code>Scikit</code> d‚Äôestimation et d‚Äô√©valuation vous a √©t√© donn√© tel quel. Regardez, ci-dessous, le code √©quivalent sans utiliser de <em>pipeline</em> <code>Scikit</code>:</li>
</ul>
<details>
<summary>
<p>Le code √©quivalent sans <em>pipeline</em></p>
</summary>
<div class="sourceCode" id="cb8" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> MinMaxScaler, OneHotEncoder</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># D√©finition des variables</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>numeric_features <span class="op">=</span> [<span class="st">"Age"</span>, <span class="st">"Fare"</span>]</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> [<span class="st">"Embarked"</span>, <span class="st">"Sex"</span>]</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co"># PREPROCESSING ----------------------------</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Handling missing values for numerical features</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>num_imputer <span class="op">=</span> SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>X_train[numeric_features] <span class="op">=</span> num_imputer.fit_transform(X_train[numeric_features])</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>X_test[numeric_features] <span class="op">=</span> num_imputer.transform(X_test[numeric_features])</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Scaling numerical features</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler()</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>X_train[numeric_features] <span class="op">=</span> scaler.fit_transform(X_train[numeric_features])</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>X_test[numeric_features] <span class="op">=</span> scaler.transform(X_test[numeric_features])</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Handling missing values for categorical features</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>cat_imputer <span class="op">=</span> SimpleImputer(strategy<span class="op">=</span><span class="st">"most_frequent"</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>X_train[categorical_features] <span class="op">=</span> cat_imputer.fit_transform(X_train[categorical_features])</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>X_test[categorical_features] <span class="op">=</span> cat_imputer.transform(X_test[categorical_features])</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="co"># One-hot encoding categorical features</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>encoder <span class="op">=</span> OneHotEncoder(handle_unknown<span class="op">=</span><span class="st">'ignore'</span>, sparse_output<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>X_train_encoded <span class="op">=</span> encoder.fit_transform(X_train[categorical_features])</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>X_test_encoded <span class="op">=</span> encoder.transform(X_test[categorical_features])</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert encoded features into a DataFrame</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>X_train_encoded <span class="op">=</span> pd.DataFrame(X_train_encoded, columns<span class="op">=</span>encoder.get_feature_names_out(categorical_features), index<span class="op">=</span>X_train.index)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>X_test_encoded <span class="op">=</span> pd.DataFrame(X_test_encoded, columns<span class="op">=</span>encoder.get_feature_names_out(categorical_features), index<span class="op">=</span>X_test.index)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop original categorical columns and concatenate encoded ones</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> X_train.drop(columns<span class="op">=</span>categorical_features).join(X_train_encoded)</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> X_test.drop(columns<span class="op">=</span>categorical_features).join(X_test_encoded)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="co"># MODEL TRAINING ----------------------------</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Defining the model</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span>n_trees)</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting the model</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a><span class="co"># EVALUATION ----------------------------</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Scoring</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>rdmf_score <span class="op">=</span> model.score(X_test, y_test)</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>rdmf_score<span class="sc">:.1%}</span><span class="ss"> de bonnes r√©ponses sur les donn√©es de test pour validation"</span>)</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="dv">20</span> <span class="op">*</span> <span class="st">"-"</span>)</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"matrice de confusion"</span>)</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(confusion_matrix(y_test, model.predict(X_test)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li><p>Voyez-vous l‚Äôint√©r√™t de l‚Äôapproche par <em>pipeline</em> en termes de lisibilit√©, √©volutivit√© et fiabilit√© ?</p></li>
<li><p>Cr√©er un <em>notebook</em> qui servira de brouillon. Y introduire le code suivant:</p></li>
</ul>
<details>
<summary>
<p>Le code √† copier-coller dans un <em>notebook</em></p>
</summary>
<div class="sourceCode" id="cb9" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder, MinMaxScaler</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> pd.read_csv(<span class="st">"train.csv"</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>test <span class="op">=</span> pd.read_csv(<span class="st">"test.csv"</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>X_train, y_train <span class="op">=</span> train.drop(<span class="st">"Survived"</span>, axis<span class="op">=</span><span class="st">"columns"</span>), train[<span class="st">"Survived"</span>]</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>X_test, y_test <span class="op">=</span> test.drop(<span class="st">"Survived"</span>, axis<span class="op">=</span><span class="st">"columns"</span>), train[<span class="st">"Survived"</span>]</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>MAX_DEPTH <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>MAX_FEATURES <span class="op">=</span> <span class="st">"sqrt"</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>n_trees<span class="op">=</span><span class="dv">20</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>numeric_features <span class="op">=</span> [<span class="st">"Age"</span>, <span class="st">"Fare"</span>]</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> [<span class="st">"Embarked"</span>, <span class="st">"Sex"</span>]</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables num√©riques</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>numeric_transformer <span class="op">=</span> Pipeline(</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"imputer"</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>)),</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"scaler"</span>, MinMaxScaler()),</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables cat√©gorielles</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>categorical_transformer <span class="op">=</span> Pipeline(</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"imputer"</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">"most_frequent"</span>)),</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"onehot"</span>, OneHotEncoder()),</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Preprocessing</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"Preprocessing numerical"</span>, numeric_transformer, numeric_features),</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Preprocessing categorical"</span>,</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>            categorical_transformer,</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>            categorical_features,</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Pipeline</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> Pipeline(</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"preprocessor"</span>, preprocessor),</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"classifier"</span>, RandomForestClassifier(</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span>n_trees,</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>            max_depth<span class="op">=</span>MAX_DEPTH,</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>            max_features<span class="op">=</span>MAX_FEATURES</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>        )),</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>pipe.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li><p>Afficher ce pipeline dans une cellule de votre <em>notebook</em>. Cela vous aide-t-il mieux √† comprendre les diff√©rentes √©tapes du <em>pipeline</em> de mod√©lisation ?</p></li>
<li><p>Comment pouvez-vous acc√©der aux √©tapes de <em>preprocessing</em> ?</p></li>
</ul>
<!-------
pipe['preprocessor'] ou pipe[:-1]
--------->
<ul>
<li>Comment pouvez-vous faire pour appliquer le <em>pipeline</em> de <em>preprocessing</em> des variables num√©riques (et uniquement celui-ci) √† ce <em>DataFrame</em> ?</li>
</ul>
<details>
<summary>
<p>Le <em>DataFrame</em> √† cr√©er pour appliquer un bout de notre <em>pipeline</em></p>
</summary>
<div class="sourceCode" id="cb10" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>new_data <span class="op">=</span> {</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Age"</span>: [<span class="dv">22</span>, np.nan, <span class="dv">35</span>, <span class="dv">28</span>, np.nan],</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fare"</span>: [<span class="fl">7.25</span>, <span class="fl">8.05</span>, np.nan, <span class="fl">13.00</span>, <span class="fl">15.50</span>]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>new_data <span class="op">=</span> pd.DataFrame(new_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<!-------
preprocessor_numeric = pipe['preprocessor']['Preprocessing numerical']
new_data_preprocessed = preprocessor_numeric.transform(new_data)

pd.DataFrame(
    new_data_preprocessed,
    columns=preprocessor_numeric[:-1].get_feature_names_out()
)
--------->
<ul>
<li>Normalement ce code ne devrait pas prendre plus d‚Äôune demie-douzaine de lignes. Sans <em>pipeline</em> le code √©quivalent, beaucoup plus verbeux et moins fiable, ressemble √† celui-ci</li>
</ul>
<details>
<summary>
Le code √©quivalent, sans <em>pipeline</em>
</summary>
<div class="sourceCode" id="cb11" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> MinMaxScaler</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># D√©finition des nouvelles donn√©es</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>new_data <span class="op">=</span> pd.DataFrame({</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Age"</span>: [<span class="dv">25</span>, np.nan, <span class="dv">40</span>, <span class="dv">33</span>, np.nan],</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fare"</span>: [<span class="fl">10.50</span>, <span class="fl">7.85</span>, np.nan, <span class="fl">22.00</span>, <span class="fl">12.75</span>]</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co"># D√©finition des transformations (m√™me que dans le pipeline)</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>num_imputer <span class="op">=</span> SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler()</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Apprentissage des transformations sur X_train (assumant que vous l'avez d√©j√†)</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>X_train_numeric <span class="op">=</span> X_train[[<span class="st">"Age"</span>, <span class="st">"Fare"</span>]]  <span class="co"># Supposons que X_train existe</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>num_imputer.fit(X_train_numeric)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>scaler.fit(num_imputer.transform(X_train_numeric))</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Transformation des nouvelles donn√©es</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>new_data_imputed <span class="op">=</span> num_imputer.transform(new_data)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>new_data_scaled <span class="op">=</span> scaler.transform(new_data_imputed)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Cr√©ation du DataFrame final</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>new_data_preprocessed <span class="op">=</span> pd.DataFrame(</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    new_data_scaled,</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"Age_scaled"</span>, <span class="st">"Fare_scaled"</span>]  <span class="co"># G√©n√©rer des noms de colonnes adapt√©s</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Affichage du DataFrame</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(new_data_preprocessed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li>Imaginons que vous ayez d√©j√† des donn√©es pr√©process√©es:</li>
</ul>
<details>
<summary>
<p>Cr√©er des donn√©es <em>pr√©process√©es</em></p>
</summary>
<div class="sourceCode" id="cb12" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>new_data <span class="op">=</span> pd.DataFrame({</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Age"</span>: [<span class="dv">25</span>, np.nan, <span class="dv">40</span>, <span class="dv">33</span>, np.nan],</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fare"</span>: [<span class="fl">10.50</span>, <span class="fl">7.85</span>, np.nan, <span class="fl">22.00</span>, <span class="fl">12.75</span>],</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Embarked"</span>: [<span class="st">"S"</span>, <span class="st">"C"</span>, np.nan, <span class="st">"Q"</span>, <span class="st">"S"</span>],</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sex"</span>: [<span class="st">"male"</span>, <span class="st">"female"</span>, <span class="st">"male"</span>, np.nan, <span class="st">"female"</span>]</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>new_y <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="dv">2</span>, size<span class="op">=</span><span class="bu">len</span>(new_data))</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>preprocessed_data <span class="op">=</span> pd.DataFrame(</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    pipe[:<span class="op">-</span><span class="dv">1</span>].transform(new_data),</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    columns <span class="op">=</span> preprocessor_numeric.get_feature_names_out()</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>preprocessed_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li>D√©terminer le score en pr√©diction sur ces donn√©es</li>
</ul>
<!------
pipe[-1].score(preprocessed_data, new_y)
------->
</div>
</div>
<p>Maintenant, revenons √† notre chaine de production et appliquons des fonctions pour la rendre plus lisible, plus fiable et plus modulaire.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 4: adoption des standards de programmation fonctionnelle
</div>
</div>
<div class="callout-body-container callout-body">
<p>Cette application peut √™tre chronophage, vous pouvez aller plus ou moins loin dans la fonctionalisation de votre script en fonction du temps dont vous disposez.</p>
<ul>
<li>Cr√©er une fonction qui int√®gre les diff√©rentes √©tapes du <em>pipeline</em> (preprocessing et d√©finition du mod√®le). Cette fonction prend en param√®tre le nombre d‚Äôarbres (argument obligatoire) et des arguments optionnels suppl√©mentaires (les colonnes sur lesquelles s‚Äôappliquent les diff√©rentes √©tapes du <em>pipeline</em>, <code>max_depth</code> et <code>max_features</code>).</li>
<li>Cr√©er une fonction d‚Äô√©valuation renvoyant le score obtenu et la matrice de confusion, √† l‚Äôissue d‚Äôune estimation (mais cette estimation est faite en amont de la fonction, pas au sein de celle-ci)</li>
<li>D√©placer toutes les fonctions ensemble, en d√©but de script. Si besoin, ajouter des param√®tres √† votre fichier d‚Äôenvironnement pour cr√©er de nouvelles variables comme les chemins des donn√©es.</li>
<li>En profiter pour supprimer le code zombie qu‚Äôon a gard√© jusqu‚Äô√† pr√©sent mais qui ne correspond pas vraiment √† des op√©rations utiles √† notre chaine de production</li>
</ul>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli4-contents" aria-controls="callout-appli4" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli4      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli4" class="callout-appli4-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli4<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli4" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli4</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<p>Cela ne se remarque pas encore vraiment car nous avons de nombreuses d√©finitions de fonctions mais notre chaine de production est beaucoup plus concise (le script fait environ 150 lignes dont une centaine issues de d√©finitions de fonctions g√©n√©riques). Cette auto-discipline facilitera grandement les √©tapes ult√©rieures. Cela aurait √©t√© n√©anmoins beaucoup moins co√ªteux en temps d‚Äôadopter ces bons gestes de mani√®re plus pr√©coce.</p>
</section>
</section>
<section id="partie2" class="level1">
<h1>Partie 2 : adoption d‚Äôune structure modulaire</h1>
<p>Dans la partie pr√©c√©dente, on a appliqu√© de mani√®re incr√©mentale de nombreuses bonnes pratiques vues tout au long du cours. Ce faisant, on s‚Äôest d√©j√† consid√©rablement rapproch√©s d‚Äôun possible partage du code : celui-ci est lisible et intelligible. Le code est proprement versionn√© sur un d√©p√¥t <code>GitHub</code>.</p>
<p>Cependant, le projet est encore perfectible: il est encore difficile de rentrer dedans si on ne sait pas exactement ce qu‚Äôon recherche. L‚Äôobjectif de cette partie est d‚Äôisoler les diff√©rentes √©tapes de notre <em>pipeline</em>. Outre le gain de clart√© pour notre projet, nous √©conomiserons beaucoup de peines pour la mise en production ult√©rieure de notre mod√®le.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../chapters/applications/figures/pipeline_post_appli4.png" class="img-fluid figure-img"></p>
<figcaption>Etat du <em>pipeline</em> avant la modularisation</figcaption>
</figure>
</div>
<p>Dans cette partie nous allons continuer les am√©liorations incr√©mentales de notre projet avec les √©tapes suivantes:</p>
<ol type="1">
<li>Modularisation du code <code>Python</code> pour s√©parer les diff√©rentes √©tapes de notre <em>pipeline</em> ;</li>
<li>Adopter une structure standardis√©e pour notre projet afin d‚Äôautodocumenter l‚Äôorganisation de celui-ci ;</li>
<li>Documenter les <em>packages</em> indispensables √† l‚Äôex√©cution du code ;</li>
<li>Stocker les donn√©es dans un environnement ad√©quat afin de continuer la d√©marche de s√©parer conceptuellement les donn√©es du code en de la configuration.</li>
</ol>
<section id="√©tape-1-modularisation" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-1-modularisation">√âtape 1 : modularisation</h2>
<p>Nous allons profiter de la modularisation pour adopter une structure applicative pour notre code. Celui-ci n‚Äô√©tant en effet plus lanc√© que depuis la ligne de commande, on peut consid√©rer qu‚Äôon construit une application g√©n√©rique o√π un script principal (<code>main.py</code>) encapsule des √©l√©ments issus d‚Äôautres scripts <code>Python</code>.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 5: modularisation
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>D√©placer les fonctions dans une s√©rie de fichiers d√©di√©s:
<ul>
<li><code>build_pipeline.py</code>: script avec la d√©finition du <em>pipeline</em></li>
<li><code>train_evaluate.py</code>: script avec les fonctions d‚Äô√©valuation du projet</li>
</ul></li>
<li>Sp√©cifier les d√©pendances (i.e.&nbsp;les packages √† importer) dans les modules pour que ceux-ci puissent s‚Äôex√©cuter ind√©pendamment ;</li>
<li>Renommer <code>titanic.py</code> en <code>main.py</code> pour suivre la convention de nommage des projets <code>Python</code> ;</li>
<li>Importer les fonctions n√©cessaires √† partir des modules.</li>
<li>V√©rifier que tout fonctionne bien en ex√©cutant le <em>script</em> <code>main</code> √† partir de la ligne de commande :</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb13" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python main.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Optionnel: profitez en pour mettre un petit coup de <em>formatter</em> √† votre projet, si vous ne l‚Äôavez pas fait r√©guli√®rement.</li>
</ul>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli5-contents" aria-controls="callout-appli5" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli5      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli5" class="callout-appli5-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli5<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli5" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli5</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</section>
<section id="√©tape-2-adopter-une-architecture-standardis√©e-de-projet" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-2-adopter-une-architecture-standardis√©e-de-projet">√âtape 2 : adopter une architecture standardis√©e de projet</h2>
<p>On dispose maintenant d‚Äôune application <code>Python</code> fonctionnelle. N√©anmoins, le projet est certes plus fiable mais sa structuration laisse √† d√©sirer et il serait difficile de rentrer √† nouveau dans le projet dans quelques temps.</p>
<details>
<summary>
Etat actuel du projet üôà
</summary>
<pre data-code-line-numbers=""><code>‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ data.csv
‚îú‚îÄ‚îÄ train.csv
‚îú‚îÄ‚îÄ test.csv
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ build_pipeline.py
‚îú‚îÄ‚îÄ train_evaluate.py
‚îú‚îÄ‚îÄ titanic.ipynb
‚îî‚îÄ‚îÄ main.py</code></pre>
</details>
<p>Comme cela est expliqu√© dans la partie <a href="../chapters/projects-architecture.html">Structure des projets</a>, on va adopter une structure certes arbitraire mais qui va faciliter l‚Äôautodocumentation de notre projet. De plus, une telle structure va faciliter des √©volutions optionnelles comme la <em>packagisation</em> du projet. Passer d‚Äôune structure modulaire bien faite √† un <em>package</em> est quasi-imm√©diat en <code>Python</code>.</p>
<p>On va donc modifier l‚Äôarchitecture de notre projet pour la rendre plus standardis√©e. Pour cela, on va s‚Äôinspirer des structures <a href="https://cookiecutter.readthedocs.io/en/stable/"><code>cookiecutter</code></a> qui g√©n√®rent des <em>templates</em> de projet. En l‚Äôoccurrence notre source d‚Äôinspiration sera le <a href="https://drivendata.github.io/cookiecutter-data-science/"><em>template datascience</em></a> issu d‚Äôun effort communautaire.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>L‚Äôid√©e de <a href="https://cookiecutter.readthedocs.io/en/stable/"><code>cookiecutter</code></a> est de proposer des <em>templates</em> que l‚Äôon utilise pour <strong>initialiser</strong> un projet, afin de b√¢tir √† l‚Äôavance une structure √©volutive. La syntaxe √† utiliser dans ce cas est la suivante :</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb15" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pip install cookiecutter</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cookiecutter https://github.com/drivendata/cookiecutter-data-science</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ici, on a d√©j√† un projet, on va donc faire les choses dans l‚Äôautre sens : on va s‚Äôinspirer de la structure propos√©e afin de r√©organiser celle de notre projet selon les standards communautaires.</p>
</div>
</div>
<p>En s‚Äôinspirant du <em>cookiecutter data science</em> on va adopter la structure suivante:</p>
<details>
<summary>
Structure recommand√©e
</summary>
<pre data-code-line-numbers=""><code>application
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ data
‚îÇ   ‚îú‚îÄ‚îÄ raw
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ data.csv
‚îÇ   ‚îî‚îÄ‚îÄ derived
‚îÇ       ‚îú‚îÄ‚îÄ test.csv
‚îÇ       ‚îî‚îÄ‚îÄ train.csv
‚îú‚îÄ‚îÄ notebooks
‚îÇ   ‚îî‚îÄ‚îÄ titanic.ipynb
‚îî‚îÄ‚îÄ src
    ‚îú‚îÄ‚îÄ pipeline
    ‚îÇ   ‚îî‚îÄ‚îÄ build_pipeline.py
    ‚îî‚îÄ‚îÄ models
        ‚îî‚îÄ‚îÄ train_evaluate.py</code></pre>
</details>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 6: adopter une structure lisible
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><em>(optionnel)</em> Analyser et comprendre la <a href="https://drivendata.github.io/cookiecutter-data-science/#directory-structure">structure de projet</a> propos√©e par le template ;</li>
<li>Modifier l‚Äôarborescence du projet selon le mod√®le ;</li>
<li>Mettre √† jour l‚Äôimport des d√©pendances, le fichier de configuration et <code>main.py</code> avec les nouveaux chemins ;</li>
</ul>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli6-contents" aria-controls="callout-appli6" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli6      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli6" class="callout-appli6-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli6<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli6" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli6</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</section>
<section id="√©tape-3-mieux-tracer-notre-chaine-de-production" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-3-mieux-tracer-notre-chaine-de-production">√âtape 3: mieux tracer notre chaine de production</h2>
<section id="indiquer-lenvironnement-minimal-de-reproductibilit√©" class="level3">
<h3 class="anchored" data-anchor-id="indiquer-lenvironnement-minimal-de-reproductibilit√©">Indiquer l‚Äôenvironnement minimal de reproductibilit√©</h3>
<p>Le script <code>main.py</code> n√©cessite un certain nombre de packages pour √™tre fonctionnel. Chez vous les packages n√©cessaires sont bien s√ªr install√©s mais √™tes-vous assur√© que c‚Äôest le cas chez la personne qui testera votre code ?</p>
<p>Afin de favoriser la portabilit√© du projet, il est d‚Äôusage de <em>‚Äúfixer l‚Äôenvironnement‚Äù</em>, c‚Äôest-√†-dire d‚Äôindiquer dans un fichier toutes les d√©pendances utilis√©es ainsi que leurs version. Nous proposons de cr√©er un fichier <code>requirements.txt</code> minimal, sur lequel nous reviendrons dans la partie consacr√©e aux environnements reproductibles.</p>
<p>Le fichier <code>requirements.txt</code> est conventionnellement localis√© √† la racine du projet. Ici on ne va pas fixer les versions, on raffinera ce fichier ult√©rieurement.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 7a: cr√©ation du <code>requirements.txt</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Cr√©er un fichier <code>requirements.txt</code> avec la liste des packages n√©cessaires</li>
<li>Ajouter une indication dans <code>README.md</code> sur l‚Äôinstallation des <em>packages</em> gr√¢ce au fichier <code>requirements.txt</code></li>
</ul>
</div>
</div>
</section>
<section id="tracer-notre-cha√Æne" class="level3">
<h3 class="anchored" data-anchor-id="tracer-notre-cha√Æne">Tracer notre cha√Æne</h3>
<p>Quand votre projet passera en production, vous aurez un acc√®s limit√© √† celui-ci. Il est donc important de faire remonter, par le biais du <em>logging</em> des informations critiques sur votre projet qui vous permettront de savoir o√π il en est (si vous avez acc√®s √† la console o√π il tourne) ou l√† o√π il s‚Äôest arr√™t√©.</p>
<p>L‚Äôutilisation de <code>print</code> montre rapidement ses limites pour cela. Les informations enregistr√©es ne persistent pas apr√®s la session et sont quelques peu rudimentaires.</p>
<p>Pour faire du <em>logging</em>, la librairie consacr√©e depuis longtemps en <code>Python</code> est‚Ä¶ <a href="https://docs.python.org/3/library/logging.html"><code>logging</code></a>. Il existe aussi une librairie nomm√©e <a href="https://github.com/Delgan/loguru"><code>loguru</code></a> qui est un peu plus simple √† configurer (l‚Äôinstanciation du <em>logger</em> est plus ais√©e) et plus agr√©able gr√¢ce √† ses messages en couleurs qui permettent de visuellement trier les informations.</p>
<p><img src="https://raw.githubusercontent.com/Delgan/loguru/master/docs/_static/img/demo.gif" class="img-fluid"></p>
<p>L‚Äôexercice suivant peut √™tre fait avec les deux librairies, cela ne change pas grand chose. Les prochaines applications repartiront de la version utilisant la librairie standard <code>logging</code>.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 7b: remont√©e de messages par <em>logging</em>
</div>
</div>
<div class="callout-body-container callout-body">
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="logging">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Version utilisant <code>logging</code></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Version utilisant <code>loguru</code></a></li></ul>
<div class="tab-content" data-group="logging">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<ol type="1">
<li>Aller sur la documentation de la librairie <a href="https://docs.python.org/3/howto/logging.html">ici</a> et sur <a href="https://realpython.com/python-logging/">ce tutoriel</a> pour trouver des sources d‚Äôinspiration sur la configuration et l‚Äôutilisation de <code>logging</code>.</li>
<li>Pour afficher les messages dans la console et dans un fichier de log, s‚Äôinspirer de <a href="https://stackoverflow.com/a/46098711/9197726">cette r√©ponse</a> sur <em>stack overflow</em>.</li>
<li>Tester en ligne de commande votre code et observer le fichier de <em>log</em></li>
</ol>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<ol type="1">
<li>Installer <code>loguru</code> et l‚Äôajouter au <code>requirements.txt</code></li>
<li>En s‚Äôaidant du <code>README</code> du projet sur <a href="https://github.com/Delgan/loguru"><code>Github</code></a>, remplacer nos <code>print</code> par diff√©rents types de messages (info, success, etc.).</li>
<li>Tester l‚Äôex√©cution du script en ligne de commande et observer vos sorties</li>
<li>Mettre √† jour le logger pour enregistrer dans un fichier de <em>log</em>. Ajouter celui-ci au <code>.gitignore</code> puis tester en ligne de commande votre script. Ouvrir le fichier en question, refaites tourner le script et regardez son √©volutoin.</li>
<li>Il est possible avec <code>loguru</code> de capturer les erreurs des fonctions gr√¢ce au syst√®me de cache d√©crit <a href="https://github.com/Delgan/loguru?tab=readme-ov-file#exceptions-catching-within-threads-or-main">ici</a>. Introduire une erreur dans une des fonctions (par exemple dans <code>create_pipeline</code>) avec un code du type <code>raise ValueError("Probl√®me ici")</code></li>
</ol>
</div>
</div>
</div>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli7-contents" aria-controls="callout-appli7" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli7      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli7" class="callout-appli7-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli7<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli7" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli7</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</section>
</section>
<section id="stockageS3" class="level2">
<h2 class="anchored" data-anchor-id="stockageS3">√âtape 4 : stocker les donn√©es de mani√®re externe</h2>
<p>Pour cette partie, il faut avoir un service <code>VSCode</code> dont les jetons d‚Äôauthentification √† <code>S3</code> sont valides. Pour cela, si vous √™tes sur le <code>SSPCloud</code>, le plus simple est de recr√©er un nouveau service avec le bouton suivant</p>
<p><a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false" target="_blank" rel="noopener" data-original-href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false"><img src="https://img.shields.io/badge/SSP%20Cloud-Lancer_avec_VSCode-blue?logo=visualstudiocode&amp;logoColor=blue" alt="Onyxia"></a></p>
<p>et remplir l‚Äôonglet <code>Git</code> comme √ßa votre <code>VSCode</code> sera pr√© √† l‚Äôemploi (cf.&nbsp;application 0).</p>
<p>Une fois que vous avez un <code>VSCode</code> fonctionnel, il est possible de reprendre cette application fil rouge depuis le <em>checkpoint</em> pr√©c√©dent.</p>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-pre-appli8-contents" aria-controls="callout-appli7" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Reprendre √† partir d'ici      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-pre-appli8" class="callout-pre-appli8-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        <b>Si vous n'avez plus de <code>VSCode</code> actif avec la configuration propos√©e dans l'application pr√©liminaire</b>, vous pouvez repartir de ce service:<br><center>    <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false" target="_blank" rel="noopener" data-original-href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false">
      <img src="https://img.shields.io/badge/SSP%20Cloud-Lancer_avec_VSCode-blue?logo=visualstudiocode&amp;logoColor=blue" alt="Onyxia">
    </a>
    </center><br>Et ensuite, apr√®s avoir cl√¥n√© le d√©p√¥t<br><br>
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli7<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli7" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli7</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<p>Enfin, il vous suffira d‚Äôouvrir un terminal et faire <code>pip install -r requirements.txt &amp;&amp; python main.py</code> pour pouvoir d√©marrer l‚Äôapplication.</p>
<p>L‚Äô√©tape pr√©c√©dente nous a permis d‚Äôisoler la configuration. Nous avons conceptuellement isol√© les donn√©es du code lors des applications pr√©c√©dentes. Cependant, nous n‚Äôavons pas √©t√© au bout du chemin car le stockage des donn√©es reste conjoint √† celui du code. Nous allons maintenant dissocier ces deux √©l√©ments.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-16-contents" aria-controls="callout-16" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pour en savoir plus sur le syst√®me de stockage <code>S3</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-16" class="callout-16-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Pour mettre en oeuvre cette √©tape, il peut √™tre utile de comprendre un peu comme fonctionne le SSP Cloud. Vous devrez suivre la <a href="https://inseefrlab.github.io/docs.sspcloud.fr/docs/fr/storage.html">documentation du SSP Cloud</a> pour la r√©aliser. Une aide-m√©moire est √©galement disponible dans le cours de 2e ann√©e de l‚ÄôENSAE <a href="https://linogaliana-teaching.netlify.app/reads3/#">Python pour la <em>data science</em></a>.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pour en savoir plus sur le format <code>Parquet</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>L‚Äôobjectif de cette application est de montrer comment utiliser le format <code>Parquet</code> dans une cha√Æne production ; un objectif somme toute modeste.</p>
<p>Si vous voulez aller plus loin dans la d√©couverte du format <code>Parquet</code>, vous pouvez consulter <a href="https://inseefrlab.github.io/formation-bonnes-pratiques-git-R/slides/complete.html#/application-3-2">cette ressource <code>R</code></a> tr√®s similaire √† ce cours (oui elle est faite par les m√™mes auteurs‚Ä¶) et essayer de faire les exercices avec votre librairie <code>Python</code> de pr√©dilection (<code>PyArrow</code> ou <code>DuckDB</code>)</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-18-contents" aria-controls="callout-18" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Et si vous utilisez une infrastructure <em>cloud</em> qui n‚Äôest pas le <code>SSPCloud</code> ? (une id√©e saugrenue mais sait-on jamais)
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-18" class="callout-18-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Les exemples √† venir peuvent tr√®s bien √™tre r√©pliqu√©s sur n‚Äôimporte quel <em>cloud provider</em> qui propose une solution de type <code>S3</code>, qu‚Äôil s‚Äôagisse d‚Äôun <em>cloud provider</em> priv√© (AWS, GCP, Azure, etc.) ou d‚Äôune r√©instanciation <em>ad hoc</em> du projet <a href="https://www.onyxia.sh/"><code>Onyxia</code></a>, le logiciel derri√®re le <code>SSPCloud</code>.</p>
<p>Pour un syst√®me de stockage <code>S3</code>, il suffit de changer les param√®tres de connexion de <code>s3fs</code> (<em>endpoint</em>, <em>region</em>, etc.). Pour les stockages sur <code>GCP</code>, les codes sont presque √©quivalents, il suffit de remplacer la librairie <a href="https://pypi.org/project/s3fs/"><code>s3fs</code></a> par <a href="https://github.com/fsspec/gcsfs"><code>gcfs</code></a>; ces deux librairies sont en fait des briques d‚Äôun standard plus g√©n√©ral de gestion de syst√®mes de fichiers en <code>Python</code> <a href="https://filesystem-spec.readthedocs.io/en/latest/"><code>ffspec</code></a>.</p>
</div>
</div>
</div>
<p>Le chapitre sur la <a href="../chapters/projects-architecture.html">structure des projets</a> d√©veloppe l‚Äôid√©e qu‚Äôil est recommand√© de converger vers un mod√®le o√π environnements d‚Äôex√©cution, de stockage du code et des donn√©es sont conceptuellement s√©par√©s. Ce haut niveau d‚Äôexigence est un gain de temps important lors de la mise en production car au cours de cette derni√®re, le projet est amen√© √† √™tre ex√©cut√© sur une infrastructure informatique d√©di√©e qu‚Äôil est bon d‚Äôanticiper. Sch√©matiquement, nous visons la structure de projet suivante:</p>
<p><img src="https://inseefrlab.github.io/formation-bonnes-pratiques-git-R/slides/img/environment_clean.png" class="img-fluid"></p>
<p>A l‚Äôheure actuelle, les donn√©es sont stock√©es dans le d√©p√¥t. C‚Äôest une mauvaise pratique. En premier lieu, <code>Git</code> n‚Äôest techniquement pas bien adapt√© au stockage de donn√©es. Ici ce n‚Äôest pas tr√®s grave car il ne s‚Äôagit pas de donn√©es volumineuses et ces derni√®res ne sont pas modifi√©es au cours de notre chaine de traitement.</p>
<p>La raison principale est que les donn√©es trait√©es par les <em>data scientists</em> sont g√©n√©ralement soumises √† des clauses de confidentialit√©s (<a href="https://www.cnil.fr/fr/rgpd-de-quoi-parle-t-on">RGPD</a>, <a href="https://www.insee.fr/fr/information/1300624">secret statistique</a>‚Ä¶). Mettre ces donn√©es sous contr√¥le de version c‚Äôest prendre le risque de les divulguer √† un public non habilit√©. Il est donc recommand√© de privil√©gier des outils techniques adapt√©s au stockage de donn√©es.</p>
<p>L‚Äôid√©al, dans notre cas, est d‚Äôutiliser une solution de stockage externe. On va utiliser pour cela <code>MinIO</code>, la solution de stockage de type <code>S3</code> offerte par le SSP Cloud. Cela nous permettra de supprimer les donn√©es de <code>Github</code> tout en maintenant la reproductibilit√© de notre projet <a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
<p>Plus concr√®tement, nous allons adopter le pipeline suivant pour notre projet:</p>
<p><img src="../chapters/applications/figures/pipeline_appli8.png" class="img-fluid"></p>
<p>Le sc√©nario type est que nous avons une source brute, re√ßue sous forme de CSV, dont on ne peut changer le format. Il aurait √©t√© id√©al d‚Äôavoir un format plus adapt√© au traitement de donn√©es pour ce fichier mais ce n‚Äô√©tait pas de notre ressort. Notre chaine va aller chercher ce fichier, travailler dessus jusqu‚Äô√† valoriser celui-ci sous la forme de notre matrice de confusion. Si on imagine que notre chaine prend un certain temps, il n‚Äôest pas inutile d‚Äô√©crire des donn√©es interm√©diaires. Pour faire cela, puisque nous avons la main, autant choisir un format adapt√©, √† savoir le format <code>Parquet</code>.</p>
<p>Cette application va se d√©rouler en trois temps:</p>
<ol type="1">
<li><em>Upload</em> de notre source brute (CSV) sur S3</li>
<li>Illustration de l‚Äôusage des librairies <em>cloud native</em> pour lire celle-ci</li>
<li>Partage public de cette donn√©e pour la rendre accessible de mani√®re plus simple √† nos futures applications.</li>
</ol>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 8a: ajout de donn√©es sur le syst√®me de stockage <code>S3</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour commencer, √† partir de la ligne de commande, utiliser l‚Äôutilitaire <a href="https://min.io/docs/minio/linux/reference/minio-mc.html">MinIO</a> pour copier les donn√©es <code>data/raw/data.csv</code> vers votre bucket personnel. Les donn√©es interm√©diaires peuvent √™tre laiss√©es en local mais doivent √™tre ajout√©es au <code>.gitignore</code>.</p>
<details>
<summary>
Indice
</summary>
<p>Structure √† adopter:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb17" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>BUCKET_PERSONNEL<span class="op">=</span><span class="st">"nom_utilisateur_sspcloud"</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>mc cp data<span class="op">/</span>raw<span class="op">/</span>data.csv s3<span class="op">/</span>${BUCKET_PERSONNEL}<span class="op">/</span>ensae<span class="op">-</span>reproductibilite<span class="op">/</span>data<span class="op">/</span>raw<span class="op">/</span>data.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
en modifiant la variable <code>BUCKET_PERSONNEL</code>, l‚Äôemplacement de votre bucket personnel
</details>
<p>Pour se simplifier la vie, dans les prochaines applications, on va utiliser des URL de t√©l√©chargement des fichiers (comme si ceux-ci √©taient sur n‚Äôimporte quel espace de stockage) plut√¥t que d‚Äôutiliser une librairie <code>S3</code> compatible comme <code>boto3</code> ou <code>s3fs</code>.</p>
<p>N√©anmoins, il est utile de les utiliser une fois pour comprendre la logique. Pour aller plus loin sur ces librairies, vous pouvez consulter <a href="https://pythonds.linogaliana.fr/content/modern-ds/s3.html#cas-pratique-stocker-les-donn%C3%A9es-de-son-projet-sur-le-ssp-cloud">cette page</a> du cours de 2A de <em>Python pour la data science</em>.</p>
<p>Pour commencer, on va lister les fichiers se trouvant dans un <em>bucket</em>. En ligne de commande, sur notre poste local, on ferait <code>ls</code> (<a href="../chapters/linux-101.html">cf.&nbsp;Linux 101</a>). Cela ne va pas beaucoup diff√©rer avec les librairies <em>cloud native</em>:</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Avec <code>s3fs</code></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Avec <code>mc</code></a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<p>Dans un <em>notebook</em>, copier-coller ce code, le modifier et ex√©cuter:</p>
<div class="sourceCode" id="annotated-cell-33" data-code-line-numbers=""><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-33-1"><a href="#annotated-cell-33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="annotated-cell-33-2"><a href="#annotated-cell-33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-33-3"><a href="#annotated-cell-33-3" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> s3fs.S3FileSystem(client_kwargs<span class="op">=</span>{<span class="st">"endpoint_url"</span>: <span class="st">"https://minio.lab.sspcloud.fr"</span>})</span>
<span id="annotated-cell-33-4"><a href="#annotated-cell-33-4" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-33" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-33-5" class="code-annotation-target"><a href="#annotated-cell-33-5" aria-hidden="true" tabindex="-1"></a>MY_BUCKET <span class="op">=</span> <span class="st">"mon_nom_utilisateur_sspcloud"</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-33" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-33-6" class="code-annotation-target"><a href="#annotated-cell-33-6" aria-hidden="true" tabindex="-1"></a>CHEMIN <span class="op">=</span> <span class="st">"ensae-reproductibilite/data/raw"</span></span>
<span id="annotated-cell-33-7"><a href="#annotated-cell-33-7" aria-hidden="true" tabindex="-1"></a>fs.ls(<span class="ss">f"s3://</span><span class="sc">{</span>MY_BUCKET<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>CHEMIN<span class="sc">}</span><span class="ss">"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-33" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-33" data-code-lines="5" data-code-annotation="1">Changer avec le bucket</span>
</dd>
<dt data-target-cell="annotated-cell-33" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-33" data-code-lines="6" data-code-annotation="2">Changer en fonction du chemin voulu</span>
</dd>
</dl>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<p>Dans un terminal, copier-coller ligne √† ligne ce code, le modifier et ex√©cuter:</p>
<div class="sourceCode" id="annotated-cell-34" data-code-line-numbers=""><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-34-1"><a href="#annotated-cell-34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="annotated-cell-34-2"><a href="#annotated-cell-34-2" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-34-3" class="code-annotation-target"><a href="#annotated-cell-34-3" aria-hidden="true" tabindex="-1"></a>MY_BUCKET<span class="op">=</span><span class="st">"mon_nom_utilisateur_sspcloud"</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-34-4" class="code-annotation-target"><a href="#annotated-cell-34-4" aria-hidden="true" tabindex="-1"></a>CHEMIN <span class="op">=</span> <span class="st">"ensae-reproductibilite/data/raw"</span></span>
<span id="annotated-cell-34-5"><a href="#annotated-cell-34-5" aria-hidden="true" tabindex="-1"></a>mc ls s3<span class="op">/</span>${MY_BUCKET}<span class="op">/</span>${CHEMIN}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-34" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-34" data-code-lines="3" data-code-annotation="1">Changer avec le bucket</span>
</dd>
<dt data-target-cell="annotated-cell-34" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-34" data-code-lines="4" data-code-annotation="2">Changer en fonction du chemin voulu</span>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<p>On va maintenant lire directement une donn√©e stock√©e sur <code>S3</code>. Pour illustrer le fait que cela change peu notre code d‚Äô√™tre sur un syst√®me <em>cloud</em> avec les librairies adapt√©es, on va lire directement un fichier <code>CSV</code> stock√© sur le <code>SSPCloud</code>, sans passer par un fichier en local<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 8b: importer une donn√©e depuis un syst√®me de stockage <code>S3</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour illustrer la coh√©rence avec un syst√®me de fichier local, voici trois solutions pour lire le fichier que vous venez de mettre sur <code>S3</code>. Attention, il faut avoir des jetons de connexion √† <code>S3</code> √† jour. Si vous avez cette erreur</p>
<blockquote class="blockquote">
<p>A client error (InvalidAccessKeyId) occurred when calling the ListBuckets operation: The AWS Access Key Id you provided does not exist in our records.</p>
</blockquote>
<p>c‚Äôest que vos identifiants de connexion ne sont plus √† jour (pour des raisons de s√©curit√©, ils sont r√©guli√®rement renouvel√©s). Dans ce cas, recr√©ez un service <code>VSCode</code> avec le bouton propos√© plus haut.</p>
<p>Dans un <em>notebook</em>, copier-coller et mettre √† jour ces deux variables qui seront utilis√©es dans diff√©rents exemples:</p>
<div class="sourceCode" id="annotated-cell-35" data-code-line-numbers=""><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-35" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-35-1" class="code-annotation-target"><a href="#annotated-cell-35-1" aria-hidden="true" tabindex="-1"></a>MY_BUCKET <span class="op">=</span> <span class="st">"mon_nom_utilisateur_sspcloud"</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-35" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-35-2" class="code-annotation-target"><a href="#annotated-cell-35-2" aria-hidden="true" tabindex="-1"></a>CHEMIN_FICHIER <span class="op">=</span> <span class="st">"ensae-reproductibilite/data/raw/data.csv"</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-35" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-35" data-code-lines="1" data-code-annotation="1">Changer avec le bucket</span>
</dd>
<dt data-target-cell="annotated-cell-35" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-35" data-code-lines="2" data-code-annotation="2">Changer en fonction du chemin voulu</span>
</dd>
</dl>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">Avec <code>Pandas</code> et <code>s3fs</code></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">Avec <code>Pyarrow</code> et <code>s3fs</code></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" role="tab" aria-controls="tabset-3-3" aria-selected="false">Avec <code>DuckDB</code></a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="sourceCode" id="cb18" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> s3fs.S3FileSystem(client_kwargs<span class="op">=</span>{<span class="st">"endpoint_url"</span>: <span class="st">"https://minio.lab.sspcloud.fr"</span>})</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> fs.<span class="bu">open</span>(<span class="ss">f"s3://</span><span class="sc">{</span>MY_BUCKET<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>CHEMIN_FICHIER<span class="sc">}</span><span class="ss">"</span>) <span class="im">as</span> f:</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(f)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="sourceCode" id="cb19" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyarrow <span class="im">import</span> csv</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> s3fs.S3FileSystem(client_kwargs<span class="op">=</span>{<span class="st">"endpoint_url"</span>: <span class="st">"https://minio.lab.sspcloud.fr"</span>})</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> fs.<span class="bu">open</span>(<span class="ss">f"s3://</span><span class="sc">{</span>MY_BUCKET<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>CHEMIN_FICHIER<span class="sc">}</span><span class="ss">"</span>) <span class="im">as</span> f:</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> csv.read_csv(f)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-3-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-3-tab">
<div class="sourceCode" id="cb20" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>con <span class="op">=</span> duckdb.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">":memory:"</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>con.execute(</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"""</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="ss">CREATE SECRET secret (</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="ss">    TYPE S3,</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="ss">    KEY_ID '</span><span class="sc">{</span>os<span class="sc">.</span>environ[<span class="st">"AWS_ACCESS_KEY_ID"</span>]<span class="sc">}</span><span class="ss">',</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="ss">    SECRET '</span><span class="sc">{</span>os<span class="sc">.</span>environ[<span class="st">"AWS_SECRET_ACCESS_KEY"</span>]<span class="sc">}</span><span class="ss">',</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="ss">    ENDPOINT 'minio.lab.sspcloud.fr',</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="ss">    SESSION_TOKEN '</span><span class="sc">{</span>os<span class="sc">.</span>environ[<span class="st">"AWS_SESSION_TOKEN"</span>]<span class="sc">}</span><span class="ss">',</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="ss">    REGION 'us-east-1',</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="ss">    URL_STYLE 'path',</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="ss">    SCOPE 's3://</span><span class="sc">{</span>MY_BUCKET<span class="sc">}</span><span class="ss">/'</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="ss">);</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>query_definition <span class="op">=</span> <span class="ss">f"SELECT * FROM read_csv('s3://</span><span class="sc">{</span>MY_BUCKET<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>CHEMIN_FICHIER<span class="sc">}</span><span class="ss">')"</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> con.sql(query_definition)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>Pour illustrer le fonctionnement encore plus simple de S3 avec les fichiers <code>Parquet</code>, on propose de copier un <code>Parquet</code> mis √† disposition dans un <em>bucket</em> collectiv vers votre <em>bucket</em> personnel:</p>
<div class="sourceCode" id="annotated-cell-36" data-code-line-numbers=""><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-36-1" class="code-annotation-target"><a href="#annotated-cell-36-1" aria-hidden="true" tabindex="-1"></a>BUCKET_PERSONNEL<span class="op">=</span><span class="st">"nom_utilisateur_sspcloud"</span></span>
<span id="annotated-cell-36-2"><a href="#annotated-cell-36-2" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-36-3" class="code-annotation-target"><a href="#annotated-cell-36-3" aria-hidden="true" tabindex="-1"></a>curl <span class="op">-</span>o rp.parquet <span class="st">"https://minio.lab.sspcloud.fr/projet-formation/bonnes-pratiques/data/REGION=11/part-0.parquet"</span></span>
<span id="annotated-cell-36-4"><a href="#annotated-cell-36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-36-5"><a href="#annotated-cell-36-5" aria-hidden="true" tabindex="-1"></a>mc cp rp.parquet s3<span class="op">/</span>${BUCKET_PERSONNEL}<span class="op">/</span>ensae<span class="op">-</span>reproductibilite<span class="op">/</span>data<span class="op">/</span>example<span class="op">/</span>rp.parquet</span>
<span id="annotated-cell-36-6"><a href="#annotated-cell-36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-36-7"><a href="#annotated-cell-36-7" aria-hidden="true" tabindex="-1"></a>rm rp.parquet</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-36" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-36" data-code-lines="1" data-code-annotation="1">Remplacer par le nom de votre <em>bucket</em>.</span>
</dd>
<dt data-target-cell="annotated-cell-36" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-36" data-code-lines="3" data-code-annotation="2">T√©l√©charger le fichier <code>Parquet</code> mis √† dispositoin</span>
</dd>
</dl>
<p>Pour lire ceux-ci, tester les exemples de code suivants:</p>
<div class="sourceCode" id="annotated-cell-37" data-code-line-numbers=""><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-37" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-37-1" class="code-annotation-target"><a href="#annotated-cell-37-1" aria-hidden="true" tabindex="-1"></a>MY_BUCKET <span class="op">=</span> <span class="st">"mon_nom_utilisateur_sspcloud"</span></span>
<span id="annotated-cell-37-2"><a href="#annotated-cell-37-2" aria-hidden="true" tabindex="-1"></a>CHEMIN_FICHIER <span class="op">=</span> <span class="st">"ensae-reproductibilite/data/example/rp.parquet"</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-37" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-37" data-code-lines="1" data-code-annotation="1">Remplacer ici par la valeur appropri√©e</span>
</dd>
</dl>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">Avec <code>Pandas</code> et <code>s3fs</code></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">Avec <code>Pyarrow</code> et <code>s3fs</code></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-3" role="tab" aria-controls="tabset-4-3" aria-selected="false">Avec <code>DuckDB</code></a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div class="sourceCode" id="cb21" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> s3fs.S3FileSystem(client_kwargs<span class="op">=</span>{<span class="st">"endpoint_url"</span>: <span class="st">"https://minio.lab.sspcloud.fr"</span>})</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_parquet(<span class="ss">f"s3://</span><span class="sc">{</span>MY_BUCKET<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>CHEMIN_FICHIER<span class="sc">}</span><span class="ss">"</span>, filesystem<span class="op">=</span>fs)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="sourceCode" id="cb22" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow <span class="im">as</span> pa</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.parquet <span class="im">as</span> pq</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>s3 <span class="op">=</span> pa.fs.S3FileSystem(endpoint_override <span class="op">=</span><span class="st">"https://minio.lab.sspcloud.fr"</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pq.read_table(<span class="ss">f"</span><span class="sc">{</span>MY_BUCKET<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>CHEMIN_FICHIER<span class="sc">}</span><span class="ss">"</span>, filesystem<span class="op">=</span>s3)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-4-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-3-tab">
<div class="sourceCode" id="cb23" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>con <span class="op">=</span> duckdb.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">":memory:"</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>con.execute(</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"""</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="ss">CREATE SECRET secret (</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="ss">    TYPE S3,</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="ss">    KEY_ID '</span><span class="sc">{</span>os<span class="sc">.</span>environ[<span class="st">"AWS_ACCESS_KEY_ID"</span>]<span class="sc">}</span><span class="ss">',</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="ss">    SECRET '</span><span class="sc">{</span>os<span class="sc">.</span>environ[<span class="st">"AWS_SECRET_ACCESS_KEY"</span>]<span class="sc">}</span><span class="ss">',</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="ss">    ENDPOINT 'minio.lab.sspcloud.fr',</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="ss">    SESSION_TOKEN '</span><span class="sc">{</span>os<span class="sc">.</span>environ[<span class="st">"AWS_SESSION_TOKEN"</span>]<span class="sc">}</span><span class="ss">',</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="ss">    REGION 'us-east-1',</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="ss">    URL_STYLE 'path',</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="ss">    SCOPE 's3://</span><span class="sc">{</span>MY_BUCKET<span class="sc">}</span><span class="ss">/'</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="ss">);</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>query_definition <span class="op">=</span> <span class="ss">f"SELECT * FROM read_parquet('s3://</span><span class="sc">{</span>MY_BUCKET<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>CHEMIN_FICHIER<span class="sc">}</span><span class="ss">')"</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> con.sql(query_definition)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>Pour aller plus loin sur le format <code>Parquet</code>, notamment d√©couvrir comment importer des donn√©es partitionn√©es, vous pouvez traduire en <code>Python</code> les exemples issus de la <a href="https://inseefrlab.github.io/formation-bonnes-pratiques-git-R/slides/complete.html#/application-3-2">formation aux bonnes pratiques avec <code>R</code></a> de l‚ÄôInsee.</p>
</div>
</div>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 8c: privil√©gier le format <code>Parquet</code> dans notre cha√Æne
</div>
</div>
<div class="callout-body-container callout-body">
<p>Dans <code>main.py</code>, remplacer le format csv initialement pr√©vu par un format parquet:</p>
<div class="sourceCode" id="cb24" data-file="main.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>data_train_path <span class="op">=</span> os.environ.get(<span class="st">"train_path"</span>, <span class="st">"data/derived/train.parquet"</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>data_test_path <span class="op">=</span> os.environ.get(<span class="st">"test_path"</span>, <span class="st">"data/derived/test.parquet"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Et modifier l‚Äô√©criture des donn√©es pour utiliser <code>to_parquet</code> plut√¥t que <code>to_csv</code> pour √©crire les fichiers interm√©diaires:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>main.py</strong></pre>
</div>
<div class="sourceCode" id="cb25" data-filename="main.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>pd.concat([X_train, y_train], axis <span class="op">=</span> <span class="dv">1</span>).to_parquet(data_train_path)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>pd.concat([X_test, y_test], axis <span class="op">=</span> <span class="dv">1</span>).to_parquet(data_test_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 8d: partage de donn√©es sur le syst√®me de stockage <code>S3</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Par d√©faut, le contenu de votre <em>bucket</em> est priv√©, seul vous y avez acc√®s. Pour pouvoir lire votre donn√©e, vos applications externes devront utiliser des jetons vous identifiant. Ici, comme nous utilisons une donn√©e publique, vous pouvez rendre accessible celle-ci √† tous en lecture. Dans le jargon S3, cela signifie donner un acc√®s anonyme √† votre donn√©e.</p>
<p>Le mod√®le de commande √† utiliser dans le terminal est le suivant:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-47" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-47" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-47-1" class="code-annotation-target"><a href="#annotated-cell-47-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> BUCKET_PERSONNEL=<span class="st">"nom_utilisateur_sspcloud"</span></span>
<span id="annotated-cell-47-2"><a href="#annotated-cell-47-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mc anonymous set download s3/<span class="va">${BUCKET_PERSONNEL}</span>/ensae-reproductibilite/data/raw/</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-47" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-47" data-code-lines="1" data-code-annotation="1">Remplacer par le nom de votre <em>bucket</em>.</span>
</dd>
</dl>
<p>Les URL de t√©l√©chargement seront de la forme <code>https://minio.lab.sspcloud.fr/&lt;BUCKET_PERSONNEL&gt;/ensae-reproductibilite/data/raw/data.csv</code></p>
<ul>
<li>Remplacer la d√©finition de <code>data_path</code> pour utiliser, par d√©faut, directement l‚ÄôURL dans l‚Äôimport. Modifier, si cela est pertinent, aussi votre fichier <code>.env</code>.</li>
</ul>
<div class="sourceCode" id="annotated-cell-48" data-file="main.py" data-code-line-numbers=""><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-48" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-48-1" class="code-annotation-target"><a href="#annotated-cell-48-1" aria-hidden="true" tabindex="-1"></a>URL_RAW <span class="op">=</span> <span class="st">""</span></span>
<span id="annotated-cell-48-2"><a href="#annotated-cell-48-2" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> os.environ.get(<span class="st">"data_path"</span>, URL_RAW)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-48" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-48" data-code-lines="1" data-code-annotation="1">Modifier avec <code>URL_RAW</code> un lien de la forme <code>"https://minio.lab.sspcloud.fr/${BUCKET_PERSONNEL}/ensae-reproductibilite/data/raw/data.csv"</code> (ne laissez pas <code>${BUCKET_PERSONNEL}</code>, remplacez par la vraie valeur!).</span>
</dd>
</dl>
<ul>
<li><p>Ajouter le dossier <code>data/</code> au <code>.gitignore</code> ainsi que les fichiers <code>*.parquet</code></p></li>
<li><p>Supprimer le dossier <code>data</code> de votre projet et faites <code>git rm --cached -r data</code></p></li>
<li><p>V√©rifier le bon fonctionnement de votre application.</p></li>
</ul>
</div>
</div>
<p>Maintenant qu‚Äôon a arrang√© la structure de notre projet, c‚Äôest l‚Äôoccasion de supprimer le code qui n‚Äôest plus n√©cessaire au bon fonctionnement de notre projet (cela r√©duit la charge de maintenance<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>).</p>
<p>Pour vous aider, vous pouvez utiliser <a href="https://pypi.org/project/vulture/"><code>vulture</code></a> de mani√®re it√©rative pour vous assister dans le nettoyage de votre code.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb26" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>pip install vulture</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>vulture .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<details>
<summary>
Exemple de sortie
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb27" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> vulture .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb28" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>src<span class="op">/</span>data<span class="op">/</span>import_data.py:<span class="dv">3</span>: unused function <span class="st">'split_and_count'</span> (<span class="dv">60</span><span class="op">%</span> confidence)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>src<span class="op">/</span>pipeline<span class="op">/</span>build_pipeline.py:<span class="dv">12</span>: unused function <span class="st">'split_train_test'</span> (<span class="dv">60</span><span class="op">%</span> confidence)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli8-contents" aria-controls="callout-appli8" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli8      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli8" class="callout-appli8-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli8<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli8" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli8</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</section>
</section>
<section id="partie-2bis-packagisation-de-son-projet-optionnel" class="level1">
<h1>Partie 2bis: packagisation de son projet (optionnel)</h1>
<p>Cette s√©rie d‚Äôactions n‚Äôest pas forc√©ment pertinente pour tous les projets. Elle fait un peu la transition entre la modularit√© et la portabilit√©.</p>
<section id="√©tape-1-proposer-des-tests-unitaires-optionnel" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-1-proposer-des-tests-unitaires-optionnel">√âtape 1 : proposer des tests unitaires (optionnel)</h2>
<p>Notre code comporte un certain nombre de fonctions g√©n√©riques. On peut vouloir tester leur usage sur des donn√©es standardis√©es, diff√©rentes de celles du Titanic.</p>
<p>M√™me si la notion de tests unitaires prend plus de sens dans un <em>package</em>, nous pouvons proposer dans le projet des exemples d‚Äôutilisation de la fonction, ceci peut √™tre p√©dagogique.</p>
<p>Nous allons utiliser <a href="https://docs.python.org/3/library/unittest.html"><code>unittest</code></a> pour effectuer des tests unitaires. Cette approche n√©cessite quelques notions de programmation orient√©e objet ou une bonne discussion avec <code>ChatGPT</code>.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 9: test unitaire <em>(optionnel)</em>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Dans le dossier <code>tests/</code>, cr√©er avec l‚Äôaide de <code>ChatGPT</code> ou de <code>Copilot</code> un test pour la fonction <code>split_and_count</code>.</p>
<ul>
<li>Effectuer le test unitaire en ligne de commande avec <code>unittest</code> (<code>python -m unittest tests/test_split.py</code>). Corriger le test unitaire en cas d‚Äôerreur.</li>
<li>Si le temps le permet, proposer des variantes ou d‚Äôautres tests.</li>
</ul>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli9-contents" aria-controls="callout-appli9" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli9      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli9" class="callout-appli9-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli9<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli9" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli9</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Lorsqu‚Äôon effectue des tests unitaires, on cherche g√©n√©ralement √† tester le plus de lignes possibles de son code. On parle de <strong>taux de couverture</strong> (<em>coverage rate</em>) pour d√©signer la statistique mesurant cela.</p>
<p>Cela peut s‚Äôeffectuer de la mani√®re suivante avec le package <a href="https://coverage.readthedocs.io/en/7.2.2/"><code>coverage</code></a>:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb29" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> coverage run <span class="at">-m</span> unittest tests/test_create_variable_title.py</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> coverage report <span class="at">-m</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb30" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>Name                                  Stmts   Miss  Cover   Missing</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="op">-------------------------------------------------------------------</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>src<span class="op">/</span>features<span class="op">/</span>build_features.py           <span class="dv">34</span>     <span class="dv">21</span>    <span class="dv">38</span><span class="op">%</span>   <span class="dv">35</span><span class="op">-</span><span class="dv">36</span>, <span class="dv">48</span><span class="op">-</span><span class="dv">58</span>, <span class="dv">71</span><span class="op">-</span><span class="dv">74</span>, <span class="dv">85</span><span class="op">-</span><span class="dv">89</span>, <span class="dv">99</span><span class="op">-</span><span class="dv">101</span>, <span class="dv">111</span><span class="op">-</span><span class="dv">113</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>tests<span class="op">/</span>test_create_variable_title.py      <span class="dv">21</span>      <span class="dv">1</span>    <span class="dv">95</span><span class="op">%</span>   <span class="dv">54</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="op">-------------------------------------------------------------------</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>TOTAL                                    <span class="dv">55</span>     <span class="dv">22</span>    <span class="dv">60</span><span class="op">%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Le taux de couverture est souvent mis en avant par les gros projets comme indicateur de leur qualit√©. Il existe d‚Äôailleurs des badges <code>Github</code> d√©di√©s.</p>
</div>
</div>
</section>
<section id="√©tape-2-transformer-son-projet-en-package-optionnel" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-2-transformer-son-projet-en-package-optionnel">√âtape 2 : transformer son projet en package (optionnel)</h2>
<p>Notre projet est modulaire, ce qui le rend assez simple √† transformer en <em>package</em>, en s‚Äôinspirant de la structure du <code>cookiecutter</code> adapt√©, issu de <a href="https://py-pkgs.org/03-how-to-package-a-python#package-structure">cet ouvrage</a>.</p>
<p>On va cr√©er un <em>package</em> nomm√© <code>titanicml</code> qui encapsule tout notre code et qui sera appel√© par notre script <code>main.py</code>. La structure attendue est la suivante:</p>
<details>
<summary>
Structure vis√©e
</summary>
<pre data-code-line-numbers=""><code>ensae-reproductibilite-application
‚îú‚îÄ‚îÄ docs                                    ‚îê
‚îÇ   ‚îú‚îÄ‚îÄ main.py                             ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ notebooks                           ‚îÇ Package documentation and examples
‚îÇ       ‚îî‚îÄ‚îÄ titanic.ipynb                   ‚îÇ
‚îú‚îÄ‚îÄ configuration                           ‚îê Configuration (pas √† partager avec Git)
‚îÇ   ‚îî‚îÄ‚îÄ config.yaml                         ‚îò
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ pyproject.toml                          ‚îê
‚îú‚îÄ‚îÄ requirements.txt                        ‚îÇ
‚îú‚îÄ‚îÄ titanicml                               ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                         ‚îÇ Package source code, metadata
‚îÇ   ‚îú‚îÄ‚îÄ data                                ‚îÇ and build instructions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ import_data.py                  ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_create_variable_title.py   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ features                            ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ build_features.py               ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ models                              ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ train_evaluate.py               ‚îò
‚îî‚îÄ‚îÄ tests                                   ‚îê
    ‚îî‚îÄ‚îÄ test_create_variable_title.py       ‚îò Package tests</code></pre>
</details>
<details>
<summary>
Rappel: structure actuelle
</summary>
<pre data-code-line-numbers=""><code>ensae-reproductibilite-application
‚îú‚îÄ‚îÄ notebooks
‚îÇ   ‚îî‚îÄ‚îÄ titanic.ipynb
‚îú‚îÄ‚îÄ configuration
‚îÇ   ‚îî‚îÄ‚îÄ config.yaml
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ src
    ‚îú‚îÄ‚îÄ data
    ‚îÇ   ‚îú‚îÄ‚îÄ import_data.py
    ‚îÇ   ‚îî‚îÄ‚îÄ test_create_variable_title.py
    ‚îú‚îÄ‚îÄ features
    ‚îÇ   ‚îî‚îÄ‚îÄ build_features.py
    ‚îî‚îÄ‚îÄ models
        ‚îî‚îÄ‚îÄ train_evaluate.py</code></pre>
</details>
<p>Il existe plusieurs <em>frameworks</em> pour construire un <em>package</em>. Nous allons privil√©gier <a href="https://python-poetry.org/"><code>Poetry</code></a> √† <a href="https://pypi.org/project/setuptools/"><code>Setuptools</code></a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour cr√©er la structure minimale d‚Äôun <em>package</em>, le plus simple est d‚Äôutiliser le <code>cookiecutter</code> adapt√©, issu de <a href="https://py-pkgs.org/03-how-to-package-a-python#package-structure">cet ouvrage</a>.</p>
<p>Comme on a d√©j√† une structure tr√®s modulaire, on va plut√¥t recr√©er cette structure dans notre projet d√©j√† existant. En fait, il ne manque qu‚Äôun fichier essentiel, le principal distinguant un projet classique d‚Äôun package : <code>pyproject.toml</code>.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb33" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cookiecutter https://github.com/py-pkgs/py-pkgs-cookiecutter.git</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<details>
<summary>
D√©rouler pour voir les choix possibles
</summary>
<div class="sourceCode" id="cb34" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>author_name [Monty Python]: Daffy Duck</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>package_name [mypkg]: titanicml</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>package_short_description []: Impressive Titanic survival analysis</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>package_version [<span class="fl">0.1.0</span>]:</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>python_version [<span class="fl">3.9</span>]:</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>Select open_source_license:</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="op">-</span> MIT</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="op">-</span> Apache License <span class="fl">2.0</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="op">-</span> GNU General Public License v3<span class="fl">.0</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span> <span class="op">-</span> Creative Commons Attribution <span class="fl">4.0</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span> <span class="op">-</span> BSD <span class="dv">3</span><span class="op">-</span>Clause</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span> <span class="op">-</span> Proprietary</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="dv">7</span> <span class="op">-</span> <span class="va">None</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>Choose <span class="im">from</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span> [<span class="dv">1</span>]:</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>Select include_github_actions:</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="op">-</span> no</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="op">-</span> ci</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="op">-</span> ci<span class="op">+</span>cd</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>Choose <span class="im">from</span> <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span> [<span class="dv">1</span>]:</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 10: packagisation <em>(optionnel)</em>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Renommer le dossier <code>titanicml</code> pour respecter la nouvelle arborescence ;</li>
<li>Cr√©er un fichier <code>pyproject.toml</code> sur cette base ;</li>
</ul>
<div class="sourceCode" id="cb35" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "pyproject.toml"</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| filename: "pyproject.toml"</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>[tool.poetry]</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"titanicml"</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>version <span class="op">=</span> <span class="st">"0.0.1"</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>description <span class="op">=</span> <span class="st">"Awesome Machine Learning project"</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>authors <span class="op">=</span> [<span class="st">"Daffy Duck &lt;daffy.duck@fauxmail.fr&gt;"</span>, <span class="st">"Mickey Mouse"</span>]</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>license <span class="op">=</span> <span class="st">"MIT"</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>readme <span class="op">=</span> <span class="st">"README.md"</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>[build<span class="op">-</span>system]</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>requires <span class="op">=</span> [<span class="st">"poetry-core"</span>]</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>build<span class="op">-</span>backend <span class="op">=</span> <span class="st">"poetry.core.masonry.api"</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>[tool.pytest.ini_options]</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>log_cli <span class="op">=</span> true</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>log_cli_level <span class="op">=</span> <span class="st">"WARNING"</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>log_cli_format <span class="op">=</span> <span class="st">"</span><span class="sc">%(asctime)s</span><span class="st"> [</span><span class="sc">%(levelname)8s</span><span class="st">] </span><span class="sc">%(message)s</span><span class="st"> (</span><span class="sc">%(filename)s</span><span class="st">:</span><span class="sc">%(lineno)s</span><span class="st">)"</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>log_cli_date_format <span class="op">=</span> <span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Cr√©er le dossier <code>docs</code> et mettre les fichiers indiqu√©s dedans</li>
<li>Dans <code>titanicml/</code>, cr√©er un fichier <code>__init__.py</code><a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a></li>
</ul>
<div class="sourceCode" id="cb36" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "__init__.py"</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| filename: "__init__.py"</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .data.import_data <span class="im">import</span> (</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    split_and_count</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .pipeline.build_pipeline <span class="im">import</span> (</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    split_train_test,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    create_pipeline</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .models.train_evaluate <span class="im">import</span> (</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    evaluate_model</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>__all__ <span class="op">=</span> [</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"split_and_count"</span>,</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"split_train_test"</span>,</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"create_pipeline"</span>,</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"evaluate_model"</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Installer le package en local avec <code>pip install -e .</code></li>
<li>Modifier le contenu de <code>docs/main.py</code> pour importer les fonctions de notre <em>package</em> <code>titanicml</code> et tester en ligne de commande notre fichier <code>main.py</code></li>
</ul>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli10-contents" aria-controls="callout-appli10" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli10      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli10" class="callout-appli10-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli10<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli10" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli10</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</section>
</section>
<section id="partie3" class="level1">
<h1>Partie 3 : construction d‚Äôun projet portable et reproductible</h1>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-pre-appli10-contents" aria-controls="callout-appli8" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Reprendre √† partir d'ici      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-pre-appli10" class="callout-pre-appli10-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        <b>Si vous n'avez plus de <code>VSCode</code> actif avec la configuration propos√©e dans l'application pr√©liminaire</b>, vous pouvez repartir de ce service:<br><center>    <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false" target="_blank" rel="noopener" data-original-href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false">
      <img src="https://img.shields.io/badge/SSP%20Cloud-Lancer_avec_VSCode-blue?logo=visualstudiocode&amp;logoColor=blue" alt="Onyxia">
    </a>
    </center><br>Et ensuite, apr√®s avoir cl√¥n√© le d√©p√¥t<br><br>
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli8<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli8" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli8</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<p>Dans la partie pr√©c√©dente, on a appliqu√© de mani√®re incr√©mentale de nombreuses bonnes pratiques vues dans les chapitres <a href="../chapters/code-quality.html">Qualit√© du code</a> et <a href="../chapters/projects-architecture.html">Structure des projets</a> tout au long du cours.</p>
<p>Ce faisant, on s‚Äôest d√©j√† consid√©rablement rapproch√©s d‚Äôune possible mise en production : le code est lisible, la structure du projet est normalis√©e et √©volutive, et le code est proprement versionn√© sur un d√©p√¥t <code>GitHub</code> <i class="fa-brands fa-github" aria-label="github"></i>.</p>
<details>
<summary>
Illustration de l‚Äô√©tat actuel du projet
</summary>
<p><img src="../chapters/applications/figures/_pipeline_avant_partie3.png" class="img-fluid"></p>
</details>
<p>A pr√©sent, nous avons une version du projet qui est largement partageable. Du moins en th√©orie, car la pratique est souvent plus compliqu√©e : il y a fort √† parier que si vous essayez d‚Äôex√©cuter votre projet sur un autre environnement (typiquement, votre ordinateur personnel), les choses ne se passent pas du tout comme attendu. Cela signifie qu‚Äô<strong>en l‚Äô√©tat, le projet n‚Äôest pas portable : il n‚Äôest pas possible, sans modifications co√ªteuses, de l‚Äôex√©cuter dans un environnement diff√©rent de celui dans lequel il a √©t√© d√©velopp√©</strong>.</p>
<p>Dans cette trois√®me partie de notre travail vers la mise en production, nous allons voir comment <strong>normaliser l‚Äôenvironnement d‚Äôex√©cution afin de produire un projet portable</strong>. Autrement dit, nous n‚Äôallons plus nous contenter de modularit√© mais allons rechercher la portabilit√©. On sera alors tout proche de pouvoir mettre le projet en production.</p>
<p>On progressera dans l‚Äô√©chelle de la reproductibilit√© de la mani√®re suivante:</p>
<ol type="1">
<li><a href="#anaconda"><strong>Environnements virtuels</strong></a> ;</li>
<li>Cr√©er un <a href="#shell">script shell</a> qui permet, depuis un environnement minimal, de construire l‚Äôapplication de A √† Z ;</li>
<li><a href="#docker"><strong>Images et conteneurs <code>Docker</code></strong></a>.</li>
</ol>
<p>Nous allons repartir de l‚Äôapplication 8, c‚Äôest-√†-dire d‚Äôun projet modulaire mais qui n‚Äôest pas, √† strictement parler, un <em>package</em> (objet des applications optionnelles suivantes 9 et 10).</p>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-pre-appli10-contents" aria-controls="callout-appli8" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Reprendre √† partir d'ici      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-pre-appli10" class="callout-pre-appli10-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        <b>Si vous n'avez plus de <code>VSCode</code> actif avec la configuration propos√©e dans l'application pr√©liminaire</b>, vous pouvez repartir de ce service:<br><center>    <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false" target="_blank" rel="noopener" data-original-href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false">
      <img src="https://img.shields.io/badge/SSP%20Cloud-Lancer_avec_VSCode-blue?logo=visualstudiocode&amp;logoColor=blue" alt="Onyxia">
    </a>
    </center><br>Et ensuite, apr√®s avoir cl√¥n√© le d√©p√¥t<br><br>
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli8<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli8" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli8</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<section id="anaconda" class="level2">
<h2 class="anchored" data-anchor-id="anaconda">√âtape 1 : un environnement pour rendre le projet portable</h2>
<p>Pour qu‚Äôun projet soit portable, il doit remplir deux conditions:</p>
<ul>
<li>Ne pas n√©cessiter de d√©pendance qui ne soient pas renseign√©es quelque part ;</li>
<li>Ne pas proposer des d√©pendances inutiles, qui ne sont pas utilis√©es dans le cadre du projet.</li>
</ul>
<p>Le prochain exercice vise √† mettre ceci en oeuvre. Comme expliqu√© dans le <a href="../chapters/portability.html">chapitre portabilit√©</a>, le choix du gestionnaire d‚Äôenvironnement est laiss√© libre. Il est recommand√© de privil√©gier <code>venv</code> si vous d√©couvrez la probl√©matique de la portabilit√©.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true">Environnement virtuel <code>venv</code></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false">Environnement <code>conda</code></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-3" role="tab" aria-controls="tabset-5-3" aria-selected="false">Environnement virtuel via <code>uv</code></a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<p>L‚Äôapproche la plus l√©g√®re est l‚Äôenvironnement virtuel. Nous avons en fait implicitement d√©j√† commenc√© √† aller vers cette direction en cr√©ant un fichier <code>requirements.txt</code>.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 11a: environnement virtuel <code>venv</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Ex√©cuter <code>pip freeze</code> en ligne de commande et observer la (tr√®s) longue liste de package</li>
<li>Cr√©er l‚Äôenvironnement virtuel <code>titanic</code> en s‚Äôinspirant de <a href="https://packaging.python.org/en/latest/guides/installing-using-pip-and-virtual-environments/">la documentation officielle</a><a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a> ou du <a href="../chapters/portability.html">chapitre d√©di√©</a></li>
<li>Utiliser <code>ls</code> pour observer et comprendre le contenu du dossier <code>titanic/bin</code> install√©</li>
<li>Le SSPCloud, par d√©faut, fonctionne sur un environnement <code>conda</code>. Le d√©sactiver en faisant <code>conda deactivate</code>.</li>
<li>Activer l‚Äôenvironnement et v√©rifier l‚Äôinstallation de <code>Python</code> maintenant utilis√©e par votre machine <!---source titanic/bin/activate && which python----></li>
<li>V√©rifier directement depuis la ligne de commande que <code>Python</code> ex√©cute bien une commande<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a> avec:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb37" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python <span class="at">-c</span> <span class="st">"print('Hello')"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="6" type="1">
<li>Faire la m√™me chose mais avec <code>import pandas as pd</code></li>
<li>Installer les <em>packages</em> √† partir du <code>requirements.txt</code>. Tester √† nouveau <code>import pandas as pd</code> pour comprendre la diff√©rence.</li>
<li>Ex√©cuter <code>pip freeze</code> et comprendre la diff√©rence avec la situation pr√©c√©dente.</li>
<li>V√©rifier que le script <code>main.py</code> fonctionne bien. Sinon ajouter les <em>packages</em> manquants dans le <code>requirements.txt</code> et reprendre de mani√®re it√©rative √† partir de la question 7.</li>
<li>Ajouter le dossier <code>titanic/</code> au <code>.gitignore</code> pour ne pas ajouter ce dossier √† <code>Git</code>.</li>
</ol>
<details>
<summary>
Aide pour la question 4
</summary>
<p>Apr√®s l‚Äôactivation, vous pouvez v√©rifier quel <code>python</code> est utilis√© de cette mani√®re</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb38" data-filename="terminal" data-env="titanic" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">titanic</span><span class="kw">)</span> <span class="ex">$</span> which python</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli11a-contents" aria-controls="callout-appli11a" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli11a      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli11a" class="callout-appli11a-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli11a<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli11a" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli11a</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<p>Les environnements <code>conda</code> sont plus lourds √† mettre en oeuvre que les environnements virtuels mais peuvent permettre un contr√¥le plus formel des d√©pendances.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 11b: environnement <code>conda</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Ex√©cuter <code>conda env export</code> en ligne de commande et observer la (tr√®s) longue liste de package</li>
<li>Cr√©er un environnement <code>titanic</code> avec <a href="https://conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html#creating-an-environment-with-commands"><code>conda create</code></a></li>
<li>Activer l‚Äôenvironnement et v√©rifier l‚Äôinstallation de <code>Python</code> maintenant utilis√©e par votre machine <!---conda activate titanic && which python----></li>
<li>V√©rifier directement depuis la ligne de commande que <code>Python</code> ex√©cute bien une commande<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a> avec:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb39" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python <span class="at">-c</span> <span class="st">"print('Hello')"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="6" type="1">
<li>Faire la m√™me chose mais avec <code>import pandas as pd</code></li>
<li>Installer les <em>packages</em> qu‚Äôon avait list√© dans le <code>requirements.txt</code> pr√©c√©demment. Ne pas faire un <code>pip install -r requirements.txt</code> afin de privil√©gier <code>conda install</code></li>
<li>Ex√©cuter √† nouveau <code>conda env export</code> et comprendre la diff√©rence avec la situation pr√©c√©dente<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a>.</li>
<li>V√©rifier que le script <code>main.py</code> fonctionne bien. Sinon installer les <em>packages</em> manquants et reprndre de mani√®re it√©rative √† partir de la question 7.</li>
<li>Quand <code>main.py</code> fonctionne, faire <code>conda env export &gt; environment.yml</code> pour figer l‚Äôenvironnement de travail.</li>
</ol>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli11b-contents" aria-controls="callout-appli11b" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli11b      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli11b" class="callout-appli11b-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli11b<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli11b" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli11b</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</div>
<div id="tabset-5-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-3-tab">
<p><code>uv</code> est le <em>new kid in the game</em> pour g√©rer les environnements virtuels avec <code>Python</code>.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 11c: environnement virtuel <code>venv</code> (via <code>uv</code>)
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Apr√®s avoir install√© <code>uv</code>, ex√©cuter <code>uv init .</code> et supprimer le fichier <code>hello.py</code> g√©n√©r√©. Ouvrir le <code>pyproject.toml</code> et observer sa structure.</li>
<li>Ex√©cuter <code>uv pip freeze</code> en ligne de commande et observer la (tr√®s) longue liste de package</li>
<li>Cr√©er un environnement virtuel <code>titanic</code> par le biais d‚Äô<code>uv</code> (<a href="https://docs.astral.sh/uv/pip/environments/#creating-a-virtual-environment">documentation</a>) sous le nom <code>titanic</code></li>
<li>Utiliser <code>ls</code> pour observer et comprendre le contenu du dossier <code>titanic/bin</code> install√©</li>
<li>Activer l‚Äôenvironnement et v√©rifier l‚Äôinstallation de <code>Python</code> maintenant utilis√©e par votre machine <!---source titanic/bin/activate && which python----></li>
<li>V√©rifier directement depuis la ligne de commande que <code>Python</code> ex√©cute bien une commande<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a> avec:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb40" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python <span class="at">-c</span> <span class="st">"print('Hello')"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="7" type="1">
<li>Faire la m√™me chose mais avec <code>import pandas as pd</code>. Maintenant, essayer <code>uv run main.py</code> en ligne de commande: comprenez-vous ce qu‚Äôil se passe ?</li>
<li>Installer de mani√®re it√©rative les <em>packages</em> √† partir d‚Äô<code>uv add</code> (<a href="https://docs.astral.sh/uv/guides/projects/#managing-dependencies">documentation</a>) et en testant avec <code>uv run main.py</code>: avez-vous remarqu√© la vitesse √† laquelle cela a √©t√© quand vous avez fait <code>uv add pandas</code> ?</li>
<li>Observer votre <code>pyproject.toml</code>. Regarder le <em>lockfile</em> <code>uv.lock</code>. G√©n√©rer automatiquement le <code>requirements.txt</code> en faisant <a href="https://docs.astral.sh/uv/pip/compile/#locking-requirements"><code>pip compile</code></a> et regarder celui-ci.</li>
<li>Ajouter le dossier <code>titanic/</code> au <code>.gitignore</code> pour ne pas ajouter ce dossier √† <code>Git</code>.</li>
</ol>
<details>
<summary>
Aide pour la question 5
</summary>
<p>Apr√®s l‚Äôactivation, vous pouvez v√©rifier quel <code>python</code> est utilis√© de cette mani√®re</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb41" data-filename="terminal" data-env="titanic" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">titanic</span><span class="kw">)</span> <span class="ex">$</span> which python</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli11c-contents" aria-controls="callout-appli11c" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli11c      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli11c" class="callout-appli11c-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli11c<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli11c" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli11c</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</div>
</div>
</div>
</section>
<section id="shell" class="level2">
<h2 class="anchored" data-anchor-id="shell">√âtape 2: construire l‚Äôenvironnement de notre application via un script <code>shell</code></h2>
<p>Les environnements virtuels permettent de mieux sp√©cifier les d√©pendances de notre projet, mais ne permettent pas de garantir une portabilit√© optimale. Pour cela, il faut recourir √† la technologie des conteneurs. L‚Äôid√©e est de construire une machine, en partant d‚Äôune base quasi-vierge, qui permette de construire √©tape par √©tape l‚Äôenvironnement n√©cessaire au bon fonctionnement de notre projet. C‚Äôest le principe des conteneurs <code>Docker</code> <i class="fa-brands fa-docker" aria-label="docker"></i>.</p>
<p>Leur m√©thode de construction √©tant un peu difficile √† prendre en main au d√©but, nous allons passer par une √©tape interm√©diaire afin de bien comprendre le processus de production.</p>
<ul>
<li>Nous allons d‚Äôabord cr√©er un script <code>shell</code>, c‚Äôest √† dire une suite de commandes <code>Linux</code> permettant de construire l‚Äôenvironnement √† partir d‚Äôune machine vierge ;</li>
<li>Nous transformerons celui-ci en <code>Dockerfile</code> dans un deuxi√®me temps. C‚Äôest l‚Äôobjet de l‚Äô√©tape suivante.</li>
</ul>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" role="tab" aria-controls="tabset-6-1" aria-selected="true">Environnement virtuel <code>venv</code></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" role="tab" aria-controls="tabset-6-2" aria-selected="false">Environnement <code>conda</code></a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-6-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-6-1-tab">
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 12a : cr√©er un fichier d‚Äôinstallation de A √† Z
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Cr√©er un service <code>ubuntu</code> sur le SSP Cloud</li>
<li>Ouvrir un terminal</li>
<li>Cloner le d√©p√¥t</li>
<li>Se placer dans le dossier du projet avec <code>cd</code></li>
<li>Se placer au niveau du checkpoint 11a avec <code>git checkout appli11a</code></li>
<li>Via l‚Äôexplorateur de fichiers, cr√©er le fichier <code>install.sh</code> √† la racine du projet avec le contenu suivant:</li>
</ol>
<details>
<summary>
Script √† cr√©er sous le nom <code>install.sh</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>install.sh</strong></pre>
</div>
<div class="sourceCode" id="cb42" data-filename="terminal" data-no-prefix="true" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Install Python</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="ex">apt-get</span> <span class="at">-y</span> update</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="ex">apt-get</span> install <span class="at">-y</span> python3-pip python3-venv</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create empty virtual environment</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> venv titanic</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> titanic/bin/activate</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Install project dependencies</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ol start="6" type="1">
<li>Changer les permissions sur le script pour le rendre ex√©cutable</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb43" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> chmod +x install.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="7" type="1">
<li>Ex√©cuter le script depuis la ligne de commande avec des droits de super-utilisateur (n√©cessaires pour installer des <em>packages</em> via <code>apt</code>)</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb44" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo ./install.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="8" type="1">
<li>V√©rifier que le script <code>main.py</code> fonctionne correctement dans l‚Äôenvironnement virtuel cr√©√©</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb45" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> source titanic/bin/activate</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 main.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli12a-contents" aria-controls="callout-appli12a" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli12a      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli12a" class="callout-appli12a-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli12a<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli12a" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli12a</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</div>
<div id="tabset-6-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-2-tab">
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 12b : cr√©er un fichier d‚Äôinstallation de A √† Z
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Cr√©er un service <code>ubuntu</code> sur le SSP Cloud</li>
<li>Ouvrir un terminal</li>
<li>Cloner le d√©p√¥t</li>
<li>Se placer dans le dossier du projet avec <code>cd</code></li>
<li>Se placer au niveau du checkpoint 11b avec <code>git checkout appli11b</code></li>
<li>Via l‚Äôexplorateur de fichiers, cr√©er le fichier <code>install.sh</code> √† la racine du projet avec le contenu suivant:</li>
</ol>
<details>
<summary>
Script √† cr√©er sous le nom <code>install.sh</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>install.sh</strong></pre>
</div>
<div class="sourceCode" id="cb46" data-filename="terminal" data-no-prefix="true" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apt-get</span> <span class="at">-y</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> <span class="at">-y</span> install wget</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bash</span> Miniconda3-latest-Linux-x86_64.sh <span class="at">-b</span> <span class="at">-p</span> /miniconda <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span> <span class="at">-f</span> Miniconda3-latest-Linux-x86_64.sh</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="va">PATH</span><span class="op">=</span><span class="st">"/miniconda/bin:</span><span class="va">${PATH}</span><span class="st">"</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create environment</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">-n</span> titanic pandas PyYAML scikit-learn <span class="at">-c</span> conda-forge</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate titanic</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="va">PATH</span><span class="op">=</span><span class="st">"/miniconda/envs/titanic/bin:</span><span class="va">${PATH}</span><span class="st">"</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> main.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ol start="6" type="1">
<li>Changer les permissions sur le script pour le rendre ex√©cutable</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb47" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> chmod +x install.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="7" type="1">
<li>Ex√©cuter le script depuis la ligne de commande avec des droits de super-utilisateur (n√©cessaires pour installer des <em>packages</em> via <code>apt</code>)</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb48" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo ./install.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="8" type="1">
<li>V√©rifier que le script <code>main.py</code> fonctionne correctement dans l‚Äôenvironnement virtuel cr√©√©</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb49" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> conda activate titanic</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 main.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli12b-contents" aria-controls="callout-appli12b" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli12b      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli12b" class="callout-appli12b-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli12b<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli12b" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli12b</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</div>
</div>
</div>
</section>
<section id="docker" class="level2">
<h2 class="anchored" data-anchor-id="docker">√âtape 3: conteneuriser l‚Äôapplication avec <code>Docker</code></h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Cette application n√©cessite l‚Äôacc√®s √† une version interactive de <code>Docker</code>. Il n‚Äôy a pas beaucoup d‚Äôinstances en ligne disponibles.</p>
<p>Nous proposons deux solutions:</p>
<ul>
<li><a href="https://docs.docker.com/get-docker/">Installer <code>Docker</code></a> sur sa machine ;</li>
<li>Se rendre sur l‚Äôenvironnement bac √† sable <em><a href="https://labs.play-with-docker.com">Play with Docker</a></em></li>
</ul>
<p>Sinon, elle peut √™tre r√©alis√©e en essai-erreur par le biais des services d‚Äôint√©gration continue de <code>Github</code> <i class="fa-brands fa-github" aria-label="github"></i> ou <code>Gitlab</code> <i class="fa-brands fa-gitlab" aria-label="gitlab"></i>. N√©anmoins, nous pr√©senterons l‚Äôutilisation de ces services plus tard, dans la prochaine partie.</p>
</div>
</div>
<p>Maintenant qu‚Äôon sait que ce script pr√©paratoire fonctionne, on va le transformer en <code>Dockerfile</code> pour anticiper la mise en production. Comme la syntaxe <code>Docker</code> est l√©g√®rement diff√©rente de la syntaxe <code>Linux</code> classique (voir le <a href="../chapters/portability.html">chapitre portabilit√©</a>), il va √™tre n√©cessaire de changer quelques instructions mais ceci sera tr√®s l√©ger.</p>
<p>On va tester le <code>Dockerfile</code> dans un environnement bac √† sable pour ensuite pouvoir plus facilement automatiser la construction de l‚Äôimage <code>Docker</code>.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 13: cr√©ation de l‚Äôimage <code>Docker</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Se placer dans un environnement avec <code>Docker</code>, par exemple <em><a href="https://labs.play-with-docker.com">Play with Docker</a></em></p>
<section id="cr√©ation-du-dockerfile" class="level4">
<h4 class="anchored" data-anchor-id="cr√©ation-du-dockerfile">Cr√©ation du <code>Dockerfile</code></h4>
<ul>
<li>Dans le terminal <code>Linux</code>, cloner votre d√©p√¥t <code>Github</code></li>
<li>Repartir de la derni√®re version √† disposition. Par exemple, si vous avez privil√©gi√© l‚Äôenvironnement virtuel <code>venv</code>, ce sera:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-85" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-85" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-85-1" class="code-annotation-target"><a href="#annotated-cell-85-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-85-2"><a href="#annotated-cell-85-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli12a</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-85" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-85" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<ul>
<li>Cr√©er via la ligne de commande un fichier texte vierge nomm√© <code>Dockerfile</code> (la majuscule au d√©but du mot est importante)</li>
</ul>
<details>
<summary>
Commande pour cr√©er un <code>Dockerfile</code> vierge depuis la ligne de commande
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb50" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> touch Dockerfile</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ul>
<li>Ouvrir ce fichier via un √©diteur de texte et copier le contenu suivant dedans:</li>
</ul>
<details>
<summary>
Premier <code>Dockerfile</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb51" data-filename="terminal" data-no-prefix="true" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="ex">FROM</span> ubuntu:22.04</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WORKDIR</span> <span class="va">${HOME}</span>/titanic</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Install Python</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="ex">RUN</span> apt-get <span class="at">-y</span> update <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">apt-get</span> install <span class="at">-y</span> python3-pip</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Install project dependencies</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="ex">COPY</span> requirements.txt .</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="ex">RUN</span> pip install <span class="at">-r</span> requirements.txt</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="ex">CMD</span> [<span class="st">"python3"</span>, <span class="st">"main.py"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
</section>
<section id="construire-build-limage" class="level4">
<h4 class="anchored" data-anchor-id="construire-build-limage">Construire (<em>build</em>) l‚Äôimage</h4>
<ul>
<li>Utiliser <code>docker build</code> pour cr√©er une image avec le tag <code>my-python-app</code></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb52" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker build . <span class="at">-t</span> my-python-app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>V√©rifier les images dont vous disposez. Vous devriez avoir un r√©sultat proche de celui-ci :</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb53" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker images</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb54" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>REPOSITORY      TAG       IMAGE ID       CREATED              SIZE</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>my<span class="op">-</span>python<span class="op">-</span>app   latest    <span class="fl">188957e16594</span>   About a minute ago   <span class="dv">879</span><span class="er">MB</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="tester-limage-d√©couverte-du-cache" class="level4">
<h4 class="anchored" data-anchor-id="tester-limage-d√©couverte-du-cache">Tester l‚Äôimage: d√©couverte du cache</h4>
<p>L‚Äô√©tape de <code>build</code> a fonctionn√©: une image a √©t√© construite.</p>
<p>Mais fait-elle effectivement ce que l‚Äôon attend d‚Äôelle ?</p>
<p>Pour le savoir, il faut passer √† l‚Äô√©tape suivante, l‚Äô√©tape de <code>run</code>.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb55" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker run <span class="at">-it</span> my-python-app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb56" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>python3: can<span class="st">'t open file '</span><span class="op">/~/</span>titanic<span class="op">/</span>main.py<span class="st">': [Errno 2] No such file or directory</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Le message d‚Äôerreur est clair : <code>Docker</code> ne sait pas o√π trouver le fichier <code>main.py</code>. D‚Äôailleurs, il ne connait pas non plus les autres fichiers de notre application qui sont n√©cessaires pour faire tourner le code, par exemple le dossier <code>src</code>.</p>
<ul>
<li>Avant l‚Äô√©tape <code>CMD</code>, copier les fichiers n√©cessaires sur l‚Äôimage afin que l‚Äôapplication dispose de tous les √©l√©ments n√©cessaires pour √™tre en mesure de fonctionner.</li>
</ul>
<details>
<summary>
Nouveau <code>Dockerfile</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb57" data-filename="terminal" data-no-prefix="true" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="ex">FROM</span> ubuntu:22.04</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="ex">WORKDIR</span> <span class="va">${HOME}</span>/titanic</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Install Python</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="ex">RUN</span> apt-get <span class="at">-y</span> update <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">apt-get</span> install <span class="at">-y</span> python3-pip</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Install project dependencies</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="ex">COPY</span> requirements.txt .</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="ex">RUN</span> pip install <span class="at">-r</span> requirements.txt</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="ex">COPY</span> main.py .</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="ex">COPY</span> src ./src</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="ex">CMD</span> [<span class="st">"python3"</span>, <span class="st">"main.py"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ul>
<li><p>Refaire tourner l‚Äô√©tape de <code>build</code></p></li>
<li><p>Refaire tourner l‚Äô√©tape de <code>run</code>. A ce stade, la matrice de confusion doit fonctionner üéâ. Vous avez cr√©√© votre premi√®re application reproductible !</p></li>
</ul>
</section>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ici, le <em>cache</em> permet d‚Äô√©conomiser beaucoup de temps. Par besoin de refaire tourner toutes les √©tapes, <code>Docker</code> agit de mani√®re intelligente en faisant tourner uniquement les √©tapes qui ont chang√©.</p>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli13-contents" aria-controls="callout-appli13" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli13      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli13" class="callout-appli13-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli13<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli13" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli13</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</section>
</section>
<section id="partie-4-automatisation-avec-lint√©gration-continue" class="level1">
<h1>Partie 4 : automatisation avec l‚Äôint√©gration continue</h1>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-pre-appli13-contents" aria-controls="callout-appli13" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Reprendre √† partir d'ici      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-pre-appli13" class="callout-pre-appli13-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        <b>Si vous n'avez plus de <code>VSCode</code> actif avec la configuration propos√©e dans l'application pr√©liminaire</b>, vous pouvez repartir de ce service:<br><center>    <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false" target="_blank" rel="noopener" data-original-href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false">
      <img src="https://img.shields.io/badge/SSP%20Cloud-Lancer_avec_VSCode-blue?logo=visualstudiocode&amp;logoColor=blue" alt="Onyxia">
    </a>
    </center><br>Et ensuite, apr√®s avoir cl√¥n√© le d√©p√¥t<br><br>
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli13<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli13" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli13</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<p>Imaginez que vous √™tes au restaurant et qu‚Äôon ne vous serve pas le plat mais seulement la recette et que, de plus, on vous demande de pr√©parer le plat chez vous avec les ingr√©dients dans votre frigo. Vous seriez quelque peu d√©√ßu. En revanche, si vous avez go√ªt√© au plat, que vous √™tes un r√©el cordon bleu et qu‚Äôon vous donne la recette pour refaire ce plat ult√©rieurement, peut-√™tre que vous appr√©ciriez plus.</p>
<p>Cette analogie illustre l‚Äôenjeu de d√©finir le public cible et ses attentes afin de fournir un livrable adapt√©. Une image <code>Docker</code> est un livrable qui n‚Äôest pas forc√©ment int√©ressant pour tous les publics. Certains pr√©f√©reront avoir un plat bien pr√©par√© qu‚Äôune recette ; certains appr√©cieront avoir une image <code>Docker</code> mais d‚Äôautres ne seront pas en mesure de construire celle-ci ou ne sauront pas la faire fonctionner. Une image <code>Docker</code> est plus souvent un moyen pour faciliter la mise en service d‚Äôune production qu‚Äôune fin en soi.</p>
<p>Nous allons donc proposer plusieurs types de livrables plus classiques par la suite. Ceux-ci correspondront mieux aux attendus des publics utilisateurs de services construits √† partir de techniques de <em>data science</em>. <code>Docker</code> est n√©anmoins un passage oblig√© car l‚Äôensemble des types de livrables que nous allons explorer reposent sur la standardisation permise par les conteneurs.</p>
<p>Cette approche nous permettra de quitter le domaine de l‚Äôartisanat pour s‚Äôapprocher d‚Äôune industrialisation de la mise √† disposition de notre projet. Ceci va notamment nous amener √† mettre en oeuvre l‚Äôapproche pragmatique du <code>DevOps</code> qui consiste √† int√©grer d√®s la phase de d√©veloppement d‚Äôun projet les contraintes li√©es √† sa mise √† disposition au public cible (cette approche est d√©taill√©e plus amplement dans le chapitre sur la <a href="../chapters/deployment.html">mise en production</a>).</p>
<p>L‚Äôautomatisation et la mise √† disposition automatis√©e de nos productions sera faite progressivement, au cours des prochaines parties. Tous les projets n‚Äôont pas vocation √† aller aussi loin dans ce domaine. L‚Äôopportunit√© doit √™tre compar√©e aux co√ªts humains et financiers de leur mise en oeuvre et de leur cycle de vie. Avant de faire une production en s√©rie de nos mod√®les, nous allons d√©j√† commencer par automatiser quelques tests de conformit√© de notre code. On va ici utiliser l‚Äôint√©gration continue pour deux objectifs distincts:</p>
<ul>
<li>la mise √† disposition de l‚Äôimage <code>Docker</code> ;</li>
<li>la mise en place de tests automatis√©s de la qualit√© du code sur le mod√®le de notre <code>linter</code> pr√©c√©dent.</li>
</ul>
<p>Nous allons utiliser <code>Github Actions</code> pour cela. Il s‚Äôagit de serveurs standardis√©s mis √† disposition gratuitement par <code>Github</code> <i class="fa-brands fa-github" aria-label="github"></i>. <code>Gitlab</code> <i class="fa-brands fa-gitlab" aria-label="gitlab"></i>, l‚Äôautre principal acteur du domaine, propose des services similaires. L‚Äôimpl√©mentation est l√©g√®rement diff√©rente mais les principes sont identiques.</p>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-pre-appli14-contents" aria-controls="callout-appli13" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Reprendre √† partir d'ici      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-pre-appli14" class="callout-pre-appli14-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        <b>Si vous n'avez plus de <code>VSCode</code> actif avec la configuration propos√©e dans l'application pr√©liminaire</b>, vous pouvez repartir de ce service:<br><center>    <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false" target="_blank" rel="noopener" data-original-href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false">
      <img src="https://img.shields.io/badge/SSP%20Cloud-Lancer_avec_VSCode-blue?logo=visualstudiocode&amp;logoColor=blue" alt="Onyxia">
    </a>
    </center><br>Et ensuite, apr√®s avoir cl√¥n√© le d√©p√¥t<br><br>
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli13<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli13" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli13</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<section id="√©tape-1-mise-en-place-de-tests-automatis√©s" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-1-mise-en-place-de-tests-automatis√©s">√âtape 1: mise en place de tests automatis√©s</h2>
<p>Avant d‚Äôessayer de mettre en oeuvre la cr√©ation de notre image <code>Docker</code> de mani√®re automatis√©e, nous allons pr√©senter la logique de l‚Äôint√©gration continue en testant de mani√®re automatis√©e notre script <code>main.py</code>.</p>
<p>Pour cela, nous allons partir de la structure propos√©e dans l‚Äô<a href="https://github.com/actions/setup-python">action officielle</a>. La documentation associ√©e est <a href="https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python">ici</a>. Des √©l√©ments succincts de pr√©sentation de la logique d√©clarative des actions <code>Github</code> sont disponibles dans le chapitre sur la <a href="../chapters/deployment.html">mise en production</a>. N√©anmoins, la meilleure √©cole pour comprendre le fonctionnement de celles-ci est de parcourir la documentation du service et d‚Äôobserver les actions <code>Github</code> mises en oeuvre par vos projets favoris, celles-ci seront fort instructives !</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 14: premier script d‚Äôint√©gration continue
</div>
</div>
<div class="callout-body-container callout-body">
<p>A partir de l‚Äôexemple pr√©sent dans la <a href="https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python#using-a-specific-python-version">documentation officielle</a> de <code>Github</code> <i class="fa-brands fa-github" aria-label="github"></i>, on a d√©j√† une base de d√©part qui peut √™tre modifi√©e. Les questions suivantes permettront d‚Äôautomatiser les tests et le diagnostic qualit√© de notre code<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a></p>
<ol type="1">
<li>Cr√©er un fichier <code>.github/workflows/test.yaml</code> avec le contenu de l‚Äôexemple de la documentation</li>
<li>Avec l‚Äôaide de la documentation, introduire une √©tape d‚Äôinstallation des d√©pendances. Utiliser le fichier <code>requirements.txt</code> pour installer les d√©pendances.</li>
<li>Utiliser <code>pylint</code> pour v√©rifier la qualit√© du code. Ajouter l‚Äôargument <code>--fail-under=6</code> pour renvoyer une erreur en cas de note trop basse<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a></li>
<li>Utiliser une √©tape appelant notre application en ligne de commande (<code>python main.py</code>) pour tester que la matrice de confusion s‚Äôaffiche bien.</li>
<li>Cr√©er un secret stockant une valeur du <code>JETON_API</code>. Ne le faites pas commencer par un <em>‚Äú$‚Äù</em> comme √ßa vous pourrez regarder la log ult√©rieurement</li>
<li>Aller voir votre test automatis√© dans l‚Äôonglet <code>Actions</code> de votre d√©p√¥t sur <code>Github</code></li>
<li><em>(optionnel)</em>: Cr√©er un <em>artefact</em> √† partir du fichier de <em>log</em> que vous cr√©ez dans <code>main.py</code></li>
</ol>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli14-contents" aria-controls="callout-appli14" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli14      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli14" class="callout-appli14-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli14<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli14" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli14</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<p>Maintenant, nous pouvons observer que l‚Äôonglet <code>Actions</code> s‚Äôest enrichi. Chaque <code>commit</code> va entra√Æner une s√©rie d‚Äôactions automatis√©es.</p>
<p>Si l‚Äôune des √©tapes √©choue, ou si la note de notre projet est mauvaise, nous aurons une croix rouge (et nous recevrons un mail). On pourra ainsi d√©tecter, en d√©veloppant son projet, les moments o√π on d√©grade la qualit√© du script afin de la r√©tablir imm√©diatemment.</p>
</section>
<section id="√©tape-2-automatisation-de-la-livraison-de-limage-docker" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-2-automatisation-de-la-livraison-de-limage-docker">√âtape 2: Automatisation de la livraison de l‚Äôimage <code>Docker</code></h2>
<p>Maintenant, nous allons automatiser la mise √† disposition de notre image sur <code>DockerHub</code> (le lieu de partage des images <code>Docker</code>). Cela facilitera sa r√©utilisation mais aussi des valorisations ult√©rieures.</p>
<p>L√† encore, nous allons utiliser une s√©rie d‚Äôactions pr√©-configur√©es.</p>
<p>Pour que <code>Github</code> puisse s‚Äôauthentifier aupr√®s de <code>DockerHub</code>, il va falloir d‚Äôabord interfacer les deux plateformes. Pour cela, nous allons utiliser un jeton (<em>token</em>) <code>DockerHub</code> que nous allons mettre dans un espace s√©curis√© associ√© √† votre d√©p√¥t <code>Github</code>.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 15a: configuration
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Se rendre sur <a href="https://hub.docker.com/">https://hub.docker.com/</a> et cr√©er un compte. Il est recommand√© d‚Äôassocier ce compte √† votre compte <code>Github</code>.</li>
<li>Cr√©er un d√©p√¥t public <code>application</code></li>
<li>Aller dans les <a href="https://hub.docker.com/settings/general">param√®tres de votre compte</a> et cliquer, √† gauche, sur <code>Security</code></li>
<li>Cr√©er un jeton personnel d‚Äôacc√®s, ne fermez pas l‚Äôonglet en question, vous ne pouvez voir sa valeur qu‚Äôune fois.</li>
<li>Dans le d√©p√¥t <code>Github</code> de votre projet, cliquer sur l‚Äôonglet <code>Settings</code> et cliquer, √† gauche, sur <code>Secrets and variables</code> puis dans le menu d√©roulant en dessous sur <code>Actions</code>. Sur la page qui s‚Äôaffiche, aller dans la section <code>Repository secrets</code></li>
<li>Cr√©er un jeton <code>DOCKERHUB_TOKEN</code> √† partir du jeton que vous aviez cr√©√© sur <code>Dockerhub</code>. Valider</li>
<li>Cr√©er un deuxi√®me secret nomm√© <code>DOCKERHUB_USERNAME</code> ayant comme valeur le nom d‚Äôutilisateur que vous avez cr√©√© sur <code>Dockerhub</code></li>
</ul>
<details>
<summary>
Etape optionnelle suppl√©mentaire si on met en production un site web
</summary>
<ul>
<li>Dans le d√©p√¥t <code>Github</code> de votre projet, cliquer sur l‚Äôonglet <code>Settings</code> et cliquer, √† gauche, sur <code>Actions</code>. Donner les droits d‚Äô√©criture √† vos actions sur le d√©p√¥t du projet (ce sera n√©cessaire pour <code>Github Pages</code>)</li>
</ul>
<p><img src="../permissions.png" class="img-fluid"></p>
</details>
</div>
</div>
<p>A ce stade, nous avons donn√© les moyens √† <code>Github</code> de s‚Äôauthentifier avec notre identit√© sur <code>Dockerhub</code>. Il nous reste √† mettre en oeuvre l‚Äôaction en s‚Äôinspirant de la <a href="https://github.com/docker/build-push-action/#usage">documentation officielle</a>. On ne va modifier que trois √©l√©ments dans ce fichier. Effectuer les actions suivantes:</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 15b: automatisation de l‚Äôimage <code>Docker</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>En s‚Äôinspirant de ce <a href="https://github.com/marketplace/actions/build-and-push-docker-images"><em>template</em></a>, cr√©er le fichier <code>.github/workflows/prod.yml</code> qui va <em>build</em> et <em>push</em> l‚Äôimage sur le <code>DockerHub</code>. Il va √™tre n√©cessaire de changer l√©g√®rement ce mod√®le :
<ul>
<li>Retirer la condition restrictive sur les <em>commits</em> pour lesquels sont lanc√©s cette automatisation. Pour cela, remplacer le contenu de <code>on</code> de sorte √† avoir</li>
</ul>
<div class="sourceCode" id="cb58" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>on:</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  push:</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    branches:</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> main</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Changer le tag √† la fin pour mettre <code>username/application:latest</code> o√π <code>username</code> est le nom d‚Äôutilisateur sur <code>DockerHub</code>;</li>
<li>Optionnel: changer le nom de l‚Äôaction</li>
</ul></li>
<li>Faire un <code>commit</code> et un <code>push</code> de ces fichiers</li>
</ul>
<p>Comme on est fier de notre travail, on va afficher √ßa avec un badge sur le <code>README</code> <em>(partie optionnelle)</em>.</p>
<ul>
<li>Se rendre dans l‚Äôonglet <code>Actions</code> et cliquer sur une des actions list√©es.</li>
<li>En haut √† droite, cliquer sur <code>...</code></li>
<li>S√©lectionner <code>Create status badge</code></li>
<li>R√©cup√©rer le code <code>Markdown</code> propos√©</li>
<li>Copier dans votre <code>README.md</code> le code <em>markdown</em> propos√©</li>
</ul>
<details>
<summary>
Cr√©er le badge
</summary>
<img src="../create-badge.png" class="img-fluid">
</details>
</div>
</div>
<p>Maintenant, il nous reste √† tester notre application dans l‚Äôespace bac √† sable ou en local, si <code>Docker</code> est install√©.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 15b (partie optionnelle): Tester l‚Äôapplication
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Se rendre sur l‚Äôenvironnement bac √† sable <em><a href="https://labs.play-with-docker.com">Play with Docker</a></em> ou dans votre environnement <code>Docker</code> de pr√©dilection.</li>
<li>R√©cup√©rer et lancer l‚Äôimage :</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb59" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker run <span class="at">-it</span> username/application:latest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>üéâ La matrice de confusion doit s‚Äôafficher ! Vous avez grandement facilit√© la r√©utilisation de votre image.</p>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli15-contents" aria-controls="callout-appli15" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli15      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli15" class="callout-appli15-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli15<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli15" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli15</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</section>
</section>
<section id="partie-5-exp√©rimenter-en-local-des-valorisations-puis-automatiser-leur-production" class="level1">
<h1>Partie 5: exp√©rimenter en local des valorisations puis automatiser leur production</h1>
<p>Nous avons automatis√© les √©tapes interm√©diaires de notre projet. N√©anmoins nous n‚Äôavons pas encore r√©fl√©chi √† la valorisation √† mettre en oeuvre pour notre projet. On va supposer que notre projet s‚Äôadresse √† des <em>data scientists</em> mais aussi √† une audience moins technique. Pour ces premiers, nous pourrions nous contenter de valorisations techniques, comme des API, mais pour ces derniers il est conseill√© de privil√©gier des formats plus <em>user friendly</em>.</p>
<p>Afin de faire le parall√®le avec les parcours possibles pour l‚Äô√©valuation, nous allons proposer deux valorisations<a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a>:</p>
<ul>
<li>Une <a href="https://titanic.kub.sspcloud.fr/docs">API</a> facilitant la r√©utilisation du mod√®le en ‚Äúproduction‚Äù ;</li>
<li>Un <a href="https://ensae-reproductibilite.github.io/application/">site web statique</a> exploitant cette API pour exposer les pr√©dictions √† une audience moins technique.</li>
</ul>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-39-contents" aria-controls="callout-39" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Site statique vs application r√©active
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-39" class="callout-39-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>La solution que nous allons proposer pour les sites statiques, <code>Quarto</code> associ√© √† <code>Github Pages</code>, peut √™tre utilis√©e dans le cadre des parcours <em>‚Äúrapport reproductible‚Äù</em> ou <em>‚Äúdashboard / application interactive‚Äù</em>.</p>
<p>Pour ce dernier parcours, d‚Äôautres approches techniques sont n√©anmoins possibles, comme <code>Streamlit</code>. Celles-ci sont plus exigeantes sur le plan technique puisqu‚Äôelles n√©cessitent de mettre en production sur des serveurs conteuneuris√©s (comme la mise en production de l‚ÄôAPI) l√† o√π le site statique ne n√©cessite qu‚Äôun serveur web, mis √† disposition gratuitement par <code>Github</code>.</p>
<p>La distinction principale entre ces deux approches est qu‚Äôelles s‚Äôappuient sur des serveurs diff√©rents. Un site statique repose sur un serveur web l√† o√π <code>Streamlit</code> s‚Äôappuie sur serveur classique en <em>backend</em>. La diff√©rence principale entre ces deux types de serveurs r√©side principalement dans leur fonction et leur utilisation:</p>
<ul>
<li>Un <strong>serveur web</strong> est sp√©cifiquement con√ßu pour stocker, traiter et livrer des pages web aux clients. Cela inclut des fichiers HTML, CSS, JavaScript, images, etc. Les serveurs web √©coutent les requ√™tes HTTP/HTTPS provenant des navigateurs des utilisateurs et y r√©pondent en envoyant les donn√©es demand√©es.</li>
<li>Un <strong>serveur <em>backend</em></strong> classique est con√ßu pour effectuer des op√©rations en r√©ponse √† un <em>front</em>, en l‚Äôoccurrence une page web. Dans le contexte d‚Äôune application <code>Streamlit</code>, il s‚Äôagit d‚Äôun serveur avec l‚Äôenvironnement <code>Python</code> <em>ad hoc</em> pour ex√©cuter le code n√©cessaire √† r√©pondre √† toute action d‚Äôun utilisateur de l‚Äôappliacation.</li>
</ul>
</div>
</div>
</div>
<section id="√©tape-1-d√©velopper-une-api-en-local" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-1-d√©velopper-une-api-en-local">√âtape 1: d√©velopper une API en local</h2>
<p>Le premier livrable devenu classique dans un projet impliquant du <em>machine learning</em> est la mise √† disposition d‚Äôun mod√®le par le biais d‚Äôune API (voir chapitre sur la <a href="../chapters/deployment.html">mise en production</a>). Le <em>framework</em> <a href="https://fastapi.tiangolo.com/"><code>FastAPI</code></a> va permettre de rapidement transformer notre application <code>Python</code> en une API fonctionnelle.</p>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-pre-appli16-contents" aria-controls="callout-appli15" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Reprendre √† partir d'ici      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-pre-appli16" class="callout-pre-appli16-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        <b>Si vous n'avez plus de <code>VSCode</code> actif avec la configuration propos√©e dans l'application pr√©liminaire</b>, vous pouvez repartir de ce service:<br><center>    <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false" target="_blank" rel="noopener" data-original-href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false">
      <img src="https://img.shields.io/badge/SSP%20Cloud-Lancer_avec_VSCode-blue?logo=visualstudiocode&amp;logoColor=blue" alt="Onyxia">
    </a>
    </center><br>Et ensuite, apr√®s avoir cl√¥n√© le d√©p√¥t<br><br>
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli15<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli15" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli15</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 16: Mise √† disposition sous forme d‚ÄôAPI locale
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Installer <code>fastAPI</code> et <code>uvicorn</code> puis les ajouter au <code>requirements.txt</code></li>
<li>Renommer le fichier <code>main.py</code> en <code>train.py</code>.</li>
<li>Dans ce script, ajouter une sauvegarde du mod√®le apr√®s l‚Äôavoir entra√Æn√©, sous le format <a href="https://scikit-learn.org/stable/model_persistence.html#python-specific-serialization"><code>joblib</code></a>.</li>
<li>Faire tourner</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb60" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python train.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>pour enregistrer en local votre mod√®le de production.</p>
<ul>
<li><p>Modifier les appels √† <code>main.py</code> dans votre <code>Dockerfile</code> et vos actions <code>Github</code> sous peine d‚Äôessuyer des √©checs lors de vos actions <code>Github</code> apr√®s le prochain <em>push</em>.</p></li>
<li><p>Ajouter <code>model.joblib</code> au <code>.gitignore</code> car <code>Git</code> n‚Äôest pas fait pour ce type de fichiers.</p></li>
</ul>
<p>Nous allons maintenant passer au d√©veloppement de l‚ÄôAPI. Comme d√©couvrir <code>FastAPI</code> n‚Äôest pas l‚Äôobjet de cet enseignement, nous donnons directement le mod√®le pour cr√©er l‚ÄôAPI. Si vous d√©sirez tester de vous-m√™mes, vous pouvez cr√©er votre fichier sans vous r√©f√©rer √† l‚Äôexemple.</p>
<ul>
<li>Cr√©er le fichier <code>app/api.py</code> permettant d‚Äôinitialiser l‚ÄôAPI:</li>
</ul>
<details>
<summary>
Fichier <code>app/api.py</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/api.py</strong></pre>
</div>
<div class="sourceCode" id="cb61" data-filename="app/api.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""A simple API to expose our trained RandomForest model for Tutanic survival."""</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastapi <span class="im">import</span> FastAPI</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> load</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> load(<span class="st">'model.joblib'</span>)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> FastAPI(</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Pr√©diction de survie sur le Titanic"</span>,</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Application de pr√©diction de survie sur le Titanic üö¢ &lt;br&gt;Une version par API pour faciliter la r√©utilisation du mod√®le üöÄ"</span> <span class="op">+\</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;br&gt;&lt;br&gt;&lt;img src=</span><span class="ch">\"</span><span class="st">https://media.vogue.fr/photos/5faac06d39c5194ff9752ec9/1:1/w_2404,h_2404,c_limit/076_CHL_126884.jpg</span><span class="ch">\"</span><span class="st"> width=</span><span class="ch">\"</span><span class="st">200</span><span class="ch">\"</span><span class="st">&gt;"</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">"/"</span>, tags<span class="op">=</span>[<span class="st">"Welcome"</span>])</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_welcome_page():</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Show welcome page with model name and version.</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Message"</span>: <span class="st">"API de pr√©diction de survie sur le Titanic"</span>,</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Model_name"</span>: <span class="st">'Titanic ML'</span>,</span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Model_version"</span>: <span class="st">"0.1"</span>,</span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">"/predict"</span>, tags<span class="op">=</span>[<span class="st">"Predict"</span>])</span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> predict(</span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>    sex: <span class="bu">str</span> <span class="op">=</span> <span class="st">"female"</span>,</span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>    age: <span class="bu">float</span> <span class="op">=</span> <span class="fl">29.0</span>,</span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>    fare: <span class="bu">float</span> <span class="op">=</span> <span class="fl">16.5</span>,</span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>    embarked: <span class="bu">str</span> <span class="op">=</span> <span class="st">"S"</span></span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Sex"</span>: [sex],</span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Age"</span>: [age],</span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Fare"</span>: [fare],</span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Embarked"</span>: [embarked],</span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> <span class="st">"Survived üéâ"</span> <span class="cf">if</span> <span class="bu">int</span>(model.predict(df)) <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">"Dead ‚ö∞Ô∏è"</span></span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prediction</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ul>
<li>Construire et d√©ployer en local l‚ÄôAPI avec la commande</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb62" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> uvicorn api:app <span class="at">--reload</span> <span class="at">--host</span> <span class="st">"0.0.0.0"</span> <span class="at">--port</span> 5000</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>En retournant sur la page <a href="https://datalab.sspcloud.fr/my-services">Mes Services</a> du <code>SSPCloud</code>, ouvrir le <code>README</code> de votre service<a href="#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup>19</sup></a>. Se rendre sur l‚ÄôURL de d√©ploiement, ajouter <code>/docs/</code> √† celui-ci et observer la documentation de l‚ÄôAPI</li>
<li>Se servir de la documentation pour tester les requ√™tes <code>/predict</code></li>
<li>R√©cup√©rer l‚ÄôURL d‚Äôune des requ√™tes propos√©es. La tester dans le navigateur et depuis <code>Python</code> avec <code>requests</code> :</li>
</ul>
<div class="sourceCode" id="cb63" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> request</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>requests.get(url).json()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Une fois que vous avez test√©, vous pouvez tuer l‚Äôapplication en faisant <kbd>CTRL</kbd>+<kbd>C</kbd>. Retester votre bout de code <code>Python</code> et comprendre l‚Äôorigine du probl√®me.</li>
</ul>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli16-contents" aria-controls="callout-appli16" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli16      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli16" class="callout-appli16-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli16<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli16" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli16</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</section>
<section id="√©tape-2-d√©ployer-lapi-de-mani√®re-manuelle" class="level2">
<h2 class="anchored" data-anchor-id="√©tape-2-d√©ployer-lapi-de-mani√®re-manuelle">√âtape 2: d√©ployer l‚ÄôAPI de mani√®re manuelle</h2>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-pre-appli17-contents" aria-controls="callout-appli16" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Reprendre √† partir d'ici      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-pre-appli17" class="callout-pre-appli17-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        <b>Si vous n'avez plus de <code>VSCode</code> actif avec la configuration propos√©e dans l'application pr√©liminaire</b>, vous pouvez repartir de ce service:<br><center>    <a href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false" target="_blank" rel="noopener" data-original-href="https://datalab.sspcloud.fr/launcher/ide/vscode-python?name=ENSAE%20Mise%20en%20production&amp;version=2.1.24&amp;s3=region-ec97c721&amp;init.personalInit=¬´https%3A%2F%2Fraw.githubusercontent.com%2Fensae-reproductibilite%2Fwebsite%2Frefs%2Fheads%2Fmain%2Fchapters%2Fapplications%2Finit.sh¬ª&amp;kubernetes.role=¬´admin¬ª&amp;networking.user.enabled=true&amp;autoLaunch=false">
      <img src="https://img.shields.io/badge/SSP%20Cloud-Lancer_avec_VSCode-blue?logo=visualstudiocode&amp;logoColor=blue" alt="Onyxia">
    </a>
    </center><br>Et ensuite, apr√®s avoir cl√¥n√© le d√©p√¥t<br><br>
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli16<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli16" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli16</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<p>A ce stade, nous avons d√©ploy√© l‚ÄôAPI seulement localement, dans le cadre d‚Äôun terminal qui tourne en arri√®re-plan. C‚Äôest une mise en production manuelle, pas franchement p√©renne. Ce mode de d√©ploiement est tr√®s pratique pour la phase de d√©veloppement, afin de s‚Äôassurer que l‚ÄôAPI fonctionne comme attendue. Pour p√©renniser la mise en production, on va √©liminer l‚Äôaspect artisanal de celle-ci.</p>
<p>Il est temps de passer √† l‚Äô√©tape de d√©ploiement, qui permettra √† notre API d‚Äô√™tre accessible, √† tout moment, via une URL sur le web et d‚Äôavoir un serveur, en arri√®re plan, qui effectuera les op√©rations pour r√©pondre √† une requ√™te. Pour se faire, on va utiliser les possibilit√©s offertes par <code>Kubernetes</code>, technologie sur laquelle est bas√©e l‚Äôinfrastructure <a href="https://datalab.sspcloud.fr"><code>SSP Cloud</code></a>.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-41-contents" aria-controls="callout-41" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Et si vous n‚Äôutilisez pas le <code>SSPCloud</code> ? (une id√©e saugrenue mais sait-on jamais)
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-41" class="callout-41-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Les exemples √† venir peuvent tr√®s bien √™tre r√©pliqu√©s sur n‚Äôimporte quel <em>cloud provider</em> qui propose une solution d‚Äôordonnancement type <code>Kubernetes</code>. Il existe √©galement des fournisseurs de services d√©di√©s, g√©n√©ralement associ√©s √† une impl√©mentation, par exemple pour <a href="https://streamlit.io/gallery"><code>Streamlit</code></a>. Ces services sont pratiques si on n‚Äôa pas le choix mais il faut garder √† l‚Äôesprit qu‚Äôils peuvent constituer un mur de la production car vous ne contr√¥lez pas l‚Äôenvironnement en question, qui peut se distinguer de votre environnement de d√©veloppement.</p>
<p>Et si jamais vous voulez avoir un <code>SSPCloud</code> dans votre entreprise c‚Äôest possible: le logiciel <a href="https://github.com/InseeFrLab/onyxia"><code>Onyxia</code></a> sur lequel repose cette infrastructure est <em>open source</em> et est, d√©j√†, r√©impl√©ment√© par de nombreux acteurs. Pour b√©n√©ficier d‚Äôun accompagnement dans la cr√©ation d‚Äôune telle infrastructure, rdv sur le <code>Slack</code> du projet <code>Onyxia</code>:</p>
<p><a href="https://join.slack.com/t/3innovation/shared_invite/zt-31au6d4uu-Ib~AX40ua2BZjgFq~DZeNg"><img src="https://img.shields.io/badge/Slack-4A154B?logo=slack&amp;logoColor=fff.png" class="img-fluid"></a></p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 17: Dockeriser l‚ÄôAPI (int√©gration continue)
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Cr√©er un script <code>app/run.sh</code> √† la racine du projet qui lance le script <code>train.py</code> puis d√©ploie localement l‚ÄôAPI</li>
</ul>
<details>
<summary>
Fichier <code>run.sh</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>api/run.sh</strong></pre>
</div>
<div class="sourceCode" id="cb64" data-filename="terminal" data-no-prefix="true" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co">#/bin/bash</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> train.py</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="ex">uvicorn</span> app.api:app <span class="at">--reload</span> <span class="at">--host</span> <span class="st">"0.0.0.0"</span> <span class="at">--port</span> 5000</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ul>
<li><p>Donner au script <code>api/run.sh</code> des permissions d‚Äôex√©cution : <code>chmod +x api/run.sh</code></p></li>
<li><p>Ajouter <code>COPY app ./app</code> pour avoir les fichiers n√©cessaires au lancement dans l‚ÄôAPI dans l‚Äôimage</p></li>
<li><p>Modifier <code>COPY train.py .</code> pour tenir compte du nouveau nom du fichier</p></li>
<li><p>Changer l‚Äôinstruction <code>CMD</code> du <code>Dockerfile</code> pour ex√©cuter le script <code>api/run.sh</code> au lancement du conteneur (<code>CMD ["bash", "-c", "./app/run.sh"]</code>)</p></li>
<li><p>Mettre √† jour votre <code>requirements.txt</code> pour tenir compte des nouveaux <em>packages</em> utilis√©s</p></li>
<li><p><em>Commit</em> et <em>push</em> les changements</p></li>
<li><p>Une fois le CI termin√©, r√©cup√©rer la nouvelle image dans votre environnement de test de <code>Docker</code> et v√©rifier que l‚ÄôAPI se d√©ploie correctement</p></li>
</ul>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli17-contents" aria-controls="callout-appli17" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli17      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli17" class="callout-appli17-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli17<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli17" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli17</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<p>Nous avons pr√©par√© la mise √† disposition de notre API mais √† l‚Äôheure actuelle elle n‚Äôest pas accessible de mani√®re ais√©e car il est n√©cessaire de lancer manuellement une image <code>Docker</code> pour pouvoir y acc√©der. Ce type de travail est la sp√©cialit√© de <code>Kubernetes</code> que nous allons utiliser pour g√©rer la mise √† disposition de notre API.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 18b: Mettre √† disposition l‚ÄôAPI (d√©ploiement manuel)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Cette partie n√©cessite d‚Äôavoir √† disposition une infrastructure <em>cloud</em>.</p>
<ul>
<li><p>Cr√©er un dossier <code>deployment</code> √† la racine du projet qui va contenir les fichiers de configuration n√©cessaires pour d√©ployer sur un cluster <code>Kubernetes</code></p></li>
<li><p>En vous inspirant de la <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#creating-a-deployment">documentation</a>, y ajouter un premier fichier <code>deployment.yaml</code> qui va sp√©cifier la configuration du <em>Pod</em> √† lancer sur le cluster</p></li>
</ul>
<details>
<summary>
Fichier <code>deployment/deployment.yaml</code>
</summary>
<div class="sourceCode" id="annotated-cell-112" data-code-line-numbers=""><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-112-1"><a href="#annotated-cell-112-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| filename: "deployment/deployment.yaml"</span></span>
<span id="annotated-cell-112-2"><a href="#annotated-cell-112-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| source-line-numbers: "19"</span></span>
<span id="annotated-cell-112-3"><a href="#annotated-cell-112-3" aria-hidden="true" tabindex="-1"></a>apiVersion: apps<span class="op">/</span>v1</span>
<span id="annotated-cell-112-4"><a href="#annotated-cell-112-4" aria-hidden="true" tabindex="-1"></a>kind: Deployment</span>
<span id="annotated-cell-112-5"><a href="#annotated-cell-112-5" aria-hidden="true" tabindex="-1"></a>metadata:</span>
<span id="annotated-cell-112-6"><a href="#annotated-cell-112-6" aria-hidden="true" tabindex="-1"></a>  name: titanic<span class="op">-</span>deployment</span>
<span id="annotated-cell-112-7"><a href="#annotated-cell-112-7" aria-hidden="true" tabindex="-1"></a>  labels:</span>
<span id="annotated-cell-112-8"><a href="#annotated-cell-112-8" aria-hidden="true" tabindex="-1"></a>    app: titanic</span>
<span id="annotated-cell-112-9"><a href="#annotated-cell-112-9" aria-hidden="true" tabindex="-1"></a>spec:</span>
<span id="annotated-cell-112-10"><a href="#annotated-cell-112-10" aria-hidden="true" tabindex="-1"></a>  replicas: <span class="dv">1</span></span>
<span id="annotated-cell-112-11"><a href="#annotated-cell-112-11" aria-hidden="true" tabindex="-1"></a>  selector:</span>
<span id="annotated-cell-112-12"><a href="#annotated-cell-112-12" aria-hidden="true" tabindex="-1"></a>    matchLabels:</span>
<span id="annotated-cell-112-13"><a href="#annotated-cell-112-13" aria-hidden="true" tabindex="-1"></a>      app: titanic</span>
<span id="annotated-cell-112-14"><a href="#annotated-cell-112-14" aria-hidden="true" tabindex="-1"></a>  template:</span>
<span id="annotated-cell-112-15"><a href="#annotated-cell-112-15" aria-hidden="true" tabindex="-1"></a>    metadata:</span>
<span id="annotated-cell-112-16"><a href="#annotated-cell-112-16" aria-hidden="true" tabindex="-1"></a>      labels:</span>
<span id="annotated-cell-112-17"><a href="#annotated-cell-112-17" aria-hidden="true" tabindex="-1"></a>        app: titanic</span>
<span id="annotated-cell-112-18"><a href="#annotated-cell-112-18" aria-hidden="true" tabindex="-1"></a>    spec:</span>
<span id="annotated-cell-112-19"><a href="#annotated-cell-112-19" aria-hidden="true" tabindex="-1"></a>      containers:</span>
<span id="annotated-cell-112-20"><a href="#annotated-cell-112-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> name: titanic</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-112" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-112-21" class="code-annotation-target"><a href="#annotated-cell-112-21" aria-hidden="true" tabindex="-1"></a>        image:</span>
<span id="annotated-cell-112-22"><a href="#annotated-cell-112-22" aria-hidden="true" tabindex="-1"></a>        ports:</span>
<span id="annotated-cell-112-23"><a href="#annotated-cell-112-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> containerPort: <span class="dv">5000</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-112" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-112" data-code-lines="21" data-code-annotation="1">Mettre ici l‚Äôimage <code>Docker</code> utilis√©e, sous la forme <code>username/image:latest</code></span>
</dd>
</dl>
</details>
<ul>
<li>En vous inspirant de la <a href="https://kubernetes.io/fr/docs/concepts/services-networking/service/#d%C3%A9finition-d-un-service">documentation</a>, y ajouter un second fichier <code>service.yaml</code> qui va cr√©er une ressource <code>Service</code> permettant de donner une identit√© fixe au <code>Pod</code> pr√©c√©demment cr√©√© au sein du cluster</li>
</ul>
<details>
<summary>
Fichier <code>deployment/service.yaml</code>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deployment/service.yaml</strong></pre>
</div>
<div class="sourceCode" id="cb65" data-filename="deployment/service.yaml" data-code-line-numbers=""><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> titanic-service</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> titanic</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">protocol</span><span class="kw">:</span><span class="at"> TCP</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">5000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ul>
<li>En vous inspirant de la <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#the-ingress-resource">documentation</a>, y ajouter un troisi√®me fichier <code>ingress.yaml</code> qui va cr√©er une ressource <code>Ingress</code> permettant d‚Äôexposer le service via une URL en dehors du cluster</li>
</ul>
<details>
<summary>
Fichier <code>deployment/ingress.yaml</code>
</summary>
<div class="sourceCode" id="annotated-cell-114" data-code-line-numbers=""><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-114-1"><a href="#annotated-cell-114-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| filename: "deployment/ingress.yaml"</span></span>
<span id="annotated-cell-114-2"><a href="#annotated-cell-114-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| source-line-numbers: "16-19"</span></span>
<span id="annotated-cell-114-3"><a href="#annotated-cell-114-3" aria-hidden="true" tabindex="-1"></a>apiVersion: networking.k8s.io<span class="op">/</span>v1</span>
<span id="annotated-cell-114-4"><a href="#annotated-cell-114-4" aria-hidden="true" tabindex="-1"></a>kind: Ingress</span>
<span id="annotated-cell-114-5"><a href="#annotated-cell-114-5" aria-hidden="true" tabindex="-1"></a>metadata:</span>
<span id="annotated-cell-114-6"><a href="#annotated-cell-114-6" aria-hidden="true" tabindex="-1"></a>  name: titanic<span class="op">-</span>ingress</span>
<span id="annotated-cell-114-7"><a href="#annotated-cell-114-7" aria-hidden="true" tabindex="-1"></a>  annotations:</span>
<span id="annotated-cell-114-8"><a href="#annotated-cell-114-8" aria-hidden="true" tabindex="-1"></a>    nginx.ingress.kubernetes.io<span class="op">/</span>rewrite<span class="op">-</span>target: <span class="op">/</span></span>
<span id="annotated-cell-114-9"><a href="#annotated-cell-114-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enable CORS by adding these annotations</span></span>
<span id="annotated-cell-114-10"><a href="#annotated-cell-114-10" aria-hidden="true" tabindex="-1"></a>    nginx.ingress.kubernetes.io<span class="op">/</span>enable<span class="op">-</span>cors: <span class="st">"true"</span></span>
<span id="annotated-cell-114-11"><a href="#annotated-cell-114-11" aria-hidden="true" tabindex="-1"></a>    nginx.ingress.kubernetes.io<span class="op">/</span>cors<span class="op">-</span>allow<span class="op">-</span>methods: <span class="st">"PUT, GET, POST, DELETE, PATCH, OPTIONS"</span></span>
<span id="annotated-cell-114-12"><a href="#annotated-cell-114-12" aria-hidden="true" tabindex="-1"></a>    nginx.ingress.kubernetes.io<span class="op">/</span>cors<span class="op">-</span>allow<span class="op">-</span>credentials: <span class="st">"true"</span></span>
<span id="annotated-cell-114-13"><a href="#annotated-cell-114-13" aria-hidden="true" tabindex="-1"></a>    nginx.ingress.kubernetes.io<span class="op">/</span>cors<span class="op">-</span>allow<span class="op">-</span>headers: <span class="st">"DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"</span></span>
<span id="annotated-cell-114-14"><a href="#annotated-cell-114-14" aria-hidden="true" tabindex="-1"></a>    nginx.ingress.kubernetes.io<span class="op">/</span>cors<span class="op">-</span>allow<span class="op">-</span>origin: <span class="st">"*"</span></span>
<span id="annotated-cell-114-15"><a href="#annotated-cell-114-15" aria-hidden="true" tabindex="-1"></a>spec:</span>
<span id="annotated-cell-114-16"><a href="#annotated-cell-114-16" aria-hidden="true" tabindex="-1"></a>  ingressClassName: nginx</span>
<span id="annotated-cell-114-17"><a href="#annotated-cell-114-17" aria-hidden="true" tabindex="-1"></a>  tls:</span>
<span id="annotated-cell-114-18"><a href="#annotated-cell-114-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span> hosts:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-114" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-114-19" class="code-annotation-target"><a href="#annotated-cell-114-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span></span>
<span id="annotated-cell-114-20"><a href="#annotated-cell-114-20" aria-hidden="true" tabindex="-1"></a>  rules:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-114" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-114-21" class="code-annotation-target"><a href="#annotated-cell-114-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span> host:</span>
<span id="annotated-cell-114-22"><a href="#annotated-cell-114-22" aria-hidden="true" tabindex="-1"></a>    http:</span>
<span id="annotated-cell-114-23"><a href="#annotated-cell-114-23" aria-hidden="true" tabindex="-1"></a>      paths:</span>
<span id="annotated-cell-114-24"><a href="#annotated-cell-114-24" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> path: <span class="op">/</span></span>
<span id="annotated-cell-114-25"><a href="#annotated-cell-114-25" aria-hidden="true" tabindex="-1"></a>        pathType: Prefix</span>
<span id="annotated-cell-114-26"><a href="#annotated-cell-114-26" aria-hidden="true" tabindex="-1"></a>        backend:</span>
<span id="annotated-cell-114-27"><a href="#annotated-cell-114-27" aria-hidden="true" tabindex="-1"></a>          service:</span>
<span id="annotated-cell-114-28"><a href="#annotated-cell-114-28" aria-hidden="true" tabindex="-1"></a>            name: titanic<span class="op">-</span>service</span>
<span id="annotated-cell-114-29"><a href="#annotated-cell-114-29" aria-hidden="true" tabindex="-1"></a>            port:</span>
<span id="annotated-cell-114-30"><a href="#annotated-cell-114-30" aria-hidden="true" tabindex="-1"></a>              number: <span class="dv">80</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-114" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-114" data-code-lines="19" data-code-annotation="1">Mettez l‚ÄôURL auquel vous voulez exposer votre service. Sur le mod√®le de <code>titanic.kub.sspcloud.fr</code> (mais ne tentez pas celui-l√†, il est d√©j√† pris üòÉ)</span>
</dd>
<dt data-target-cell="annotated-cell-114" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-114" data-code-lines="21" data-code-annotation="2">Mettre ce m√™me URL ici aussi</span>
</dd>
</dl>
</details>
<ul>
<li><p>Appliquer ces fichiers de configuration sur le cluster : <code>kubectl apply -f deployment/</code></p></li>
<li><p>Si tout a correctement fonctionn√©, vous devriez pouvoir acc√©der depuis votre navigateur √† l‚ÄôAPI √† l‚ÄôURL sp√©cifi√©e dans le fichier <code>deployment/ingress.yaml</code>. Par exemple <code>https://toto.kub.sspcloud.fr/</code> si vous avez mis celui-ci plus t√¥t (et <code>https://toto.kub.sspcloud.fr/docs</code> pour la documentation).</p></li>
</ul>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli18-contents" aria-controls="callout-appli18" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli18      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli18" class="callout-appli18-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli18<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli18" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli18</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<div class="callout callout-style-default callout-note callout-titled" title="G√©rer le CORS">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-44-contents" aria-controls="callout-44" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
G√©rer le CORS
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-44" class="callout-44-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Notre API est accessible sans probl√®me depuis <code>Python</code> ou notre navigateur.</p>
<p>En revanche, si on d√©sire utiliser <code>JavaScript</code> pour cr√©er une application interactive il est indispensable de mettre les lignes un peu obscure sur le CORS dans le fichier <code>ingress.yaml</code>.</p>
<p>Comme c‚Äôest un point technique qui ne concerne pas les comp√©tences li√©es √† ce cours, nous avons donn√© directement les lignes correspondantes dans ce fichier.</p>
</div>
</div>
</div>
<p>On peut remarquer quelques voies d‚Äôam√©lioration de notre approche qui seront ult√©rieurement trait√©es:</p>
<ul>
<li>L‚Äôentra√Ænement du mod√®le est r√©-effectu√© √† chaque lancement d‚Äôun nouveau conteneur. On relance donc autant de fois un entra√Ænement qu‚Äôon d√©ploie de conteneurs pour r√©pondre √† nos utilisateurs. Ce sera l‚Äôobjet de la partie MLOps de fiabiliser et optimiser cette partie du <em>pipeline</em>.</li>
<li>il est n√©cessaire de (re)lancer manuellement <code>kubectl apply -f deployment/</code> √† chaque changement de notre code. Autrement dit, lors de cette application, on a am√©lior√© la fiabilit√© du lancement de notre API mais un lancement manuel est encore indispensable. Comme dans le reste de ce cours, on va essayer d‚Äô√©viter un geste manuel pouvant √™tre source d‚Äôerreur en privil√©giant l‚Äôautomatisation et l‚Äôarchivage dans des scripts. C‚Äôest l‚Äôobjet de la prochaine √©tape.</li>
</ul>
</section>
<section id="etape-3-automatiser-le-d√©ploiement-d√©ploiement-en-continu" class="level2">
<h2 class="anchored" data-anchor-id="etape-3-automatiser-le-d√©ploiement-d√©ploiement-en-continu">Etape 3: automatiser le d√©ploiement (d√©ploiement en continu)</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Clarification sur la branche de travail et les <em>tags</em>
</div>
</div>
<div class="callout-body-container callout-body">
<p>A partir de maintenant, il est n√©cessaire de clarifier la branche principale sur laquelle nous travaillons. De mani√®re traditionnelle, on utilise la branche <code>main</code>. Si vous avez chang√© de branche, vous pouvez continuer 1/ continuer mais en tenir compte dans les exemples ult√©rieurs ou 2/ fusionner celle-ci √† <code>main</code>.</p>
<p>Si vous avez utilis√© un <code>tag</code> pour sauter une ou plusieurs √©tapes, il va √™tre n√©cessaire de se placer sur une branche car vous √™tes en <em>head detached</em>. Si vous avez utilis√© les scripts automatis√©s de checkpoint, cette gymnastique a √©t√© faite pour vous.</p>
</div>
</div>
<p>Qu‚Äôest-ce qui peut d√©clencher une √©volution n√©cessitant de mettre √† jour l‚Äôensemble de notre processus de production ?</p>
<p>Regardons √† nouveau notre <em>pipeline</em>:</p>
<p><img src="../drawio/end_point.png" class="img-fluid"></p>
<p>Les <em>inputs</em> de notre <em>pipeline</em> sont donc:</p>
<ul>
<li>La <strong>configuration</strong>. Ici, on peut consid√©rer que notre <code>.env</code> de configuration, les secrets renseign√©s √† <code>Github</code> ou encore le <code>requirements.txt</code> rel√®vent de cette cat√©gorie ;</li>
<li>Les <strong>donn√©es</strong>. Nos donn√©es sont statiques et n‚Äôont pas vocation √† √©voluer. Si c‚Äô√©tait le cas, il faudrait en tenir compte dans notre automatisation <span class="citation" data-cites="note-versionning-data">[@note-versionning-data]</span>. ;</li>
<li>Le <strong>code</strong>. C‚Äôest l‚Äô√©l√©ment principal qui √©volue chez nous. Id√©alement, on veut automatiser le processus au maximum en faisant en sorte qu‚Äô√† chaque mise √† jour de notre code (un <em>push</em> sur <code>Github</code>), les √©tapes ult√©rieures (production de l‚Äôimage <code>Docker</code>, etc.) se lancent. N√©anmoins, on veut aussi √©viter qu‚Äôune erreur puisse donner lieu √† une mise en production non-fonctionnelle, on va donc maintenir une action manuelle minimale comme garde-fou.</li>
</ul>
<div id="note-versionning-data" class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Et le <em>versionning</em> des donn√©es ?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ici, nous nous pla√ßons dans le cas simple o√π les donn√©es brutes re√ßues sont fig√©es. Ce qui peut changer est la mani√®re dont on constitue nos √©chantillons train/test. Il sera donc utile de logguer les donn√©es en question par le biais de <code>MLFlow</code>. Mais il n‚Äôest pas n√©cessaire de versionner les donn√©es brutes.</p>
<p>Si celles-ci √©voluaient, il pourrait √™tre utile de versionner les donn√©es, √† la mani√®re dont on le fait pour le code. <code>Git</code> n‚Äôest pas l‚Äôoutil appropri√© pour cela. Parmi les outils populaires de versionning de donn√©es, bien int√©gr√©s avec <code>S3</code>, il y a, sur le <code>SSPCloud</code>, <a href="https://lakefs.io/"><code>lakefs</code></a>.</p>
</div>
</div>
<p>Pour automatiser au maximum la mise en production, on va utiliser un nouvel outil : <code>ArgoCD</code>. Ainsi, au lieu de devoir appliquer manuellement la commande <code>kubectl apply</code> √† chaque modification des fichiers de d√©ploiement (pr√©sents dans le dossier <code>kubernetes/</code>), c‚Äôest l‚Äô<strong>op√©rateur</strong> <code>ArgoCD</code>, d√©ploy√© sur le <em>cluster</em>, qui va d√©tecter les changements de configuration du d√©ploiement et les appliquer automatiquement.</p>
<p>C‚Äôest l‚Äôapproche dite <strong>GitOps</strong> : le d√©p√¥t <code>Git</code> du d√©ploiement fait office de <strong>source de v√©rit√© unique</strong> de l‚Äô√©tat voulu de l‚Äôapplication, tout changement sur ce dernier doit donc se r√©percuter imm√©diatement sur le d√©ploiement effectif.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 19a: Automatiser la mise √† disposition de l‚ÄôAPI (d√©ploiement continu)
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Lancer un service <code>ArgoCD</code> sur le <code>SSPCloud</code> depuis la page <code>Mes services</code> (catalogue <code>Automation</code>). Laisser les configurations par d√©faut.</p></li>
<li><p>Sur <code>GitHub</code>, cr√©er un d√©p√¥t <code>application-deployment</code> qui va servir de <strong>d√©p√¥t GitOps</strong>, c‚Äôest √† dire un d√©p√¥t qui sp√©cifie le param√©trage du d√©ploiement de votre application.</p></li>
<li><p>Ajouter un dossier <code>deployment</code> √† votre d√©p√¥t <code>GitOps</code>, dans lequel on mettra les trois fichiers de d√©ploiement qui permettent de d√©ployer notre application sur <code>Kubernetes</code> (<code>deployment.yaml</code>, <code>service.yaml</code>, <code>ingress.yaml</code>).</p></li>
<li><p>A la racine de votre d√©p√¥t <code>GitOps</code>, cr√©ez un fichier <code>application.yml</code> avec le contenu suivant, en prenant bien soin de modifier les lignes surlign√©es avec les informations pertinentes :</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>application.yaml</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-116" data-filename="application.yaml" data-file="application.yaml" data-source-line-numbers="8-9,13" data-code-line-numbers="8-9,13"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-116-1"><a href="#annotated-cell-116-1" aria-hidden="true" tabindex="-1"></a>apiVersion: argoproj.io<span class="op">/</span>v1alpha1</span>
<span id="annotated-cell-116-2"><a href="#annotated-cell-116-2" aria-hidden="true" tabindex="-1"></a>kind: Application</span>
<span id="annotated-cell-116-3"><a href="#annotated-cell-116-3" aria-hidden="true" tabindex="-1"></a>metadata:</span>
<span id="annotated-cell-116-4"><a href="#annotated-cell-116-4" aria-hidden="true" tabindex="-1"></a>  name: ensae<span class="op">-</span>mlops</span>
<span id="annotated-cell-116-5"><a href="#annotated-cell-116-5" aria-hidden="true" tabindex="-1"></a>spec:</span>
<span id="annotated-cell-116-6"><a href="#annotated-cell-116-6" aria-hidden="true" tabindex="-1"></a>  project: default</span>
<span id="annotated-cell-116-7"><a href="#annotated-cell-116-7" aria-hidden="true" tabindex="-1"></a>  source:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-116" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-116-8" class="code-annotation-target"><a href="#annotated-cell-116-8" aria-hidden="true" tabindex="-1"></a>    repoURL: https:<span class="op">//</span>github.com<span class="op">/&lt;</span>your_github_username<span class="op">&gt;/</span>application<span class="op">-</span>deployment.git</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-116" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-116-9" class="code-annotation-target"><a href="#annotated-cell-116-9" aria-hidden="true" tabindex="-1"></a>    targetRevision: main</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-116" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-116-10" class="code-annotation-target"><a href="#annotated-cell-116-10" aria-hidden="true" tabindex="-1"></a>    path: deployment</span>
<span id="annotated-cell-116-11"><a href="#annotated-cell-116-11" aria-hidden="true" tabindex="-1"></a>  destination:</span>
<span id="annotated-cell-116-12"><a href="#annotated-cell-116-12" aria-hidden="true" tabindex="-1"></a>    server: https:<span class="op">//</span>kubernetes.default.svc</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-116" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-116-13" class="code-annotation-target"><a href="#annotated-cell-116-13" aria-hidden="true" tabindex="-1"></a>    namespace: user<span class="op">-&lt;</span>your_sspcloud_username<span class="op">&gt;</span></span>
<span id="annotated-cell-116-14"><a href="#annotated-cell-116-14" aria-hidden="true" tabindex="-1"></a>  syncPolicy:</span>
<span id="annotated-cell-116-15"><a href="#annotated-cell-116-15" aria-hidden="true" tabindex="-1"></a>    automated:</span>
<span id="annotated-cell-116-16"><a href="#annotated-cell-116-16" aria-hidden="true" tabindex="-1"></a>      selfHeal: true</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-116" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-116" data-code-lines="8" data-code-annotation="1">L‚ÄôURL de votre d√©p√¥t <code>Github</code> <i class="fa-brands fa-github" aria-label="github"></i> faisant office de d√©p√¥t <code>GitOps</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-116" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-116" data-code-lines="9" data-code-annotation="2">La branche √† partir de laquelle vous d√©ployez.</span>
</dd>
<dt data-target-cell="annotated-cell-116" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-116" data-code-lines="10" data-code-annotation="3">Le nom du dossier contenant vos fichiers de d√©ploiement <code>Kubernetes</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-116" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-116" data-code-lines="13" data-code-annotation="4">Votre <em>namespace</em> <code>Kubernetes</code>. Sur le SSPCloud, cela prend la forme <code>user-${username}</code>.</span>
</dd>
</dl></li>
<li><p>Pousser sur <code>Github</code> le d√©p√¥t <code>GitOps</code>.</p></li>
<li><p>Dans <code>ArgoCD</code>, cliquez sur <code>New App</code> puis <code>Edit as a YAML</code>. Copiez-collez le contenu de <code>application.yml</code> et cliquez sur <code>Create</code>.</p></li>
<li><p>Observez dans l‚Äôinterface d‚Äô<code>ArgoCD</code> le d√©ploiement progressif des ressources n√©cessaires √† votre application sur le cluster. Joli non ?</p></li>
<li><p>V√©rifiez que votre API est bien d√©ploy√©e en utilisant l‚ÄôURL d√©finie dans le fichier <code>ingress.yml</code>.</p></li>
<li><p>Supprimer du code applicatif le dossier <code>deployment</code> puisque c‚Äôest maintenant votre d√©p√¥t de d√©ploiement qui le contr√¥le.</p></li>
<li><p>Indiquer dans le <code>README.md</code> que le d√©ploiement de votre application (dont vous pouvez mettre l‚ÄôURL dans le README) est contr√¥l√© par un autre d√©p√¥t.</p></li>
</ul>
</div>
</div>
<p>Si cela a fonctionn√©, vous devriez maintenant voir votre application dans votre tableau de bord <code>ArgoCD</code>:</p>
<p><img src="../chapters/applications/figures/argo_appli19a.png" class="img-fluid"></p>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli19a-contents" aria-controls="callout-appli19a" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli19a      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli19a" class="callout-appli19a-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli19a<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli19a" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli19a</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<p>A pr√©sent, nous avons tous les outils √† notre disposition pour construire un vrai <strong>pipeline de CI/CD, automatis√© de bout en bout</strong>. Il va nous suffire pour cela de mettre √† bout les composants :</p>
<ul>
<li><p>dans la partie 4 de l‚Äôapplication, nous avons construit un <strong>pipeline de CI</strong> : on a donc seulement √† faire un commit sur le d√©p√¥t de l‚Äôapplication pour lancer l‚Äô√©tape de <strong>build</strong> et de mise √† disposition de la nouvelle image sur le <code>DockerHub</code> ;</p></li>
<li><p>dans l‚Äôapplication pr√©c√©dente, nous avons construit un <strong>pipeline de CD</strong> : <code>ArgoCD</code> suit en permanence l‚Äô√©tat du d√©p√¥t <code>GitOps</code>, tout commit sur ce dernier lancera donc automatiquement un red√©ploiement de l‚Äôapplication.</p></li>
</ul>
<p>Il y a donc un √©l√©ment qui fait la liaison entre ces deux pipelines et qui nous sert de garde-fou en cas d‚Äôerreur : la <strong>version de l‚Äôapplication</strong>.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 19b : Mettre √† jour la version en production
</div>
</div>
<div class="callout-body-container callout-body">
<p>Jusqu‚Äô√† maintenant, on a utilis√© le tag <em>latest</em> pour d√©finir la version de notre application. En pratique, lorsqu‚Äôon passe de la phase de d√©veloppement √† celle de production, on a plut√¥t envie de versionner proprement les versions de l‚Äôapplication afin de savoir ce qui est d√©ploy√©. On va pour cela utiliser les <strong><em>tags</em></strong> avec <code>Git</code>, qui vont se propager au nommage de l‚Äôimage <code>Docker</code>.</p>
<ul>
<li>Modifier le fichier de CI <code>prod.yml</code> pour assurer la propagation des tags.</li>
</ul>
<details>
<summary>
<p>Fichier <code>.github/workflows/prod.yml</code></p>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.github/workflows/prod.yml</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-117" data-filename=".github/workflows/prod.yml" data-code-line-numbers=""><pre class="sourceCode yaml code-annotation-code code-with-copy code-annotated"><code class="sourceCode yaml"><span id="annotated-cell-117-1"><a href="#annotated-cell-117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Construction image Docker</span></span>
<span id="annotated-cell-117-2"><a href="#annotated-cell-117-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-117-3"><a href="#annotated-cell-117-3" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="annotated-cell-117-4"><a href="#annotated-cell-117-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="annotated-cell-117-5"><a href="#annotated-cell-117-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span></span>
<span id="annotated-cell-117-6"><a href="#annotated-cell-117-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> main</span></span>
<span id="annotated-cell-117-7"><a href="#annotated-cell-117-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> dev</span></span>
<span id="annotated-cell-117-8"><a href="#annotated-cell-117-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">tags</span><span class="kw">:</span></span>
<span id="annotated-cell-117-9"><a href="#annotated-cell-117-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">'v*.*.*'</span></span>
<span id="annotated-cell-117-10"><a href="#annotated-cell-117-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-117-11"><a href="#annotated-cell-117-11" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="annotated-cell-117-12"><a href="#annotated-cell-117-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">docker</span><span class="kw">:</span></span>
<span id="annotated-cell-117-13"><a href="#annotated-cell-117-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="annotated-cell-117-14"><a href="#annotated-cell-117-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="annotated-cell-117-15"><a href="#annotated-cell-117-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span></span>
<span id="annotated-cell-117-16"><a href="#annotated-cell-117-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up QEMU</span></span>
<span id="annotated-cell-117-17"><a href="#annotated-cell-117-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/setup-qemu-action@v3</span></span>
<span id="annotated-cell-117-18"><a href="#annotated-cell-117-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span></span>
<span id="annotated-cell-117-19"><a href="#annotated-cell-117-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Docker Buildx</span></span>
<span id="annotated-cell-117-20"><a href="#annotated-cell-117-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/setup-buildx-action@v3</span></span>
<span id="annotated-cell-117-21"><a href="#annotated-cell-117-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-117-22"><a href="#annotated-cell-117-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span></span>
<span id="annotated-cell-117-23"><a href="#annotated-cell-117-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Docker meta</span></span>
<span id="annotated-cell-117-24"><a href="#annotated-cell-117-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> meta</span></span>
<span id="annotated-cell-117-25"><a href="#annotated-cell-117-25" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/metadata-action@v5</span></span>
<span id="annotated-cell-117-26"><a href="#annotated-cell-117-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-117" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-117-27" class="code-annotation-target"><a href="#annotated-cell-117-27" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">images</span><span class="kw">:</span><span class="at"> linogaliana/application</span></span>
<span id="annotated-cell-117-28"><a href="#annotated-cell-117-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-117-29"><a href="#annotated-cell-117-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span></span>
<span id="annotated-cell-117-30"><a href="#annotated-cell-117-30" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Login to Docker Hub</span></span>
<span id="annotated-cell-117-31"><a href="#annotated-cell-117-31" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/login-action@v3</span></span>
<span id="annotated-cell-117-32"><a href="#annotated-cell-117-32" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="annotated-cell-117-33"><a href="#annotated-cell-117-33" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">username</span><span class="kw">:</span><span class="at"> ${{ secrets.DOCKERHUB_USERNAME }}</span></span>
<span id="annotated-cell-117-34"><a href="#annotated-cell-117-34" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">password</span><span class="kw">:</span><span class="at"> ${{ secrets.DOCKERHUB_TOKEN }}</span></span>
<span id="annotated-cell-117-35"><a href="#annotated-cell-117-35" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span></span>
<span id="annotated-cell-117-36"><a href="#annotated-cell-117-36" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build and push</span></span>
<span id="annotated-cell-117-37"><a href="#annotated-cell-117-37" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/build-push-action@v5</span></span>
<span id="annotated-cell-117-38"><a href="#annotated-cell-117-38" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="annotated-cell-117-39"><a href="#annotated-cell-117-39" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">push</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="annotated-cell-117-40"><a href="#annotated-cell-117-40" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">tags</span><span class="kw">:</span><span class="at"> ${{ steps.meta.outputs.tags }}</span></span>
<span id="annotated-cell-117-41"><a href="#annotated-cell-117-41" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">labels</span><span class="kw">:</span><span class="at"> ${{ steps.meta.outputs.labels }}</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-117" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-117" data-code-lines="27" data-code-annotation="1">Modifier ici !</span>
</dd>
</dl>
</details>
<ul>
<li>Dans le d√©p√¥t de l‚Äôapplication, mettre √† jour le code dans <code>app/main.py</code> pour changer un √©l√©ment de l‚Äôinterface de votre documentation. Par exemple, mettre en gras un titre.</li>
</ul>
<div class="sourceCode" id="cb66" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> FastAPI(</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"D√©monstration du mod√®le de pr√©diction de survie sur le Titanic"</span>,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"&lt;b&gt;Application de pr√©diction de survie sur le Titanic&lt;/b&gt; üö¢ &lt;br&gt;Une version par API pour faciliter la r√©utilisation du mod√®le üöÄ"</span> <span class="op">+\</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;br&gt;&lt;br&gt;&lt;img src=</span><span class="ch">\"</span><span class="st">https://media.vogue.fr/photos/5faac06d39c5194ff9752ec9/1:1/w_2404,h_2404,c_limit/076_CHL_126884.jpg</span><span class="ch">\"</span><span class="st"> width=</span><span class="ch">\"</span><span class="st">200</span><span class="ch">\"</span><span class="st">&gt;"</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><em>Commit</em> et <em>push</em> les changements.</p></li>
<li><p><em>Tagger</em> le commit effectu√© pr√©c√©demment et <em>push</em> le nouveau tag :</p></li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb67" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git tag v0.0.1</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git push <span class="at">--tags</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>V√©rifier sur le d√©p√¥t <code>GitHub</code> de l‚Äôapplication que ce <em>commit</em> lance bien un pipeline de CI <strong>associ√© au tag v1.0.0</strong>. Une fois termin√©, v√©rifier sur le <code>DockerHub</code> que le tag <code>v0.0.1</code> existe bien parmi les tags disponibles de l‚Äôimage.</li>
</ul>
<p>La partie CI a correctement fonctionn√©. Int√©ressons-nous √† pr√©sent √† la partie CD.</p>
<ul>
<li>Sur le d√©p√¥t <code>GitOps</code>, mettre √† jour la version de l‚Äôimage √† d√©ployer en production dans le fichier <code>deployment/deployment.yaml</code></li>
</ul>
<details>
<summary>
<p>Fichier <code>deployment/deployment.yaml</code></p>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deployment/deployment.yaml</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-120" data-file="deployment/deployment.yaml" data-filename="deployment/deployment.yaml" data-source-line-numbers="19" data-code-line-numbers="19"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-120-1"><a href="#annotated-cell-120-1" aria-hidden="true" tabindex="-1"></a>apiVersion: apps<span class="op">/</span>v1</span>
<span id="annotated-cell-120-2"><a href="#annotated-cell-120-2" aria-hidden="true" tabindex="-1"></a>kind: Deployment</span>
<span id="annotated-cell-120-3"><a href="#annotated-cell-120-3" aria-hidden="true" tabindex="-1"></a>metadata:</span>
<span id="annotated-cell-120-4"><a href="#annotated-cell-120-4" aria-hidden="true" tabindex="-1"></a>  name: titanic<span class="op">-</span>deployment</span>
<span id="annotated-cell-120-5"><a href="#annotated-cell-120-5" aria-hidden="true" tabindex="-1"></a>  labels:</span>
<span id="annotated-cell-120-6"><a href="#annotated-cell-120-6" aria-hidden="true" tabindex="-1"></a>    app: titanic</span>
<span id="annotated-cell-120-7"><a href="#annotated-cell-120-7" aria-hidden="true" tabindex="-1"></a>spec:</span>
<span id="annotated-cell-120-8"><a href="#annotated-cell-120-8" aria-hidden="true" tabindex="-1"></a>  replicas: <span class="dv">1</span></span>
<span id="annotated-cell-120-9"><a href="#annotated-cell-120-9" aria-hidden="true" tabindex="-1"></a>  selector:</span>
<span id="annotated-cell-120-10"><a href="#annotated-cell-120-10" aria-hidden="true" tabindex="-1"></a>    matchLabels:</span>
<span id="annotated-cell-120-11"><a href="#annotated-cell-120-11" aria-hidden="true" tabindex="-1"></a>      app: titanic</span>
<span id="annotated-cell-120-12"><a href="#annotated-cell-120-12" aria-hidden="true" tabindex="-1"></a>  template:</span>
<span id="annotated-cell-120-13"><a href="#annotated-cell-120-13" aria-hidden="true" tabindex="-1"></a>    metadata:</span>
<span id="annotated-cell-120-14"><a href="#annotated-cell-120-14" aria-hidden="true" tabindex="-1"></a>      labels:</span>
<span id="annotated-cell-120-15"><a href="#annotated-cell-120-15" aria-hidden="true" tabindex="-1"></a>        app: titanic</span>
<span id="annotated-cell-120-16"><a href="#annotated-cell-120-16" aria-hidden="true" tabindex="-1"></a>    spec:</span>
<span id="annotated-cell-120-17"><a href="#annotated-cell-120-17" aria-hidden="true" tabindex="-1"></a>      containers:</span>
<span id="annotated-cell-120-18"><a href="#annotated-cell-120-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> name: titanic</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-120" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-120-19" class="code-annotation-target"><a href="#annotated-cell-120-19" aria-hidden="true" tabindex="-1"></a>        image: linogaliana<span class="op">/</span>application:v0<span class="fl">.0.1</span></span>
<span id="annotated-cell-120-20"><a href="#annotated-cell-120-20" aria-hidden="true" tabindex="-1"></a>        ports:</span>
<span id="annotated-cell-120-21"><a href="#annotated-cell-120-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> containerPort: <span class="dv">5000</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-120" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-120" data-code-lines="19" data-code-annotation="1">Remplacer ici par le d√©p√¥t applicatif ad√©quat</span>
</dd>
</dl>
</details>
<ul>
<li>Apr√®s avoir <em>committ√©</em> et <em>push√©</em>, observer dans <code>ArgoCD</code> le statut de votre application. Normalement, l‚Äôop√©rateur devrait avoir automatiquement identifi√© le changement, et mettre √† jour le d√©ploiement pour en tenir compte.</li>
</ul>
<p><img src="../argocd-waiting.png" class="img-fluid"></p>
<ul>
<li>V√©rifier que l‚ÄôAPI a bien √©t√© mise √† jour.</li>
</ul>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli19b-contents" aria-controls="callout-appli19b" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli19b      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli19b" class="callout-appli19b-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli19b<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli19b" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli19b</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</section>
<section id="etape-4-construire-un-site-web" class="level2">
<h2 class="anchored" data-anchor-id="etape-4-construire-un-site-web">Etape 4: construire un site web</h2>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-49-contents" aria-controls="callout-49" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Si vous prenez ce projet fil rouge en cours de route
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-49" class="callout-49-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb68" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli19</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout <span class="at">-b</span> dev</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git push origin dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>On va proposer un nouveau livrable pour parler √† un public plus large. Pour faire ce site web, on va utiliser <code>Quarto</code> et d√©ployer sur <code>Github Pages</code>.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 20: Cr√©ation d‚Äôun site web pour valoriser le projet
</div>
</div>
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb69" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> quarto create project website mysite</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Faire remonter d‚Äôun niveau <code>_quarto.yml</code></li>
<li>Supprimer <code>about.qmd</code>, d√©placer <code>index.qmd</code> vers la racine de notre projet.</li>
<li>Remplacer le contenu de <code>index.qmd</code> par <a href="https://raw.githubusercontent.com/ensae-reproductibilite/application/tree/appli19/index.qmd">celui-ci</a> et retirer <code>about.qmd</code> des fichiers √† compiler.</li>
<li>D√©placer <code>styles.css</code> √† la racine du projet</li>
<li>Mettre √† jour le <code>.gitignore</code> avec les instructions suivantes</li>
</ul>
<div class="sourceCode" id="cb70" data-file=".gitignore" data-no-prefix="true" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/.quarto/</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="ex">*.html</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="ex">*_files</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="ex">_site/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>En ligne de commande, faire <code>quarto preview</code> (ajouter les arguments <code>--port 5000 --host 0.0.0.0</code> si vous passez par le <code>SSPCloud</code>)</li>
<li>Observer le site web g√©n√©r√© en local</li>
</ul>
<p>Enfin, on va construire et d√©ployer automatiquement ce site web gr√¢ce au combo <code>Github Actions</code> et <code>Github Pages</code>:</p>
<ul>
<li>Cr√©er une branche <code>gh-pages</code> √† partir des lignes suivantes</li>
</ul>
<div class="sourceCode" id="cb71" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>git checkout <span class="op">--</span>orphan gh<span class="op">-</span>pages</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>git reset <span class="op">--</span>hard <span class="co"># make sure all changes are committed before running this!</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>git commit <span class="op">--</span>allow<span class="op">-</span>empty <span class="op">-</span>m <span class="st">"Initialising gh-pages branch"</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>git push origin gh<span class="op">-</span>pages</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Revenir √† votre branche</li>
<li>Cr√©er un fichier <code>.github/workflows/website.yaml</code> avec le contenu de <a href="https://raw.githubusercontent.com/ensae-reproductibilite/application/tree/appli20/.github/workflows/publish.yaml">ce fichier</a></li>
<li>Modifier le <code>README</code> pour indiquer l‚ÄôURL de votre site web et de votre API</li>
</ul>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli20-contents" aria-controls="callout-appli20" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli20      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli20" class="callout-appli20-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli20<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli20" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli20</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</section>
</section>
<section id="partie-6-adopter-une-approche-mlops-pour-am√©liorer-notre-mod√®le" class="level1">
<h1>Partie 6: adopter une approche MLOps pour am√©liorer notre mod√®le</h1>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-51-contents" aria-controls="callout-51" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Si vous prenez ce projet fil rouge en cours de route
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-51" class="callout-51-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb72" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli20</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout <span class="at">-b</span> dev</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git push origin dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>Maintenant que nous avons tout pr√©par√© pour mettre √† disposition rapidement un mod√®le, nous pouvons revenir en arri√®re pour am√©liorer ce mod√®le. Pour cela, nous allons mettre en oeuvre une validation crois√©e.</p>
<p>Le probl√®me que nous allons rencontrer va √™tre que nous voudrions facilement tracer les √©volutions de notre mod√®le, la qualit√© pr√©dictive de celui-ci dans diff√©rentes situations. Il s‚Äôagira d‚Äô√† nouveau mettre en place du <em>logging</em> mais, cette fois, de suivre la qualit√© du mod√®le et pas seulement s‚Äôil fonctionne. L‚Äôoutil <code>MLFlow</code> va r√©pondre √† ce probl√®me et va, au passage, fluidifier la mise √† disposition du mod√®le de production, c‚Äôest-√†-dire de celui qu‚Äôon d√©sire mettre √† disposition du public.</p>
<section id="revenir-sur-le-code-dentra√Ænement-du-mod√®le-pour-faire-de-la-validation-crois√©e" class="level2">
<h2 class="anchored" data-anchor-id="revenir-sur-le-code-dentra√Ænement-du-mod√®le-pour-faire-de-la-validation-crois√©e">Revenir sur le code d‚Äôentra√Ænement du mod√®le pour faire de la validation crois√©e</h2>
<p>Pour pouvoir faire ceci, il va falloir changer un tout petit peu notre code applicatif dans sa phase d‚Äôentra√Ænement.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 21 <em>(optionnelle)</em>: restructuration de la cha√Æne
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Faire les modifications suivantes pour restructurer notre <em>pipeline</em> afin de mieux distinguer les √©tapes d‚Äôestimation et d‚Äô√©valuation</li>
</ol>
<details>
<summary>
Modification de <code>train.py</code> pour faire une <em>grid search</em>
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>train.py</strong></pre>
</div>
<div class="sourceCode" id="cb73" data-filename="train.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="co">Prediction de la survie d'un individu sur le Titanic</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> loguru <span class="im">import</span> logger</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pathlib</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> dump</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.pipeline.build_pipeline <span class="im">import</span> split_train_test, create_pipeline</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> src.models.train_evaluate <span class="im">import</span> evaluate_model</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a><span class="co"># ENVIRONMENT CONFIGURATION ---------------------------</span></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>logger.add(<span class="st">"recording.log"</span>, rotation<span class="op">=</span><span class="st">"500 MB"</span>)</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span><span class="st">"Param√®tres du random forest"</span>)</span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>parser.add_argument(</span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"--n_trees"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">20</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Nombre d'arbres"</span></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>args <span class="op">=</span> parser.parse_args()</span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>URL_RAW <span class="op">=</span> <span class="st">"https://minio.lab.sspcloud.fr/lgaliana/ensae-reproductibilite/data/raw/data.csv"</span></span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>n_trees <span class="op">=</span> args.n_trees</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>jeton_api <span class="op">=</span> os.environ.get(<span class="st">"JETON_API"</span>, <span class="st">""</span>)</span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> os.environ.get(<span class="st">"data_path"</span>, URL_RAW)</span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a>data_train_path <span class="op">=</span> os.environ.get(<span class="st">"train_path"</span>, <span class="st">"data/derived/train.parquet"</span>)</span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a>data_test_path <span class="op">=</span> os.environ.get(<span class="st">"test_path"</span>, <span class="st">"data/derived/test.parquet"</span>)</span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a>MAX_DEPTH <span class="op">=</span> <span class="va">None</span></span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>MAX_FEATURES <span class="op">=</span> <span class="st">"sqrt"</span></span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> jeton_api.startswith(<span class="st">"$"</span>):</span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">"API token has been configured properly"</span>)</span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a>    logger.warning(<span class="st">"API token has not been configured"</span>)</span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a><span class="co"># IMPORT ET STRUCTURATION DONNEES --------------------------------</span></span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> pathlib.Path(<span class="st">"data/derived/"</span>)</span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a>p.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a>TrainingData <span class="op">=</span> pd.read_csv(data_path)</span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> split_train_test(</span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a>    TrainingData, test_size<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a>    train_path<span class="op">=</span>data_train_path,</span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true" tabindex="-1"></a>    test_path<span class="op">=</span>data_test_path</span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-59"><a href="#cb73-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-60"><a href="#cb73-60" aria-hidden="true" tabindex="-1"></a><span class="co"># PIPELINE ----------------------------</span></span>
<span id="cb73-61"><a href="#cb73-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-62"><a href="#cb73-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-63"><a href="#cb73-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the pipeline</span></span>
<span id="cb73-64"><a href="#cb73-64" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> create_pipeline(</span>
<span id="cb73-65"><a href="#cb73-65" aria-hidden="true" tabindex="-1"></a>    n_trees, max_depth<span class="op">=</span>MAX_DEPTH, max_features<span class="op">=</span>MAX_FEATURES</span>
<span id="cb73-66"><a href="#cb73-66" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-67"><a href="#cb73-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-68"><a href="#cb73-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-69"><a href="#cb73-69" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {</span>
<span id="cb73-70"><a href="#cb73-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">"classifier__n_estimators"</span>: [<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>],</span>
<span id="cb73-71"><a href="#cb73-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">"classifier__max_leaf_nodes"</span>: [<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">50</span>],</span>
<span id="cb73-72"><a href="#cb73-72" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb73-73"><a href="#cb73-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-74"><a href="#cb73-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-75"><a href="#cb73-75" aria-hidden="true" tabindex="-1"></a>pipe_cross_validation <span class="op">=</span> GridSearchCV(</span>
<span id="cb73-76"><a href="#cb73-76" aria-hidden="true" tabindex="-1"></a>    pipe,</span>
<span id="cb73-77"><a href="#cb73-77" aria-hidden="true" tabindex="-1"></a>    param_grid<span class="op">=</span>param_grid,</span>
<span id="cb73-78"><a href="#cb73-78" aria-hidden="true" tabindex="-1"></a>    scoring<span class="op">=</span>[<span class="st">"accuracy"</span>, <span class="st">"precision"</span>, <span class="st">"recall"</span>, <span class="st">"f1"</span>],</span>
<span id="cb73-79"><a href="#cb73-79" aria-hidden="true" tabindex="-1"></a>    refit<span class="op">=</span><span class="st">"f1"</span>,</span>
<span id="cb73-80"><a href="#cb73-80" aria-hidden="true" tabindex="-1"></a>    cv<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb73-81"><a href="#cb73-81" aria-hidden="true" tabindex="-1"></a>    n_jobs<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb73-82"><a href="#cb73-82" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb73-83"><a href="#cb73-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-84"><a href="#cb73-84" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> pipe_cross_validation.best_estimator_</span>
<span id="cb73-85"><a href="#cb73-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-86"><a href="#cb73-86" aria-hidden="true" tabindex="-1"></a><span class="co"># ESTIMATION ET EVALUATION ----------------------</span></span>
<span id="cb73-87"><a href="#cb73-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-88"><a href="#cb73-88" aria-hidden="true" tabindex="-1"></a>pipe.fit(X_train, y_train)</span>
<span id="cb73-89"><a href="#cb73-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-90"><a href="#cb73-90" aria-hidden="true" tabindex="-1"></a>dump(pipe, <span class="st">'model.joblib'</span>)</span>
<span id="cb73-91"><a href="#cb73-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-92"><a href="#cb73-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-93"><a href="#cb73-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate the model</span></span>
<span id="cb73-94"><a href="#cb73-94" aria-hidden="true" tabindex="-1"></a>score, matrix <span class="op">=</span> evaluate_model(pipe, X_test, y_test)</span>
<span id="cb73-95"><a href="#cb73-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-96"><a href="#cb73-96" aria-hidden="true" tabindex="-1"></a>logger.success(<span class="ss">f"</span><span class="sc">{</span>score<span class="sc">:.1%}</span><span class="ss"> de bonnes r√©ponses sur les donn√©es de test pour validation"</span>)</span>
<span id="cb73-97"><a href="#cb73-97" aria-hidden="true" tabindex="-1"></a>logger.debug(<span class="dv">20</span> <span class="op">*</span> <span class="st">"-"</span>)</span>
<span id="cb73-98"><a href="#cb73-98" aria-hidden="true" tabindex="-1"></a>logger.info(<span class="st">"Matrice de confusion"</span>)</span>
<span id="cb73-99"><a href="#cb73-99" aria-hidden="true" tabindex="-1"></a>logger.debug(matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ol start="2" type="1">
<li>Dans le code de l‚ÄôAPI (<code>api/main.py</code>), changer la version du mod√®le mis en oeuvre en <em>‚Äú0.2‚Äù</em></li>
<li>Apr√®s avoir committ√© cette nouvelle version du code applicatif, tagguer ce d√©p√¥t avec le tag <code>v0.0.2</code></li>
<li>Modifier <code>deployment/deployment.yaml</code> dans le code <code>GitOps</code> pour utiliser ce <em>tag</em>.</li>
</ol>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli21-contents" aria-controls="callout-appli21" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli21      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli21" class="callout-appli21-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli21<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli21" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli21</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
</section>
<section id="garder-une-trace-des-entra√Ænements-de-notre-mod√®le-gr√¢ce-au-register-de-mlflow" class="level2">
<h2 class="anchored" data-anchor-id="garder-une-trace-des-entra√Ænements-de-notre-mod√®le-gr√¢ce-au-register-de-mlflow">Garder une trace des entra√Ænements de notre mod√®le gr√¢ce au <em>register</em> de <code>MLFlow</code></h2>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-53-contents" aria-controls="callout-53" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Si vous prenez ce projet fil rouge en cours de route
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-53" class="callout-53-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="cb74" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli21</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="enregistrer-nos-premiers-entra√Ænements" class="level2">
<h2 class="anchored" data-anchor-id="enregistrer-nos-premiers-entra√Ænements">Enregistrer nos premiers entra√Ænements</h2>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 22 : archiver nos entra√Ænements avec <code>MLFlow</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>Lancer <code>MLFlow</code> depuis l‚Äôonflet <a href="https://datalab.sspcloud.fr/catalog/automation">Mes services</a> du SSPCloud. Attendre que le service soit bien lanc√©. Cela cr√©era un service dont l‚ÄôURL est de la forme <code>https://user-{username}.user.lab.sspcloud.fr</code>. Ce service <code>MLFlow</code> communiquera avec les <code>VSCode</code> que vous ouvrirez ult√©rieurement √† partir de cet URL ainsi qu‚Äôavec le syst√®me de stockage <code>S3</code><a href="#fn20" class="footnote-ref" id="fnref20" role="doc-noteref"><sup>20</sup></a>.</p></li>
<li><p>Regarder la page <code>Experiments</code>. Elle ne contient que <code>Default</code> √† ce stade, c‚Äôest normal.</p></li>
</ol>
<ol start="2" type="1">
<li><p>Une fois le service <code>MLFlow</code> fonctionnel, lancer un nouveau <code>VSCode</code> pour b√©n√©ficier de la connexion automatique entre les services interactifs du SSPCloud et les services d‚Äôautomatisation comme <code>MLFlow</code>.</p></li>
<li><p>Cl√¥ner votre projet, vous situer sur la branche de travail.</p></li>
<li><p>Dans la section de passage des param√®tres de notre ligne de commande, introduire ce morceau de code:</p></li>
</ol>
<div class="sourceCode" id="cb75" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span><span class="st">"Param√®tres du random forest"</span>)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>parser.add_argument(</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"--n_trees"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">20</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Nombre d'arbres"</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>parser.add_argument(</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"--experiment_name"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, default<span class="op">=</span><span class="st">"titanicml"</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"MLFlow experiment name"</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>args <span class="op">=</span> parser.parse_args()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li><p>Faire tourner <code>train.py</code> en ligne de commande puis retourner sur l‚ÄôUI de <code>MLFlow</code> et observer la diff√©rence, √† gauche.</p></li>
<li><p>A la fin du script <code>train.py</code>, ajouter le code suivant</p></li>
</ol>
<details>
<summary>
Code √† ajouter
</summary>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>fin de train.py</strong></pre>
</div>
<div class="sourceCode" id="cb76" data-filename="fin de train.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># LOGGING IN MLFLOW -----------------</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>input_data_mlflow <span class="op">=</span> mlflow.data.from_pandas(</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    TrainingData, source<span class="op">=</span>data_path, name<span class="op">=</span><span class="st">"Raw dataset"</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>training_data_mlflow <span class="op">=</span> mlflow.data.from_pandas(</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    pd.concat([X_train, y_train], axis<span class="op">=</span><span class="dv">1</span>), source<span class="op">=</span>data_path, name<span class="op">=</span><span class="st">"Training data"</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run():</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log datasets</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    mlflow.log_input(input_data_mlflow, context<span class="op">=</span><span class="st">"raw"</span>)</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>    mlflow.log_input(training_data_mlflow, context<span class="op">=</span><span class="st">"raw"</span>)</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log parameters</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">"n_trees"</span>, n_trees)</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">"max_depth"</span>, MAX_DEPTH)</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">"max_features"</span>, MAX_FEATURES)</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log best hyperparameters from GridSearchCV</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>    best_params <span class="op">=</span> pipe_cross_validation.best_params_</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> param, value <span class="kw">in</span> best_params.items():</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>        mlflow.log_param(param, value)</span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log metrics</span></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">"accuracy"</span>, score)</span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log confusion matrix as an artifact</span></span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>    matrix_path <span class="op">=</span> <span class="st">"confusion_matrix.txt"</span></span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(matrix_path, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>        f.write(<span class="bu">str</span>(matrix))</span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(matrix_path)</span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log model</span></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a>    mlflow.sklearn.log_model(pipe, <span class="st">"model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</details>
<ol start="5" type="1">
<li><p>Ajouter <code>mlruns/*</code> dans <code>.gitignore</code></p></li>
<li><p>Tester <code>train.py</code> en ligne de commande</p></li>
<li><p>Observer l‚Äô√©volution de la page <code>Experiments</code>. Cliquer sur un des <em>run</em>. Observer toutes les m√©tadonn√©es archiv√©es (hyperparam√®tres, m√©triques d‚Äô√©valuation, <code>requirements.txt</code> dont <code>MLFlow</code> a fait l‚Äôinf√©rence, etc.)</p></li>
<li><p>Observer le code propos√© par <code>MLFlow</code> pour r√©cup√©rer le <em>run</em> en question. Tester celui-ci dans un <em>notebook</em> sur le fichier interm√©diaire de test au format <code>Parquet</code></p></li>
<li><p>En ligne de commande, faites tourner pour une autre valeur de <code>n_trees</code>. Retourner √† la liste des <em>runs</em> en cliquant √† nouveau sur <em>‚Äútitanicml‚Äù</em> dans les exp√©rimentations</p></li>
<li><p>Dans l‚Äôonglet <code>Table</code>, s√©lectionner plusieurs exp√©rimentations, cliquer sur <code>Columns</code> et ajouter la statistique d‚Äôaccuracy. Ajuster la taille des colonnes pour la voir et classer les mod√®les par score d√©croissants</p></li>
<li><p>Cliquer sur <code>Compare</code> apr√®s en avoir s√©lectionn√© plusieurs. Afficher un <em>scatterplot</em> des performances en fonction du nombre d‚Äôestimateurs. Conclure.</p></li>
</ol>
</div>
</div>
  <div class="callout callout-style-default callout-caution callout-titled">
    <div class="callout-header d-flex align-content-center collapse" data-bs-toggle="collapse" data-bs-target=".callout-appli22-contents" aria-controls="callout-appli22" aria-expanded="true" aria-label="Toggle callout">
      <div class="callout-icon-container">
        <i class="callout-icon"></i>
      </div>
      <div class="callout-title-container flex-fill">
        Checkpoint post appli22      </div>
      <div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
    </div>
    <div id="callout-appli22" class="callout-appli22-contents callout-collapse collapse" style="">
      <div class="callout-body-container callout-body">

        
        <div class="code-with-filename">
          <div class="code-with-filename-file">
            <pre><strong>terminal</strong></pre>
          </div>
          <div class="sourceCode" data-filename="terminal">
            <pre class="sourceCode python code-annotated code-with-copy"><code class="sourceCode python">curl -sSL https://raw.githubusercontent.com/ensae-reproductibilite/website/refs/heads/main/chapters/applications/overwrite.sh -o update.sh &amp;&amp; chmod +x update.sh
./update.sh appli22<a class="code-annotation-anchor" data-target-cell="annotated-cell-appli22" data-target-annotation="2" onclick="event.preventDefault();">2</a>
rm -f update.sh</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
          </div>
        </div>
        <dl class="code-annotation-container-grid">
          <dt>1</dt>
          <dd>R√©cup√©rer le script de <em>checkpoint</em></dd>
          <dt>2</dt>
          <dd>Avancer √† l‚Äô√©tat √† l‚Äôissue de l‚Äôapplication appli22</dd>
          <dt>3</dt>
          <dd>Nettoyer derri√®re nous</dd>
        </dl>

        <div class="quarto-figure quarto-figure-center">
          <figure class="figure">
            <p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
          </figure>
        </div>
      </div>
    </div>
  </div>
  
<p>Cette appplication illustre l‚Äôun des premiers apports de <code>MLFlow</code>: on garde une trace de nos exp√©rimentations: le mod√®le est archiv√© avec les param√®tres et des m√©triques de performance. On peut donc retrouver de plusieurs mani√®res un mod√®le qui nous avait tap√© dans l‚Äôoeil.</p>
<p>N√©anmoins, persistent un certain nombre de voies d‚Äôam√©lioration dans notre <em>pipeline</em>.</p>
<ul>
<li>On entra√Æne le mod√®le en local, de mani√®re s√©quentielle, et en lan√ßant nous-m√™mes le script <code>train.py</code>.</li>
<li>Pis encore, √† l‚Äôheure actuelle, cette √©tape d‚Äôestimation n‚Äôest pas s√©par√©e de la mise √† disposition du mod√®le par le biais de notre API. On archive des mod√®les mais on les utilise pas ult√©rieurement.</li>
</ul>
<p>Les prochaines applications permettront d‚Äôam√©liorer ceci.</p>
</section>
<section id="consommation-dun-mod√®le-archiv√©-sur-mlflow" class="level2">
<h2 class="anchored" data-anchor-id="consommation-dun-mod√®le-archiv√©-sur-mlflow">Consommation d‚Äôun mod√®le archiv√© sur <code>MLFlow</code></h2>
<p>A l‚Äôheure actuelle, notre <em>pipeline</em> est lin√©aire:</p>
<p><img src="../chapters/applications/figures/pipeline_avant_appli23.png" class="img-fluid"></p>
<p>Ceci nous g√™ne pour faire √©voluer notre mod√®le: on ne dissocie pas ce qui rel√®ve de l‚Äôentra√Ænement du mod√®le de son utilisation. Un <em>pipeline</em> plus cyclique permettra de mieux dissocier l‚Äôexp√©rimentation de la production:</p>
<p><img src="../chapters/applications/figures/pipeline_apres_appli23.png" class="img-fluid"></p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Application 23 : passer en production un mod√®le avec MLFlow
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>Si vous avez entra√Æn√© plusieurs mod√®les avec des <code>n_trees</code> diff√©rents, utiliser l‚Äôinterface de <code>MLFlow</code> pour s√©lectionner le ‚Äúmeilleur‚Äù. Cliquer sur le mod√®le en question et faire l‚Äôaction <em>‚ÄúRegister Model‚Äù</em>. L‚Äôenregistrer comme le mod√®le de <em>‚Äúproduction‚Äù</em></p></li>
<li><p>Rendez-vous sur l‚Äôonglet <code>Models</code> et observez cet entrep√¥t de mod√®les. Cliquez sur le mod√®le de production. Vous pourrez par ce biais suivre ses diff√©rentes versions.</p></li>
<li><p>Ouvrir un notebook temporaire et observer le r√©sultat.</p></li>
</ol>
<div class="sourceCode" id="cb77" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>model_name <span class="op">=</span> <span class="st">"production"</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>model_version <span class="op">=</span> <span class="st">"latest"</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the model from the Model Registry</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>model_uri <span class="op">=</span> <span class="ss">f"models:/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>model_version<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>logged_model <span class="op">=</span> mlflow.sklearn.load_model(model_uri)</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a><span class="co"># GENERATE PREDICTION DATA ---------------------</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_data(</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>    sex: <span class="bu">str</span> <span class="op">=</span> <span class="st">"female"</span>,</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>    age: <span class="bu">float</span> <span class="op">=</span> <span class="fl">29.0</span>,</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>    fare: <span class="bu">float</span> <span class="op">=</span> <span class="fl">16.5</span>,</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>    embarked: <span class="bu">str</span> <span class="op">=</span> <span class="st">"S"</span>,</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Sex"</span>: [sex],</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Age"</span>: [age],</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Fare"</span>: [fare],</span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Embarked"</span>: [embarked],</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.concat(</span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a>    [create_data(age<span class="op">=</span><span class="dv">40</span>), create_data(sex<span class="op">=</span><span class="st">"male"</span>)]</span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a><span class="co"># PREDICTION ---------------------</span></span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a>logged_model.predict(pd.DataFrame(data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="4" type="1">
<li>On va adapter le code applicatif de notre API pour tenir compte de ce mod√®le de production.</li>
</ol>
<div class="sourceCode" id="cb78" data-file="api/main.py" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""A simple API to expose our trained RandomForest model for Tutanic survival."""</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastapi <span class="im">import</span> FastAPI</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Preload model -------------------</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>model_name <span class="op">=</span> <span class="st">"production"</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>model_version <span class="op">=</span> <span class="st">"latest"</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the model from the Model Registry</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>model_uri <span class="op">=</span> <span class="ss">f"models:/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>model_version<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> mlflow.sklearn.load_model(model_uri)</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Define app -------------------------</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> FastAPI(</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Pr√©diction de survie sur le Titanic"</span>,</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Application de pr√©diction de survie sur le Titanic üö¢ &lt;br&gt;Une version par API pour faciliter la r√©utilisation du mod√®le üöÄ"</span> <span class="op">+\</span></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;br&gt;&lt;br&gt;&lt;img src=</span><span class="ch">\"</span><span class="st">https://media.vogue.fr/photos/5faac06d39c5194ff9752ec9/1:1/w_2404,h_2404,c_limit/076_CHL_126884.jpg</span><span class="ch">\"</span><span class="st"> width=</span><span class="ch">\"</span><span class="st">200</span><span class="ch">\"</span><span class="st">&gt;"</span></span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">"/"</span>, tags<span class="op">=</span>[<span class="st">"Welcome"</span>])</span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_welcome_page():</span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a><span class="co">    Show welcome page with model name and version.</span></span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb78-34"><a href="#cb78-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Message"</span>: <span class="st">"API de pr√©diction de survie sur le Titanic"</span>,</span>
<span id="cb78-35"><a href="#cb78-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Model_name"</span>: <span class="st">'Titanic ML'</span>,</span>
<span id="cb78-36"><a href="#cb78-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Model_version"</span>: <span class="st">"0.3"</span>,</span>
<span id="cb78-37"><a href="#cb78-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb78-38"><a href="#cb78-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-39"><a href="#cb78-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-40"><a href="#cb78-40" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">"/predict"</span>, tags<span class="op">=</span>[<span class="st">"Predict"</span>])</span>
<span id="cb78-41"><a href="#cb78-41" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> predict(</span>
<span id="cb78-42"><a href="#cb78-42" aria-hidden="true" tabindex="-1"></a>    sex: <span class="bu">str</span> <span class="op">=</span> <span class="st">"female"</span>,</span>
<span id="cb78-43"><a href="#cb78-43" aria-hidden="true" tabindex="-1"></a>    age: <span class="bu">float</span> <span class="op">=</span> <span class="fl">29.0</span>,</span>
<span id="cb78-44"><a href="#cb78-44" aria-hidden="true" tabindex="-1"></a>    fare: <span class="bu">float</span> <span class="op">=</span> <span class="fl">16.5</span>,</span>
<span id="cb78-45"><a href="#cb78-45" aria-hidden="true" tabindex="-1"></a>    embarked: <span class="bu">str</span> <span class="op">=</span> <span class="st">"S"</span></span>
<span id="cb78-46"><a href="#cb78-46" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb78-47"><a href="#cb78-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb78-48"><a href="#cb78-48" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb78-49"><a href="#cb78-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-50"><a href="#cb78-50" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb78-51"><a href="#cb78-51" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb78-52"><a href="#cb78-52" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Sex"</span>: [sex],</span>
<span id="cb78-53"><a href="#cb78-53" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Age"</span>: [age],</span>
<span id="cb78-54"><a href="#cb78-54" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Fare"</span>: [fare],</span>
<span id="cb78-55"><a href="#cb78-55" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Embarked"</span>: [embarked],</span>
<span id="cb78-56"><a href="#cb78-56" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb78-57"><a href="#cb78-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb78-58"><a href="#cb78-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-59"><a href="#cb78-59" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> <span class="st">"Survived üéâ"</span> <span class="cf">if</span> <span class="bu">int</span>(model.predict(df)) <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">"Dead ‚ö∞Ô∏è"</span></span>
<span id="cb78-60"><a href="#cb78-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-61"><a href="#cb78-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prediction</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Les changements principaux de ce code sont:</p>
<ul>
<li>on va chercher le mod√®le de production</li>
<li>on met √† jour la version de notre API pour signaler √† nos clients que celle-ci a √©volu√©</li>
</ul>
<ol start="6" type="1">
<li>On va retirer l‚Äôentra√Ænement de la s√©quence d‚Äôop√©ration du <code>api/run.sh</code>. En supprimant la ligne relative √† l‚Äôentra√Ænement du mod√®le, vous devriez avoir</li>
</ol>
<div class="sourceCode" id="cb79" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co">#/bin/bash</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>uvicorn api.main:app <span class="op">--</span><span class="bu">reload</span> <span class="op">--</span>host <span class="st">"0.0.0.0"</span> <span class="op">--</span>port <span class="dv">5000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Mettons en production cette nouvelle version. Cela implique de faire les gestes suivants:</p>
<ol start="7" type="1">
<li><p>Publier un tag <code>v0.0.3</code> pour le code applicatif</p></li>
<li><p>Mettre √† jour notre manifeste dans le d√©p√¥t <code>GitOps</code>. En premier lieu, il faut changer la version de r√©f√©rence pour utiliser le tag <code>v0.0.3</code>. De plus, il faut d√©clarer la variable d‚Äôenvironnement <code>MLFLOW_TRACKING_URI</code> qui indique √† <code>Python</code> l‚Äôentrep√¥t de mod√®les o√π aller chercher celui en production. La bonne pratique est de d√©finir ceci hors du code, dans un fichier de configuration donc, ce qui est l‚Äôobjet de notre manifeste <code>deployment.yaml</code>. On peut donc changer de cette mani√®re ce fichier:</p></li>
</ol>
<div id="e421ad2e" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="annotated-cell-140" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-140-1"><a href="#annotated-cell-140-1" aria-hidden="true" tabindex="-1"></a>apiVersion: apps<span class="op">/</span>v1</span>
<span id="annotated-cell-140-2"><a href="#annotated-cell-140-2" aria-hidden="true" tabindex="-1"></a>kind: Deployment</span>
<span id="annotated-cell-140-3"><a href="#annotated-cell-140-3" aria-hidden="true" tabindex="-1"></a>metadata:</span>
<span id="annotated-cell-140-4"><a href="#annotated-cell-140-4" aria-hidden="true" tabindex="-1"></a>  name: titanic<span class="op">-</span>deployment</span>
<span id="annotated-cell-140-5"><a href="#annotated-cell-140-5" aria-hidden="true" tabindex="-1"></a>  labels:</span>
<span id="annotated-cell-140-6"><a href="#annotated-cell-140-6" aria-hidden="true" tabindex="-1"></a>    app: titanic</span>
<span id="annotated-cell-140-7"><a href="#annotated-cell-140-7" aria-hidden="true" tabindex="-1"></a>spec:</span>
<span id="annotated-cell-140-8"><a href="#annotated-cell-140-8" aria-hidden="true" tabindex="-1"></a>  replicas: <span class="dv">1</span></span>
<span id="annotated-cell-140-9"><a href="#annotated-cell-140-9" aria-hidden="true" tabindex="-1"></a>  selector:</span>
<span id="annotated-cell-140-10"><a href="#annotated-cell-140-10" aria-hidden="true" tabindex="-1"></a>    matchLabels:</span>
<span id="annotated-cell-140-11"><a href="#annotated-cell-140-11" aria-hidden="true" tabindex="-1"></a>      app: titanic</span>
<span id="annotated-cell-140-12"><a href="#annotated-cell-140-12" aria-hidden="true" tabindex="-1"></a>  template:</span>
<span id="annotated-cell-140-13"><a href="#annotated-cell-140-13" aria-hidden="true" tabindex="-1"></a>    metadata:</span>
<span id="annotated-cell-140-14"><a href="#annotated-cell-140-14" aria-hidden="true" tabindex="-1"></a>      labels:</span>
<span id="annotated-cell-140-15"><a href="#annotated-cell-140-15" aria-hidden="true" tabindex="-1"></a>        app: titanic</span>
<span id="annotated-cell-140-16"><a href="#annotated-cell-140-16" aria-hidden="true" tabindex="-1"></a>    spec:</span>
<span id="annotated-cell-140-17"><a href="#annotated-cell-140-17" aria-hidden="true" tabindex="-1"></a>      containers:</span>
<span id="annotated-cell-140-18"><a href="#annotated-cell-140-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> name: titanic</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-140" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-140-19" class="code-annotation-target"><a href="#annotated-cell-140-19" aria-hidden="true" tabindex="-1"></a>        image: linogaliana<span class="op">/</span>application:v0<span class="fl">.0.3</span></span>
<span id="annotated-cell-140-20"><a href="#annotated-cell-140-20" aria-hidden="true" tabindex="-1"></a>        ports:</span>
<span id="annotated-cell-140-21"><a href="#annotated-cell-140-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> containerPort: <span class="dv">5000</span></span>
<span id="annotated-cell-140-22"><a href="#annotated-cell-140-22" aria-hidden="true" tabindex="-1"></a>        env:</span>
<span id="annotated-cell-140-23"><a href="#annotated-cell-140-23" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: MLFLOW_TRACKING_URI</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-140" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-140-24" class="code-annotation-target"><a href="#annotated-cell-140-24" aria-hidden="true" tabindex="-1"></a>            value: https:<span class="op">//</span>user<span class="op">-</span>${USERNAME}<span class="op">-</span>mlflow.user.lab.sspcloud.fr</span>
<span id="annotated-cell-140-25"><a href="#annotated-cell-140-25" aria-hidden="true" tabindex="-1"></a>        resources:</span>
<span id="annotated-cell-140-26"><a href="#annotated-cell-140-26" aria-hidden="true" tabindex="-1"></a>          limits:</span>
<span id="annotated-cell-140-27"><a href="#annotated-cell-140-27" aria-hidden="true" tabindex="-1"></a>            memory: <span class="st">"2Gi"</span></span>
<span id="annotated-cell-140-28"><a href="#annotated-cell-140-28" aria-hidden="true" tabindex="-1"></a>            cpu: <span class="st">"1000m"</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-140" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-140" data-code-lines="19" data-code-annotation="1">Le <em>tag</em> de notre code applicatif</span>
</dd>
<dt data-target-cell="annotated-cell-140" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-140" data-code-lines="24" data-code-annotation="2">La variable d‚Äôenvironnement √† adapter en fonction de l‚Äôadresse du d√©p√¥t de mod√®les utilis√©</span>
</dd>
</dl>
</div>
</div>
</div>
</div>
<p>A ce stade, nous avons am√©lior√© la fiabilit√© de notre application car nous utilisons le meilleur mod√®le. N√©anmoins, nos entra√Ænements sont encore manuels. L√† encore il y a des gains √† avoir car cela para√Æt p√©nible √† la longue de devoir syst√©matiquement relancer des entra√Ænements manuellement pour tester des variations de tel ou tel param√®tre. Heureusement, nous allons pouvoir automatiser ceci √©galement.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-56-contents" aria-controls="callout-56" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Checkpoint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-56" class="callout-56-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>terminal</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-141" data-filename="terminal" data-code-line-numbers=""><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-141" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-141-1" class="code-annotation-target"><a href="#annotated-cell-141-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git stash</span>
<span id="annotated-cell-141-2"><a href="#annotated-cell-141-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> git checkout appli23</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-141" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-141" data-code-lines="1" data-code-annotation="1">Pour annuler les modifications depuis le dernier <em>commit</em></span>
</dd>
</dl>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../checkpoint.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<section id="industrialiser-les-entra√Ænements-de-nos-mod√®les" class="level3">
<h3 class="anchored" data-anchor-id="industrialiser-les-entra√Ænements-de-nos-mod√®les">Industrialiser les entra√Ænements de nos mod√®les</h3>
<p>Pour industrialiser nos entra√Ænements, nous allons cr√©er des processus parall√®les ind√©pendants pour chaque combinaison de nos hyperparam√®tres. Pour cela, l‚Äôoutil pratique sur le SSPCloud est <code>Argo workflows</code>.</p>
<p>Chaque combinaison d‚Äôhyperparam√®tres sera un processus isol√© √† l‚Äôissue duquel sera loggu√© le r√©sultat dans <code>MLFlow</code>. Ces entra√Ænements auront lieu en parall√®le.</p>
<p><img src="https://inseefrlab.github.io/formation-mlops/slides/img/pokemon_workflow.png" class="img-fluid"></p>
<ol type="1">
<li>Lancer un service Argo Workflows</li>
<li>Dans le d√©p√¥t GitOps, cr√©er un fichier <code>argo-workflow/manifest.yaml</code></li>
</ol>
<div class="sourceCode" id="annotated-cell-10" data-code-line-numbers=""><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-10-1"><a href="#annotated-cell-10-1" aria-hidden="true" tabindex="-1"></a>apiVersion: argoproj.io<span class="op">/</span>v1alpha1</span>
<span id="annotated-cell-10-2"><a href="#annotated-cell-10-2" aria-hidden="true" tabindex="-1"></a>kind: Workflow</span>
<span id="annotated-cell-10-3"><a href="#annotated-cell-10-3" aria-hidden="true" tabindex="-1"></a>metadata:</span>
<span id="annotated-cell-10-4"><a href="#annotated-cell-10-4" aria-hidden="true" tabindex="-1"></a>  generateName: titanic<span class="op">-</span>training<span class="op">-</span>workflow<span class="op">-</span></span>
<span id="annotated-cell-10-5"><a href="#annotated-cell-10-5" aria-hidden="true" tabindex="-1"></a>  namespace: user<span class="op">-</span>lgaliana</span>
<span id="annotated-cell-10-6"><a href="#annotated-cell-10-6" aria-hidden="true" tabindex="-1"></a>spec:</span>
<span id="annotated-cell-10-7"><a href="#annotated-cell-10-7" aria-hidden="true" tabindex="-1"></a>  entrypoint: main</span>
<span id="annotated-cell-10-8"><a href="#annotated-cell-10-8" aria-hidden="true" tabindex="-1"></a>  serviceAccountName: workflow</span>
<span id="annotated-cell-10-9"><a href="#annotated-cell-10-9" aria-hidden="true" tabindex="-1"></a>  arguments:</span>
<span id="annotated-cell-10-10"><a href="#annotated-cell-10-10" aria-hidden="true" tabindex="-1"></a>    parameters:</span>
<span id="annotated-cell-10-11"><a href="#annotated-cell-10-11" aria-hidden="true" tabindex="-1"></a>      <span class="co"># The MLflow tracking server is responsible to log the hyper-parameter and model metrics.</span></span>
<span id="annotated-cell-10-12"><a href="#annotated-cell-10-12" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> name: mlflow<span class="op">-</span>tracking<span class="op">-</span>uri</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-10-13" class="code-annotation-target"><a href="#annotated-cell-10-13" aria-hidden="true" tabindex="-1"></a>        value: https:<span class="op">//</span>user<span class="op">-</span>lgaliana<span class="op">-</span>argo<span class="op">-</span>workflows.user.lab.sspcloud.fr</span>
<span id="annotated-cell-10-14"><a href="#annotated-cell-10-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> name: mlflow<span class="op">-</span>experiment<span class="op">-</span>name</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-10-15" class="code-annotation-target"><a href="#annotated-cell-10-15" aria-hidden="true" tabindex="-1"></a>        value: titanicml</span>
<span id="annotated-cell-10-16"><a href="#annotated-cell-10-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> name: model<span class="op">-</span>training<span class="op">-</span>conf<span class="op">-</span><span class="bu">list</span></span>
<span id="annotated-cell-10-17"><a href="#annotated-cell-10-17" aria-hidden="true" tabindex="-1"></a>        value: <span class="op">|</span></span>
<span id="annotated-cell-10-18"><a href="#annotated-cell-10-18" aria-hidden="true" tabindex="-1"></a>          [</span>
<span id="annotated-cell-10-19"><a href="#annotated-cell-10-19" aria-hidden="true" tabindex="-1"></a>            { <span class="st">"n_trees"</span>: <span class="dv">10</span>, <span class="st">"max_features"</span>: <span class="st">"log2"</span> },</span>
<span id="annotated-cell-10-20"><a href="#annotated-cell-10-20" aria-hidden="true" tabindex="-1"></a>            { <span class="st">"n_trees"</span>: <span class="dv">20</span>, <span class="st">"max_features"</span>: <span class="st">"sqrt"</span> },</span>
<span id="annotated-cell-10-21"><a href="#annotated-cell-10-21" aria-hidden="true" tabindex="-1"></a>            { <span class="st">"n_trees"</span>: <span class="dv">20</span>, <span class="st">"max_features"</span>: <span class="st">"log2"</span> },</span>
<span id="annotated-cell-10-22"><a href="#annotated-cell-10-22" aria-hidden="true" tabindex="-1"></a>            { <span class="st">"n_trees"</span>: <span class="dv">50</span>, <span class="st">"max_features"</span>: <span class="st">"sqrt"</span> }</span>
<span id="annotated-cell-10-23"><a href="#annotated-cell-10-23" aria-hidden="true" tabindex="-1"></a>          ]</span>
<span id="annotated-cell-10-24"><a href="#annotated-cell-10-24" aria-hidden="true" tabindex="-1"></a>  templates:</span>
<span id="annotated-cell-10-25"><a href="#annotated-cell-10-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Entrypoint DAG template</span></span>
<span id="annotated-cell-10-26"><a href="#annotated-cell-10-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> name: main</span>
<span id="annotated-cell-10-27"><a href="#annotated-cell-10-27" aria-hidden="true" tabindex="-1"></a>      dag:</span>
<span id="annotated-cell-10-28"><a href="#annotated-cell-10-28" aria-hidden="true" tabindex="-1"></a>        tasks:</span>
<span id="annotated-cell-10-29"><a href="#annotated-cell-10-29" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Task 0: Start pipeline</span></span>
<span id="annotated-cell-10-30"><a href="#annotated-cell-10-30" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: start<span class="op">-</span>pipeline</span>
<span id="annotated-cell-10-31"><a href="#annotated-cell-10-31" aria-hidden="true" tabindex="-1"></a>            template: start<span class="op">-</span>pipeline<span class="op">-</span>wt</span>
<span id="annotated-cell-10-32"><a href="#annotated-cell-10-32" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Task 1: Train model with given params</span></span>
<span id="annotated-cell-10-33"><a href="#annotated-cell-10-33" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: train<span class="op">-</span>model<span class="op">-</span><span class="cf">with</span><span class="op">-</span>params</span>
<span id="annotated-cell-10-34"><a href="#annotated-cell-10-34" aria-hidden="true" tabindex="-1"></a>            dependencies: [ start<span class="op">-</span>pipeline ]</span>
<span id="annotated-cell-10-35"><a href="#annotated-cell-10-35" aria-hidden="true" tabindex="-1"></a>            template: run<span class="op">-</span>model<span class="op">-</span>training<span class="op">-</span>wt</span>
<span id="annotated-cell-10-36"><a href="#annotated-cell-10-36" aria-hidden="true" tabindex="-1"></a>            arguments:</span>
<span id="annotated-cell-10-37"><a href="#annotated-cell-10-37" aria-hidden="true" tabindex="-1"></a>              parameters:</span>
<span id="annotated-cell-10-38"><a href="#annotated-cell-10-38" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span> name: max_features</span>
<span id="annotated-cell-10-39"><a href="#annotated-cell-10-39" aria-hidden="true" tabindex="-1"></a>                  value: <span class="st">"</span><span class="sc">{{</span><span class="st">item.max_features</span><span class="sc">}}</span><span class="st">"</span></span>
<span id="annotated-cell-10-40"><a href="#annotated-cell-10-40" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span> name: n_trees</span>
<span id="annotated-cell-10-41"><a href="#annotated-cell-10-41" aria-hidden="true" tabindex="-1"></a>                  value: <span class="st">"</span><span class="sc">{{</span><span class="st">item.n_trees</span><span class="sc">}}</span><span class="st">"</span></span>
<span id="annotated-cell-10-42"><a href="#annotated-cell-10-42" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Pass the inputs to the task using "withParam"</span></span>
<span id="annotated-cell-10-43"><a href="#annotated-cell-10-43" aria-hidden="true" tabindex="-1"></a>            withParam: <span class="st">"</span><span class="sc">{{</span><span class="st">workflow.parameters.model-training-conf-list</span><span class="sc">}}</span><span class="st">"</span></span>
<span id="annotated-cell-10-44"><a href="#annotated-cell-10-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-45"><a href="#annotated-cell-10-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Now task container templates are defined</span></span>
<span id="annotated-cell-10-46"><a href="#annotated-cell-10-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Worker template for task 0 : start-pipeline</span></span>
<span id="annotated-cell-10-47"><a href="#annotated-cell-10-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> name: start<span class="op">-</span>pipeline<span class="op">-</span>wt</span>
<span id="annotated-cell-10-48"><a href="#annotated-cell-10-48" aria-hidden="true" tabindex="-1"></a>      inputs:</span>
<span id="annotated-cell-10-49"><a href="#annotated-cell-10-49" aria-hidden="true" tabindex="-1"></a>      container:</span>
<span id="annotated-cell-10-50"><a href="#annotated-cell-10-50" aria-hidden="true" tabindex="-1"></a>        image: busybox</span>
<span id="annotated-cell-10-51"><a href="#annotated-cell-10-51" aria-hidden="true" tabindex="-1"></a>        command: [ sh, <span class="op">-</span>c ]</span>
<span id="annotated-cell-10-52"><a href="#annotated-cell-10-52" aria-hidden="true" tabindex="-1"></a>        args: [ <span class="st">"echo Starting pipeline"</span> ]</span>
<span id="annotated-cell-10-53"><a href="#annotated-cell-10-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-54"><a href="#annotated-cell-10-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Worker template for task-1 : train model with params</span></span>
<span id="annotated-cell-10-55"><a href="#annotated-cell-10-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> name: run<span class="op">-</span>model<span class="op">-</span>training<span class="op">-</span>wt</span>
<span id="annotated-cell-10-56"><a href="#annotated-cell-10-56" aria-hidden="true" tabindex="-1"></a>      inputs:</span>
<span id="annotated-cell-10-57"><a href="#annotated-cell-10-57" aria-hidden="true" tabindex="-1"></a>        parameters:</span>
<span id="annotated-cell-10-58"><a href="#annotated-cell-10-58" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: n_trees</span>
<span id="annotated-cell-10-59"><a href="#annotated-cell-10-59" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: max_features</span>
<span id="annotated-cell-10-60"><a href="#annotated-cell-10-60" aria-hidden="true" tabindex="-1"></a>      container:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-10-61" class="code-annotation-target"><a href="#annotated-cell-10-61" aria-hidden="true" tabindex="-1"></a>        image: linogaliana<span class="op">/</span>application:v0<span class="fl">.0.5</span></span>
<span id="annotated-cell-10-62"><a href="#annotated-cell-10-62" aria-hidden="true" tabindex="-1"></a>        imagePullPolicy: Always</span>
<span id="annotated-cell-10-63"><a href="#annotated-cell-10-63" aria-hidden="true" tabindex="-1"></a>        command: [sh, <span class="op">-</span>c]</span>
<span id="annotated-cell-10-64"><a href="#annotated-cell-10-64" aria-hidden="true" tabindex="-1"></a>        args: [</span>
<span id="annotated-cell-10-65"><a href="#annotated-cell-10-65" aria-hidden="true" tabindex="-1"></a>          <span class="st">"python train.py --n_trees=</span><span class="sc">{{</span><span class="st">inputs.parameters.n_trees</span><span class="sc">}}</span><span class="st"> --max_features=</span><span class="sc">{{</span><span class="st">inputs.parameters.max_features</span><span class="sc">}}</span><span class="st">"</span></span>
<span id="annotated-cell-10-66"><a href="#annotated-cell-10-66" aria-hidden="true" tabindex="-1"></a>          ]</span>
<span id="annotated-cell-10-67"><a href="#annotated-cell-10-67" aria-hidden="true" tabindex="-1"></a>        env:</span>
<span id="annotated-cell-10-68"><a href="#annotated-cell-10-68" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: MLFLOW_TRACKING_URI</span>
<span id="annotated-cell-10-69"><a href="#annotated-cell-10-69" aria-hidden="true" tabindex="-1"></a>            value: <span class="st">"</span><span class="sc">{{</span><span class="st">workflow.parameters.mlflow-tracking-uri</span><span class="sc">}}</span><span class="st">"</span></span>
<span id="annotated-cell-10-70"><a href="#annotated-cell-10-70" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: MLFLOW_EXPERIMENT_NAME</span>
<span id="annotated-cell-10-71"><a href="#annotated-cell-10-71" aria-hidden="true" tabindex="-1"></a>            value: <span class="st">"</span><span class="sc">{{</span><span class="st">workflow.parameters.mlflow-experiment-name</span><span class="sc">}}</span><span class="st">"</span></span>
<span id="annotated-cell-10-72"><a href="#annotated-cell-10-72" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: AWS_DEFAULT_REGION</span>
<span id="annotated-cell-10-73"><a href="#annotated-cell-10-73" aria-hidden="true" tabindex="-1"></a>            value: us<span class="op">-</span>east<span class="op">-</span><span class="dv">1</span></span>
<span id="annotated-cell-10-74"><a href="#annotated-cell-10-74" aria-hidden="true" tabindex="-1"></a>          <span class="op">-</span> name: AWS_S3_ENDPOINT</span>
<span id="annotated-cell-10-75"><a href="#annotated-cell-10-75" aria-hidden="true" tabindex="-1"></a>            value: minio.lab.sspcloud.fr</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-10" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="13" data-code-annotation="1">Changer pour votre entrepot de mod√®le</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="15" data-code-annotation="2">Le nom de l‚Äôexp√©rimentation <code>MLFLow</code> dont nous allons avoir besoin (on propose de continuer sur <code>titanicml</code>)</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="61" data-code-annotation="3">Changer l‚Äôapplication ici</span>
</dd>
</dl>
</section>
</section>
<section id="pour-aller-plus-loin" class="level2">
<h2 class="anchored" data-anchor-id="pour-aller-plus-loin">Pour aller plus loin</h2>
<p>Cr√©er un service label studio pour √©valuer la qualit√© du mod√®le</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Il y a quelques diff√©rences entre le VSCode server mis √† disposition sur le SSPCloud et la version <em>desktop</em> sur laquelle s‚Äôappuient beaucoup de ressources. A quelques extensions pr√™ts (<em>Data Wrangler</em>, <em>Copilot</em>), les diff√©rences sont n√©anmoins minimes.<a href="#fnref1" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn2"><p>L‚Äôexport dans un script <code>.py</code> a √©t√© fait directement depuis <code>VSCode</code>. Comme cela n‚Äôest pas vraiment l‚Äôobjet du cours, nous passons cette √©tape et fournissons directement le script expurg√© du texte interm√©diaire. Mais n‚Äôoubliez pas que cette d√©marche, fr√©quente quand on a d√©marr√© sur un <em>notebook</em> et qu‚Äôon d√©sire consolider en faisant la transition vers des scripts, n√©cessite d‚Äô√™tre attentif pour ne pas risquer de faire une erreur.<a href="#fnref2" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn3"><p>Il est √©galement possible avec <code>VSCode</code> d‚Äôex√©cuter le script ligne √† ligne de mani√®re interactive ligne √† ligne (<kbd>MAJ</kbd>+<kbd>ENTER</kbd>). N√©anmoins, cela n√©cessite de s‚Äôassurer que le <em>working directory</em> de votre console interactive est le bon. Celle-ci se lance selon les param√®tres pr√©configur√©s de <code>VSCode</code> et les votres ne sont peut-√™tre pas les m√™mes que les notres. Vous pouvez changer le <em>working directory</em> dans le script en utilisant le <em>package</em> <code>os</code> mais peut-√™tre allez vous d√©couvrir ult√©rieurement qu‚Äôil y a de meilleures pratiques‚Ä¶<a href="#fnref3" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn4"><p>Essayez de <em>commit</em> vos changements √† chaque √©tape de l‚Äôexercice, c‚Äôest une bonne habitude √† prendre.<a href="#fnref4" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn5"><p>Il est normal d‚Äôavoir des dossiers <code>__pycache__</code> qui tra√Ænent en local : ils se cr√©ent automatiquement √† l‚Äôex√©cution d‚Äôun script en <code>Python</code>. N√©anmoins, il ne faut pas associer ces fichiers √† <code>Git</code>, voil√† pourquoi on les ajoute au <code>.gitignore</code>.<a href="#fnref5" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn6"><p>Nous proposons ici d‚Äôadopter le principe de la <strong>programmation fonctionnelle</strong>. Pour encore fiabiliser un processus, il serait possible d‚Äôadopter le paradigme de la <strong>programmation orient√©e objet (POO)</strong>. Celle-ci est plus rebutante et demande plus de temps au d√©veloppeur. L‚Äôarbitrage co√ªt-avantage est n√©gatif pour notre exemple, nous proposons donc de nous en passer. N√©anmoins, pour une mise en production r√©elle d‚Äôun mod√®le, il peut √™tre utle de l‚Äôadopter car certains <em>frameworks</em>, √† commencer par les <em>pipelines</em> <code>scikit</code>, exigeront certaines classes et m√©thodes si vous d√©sirez brancher des objets <em>ad hoc</em> √† ceux-ci.<a href="#fnref6" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn7"><p>Attention, les donn√©es ont √©t√© <em>committ√©es</em> au moins une fois. Les supprimer du d√©p√¥t ne les efface pas de l‚Äôhistorique. Si cette erreur arrive, le mieux est de supprimer le d√©p√¥t en ligne, cr√©er un nouvel historique <code>Git</code> et partir de celui-ci pour des publications ult√©rieures sur <code>Github</code>. N√©anmoins l‚Äôid√©al serait de ne pas s‚Äôexposer √† cela. C‚Äôest justement l‚Äôobjet des bonnes pratiques de ce cours: un <code>.gitignore</code> bien construit et une s√©paration des environnements de stockage du code et des donn√©es seront bien plus efficaces pour vous √©viter ces probl√®mes que tout les conseils de vigilance que vous pourrez trouver ailleurs.<a href="#fnref7" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn8"><p>Alors oui, c‚Äôest vrai, <code>s3</code> se distingue d‚Äôun syst√®me de fichiers classiques comme on peut le lire dans certains <em>posts</em> √©nerv√©s sur la question (par exemple sur <a href="https://www.reddit.com/r/aws/comments/dplfoa/why_is_s3fs_such_a_bad_idea/?tl=fr">Reddit</a>). Mais du point de vue de l‚Äôutilisateur <code>Python</code> plut√¥t que de l‚Äôarchitecte <em>cloud</em>, on va avoir assez peu de diff√©rence avec un syst√®me de fichier local. C‚Äôest pour le mieux, cela r√©duit la difficult√© √† rentrer dans cette technologie.<a href="#fnref8" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn9"><p>Lorsqu‚Äôon d√©veloppe du code qui finalement ne s‚Äôav√®re plus n√©cessaire, on a souvent un cas de conscience √† le supprimer et on pr√©f√®re le mettre de c√¥t√©. Au final, ce syndr√¥me de Diog√®ne est mauvais pour la p√©rennit√© du projet : on se retrouve √† devoir maintenir une base de code qui n‚Äôest, en pratique, pas utilis√©e. Ce n‚Äôest pas un probl√®me de supprimer un code ; si finalement celui-ci s‚Äôav√®re utile, on peut le retrouver gr√¢ce √† l‚Äôhistorique <code>Git</code> et les outils de recherche sur <code>Github</code>. Le <em>package</em> <code>vulture</code> est tr√®s pratique pour diagnostiquer les morceaux de code inutiles dans un projet.<a href="#fnref9" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn10"><p>Le fichier <code>__init__.py</code> indique √† <code>Python</code> que le dossier est un <em>package</em>. Il permet de proposer certaines configurations lors de l‚Äôimport du <em>package</em>. Il permet √©galement de contr√¥ler les objets export√©s (c‚Äôest-√†-dire mis √† disposition de l‚Äôutilisateur) par le <em>package</em> par rapport aux objets internes au <em>package</em>. En le laissant vide, nous allons utiliser ce fichier pour importer l‚Äôensemble des fonctions de nos sous-modules. Ce n‚Äôest pas la meilleure pratique mais un contr√¥le plus fin des objets export√©s demanderait un investissement qui ne vaut, ici, pas le co√ªt.<a href="#fnref10" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn11"><p>Si vous d√©sirez aussi contr√¥ler la version de <code>Python</code>, ce qui peut √™tre important dans une perspective de portabilit√©, vous pouvez ajouter une option, par exemple <code>-p python3.10</code>. N√©anmoins nous n‚Äôallons pas nous embarasser de cette nuance pour la suite car nous pourrons contr√¥ler la version de <code>Python</code> plus finement par le biais de <code>Docker</code>.<a href="#fnref11" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn12"><p>L‚Äôoption <code>-c</code> pass√©e apr√®s la commande <code>python</code> permet d‚Äôindiquer √† <code>Python</code> que la commande ne se trouve pas dans un fichier mais sera dans le texte qu‚Äôon va directement lui fournir.<a href="#fnref12" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn13"><p>L‚Äôoption <code>-c</code> pass√©e apr√®s la commande <code>python</code> permet d‚Äôindiquer √† <code>Python</code> que la commande ne se trouve pas dans un fichier mais sera dans le texte qu‚Äôon va directement lui fournir.<a href="#fnref13" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn14"><p>Pour comparer les deux listes, vous pouvez utiliser la fonctionnalit√© de <em>split</em> du terminal sur <code>VSCode</code> pour comparer les outputs de <code>conda env export</code> en les mettant en face √† face.<a href="#fnref14" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn15"><p>L‚Äôoption <code>-c</code> pass√©e apr√®s la commande <code>python</code> permet d‚Äôindiquer √† <code>Python</code> que la commande ne se trouve pas dans un fichier mais sera dans le texte qu‚Äôon va directement lui fournir.<a href="#fnref15" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn16"><p>Il est tout √† fait normal de ne pas parvenir √† cr√©er une action fonctionnelle du premier coup. N‚Äôh√©sitez pas √† <em>pusher</em> votre code apr√®s chaque question pour v√©rifier que vous parvenez bien √† r√©aliser chaque √©tape. Sinon vous risquez de devoir corriger bout par bout un fichier plus cons√©quent.<a href="#fnref16" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn17"><p>Il existe une approche alternative pour faire des tests r√©guliers: les <em>hooks</em> <code>Git</code>. Il s‚Äôagit de r√®gles qui doivent √™tre satisfaites pour que le fichier puisse √™tre committ√©. Cela assure que chaque <code>commit</code> remplisse des crit√®res de qualit√© afin d‚Äô√©viter le probl√®me de la procrastination.</p>
<p>La <a href="https://pylint.pycqa.org/en/latest/user_guide/pre-commit-integration.html">documentation de pylint</a> offre des explications suppl√©mentaires. Ici, nous allons adopter une approche moins ambitieuse en demandant √† notre action de faire ce travail d‚Äô√©valuation de la qualit√© de notre code<a href="#fnref17" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn18"><p>Vous n‚Äô√™tes pas oblig√©s pour l‚Äô√©valuation de mettre en oeuvre les jalons de plusieurs parcours. N√©anmoins, vous d√©couvrirez que chaque nouveau pas en avant est moins co√ªteux que le pr√©c√©dent si vous avez mis en oeuvre les r√©flexes des bonnes pratiques.<a href="#fnref18" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn19"><p>Puisque vous √™tes connect√©s √† un serveur distant, le <a href="https://fr.wikipedia.org/wiki/Localhost"><em>localhost</em></a> de votre <code>VSCode</code> n‚Äôest pas celui de votre ordinateur. Les applications locales lanc√©es par <code>VSCode</code>, par exemple l‚ÄôAPI, ne sont pas locales pour vous. Il faut donc trouver une mani√®re d‚Äôy acc√©der √† distance. Le SSPCloud propose automatiquement une redirection du <em>localhost</em> du conteneur sur lequel tourne votre VSCode vers un URL p√©renne, √† condition d‚Äôavoir bien d√©fini le port en question. C‚Äôest pour cette raison que vous avez d√ª indiquer les arguments <code>--host "0.0.0.0"</code> et <code>--port 5000</code> pour pouvoir exposer, temporairement, √† internet votre application.<a href="#fnref19" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn20"><p>Par cons√©quent, <code>MLFLow</code> b√©n√©ficie de l‚Äôinjection automatique des <em>tokens</em> pour pouvoir lire/√©crire sur S3. Ces jetons ont la m√™me dur√©e avant expiration que ceux de vos services interactifs <code>VSCode</code>. Il faut donc, par d√©faut, supprimer et rouvrir un service <code>MLFLow</code> r√©guli√®rement. La mani√®re d‚Äô√©viter cela est de cr√©er des <em>service account</em> sur <a href="https://minio-console.lab.sspcloud.fr/login">https://minio-console.lab.sspcloud.fr/</a> et de les renseigner sur <a href="https://datalab.sspcloud.fr/project-settings/s3-configs">la page</a>.<a href="#fnref20" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/ensae-reproductibilite\.github\.io\/website\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<script src="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>