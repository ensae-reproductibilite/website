<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Pr√©sentation des architectures informatiques et des outils logiciels permettant de faciliter le traitement de donn√©es volumineuses.">

<title>Traitement des donn√©es volumineuses ‚Äì Putting into production course</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-db8412935377c476a6a34876e811a251.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>
div.callout-application.callout {
  border-left-color: #9c5bd9;
}
div.callout-application.callout-style-default > .callout-header {
  background-color: rgba(156, 91, 217, 0.13);
}
div.callout-application .callout-toggle::before {  background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgb(33, 37, 41)" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');}
div.callout-application.callout-style-default .callout-icon::before, div.callout-application.callout-titled .callout-icon::before {
  content: 'üß†';
  background-image: none;
}
</style>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://ensae-reproductibilite.github.io/"> 
<span class="menu-text">Putting into production</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../chapters/introduction.html"> 
<span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-fundamentals" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Fundamentals</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-fundamentals">    
        <li>
    <a class="dropdown-item" href="../chapters/linux101.html">
 <span class="dropdown-text">Linux 101</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/git.html">
 <span class="dropdown-text">Git</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-good-development-practices" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Good development practices</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-good-development-practices">    
        <li>
    <a class="dropdown-item" href="../chapters/code-quality.html">
 <span class="dropdown-text">Code quality</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/projects-architecture.html">
 <span class="dropdown-text">Projects structure</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/big-data.html">
 <span class="dropdown-text">Big data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/portability.html">
 <span class="dropdown-text">Portability</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-putting-into-production" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Putting into production</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-putting-into-production">    
        <li>
    <a class="dropdown-item" href="../chapters/yaml101.html">
 <span class="dropdown-text">YAML 101</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/deployment.html">
 <span class="dropdown-text">Deployment</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/mlops.html">
 <span class="dropdown-text">MLOps</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../chapters/application.html"> 
<span class="menu-text">Application</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-projects" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Projects</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-projects">    
        <li>
    <a class="dropdown-item" href="../chapters/evaluation.html">
 <span class="dropdown-text">Evaluations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../chapters/galerie.html">
 <span class="dropdown-text">Past student projects</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-bi-github">    
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/website">
 <span class="dropdown-text">Website</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/slides">
 <span class="dropdown-text">Slides</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/ensae-reproductibilite/application">
 <span class="dropdown-text">Red thread application</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#infrastructures-1" id="toc-infrastructures-1" class="nav-link active" data-scroll-target="#infrastructures-1">Infrastructures</a>
  <ul class="collapse">
  <li><a href="#evolution-of-data-infrastructures" id="toc-evolution-of-data-infrastructures" class="nav-link" data-scroll-target="#evolution-of-data-infrastructures">Evolution of Data Infrastructures</a></li>
  <li><a href="#the-role-of-cloud-technologies" id="toc-the-role-of-cloud-technologies" class="nav-link" data-scroll-target="#the-role-of-cloud-technologies">The Role of <em>Cloud</em> Technologies</a></li>
  </ul></li>
  <li><a href="#sec-new-formats" id="toc-sec-new-formats" class="nav-link" data-scroll-target="#sec-new-formats">Data Formats</a></li>
  <li><a href="#processing-frameworks" id="toc-processing-frameworks" class="nav-link" data-scroll-target="#processing-frameworks">Processing <em>Frameworks</em></a></li>
  <li><a href="#applications-1" id="toc-applications-1" class="nav-link" data-scroll-target="#applications-1">Applications</a>
  <ul class="collapse">
  <li><a href="#application-3-1" id="toc-application-3-1" class="nav-link" data-scroll-target="#application-3-1">Application 3</a></li>
  <li><a href="#to-go-further" id="toc-to-go-further" class="nav-link" data-scroll-target="#to-go-further">To go further</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<script>
  const langButton = document.createElement("div");
  langButton.className = "lang-switch-button";
  langButton.style.textAlign = "right";
  langButton.style.marginTop = "1rem";
  langButton.style.marginBottom = "1rem";

  const currentPath = window.location.pathname;

  // G√©rer les cas avec un sous-r√©pertoire comme /website
  const normalizedPath = currentPath.replace(/^\/website/, "");
  const isEnglish = normalizedPath.includes("/en/");
  let targetHref, label, svg;

  if (isEnglish) {
    targetHref = currentPath.replace("/en/", "/");  // conserve le pr√©fixe /website si pr√©sent
    label = "Passer √† la version fran√ßaise";
    svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="20" height="20" style="vertical-align: middle; margin-left: 0.5em; display: inline-block;"><mask id="circleFlagsLangFr"><circle cx="256" cy="256" r="256" fill="#fff"/></mask><g mask="url(#circleFlagsLangFr)"><path fill="#0055A4" d="M0 0h512v512H0z"/><path fill="#fff" d="M170.7 0h170.6v512H170.7z"/><path fill="#EF4135" d="M341.3 0H512v512H341.3z"/></g></svg>`;
  } else {
    const prefix = currentPath.startsWith("/website") ? "/website" : "";
    targetHref = prefix + "/en" + currentPath.slice(prefix.length);
    label = "Switch to English version";
    svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="20" height="20" style="vertical-align: middle; margin-left: 0.5em; display: inline-block;"><mask id="circleFlagsLangEn"><circle cx="256" cy="256" r="256" fill="#fff"/></mask><g mask="url(#circleFlagsLangEn)"><path fill="#eee" d="M256 0L0 256v64l32 32l-32 32v128l22-8l23 8h23l54-32l54 32h32l48-32l48 32h32l54-32l54 32h68l-8-22l8-23v-23l-32-54l32-54v-32l-32-48l32-48v-32l-32-54l32-54V0z"/><path fill="#d80027" d="M224 64v64h160l64-64zm0 128l32 64l-48 48v208h96V304h208v-96H304l16-16zM0 320v64h128l-64 64H0v64h45l131-131v-45l16-16zm336 16l176 176v-45L381 336Z"/><path fill="#0052b4" d="M0 0v256h256V0zm512 68L404 176h108zM404 336l108 108V336zm-228 68L68 512h108zm160 0v108h108z"/><path fill="#eee" d="m187 243l57-41h-70l57 41l-22-67zm-81 0l57-41H93l57 41l-22-67zm-81 0l57-41H12l57 41l-22-67zm162-81l57-41h-70l57 41l-22-67zm-81 0l57-41H93l57 41l-22-67zm-81 0l57-41H12l57 41l-22-67Zm162-82l57-41h-70l57 41l-22-67zm-81 0l57-41H93l57 41l-22-67Zm-81 0l57-41H12l57 41l-22-67Z"/></g></svg>`;
  }

  langButton.innerHTML = `
    <a href="${targetHref}" class="button-cta">
      <button class="btn"><i class="fa fa-language"></i> ${label} ${svg}</button>
    </a>
  `;

  const main = document.querySelector("main#quarto-document-content");
  if (main) main.insertAdjacentElement("afterbegin", langButton);
</script>
    

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Traitement des donn√©es volumineuses</h1>
</div>

<div>
  <div class="description">
    <p>Pr√©sentation des architectures informatiques et des outils logiciels permettant de faciliter le traitement de donn√©es volumineuses.</p>
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<details>
<summary>
D√©rouler les <em>slides</em> ci-dessous ou <a href="https://ensae-reproductibilite.github.io/slides/#/traitement-des-donn%C3%A9es-volumineuses">cliquer ici</a> pour afficher les slides en plein √©cran.
</summary>
<div class="code-copy-outer-scaffold"><div id="cb1" class="sourceCode">
<pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre>
<iframe class="sourceCode yaml code-with-copy" src="https://ensae-reproductibilite.github.io/slides/#/traitement-des-donn%C3%A9es-volumineuses">
</iframe>
</div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<p>The <em>big data</em> phenomenon is now well-documented: the generation and collection of data from a multitude of sources (IoT sensors, daily interactions on social media, online transactions, mobile devices, etc.) drastically increases the volume of data available for analysis. There are many reasons to focus on such data in data science projects: high availability, greater granularity of observed phenomena, and large datasets needed for training increasingly data-hungry models (like LLMs), among others.</p>
<p>Big data is often defined as a situation where the data volume is so large that it can no longer be processed on a single machine. This relative definition may seem reductive but has the advantage of highlighting that a data source, depending on the time and environment, may require different skill sets. Moving to <em>big data</em> is not just a matter of scale‚Äîit often involves a fundamental shift in the computing infrastructure, with strong implications for the expertise required and the scalability of the data pipelines.</p>
<p>Processing such data introduces new challenges, often summarized as the <strong>‚Äúthree Vs‚Äù</strong>, a widely accepted way to characterize these data sources <span class="citation" data-cites="sagiroglu2013big">(<a href="#ref-sagiroglu2013big" role="doc-biblioref">Sagiroglu and Sinanc 2013</a>)</span>:</p>
<ul>
<li><p><strong>Volume</strong>: Massive volumes of data, often far beyond the capabilities of traditional systems. New storage and processing architectures are needed to handle such scales.</p></li>
<li><p><strong>Velocity</strong>: These data are typically produced at <strong>high frequency, even in real time</strong>. This demands adjustments to architecture and processing methods, such as stream processing.</p></li>
<li><p><strong>Variety</strong>: These data come from <strong>a wide range of sources and formats</strong>, from structured tables to unstructured data like text, images, or video. The appropriate processing techniques depend heavily on the data type. In this course, we focus on relatively structured data, as they remain central to analytical data science projects.</p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../vvv.png" height="350" class="figure-img"></p>
<figcaption>The ‚Äú3 Vs‚Äù of <em>big data</em>. Source: <a href="https://www.packtpub.com/product/artificial-intelligence-with-python-second-edition/9781839219535">AI with Python</a></figcaption>
</figure>
</div>
<p>When considering putting a data science project based on large datasets into production, <strong>adopting good development practices is not just recommended‚Äîit is essential</strong>. Massive datasets introduce significant complexity at every stage of the data science project lifecycle, from collection and storage to processing and analysis. Systems must be designed not only to handle the current data load but also to be <strong>scalable</strong> for future growth. Good practices enable this scalability by promoting <strong>modular architectures</strong>, reusable code, and technologies suited for large-scale data processing.</p>
<p>To address these challenges, technology choices are crucial. In this course, we will focus on three main aspects to guide those choices: <strong>computing infrastructure</strong>, <strong>data formats</strong> suited for high volumes, and <strong><em>frameworks</em></strong> (software solutions and their ecosystems) used for data processing.</p>
<section id="infrastructures-1" class="level1">
<h1>Infrastructures</h1>
<section id="evolution-of-data-infrastructures" class="level2">
<h2 class="anchored" data-anchor-id="evolution-of-data-infrastructures">Evolution of Data Infrastructures</h2>
<p>Historically, data has been stored in databases, systems designed to store and organize information. These systems emerged in the 1950s and saw significant growth with relational databases in the 1980s. This technology proved especially effective for organizing corporate ‚Äúbusiness‚Äù data and served as the foundation of <em>data warehouses</em>, long considered the standard for data storage infrastructure <span class="citation" data-cites="chaudhuri1997overview">(<a href="#ref-chaudhuri1997overview" role="doc-biblioref">Chaudhuri and Dayal 1997</a>)</span>. While technical implementations can vary, their core idea is simple: data from various heterogeneous sources is integrated into a relational database system according to business rules via <em>ETL</em> (extract-transform-load) processes, making it accessible for a range of uses (statistical analysis, reporting, etc.) using the standardized <code>SQL</code> language (<a href="#fig-datawarehouse" class="quarto-xref">Figure&nbsp;1</a>).</p>
<div id="fig-datawarehouse" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-datawarehouse-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../datawharehouse.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-datawarehouse-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Architecture of a data warehouse. Source: <a href="https://airbyte.com/data-engineering-resources/business-intelligence-data-warehouse">airbyte.com</a>
</figcaption>
</figure>
</div>
<p>In the early 2000s, the growing adoption of <em>big data</em> practices exposed the limitations of traditional data warehouses. On one hand, data increasingly came in diverse formats (structured, semi-structured, and unstructured), often evolving as new features were added to data collection platforms. These dynamic, heterogeneous formats fit poorly with the ordered nature of data warehouses, which require schemas to be defined <em>a priori</em>. To address this, <em>data lakes</em> were developed‚Äîsystems that allow for the collection and storage of large volumes of diverse data types (<a href="#fig-datalake" class="quarto-xref">Figure&nbsp;2</a>).</p>
<div id="fig-datalake" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-datalake-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../datalake.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-datalake-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Architecture of a data lake. Source: <a href="https://www.cartelis.com/blog/data-lake-definition-enjeux/">cartelis.com</a>
</figcaption>
</figure>
</div>
<p>Additionally, the enormous size of these data sets made it increasingly difficult to process them on a single machine. This is when Google introduced the <code>MapReduce</code> paradigm <span class="citation" data-cites="ghemawat2003google dean2008mapreduce">(<a href="#ref-ghemawat2003google" role="doc-biblioref">Ghemawat, Gobioff, and Leung 2003</a>; <a href="#ref-dean2008mapreduce" role="doc-biblioref">Dean and Ghemawat 2008</a>)</span>, which laid the foundation for a new generation of distributed data processing systems. Traditional infrastructures used vertical scalability‚Äîadding more powerful or additional resources to a single machine. However, this quickly became expensive and hit hardware limits. Distributed architectures use horizontal scalability: by using many parallel, lower-powered servers and adapting algorithms to this distributed logic, massive datasets can be processed using commodity hardware. This led to the emergence of the <code>Hadoop</code> ecosystem, combining complementary technologies: a data lake (<code>HDFS</code> - Hadoop Distributed File System), a distributed processing engine (<code>MapReduce</code>), and tools for data integration and transformation (<a href="#fig-hadoop" class="quarto-xref">Figure&nbsp;3</a>). This ecosystem expanded with tools like <code>Hive</code> (which converts <code>SQL</code> queries into distributed <code>MapReduce</code> tasks) and <code>Spark</code> (which overcomes certain technical limitations of <code>MapReduce</code> and provides APIs in multiple languages, including <code>Java</code>, <code>Scala</code>, and <code>Python</code>). Hadoop‚Äôs success was profound‚Äîit enabled organizations to process petabyte-scale datasets in real-time using widely accessible programming languages.</p>
<p>This technological shift fueled the <em>big data</em> revolution, enabling new types of questions to be answered using vast datasets. Philosophically, it marked a shift from collecting only the data needed for known purposes, to storing as much data as possible and evaluating its usefulness later during analysis. This approach is typical of <a href="https://en.wikipedia.org/wiki/NoSQL">NoSQL</a> environments (‚ÄúNot only SQL‚Äù), where data is stored at each transactional event but in more flexible formats than traditional databases. JSON, derived from web transactions, is especially prominent. Depending on the structure of the data, different tools are used to query it: <code>ElasticSearch</code> or <code>MongoDB</code> for text data, <code>Spark</code> for tabular data, and so on. All these tools share a common trait: they are highly horizontally scalable, making them ideal for server farms.</p>
<div id="fig-hadoop" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-hadoop-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../mapreduce-hdfs.png" class="quarto-figure quarto-figure-center figure-img" height="350">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-hadoop-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Schematic of a Hadoop architecture. Large datasets are split into blocks, and both storage and processing are distributed across multiple compute nodes. Algorithms are adapted to this distributed setup via <code>MapReduce</code>: first, a ‚Äúmap‚Äù function is applied to each block (e.g., count word frequencies), then a ‚Äúreduce‚Äù step aggregates these results (e.g., compute total frequencies across blocks). Output data is often much smaller than input data and can be brought back locally for further tasks like visualization. Source: <a href="https://www.glennklockwood.com/data-intensive/hadoop/overview.html">glennklockwood.com</a>
</figcaption>
</figure>
</div>
<p>By the late 2010s, <code>Hadoop</code> architectures began to decline in popularity. In traditional Hadoop setups, storage and compute are co-located by design: data segments are processed on the servers where they are stored, avoiding network traffic. This architecture scales linearly, increasing both storage and compute capacity‚Äîeven if only one is needed. In a provocative article titled ‚Äú<em>Big Data is Dead</em>‚Äù <span class="citation" data-cites="Tigani_2023">(<a href="#ref-Tigani_2023" role="doc-biblioref">Tigani 2023</a>)</span>, Jordan Tigani (one of the founding engineers of Google BigQuery) argues that this model no longer suits modern data workloads. First, he explains, ‚Äúin practice, data size grows much faster than compute needs.‚Äù Most use cases don‚Äôt require querying all stored data‚Äîjust recent subsets or specific columns. Second, ‚Äúthe big data frontier keeps receding‚Äù: thanks to more powerful and cheaper servers, fewer workloads require distributed systems (<a href="#fig-bigdata-frontier" class="quarto-xref">Figure&nbsp;4</a>). Additionally, new storage formats (see <a href="#sec-new-formats" class="quarto-xref">Section&nbsp;2</a>) make data handling more efficient. As a result, properly decoupling storage from compute often leads to simpler, more efficient infrastructures.</p>
<div id="fig-bigdata-frontier" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-bigdata-frontier-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../bigdatafrontier.jpg" class="quarto-figure quarto-figure-center figure-img" height="350">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bigdata-frontier-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: ‚ÄúThe big data frontier keeps receding‚Äù: the share of data workloads that cannot be handled by a single machine has steadily declined. Source: <a href="https://motherduck.com/blog/big-data-is-dead/">motherduck.com</a>
</figcaption>
</figure>
</div>
</section>
<section id="the-role-of-cloud-technologies" class="level2">
<h2 class="anchored" data-anchor-id="the-role-of-cloud-technologies">The Role of <em>Cloud</em> Technologies</h2>
<p>Building on Tigani‚Äôs analysis, we observe a growing shift toward more flexible, loosely coupled architectures. The rise of <em>cloud</em> technologies has been pivotal in this transition, for several reasons. Technically, network latency is no longer the bottleneck it was during Hadoop‚Äôs heyday, making the co-location of compute and storage less necessary. In terms of usage, it‚Äôs not just that data volumes are growing‚Äîit‚Äôs also the <strong>diversity</strong> of data and processing needs that is expanding. Modern infrastructures must support various data formats (from structured tables to unstructured media) and a wide range of compute requirements‚Äîfrom parallel data processing to deep learning on GPUs <span class="citation" data-cites="li2020big">(<a href="#ref-li2020big" role="doc-biblioref">Li et al. 2020</a>)</span>.</p>
<p>Two cloud-native technologies have become central to this modern flexibility: <strong>containerization</strong> and <strong>object storage</strong>. Containerization ensures reproducibility and portability‚Äîcrucial for production environments‚Äîand will be discussed in the <a href="../chapters/portability.html">Portability</a> and <a href="../chapters/deployment.html">Deployment</a> chapters. In this section, we focus on <strong>object storage</strong>, the default standard in modern data infrastructures.</p>
<p>Since containers are <em>stateless</em> by nature, a persistent storage layer is needed to store input and output data across computations (<a href="#fig-types-storage" class="quarto-xref">Figure&nbsp;5</a>). In container-based infrastructures, <strong>object storage</strong> has become dominant‚Äîpopularized by Amazon‚Äôs <code>S3</code> (Simple Storage Service) <span class="citation" data-cites="mesnier2003object samundiswary2017object">(<a href="#ref-mesnier2003object" role="doc-biblioref">Mesnier, Ganger, and Riedel 2003</a>; <a href="#ref-samundiswary2017object" role="doc-biblioref">Samundiswary and Dongre 2017</a>)</span>. To understand its popularity, it‚Äôs helpful to contrast object storage with other storage types.</p>
<p>There are three main storage models: file systems, block storage, and object storage (<a href="#fig-types-storage" class="quarto-xref">Figure&nbsp;5</a>). File systems organize data in a hierarchical structure‚Äîlike a traditional desktop environment‚Äîbut they don‚Äôt scale well and require manual access management. Block storage, like that on hard drives, offers fast low-latency access‚Äîideal for databases‚Äîbut also struggles with scalability and cost. Object storage, on the other hand, breaks data into ‚Äúobjects‚Äù stored in a flat namespace and assigned unique IDs and metadata. It removes the need for hierarchical structures, lowering storage costs.</p>
<div id="fig-types-storage" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-types-storage-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../types-storage.png" class="quarto-figure quarto-figure-center figure-img" height="250">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-types-storage-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Comparison of storage types. Source: <a href="https://blog.bytebytego.com/p/storage-systems-overview">bytebytego.com</a>
</figcaption>
</figure>
</div>
<p>Object storage‚Äôs characteristics make it ideal for containerized <em>data science</em> infrastructures. It‚Äôs highly scalable, supports large files, and works well with distributed systems. It also enhances user autonomy by exposing data via APIs like Amazon‚Äôs <code>S3</code>, allowing direct interaction from code (<code>R</code>, <code>Python</code>, etc.) and fine-grained access control via tokens. Most importantly, object storage supports <strong>decoupled architectures</strong>, where compute and storage are independent and remotely accessible. This improves flexibility and efficiency.</p>
<div id="fig-minio-s3" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-minio-s3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../minio-s3.png" class="quarto-figure quarto-figure-center figure-img" height="300">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-minio-s3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: In container-based infrastructure (which is stateless by nature), object storage provides the persistence layer. MinIO is an open-source object storage solution that integrates natively with Kubernetes and supports the S3 API‚Äînow the industry standard‚Äîensuring compatibility across environments. Source: <a href="https://www.lemondeinformatique.fr/actualites/lire-les-donnees-sont-plus-importantes-que-le-cloud--assure-minio%C2%A0%C2%A0-77730.html">lemondeinformatique.fr</a>
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-new-formats" class="level1">
<h1>Data Formats</h1>
<p>Another major dimension to consider for processing massive datasets is how data is stored. Choosing a data format involves balancing several factors, such as the purpose (processing, analysis, dissemination), the target audience (general public, project members, etc.), volume, and interoperability. Traditional formats like CSV, JSON, and XML are widely used due to their convenience: they are plain text formats, making them easily viewable in any text editor ‚Äî they are considered <em>human-readable</em>. Additionally, they are naturally interoperable: plain text can be read by almost any programming language, and most libraries provide built-in support for reading these formats. However, these formats quickly show their limitations when dealing with massive datasets. The lack of compression results in high disk usage, and their row-based representation (<a href="#fig-columnar-storage" class="quarto-xref">Figure&nbsp;7</a>) on disk and in memory makes them inefficient ‚Äî you often need to load the entire file into memory to perform operations on specific rows or columns.</p>
<p>One of the major innovations in the data ecosystem over the past decade is the emergence of data formats that address the limitations of traditional formats. The most popular and now standard format for data storage is <code>Apache Parquet</code>. It offers several features that make it especially well-suited for <em>data science</em> applications. First, it is a compressed format, making it ideal for storing large datasets. Depending on data structure, it‚Äôs not uncommon for a dataset in <code>Parquet</code> format to take up 10 times less space than its <code>CSV</code> equivalent. Second, <code>Parquet</code> is interoperable: files in this format can be queried not only with common languages like <code>Python</code>, <code>R</code>, or <code>SQL</code>, but also with big data processing tools like <code>Spark</code>.</p>
<p>However, the key reason for <code>Parquet</code>‚Äôs widespread adoption in <em>data science</em> is its <strong>read performance</strong>. Intuitively, one might expect that a compressed format would be slower to read than a text format like <code>CSV</code>‚Äîafter all, decompressing takes time. But <code>Parquet</code> uses highly optimized compression that actually <strong>outperforms</strong> reading from a plain CSV file. A crucial feature of <code>Parquet</code> that contributes to this performance is that it is <strong>column-oriented</strong>, meaning data is stored by columns rather than by rows as in traditional text formats (<a href="#fig-columnar-storage" class="quarto-xref">Figure&nbsp;7</a>). This makes it highly efficient for analytical workloads (also known as OLAP ‚Äî <em>Online Analytical Processing</em>), which often involve selecting specific columns, computing derived variables, and aggregating data by groups. Row-based formats like CSV require reading the entire dataset into memory to execute such queries. In contrast, columnar formats allow reading only the relevant columns, significantly reducing read and compute times for analytics tasks <span class="citation" data-cites="abdelaziz2023optimizing">(<a href="#ref-abdelaziz2023optimizing" role="doc-biblioref">Abdelaziz et al. 2023</a>)</span>. In practice, popular columnar formats like <code>Parquet</code> use a hybrid approach: they are mainly column-oriented, but also include row-grouping techniques to further optimize filtering operations.</p>
<div id="fig-columnar-storage" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-columnar-storage-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../columnar-storage.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-columnar-storage-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Row-based vs column-based data storage representation.
</figcaption>
</figure>
</div>
<p>Another important feature of the <code>Parquet</code> format is its <strong>native support for partitioned files</strong>, which means a dataset can be split across multiple files based on one or more partition keys. In most statistical processing, the entire dataset isn‚Äôt required at once ‚Äî you typically filter by geographic area, time window, etc. If all data is stored in a single file, you‚Äôd still need to load all rows ‚Äî at least the relevant columns ‚Äî into memory to perform such filtering. With <code>Parquet</code>, datasets can be partitioned by frequently used filters ‚Äî similar to indexes in a <code>SQL</code> database ‚Äî enabling much faster and more efficient queries (<a href="#fig-parquet-partitions" class="quarto-xref">Figure&nbsp;8</a>). This feature makes <code>Parquet</code> especially well-suited for analytical tasks common in <em>data science</em> <span class="citation" data-cites="dondon2023quels">(<a href="#ref-dondon2023quels" role="doc-biblioref">Dondon and Lamarche 2023</a>)</span>.</p>
<div id="fig-parquet-partitions" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-parquet-partitions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../parquet-partitions.png" class="quarto-figure quarto-figure-center figure-img" height="300">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-parquet-partitions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Filesystem representation of a <code>Parquet</code> file partitioned by two keys: year and month. In this example, querying only a few months is highly efficient because only the relevant partitions are loaded into memory.
</figcaption>
</figure>
</div>
</section>
<section id="processing-frameworks" class="level1">
<h1>Processing <em>Frameworks</em></h1>
<p>The <code>Parquet</code> format makes tabular data storage significantly more efficient. But to fully benefit from this structure, one must also consider the next step: in-memory data processing.</p>
<p>Two major tools have emerged in recent years to address this need. The first is <a href="https://arrow.apache.org/">Apache Arrow</a>, an in-memory tabular data format interoperable across many languages (<code>Python</code>, <code>R</code>, <code>Java</code>, etc.). The second is <a href="https://duckdb.org/"><code>DuckDB</code></a>, a portable and interoperable database engine capable of querying highly diverse data sources (<a href="#fig-duckdb-multisrc" class="quarto-xref">Figure&nbsp;10</a>). While technically quite different in their implementations, both tools offer similar advantages and performance gains. First, both are column-oriented and thus work synergistically with the <code>Parquet</code> format by preserving the benefits of columnar storage in memory (<a href="#fig-arrow-memory" class="quarto-xref">Figure&nbsp;9</a>).</p>
<div id="fig-arrow-memory" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-arrow-memory-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../arrow-memory.png" class="quarto-figure quarto-figure-center figure-img" height="400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-arrow-memory-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: In-memory representation of data in <code>Arrow</code> format. With this format, in-memory storage is also columnar. This preserves the storage advantages of <code>Parquet</code> in memory and leverages modern CPU improvements in vectorized operations. In this example, filtering the <code>session_id</code> column is significantly more efficient than in traditional row-based in-memory formats. <em>Source</em>: <a href="https://arrow.apache.org/overview/"><code>Arrow</code> project documentation</a>
</figcaption>
</figure>
</div>
<p>Moreover, both <code>Arrow</code> and <code>DuckDB</code> drastically improve query performance through <em>lazy evaluation</em>. While most programming languages execute data operations sequentially ‚Äî e.g., select columns, filter rows, compute new variables, then perform aggregations ‚Äî <code>Arrow</code> and <code>DuckDB</code> use a precomputed execution plan that globally optimizes the processing chain. This approach not only makes computations faster, but also more efficient, as only the necessary data is retrieved and processed. These innovations make it feasible to work with datasets that exceed the available RAM on a machine.</p>
<div id="fig-duckdb-multisrc" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-duckdb-multisrc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../duckdb-multisrc.png" class="quarto-figure quarto-figure-center figure-img" height="400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-duckdb-multisrc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: A major strength of <code>DuckDB</code> is its ability to query a wide range of data sources in a standardized way. Since DuckDB is an in-memory database engine, it is naturally suited for querying relational databases (e.g., PostgreSQL, MySQL). But it can also query data files like <code>CSV</code> and <code>Parquet</code>, whether local or cloud-hosted. <em>Source</em>: <a href="https://motherduck.com/blog/duckdb-enterprise-5-key-categories/"><code>MotherDuck</code></a>
</figcaption>
</figure>
</div>
<p>The best way to appreciate the benefits of the <code>Parquet</code> format is to test it and compare it against the same data stored as CSV, as shown in <a href="#fig-tableau-parquet" class="quarto-xref">Figure&nbsp;11</a>. The applications below illustrate the previously mentioned concepts (<em>lazy evaluation</em>, partitioning, etc.) and demonstrate the usability of the <code>Arrow</code> and <code>DuckDB</code> ecosystems through simple examples. The <a href="../chapters/application.html">capstone application</a> covers <code>Parquet</code> in less detail.</p>
<div id="fig-tableau-parquet" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tableau-parquet-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://inseefrlab.github.io/formation-bonnes-pratiques-git-R/slides/img/tableau-perf-parquet.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tableau-parquet-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Example performance comparison of the <code>Parquet</code> format in various use cases using detailed population census data released by Insee in 2023
</figcaption>
</figure>
</div>
</section>
<section id="applications-1" class="level1">
<h1>Applications</h1>
<p>Throughout this application, we will explore how to use the <code>Parquet</code> format as efficiently as possible. To compare different formats and usage methods, we will <strong>compare execution time and memory usage for a standard query</strong>. Let‚Äôs start with a small dataset example to compare the <code>CSV</code> and <code>Parquet</code> formats.</p>
<p>To do this, we need to retrieve some data in <code>Parquet</code> format. We suggest using detailed and anonymized population census data from France: about 20 million rows and 80 columns. The code to retrieve the data is given below</p>
<div id="1e2fa098" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-1-1"><a href="#annotated-cell-1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.parquet <span class="im">as</span> pq</span>
<span id="annotated-cell-1-2"><a href="#annotated-cell-1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow <span class="im">as</span> pa</span>
<span id="annotated-cell-1-3"><a href="#annotated-cell-1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="annotated-cell-1-4"><a href="#annotated-cell-1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-5"><a href="#annotated-cell-1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># D√©finir le fichier de destination</span></span>
<span id="annotated-cell-1-6"><a href="#annotated-cell-1-6" aria-hidden="true" tabindex="-1"></a>filename_table_individu <span class="op">=</span> <span class="st">"data/RPindividus.parquet"</span></span>
<span id="annotated-cell-1-7"><a href="#annotated-cell-1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-8"><a href="#annotated-cell-1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Copier le fichier depuis le stockage distant (remplacer par une m√©thode adapt√©e si n√©cessaire)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-1-9" class="code-annotation-target"><a href="#annotated-cell-1-9" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st">"mc cp s3/projet-formation/bonnes-pratiques/data/RPindividus.parquet data/RPindividus.parquet"</span>)</span>
<span id="annotated-cell-1-10"><a href="#annotated-cell-1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-11"><a href="#annotated-cell-1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Charger le fichier Parquet</span></span>
<span id="annotated-cell-1-12"><a href="#annotated-cell-1-12" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> pq.read_table(filename_table_individu)</span>
<span id="annotated-cell-1-13"><a href="#annotated-cell-1-13" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> table.to_pandas()</span>
<span id="annotated-cell-1-14"><a href="#annotated-cell-1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-15"><a href="#annotated-cell-1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrer les donn√©es pour REGION == "24"</span></span>
<span id="annotated-cell-1-16"><a href="#annotated-cell-1-16" aria-hidden="true" tabindex="-1"></a>df_filtered <span class="op">=</span> df.loc[df[<span class="st">"REGION"</span>] <span class="op">==</span> <span class="st">"24"</span>]</span>
<span id="annotated-cell-1-17"><a href="#annotated-cell-1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-18"><a href="#annotated-cell-1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Sauvegarder en CSV</span></span>
<span id="annotated-cell-1-19"><a href="#annotated-cell-1-19" aria-hidden="true" tabindex="-1"></a>df_filtered.to_csv(<span class="st">"data/RPindividus_24.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="annotated-cell-1-20"><a href="#annotated-cell-1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-21"><a href="#annotated-cell-1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Sauvegarder en Parquet</span></span>
<span id="annotated-cell-1-22"><a href="#annotated-cell-1-22" aria-hidden="true" tabindex="-1"></a>pq.write_table(pa.Table.from_pandas(df_filtered), <span class="st">"data/RPindividus_24.parquet"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-1" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="9" data-code-annotation="1">This line of code uses the Minio Client utility available on the <code>SSPCloud</code>. If you are not on this infrastructure, you can refer to the dedicated warning</span>
</dd>
</dl>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>If you are not on <code>SSPCloud</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>You will need to replace the line</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" data-code-line-numbers=""><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st">"mc cp s3/projet-formation/bonnes-pratiques/data/RPindividus.parquet data/RPindividus.parquet"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>which uses the <code>mc</code> command-line tool, with a line of code that downloads this file from the URL <a href="https://projet-formation.minio.lab.sspcloud.fr/bonnes-pratiques/data/RPindividus.parquet">https://projet-formation.minio.lab.sspcloud.fr/bonnes-pratiques/data/RPindividus.parquet</a>.</p>
<p>There are several ways to do this. For example, you can use pure <code>Python</code> with <code>requests</code>. If you have <code>curl</code> installed, you can also use it. Via <code>Python</code>, this would be the command <code>os.system("curl -o data/RPindividus.parquet https://projet-formation/bonnes-pratiques/data/RPindividus.parquet")</code>.</p>
</div>
</div>
</div>
<p>These exercises will use <code>Python</code> decorators, i.e., functions that override the behavior of another function. In this case, we will create a function that runs a chain of operations and override it with another one that monitors memory usage and execution time.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Application</span>Part 1: From <code>CSV</code> to <code>Parquet</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<ul>
<li><p>Create a notebook <code>benchmark_parquet.ipynb</code> to perform various performance comparisons for the application.</p></li>
<li><p>Let‚Äôs create our decorator, responsible for benchmarking the <code>Python</code> code:</p>
<div id="8a233519" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>D√©rouler pour retrouver le code du d√©corateur permettant de mesurer la performance</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> memory_profiler <span class="im">import</span> memory_usage</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> wraps</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> convert_size(size_bytes):</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> size_bytes <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="st">"0B"</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  size_name <span class="op">=</span> (<span class="st">"B"</span>, <span class="st">"KB"</span>, <span class="st">"MB"</span>, <span class="st">"GB"</span>, <span class="st">"TB"</span>, <span class="st">"PB"</span>, <span class="st">"EB"</span>, <span class="st">"ZB"</span>, <span class="st">"YB"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  i <span class="op">=</span> <span class="bu">int</span>(math.floor(math.log(size_bytes, <span class="dv">1024</span>)))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  p <span class="op">=</span> math.<span class="bu">pow</span>(<span class="dv">1024</span>, i)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  s <span class="op">=</span> <span class="bu">round</span>(size_bytes <span class="op">/</span> p, <span class="dv">2</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="st">"</span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st">"</span> <span class="op">%</span> (s, size_name[i])</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Decorator to measure execution time and memory usage</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> measure_performance(func, return_output<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">@wraps</span>(func)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> wrapper(return_output<span class="op">=</span><span class="va">False</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>          warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>          start_time <span class="op">=</span> time.time()</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>          mem_usage <span class="op">=</span> memory_usage((func, args, kwargs), interval<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>          end_time <span class="op">=</span> time.time()</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>          warnings.filterwarnings(<span class="st">"always"</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>          exec_time <span class="op">=</span> end_time <span class="op">-</span> start_time</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>          peak_mem <span class="op">=</span> <span class="bu">max</span>(mem_usage)  <span class="co"># Peak memory usage</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>          exec_time_formatted <span class="op">=</span> <span class="ss">f"</span><span class="ch">\033</span><span class="ss">[92m</span><span class="sc">{</span>exec_time<span class="sc">:.4f}</span><span class="ss"> sec</span><span class="ch">\033</span><span class="ss">[0m"</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>          peak_mem_formatted <span class="op">=</span> <span class="ss">f"</span><span class="ch">\033</span><span class="ss">[92m</span><span class="sc">{</span>convert_size(<span class="dv">1024</span><span class="op">*</span>peak_mem)<span class="sc">}</span><span class="ch">\033</span><span class="ss">[0m"</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>          <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>func<span class="sc">.</span><span class="va">__name__</span><span class="sc">}</span><span class="ss"> - Execution Time: </span><span class="sc">{</span>exec_time_formatted<span class="sc">}</span><span class="ss"> | Peak Memory Usage: </span><span class="sc">{</span>peak_mem_formatted<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> return_output <span class="kw">is</span> <span class="va">True</span>:</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>              <span class="cf">return</span> func(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> wrapper</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div></li>
<li><p>The following query calculates the data needed to build a population pyramid for a given department, using the census <code>CSV</code> file. Test it in your notebook:</p>
<div id="e092b4bc" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>D√©rouler pour r√©cup√©rer le code de lecture du CSV</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Charger le fichier CSV</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"data/RPindividus_24.csv"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> (</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">"DEPT"</span>] <span class="op">==</span> <span class="dv">36</span>]</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"AGED"</span>, <span class="st">"DEPT"</span>])[<span class="st">"IPONDI"</span>]</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>().reset_index()</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"IPONDI"</span>: <span class="st">"n_indiv"</span>})</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div></li>
<li><p>Repeat this code to encapsulate these operations in a <code>process_csv_appli1</code> function:</p>
<div id="4a4b13da" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>D√©rouler pour r√©cup√©rer le code pour mesurer les performances de la lecture en CSV</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the decorator to functions</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="at">@measure_performance</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_csv_appli1(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(<span class="st">"data/RPindividus_24.csv"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        df.loc[df[<span class="st">"DEPT"</span>] <span class="op">==</span> <span class="dv">36</span>]</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"AGED"</span>, <span class="st">"DEPT"</span>])[<span class="st">"IPONDI"</span>]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">sum</span>().reset_index()</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"IPONDI"</span>: <span class="st">"n_indiv"</span>})</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div></li>
<li><p>Run <code>process_csv_appli1()</code> and <code>process_csv_appli1(return_output=True)</code></p></li>
<li><p>Following the same model, build a <code>process_parquet_appli1</code> function based this time on the file <code>data/RPindividus_24.parquet</code> loaded with Pandas‚Äô <a href="https://pandas.pydata.org/docs/reference/api/pandas.read_parquet.html">read_parquet</a> function.</p></li>
<li><p>Compare the performance (execution time and memory allocation) of these two methods using the function.</p></li>
</ul>
<div id="9f0b6802" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code complet de l‚Äôapplication</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> memory_profiler <span class="im">import</span> memory_usage</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> wraps</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convert_size(size_bytes):</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> size_bytes <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>       <span class="cf">return</span> <span class="st">"0B"</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>   size_name <span class="op">=</span> (<span class="st">"B"</span>, <span class="st">"KB"</span>, <span class="st">"MB"</span>, <span class="st">"GB"</span>, <span class="st">"TB"</span>, <span class="st">"PB"</span>, <span class="st">"EB"</span>, <span class="st">"ZB"</span>, <span class="st">"YB"</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>   i <span class="op">=</span> <span class="bu">int</span>(math.floor(math.log(size_bytes, <span class="dv">1024</span>)))</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>   p <span class="op">=</span> math.<span class="bu">pow</span>(<span class="dv">1024</span>, i)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>   s <span class="op">=</span> <span class="bu">round</span>(size_bytes <span class="op">/</span> p, <span class="dv">2</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> <span class="st">"</span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st">"</span> <span class="op">%</span> (s, size_name[i])</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Decorator to measure execution time and memory usage</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> measure_performance(func, return_output<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">@wraps</span>(func)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> wrapper(return_output<span class="op">=</span><span class="va">False</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        start_time <span class="op">=</span> time.time()</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        mem_usage <span class="op">=</span> memory_usage((func, args, kwargs), interval<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        end_time <span class="op">=</span> time.time()</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        warnings.filterwarnings(<span class="st">"always"</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        exec_time <span class="op">=</span> end_time <span class="op">-</span> start_time</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        peak_mem <span class="op">=</span> <span class="bu">max</span>(mem_usage)  <span class="co"># Peak memory usage</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        exec_time_formatted <span class="op">=</span> <span class="ss">f"</span><span class="ch">\033</span><span class="ss">[92m</span><span class="sc">{</span>exec_time<span class="sc">:.4f}</span><span class="ss"> sec</span><span class="ch">\033</span><span class="ss">[0m"</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        peak_mem_formatted <span class="op">=</span> <span class="ss">f"</span><span class="ch">\033</span><span class="ss">[92m</span><span class="sc">{</span>convert_size(<span class="dv">1024</span><span class="op">*</span>peak_mem)<span class="sc">}</span><span class="ch">\033</span><span class="ss">[0m"</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>func<span class="sc">.</span><span class="va">__name__</span><span class="sc">}</span><span class="ss"> - Execution Time: </span><span class="sc">{</span>exec_time_formatted<span class="sc">}</span><span class="ss"> | Peak Memory Usage: </span><span class="sc">{</span>peak_mem_formatted<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> return_output <span class="kw">is</span> <span class="va">True</span>:</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> func(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> wrapper</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the decorator to functions</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="at">@measure_performance</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_csv(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(<span class="st">"data/RPindividus_24.csv"</span>)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        df.loc[df[<span class="st">"DEPT"</span>] <span class="op">==</span> <span class="dv">36</span>]</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"AGED"</span>, <span class="st">"DEPT"</span>])[<span class="st">"IPONDI"</span>]</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">sum</span>().reset_index()</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"IPONDI"</span>: <span class="st">"n_indiv"</span>})</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a><span class="at">@measure_performance</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_parquet(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_parquet(<span class="st">"data/RPindividus_24.parquet"</span>)</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        df.loc[df[<span class="st">"DEPT"</span>] <span class="op">==</span> <span class="st">"36"</span>]</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"AGED"</span>, <span class="st">"DEPT"</span>])[<span class="st">"IPONDI"</span>]</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">sum</span>().reset_index()</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"IPONDI"</span>: <span class="st">"n_indiv"</span>})</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>process_csv()</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>process_parquet()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</div>
</div>
</div>
<p><em>‚ùìÔ∏è What seems to be the limitation of the <code>read_parquet</code> function?</em></p>
<p>We already save a significant amount of time on reading, but we don‚Äôt fully benefit from the optimizations enabled by <code>Parquet</code> because we immediately transform the data into a <code>Pandas</code> <code>DataFrame</code> after reading it. This means we are not using one of <code>Parquet</code>‚Äôs key features that explains its excellent performance: <em>predicate pushdown</em>, which optimizes processing by applying filters on columns as early as possible to retain only those actually used in the operation.</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Application</span>Part 2: Leveraging <em>lazy evaluation</em> and <code>Arrow</code> or <code>DuckDB</code> optimizations
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>The previous section showed a <strong>significant time gain</strong> when switching from <code>CSV</code> to <code>Parquet</code>. However, <strong>memory usage remained very high</strong>, even though only a small portion of the file was actually used.</p>
<p>In this section, we‚Äôll explore how to use <strong><em>lazy evaluation</em></strong> and <strong>execution plan optimizations</strong> performed by <code>Arrow</code> to fully harness the power of the <code>Parquet</code> format.</p>
<ul>
<li>Open the file <code>data/RPindividus_24.parquet</code> with <a href="https://arrow.apache.org/docs/python/dataset.html">pyarrow.dataset</a>. Check the class of the resulting object.</li>
<li>Try the code below to read a data sample:</li>
</ul>
<div id="dd86b5f6" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    dataset.scanner()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    .head(<span class="dv">5</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    .to_pandas()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Do you understand the difference compared to before? Look at the documentation for the <code>to_table</code> method: do you grasp its purpose?</p>
<ul>
<li>Build a function <code>summarize_parquet_arrow</code> (or <code>summarize_parquet_duckdb</code>) which now imports the data using the <a href="https://arrow.apache.org/docs/python/dataset.html"><code>pyarrow.dataset</code></a> function (or with <code>DuckDB</code>) and performs the desired aggregation.</li>
<li>Compare the performance (execution time and memory allocation) of the three methods (<code>Parquet</code> read and processed with <code>Pandas</code>, <code>Arrow</code>, and <code>DuckDB</code>) using our function.</li>
</ul>
<div id="496a5e07" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code complet de l‚Äôapplication</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.dataset <span class="im">as</span> ds</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="at">@measure_performance</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarize_parquet_duckdb(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    con <span class="op">=</span> duckdb.<span class="ex">connect</span>(<span class="st">":memory:"</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM read_parquet('data/RPindividus_24.parquet')</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT AGED, DEPT, SUM(IPONDI) AS n_indiv</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="st">    GROUP BY AGED, DEPT</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (con.sql(query).to_df())</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="at">@measure_performance</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarize_parquet_arrow(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> ds.dataset(<span class="st">"data/RPindividus_24.parquet"</span>, <span class="bu">format</span><span class="op">=</span><span class="st">"parquet"</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> dataset.to_table()</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    grouped_table <span class="op">=</span> (</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        table</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        .group_by([<span class="st">"AGED"</span>, <span class="st">"DEPT"</span>])</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        .aggregate([(<span class="st">"IPONDI"</span>, <span class="st">"sum"</span>)])</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        .rename_columns([<span class="st">"AGED"</span>, <span class="st">"DEPT"</span>, <span class="st">"n_indiv"</span>])</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        .to_pandas()</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        grouped_table</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>process_parquet()</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>summarize_parquet_duckdb()</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>summarize_parquet_arrow()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</div>
</div>
</div>
<p>With lazy evaluation, the process unfolds in multiple stages:</p>
<ul>
<li><code>Arrow</code> or <code>DuckDB</code> receives instructions, optimizes them, and executes the queries</li>
<li>Only the output data from this chain is sent back to <code>Python</code></li>
</ul>
<p><img src="https://linogaliana.github.io/parquet-recensement-tutomate/img/duckdb-delegation1.png" class="img-fluid"></p>
<section id="application-3-1" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="application-3-1">Application 3</h2>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Application</span>Part 3a: What if we filter rows?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>Add a row filtering step in our queries:</p>
<ul>
<li>With <code>DuckDB</code>, modify the query with <code>WHERE DEPT IN ('18', '28', '36')</code></li>
<li>With <code>Arrow</code>, modify the <code>to_table</code> step as follows: <code>dataset.to_table(filter=pc.field("DEPT").isin(['18', '28', '36']))</code></li>
</ul>
<div id="5b615242" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Correction de cet exercice</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.dataset <span class="im">as</span> ds</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.compute <span class="im">as</span> pc</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="at">@measure_performance</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarize_filter_parquet_arrow(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> ds.dataset(<span class="st">"data/RPindividus.parquet"</span>, <span class="bu">format</span><span class="op">=</span><span class="st">"parquet"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> dataset.to_table(<span class="bu">filter</span><span class="op">=</span>pc.field(<span class="st">"DEPT"</span>).isin([<span class="st">'18'</span>, <span class="st">'28'</span>, <span class="st">'36'</span>]))</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    grouped_table <span class="op">=</span> (</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        table</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        .group_by([<span class="st">"AGED"</span>, <span class="st">"DEPT"</span>])</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        .aggregate([(<span class="st">"IPONDI"</span>, <span class="st">"sum"</span>)])</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        .rename_columns([<span class="st">"AGED"</span>, <span class="st">"DEPT"</span>, <span class="st">"n_indiv"</span>])</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        .to_pandas()</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        grouped_table</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="at">@measure_performance</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarize_filter_parquet_duckdb(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    con <span class="op">=</span> duckdb.<span class="ex">connect</span>(<span class="st">":memory:"</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM read_parquet('data/RPindividus_24.parquet')</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT AGED, DEPT, SUM(IPONDI) AS n_indiv</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE DEPT IN ('11','31','34')</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="st">    GROUP BY AGED, DEPT</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (con.sql(query).to_df())</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>summarize_filter_parquet_arrow()</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>summarize_filter_parquet_duckdb()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</div>
</div>
</div>
<p><em>‚ùìÔ∏è Why don‚Äôt we save time with row filters (or even lose time), unlike with column filters?</em></p>
<p>Data is not organized in row blocks the way it is in column blocks. Fortunately, there‚Äôs a way around this: partitioning!</p>
<div class="callout callout-style-default callout-application callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Application</span>Part 3: Partitioned <code>Parquet</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p><em>Lazy evaluation</em> and <code>Arrow</code> optimizations already bring considerable performance gains. But we can do even better! When we know that data will regularly be <strong>filtered based on a specific variable</strong>, it is a good idea to <strong>partition</strong> the <code>Parquet</code> file by that variable.</p>
<ol type="1">
<li><p>Browse the documentation for <a href="https://arrow.apache.org/docs/python/parquet.html#writing-to-partitioned-datasets"><code>pyarrow.parquet.write_to_dataset</code></a> to understand how to specify a partitioning key when writing a <code>Parquet</code> file. Several methods are possible.</p></li>
<li><p>Import the full census individual table from <code>"data/RPindividus.parquet"</code> using <a href="https://arrow.apache.org/docs/python/generated/pyarrow.dataset.dataset.html"><code>pyarrow.dataset.dataset</code></a> and export it as a partitioned table to <code>"data/RPindividus_partitionne.parquet"</code>, partitioned by region (<code>REGION</code>) and department (<code>DEPT</code>).</p></li>
<li><p>Examine the file tree structure of the exported table to see how the partitioning was applied.</p></li>
<li><p>Modify the import, filtering, and aggregation functions using <code>Arrow</code> or <code>DuckDB</code> to now use the partitioned <code>Parquet</code> file. Compare this to using the non-partitioned file.</p></li>
</ol>
<div id="0813b3f2" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Answer to question 2 (writing the partitioned Parquet)</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.parquet <span class="im">as</span> pq</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> ds.dataset(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data/RPindividus.parquet"</span>, <span class="bu">format</span><span class="op">=</span><span class="st">"parquet"</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>).to_table()</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>pq.write_to_dataset(</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    dataset,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    root_path<span class="op">=</span><span class="st">"data/RPindividus_partitionne"</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    partition_cols<span class="op">=</span>[<span class="st">"REGION"</span>, <span class="st">"DEPT"</span>]</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="20fafdf0" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Correction de la question 4 (lecture du Parquet partitionn√©)</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.dataset <span class="im">as</span> ds</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.compute <span class="im">as</span> pc</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="at">@measure_performance</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarize_filter_parquet_partitioned_arrow(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> ds.dataset(<span class="st">"data/RPindividus_partitionne/"</span>, partitioning<span class="op">=</span><span class="st">"hive"</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> dataset.to_table(<span class="bu">filter</span><span class="op">=</span>pc.field(<span class="st">"DEPT"</span>).isin([<span class="st">'18'</span>, <span class="st">'28'</span>, <span class="st">'36'</span>]))</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    grouped_table <span class="op">=</span> (</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        table</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        .group_by([<span class="st">"AGED"</span>, <span class="st">"DEPT"</span>])</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        .aggregate([(<span class="st">"IPONDI"</span>, <span class="st">"sum"</span>)])</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        .rename_columns([<span class="st">"AGED"</span>, <span class="st">"DEPT"</span>, <span class="st">"n_indiv"</span>])</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        .to_pandas()</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        grouped_table</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="at">@measure_performance</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarize_filter_parquet_complete_arrow(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> ds.dataset(<span class="st">"data/RPindividus.parquet"</span>)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> dataset.to_table(<span class="bu">filter</span><span class="op">=</span>pc.field(<span class="st">"DEPT"</span>).isin([<span class="st">'18'</span>, <span class="st">'28'</span>, <span class="st">'36'</span>]))</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    grouped_table <span class="op">=</span> (</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        table</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        .group_by([<span class="st">"AGED"</span>, <span class="st">"DEPT"</span>])</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        .aggregate([(<span class="st">"IPONDI"</span>, <span class="st">"sum"</span>)])</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        .rename_columns([<span class="st">"AGED"</span>, <span class="st">"DEPT"</span>, <span class="st">"n_indiv"</span>])</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        .to_pandas()</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        grouped_table</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="at">@measure_performance</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarize_filter_parquet_complete_duckdb(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    con <span class="op">=</span> duckdb.<span class="ex">connect</span>(<span class="st">":memory:"</span>)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM read_parquet('data/RPindividus.parquet')</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT AGED, DEPT, SUM(IPONDI) AS n_indiv</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE DEPT IN ('11','31','34')</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a><span class="st">    GROUP BY AGED, DEPT</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (con.sql(query).to_df())</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a><span class="at">@measure_performance</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarize_filter_parquet_partitioned_duckdb(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    con <span class="op">=</span> duckdb.<span class="ex">connect</span>(<span class="st">":memory:"</span>)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM read_parquet('data/RPindividus_partitionne/**/*.parquet', hive_partitioning = True)</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT AGED, DEPT, SUM(IPONDI) AS n_indiv</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE DEPT IN ('11','31','34')</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a><span class="st">    GROUP BY AGED, DEPT</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (con.sql(query).to_df())</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>summarize_filter_parquet_complete_arrow()</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>summarize_filter_parquet_partitioned_arrow()</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>summarize_filter_parquet_complete_duckdb()</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>summarize_filter_parquet_partitioned_duckdb()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</div>
</div>
</div>
<p><em>‚ùìÔ∏è When making data available in <code>Parquet</code> format, how should you choose the partitioning key(s)? What limitation should be kept in mind?</em></p>
</section>
<section id="to-go-further" class="level2">
<h2 class="anchored" data-anchor-id="to-go-further">To go further</h2>
<ul>
<li>The <a href="https://inseefrlab.github.io/formation-bonnes-pratiques-git-R/">training on good practices with <code>R</code> and <code>Git</code></a> developed by Insee, with content very similar to what‚Äôs presented in this chapter.</li>
<li>A <a href="https://linogaliana.github.io/parquet-recensement-tutomate/">workshop</a> on the <code>Parquet</code> format and <code>DuckDB</code> ecosystem for EHESS, with <code>R</code> and <code>Python</code> examples using the same data source as this application.</li>
<li>The <a href="https://ssphub.netlify.app/post/parquetrp/">getting started guide</a> for census data in <code>Parquet</code> format with examples using <code>DuckDB</code> in WASM (directly in the browser, without <code>R</code> or <code>Python</code> installation).</li>
</ul>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-abdelaziz2023optimizing" class="csl-entry" role="listitem">
Abdelaziz, Abdullah I, Kent A Hanson, Charles E Gaber, and Todd A Lee. 2023. <span>‚ÄúOptimizing Large Real-World Data Analysis with Parquet Files in r: A Step-by-Step Tutorial.‚Äù</span> <em>Pharmacoepidemiology and Drug Safety</em>.
</div>
<div id="ref-chaudhuri1997overview" class="csl-entry" role="listitem">
Chaudhuri, Surajit, and Umeshwar Dayal. 1997. <span>‚ÄúAn Overview of Data Warehousing and OLAP Technology.‚Äù</span> <em>ACM Sigmod Record</em> 26 (1): 65‚Äì74.
</div>
<div id="ref-dean2008mapreduce" class="csl-entry" role="listitem">
Dean, Jeffrey, and Sanjay Ghemawat. 2008. <span>‚ÄúMapReduce: Simplified Data Processing on Large Clusters.‚Äù</span> <em>Communications of the ACM</em> 51 (1): 107‚Äì13.
</div>
<div id="ref-dondon2023quels" class="csl-entry" role="listitem">
Dondon, Alexis, and Pierre Lamarche. 2023. <span>‚ÄúQuels Formats Pour Quelles Donn<span>√©</span>es?‚Äù</span> <em>Courrier Des Statistiques</em>, 86‚Äì103.
</div>
<div id="ref-ghemawat2003google" class="csl-entry" role="listitem">
Ghemawat, Sanjay, Howard Gobioff, and Shun-Tak Leung. 2003. <span>‚ÄúThe Google File System.‚Äù</span> In <em>Proceedings of the Nineteenth ACM Symposium on Operating Systems Principles</em>, 29‚Äì43.
</div>
<div id="ref-li2020big" class="csl-entry" role="listitem">
Li, Yun, Manzhu Yu, Mengchao Xu, Jingchao Yang, Dexuan Sha, Qian Liu, and Chaowei Yang. 2020. <span>‚ÄúBig Data and Cloud Computing.‚Äù</span> <em>Manual of Digital Earth</em>, 325‚Äì55.
</div>
<div id="ref-mesnier2003object" class="csl-entry" role="listitem">
Mesnier, Mike, Gregory R Ganger, and Erik Riedel. 2003. <span>‚ÄúObject-Based Storage.‚Äù</span> <em>IEEE Communications Magazine</em> 41 (8): 84‚Äì90.
</div>
<div id="ref-sagiroglu2013big" class="csl-entry" role="listitem">
Sagiroglu, Seref, and Duygu Sinanc. 2013. <span>‚ÄúBig Data: A Review.‚Äù</span> In <em>2013 International Conference on Collaboration Technologies and Systems (CTS)</em>, 42‚Äì47. IEEE.
</div>
<div id="ref-samundiswary2017object" class="csl-entry" role="listitem">
Samundiswary, S, and Nilma M Dongre. 2017. <span>‚ÄúObject Storage Architecture in Cloud for Unstructured Data.‚Äù</span> In <em>2017 International Conference on Inventive Systems and Control (ICISC)</em>, 1‚Äì6. IEEE.
</div>
<div id="ref-Tigani_2023" class="csl-entry" role="listitem">
Tigani, Jordan. 2023. <span>‚ÄúBig Data Is Dead.‚Äù</span> <a href="https://motherduck.com/blog/big-data-is-dead/">https://motherduck.com/blog/big-data-is-dead/</a>.
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<script src="../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>